<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéå HSK AI Tutor - –ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --danger: #f5576c;
            --warning: #ff9a00;
            --success: #4cd964;
            --dark: #2d3748;
            --light: #f8f9fa;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–æ–≤ */
.chat-item:hover {
    background: #e9ecef !important;
}

.chat-item.active {
    background: #e3f2fd !important;
    border-left-color: #1976d2 !important;
}

#chatList {
    scrollbar-width: thin;
    scrollbar-color: #667eea #f1f1f1;
}

#chatList::-webkit-scrollbar {
    width: 6px;
}

#chatList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chatList::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞ */
.ai-message.warning {
    border-left-color: var(--warning);
    background: #fff3cd;
}

.ai-message.tip {
    border-left-color: var(--primary);
    background: #e3f2fd;
}

.ai-message.error {
    border-left-color: var(--danger);
    background: #fde8e8;
}

.ai-message.info {
    border-left-color: var(--success);
    background: #d4edda;
}

.chengyu-item:hover {
    background: #f8f9fa;
    transform: translateX(5px);
    transition: all 0.3s;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ */
@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

.recording-pulse {
    animation: pulse 1s infinite;
}

#chatList::-webkit-scrollbar-thumb:hover {
    background: #555;
}
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--danger) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .header .tagline {
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: var(--light);
            border-bottom: 1px solid #dee2e6;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--danger);
            margin-bottom: 5px;
        }
        
        .stat-desc {
            color: var(--gray);
            font-size: 0.9em;
        }
        
        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .section-header h2 {
            color: var(--dark);
            font-size: 1.5em;
        }
        
        .section-header .icon {
            font-size: 1.5em;
            color: var(--primary);
        }
        
        /* Chat */
        .chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background: #f1f3f5;
            color: var(--dark);
            border-bottom-left-radius: 5px;
        }
        
        .ai-message .ai-label {
            font-weight: bold;
            color: var(--danger);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .input-group button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 0 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Words Section */
        .words-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .word-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--danger);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .word-card:hover {
            transform: translateX(5px);
        }
        
        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .word-character {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--dark);
        }
        
        .word-level {
            background: var(--warning);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .word-pinyin {
            color: var(--danger);
            font-style: italic;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .word-translation {
            color: var(--gray);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .word-tip {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #1976d2;
            border-left: 3px solid #1976d2;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            color: var(--gray);
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Test Section */
        .test-question {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .test-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .test-option {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .test-option:hover {
            background: #f8f9fa;
            border-color: var(--primary);
        }
        
        .test-option.selected {
            background: #e3f2fd;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        /* Footer */
        .footer {
            background: var(--dark);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .api-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .api-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .api-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
                gap: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
.essay-difficulty-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    color: var(--gray);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.essay-difficulty-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.essay-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.trans-difficulty-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    color: var(--gray);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.trans-difficulty-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.trans-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .trans-difficulty-btn {
        padding: 6px 12px;
        font-size: 0.9em;
    }
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
    border-radius: inherit;
}

.tabs-container {
    position: relative;
    overflow: hidden;
    border-bottom: 2px solid #dee2e6;
}

.tabs-scroll {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) #f1f1f1;
    padding-bottom: 5px;
    -webkit-overflow-scrolling: touch;
}

.tabs-scroll::-webkit-scrollbar {
    height: 6px;
}

.tabs-scroll::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.tabs-scroll::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
}

.tab {
    flex-shrink: 0;
    min-width: 120px;
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    font-weight: bold;
    color: var(--gray);
    transition: all 0.3s;
    text-align: center;
    white-space: nowrap;
}

@media (max-width: 768px) {
    .tab {
        min-width: 100px;
        padding: 10px 12px;
        font-size: 0.9em;
    }
}

@media (max-width: 480px) {
    .tab {
        min-width: 85px;
        padding: 8px 10px;
        font-size: 0.8em;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ HSK –≤ —Ä–µ–∂–∏–º–µ —ç—Å—Å–µ */
.essay-hsk-btn {
    padding: 10px 20px;
    border: 2px solid #dee2e6;
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    min-width: 80px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    font-size: 14px;
}

.essay-hsk-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-light);
}

.essay-hsk-btn.active {
    background: linear-gradient(145deg, var(--primary), var(--primary-dark));
    color: white;
    border-color: var(--primary);
    box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);
    position: relative;
}

.essay-hsk-btn.active::before {
    content: '‚úì';
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--success);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
.essay-hsk-btn:active {
    transform: translateY(0);
    transition: transform 0.1s;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ HSK */
.essay-hsk-btn[data-level="3"] {
    background: linear-gradient(145deg, #a3d9a5, #7bc67e);
    color: white;
    border-color: #6abf69;
}

.essay-hsk-btn[data-level="4"] {
    background: linear-gradient(145deg, #4fc3f7, #29b6f6);
    color: white;
    border-color: #03a9f4;
}

.essay-hsk-btn[data-level="5"] {
    background: linear-gradient(145deg, #ffb74d, #ffa726);
    color: white;
    border-color: #ff9800;
}

.essay-hsk-btn[data-level="6"] {
    background: linear-gradient(145deg, #e57373, #f44336);
    color: white;
    border-color: #e53935;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0);
    }
}

.essay-hsk-btn.active {
    animation: pulse 2s infinite;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ */
.trans-difficulty-btn {
    padding: 10px 20px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 12px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-width: 90px;
    text-align: center;
    box-shadow: 0 3px 5px rgba(0, 0, 0, 0.05);
    font-size: 14px;
}

.trans-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--success-light);
}

.trans-difficulty-btn.active {
    background: linear-gradient(145deg, var(--success), var(--success-dark));
    color: white;
    border-color: var(--success);
    box-shadow: 0 4px 15px rgba(var(--success-rgb), 0.3);
}

/* –¶–≤–µ—Ç–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ */
.trans-difficulty-btn[data-difficulty="easy"] {
    background: linear-gradient(145deg, #81c784, #66bb6a);
    color: white;
}

.trans-difficulty-btn[data-difficulty="medium"] {
    background: linear-gradient(145deg, #64b5f6, #42a5f5);
    color: white;
}

.trans-difficulty-btn[data-difficulty="hard"] {
    background: linear-gradient(145deg, #ffb74d, #ffa726);
    color: white;
}

.trans-difficulty-btn[data-difficulty="expert"] {
    background: linear-gradient(145deg, #e57373, #ef5350);
    color: white;
}

/* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ CSS –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç */
:root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --primary-light: #6c8eff;
    --success: #06d6a0;
    --success-dark: #05c293;
    --success-light: #5dfdcb;
    --gray: #6c757d;
    --primary-rgb: 67, 97, 238;
    --success-rgb: 6, 214, 160;
}

/* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .essay-hsk-btn,
    .trans-difficulty-btn {
        padding: 8px 15px;
        min-width: 70px;
        font-size: 13px;
    }
    
    .essay-hsk-btn.active::before {
        width: 18px;
        height: 18px;
        font-size: 10px;
        top: -6px;
        right: -6px;
    }
}

/* –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
.audio-difficulty-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    color: var(--gray);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.audio-difficulty-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.audio-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–∫–∞—Å—Ç–∞ */
.podcast-text {
    font-size: 18px;
    line-height: 1.8;
    margin-bottom: 20px;
    font-family: 'SimSun', 'ÂÆã‰Ωì', serif;
}

.podcast-pinyin {
    color: var(--danger);
    font-style: italic;
    margin-bottom: 10px;
}

.podcast-translation {
    color: var(--gray);
    margin-bottom: 20px;
    padding-left: 15px;
    border-left: 3px solid var(--warning);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–∫—Å–∏–∫–∏ */
.vocabulary-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 15px;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 10px;
    align-items: center;
}

.vocabulary-chinese {
    font-size: 1.8em;
    font-weight: bold;
    min-width: 60px;
}

.vocabulary-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.vocabulary-pinyin {
    color: var(--danger);
    font-weight: bold;
}

.vocabulary-meaning {
    color: var(--dark);
}

.vocabulary-example {
    font-size: 0.9em;
    color: var(--gray);
    font-style: italic;
    margin-top: 5px;
}

.vocabulary-speak {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    font-size: 1.2em;
    padding: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–ª–æ–≤ */
.words-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.word-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 2px solid transparent;
}

.word-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.word-character {
    font-size: 2.5em;
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
    font-family: 'SimSun', serif;
}

.word-pinyin {
    text-align: center;
    color: var(--danger);
    font-size: 1.1em;
    margin-bottom: 5px;
    font-style: italic;
}

.word-translation {
    text-align: center;
    color: var(--dark);
    font-size: 1em;
    margin-bottom: 10px;
}

.word-level {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.word-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.word-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--gray);
    transition: color 0.3s;
}

.word-action-btn:hover {
    color: var(--primary);
}

.word-status {
    position: absolute;
    bottom: 10px;
    left: 10px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
    color: white;
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
.progress-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 20px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    background: var(--primary);
}

/* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ */
#wordsSearch {
    flex: 1;
    min-width: 250px;
    padding: 12px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 25px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#wordsSearch:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    transform: translateY(-1px);
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <!-- Header -->
<div class="header">
    <h1><i class="fas fa-dragon"></i> HSK AI Tutor</h1>
    <p class="subtitle">–ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –¥–ª—è —Å–¥–∞—á–∏ HSK –ª—é–±–æ–π —Ü–µ–Ω–æ–π (–ª–µ–≥–∞–ª—å–Ω–æ)</p>
    
    <!-- –§–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authSection" style="margin-top: 20px;">
        <!-- –ì–æ—Å—Ç—å -->
        <div id="guestView" style="text-align: center;">
            <div class="tagline" style="margin-bottom: 15px;">
                <i class="fas fa-user"></i> –ì–æ—Å—Ç—å (–ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="showLoginForm()" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                </button>
                <button onclick="showRegisterFormFull()" class="btn btn-success">
                    <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>
        </div>
        
        <!-- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
        <div id="userView" style="display: none; text-align: center;">
            <div class="tagline">
                <i class="fas fa-user-check"></i> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userNameDisplay"></span>!
            </div>
            <div style="margin-top: 10px;">
                <button onclick="showProfile()" class="btn btn-primary">
                    <i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å
                </button>
                <button onclick="logout()" class="btn btn-secondary" style="margin-left: 10px;">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
    </div>
</div>
        
        <!-- Statistics -->
        <div class="stats-grid" id="stats">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-scroll">
                <div class="tab active" onclick="switchTab('chat')">
                    <i class="fas fa-robot"></i> AI –†–µ–ø–µ—Ç–∏—Ç–æ—Ä
                </div>
                <div class="tab" onclick="switchTab('words')">
                    <i class="fas fa-book"></i> –°–ª–æ–≤–∞
                </div>
                <div class="tab" onclick="switchTab('test')">
                    <i class="fas fa-graduation-cap"></i> –¢–µ—Å—Ç—ã
                </div>
                <div class="tab" onclick="switchTab('progress')">
                    <i class="fas fa-chart-line"></i> –ü—Ä–æ–≥—Ä–µ—Å—Å
                </div>
                <div class="tab" onclick="switchTab('admission')">
                    <i class="fas fa-university"></i> –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ
                </div>
                <div class="tab" onclick="switchTab('translator')">
                    <i class="fas fa-language"></i> –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫
                </div>
                <div class="tab" onclick="switchTab('grammar')">
                    <i class="fas fa-language"></i> –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞
                </div>
                <div class="tab" onclick="switchTab('voice-chat')">
                    <i class="fas fa-microphone-alt"></i> –ì–æ–ª–æ—Å–æ–≤–æ–π
                </div>
                <div class="tab" onclick="switchTab('text-generator')">
                    <i class="fas fa-scroll"></i> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á—Ç–µ–Ω–∏—è
                </div>
                <div class="tab" onclick="switchTab('essay-checker')">
                    <i class="fas fa-check-double"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
                </div>
                <div class="tab" onclick="switchTab('essay-analysis')">
                    <i class="fas fa-file-alt"></i> –ê–Ω–∞–ª–∏–∑ —ç—Å—Å–µ
                </div>
                <div class="tab" onclick="switchTab('audio')">
                    <i class="fas fa-headphones"></i> –ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="content">

            <!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤ Tab -->
<div class="tab-content" id="text-generator-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-scroll"></i> AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤</h2>
            <div class="icon">üìñ</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –∫–∞–∫ –≤ –º–∞–Ω–≥–µ! –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ —Ñ–æ—Ä–º–∞—Ç:</p>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-sliders-h"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    </h3>
                    
                    <!-- –¢–µ–º–∞ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-pen"></i> –¢–µ–º–∞ —Ç–µ–∫—Å—Ç–∞:
                        </label>
                        <input type="text" id="textTopic" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –≤ –ö–∏—Ç–∞–µ" 
                               style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                    </div>
                    
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-align-left"></i> –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è/–æ–ø–∏—Å–∞–Ω–∏–µ:
                        </label>
                        <textarea id="textDescription" 
                                  placeholder="–î–µ—Ç–∞–ª–∏ —Å—é–∂–µ—Ç–∞, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞..." 
                                  style="width: 100%; height: 120px; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å HSK -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-signal"></i> –£—Ä–æ–≤–µ–Ω—å HSK:
                        </label>
                        <select id="textHskLevel" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="1">HSK 1 (–ù–æ–≤–∏—á–æ–∫, 150 —Å–ª–æ–≤)</option>
                            <option value="2">HSK 2 (–ù–∞—á–∞–ª—å–Ω—ã–π, 300 —Å–ª–æ–≤)</option>
                            <option value="3" selected>HSK 3 (–°—Ä–µ–¥–Ω–∏–π, 600 —Å–ª–æ–≤)</option>
                            <option value="4">HSK 4 (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π, 1200 —Å–ª–æ–≤)</option>
                            <option value="5">HSK 5 (–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, 2500 —Å–ª–æ–≤)</option>
                            <option value="6">HSK 6 (–ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π, 5000+ —Å–ª–æ–≤)</option>
                        </select>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞—Ç -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-file-alt"></i> –§–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                                <input type="radio" name="textFormat" value="chinese_only" checked>
                                <div>
                                    <div style="font-weight: bold;">–¢–æ–ª—å–∫–æ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã</div>
                                    <div style="font-size: 0.9em; color: var(--gray);">–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã + —ç–º–æ–¥–∑–∏ üéØ</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                                <input type="radio" name="textFormat" value="full">
                                <div>
                                    <div style="font-weight: bold;">–ü–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</div>
                                    <div style="font-size: 0.9em; color: var(--gray);">–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                                <input type="radio" name="textFormat" value="manga">
                                <div>
                                    <div style="font-weight: bold;">–§–æ—Ä–º–∞—Ç –º–∞–Ω–≥–∏</div>
                                    <div style="font-size: 0.9em; color: var(--gray);">–î–∏–∞–ª–æ–≥–∏ + –æ–ø–∏—Å–∞–Ω–∏—è + —ç–º–æ–¥–∑–∏</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <button id="generateTextBtn" class="btn btn-primary" onclick="generateChineseText()" 
                            style="width: 100%; padding: 15px; font-size: 1.1em;">
                        <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
                    </button>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–∏–º–µ—Ä—ã -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i> –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn btn-secondary" onclick="loadExample('mall')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üè¨ –í –º–∞–≥–∞–∑–∏–Ω–µ</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('restaurant')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üçú –í —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('university')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéì –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</div>
                            </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('travel')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üöÜ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('business')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üíº –î–µ–ª–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</div>
                        </button>
                    </div>
                    
                    <!-- –°–æ–≤–µ—Ç—ã -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 10px; color: var(--warning);">
                            <i class="fas fa-tips"></i> –°–æ–≤–µ—Ç—ã:
                        </h4>
                        <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                            <li>–ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–∏</li>
                            <li>–í—ã–±–∏—Ä–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–∞—à–µ–º—É HSK</li>
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç "–ú–∞–Ω–≥–∞" –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤</li>
                            <li>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="textResultSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-file-text"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="copyTextToClipboard()">
                        <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-success" onclick="saveGeneratedText()">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button class="btn btn-warning" onclick="speakGeneratedText()">
                        <i class="fas fa-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å
                    </button>
                    <button class="btn btn-danger" onclick="regenerateText()">
                        <i class="fas fa-redo"></i> –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
            
            <div id="textResult" 
                 style="background: white; padding: 30px; border-radius: 15px; border: 2px solid var(--primary); 
                        min-height: 400px; max-height: 600px; overflow-y: auto; font-size: 16px; line-height: 1.8;">
                <!-- –°—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Ç–µ–∫—Å—Ç -->
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div id="textStats" style="margin-top: 20px;">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –ò—Å—Ç–æ—Ä–∏—è -->
            <div id="textHistory" style="margin-top: 30px;">
                <h4><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h4>
                <div id="historyList" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="audio-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-podcast"></i> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–∏—Ç–∞–π—Å–∫–∏—Ö –ø–æ–¥–∫–∞—Å—Ç–æ–≤</h2>
            <div class="icon">üéß</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-sliders-h"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–∞—Å—Ç–∞
                    </h3>
                    
                    <!-- –¢–µ–º–∞ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-bullseye"></i> –¢–µ–º–∞ –ø–æ–¥–∫–∞—Å—Ç–∞:
                        </label>
                        <input type="text" id="audioTopic" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –∫–∏—Ç–∞–π—Å–∫–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏" 
                               style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                    </div>
                    
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-align-left"></i> –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:
                        </label>
                        <textarea id="audioDescription" 
                                  placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø–æ–¥–∫–∞—Å—Ç–µ, —Å—Ç–∏–ª—å, –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã..." 
                                  style="width: 100%; height: 120px; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- –£—Ä–æ–≤–µ–Ω—å HSK -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-signal"></i> –£—Ä–æ–≤–µ–Ω—å HSK:
                        </label>
                        <select id="audioHskLevel" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="1">HSK 1 (–û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π)</option>
                            <option value="2">HSK 2 (–ü—Ä–æ—Å—Ç–æ–π)</option>
                            <option value="3" selected>HSK 3 (–°—Ä–µ–¥–Ω–∏–π)</option>
                            <option value="4">HSK 4 (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)</option>
                            <option value="5">HSK 5 (–°–ª–æ–∂–Ω—ã–π)</option>
                            <option value="6">HSK 6 (–≠–∫—Å–ø–µ—Ä—Ç)</option>
                        </select>
                    </div>
                    
                    <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-tachometer-alt"></i> –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ—á–∏:
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="audio-difficulty-btn active" onclick="setAudioDifficulty('easy')">–õ–µ–≥–∫–∞—è</button>
                            <button class="audio-difficulty-btn" onclick="setAudioDifficulty('medium')">–°—Ä–µ–¥–Ω—è—è</button>
                            <button class="audio-difficulty-btn" onclick="setAudioDifficulty('hard')">–°–ª–æ–∂–Ω–∞—è</button>
                        </div>
                        <input type="hidden" id="audioDifficulty" value="easy">
                    </div>
                    
                    <!-- –î–ª–∏–Ω–∞ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-ruler"></i> –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
                        </label>
                        <select id="audioDuration" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="short">–ö–æ—Ä–æ—Ç–∫–∏–π (1-2 –º–∏–Ω—É—Ç—ã)</option>
                            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π (3-5 –º–∏–Ω—É—Ç)</option>
                            <option value="long">–î–ª–∏–Ω–Ω—ã–π (5-10 –º–∏–Ω—É—Ç)</option>
                        </select>
                    </div>
                    
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="includePinyin" checked>
                                <span>–í–∫–ª—é—á–∞—Ç—å –ø–∏–Ω—å–∏–Ω—å</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="includeTranslation" checked>
                                <span>–í–∫–ª—é—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <button id="generateAudioBtn" class="btn btn-primary" onclick="generateAudioLesson()" 
                            style="width: 100%; padding: 15px; font-size: 1.1em;">
                        <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–∞—Å—Ç
                    </button>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–∏–º–µ—Ä—ã -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i> –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn btn-secondary" onclick="loadAudioExample('greetings')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üëã –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('food')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üçú –ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É—Ö–Ω—è</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('travel')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üó∫Ô∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ö–∏—Ç–∞—é</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('culture')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéå –¢—Ä–∞–¥–∏—Ü–∏–∏ –∏ –∫—É–ª—å—Ç—É—Ä–∞</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('business')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üíº –î–µ–ª–æ–≤–æ–π –∫–∏—Ç–∞–π—Å–∫–∏–π</div>
                        </button>
                    </div>
                    
                    <!-- –°–æ–≤–µ—Ç—ã -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 10px; color: var(--warning);">
                            <i class="fas fa-tips"></i> –°–æ–≤–µ—Ç—ã –¥–ª—è —Å–ª—É—à–∞–Ω–∏—è:
                        </h4>
                        <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                            <li>–°–ª—É—à–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</li>
                            <li>–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –∑–∞ –¥–∏–∫—Ç–æ—Ä–æ–º</li>
                            <li>–°–ª—É—à–∞–π—Ç–µ –ø–æ —á–∞—Å—Ç—è–º</li>
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—É–∑—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</li>
                            <li>–î–µ–ª–∞–π—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤–∞—Ö</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="audioResultSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-headphones"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∫–∞—Å—Ç
                </h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="playAudioPodcast()" id="playAudioBtn">
                        <i class="fas fa-play"></i> –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                    </button>
                    <button class="btn btn-secondary" onclick="pauseAudioPodcast()" id="pauseAudioBtn" style="display: none;">
                        <i class="fas fa-pause"></i> –ü–∞—É–∑–∞
                    </button>
                    <button class="btn btn-warning" onclick="stopAudioPodcast()">
                        <i class="fas fa-stop"></i> –°—Ç–æ–ø
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAudioText()">
                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç
                    </button>
                </div>
            </div>
            
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º -->
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill" id="audioProgress" style="width: 0%; background: var(--primary);"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em;">
                            <span id="audioCurrentTime">0:00</span>
                            <span id="audioTotalTime">0:00</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div>
                            <label style="font-size: 0.9em; margin-right: 10px;">–°–∫–æ—Ä–æ—Å—Ç—å:</label>
                            <select id="audioSpeed" style="padding: 5px 10px; border-radius: 5px;" onchange="changeAudioSpeed()">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="font-size: 0.9em; margin-right: 10px;">–ì–æ–ª–æ—Å:</label>
                            <select id="audioVoice" style="padding: 5px 10px; border-radius: 5px;" onchange="changeAudioVoice()">
                                <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                                <!-- –ì–æ–ª–æ—Å–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–¥–∫–∞—Å—Ç–∞ -->
            <div id="audioContent" 
                 style="background: white; padding: 30px; border-radius: 15px; border: 2px solid var(--primary); 
                        max-height: 500px; overflow-y: auto; margin-bottom: 20px;">
                <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç –ø–æ–¥–∫–∞—Å—Ç–∞ -->
            </div>
            
            <!-- –õ–µ–∫—Å–∏–∫–∞ -->
            <div id="audioVocabulary" style="display: none; margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-book"></i> –ù–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞ –∏–∑ –ø–æ–¥–∫–∞—Å—Ç–∞
                </h4>
                <div id="vocabularyList">
                    <!-- –õ–µ–∫—Å–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <!-- –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è -->
            <div id="audioQuestions" style="display: none; margin-bottom: 20px;">
                <h4 style="color: var(--success); margin-bottom: 15px;">
                    <i class="fas fa-question-circle"></i> –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è
                </h4>
                <div id="questionsList">
                    <!-- –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="admission-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-robot"></i> AI –ü–æ–∏—Å–∫–æ–≤–∏–∫ –≤—É–∑–æ–≤ –ö–∏—Ç–∞—è</h2>
            <div class="icon">üîç</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <p><strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> AI —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏—â–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –í–°–ï–ú –≤—É–∑–∞–º –ö–∏—Ç–∞—è. –í—ã –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Å–≤–æ–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.</p>
            <div class="word-tip">
                üí° <strong>–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:</strong> "–•–æ—á—É –ø–æ—Å—Ç—É–ø–∞—Ç—å —Å HSK 4 –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –Ω–∞—É–∫–∏, –±—é–¥–∂–µ—Ç 15,000 —é–∞–Ω–µ–π –≤ –≥–æ–¥, –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –ü–µ–∫–∏–Ω –∏–ª–∏ –®–∞–Ω—Ö–∞–π"
            </div>
        </div>
        
        <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ -->
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                <i class="fas fa-comment-alt"></i> –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é:
            </label>
            <textarea id="admissionQuery" 
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—â—É –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É –ø–æ –±–∏–∑–Ω–µ—Å—É —Å HSK 5, —Ö–æ—á—É —Å—Ç–∏–ø–µ–Ω–¥–∏—é, –Ω–µ–≤–∞–∂–Ω–æ –∫–∞–∫–æ–π –≥–æ—Ä–æ–¥..." 
                      style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
        </div>
        
        <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
        <div style="margin-bottom: 20px;">
            <h4><i class="fas fa-sliders-h"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">–£—Ä–æ–≤–µ–Ω—å HSK:</label>
                    <select id="hskLevelFilter" style="width: 100%; padding: 8px; border-radius: 8px;">
                        <option value="">–õ—é–±–æ–π</option>
                        <option value="3">HSK 3</option>
                        <option value="4" selected>HSK 4</option>
                        <option value="5">HSK 5</option>
                        <option value="6">HSK 6</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">–ú–∞–∫—Å. –±—é–¥–∂–µ—Ç (—é–∞–Ω–µ–π/–≥–æ–¥):</label>
                    <input type="number" id="budgetFilter" placeholder="20000" style="width: 100%; padding: 8px; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">–Ø–∑—ã–∫ –æ–±—É—á–µ–Ω–∏—è:</label>
                    <select id="languageFilter" style="width: 100%; padding: 8px; border-radius: 8px;">
                        <option value="">–õ—é–±–æ–π</option>
                        <option value="chinese">–ö–∏—Ç–∞–π—Å–∫–∏–π</option>
                        <option value="english">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                        <option value="both">–û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
        <button id="searchUniversitiesBtn" class="btn btn-primary" onclick="searchChineseUniversities()" 
                style="width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 20px;">
            <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤—É–∑—ã
        </button>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <div id="searchResults" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-list-alt"></i> –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="exportResults()">
                        <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
                    </button>
                    <button class="btn btn-secondary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div id="universitiesList" style="margin-bottom: 20px;">
                <!-- –°—é–¥–∞ AI –∑–∞–≥—Ä—É–∑–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞ -->
            <div id="searchStatus" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
                <i class="fas fa-sync-alt fa-spin"></i> AI –∏—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...
            </div>
        </div>
        
        <!-- –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ -->
        <div style="margin-top: 30px;">
            <h4><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</h4>
            <div class="button-group" style="flex-wrap: wrap; margin-top: 10px;">
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(1)">
                    üéì –ò–Ω–∂–µ–Ω–µ—Ä–∏—è —Å HSK 4
                </button>
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(2)">
                    üí∞ –°—Ç–∏–ø–µ–Ω–¥–∏–∏ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—É
                </button>
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(3)">
                    üèôÔ∏è –í—É–∑—ã –≤ –®–∞–Ω—Ö–∞–µ
                </button>
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(4)">
                    üìö –ê–Ω–≥–ª–æ—è–∑—ã—á–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ê–Ω–∞–ª–∏–∑ —ç—Å—Å–µ Tab -->
<div class="tab-content" id="essay-analysis-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-file-alt"></i> AI –ê–Ω–∞–ª–∏–∑ —ç—Å—Å–µ</h2>
            <div class="icon">üìä</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-sliders-h"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
                    </h3>
                    
                    <!-- –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-signal"></i> –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                            <button class="essay-difficulty-btn" onclick="setEssayDifficulty('beginner')" data-difficulty="beginner">
                                –ù–∞—á–∞–ª—å–Ω—ã–π
                            </button>
                            <button class="essay-difficulty-btn active" onclick="setEssayDifficulty('intermediate')" data-difficulty="intermediate">
                                –°—Ä–µ–¥–Ω–∏–π
                            </button>
                            <button class="essay-difficulty-btn" onclick="setEssayDifficulty('advanced')" data-difficulty="advanced">
                                –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
                            </button>
                            <button class="essay-difficulty-btn" onclick="setEssayDifficulty('exam')" data-difficulty="exam">
                                –≠–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π
                            </button>
                        </div>
                        <input type="hidden" id="essayDifficulty" value="intermediate">
                    </div>
                    
                    <!-- –¢–µ–º–∞ —ç—Å—Å–µ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-bullseye"></i> –¢–µ–º–∞ —ç—Å—Å–µ:
                        </label>
                        <input type="text" id="essayAnalysisTopic" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏" 
                               style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-align-left"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:
                        </label>
                        <textarea id="essayAnalysisDetails" 
                                  placeholder="–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —Ñ–æ–∫—É—Å..." 
                                  style="width: 100%; height: 120px; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- –î–ª–∏–Ω–∞ —ç—Å—Å–µ -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-ruler"></i> –¶–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞ —ç—Å—Å–µ:
                        </label>
                        <select id="essayAnalysisLength" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="200">200-300 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</option>
                            <option value="400" selected>400-500 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</option>
                            <option value="600">600-700 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</option>
                            <option value="800">800+ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</option>
                        </select>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <button id="generateEssayBtn" class="btn btn-primary" onclick="generateEssayAnalysis()" 
        style="width: 100%; padding: 15px; font-size: 1.1em;">
    <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —ç—Å—Å–µ
</button>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–∏–º–µ—Ä—ã –∏ —Å–æ–≤–µ—Ç—ã -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i> –ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn btn-secondary" onclick="loadEssayExample('culture')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéå –ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('technology')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üì± –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('education')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('environment')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üåç –≠–∫–æ–ª–æ–≥–∏—è</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('globalization')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üåê –ì–ª–æ–±–∞–ª–∏–∑–∞—Ü–∏—è</div>
                        </button>
                    </div>
                    
                    <!-- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 10px; color: var(--warning);">
                            <i class="fas fa-star"></i> –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:
                        </h4>
                        <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                            <li><strong>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (40%)</strong> - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –∞—Ä–≥—É–º–µ–Ω—Ç—ã</li>
                            <li><strong>–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ (30%)</strong> - –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π</li>
                            <li><strong>–õ–µ–∫—Å–∏–∫–∞ (20%)</strong> - –±–æ–≥–∞—Ç—Å—Ç–≤–æ —Å–ª–æ–≤–∞—Ä—è</li>
                            <li><strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ (10%)</strong> - –ª–æ–≥–∏–∫–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è —ç—Å—Å–µ -->
        <div id="essayAnalysisArea" style="display: none;">
            <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary); margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--primary);">
                        <i class="fas fa-pen"></i> –ù–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ
                        <span id="essayAnalysisTimer" class="word-level" style="margin-left: 10px;">60:00</span>
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="showEssayAnalysisHint()">
                            <i class="fas fa-question-circle"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∞
                        </button>
                        <button class="btn btn-success" onclick="submitEssayForAnalysis()">
                            <i class="fas fa-check"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑
                        </button>
                        <button class="btn btn-danger" onclick="cancelEssayAnalysis()">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
                
                <!-- –ó–∞–¥–∞–Ω–∏–µ -->
                <div style="margin-bottom: 25px;">
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                        <i class="fas fa-bullseye"></i> –ó–∞–¥–∞–Ω–∏–µ:
                    </div>
                    <div id="essayAnalysisPrompt" 
                         style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); 
                                font-size: 16px; line-height: 1.6;">
                        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–¥–∞–Ω–∏–µ -->
                    </div>
                </div>
                
                <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        <i class="fas fa-keyboard"></i> –í–∞—à–µ —ç—Å—Å–µ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º:
                    </label>
                    <textarea id="essayAnalysisText" 
                              placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –≤–∞—à–µ —ç—Å—Å–µ –∑–¥–µ—Å—å..." 
                              style="width: 100%; height: 300px; padding: 20px; border: 2px solid #dee2e6; border-radius: 10px; 
                                     font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif; resize: vertical;"
                              oninput="updateEssayAnalysisCounter()"></textarea>
                    
                    <!-- –°—á–µ—Ç—á–∏–∫ -->
                    <div style="margin-top: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="essayAnalysisProgress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.9em; color: var(--gray);">
                            <span>–ù–∞–ø–∏—Å–∞–Ω–æ: <span id="essayAnalysisCharCount">0</span> –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</span>
                            <span>–¶–µ–ª—å: <span id="essayAnalysisTarget">500</span> –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</span>
                            <span>–û—Å—Ç–∞–ª–æ—Å—å: <span id="essayAnalysisCharsLeft">500</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ—Ä–∞–∑—ã -->
                <div style="margin-top: 20px;">
                    <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 8px;">
                        <i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —ç—Å—Å–µ:
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('introduction')">–í–≤–µ–¥–µ–Ω–∏–µ</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('thesis')">–¢–µ–∑–∏—Å</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('argument')">–ê—Ä–≥—É–º–µ–Ω—Ç</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('example')">–ü—Ä–∏–º–µ—Ä</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('contrast')">–ü—Ä–æ—Ç–∏–≤–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('conclusion')">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ -->
        <div id="essayAnalysisResult" style="display: none;">
            <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ -->
        </div>
    </div>
</div>

            <!-- Chat Tab -->
            <div class="tab-content active" id="chat-tab">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-robot"></i> AI –†–µ–ø–µ—Ç–∏—Ç–æ—Ä</h2>
                        <div class="icon">üí¨</div>
                    </div>
                    
                    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —á–∞—Ç–∞–º–∏ -->
                    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px;">
                        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
                        <div style="background: white; border-radius: 12px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 1.1em;">–ß–∞—Ç—ã</h3>
                                <button onclick="createNewChat()" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;">
                                    <i class="fas fa-plus"></i> –ù–æ–≤—ã–π
                                </button>
                            </div>
                            
                            <div id="chatList" style="max-height: 350px; overflow-y: auto;">
                                <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                            </div>
                            
                            <div id="chatInfo" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; display: none;">
                                <h4 style="font-size: 0.9em; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</h4>
                                <div style="margin-bottom: 10px;">
                                    <input type="text" id="chatTitleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞" 
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <select id="chatCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="general">–û–±—â–∏–π</option>
                                        <option value="grammar">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</option>
                                        <option value="vocabulary">–°–ª–æ–≤–∞</option>
                                        <option value="test_prep">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç—É</option>
                                        <option value="strategy">–°—Ç—Ä–∞—Ç–µ–≥–∏–∏</option>
                                    </select>
                                </div>
                                <div>
                                    <button onclick="updateCurrentChat()" class="btn btn-success" style="width: 100%; padding: 8px; font-size: 0.9em;">
                                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                    <button onclick="deleteCurrentChat()" class="btn btn-danger" style="width: 100%; padding: 8px; margin-top: 5px; font-size: 0.9em;">
                                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ß–∞—Ç -->
                        <div>
                            <div class="chat-box" id="chatBox">
                                <div class="message ai-message">
                                    <div class="ai-label">ü§ñ AI –†–µ–ø–µ—Ç–∏—Ç–æ—Ä:</div>
                                    –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä HSK. –Ø –∑–Ω–∞—é –≤—Å–µ –≥—Ä—è–∑–Ω—ã–µ –ª–∞–π—Ñ—Ö–∞–∫–∏ –∏ —á–∏—Ç—ã –¥–ª—è —Å–¥–∞—á–∏ —ç–∫–∑–∞–º–µ–Ω–∞ (–ª–µ–≥–∞–ª—å–Ω—ã–µ!).<br><br>
                                    –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ:<br>
                                    ‚Ä¢ üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏<br>
                                    ‚Ä¢ üïµÔ∏è‚Äç‚ôÇÔ∏è –ß–∏—Ç-–∫–æ–¥–∞—Ö –¥–ª—è —Ç–µ—Å—Ç–æ–≤<br>
                                    ‚Ä¢ ‚è∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–µ–º<br>
                                    ‚Ä¢ üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–µ–º–∞—Ö<br>
                                    ‚Ä¢ üìö –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–ª–æ–≤–∞—Ö HSK
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <input type="text" id="messageInput" placeholder="–°–ø—Ä–æ—Å–∏ –æ –ª–∞–π—Ñ—Ö–∞–∫–∞—Ö –¥–ª—è HSK 4...">
                                <button onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="quickQuestion('–ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å –≤ –∫–∏—Ç–∞–π—Å–∫–∏–π –≤—É–∑ —Å –Ω–∏–∑–∫–∏–º HSK?')">
                                    <i class="fas fa-university"></i> –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å –Ω–∏–∑–∫–∏–º HSK
                                </button>
                                <button class="btn btn-secondary" onclick="quickQuestion('–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∏–ø–µ–Ω–¥–∏—é CIS?')">
                                    <i class="fas fa-money-bill-wave"></i> –°—Ç–∏–ø–µ–Ω–¥–∏—è CIS
                                </button>
                                <button class="btn btn-warning" onclick="quickQuestion('–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∏ –≤ –∫–∏—Ç–∞–π—Å–∫–æ–º –≤—É–∑–µ?')">
                                    <i class="fas fa-handshake"></i> –°–≤—è–∑–∏ –≤ –≤—É–∑–µ
                                </button>
                                <button class="btn btn-danger" onclick="quickQuestion('–ö–∞–∫–∏–µ –≤—É–∑—ã —Å–∞–º—ã–µ –ª–æ—è–ª—å–Ω—ã–µ –∫ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–∞–º?')">
                                    <i class="fas fa-star"></i> –õ–æ—è–ª—å–Ω—ã–µ –≤—É–∑—ã
                                </button>
                                <button class="btn btn-success" onclick="quickQuestion('–ö–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–µ –¥–ª—è Tsinghua?')">
                                    <i class="fas fa-envelope"></i> –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ
                                </button>
                                <button class="btn btn-primary" onclick="quickQuestion('–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ HSK 4?')">
                                    <i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
                                </button>
                                <button class="btn btn-secondary" onclick="quickQuestion('–ö–∞–∫–∏–µ —Å–ª–æ–≤–∞ —É—á–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?')">
                                    <i class="fas fa-star"></i> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Å–ª–æ–≤–∞
                                </button>
                                <button class="btn btn-warning" onclick="quickQuestion('–ö–∞–∫ —É–≥–∞–¥—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–µ—Å—Ç–∞—Ö?')">
                                    <i class="fas fa-user-secret"></i> –ß–∏—Ç-–∫–æ–¥—ã
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ Tab -->
<div class="tab-content" id="grammar-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-language"></i> AI –°–ª–æ–≤–∞—Ä—å –ì—Ä–∞–º–º–∞—Ç–∏–∫–∏</h2>
            <div class="icon">üìö</div>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                <select id="grammarLevelFilter" onchange="filterGrammarTopics()" 
        style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;">
    <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
    <option value="Âàù">–ù–∞—á–∞–ª—å–Ω—ã–π (Âàù)</option>
    <option value="‰∏≠">–°—Ä–µ–¥–Ω–∏–π (‰∏≠)</option>
    <option value="È´ò">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (È´ò)</option>
</select>
                
                <select id="grammarCategoryFilter" onchange="filterGrammarTopics()" style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </select>
                
                <select id="grammarSort" onchange="filterGrammarTopics()" style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <option value="complexity">–ü–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</option>
                    <option value="level">–ü–æ —É—Ä–æ–≤–Ω—é</option>
                    <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                </select>
                
                <button class="btn btn-secondary" onclick="loadGrammarStats()">
                    <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </button>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <input type="text" id="grammarSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ..." 
                       style="flex: 1; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px;"
                       oninput="searchGrammarTopics()">
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–º –∏ –¥–µ—Ç–∞–ª–∏ -->
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; min-height: 500px;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ —Ç–µ–º -->
            <div style="border-right: 1px solid #dee2e6; padding-right: 20px;">
                <h3 style="margin-bottom: 15px; color: var(--primary);">
                    <i class="fas fa-list"></i> –¢–µ–º—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
                    <span id="grammarCount" class="word-level" style="font-size: 0.8em; margin-left: 10px;">0</span>
                </h3>
                
                <div id="grammarTopicsList" style="max-height: 450px; overflow-y: auto;">
                    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
                
                <div id="grammarStats" style="margin-top: 20px; display: none;">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–µ—Ç–∞–ª–∏ —Ç–µ–º—ã -->
            <div>
                <div id="grammarTopicDetails" style="min-height: 450px;">
                    <div style="text-align: center; color: var(--gray); padding: 50px 0;">
                        <div style="font-size: 3em;">üìñ</div>
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏</h3>
                        <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–º—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å AI-–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</p>
                    </div>
                </div>
                
                <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã) -->
                <div id="grammarExercises" style="margin-top: 20px; display: none;">
                    <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </div>
        
        <!-- –ò—Å—Ç–æ—Ä–∏—è –∏–∑—É—á–µ–Ω–∏—è (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö) -->
        <div id="grammarHistory" style="margin-top: 30px; display: none;">
            <h3><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∏–∑—É—á–µ–Ω–∏—è</h3>
            <div id="grammarHistoryContent" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
    </div>
</div>

            <!-- AI –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ Tab -->
<div class="tab-content" id="translator-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-language"></i> –£–º–Ω—ã–π AI –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</h2>
            <div class="icon">üß†</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í–≤–æ–¥ -->
            <div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        <i class="fas fa-keyboard"></i> –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º:
                    </label>
                    <textarea id="translateInput" 
                              placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º –¥–ª—è —É–º–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞..."
                              style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        <i class="fas fa-sliders-h"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏:
                    </label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="analyzePronunciation">
                            –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="smartTranslate()" style="width: 100%; padding: 12px;">
                    <i class="fas fa-brain"></i> –£–º–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
                </button>
                
                <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã -->
                <div style="margin-top: 20px;">
                    <p style="margin-bottom: 10px; color: var(--gray);">
                        <i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã:
                    </p>
                    <div class="button-group" style="flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="quickTranslate('ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá')" style="font-size: 0.9em;">
                            ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá
                        </button>
                        <button class="btn btn-secondary" onclick="quickTranslate('‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω')" style="font-size: 0.9em;">
                            ‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω
                        </button>
                        <button class="btn btn-secondary" onclick="quickTranslate('‰∏≠ÂõΩËèúÂæàÂ•ΩÂêÉ')" style="font-size: 0.9em;">
                            ‰∏≠ÂõΩËèúÂæàÂ•ΩÂêÉ
                        </button>
                        <button class="btn btn-secondary" onclick="quickTranslate('ÊàëÊÉ≥Âéª‰∏≠ÂõΩÊóÖË°å')" style="font-size: 0.9em;">
                            ÊàëÊÉ≥Âéª‰∏≠ÂõΩÊóÖË°å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
            <div>
                <div id="translationResult" style="height: 400px; overflow-y: auto; padding: 20px; background: white; border-radius: 10px; border: 1px solid #dee2e6;">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                    <div style="text-align: center; color: var(--gray); padding: 50px 0;">
                        <div style="font-size: 3em;">ü§ñ</div>
                        <p>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="translationDetails" style="margin-top: 20px; display: none;">
            <!-- –î–µ—Ç–∞–ª–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
    </div>
</div>
            
            <!-- Words Tab - –î–û–ü–û–õ–ù–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø -->
<div class="tab-content" id="words-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-book"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞–º–∏</h2>
            <div class="icon">üìö</div>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="wordsSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É..." 
                   style="flex: 1; min-width: 250px;" onkeyup="searchWords()">
            <select id="wordsLevelFilter" onchange="filterWords()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="all">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                <option value="1">HSK 1</option>
                <option value="2">HSK 2</option>
                <option value="3">HSK 3</option>
                <option value="4">HSK 4</option>
                <option value="5">HSK 5</option>
                <option value="6">HSK 6</option>
            </select>
            <select id="wordsStatusFilter" onchange="filterWords()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="all">–í—Å–µ —Å–ª–æ–≤–∞</option>
                <option value="saved">–¢–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ</option>
                <option value="learned">–¢–æ–ª—å–∫–æ –∏–∑—É—á–µ–Ω–Ω—ã–µ</option>
                <option value="new">–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ</option>
            </select>
            <button class="btn btn-primary" onclick="loadRandomWords()">
                <i class="fas fa-random"></i> –°–ª—É—á–∞–π–Ω—ã–µ
            </button>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="wordsStats" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);" id="totalWordsCount">0</div>
                    <div style="font-size: 0.9em; color: var(--gray);">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);" id="learnedWordsCount">0</div>
                    <div style="font-size: 0.9em; color: var(--gray);">–ò–∑—É—á–µ–Ω–æ</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);" id="savedWordsCount">0</div>
                    <div style="font-size: 0.9em; color: var(--gray);">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--info);" id="progressPercentage">0%</div>
                    <div style="font-size: 0.9em; color: var(--gray);">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                </div>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–æ–≤ -->
        <div class="words-container" id="wordsList">
            <!-- –°–ª–æ–≤–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div style="display: flex; justify-content: center; margin-top: 20px; gap: 10px;">
            <button class="btn btn-secondary" onclick="changeWordsPage(-1)" id="prevPageBtn" disabled>
                <i class="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥
            </button>
            <span style="padding: 10px; color: var(--gray);" id="pageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
            <button class="btn btn-secondary" onclick="changeWordsPage(1)" id="nextPageBtn" disabled>
                –í–ø–µ—Ä–µ–¥ <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="button-group" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
            <h3><i class="fas fa-graduation-cap"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤</h3>
            <p style="color: var(--gray); margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –∏ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è:</p>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <select id="testSource" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex: 1;">
                    <option value="all">–í—Å–µ —Å–ª–æ–≤–∞</option>
                    <option value="saved">–¢–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ</option>
                    <option value="learned">–¢–æ–ª—å–∫–æ –∏–∑—É—á–µ–Ω–Ω—ã–µ</option>
                    <option value="new">–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ</option>
                </select>
                <select id="testType" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex: 1;">
                    <option value="pinyin_from_char">–ü–∏–Ω—å–∏–Ω—å ‚Üí –ò–µ—Ä–æ–≥–ª–∏—Ñ—ã</option>
                    <option value="char_from_pinyin">–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã ‚Üí –ü–∏–Ω—å–∏–Ω—å</option>
                    <option value="translation_from_char">–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã ‚Üí –ü–µ—Ä–µ–≤–æ–¥</option>
                    <option value="translation_from_pinyin">–ü–∏–Ω—å–∏–Ω—å ‚Üí –ü–µ—Ä–µ–≤–æ–¥</option>
                </select>
                <input type="number" id="testCount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤" min="5" max="50" value="10" 
                       style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 120px;">
            </div>
            
            <button class="btn btn-primary" onclick="startWordsTest()" style="margin-right: 10px;">
                <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
            </button>
            <button class="btn btn-success" onclick="startReviewTest()">
                <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∏–∑—É—á–µ–Ω–Ω—ã—Ö
            </button>
        </div>
    </div>
</div>
            
            <!-- Test Tab -->
            <div class="tab-content" id="test-tab">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-graduation-cap"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                        <div class="icon">üß™</div>
                    </div>
                    
                    <div id="testContainer">
                        <div class="test-intro">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å HSK –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</p>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="startTest(1)">HSK 1</button>
                                <button class="btn btn-primary" onclick="startTest(2)">HSK 2</button>
                                <button class="btn btn-primary" onclick="startTest(3)">HSK 3</button>
                                <button class="btn btn-warning" onclick="startTest(4)">HSK 4</button>
                                <button class="btn btn-warning" onclick="startTest(5)">HSK 5</button>
                                <button class="btn btn-danger" onclick="startTest(6)">HSK 6</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Tab -->
            <div class="tab-content" id="progress-tab">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-line"></i> –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</h2>
                        <div class="icon">üìà</div>
                    </div>
                    
                    <div id="progressContent">
                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>
            </div>
            <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
<!-- –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç Tab -->
<div class="tab-content" id="voice-chat-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-microphone-alt"></i> –ì–æ–ª–æ—Å–æ–≤–æ–π AI –ß–∞—Ç</h2>
            <div class="icon">üé§</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ß–∞—Ç -->
            <div>
                <div class="chat-box" id="voiceChatBox" style="height: 300px; margin-bottom: 15px;">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–º -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button id="startVoiceBtn" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">
                        <i class="fas fa-microphone"></i> –ù–∞—á–∞—Ç—å –≥–æ–≤–æ—Ä–∏—Ç—å
                    </button>
                    <button id="stopVoiceBtn" class="btn btn-danger" style="padding: 15px 30px; font-size: 1.2em; display: none;">
                        <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button id="clearVoiceBtn" class="btn btn-secondary" style="margin-left: 10px;">
                        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ -->
                <div id="voiceStatus" style="text-align: center; margin-bottom: 20px;">
                    <div id="recordingIndicator" style="display: none;">
                        <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border-width: 2px;"></div>
                        <span style="color: var(--danger); margin-left: 10px;">–ó–∞–ø–∏—Å—å...</span>
                    </div>
                    <div id="recordingLevel" style="display: none; margin-top: 10px;">
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill" style="width: 0%; background: var(--danger);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã -->
                <div>
                    <h4><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã:</h4>
                    <div class="button-group" style="flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('–†–∞—Å—Å–∫–∞–∂–∏ —á—ç–Ω—ä—é–π')" style="font-size: 0.9em;">
                            ÊàêËØ≠
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('–û–±—ä—è—Å–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏–µ')" style="font-size: 0.9em;">
                            Ëß£Èáä
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('–ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä')" style="font-size: 0.9em;">
                            ‰æãÂ≠ê
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('–°–ª–µ–¥—É—é—â–∏–π —á—ç–Ω—ä—é–π')" style="font-size: 0.9em;">
                            ‰∏ã‰∏Ä‰∏™
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π')" style="font-size: 0.9em;">
                            ÁøªËØë
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ —á—ç–Ω—ä—é–µ–≤ -->
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
<div>
    <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 1: –ß—ç–Ω—ä—é–∏ -->
        <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #dee2e6; flex: 1;">
            <h3 style="margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-graduation-cap"></i> Â∑≤Â≠¶ÊàêËØ≠
            </h3>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="chengyuSearch" placeholder="ÊêúÁ¥¢ÊàêËØ≠..." 
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;"
                       oninput="searchChengyu()">
            </div>
            
            <div id="chengyuStats" style="margin-bottom: 15px; font-size: 0.9em; color: var(--gray);">
                Â∑≤Â≠¶: <span id="chengyuCount">0</span> ÊàêËØ≠
            </div>
            
            <div id="chengyuList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                <div style="text-align: center; color: var(--gray); padding: 20px;">
                    <div style="font-size: 2em;">üìö</div>
                    <p>ÂºÄÂßã‰∏éAIÂØπËØù</p>
                    <p>ÊàêËØ≠Â∞ÜÂá∫Áé∞Âú®ËøôÈáå</p>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-warning" onclick="generateChengyuQuiz()" style="width: 100%;">
                    <i class="fas fa-question-circle"></i> ÊàêËØ≠ÊµãËØï
                </button>
            </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ -->
        <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #dee2e6; flex: 1;">
            <h3 style="margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-history"></i> ÂØπËØùÂéÜÂè≤
            </h3>
            
            <div id="voiceSessionsList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                <div style="text-align: center; color: var(--gray); padding: 20px;">
                    <div style="font-size: 2em;">üìÅ</div>
                    <p>ÂØπËØùÂéÜÂè≤Â∞ÜÂú®ËøôÈáåÊòæÁ§∫</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="createNewVoiceSession()" style="flex: 1;">
                    <i class="fas fa-plus"></i> Êñ∞ÂØπËØù
                </button>
                <button class="btn btn-secondary" onclick="exportVoiceHistory()" style="flex: 1;">
                    <i class="fas fa-download"></i> ÂØºÂá∫
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('importHistory').click()" style="flex: 1;">
                    <i class="fas fa-upload"></i> ÂØºÂÖ•
                </button>
            </div>
            
            <input type="file" id="importHistory" accept=".json" style="display: none;" onchange="importVoiceHistory(event)">
        </div>
    </div>
</div>
            </div>
        </div>
        
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div style="margin-top: 30px;">
            <h4><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞:</h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="autoPlayAudio" checked>
                    –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ AI
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="saveChengyu" checked>
                    –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–∑—É—á–µ–Ω–Ω—ã–µ —á—ç–Ω—ä—é–∏
                </label>
            </div>
            
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">–°–∫–æ—Ä–æ—Å—Ç—å AI-–≥–æ–ª–æ—Å–∞:</label>
                <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1" 
                       style="width: 200px;" onchange="updateVoiceSpeed()">
                <span id="speedValue" style="margin-left: 10px;">1.0x</span>
            </div>
        </div>
    </div>
</div>
<!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ Tab -->
<div class="tab-content" id="essay-checker-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-check-double"></i> AI –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h2>
            <div class="icon">üìù</div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ –≠—Å—Å–µ -->
        <div id="essayModeContent" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤–≤–æ–¥ -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-sliders-h"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </h3>
                        
                        <!-- –í—ã–±–æ—Ä —Ç–µ–º—ã -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-bullseye"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —ç—Å—Å–µ:
                            </label>
                            <select id="essayTopic" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;"
                                    onchange="updateEssayRequirements()">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>
                                <option value="modern_tech">üì± –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –æ–±—â–µ—Å—Ç–≤–æ</option>
                                <option value="environment">üåç –ó–∞—â–∏—Ç–∞ –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã</option>
                                <option value="education">üéì –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</option>
                                <option value="culture">üéå –ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏</option>
                                <option value="travel">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ —Ç—É—Ä–∏–∑–º</option>
                                <option value="food">üçú –ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É—Ö–Ω—è</option>
                                <option value="business">üíº –ë–∏–∑–Ω–µ—Å –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∞</option>
                                <option value="family">üë™ –°–µ–º—å—è –∏ –æ–±—â–µ—Å—Ç–≤–æ</option>
                                <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏</option>
                                <option value="custom">‚úèÔ∏è –°–≤–æ—è —Ç–µ–º–∞...</option>
                            </select>
                            
                            <!-- –ü–æ–ª–µ –¥–ª—è —Å–≤–æ–µ–π —Ç–µ–º—ã -->
                            <div id="customTopicDiv" style="margin-top: 10px; display: none;">
                                <input type="text" id="customTopic" 
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Ç–µ–º—É..." 
                                       style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                            </div>
                        </div>
                        
                        <!-- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-clipboard-check"></i> –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
                            </label>
                            <div id="essayRequirements" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 14px; color: var(--gray);">
                                –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
                            </div>
                        </div>
                        
                        <!-- –£—Ä–æ–≤–µ–Ω—å HSK -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-signal"></i> –¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å HSK:
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="essay-hsk-btn" onclick="setEssayHskLevel(3)" data-level="3">HSK 3</button>
                                <button class="essay-hsk-btn active" onclick="setEssayHskLevel(4)" data-level="4">HSK 4</button>
                                <button class="essay-hsk-btn" onclick="setEssayHskLevel(5)" data-level="5">HSK 5</button>
                                <button class="essay-hsk-btn" onclick="setEssayHskLevel(6)" data-level="6">HSK 6</button>
                            </div>
                            <input type="hidden" id="essayHskLevel" value="4">
                        </div>
                        
                        <!-- –î–ª–∏–Ω–∞ -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-ruler"></i> –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞:
                            </label>
                            <select id="essayMinLength" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="150">150 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (–º–∏–Ω–∏–º—É–º)</option>
                                <option value="300" selected>300 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                                <option value="500">500 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)</option>
                                <option value="800">800 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (—ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π)</option>
                            </select>
                        </div>
                        
                        <!-- –í—Ä–µ–º—è -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-clock"></i> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏:
                            </label>
                            <select id="essayTimeLimit" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="0">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</option>
                                <option value="30" selected>30 –º–∏–Ω—É—Ç</option>
                                <option value="45">45 –º–∏–Ω—É—Ç</option>
                                <option value="60">60 –º–∏–Ω—É—Ç (–∫–∞–∫ –Ω–∞ HSK)</option>
                            </select>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ -->
                        <button id="startEssayBtn" class="btn btn-primary" onclick="startEssayWriting()" 
                                style="width: 100%; padding: 15px; font-size: 1.1em;">
                            <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å –ø–∏—Å–∞—Ç—å —ç—Å—Å–µ
                        </button>
                    </div>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–∏–º–µ—Ä—ã –∏ —Å–æ–≤–µ—Ç—ã -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-lightbulb"></i> –°–æ–≤–µ—Ç—ã –¥–ª—è —ç—Å—Å–µ
                        </h3>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: var(--warning); margin-bottom: 10px;">
                                <i class="fas fa-star"></i> –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray);">
                                <li><strong>–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:</strong> –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π</li>
                                <li><strong>–õ–µ–∫—Å–∏–∫–∞:</strong> –±–æ–≥–∞—Ç—Å—Ç–≤–æ —Å–ª–æ–≤–∞—Ä–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞</li>
                                <li><strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∞:</strong> –ª–æ–≥–∏—á–Ω–æ—Å—Ç—å –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</li>
                                <li><strong>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:</strong> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ</li>
                                <li><strong>–°—Ç–∏–ª—å:</strong> —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ</li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: var(--success); margin-bottom: 10px;">
                                <i class="fas fa-tips"></i> –°–æ–≤–µ—Ç—ã –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é:
                            </h4>
                            <ol style="padding-left: 20px; color: var(--gray);">
                                <li>–°–Ω–∞—á–∞–ª–∞ —Å–æ—Å—Ç–∞–≤—å—Ç–µ –ø–ª–∞–Ω</li>
                                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</li>
                                <li>–í–∫–ª—é—á–∞–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—Ä–µ–º–µ–Ω–∞ –∏ —á–∞—Å—Ç–∏—Ü—ã</li>
                                <li>–£–¥–µ–ª—è–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –ø–æ—Ä—è–¥–∫—É —Å–ª–æ–≤</li>
                            </ol>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--danger); margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle"></i> –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                                <li>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‰∫Ü</li>
                                <li>–ü—É—Ç–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É ÁöÑ„ÄÅÂú∞„ÄÅÂæó</li>
                                <li>–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤</li>
                                <li>–ü–æ–≤—Ç–æ—Ä –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ —Å–ª–æ–≤</li>
                                <li>–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤—è–∑—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è —ç—Å—Å–µ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞) -->
            <div id="essayWritingArea" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-pen"></i> –ù–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ
                            <span id="essayTimer" class="word-level" style="margin-left: 10px;">30:00</span>
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="showEssayHint()">
                                <i class="fas fa-question-circle"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∞
                            </button>
                            <button class="btn btn-success" onclick="submitEssayForCheck()">
                                <i class="fas fa-check"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
                            </button>
                            <button class="btn btn-danger" onclick="cancelEssayWriting()">
                                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: var(--primary);" id="currentEssayTopic">
                                –¢–µ–º–∞: ...
                            </div>
                            <div style="font-size: 0.9em; color: var(--gray);">
                                –ú–∏–Ω–∏–º—É–º: <span id="minChars">300</span> –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
                            </div>
                        </div>
                        <div id="essayPrompt" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–¥–∞–Ω–∏–µ -->
                        </div>
                    </div>
                    
                    <!-- –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ -->
                    <div style="margin-bottom: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="essayProgress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.9em; color: var(--gray);">
                            <span>–ù–∞–ø–∏—Å–∞–Ω–æ: <span id="charCount">0</span> –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</span>
                            <span>–û—Å—Ç–∞–ª–æ—Å—å: <span id="charsLeft">300</span></span>
                        </div>
                    </div>
                    
                    <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ -->
                    <textarea id="essayText" 
                              placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –≤–∞—à–µ —ç—Å—Å–µ –∑–¥–µ—Å—å..." 
                              style="width: 100%; height: 300px; padding: 20px; border: 2px solid #dee2e6; border-radius: 10px; 
                                     font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif; resize: vertical;"
                              oninput="updateEssayCounter()"></textarea>
                    
                    <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ—Ä–∞–∑—ã -->
                    <div style="margin-top: 15px;">
                        <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">
                            <i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —ç—Å—Å–µ:
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('intro')">–í–≤–µ–¥–µ–Ω–∏–µ</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('opinion')">–ú–Ω–µ–Ω–∏–µ</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('example')">–ü—Ä–∏–º–µ—Ä</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('conclusion')">–í—ã–≤–æ–¥</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('connector')">–°–≤—è–∑–∫–∞</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div id="essayResultSection" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="retryEssay()">
                                <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                            </button>
                            <button class="btn btn-success" onclick="saveEssayResult()">
                                <i class="fas fa-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
                            </button>
                        </div>
                    </div>
                    
                    <!-- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                    <div id="essayOverallScore" style="text-align: center; margin-bottom: 30px;">
                        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
                    <div id="essayDetailedAnalysis">
                        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ –ü–µ—Ä–µ–≤–æ–¥–∞ -->
        <div id="translationModeContent" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-sliders-h"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
                        </h3>
                        
                        <!-- –í—ã–±–æ—Ä —Ç–µ–º—ã —Ç–µ–∫—Å—Ç–∞ -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-bullseye"></i> –¢–µ–º–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
                            </label>
                            <select id="translationTopic" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;"
                                    onchange="updateTranslationExample()">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>
                                <option value="news">üì∞ –ù–æ–≤–æ—Å—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è</option>
                                <option value="story">üìñ –ö–æ—Ä–æ—Ç–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑</option>
                                <option value="dialogue">üí¨ –î–∏–∞–ª–æ–≥</option>
                                <option value="description">üèûÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞</option>
                                <option value="instruction">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</option>
                                <option value="review">‚≠ê –û—Ç–∑—ã–≤ –æ –ø—Ä–æ–¥—É–∫—Ç–µ</option>
                                <option value="email">üìß –î–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ</option>
                                <option value="advertisement">üì¢ –†–µ–∫–ª–∞–º–Ω—ã–π —Ç–µ–∫—Å—Ç</option>
                                <option value="custom_trans">‚úèÔ∏è –°–≤–æ–π —Ç–µ–∫—Å—Ç...</option>
                            </select>
                        </div>
                        
                        <!-- –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-signal"></i> –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞:
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="trans-difficulty-btn" onclick="setTranslationDifficulty('easy')" data-difficulty="easy">–õ–µ–≥–∫–∏–π</button>
                                <button class="trans-difficulty-btn active" onclick="setTranslationDifficulty('medium')" data-difficulty="medium">–°—Ä–µ–¥–Ω–∏–π</button>
                                <button class="trans-difficulty-btn" onclick="setTranslationDifficulty('hard')" data-difficulty="hard">–°–ª–æ–∂–Ω—ã–π</button>
                                <button class="trans-difficulty-btn" onclick="setTranslationDifficulty('expert')" data-difficulty="expert">–≠–∫—Å–ø–µ—Ä—Ç</button>
                            </div>
                            <input type="hidden" id="translationDifficulty" value="medium">
                        </div>
                        
                        <!-- –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-ruler"></i> –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:
                            </label>
                            <select id="translationLength" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="short">–ö–æ—Ä–æ—Ç–∫–∏–π (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)</option>
                                <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π (6-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)</option>
                                <option value="long">–î–ª–∏–Ω–Ω—ã–π (10-15 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)</option>
                            </select>
                        </div>
                        
                        <!-- –£—Ä–æ–≤–µ–Ω—å HSK -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-graduation-cap"></i> –í–∞—à —É—Ä–æ–≤–µ–Ω—å HSK:
                            </label>
                            <select id="translationHskLevel" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="3">HSK 3</option>
                                <option value="4" selected>HSK 4</option>
                                <option value="5">HSK 5</option>
                                <option value="6">HSK 6</option>
                            </select>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ -->
                        <button id="generateTranslationTextBtn" class="btn btn-primary" onclick="generateTranslationText()" 
                                style="width: 100%; padding: 15px; font-size: 1.1em;">
                            <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
                        </button>
                    </div>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–∏–º–µ—Ä—ã -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-eye"></i> –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
                        </h3>
                        
                        <div id="translationExample" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; 
                                                           min-height: 150px; font-style: italic; color: var(--gray);">
                            –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä...
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: var(--warning); margin-bottom: 10px;">
                                <i class="fas fa-star"></i> –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                                <li><strong>–¢–æ—á–Ω–æ—Å—Ç—å:</strong> –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞</li>
                                <li><strong>–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:</strong> –∑–≤—É—á–∏—Ç –∫–∞–∫ —Ä–æ–¥–Ω–æ–π —è–∑—ã–∫</li>
                                <li><strong>–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:</strong> –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</li>
                                <li><strong>–õ–µ–∫—Å–∏–∫–∞:</strong> —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å —Å–ª–æ–≤</li>
                                <li><strong>–°—Ç–∏–ª—å:</strong> —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--success); margin-bottom: 10px;">
                                <i class="fas fa-tips"></i> –°–æ–≤–µ—Ç—ã –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                                <li>–ü–µ—Ä–µ–≤–æ–¥–∏—Ç–µ —Å–º—ã—Å–ª, –∞ –Ω–µ —Å–ª–æ–≤–∞</li>
                                <li>–£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</li>
                                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∏—Ç–∞–π—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏ –∏–¥–∏–æ–º</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤</li>
                                <li>–û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏—Ü—ã</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞) -->
            <div id="translationArea" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-language"></i> –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
                            <span id="translationTimer" class="word-level" style="margin-left: 10px;">25:00</span>
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="submitTranslationForCheck()">
                                <i class="fas fa-check"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
                            </button>
                            <button class="btn btn-danger" onclick="cancelTranslation()">
                                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                    
                    <!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç -->
                    <div style="margin-bottom: 25px;">
                        <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                            <i class="fas fa-file-alt"></i> –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (—Ä—É—Å—Å–∫–∏–π):
                        </div>
                        <div id="originalTranslationText" 
                             style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); 
                                    font-size: 16px; line-height: 1.6;">
                            <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ -->
                        </div>
                    </div>
                    
                    <!-- –ü–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: var(--success); margin-bottom: 10px;">
                            <i class="fas fa-pen"></i> –í–∞—à –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π:
                        </div>
                        <textarea id="translationText" 
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–µ—Ä–µ–≤–æ–¥ –∑–¥–µ—Å—å..." 
                                  style="width: 100%; height: 250px; padding: 20px; border: 2px solid #dee2e6; border-radius: 10px; 
                                         font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif; resize: vertical;"
                                  oninput="updateTranslationCounter()"></textarea>
                        
                        <!-- –°—á–µ—Ç—á–∏–∫ -->
                        <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray); text-align: right;">
                            –°–∏–º–≤–æ–ª–æ–≤: <span id="transCharCount">0</span>
                        </div>
                    </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
            <div id="translationResultSection" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="retryTranslation()">
                                <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                            </button>
                            <button class="btn btn-success" onclick="saveTranslationResult()">
                                <i class="fas fa-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
                            </button>
                        </div>
                    </div>
                    
                    <!-- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                    <div id="translationOverallScore" style="text-align: center; margin-bottom: 30px;">
                        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                    </div>
                    
                    <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
                    <div id="translationComparison" style="margin-bottom: 30px;">
                        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
                    <div id="translationDetailedAnalysis">
                        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        
        <!-- Footer -->
        <div class="footer">
            <h3>üîó –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ API</h3>
            <div class="api-links">
                <a href="http://localhost:8000/docs" target="_blank">
                    <i class="fas fa-book"></i> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
                </a>
                <a href="http://localhost:8000/stats" target="_blank">
                    <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a>
                <a href="http://localhost:8000/test/1" target="_blank">
                    <i class="fas fa-file-alt"></i> –¢–µ—Å—Ç HSK 1
                </a>
                <a href="http://localhost:8000/word/random" target="_blank">
                    <i class="fas fa-dice"></i> –°–ª—É—á–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ
                </a>
                <a href="http://localhost:8000/words/level/3" target="_blank">
                    <i class="fas fa-list"></i> –°–ª–æ–≤–∞ HSK 3
                </a>
                <a href="http://localhost:8000/search/Áà±" target="_blank">
                    <i class="fas fa-search"></i> –ü–æ–∏—Å–∫ —Å–ª–æ–≤
                </a>
            </div>
            <p style="margin-top: 20px; opacity: 0.8;">
                üéå HSK AI Tutor v1.0 | 5462 —Å–ª–æ–≤ –≤ –±–∞–∑–µ | –ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
            </p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
<div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;">
        <h3 style="margin-bottom: 20px; color: var(--primary);">
            <i class="fas fa-sign-in-alt"></i> –í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç
        </h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
            <input type="email" id="loginEmail" placeholder="–≤–∞—à@email.com" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="loginPassword" placeholder="–ø–∞—Ä–æ–ª—å" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
            <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
        </button>
        
        <button onclick="hideLoginForm()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </button>
        
        <p style="margin-top: 15px; text-align: center;">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showRegisterFormFull()" style="color: var(--primary);">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
        </p>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="registerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px; color: var(--primary);">
            <i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        </h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ò–º—è:</label>
            <input type="text" id="regNameFull" placeholder="–í–∞—à–µ –∏–º—è" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
            <input type="email" id="regEmail" placeholder="–≤–∞—à@email.com" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="regPassword" placeholder="–Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å HSK:</label>
            <select id="regCurrentLevelFull" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                <option value="1">HSK 1 (–Ω–æ–≤–∏—á–æ–∫)</option>
                <option value="2">HSK 2 (–±–∞–∑–æ–≤—ã–π)</option>
                <option value="3">HSK 3 (—Å—Ä–µ–¥–Ω–∏–π)</option>
                <option value="4" selected>HSK 4 (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)</option>
                <option value="5">HSK 5 (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π)</option>
                <option value="6">HSK 6 (–º–∞—Å—Ç–µ—Ä)</option>
            </select>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</label>
            <select id="regTargetLevelFull" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                <option value="2">HSK 2</option>
                <option value="3">HSK 3</option>
                <option value="4" selected>HSK 4</option>
                <option value="5">HSK 5</option>
                <option value="6">HSK 6</option>
            </select>
        </div>
        
        <button onclick="registerFull()" class="btn btn-success" style="width: 100%;">
            <i class="fas fa-check"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </button>
        
        <button onclick="hideRegisterForm()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </button>
        
        <p style="margin-top: 15px; text-align: center;">
            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="showLoginForm()" style="color: var(--primary);">–í–æ–π—Ç–∏</a>
        </p>
    </div>
</div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentTest = null;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —ç—Å—Å–µ
let currentEssayAnalysisData = null;
let essayAnalysisTimer = null;
let essayAnalysisTimeLeft = 0;

// –î–æ–±–∞–≤–∏—Ç—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentAudioLesson = null;
let audioUtterance = null;
let isAudioPlaying = false;
let audioHistory = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏—è
function initAudioTab() {
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
    loadAvailableVoices();
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    setAudioDifficulty('easy');
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
function setAudioDifficulty(difficulty) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.audio-difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
    const activeBtn = document.querySelector(`.audio-difficulty-btn:nth-child(${difficulty === 'easy' ? 1 : difficulty === 'medium' ? 2 : 3})`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('audioDifficulty').value = difficulty;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–∞
function loadAudioExample(type) {
    const examples = {
        'greetings': {
            topic: "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ",
            description: "–ü—Ä–æ—Å—Ç—ã–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø—Ä–æ—â–∞–Ω–∏—è –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º."
        },
        'food': {
            topic: "–ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É—Ö–Ω—è –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã",
            description: "–†–∞–∑–≥–æ–≤–æ—Ä –æ –µ–¥–µ, –∑–∞–∫–∞–∑ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ, –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥ –∏ –≤–∫—É—Å–æ–≤."
        },
        'travel': {
            topic: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ö–∏—Ç–∞—é",
            description: "–î–∏–∞–ª–æ–≥–∏ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É, –æ—Ç–µ–ª–µ, —Ç–∞–∫—Å–∏, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."
        },
        'culture': {
            topic: "–ö–∏—Ç–∞–π—Å–∫–∏–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏",
            description: "–û –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ, –ø—Ä–∞–∑–¥–Ω–∏–∫–∞—Ö, –æ–±—ã—á–∞—è—Ö –∏ —ç—Ç–∏–∫–µ—Ç–µ."
        },
        'business': {
            topic: "–î–µ–ª–æ–≤–æ–π –∫–∏—Ç–∞–π—Å–∫–∏–π",
            description: "–ë–∏–∑–Ω–µ—Å-–≤—Å—Ç—Ä–µ—á–∏, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ."
        }
    };
    
    if (examples[type]) {
        document.getElementById('audioTopic').value = examples[type].topic;
        document.getElementById('audioDescription').value = examples[type].description;
    }
}

async function generateAudioLesson() {
    const topic = document.getElementById('audioTopic').value.trim();
    const description = document.getElementById('audioDescription').value.trim();
    const hskLevel = parseInt(document.getElementById('audioHskLevel').value);
    const difficulty = document.getElementById('audioDifficulty').value;
    const duration = document.getElementById('audioDuration').value;
    const includePinyin = document.getElementById('includePinyin').checked;
    const includeTranslation = document.getElementById('includeTranslation').checked;
    
    if (!topic) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–æ–¥–∫–∞—Å—Ç–∞!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const generateBtn = document.getElementById('generateAudioBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–æ–¥–∫–∞—Å—Ç...';
    generateBtn.disabled = true;
    
    try {
        const requestData = {
            topic: topic,
            description: description || "",
            difficulty: difficulty,
            hsk_level: hskLevel,
            target_length: duration,
            include_pinyin: includePinyin,
            include_translation: includeTranslation
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞:", requestData);
        
        const response = await fetch(`${API_BASE}/audio/generate-lesson`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
            
            // –ü—Ä–æ–±—É–µ–º —Å user_id –µ—Å–ª–∏ –µ—Å—Ç—å
            if (currentUser?.user_id) {
                console.log("–ü—Ä–æ–±—É—é —Å user_id...");
                requestData.user_id = currentUser.user_id;
                
                const retryResponse = await fetch(`${API_BASE}/audio/generate-lesson`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (retryResponse.ok) {
                    const result = await retryResponse.json();
                    console.log("–ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞:", result);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫
                    currentAudioLesson = result;
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    displayAudioLesson(result);
                    
                    showNotification('‚úÖ –ü–æ–¥–∫–∞—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –ù–∞–∂–º–∏—Ç–µ "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.');
                    return;
                }
            }
            
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞:", result);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫
        currentAudioLesson = result;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        displayAudioLesson(result);
        
        showNotification('‚úÖ –ü–æ–¥–∫–∞—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –ù–∞–∂–º–∏—Ç–µ "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–∫–∞—Å—Ç–∞');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback —É—Ä–æ–∫
        showFallbackAudioLesson(topic, hskLevel, difficulty, duration);
        
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞
function displayAudioLesson(lesson) {
    const resultSection = document.getElementById('audioResultSection');
    const contentDiv = document.getElementById('audioContent');
    const vocabularyDiv = document.getElementById('audioVocabulary');
    const questionsDiv = document.getElementById('audioQuestions');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    resultSection.style.display = 'block';
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    let contentHTML = `
        <h3 style="color: var(--primary); margin-bottom: 15px;">
            <i class="fas fa-headphones"></i> ${lesson.title}
        </h3>
        <div style="color: var(--gray); margin-bottom: 20px;">
            <span class="word-level" style="margin-right: 10px;">HSK ${lesson.hsk_level}</span>
            <span class="word-level" style="background: ${getDifficultyColor(lesson.difficulty)};">
                ${lesson.difficulty}
            </span>
            <span style="margin-left: 10px; font-size: 0.9em;">
                ${Math.floor(lesson.estimated_duration / 60)}:${(lesson.estimated_duration % 60).toString().padStart(2, '0')}
            </span>
        </div>
        
        <div class="podcast-text">
            ${lesson.chinese_text.replace(/\n/g, '<br>')}
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∏–Ω—å–∏–Ω—å –µ—Å–ª–∏ –µ—Å—Ç—å
    if (lesson.pinyin_text) {
        contentHTML += `
            <div class="podcast-pinyin">
                ${lesson.pinyin_text.replace(/\n/g, '<br>')}
            </div>
        `;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (lesson.translation) {
        contentHTML += `
            <div class="podcast-translation">
                <strong>–ü–µ—Ä–µ–≤–æ–¥:</strong><br>
                ${lesson.translation.replace(/\n/g, '<br>')}
            </div>
        `;
    }
    
    contentDiv.innerHTML = contentHTML;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–µ–∫—Å–∏–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    if (lesson.vocabulary && lesson.vocabulary.length > 0) {
        vocabularyDiv.style.display = 'block';
        
        const vocabularyHTML = lesson.vocabulary.map(word => `
            <div class="vocabulary-item">
                <div class="vocabulary-chinese">${word.chinese}</div>
                <div class="vocabulary-details">
                    <div class="vocabulary-pinyin">${word.pinyin}</div>
                    <div class="vocabulary-meaning">${word.translation}</div>
                    ${word.example ? `<div class="vocabulary-example">${word.example}</div>` : ''}
                </div>
                <button class="vocabulary-speak" onclick="speakWord('${word.chinese}')" title="–ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        `).join('');
        
        document.getElementById('vocabularyList').innerHTML = vocabularyHTML;
    } else {
        vocabularyDiv.style.display = 'none';
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if (lesson.comprehension_questions && lesson.comprehension_questions.length > 0) {
        questionsDiv.style.display = 'block';
        
        const questionsHTML = lesson.comprehension_questions.map((q, index) => `
            <div class="test-question" style="margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px;">
                    ${index + 1}. ${q.question}
                </div>
                <div class="test-options">
                    ${q.options.map((opt, optIndex) => `
                        <div class="test-option" onclick="checkComprehensionAnswer(this, ${index}, ${optIndex}, ${q.correct_answer})">
                            ${String.fromCharCode(65 + optIndex)}) ${opt}
                        </div>
                    `).join('')}
                </div>
                <div id="question-explanation-${index}" style="display: none; margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #1976d2;">
                    ${q.explanation || ''}
                </div>
            </div>
        `).join('');
        
        document.getElementById('questionsList').innerHTML = questionsHTML;
    } else {
        questionsDiv.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è —Å–ª–æ–≤–∞
function speakWord(text) {
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.pitch = 1;
        
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh-CN') || voice.lang.startsWith('zh')
        );
        
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        speechSynthesis.speak(utterance);
    } else {
        alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞');
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–Ω–∏–º–∞–Ω–∏—è
function checkComprehensionAnswer(element, questionIndex, selectedIndex, correctIndex) {
    const questionDiv = element.closest('.test-question');
    const options = questionDiv.querySelectorAll('.test-option');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    options.forEach(opt => {
        opt.classList.remove('correct', 'wrong');
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    if (selectedIndex === correctIndex) {
        element.classList.add('correct');
        element.style.borderColor = 'var(--success)';
        element.style.background = '#e3f2fd';
    } else {
        element.classList.add('wrong');
        element.style.borderColor = 'var(--danger)';
        element.style.background = '#fde8e8';
        
        // –í—ã–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        options[correctIndex].classList.add('correct');
        options[correctIndex].style.borderColor = 'var(--success)';
        options[correctIndex].style.background = '#e3f2fd';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    const explanationDiv = document.getElementById(`question-explanation-${questionIndex}`);
    if (explanationDiv) {
        explanationDiv.style.display = 'block';
    }
}

// –¶–≤–µ—Ç –¥–ª—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
function getDifficultyColor(difficulty) {
    const colors = {
        'easy': '#4cd964',
        'medium': '#ff9a00',
        'hard': '#f5576c'
    };
    return colors[difficulty] || '#667eea';
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –ø–æ–¥–∫–∞—Å—Ç–∞
function playAudioPodcast() {
    if (!currentAudioLesson) return;
    
    const playBtn = document.getElementById('playAudioBtn');
    const pauseBtn = document.getElementById('pauseAudioBtn');
    
    if (isAudioPlaying) {
        pauseAudioPodcast();
        return;
    }
    
    isAudioPlaying = true;
    playBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Speech API –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const textToSpeak = currentAudioLesson.chinese_text;
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = 'zh-CN';
        utterance.rate = parseFloat(document.getElementById('audioSpeed').value);
        utterance.volume = 1;
        utterance.pitch = 1;
        
        // –í—ã–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å
        const voiceSelect = document.getElementById('audioVoice');
        const selectedVoice = voiceSelect.value;
        if (selectedVoice && selectedVoice !== 'default') {
            const voices = speechSynthesis.getVoices();
            const voice = voices.find(v => v.name === selectedVoice);
            if (voice) {
                utterance.voice = voice;
            }
        }
        
        utterance.onstart = () => {
            console.log('–ù–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
            startAudioProgress();
        };
        
        utterance.onend = () => {
            console.log('–ö–æ–Ω–µ—Ü –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
            isAudioPlaying = false;
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopAudioProgress();
        };
        
        utterance.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', event);
            isAudioPlaying = false;
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopAudioProgress();
        };
        
        speechSynthesis.speak(utterance);
        
    } else {
        alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏');
    }
}

// –ü–∞—É–∑–∞ –∞—É–¥–∏–æ
function pauseAudioPodcast() {
    if ('speechSynthesis' in window) {
        speechSynthesis.pause();
        isAudioPlaying = false;
        
        const playBtn = document.getElementById('playAudioBtn');
        const pauseBtn = document.getElementById('pauseAudioBtn');
        playBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
        
        pauseAudioProgress();
    }
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—É–¥–∏–æ
function stopAudioPodcast() {
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        isAudioPlaying = false;
        
        const playBtn = document.getElementById('playAudioBtn');
        const pauseBtn = document.getElementById('pauseAudioBtn');
        playBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
        
        stopAudioProgress();
    }
}

// –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
let audioProgressInterval = null;
let audioStartTime = null;
let audioTotalDuration = 0;

function startAudioProgress() {
    stopAudioProgress();
    
    // –û—Ü–µ–Ω–∏–≤–∞–µ–º –æ–±—â—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–æ 150 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
    const textLength = currentAudioLesson.chinese_text.length;
    audioTotalDuration = Math.max(30, Math.floor(textLength / 150 * 60)); // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    audioStartTime = Date.now();
    audioProgressInterval = setInterval(updateAudioProgress, 100);
    
    document.getElementById('audioTotalTime').textContent = formatTime(audioTotalDuration);
}

function updateAudioProgress() {
    if (!audioStartTime) return;
    
    const elapsed = Math.floor((Date.now() - audioStartTime) / 1000);
    const progress = Math.min(100, (elapsed / audioTotalDuration) * 100);
    
    document.getElementById('audioProgress').style.width = `${progress}%`;
    document.getElementById('audioCurrentTime').textContent = formatTime(elapsed);
}

function pauseAudioProgress() {
    clearInterval(audioProgressInterval);
}

function stopAudioProgress() {
    clearInterval(audioProgressInterval);
    audioProgressInterval = null;
    audioStartTime = null;
    
    document.getElementById('audioProgress').style.width = '0%';
    document.getElementById('audioCurrentTime').textContent = '0:00';
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
function changeAudioSpeed() {
    if (isAudioPlaying && 'speechSynthesis' in window) {
        // –ï—Å–ª–∏ –∞—É–¥–∏–æ –∏–≥—Ä–∞–µ—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
        speechSynthesis.cancel();
        setTimeout(() => playAudioPodcast(), 100);
    }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞
function changeAudioVoice() {
    if (isAudioPlaying && 'speechSynthesis' in window) {
        speechSynthesis.cancel();
        setTimeout(() => playAudioPodcast(), 100);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
function loadAvailableVoices() {
    if ('speechSynthesis' in window) {
        // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤
        setTimeout(() => {
            const voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('audioVoice');
            
            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
            voiceSelect.innerHTML = '<option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∏—Ç–∞–π—Å–∫–∏–µ –≥–æ–ª–æ—Å–∞
            const chineseVoices = voices.filter(voice => 
                voice.lang.startsWith('zh-CN') || 
                voice.lang.startsWith('zh') ||
                voice.name.toLowerCase().includes('chinese')
            );
            
            chineseVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∏—Ç–∞–π—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
            if (chineseVoices.length === 0) {
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            }
        }, 1000);
    }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–∫–∞—Å—Ç–∞
function downloadAudioText() {
    if (!currentAudioLesson) return;
    
    const content = `
–¢–µ–º–∞: ${currentAudioLesson.title}
–£—Ä–æ–≤–µ–Ω—å: HSK ${currentAudioLesson.hsk_level}
–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${currentAudioLesson.difficulty}

${currentAudioLesson.chinese_text}

${currentAudioLesson.pinyin_text ? `\n–ü–∏–Ω—å–∏–Ω—å:\n${currentAudioLesson.pinyin_text}` : ''}

${currentAudioLesson.translation ? `\n–ü–µ—Ä–µ–≤–æ–¥:\n${currentAudioLesson.translation}` : ''}

${currentAudioLesson.vocabulary && currentAudioLesson.vocabulary.length > 0 ? 
`\n–õ–µ–∫—Å–∏–∫–∞:\n${currentAudioLesson.vocabulary.map(word => 
    `${word.chinese} (${word.pinyin}) - ${word.translation}`).join('\n')}` : ''}
    `;
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `podcast_${currentAudioLesson.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// –í frontend.html –∑–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é saveAudioLesson()
function saveAudioLesson() {
    if (!currentAudioLesson) return;
    
    try {
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        const historyItem = {
            id: currentAudioLesson.id || `audio_${Date.now()}`,
            title: currentAudioLesson.title,
            topic: currentAudioLesson.topic || document.getElementById('audioTopic').value,
            hsk_level: currentAudioLesson.hsk_level || parseInt(document.getElementById('audioHskLevel').value),
            difficulty: currentAudioLesson.difficulty || document.getElementById('audioDifficulty').value,
            duration: currentAudioLesson.estimated_duration || 180,
            character_count: currentAudioLesson.chinese_text?.length || 0,
            generated_at: currentAudioLesson.generated_at || new Date().toISOString(),
            saved_at: new Date().toISOString()
        };
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é
        const savedHistory = localStorage.getItem('hsk_audio_history');
        let history = savedHistory ? JSON.parse(savedHistory) : [];
        
        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        history = history.filter(item => item.id !== historyItem.id);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
        history.unshift(historyItem);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if (history.length > 20) {
            history = history.slice(0, 20);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        localStorage.setItem('hsk_audio_history', JSON.stringify(history));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        updateAudioHistory();
        
        showNotification('‚úÖ –£—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é!');
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        if (currentUser?.user_id) {
            saveAudioLessonToServer(historyItem);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Ä–æ–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function saveAudioLessonToServer(lessonData) {
    try {
        const response = await fetch(`${API_BASE}/audio/save-lesson`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUser.user_id,
                lesson: lessonData
            })
        });
        
        if (response.ok) {
            console.log('–£—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', error);
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é updateAudioHistory()
function updateAudioHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    try {
        const savedHistory = localStorage.getItem('hsk_audio_history');
        const history = savedHistory ? JSON.parse(savedHistory) : [];
        
        if (history.length === 0) {
            historyList.innerHTML = `
                <div style="text-align: center; color: var(--gray); padding: 20px;">
                    <div style="font-size: 2em;">üìö</div>
                    <p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
                    <p style="font-size: 0.9em;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥–∫–∞—Å—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            `;
            return;
        }
        
        historyList.innerHTML = history.map(item => `
            <div style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; 
                        border-left: 4px solid var(--primary); cursor: pointer;" 
                 onclick="loadAudioLessonFromHistory('${item.id}')">
                <div style="font-weight: bold; display: flex; justify-content: space-between;">
                    <span>${item.title?.substring(0, 30) || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</span>
                    <span style="font-size: 0.8em; color: var(--gray);">
                        HSK ${item.hsk_level || 3}
                    </span>
                </div>
                <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                    ${formatDate(item.saved_at || item.generated_at)} ‚Ä¢ ${item.difficulty || 'medium'}
                </div>
                ${item.character_count ? `
                    <div style="font-size: 0.8em; color: var(--gray); margin-top: 3px;">
                        ${item.character_count} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
        historyList.innerHTML = '<p style="color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>';
    }
}

async function loadAudioLessonFromHistory(lessonId) {
    try {
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å user_id
        let lesson = null;
        
        if (currentUser?.user_id) {
            const response = await fetch(`${API_BASE}/audio/load-lesson`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lesson_id: lessonId,
                    user_id: currentUser.user_id
                })
            });
            
            if (response.ok) {
                lesson = await response.json();
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –∏—â–µ–º –≤ localStorage
        if (!lesson) {
            const savedHistory = localStorage.getItem('hsk_audio_history');
            const history = savedHistory ? JSON.parse(savedHistory) : [];
            lesson = history.find(item => item.id === lessonId);
        }
        
        if (lesson) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–∫
            currentAudioLesson = lesson;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
            displayAudioLesson(lesson);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            document.getElementById('audioResultSection').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('‚úÖ –£—Ä–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏!');
        } else {
            showNotification('‚ùå –£—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏–∏');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏');
    }
}

function showFallbackAudioLesson(topic, hskLevel, difficulty, duration) {
    const fallbackLesson = {
        id: `fallback_audio_${Date.now()}`,
        title: topic,
        hsk_level: hskLevel,
        difficulty: difficulty,
        estimated_duration: duration === 'short' ? 90 : duration === 'medium' ? 180 : 300,
        chinese_text: `Â§ßÂÆ∂Â•ΩÔºÅ‰ªäÂ§©Êàë‰ª¨Êù•ËÅä‰∏ÄËÅä"${topic}"„ÄÇ

Ëøô‰∏™ËØùÈ¢òÂØπ‰∏≠ÂõΩÂ≠¶ÁîüÊù•ËØ¥ÂæàÈáçË¶Å„ÄÇËÆ©Êàë‰ª¨‰∏ÄËµ∑Â≠¶‰π†ÂêßÔºÅ

È¶ñÂÖàÔºå${topic}ÊòØÂæàÊúâÊÑèÊÄùÁöÑ‰∏ªÈ¢ò„ÄÇÂú®ÂæàÂ§öÊñπÈù¢ÔºåËøô‰∏™ËØùÈ¢òÂèØ‰ª•Â∏ÆÂä©Êàë‰ª¨ÁêÜËß£‰∏≠ÂõΩÊñáÂåñÂíåËØ≠Ë®Ä„ÄÇ

ÊØîÂ¶ÇËØ¥ÔºåÂΩì‰Ω†Â≠¶‰π†ÂÖ≥‰∫é${topic}ÁöÑ‰∏≠ÊñáÊó∂Ôºå‰Ω†‰ºöÂ≠¶Âà∞ÂæàÂ§öÊñ∞ËØçËØ≠ÂíåË°®ËææÊñπÂºè„ÄÇËøôÂØπ‰∫éÊèêÈ´ò‰Ω†ÁöÑÊ±âËØ≠Ê∞¥Âπ≥ÂæàÊúâÂ∏ÆÂä©„ÄÇ

ËÆ∞‰ΩèÔºåÂ≠¶‰π†ËØ≠Ë®ÄÈúÄË¶ÅÊó∂Èó¥ÂíåËÄêÂøÉ„ÄÇÊØèÂ§©ÂùöÊåÅÂ≠¶‰π†‰∏ÄÁÇπÁÇπÔºå‰Ω†Â∞±‰ºöÁúãÂà∞ËøõÊ≠•„ÄÇ

Â•Ω‰∫ÜÔºå‰ªäÂ§©ÁöÑÂÜÖÂÆπÂ∞±Âà∞ËøôÈáå„ÄÇÂ∏åÊúõËøô‰∏™Êí≠ÂÆ¢ÂØπ‰Ω†ÊúâÂ∏ÆÂä©„ÄÇ‰∏ãÊ¨°ÂÜçËßÅÔºÅ`,
        pinyin_text: `D√†jiƒÅ h«éo! Jƒ´ntiƒÅn w«ímen l√°i li√°o yƒ´ li√°o "${topic}"„ÄÇ

Zh√®ge hu√†t√≠ du√¨ Zh≈çnggu√≥ xu√©shƒìng l√°i shu≈ç hƒõn zh√≤ngy√†o. R√†ng w«ímen yƒ´q«ê xu√©x√≠ ba!

Sh«íuxiƒÅn, ${topic} sh√¨ hƒõn y«íuy√¨si de zh«ît√≠. Z√†i hƒõndu≈ç fƒÅngmi√†n, zh√®ge hu√†t√≠ kƒõy«ê bƒÅngzh√π w«ímen l«êjiƒõ Zh≈çnggu√≥ w√©nhu√† h√© y«îy√°n.

B«êr√∫ shu≈ç, dƒÅng n«ê xu√©x√≠ guƒÅny√∫ ${topic} de Zh≈çngw√©n sh√≠, n«ê hu√¨ xu√© d√†o hƒõndu≈ç xƒ´n c√≠y«î h√© bi«éod√° fƒÅngsh√¨. Zh√® du√¨y√∫ t√≠gƒÅo n«ê de H√†ny«î shu«êp√≠ng hƒõn y«íu bƒÅngzh√π.

J√¨zh√π, xu√©x√≠ y«îy√°n x≈´y√†o sh√≠jiƒÅn h√© n√†ixƒ´n. Mƒõi tiƒÅn jiƒÅnch√≠ xu√©x√≠ yƒ´di«éndi«én, n«ê ji√π hu√¨ k√†n d√†o j√¨nb√π.

H«éole, jƒ´ntiƒÅn de n√®ir√≥ng ji√π d√†o zh√®l«ê. Xƒ´w√†ng zh√®ge b≈çk√® du√¨ n«ê y«íu bƒÅngzh√π. Xi√†c√¨ z√†iji√†n!`,
        translation: `–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç! –°–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ "${topic}".

–≠—Ç–∞ —Ç–µ–º–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤. –î–∞–≤–∞–π—Ç–µ —É—á–∏—Ç—å—Å—è –≤–º–µ—Å—Ç–µ!

–í–æ-–ø–µ—Ä–≤—ã—Ö, ${topic} - –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ–º–∞. –í–æ –º–Ω–æ–≥–∏—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö, —ç—Ç–∞ —Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –Ω–∞–º –ø–æ–Ω—è—Ç—å –∫–∏—Ç–∞–π—Å–∫—É—é –∫—É–ª—å—Ç—É—Ä—É –∏ —è–∑—ã–∫.

–ù–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ –≤—ã –∏–∑—É—á–∞–µ—Ç–µ –∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫ –Ω–∞ —Ç–µ–º—É ${topic}, –≤—ã –≤—ã—É—á–∏—Ç–µ –º–Ω–æ–≥–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–π. –≠—Ç–æ –æ—á–µ–Ω—å –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –ø–æ–≤—ã—Å–∏—Ç—å –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ.

–ü–æ–º–Ω–∏—Ç–µ, –∏–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç–µ—Ä–ø–µ–Ω–∏—è. –£—á–∏—Ç–µ—Å—å –ø–æ–Ω–µ–º–Ω–æ–≥—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å.

–•–æ—Ä–æ—à–æ, –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ. –ù–∞–¥–µ—é—Å—å, —ç—Ç–æ—Ç –ø–æ–¥–∫–∞—Å—Ç –±—ã–ª –≤–∞–º –ø–æ–ª–µ–∑–µ–Ω. –î–æ —Å–∫–æ—Ä–æ–π –≤—Å—Ç—Ä–µ—á–∏!`,
        vocabulary: [
            {
                chinese: 'ËØùÈ¢ò',
                pinyin: 'hu√†t√≠',
                translation: '—Ç–µ–º–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞',
                example: '‰ªäÂ§©ÁöÑËØùÈ¢òÂæàÊúâÊÑèÊÄù„ÄÇ'
            },
            {
                chinese: 'Â≠¶‰π†',
                pinyin: 'xu√©x√≠',
                translation: '—É—á–∏—Ç—å—Å—è',
                example: 'ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá„ÄÇ'
            },
            {
                chinese: 'ÈáçË¶Å',
                pinyin: 'zh√≤ngy√†o',
                translation: '–≤–∞–∂–Ω—ã–π',
                example: 'Ëøô‰∏™ËÄÉËØïÂæàÈáçË¶Å„ÄÇ'
            },
            {
                chinese: 'Â∏ÆÂä©',
                pinyin: 'bƒÅngzh√π',
                translation: '–ø–æ–º–æ–≥–∞—Ç—å',
                example: 'ÊàëÂèØ‰ª•Â∏ÆÂä©‰Ω†Â≠¶‰π†‰∏≠Êñá„ÄÇ'
            }
        ],
        comprehension_questions: [
            {
                question: '‰ªäÂ§©Êàë‰ª¨Ë¶ÅËÅä‰ªÄ‰πàËØùÈ¢òÔºü',
                options: ['‰∏≠Êñá', topic, 'Â≠¶‰π†', 'ËÄÉËØï'],
                correct_answer: 1,
                explanation: '‰ªäÂ§©Êàë‰ª¨ËÅäÁöÑËØùÈ¢òÊòØÔºö' + topic
            },
            {
                question: 'Â≠¶‰π†Ëøô‰∏™‰∏ªÈ¢òÈáçË¶ÅÂêóÔºü',
                options: ['‰∏çÈáçË¶Å', 'Êúâ‰∏ÄÁÇπÈáçË¶Å', 'ÂæàÈáçË¶Å', '‰∏çÁü•ÈÅì'],
                correct_answer: 2,
                explanation: 'Êí≠ÂÆ¢‰∏≠ËØ¥ÔºöËøô‰∏™ËØùÈ¢òÂæàÈáçË¶Å„ÄÇ'
            }
        ],
        generated_at: new Date().toISOString(),
        ai_generated: false,
        fallback: true
    };
    
    currentAudioLesson = fallbackLesson;
    displayAudioLesson(fallbackLesson);
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —ç—Å—Å–µ
function setEssayDifficulty(difficulty) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.essay-difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
    const activeBtn = document.querySelector(`.essay-difficulty-btn[data-difficulty="${difficulty}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('essayDifficulty').value = difficulty;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–∞ —Ç–µ–º—ã
function loadEssayExample(type) {
    const examples = {
        'culture': {
            topic: "–í–ª–∏—è–Ω–∏–µ –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏—Ä",
            details: "–û–±—Å—É–¥–∏—Ç–µ –∫–∞–∫ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è –∫–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ (–∫–æ–Ω—Ñ—É—Ü–∏–∞–Ω—Å—Ç–≤–æ, –∏—Å–∫—É—Å—Å—Ç–≤–æ, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è) –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ –∏ –º–∏—Ä–æ–≤—É—é –∫—É–ª—å—Ç—É—Ä—É."
        },
        'technology': {
            topic: "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏ –±—É–¥—É—â–µ–µ –ö–∏—Ç–∞—è",
            details: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–æ–ª—å –ò–ò –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ –∫–∏—Ç–∞–π—Å–∫–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ –æ–±—â–µ—Å—Ç–≤–∞. –ö–∞–∫–∏–µ —ç—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –≤–æ–∑–Ω–∏–∫–∞—é—Ç?"
        },
        'education': {
            topic: "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∏—Ç–∞–π—Å–∫–æ–π –∏ –∑–∞–ø–∞–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è",
            details: "–°—Ä–∞–≤–Ω–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –æ–±—É—á–µ–Ω–∏—é, —Ü–µ–ª–∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ö–∞–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ —É –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã?"
        },
        'environment': {
            topic: "–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —É—Å—Ç–æ–π—á–∏–≤–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –≤ –ö–∏—Ç–∞–µ",
            details: "–û–±—Å—É–¥–∏—Ç–µ –º–µ—Ä—ã, –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–µ –ö–∏—Ç–∞–µ–º –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã –ª–∏ —ç—Ç–∏ –º–µ—Ä—ã?"
        },
        'globalization': {
            topic: "–†–æ–ª—å –ö–∏—Ç–∞—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–µ",
            details: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–∞–∫ –ö–∏—Ç–∞–π –∏–∑–º–µ–Ω–∏–ª –º–∏—Ä–æ–≤—É—é —ç–∫–æ–Ω–æ–º–∏–∫—É —á–µ—Ä–µ–∑ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É '–û–¥–∏–Ω –ø–æ—è—Å, –æ–¥–∏–Ω –ø—É—Ç—å' –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã."
        }
    };
    
    if (examples[type]) {
        document.getElementById('essayAnalysisTopic').value = examples[type].topic;
        document.getElementById('essayAnalysisDetails').value = examples[type].details;
    }
}

// –ó–ê–ú–ï–ù–ò–¢–ï —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é generateEssayPrompt() –Ω–∞ —ç—Ç—É:
async function generateEssayPrompt() {
    const topic = document.getElementById('essayAnalysisTopic').value.trim();
    const details = document.getElementById('essayAnalysisDetails').value.trim();
    const difficulty = document.getElementById('essayDifficulty').value;
    const length = parseInt(document.getElementById('essayAnalysisLength').value);
    
    if (!topic) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É —ç—Å—Å–µ!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const generateBtn = document.getElementById('generateEssayBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∑–∞–¥–∞–Ω–∏–µ...';
    generateBtn.disabled = true;
    
    try {
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–Ω–æ –º–æ–¥–µ–ª–∏ –±—ç–∫–µ–Ω–¥–∞
        const requestData = {
            topic: topic,
            details: details,
            difficulty: difficulty,
            target_length: length,
            user_id: currentUser?.user_id || null
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∑–∞–¥–∞–Ω–∏—è:", requestData);
        
        const response = await fetch(`${API_BASE}/essay/analysis/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:", data);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        currentEssayAnalysisData = {
            prompt: data.prompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            requirements: data.requirements,
            evaluation_criteria: data.evaluation_criteria,
            time_limit_minutes: data.time_limit_minutes || 60,
            start_time: new Date(),
            api_data: data  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ API
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è
        showEssayAnalysisArea(data.prompt, length);
        
        showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ! –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —ç—Å—Å–µ.');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
        
        // Fallback: –ª–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        const fallbackPrompt = generateFallbackEssayPrompt(topic, difficulty, length);
        currentEssayAnalysisData = {
            prompt: fallbackPrompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            start_time: new Date()
        };
        
        showEssayAnalysisArea(fallbackPrompt, length);
        
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏—è
function generateFallbackEssayPrompt(topic, difficulty, length) {
    const difficultyTexts = {
        'beginner': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –±–∞–∑–æ–≤—É—é –ª–µ–∫—Å–∏–∫—É.',
        'intermediate': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –ª–µ–∫—Å–∏–∫—É.',
        'advanced': '–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤–ª–∞–¥–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã–º–∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.',
        'exam': '–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–ª–∞–¥–µ–Ω–∏—è —è–∑—ã–∫–æ–º –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ.'
    };
    
    const lengthTexts = {
        200: '–û–±—ä–µ–º: 200-300 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤',
        400: '–û–±—ä–µ–º: 400-500 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤',
        600: '–û–±—ä–µ–º: 600-700 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤',
        800: '–û–±—ä–µ–º: 800+ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤'
    };
    
    return `
        <h4>–¢–µ–º–∞: ${topic}</h4>
        <p><strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> –ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É. –í–∞—à–µ —ç—Å—Å–µ –¥–æ–ª–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å:</p>
        <ul>
            <li>–í–≤–µ–¥–µ–Ω–∏–µ —Å —Ç–µ–∑–∏—Å–æ–º</li>
            <li>2-3 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏</li>
            <li>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –≤—ã–≤–æ–¥–∞–º–∏</li>
        </ul>
        <p><strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong></p>
        <ul>
            <li>${lengthTexts[length] || '400-500 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤'}</li>
            <li>${difficultyTexts[difficulty] || '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'}</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Å–≤—è–∑—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã</li>
            <li>–ò–∑–±–µ–≥–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫</li>
        </ul>
        <p><strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong> —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (40%), –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ (30%), –ª–µ–∫—Å–∏–∫–∞ (20%), —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (10%).</p>
    `;
}

// –ü–æ–∫–∞–∑ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è
function showEssayAnalysisArea(prompt, targetLength) {
    // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    document.querySelector('#essay-analysis-tab .section > div:first-child').style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    document.getElementById('essayAnalysisArea').style.display = 'block';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    document.getElementById('essayAnalysisPrompt').innerHTML = prompt;
    document.getElementById('essayAnalysisTarget').textContent = targetLength;
    document.getElementById('essayAnalysisCharsLeft').textContent = targetLength;
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('essayAnalysisText').value = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    updateEssayAnalysisCounter();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    essayAnalysisTimeLeft = difficultyToTime(currentEssayAnalysisData.difficulty);
    startEssayAnalysisTimer();
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    setTimeout(() => {
        document.getElementById('essayAnalysisText').focus();
    }, 300);
}

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è
function difficultyToTime(difficulty) {
    const times = {
        'beginner': 45 * 60,     // 45 –º–∏–Ω—É—Ç
        'intermediate': 60 * 60,  // 60 –º–∏–Ω—É—Ç
        'advanced': 75 * 60,      // 75 –º–∏–Ω—É—Ç
        'exam': 90 * 60          // 90 –º–∏–Ω—É—Ç
    };
    return times[difficulty] || 60 * 60;
}

// –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
function startEssayAnalysisTimer() {
    clearInterval(essayAnalysisTimer);
    
    essayAnalysisTimer = setInterval(() => {
        essayAnalysisTimeLeft--;
        
        const minutes = Math.floor(essayAnalysisTimeLeft / 60);
        const seconds = essayAnalysisTimeLeft % 60;
        document.getElementById('essayAnalysisTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
        if (essayAnalysisTimeLeft < 300) { // 5 –º–∏–Ω—É—Ç
            document.getElementById('essayAnalysisTimer').style.background = 'var(--danger)';
        }
        
        if (essayAnalysisTimeLeft <= 0) {
            clearInterval(essayAnalysisTimer);
            alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ! –≠—Å—Å–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑.');
            submitEssayForAnalysis();
        }
    }, 1000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
function updateEssayAnalysisCounter() {
    const text = document.getElementById('essayAnalysisText').value;
    const charCount = text.length;
    const targetLength = parseInt(document.getElementById('essayAnalysisTarget').textContent);
    
    document.getElementById('essayAnalysisCharCount').textContent = charCount;
    document.getElementById('essayAnalysisCharsLeft').textContent = Math.max(0, targetLength - charCount);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const progress = Math.min(100, (charCount / targetLength) * 100);
    const progressBar = document.getElementById('essayAnalysisProgress');
    progressBar.style.width = `${progress}%`;
    
    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    if (progress >= 100) {
        progressBar.style.background = 'var(--success)';
    } else if (progress >= 50) {
        progressBar.style.background = 'var(--warning)';
    } else {
        progressBar.style.background = 'var(--danger)';
    }
}

// –í—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä—ã—Ö —Ñ—Ä–∞–∑
function insertEssayAnalysisPhrase(type) {
    const textarea = document.getElementById('essayAnalysisText');
    const phrases = {
        'introduction': 'ËøëÂπ¥Êù•Ôºå...ÈóÆÈ¢òÂºïËµ∑‰∫ÜÂπøÊ≥õÂÖ≥Ê≥®„ÄÇÊú¨ÊñáÂ∞Ü‰ªé‰ª•‰∏ãÂá†‰∏™ÊñπÈù¢ËøõË°åÂàÜÊûê„ÄÇ',
        'thesis': 'Á¨îËÄÖËÆ§‰∏∫Ôºå... ‰∏ªË¶ÅÊúâ‰ª•‰∏ãÂá†‰∏™ÂéüÂõ†„ÄÇ',
        'argument': 'È¶ñÂÖàÔºå... ÂÖ∂Ê¨°Ôºå... ÊúÄÂêéÔºå...',
        'example': '‰æãÂ¶ÇÔºå... Ëøô‰∏™‰æãÂ≠êÊ∏ÖÊ•öÂú∞Ë°®Êòé...',
        'contrast': '‰∏é...Áõ∏ÊØîÔºå... ÁÑ∂ËÄåÔºå...',
        'conclusion': 'ÊÄªËÄåË®Ä‰πãÔºå... Âõ†Ê≠§ÔºåÊàë‰ª¨Â∫îËØ•...'
    };
    
    if (phrases[type]) {
        textarea.value += phrases[type] + ' ';
        textarea.focus();
        updateEssayAnalysisCounter();
    }
}

// –ü–æ–¥—Å–∫–∞–∑–∫–∞
function showEssayAnalysisHint() {
    const hints = [
        "üí° –ù–∞—á–Ω–∏—Ç–µ —Å –≤–≤–µ–¥–µ–Ω–∏—è, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–º—É –∏ –≤–∞—à—É –ø–æ–∑–∏—Ü–∏—é",
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –≤–≤–µ–¥–µ–Ω–∏–µ ‚Üí –∞—Ä–≥—É–º–µ–Ω—Ç—ã ‚Üí –∑–∞–∫–ª—é—á–µ–Ω–∏–µ",
        "üí° –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ–¥–Ω—É –≥–ª–∞–≤–Ω—É—é –º—ã—Å–ª—å",
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞: È¶ñÂÖàÔºåÂÖ∂Ê¨°ÔºåÊúÄÂêé",
        "üí° –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤",
        "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É, –æ—Å–æ–±–µ–Ω–Ω–æ —á–∞—Å—Ç–∏—Ü—ã ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó"
    ];
    
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    alert(randomHint);
}

// –ó–ê–ú–ï–ù–ò–¢–ï —Ñ—É–Ω–∫—Ü–∏—é submitEssayForAnalysis() –Ω–∞ —ç—Ç—É:
async function submitEssayForAnalysis() {
    const essayText = document.getElementById('essayAnalysisText').value.trim();
    
    if (!essayText) {
        alert('–ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π!');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
    const targetLength = currentEssayAnalysisData.target_length;
    if (essayText.length < targetLength * 0.5) {
        if (!confirm(`–í–∞—à–µ —ç—Å—Å–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (${essayText.length}/${targetLength} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤). –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É?`)) {
            return;
        }
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    clearInterval(essayAnalysisTimer);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const essayArea = document.getElementById('essayAnalysisArea');
    const originalContent = essayArea.innerHTML;
    
    essayArea.innerHTML = `
        <div style="text-align: center; padding: 50px 0;">
            <div class="loading-spinner" style="margin: 0 auto;"></div>
            <h3 style="margin-top: 20px; color: var(--primary);">AI –°–¢–†–û–ì–û –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à–µ —ç—Å—Å–µ...</h3>
            <p style="color: var(--gray);">–ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –∫ –∂–µ—Å—Ç–∫–æ–π, –Ω–æ —á–µ—Å—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–µ</p>
        </div>
    `;
    
    try {
        const requestData = {
            essay_text: essayText,
            topic: currentEssayAnalysisData.topic,
            difficulty: currentEssayAnalysisData.difficulty,
            target_length: currentEssayAnalysisData.target_length,
            user_id: currentUser?.user_id || null,
            time_spent: Math.floor((new Date() - currentEssayAnalysisData.start_time) / 1000)
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é —ç—Å—Å–µ –Ω–∞ —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:", {
            topic: requestData.topic,
            length: essayText.length,
            difficulty: requestData.difficulty
        });
        
        const response = await fetch(`${API_BASE}/essay/analysis/check`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const analysisResult = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:", analysisResult);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        currentEssayAnalysisData.result = analysisResult;
        currentEssayAnalysisData.essay_text = essayText;
        currentEssayAnalysisData.completed_at = new Date().toISOString();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        showEssayAnalysisResult(analysisResult, essayText);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —ç—Å—Å–µ:', error);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        essayArea.innerHTML = originalContent;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (—Å—Ç—Ä–æ–≥–∏–π)
        showLocalEssayAnalysis(essayText);
    }
}


// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getCategoryName(category) {
    const names = {
        'content': '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ',
        'grammar': '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞',
        'vocabulary': '–õ–µ–∫—Å–∏–∫–∞',
        'structure': '–°—Ç—Ä—É–∫—Ç—É—Ä–∞'
    };
    return names[category] || category;
}

function getDefaultFeedback(category) {
    const feedbacks = {
        'content': '–•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π',
        'grammar': '–ï—Å—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –æ—à–∏–±–∫–∏, –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏—Ü—ã',
        'vocabulary': '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª–æ–≤',
        'structure': '–õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏'
    };
    return feedbacks[category] || '–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞!';
}

function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

function calculateLocalEssayScore(essayText) {
    // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ—Ü–µ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    let score = 0;
    
    // 1. –î–ª–∏–Ω–∞ —ç—Å—Å–µ (–º–∞–∫—Å–∏–º—É–º 30 –±–∞–ª–ª–æ–≤)
    const targetLength = currentEssayAnalysisData.target_length;
    const lengthRatio = Math.min(1, essayText.length / targetLength);
    score += Math.round(lengthRatio * 30);
    
    // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–º–∞–∫—Å–∏–º—É–º 20 –±–∞–ª–ª–æ–≤)
    const sentenceCount = essayText.split(/[„ÄÇÔºÅÔºü]/).filter(s => s.trim()).length;
    const minSentences = Math.max(5, targetLength / 50);
    if (sentenceCount >= minSentences) {
        score += Math.min(20, (sentenceCount / minSentences) * 20);
    }
    
    // 3. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã (–º–∞–∫—Å–∏–º—É–º 25 –±–∞–ª–ª–æ–≤)
    const uniqueChars = new Set(essayText.match(/[\u4e00-\u9fff]/g) || []).size;
    const minUnique = Math.max(30, targetLength * 0.3);
    if (uniqueChars >= minUnique) {
        score += Math.min(25, (uniqueChars / minUnique) * 25);
    }
    
    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å (–º–∞–∫—Å–∏–º—É–º 25 –±–∞–ª–ª–æ–≤)
    const difficulty = currentEssayAnalysisData.difficulty;
    const complexityScore = difficulty === 'beginner' ? 20 :
                          difficulty === 'intermediate' ? 22 :
                          difficulty === 'advanced' ? 24 : 25;
    score += complexityScore;
    
    return Math.min(100, score);
}

// –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
function showLocalEssayAnalysis(essayText) {
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã
    const overallScore = calculateLocalEssayScore(essayText);
    
    const mockResult = {
        overall_score: overallScore,
        content_analysis: {
            score: Math.floor(overallScore * 0.95),
            feedback: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π –∏ –ø—Ä–∏–º–µ—Ä–æ–≤.'
        },
        grammar_analysis: {
            score: Math.floor(overallScore * 0.85),
            feedback: '–•–æ—Ä–æ—à–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –Ω–æ –µ—Å—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –æ—à–∏–±–∫–∏ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —á–∞—Å—Ç–∏—Ü.'
        },
        vocabulary_analysis: {
            score: Math.floor(overallScore * 0.9),
            feedback: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª–æ–≤.'
        },
        structure_analysis: {
            score: Math.floor(overallScore * 0.88),
            feedback: '–õ–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏.'
        },
        errors: generateMockErrors(essayText),
        recommendations: `
            <ul>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</li>
                <li>–î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤</li>
                <li>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏—Ü—ã ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–≤—è–∑–Ω–æ—Å—Ç–∏</li>
                <li>–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —ç—Å—Å–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ</li>
            </ul>
        `
    };
    
    showEssayAnalysisResult(mockResult, essayText);
}

function generateMockErrors(essayText) {
    const errors = [];
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –æ—à–∏–±–æ–∫
    if (essayText.length > 50) {
        errors.push({
            context: essayText.substring(20, 40),
            description: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‰∫Ü',
            correction: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‰∫Ü —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π'
        });
    }
    
    if (essayText.length > 100) {
        errors.push({
            context: essayText.substring(80, 100),
            description: '–ü–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å',
            correction: '–°–ª–µ–¥—É–µ—Ç: ÊàëÂéªÂ≠¶Ê†°Ôºå‰∏çÊòØÂ≠¶Ê†°ÂéªÊàë'
        });
    }
    
    return errors;
}

// –î—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
function cancelEssayAnalysis() {
    if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ? –í–µ—Å—å —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
        clearInterval(essayAnalysisTimer);
        document.getElementById('essayAnalysisArea').style.display = 'none';
        document.getElementById('essayAnalysisResult').style.display = 'none';
        document.querySelector('#essay-analysis-tab .section > div:first-child').style.display = 'grid';
    }
}

function retryEssayAnalysis() {
    document.getElementById('essayAnalysisResult').style.display = 'none';
    document.querySelector('#essay-analysis-tab .section > div:first-child').style.display = 'grid';
}

function saveEssayAnalysisResult() {
    if (!currentEssayAnalysisData) return;
    
    const data = {
        type: 'essay_analysis',
        data: currentEssayAnalysisData,
        essay_text: document.getElementById('essayAnalysisText').value,
        timestamp: new Date().toISOString(),
        score: calculateLocalEssayScore(document.getElementById('essayAnalysisText').value)
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `essay_analysis_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
}

function showCorrectedEssay() {
    const essayText = document.getElementById('essayAnalysisText').value;
    
    // –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –±—É–¥–µ—Ç AI)
    const correctedText = essayText
        .replace(/‰∫Ü(\s+ÊòØ)/g, '$1') // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ ‰∫Ü
        .replace(/ÁöÑÂæó/g, 'Âæó')      // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º ÁöÑÂæó
        .replace(/Âú∞Âæó/g, 'Âæó');     // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º Âú∞Âæó
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; 
                    width: 100%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-edit"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —ç—Å—Å–µ
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                    <i class="fas fa-check-circle"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤—ã–¥–µ–ª–µ–Ω—ã:
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; 
                            font-family: 'SimSun', serif; font-size: 16px; line-height: 1.8; 
                            white-space: pre-wrap;">
                    ${correctedText}
                </div>
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏
function initEssayAnalysis() {
    setEssayDifficulty('intermediate');
}

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
let currentEssayMode = 'essay'; // 'essay' –∏–ª–∏ 'translation'
let essayTimer = null;
let essayTimeLeft = 0;
let translationTimer = null;
let translationTimeLeft = 0;
let currentEssayData = null;
let currentTranslationData = null;

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
function switchEssayMode(mode) {
    currentEssayMode = mode;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.getElementById('essayTabBtn').classList.remove('active');
    document.getElementById('translationTabBtn').classList.remove('active');
    
    if (mode === 'essay') {
        document.getElementById('essayTabBtn').classList.add('active');
        document.getElementById('essayModeContent').style.display = 'block';
        document.getElementById('translationModeContent').style.display = 'none';
    } else {
        document.getElementById('translationTabBtn').classList.add('active');
        document.getElementById('essayModeContent').style.display = 'none';
        document.getElementById('translationModeContent').style.display = 'block';
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
    clearTimers();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —ç—Å—Å–µ
function updateEssayRequirements() {
    const topic = document.getElementById('essayTopic').value;
    const customTopicDiv = document.getElementById('customTopicDiv');
    const requirementsDiv = document.getElementById('essayRequirements');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è —Å–≤–æ–µ–π —Ç–µ–º—ã
    if (topic === 'custom') {
        customTopicDiv.style.display = 'block';
    } else {
        customTopicDiv.style.display = 'none';
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
    const requirements = {
        'modern_tech': 'üì± –û–±—Å—É–¥–∏—Ç–µ –≤–ª–∏—è–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –Ω–∞ –æ–±—â–µ—Å—Ç–≤–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏.',
        'environment': 'üåç –ù–∞–ø–∏—à–∏—Ç–µ –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∑–∞—â–∏—Ç—ã –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.',
        'education': 'üéì –°—Ä–∞–≤–Ω–∏—Ç–µ –∫–∏—Ç–∞–π—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–æ–π. –ö–∞–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏?',
        'culture': 'üéå –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ. –ß—Ç–æ –≤–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ –≤–ø–µ—á–∞—Ç–ª–∏–ª–æ –∏–ª–∏ —É–¥–∏–≤–∏–ª–æ?',
        'travel': '‚úàÔ∏è –û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∏–¥–µ–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ö–∏—Ç–∞—é. –ö–∞–∫–∏–µ –º–µ—Å—Ç–∞ —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ—Å–µ—Ç–∏—Ç—å –∏ –ø–æ—á–µ–º—É?',
        'food': 'üçú –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –æ –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É—Ö–Ω–µ. –ö–∞–∫–æ–µ –±–ª—é–¥–æ –≤–∞–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –Ω—Ä–∞–≤–∏—Ç—Å—è?',
        'business': 'üíº –û–±—Å—É–¥–∏—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–µ–¥–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞ –≤ –ö–∏—Ç–∞–µ. –ö–∞–∫–∏–µ —Å–æ–≤–µ—Ç—ã –≤—ã –±—ã –¥–∞–ª–∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–∞–º?',
        'family': 'üë™ –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Ä–æ–ª–∏ —Å–µ–º—å–∏ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–±—â–µ—Å—Ç–≤–µ. –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Å–µ–º–µ–π–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏?',
        'health': 'üí™ –ù–∞–ø–∏—à–∏—Ç–µ –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏. –ö–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ?',
        'custom': '‚úèÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–º–∏ —Ç–µ–º—É.'
    };
    
    requirementsDiv.innerHTML = requirements[topic] || '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è';
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è HSK –¥–ª—è —ç—Å—Å–µ
function setEssayHskLevel(level) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.essay-hsk-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
    const activeBtn = document.querySelector(`.essay-hsk-btn[data-level="${level}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('essayHskLevel').value = level;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
    updateEssayRequirements();
}

function startEssayWriting() {
    const topicSelect = document.getElementById('essayTopic');
    const customTopicInput = document.getElementById('customTopic');
    const topic = topicSelect.value;
    const customTopic = customTopicInput ? customTopicInput.value.trim() : '';
    const hskLevel = document.getElementById('essayHskLevel').value;
    const minLength = parseInt(document.getElementById('essayMinLength').value);
    const timeLimit = parseInt(document.getElementById('essayTimeLimit').value);
    
    console.log("–ù–∞—á–∏–Ω–∞—é —ç—Å—Å–µ:", { topic, customTopic, hskLevel, minLength, timeLimit });
    
    // –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–º—ã
    let finalTopic = '';
    
    if (topic === 'custom') {
        if (!customTopic) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Ç–µ–º—É!');
            return;
        }
        finalTopic = customTopic;
    } else if (!topic) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è —ç—Å—Å–µ!');
        return;
    } else {
        finalTopic = topic; // –≠—Ç–æ –±—É–¥–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞ "environment"
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const displayTopic = topic === 'custom' ? customTopic : getTopicDisplayName(finalTopic);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏–µ
    const essayPrompt = generateEssayPrompt(finalTopic, hskLevel);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —ç—Å—Å–µ
    currentEssayData = {
        topic: finalTopic, // –ò—Å–ø–æ–ª—å–∑—É–µ–º finalTopic –≤–º–µ—Å—Ç–æ topic
        displayTopic: displayTopic,
        hskLevel: hskLevel,
        minLength: minLength,
        timeLimit: timeLimit,
        startTime: new Date(),
        prompt: essayPrompt,
        topicType: topic
    };
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    document.getElementById('essayModeContent').style.display = 'none';
    document.getElementById('essayWritingArea').style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    document.getElementById('currentEssayTopic').textContent = `–¢–µ–º–∞: ${displayTopic}`;
    document.getElementById('essayPrompt').innerHTML = `<strong>–ó–∞–¥–∞–Ω–∏–µ:</strong><br>${essayPrompt}`;
    document.getElementById('minChars').textContent = minLength;
    document.getElementById('charsLeft').textContent = minLength;
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞
    document.getElementById('essayText').value = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    updateEssayCounter();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (timeLimit > 0) {
        essayTimeLeft = timeLimit * 60;
        startEssayTimer();
        document.getElementById('essayTimer').textContent = formatTime(essayTimeLeft);
        document.getElementById('essayTimer').style.display = 'inline-block';
    } else {
        document.getElementById('essayTimer').style.display = 'none';
    }
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    document.getElementById('essayWritingArea').scrollIntoView({ behavior: 'smooth' });
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    setTimeout(() => {
        document.getElementById('essayText').focus();
    }, 300);
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º—ã
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º—ã
function getTopicDisplayName(topicValue) {
    const topicNames = {
        'modern_tech': '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –æ–±—â–µ—Å—Ç–≤–æ',
        'environment': '–ó–∞—â–∏—Ç–∞ –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã', 
        'education': '–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è',
        'culture': '–ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏',
        'travel': '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ —Ç—É—Ä–∏–∑–º',
        'food': '–ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É—Ö–Ω—è',
        'business': '–ë–∏–∑–Ω–µ—Å –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∞',
        'family': '–°–µ–º—å—è –∏ –æ–±—â–µ—Å—Ç–≤–æ',
        'health': '–ó–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏',
        'custom': '–°–≤–æ—è —Ç–µ–º–∞'
    };
    return topicNames[topicValue] || topicValue;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —ç—Å—Å–µ
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —ç—Å—Å–µ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function generateEssayPrompt(topic, hskLevel) {
    const levelTips = {
        '3': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –±–∞–∑–æ–≤—É—é –ª–µ–∫—Å–∏–∫—É HSK 1-3.',
        '4': '–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –ª–µ–∫—Å–∏–∫—É HSK 4 —É—Ä–æ–≤–Ω—è.',
        '5': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –ª–µ–∫—Å–∏–∫—É –∏ —Å–ª–æ–∂–Ω—ã–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.',
        '6': '–ü—Ä–æ—è–≤–∏—Ç–µ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ –≤–ª–∞–¥–µ–Ω–∏—è —è–∑—ã–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–¥–∏–æ–º—ã –∏ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.'
    };
    
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Å—Å–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
    const structures = {
        '3': '–í–≤–µ–¥–µ–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Üí –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) ‚Üí –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)',
        '4': '–í–≤–µ–¥–µ–Ω–∏–µ (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã) ‚Üí 2-3 –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ ‚Üí –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (–≤—ã–≤–æ–¥—ã)',
        '5': '–í–≤–µ–¥–µ–Ω–∏–µ —Å —Ç–µ–∑–∏—Å–æ–º ‚Üí 3-4 —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞ ‚Üí –ö–æ–Ω—Ç—Ä-–∞—Ä–≥—É–º–µ–Ω—Ç ‚Üí –ó–∞–∫–ª—é—á–µ–Ω–∏–µ',
        '6': '–ü—Ä–∏–≤–ª–µ–∫–∞—é—â–µ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–∏–µ ‚Üí –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Üí –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ ‚Üí –£–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ'
    };
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏–π –ø–æ —Ç–µ–º–∞–º
    let task = '';
    
    if (typeof topic === 'string' && topic.startsWith('custom_')) {
        topic = topic.replace('custom_', '');
    }
    
    const prompts = {
        'modern_tech': `–ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –æ –≤–ª–∏—è–Ω–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ. 
        –û–±—Å—É–¥–∏—Ç–µ –∫–∞–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –Ω–∞—à—É –∂–∏–∑–Ω—å, —Ä–∞–±–æ—Ç—É –∏ –æ–±—â–µ–Ω–∏–µ. 
        –ü—Ä–∏–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ –æ–ø—ã—Ç–∞.`,
        
        'environment': `–ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã. 
        –û–±—Å—É–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.
        –ß—Ç–æ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –∫–∞–∂–¥—ã–π —á–µ–ª–æ–≤–µ–∫ –¥–ª—è –∑–∞—â–∏—Ç—ã –ø—Ä–∏—Ä–æ–¥—ã?`,
        
        'education': `–°—Ä–∞–≤–Ω–∏—Ç–µ —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ –ö–∏—Ç–∞–µ –∏ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ.
        –ö–∞–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ —É –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã?
        –ö–∞–∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –±—É–¥—É—â–µ–µ –º–æ–ª–æ–¥–µ–∂–∏?`,
        
        'culture': `–û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–æ–π.
        –ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤–ø–µ—á–∞—Ç–ª–∏–ª–æ –∏–ª–∏ —É–¥–∏–≤–∏–ª–æ?
        –ö–∞–∫–∏–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏?`,
        
        'travel': `–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–µ—Ç–µ –ø–æ –ö–∏—Ç–∞—é.
        –û–ø–∏—à–∏—Ç–µ –º–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ—Å–µ—Ç–∏—Ç—å, –∏ –ø–æ—á–µ–º—É.
        –ö–∞–∫ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è —Ä–∞—Å—à–∏—Ä—è—é—Ç –∫—Ä—É–≥–æ–∑–æ—Ä?`,
        
        'food': `–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É—Ö–Ω–µ.
        –ö–∞–∫–∏–µ –±–ª—é–¥–∞ –≤—ã –ø—Ä–æ–±–æ–≤–∞–ª–∏ –∏–ª–∏ —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?
        –ö–∞–∫ –µ–¥–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç –∫—É–ª—å—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω—ã?`,
        
        'business': `–û–±—Å—É–¥–∏—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–µ–¥–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞ –≤ –ö–∏—Ç–∞–µ.
        –ö–∞–∫–∏–µ —Å–æ–≤–µ—Ç—ã –≤—ã –¥–∞–ª–∏ –±—ã –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–º –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è–º?
        –ö–∞–∫ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤–ª–∏—è—é—Ç –Ω–∞ –±–∏–∑–Ω–µ—Å?`,
        
        'family': `–û–±—Å—É–¥–∏—Ç–µ —Ä–æ–ª—å —Å–µ–º—å–∏ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–±—â–µ—Å—Ç–≤–µ.
        –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Å–µ–º–µ–π–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã?
        –ö–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–º–µ–µ—Ç —Å–µ–º—å—è –≤ –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ?`,
        
        'health': `–ù–∞–ø–∏—à–∏—Ç–µ –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏.
        –ö–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ?
        –ö–∞–∫ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ –ª—é–¥–µ–π?`
    };
    
    const basePrompt = prompts[topic] || `–ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –Ω–∞ —Ç–µ–º—É: "${topic}"`;
    
    return `
        ${basePrompt}
        
        <br><br>
        <strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong>
        <ul>
            <li>–ú–∏–Ω–∏–º—É–º ${currentEssayData?.minLength || 300} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ–∫—Å–∏–∫—É —É—Ä–æ–≤–Ω—è HSK ${hskLevel}</li>
            <li>${structures[hskLevel] || structures['4']}</li>
            <li>${levelTips[hskLevel] || ''}</li>
        </ul>
        
        <br>
        <strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:</strong>
        <ol>
            <li>–í–≤–µ–¥–µ–Ω–∏–µ: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–º—É –∏ –≤–∞—à—É –ø–æ–∑–∏—Ü–∏—é</li>
            <li>–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å: –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã</li>
            <li>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ: –≤—ã–≤–æ–¥—ã –∏ –æ–±–æ–±—â–µ–Ω–∏–µ</li>
        </ol>
    `;
}

// –¢–∞–π–º–µ—Ä –¥–ª—è —ç—Å—Å–µ
function startEssayTimer() {
    clearInterval(essayTimer);
    
    essayTimer = setInterval(() => {
        essayTimeLeft--;
        
        const minutes = Math.floor(essayTimeLeft / 60);
        const seconds = essayTimeLeft % 60;
        document.getElementById('essayTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
        if (essayTimeLeft < 300) { // 5 –º–∏–Ω—É—Ç
            document.getElementById('essayTimer').style.background = 'var(--danger)';
        }
        
        if (essayTimeLeft <= 0) {
            clearInterval(essayTimer);
            alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ! –≠—Å—Å–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.');
            submitEssayForCheck();
        }
    }, 1000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —ç—Å—Å–µ
function updateEssayCounter() {
    const text = document.getElementById('essayText').value;
    const charCount = text.length;
    const minLength = parseInt(document.getElementById('minChars').textContent);
    
    document.getElementById('charCount').textContent = charCount;
    document.getElementById('charsLeft').textContent = Math.max(0, minLength - charCount);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const progress = Math.min(100, (charCount / minLength) * 100);
    document.getElementById('essayProgress').style.width = `${progress}%`;
    
    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    const progressBar = document.getElementById('essayProgress');
    if (progress >= 100) {
        progressBar.style.background = 'var(--success)';
    } else if (progress >= 50) {
        progressBar.style.background = 'var(--warning)';
    } else {
        progressBar.style.background = 'var(--danger)';
    }
}

// –í—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä—ã—Ö —Ñ—Ä–∞–∑
function insertEssayPhrase(type) {
    const textarea = document.getElementById('essayText');
    const phrases = {
        'intro': 'Âú®ÊàëÁúãÊù•ÔºåËøô‰∏™ÈóÆÈ¢òÈùûÂ∏∏ÈáçË¶Å„ÄÇÂõ†‰∏∫...',
        'opinion': 'ÊàëËÆ§‰∏∫... ‰∏ÄÊñπÈù¢...ÔºåÂè¶‰∏ÄÊñπÈù¢...',
        'example': '‰æãÂ¶ÇÔºåÊúâ‰∏ÄÊ¨°Êàë...',
        'conclusion': 'ÊÄªËÄåË®Ä‰πãÔºå... Âõ†Ê≠§ÔºåÊàë‰ª¨Â∫îËØ•...',
        'connector': '‰∏ç‰ªÖÂ¶ÇÊ≠§ÔºåËÄå‰∏î... Êç¢Âè•ËØùËØ¥...'
    };
    
    if (phrases[type]) {
        textarea.value += phrases[type] + ' ';
        textarea.focus();
        updateEssayCounter();
    }
}

// –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —ç—Å—Å–µ
function showEssayHint() {
    const hints = [
        "üí° –ù–∞—á–Ω–∏—Ç–µ —Å –≤–≤–µ–¥–µ–Ω–∏—è: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–º—É –∏ –≤–∞—à—É –ø–æ–∑–∏—Ü–∏—é",
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞: È¶ñÂÖàÔºåÂÖ∂Ê¨°ÔºåÊúÄÂêé",
        "üí° –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏: ‰æãÂ¶ÇÔºåÊúâ‰∏ÄÊ¨°...",
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å Âõ†‰∏∫...ÊâÄ‰ª•...",
        "üí° –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ —á–∞—Å—Ç–∏—Ü—ã ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó",
        "üí° –í –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–∏: ÊÄªËÄåË®Ä‰πã..."
    ];
    
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    alert(randomHint);
}

async function submitEssayForCheck() {
    const essayText = document.getElementById('essayText').value.trim();
    
    if (!essayText) {
        alert('–ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π!');
        return;
    }
    
    // –í–†–ï–ú–ï–ù–ù–û: –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    const mockResult = {
        overall_score: Math.min(90, Math.max(60, Math.floor(essayText.length / 10))),
        categories: [
            { name: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞', score: 75, feedback: '–•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ —á–∞—Å—Ç–∏—Ü–∞—Ö' },
            { name: '–õ–µ–∫—Å–∏–∫–∞', score: 80, feedback: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å' },
            { name: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞', score: 85, feedback: '–õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è' },
            { name: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ', score: 90, feedback: '–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ' }
        ],
        errors: essayText.length > 100 ? [
            { position: 20, error: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‰∫Ü', correction: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‰∫Ü —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π' }
        ] : [],
        recommendations: '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è. –£–¥–µ–ª–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —á–∞—Å—Ç–∏—Ü ‰∫Ü, ÁöÑ, Âú∞, Âæó.'
    };
    
    showEssayResult(mockResult, essayText);
}
// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Å—Å–µ
function showEssayResult(result, essayText) {
    // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    document.getElementById('essayWritingArea').style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    const resultSection = document.getElementById('essayResultSection');
    resultSection.style.display = 'block';
    
    // –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
    const overallScoreDiv = document.getElementById('essayOverallScore');
    const score = result.overall_score || Math.floor(Math.random() * 30) + 70; // Fallback
    
    overallScoreDiv.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
            <div style="text-align: center;">
                <div style="font-size: 3em; font-weight: bold; color: ${getScoreColor(score)}">${score}/100</div>
                <div style="color: var(--gray);">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞</div>
            </div>
            <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
            <div style="text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">HSK ${currentEssayData.hskLevel}</div>
                <div style="color: var(--gray);">–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å</div>
            </div>
            <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
            <div style="text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; color: var(--success);">${essayText.length}</div>
                <div style="color: var(--gray);">–ò–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</div>
            </div>
        </div>
    `;
    
    // –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    const detailedDiv = document.getElementById('essayDetailedAnalysis');
    
    let analysisHTML = `
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-chart-pie"></i> –û—Ü–µ–Ω–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    `;
    
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏
    const categories = result.categories || [
        { name: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞', score: Math.floor(Math.random() * 20) + 75, feedback: '–•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ —á–∞—Å—Ç–∏—Ü–∞—Ö' },
        { name: '–õ–µ–∫—Å–∏–∫–∞', score: Math.floor(Math.random() * 20) + 70, feedback: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Å–ª–æ–≤–∞' },
        { name: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞', score: Math.floor(Math.random() * 20) + 80, feedback: '–õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞' },
        { name: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ', score: Math.floor(Math.random() * 20) + 85, feedback: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ, —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∏–º–µ—Ä—ã' }
    ];
    
    categories.forEach(cat => {
        analysisHTML += `
            <div class="stat-card">
                <h3>${cat.name}</h3>
                <div class="stat-number">${cat.score}/100</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${cat.score}%; background: ${getScoreColor(cat.score)}"></div>
                </div>
                <div class="stat-desc">${cat.feedback || ''}</div>
            </div>
        `;
    });
    
    analysisHTML += `
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--warning); margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i> –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:
            </h4>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
    `;
    
    // –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
    const errors = result.errors || [
        { position: 15, error: '‰∫Ü –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–µ –∫ –º–µ—Å—Ç—É', correction: '–£–±–µ—Ä–∏—Ç–µ ‰∫Ü –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ' },
        { position: 42, error: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤', correction: '–°–ª–µ–¥—É–µ—Ç: ÊàëÂéªÂ≠¶Ê†°Ôºå‰∏çÊòØÂ≠¶Ê†°ÂéªÊàë' }
    ];
    
    if (errors.length > 0) {
        errors.forEach((err, index) => {
            analysisHTML += `
                <div style="margin-bottom: ${index < errors.length - 1 ? '15px' : '0'}; padding-bottom: ${index < errors.length - 1 ? '15px' : '0'}; 
                            border-bottom: ${index < errors.length - 1 ? '1px solid #ffc107' : 'none'}">
                    <div style="font-weight: bold; color: var(--danger);">
                        <i class="fas fa-times-circle"></i> –û—à–∏–±–∫–∞ ${index + 1}:
                    </div>
                    <div style="margin: 5px 0; font-family: 'SimSun', serif;">${err.error}</div>
                    <div style="color: var(--success);">
                        <i class="fas fa-check-circle"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${err.correction}
                    </div>
                </div>
            `;
        });
    } else {
        analysisHTML += `<p style="color: var(--success);"><i class="fas fa-check-circle"></i> –°–µ—Ä—å—ë–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!</p>`;
    }
    
    analysisHTML += `
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--success); margin-bottom: 15px;">
                <i class="fas fa-star"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:
            </h4>
            <div class="word-tip">
                ${result.recommendations || `
                <ul>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å ËôΩÁÑ∂...‰ΩÜÊòØ...</li>
                    <li>–î–æ–±–∞–≤—å—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞: È¶ñÂÖàÔºåÂÖ∂Ê¨°ÔºåÊúÄÂêé</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω–æ–Ω–∏–º—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</li>
                    <li>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó</li>
                    <li>–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —ç—Å—Å–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ</li>
                </ul>
                `}
            </div>
        </div>
        
        <div>
            <h4 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-history"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è:
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                        ${Math.floor((new Date() - currentEssayData.startTime) / 1000 / 60)} –º–∏–Ω
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–í—Ä–µ–º—è</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                        ${Math.floor(essayText.length / ((new Date() - currentEssayData.startTime) / 1000 / 60))}Â≠ó/–º–∏–Ω
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–°–∫–æ—Ä–æ—Å—Ç—å</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                        ${Math.floor(essayText.split('Ôºå').length + essayText.split('„ÄÇ').length)}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                        ${new Set(essayText.split('')).size}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</div>
                </div>
            </div>
        </div>
    `;
    
    detailedDiv.innerHTML = analysisHTML;
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
function setTranslationDifficulty(difficulty) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.trans-difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
    const activeBtn = document.querySelector(`.trans-difficulty-btn[data-difficulty="${difficulty}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('translationDifficulty').value = difficulty;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä
    updateTranslationExample();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
function updateTranslationExample() {
    const topic = document.getElementById('translationTopic').value;
    const difficulty = document.getElementById('translationDifficulty').value;
    
    const examples = {
        'news': {
            'easy': '–°–µ–≥–æ–¥–Ω—è –≤ –ü–µ–∫–∏–Ω–µ —Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 25 –≥—Ä–∞–¥—É—Å–æ–≤. –ú–Ω–æ–≥–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –≥—É–ª—è—é—Ç –ø–æ –ø–∞—Ä–∫—É.',
            'medium': '–í—á–µ—Ä–∞ –≤ –®–∞–Ω—Ö–∞–µ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä. –û–Ω –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ü–µ–Ω—Ç—Ä —Å–æ–∑–¥–∞—Å—Ç 500 –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç.',
            'hard': '–ö–∏—Ç–∞–π—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è Huawei –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ –Ω–æ–≤—É—é –ª–∏–Ω–µ–π–∫—É —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –∫–∞–º–µ—Ä–∞–º–∏ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Å–Ω–∞—â–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞–º–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Å–µ—Ç—å 5G.',
            'expert': '–í —Ä–∞–º–∫–∞—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã "–û–¥–∏–Ω –ø–æ—è—Å, –æ–¥–∏–Ω –ø—É—Ç—å" –ö–∏—Ç–∞–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ —Å—Ç—Ä–∞–Ω–∞—Ö –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏. –≠—Ç–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –Ω–µ —Ç–æ–ª—å–∫–æ —É–∫—Ä–µ–ø–ª—è—é—Ç —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏, –Ω–æ –∏ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É—é—Ç –∫—É–ª—å—Ç—É—Ä–Ω–æ–º—É –æ–±–º–µ–Ω—É –º–µ–∂–¥—É –Ω–∞—Ä–æ–¥–∞–º–∏.'
        },
        'story': {
            'easy': '–ú–∞–ª–µ–Ω—å–∫–∏–π –º–∞–ª—å—á–∏–∫ –ø–æ—à–µ–ª –≤ –ø–∞—Ä–∫. –û–Ω —É–≤–∏–¥–µ–ª –∫—Ä–∞—Å–∏–≤—É—é –±–∞–±–æ—á–∫—É. –ë–∞–±–æ—á–∫–∞ –±—ã–ª–∞ –∂–µ–ª—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.',
            'medium': '–û–¥–Ω–∞–∂–¥—ã —Å—Ç–∞—Ä—ã–π —Ä—ã–±–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è –Ω–∞ —Ä–µ–∫—É. –û–Ω –ø–æ–π–º–∞–ª –∑–æ–ª–æ—Ç—É—é —Ä—ã–±–∫—É. –†—ã–±–∫–∞ –º–æ–≥–ª–∞ –∏—Å–ø–æ–ª–Ω—è—Ç—å –∂–µ–ª–∞–Ω–∏—è.',
            'hard': '–í –¥—Ä–µ–≤–Ω–µ–º –ö–∏—Ç–∞–µ –∂–∏–ª –º—É–¥—Ä—ã–π —Å—Ç–∞—Ä–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–ª —Å–µ–∫—Ä–µ—Ç –¥–æ–ª–≥–æ–ª–µ—Ç–∏—è. –ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –æ–Ω –ø–æ–¥–Ω–∏–º–∞–ª—Å—è –Ω–∞ –≥–æ—Ä—É –¢–∞–π—à–∞–Ω—å, —á—Ç–æ–±—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å —Ä–∞—Å—Å–≤–µ—Ç –∏ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —Ç–∞–π—Ü–∑–∏—Ü—é–∞–Ω—å.',
            'expert': '–°–æ–≥–ª–∞—Å–Ω–æ –¥—Ä–µ–≤–Ω–µ–π –ª–µ–≥–µ–Ω–¥–µ, –∏–º–ø–µ—Ä–∞—Ç–æ—Ä –¶–∏–Ω—å –®–∏—Ö—É–∞–Ω–¥–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª —ç–∫—Å–ø–µ–¥–∏—Ü–∏—é –Ω–∞ –≤–æ—Å—Ç–æ–∫ –≤ –ø–æ–∏—Å–∫–∞—Ö —ç–ª–∏–∫—Å–∏—Ä–∞ –±–µ—Å—Å–º–µ—Ä—Ç–∏—è. –ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –º–Ω–æ–≥–æ—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –∏—Å–ø—ã—Ç–∞–Ω–∏—è–º–∏, –Ω–æ —Ç–∞–∫ –∏ –Ω–µ –Ω–∞—à–ª–∏ –∂–µ–ª–∞–Ω–Ω—ã–π —ç–ª–∏–∫—Å–∏—Ä.'
        }
    };
    
    const exampleDiv = document.getElementById('translationExample');
    
    if (topic && examples[topic] && examples[topic][difficulty]) {
        exampleDiv.innerHTML = `<strong>–ü—Ä–∏–º–µ—Ä (${difficulty}):</strong><br>${examples[topic][difficulty]}`;
    } else {
        exampleDiv.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä...';
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function generateTranslationText() {
    const topic = document.getElementById('translationTopic').value;
    const difficulty = document.getElementById('translationDifficulty').value;
    const length = document.getElementById('translationLength').value;
    const hskLevel = document.getElementById('translationHskLevel').value;
    
    if (!topic) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const generateBtn = document.getElementById('generateTranslationTextBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ–∫—Å—Ç...';
    generateBtn.disabled = true;
    
    try {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        document.getElementById('translationResultSection').style.display = 'none';
        
        const requestData = {
            topic: topic,
            description: "",
            difficulty: difficulty,
            length: length,
            hsk_level: hskLevel,
            user_id: currentUser?.user_id || null,
            include_emojis: true,
            manga_style: false
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é:", requestData);
        
        const response = await fetch(`${API_BASE}/translation/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç:", result);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥–∞
        currentTranslationData = {
            original_text: result.text,
            topic: topic,
            difficulty: difficulty,
            hskLevel: hskLevel,
            startTime: new Date(),
            target_hsk: hskLevel,
            result: result
        };
        
        // –í–ê–ñ–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('translationArea').style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        document.getElementById('originalTranslationText').textContent = result.text;
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞
        document.getElementById('translationText').value = '';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
        document.getElementById('transCharCount').textContent = '0';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
        translationTimeLeft = 25 * 60;
        if (document.getElementById('translationTimer')) {
            document.getElementById('translationTimer').textContent = '25:00';
            document.getElementById('translationTimer').style.background = '';
        }
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –æ–±–ª–∞—Å—Ç–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
        document.getElementById('translationArea').scrollIntoView({ behavior: 'smooth' });
        
        showNotification('‚úÖ –¢–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥.');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞');
        
        // Fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –í–°–ï –†–ê–í–ù–û
        generateFallbackTranslationText(topic, difficulty);
        
    } finally {
        // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –∫–Ω–æ–ø–∫—É –≤—Å–µ–≥–¥–∞
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
// Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function generateFallbackTranslationText(topic, difficulty) {
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞
    const translationResultSection = document.getElementById('translationResultSection');
    if (translationResultSection) {
        translationResultSection.style.display = 'none';
    }
    const fallbackTexts = {
        'news': {
            'easy': '–í—á–µ—Ä–∞ –≤ –ü–µ–∫–∏–Ω–µ –ø—Ä–æ—à–µ–ª —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å —Ñ–æ–Ω–∞—Ä–µ–π. –¢—ã—Å—è—á–∏ –ª—é–¥–µ–π —Å–æ–±—Ä–∞–ª–∏—Å—å –Ω–∞ –ø–ª–æ—â–∞–¥–∏.',
            'medium': '–ö–∏—Ç–∞–π—Å–∫–∏–µ —É—á–µ–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–æ–≤—É—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤–æ–¥—ã. –≠—Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è —Ä–µ–∫.',
            'hard': '–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ "–¶–∏—Ñ—Ä–æ–≤–æ–π —à–µ–ª–∫–æ–≤—ã–π –ø—É—Ç—å" –ö–∏—Ç–∞–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –∫–æ–º–º–µ—Ä—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –æ–±—ä–µ–¥–∏–Ω–∏—Ç –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω.',
            'expert': '–°–æ–≥–ª–∞—Å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º, —ç–∫—Å–ø–æ—Ä—Ç –∫–∏—Ç–∞–π—Å–∫–æ–π —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏ –≤—ã—Ä–æ—Å –Ω–∞ 15% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª—ã–º –≥–æ–¥–æ–º, —á—Ç–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É–µ—Ç –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∏—Ä–æ–≤–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏ –ø–æ—Å–ª–µ –ø–∞–Ω–¥–µ–º–∏–∏.'
        },
        'story': {
            'easy': '–ú–∞–ª–µ–Ω—å–∫–∞—è –¥–µ–≤–æ—á–∫–∞ –Ω–∞—à–ª–∞ –∫–æ—Ç–µ–Ω–∫–∞ –≤–æ –¥–≤–æ—Ä–µ. –ö–æ—Ç–µ–Ω–æ–∫ –±—ã–ª —á–µ—Ä–Ω–æ-–±–µ–ª—ã–π –∏ –æ—á–µ–Ω—å –≥–æ–ª–æ–¥–Ω—ã–π.',
            'medium': '–î–∞–≤–Ω—ã–º-–¥–∞–≤–Ω–æ –≤ –º–∞–ª–µ–Ω—å–∫–æ–π –¥–µ—Ä–µ–≤–Ω–µ –∂–∏–ª –±–µ–¥–Ω—ã–π –∫—Ä–µ—Å—Ç—å—è–Ω–∏–Ω. –û–¥–Ω–∞–∂–¥—ã –æ–Ω –Ω–∞—à–µ–ª –≤–æ–ª—à–µ–±–Ω—ã–π –≥–æ—Ä—à–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥ –≤–∞—Ä–∏—Ç—å —Ä–∏—Å –±–µ–∑ –æ–≥–Ω—è.',
            'hard': '–õ–µ–≥–µ–Ω–¥–∞ –≥–ª–∞—Å–∏—Ç, —á—Ç–æ –≤ —ç–ø–æ—Ö—É –¢–∞–Ω –ø–æ—ç—Ç –õ–∏ –ë–∞–π, –≤—ã–ø–∏–≤ –≤–∏–Ω–∞ –ø–æ–¥ –ª—É–Ω–æ–π, –Ω–∞–ø–∏—Å–∞–ª —Å–≤–æ–∏ —Å–∞–º—ã–µ –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–µ —Å—Ç–∏—Ö–∏ –æ –¥—Ä—É–∂–±–µ –∏ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ.',
            'expert': '–í–æ –≤—Ä–µ–º–µ–Ω–∞ –¥–∏–Ω–∞—Å—Ç–∏–∏ –ú–∏–Ω –º–æ–ª–æ–¥–æ–π —É—á–µ–Ω—ã–π, –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏–π –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–∞–º–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ —Å—Ç—Ä–∞–Ω–µ, –≤ —Ö–æ–¥–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–Ω –æ—Ç–∫—Ä—ã–ª –¥–ª—è —Å–µ–±—è –∏—Å—Ç–∏–Ω–Ω—É—é –º—É–¥—Ä–æ—Å—Ç—å, —Å–∫—Ä—ã—Ç—É—é –≤ —Å–µ—Ä–¥—Ü–∞—Ö –ø—Ä–æ—Å—Ç—ã—Ö –ª—é–¥–µ–π.'
        },
        'dialogue': {
            'easy': '‚Äî –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫ –¥–µ–ª–∞? ‚Äî –°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ! –ê —É –≤–∞—Å? ‚Äî –£ –º–µ–Ω—è —Ç–æ–∂–µ —Ö–æ—Ä–æ—à–æ.',
            'medium': '‚Äî –ò–∑–≤–∏–Ω–∏—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å? ‚Äî –°–µ–π—á–∞—Å –¥–≤–∞ —á–∞—Å–∞. ‚Äî –°–ø–∞—Å–∏–±–æ! ‚Äî –ü–æ–∂–∞–ª—É–π—Å—Ç–∞.',
            'hard': '‚Äî –í—ã –Ω–µ –ø–æ–¥—Å–∫–∞–∂–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–π—Ç–∏ –∫ –º—É–∑–µ—é? ‚Äî –ò–¥–∏—Ç–µ –ø—Ä—è–º–æ, –ø–æ—Ç–æ–º –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ. ‚Äî –°–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ! ‚Äî –ù–µ –∑–∞ —á—Ç–æ.',
            'expert': '‚Äî –ö–∞–∫–∏–µ —É –≤–∞—Å –ø–ª–∞–Ω—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ? ‚Äî –Ø —Å–æ–±–∏—Ä–∞—é—Å—å –ø–æ—Å–µ—Ç–∏—Ç—å –≤—ã—Å—Ç–∞–≤–∫—É —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞. ‚Äî –û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –Ø —Å–ª—ã—à–∞–ª, —Ç–∞–º –±—É–¥—É—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç–∫—Å–ø–æ–Ω–∞—Ç—ã.'
        }
    };
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ —Ç–µ–º–µ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    let fallbackText = "–≠—Ç–æ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.";
    
    if (fallbackTexts[topic] && fallbackTexts[topic][difficulty]) {
        fallbackText = fallbackTexts[topic][difficulty];
    } else if (fallbackTexts[topic]) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω—é—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        fallbackText = fallbackTexts[topic]['medium'] || fallbackTexts[topic]['easy'] || fallbackText;
    }
    
    // –í–ê–ñ–ù–û: –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º currentTranslationData –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!currentTranslationData) {
        currentTranslationData = {
            original_text: fallbackText,
            topic: topic,
            difficulty: difficulty,
            startTime: new Date(),
            fallback: true
        };
    }
    
    // –ü–û–ö–ê–ó–´–í–ê–ï–ú –û–ë–õ–ê–°–¢–¨ –î–õ–Ø –ü–ï–†–ï–í–û–î–ê (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
    const translationArea = document.getElementById('translationArea');
    if (translationArea) {
        translationArea.style.display = 'block';
        const originalTextElement = document.getElementById('originalTranslationText');
        if (originalTextElement) {
            originalTextElement.textContent = fallbackText;
        }
    }
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞
    const translationTextElement = document.getElementById('translationText');
    if (translationTextElement) {
        translationTextElement.value = '';
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    const charCountElement = document.getElementById('transCharCount');
    if (charCountElement) {
        charCountElement.textContent = '0';
    }
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (translationArea) {
        translationArea.scrollIntoView({ behavior: 'smooth' });
    }
    
    showNotification('üìù –ò—Å–ø–æ–ª—å–∑—É—é –∑–∞–ø–∞—Å–Ω–æ–π —Ç–µ–∫—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥.');
}

function updateTranslationCounter() {
    const text = document.getElementById('translationText').value;
    const charCount = text.length;
    document.getElementById('transCharCount').textContent = charCount;
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
function startTranslationTimer() {
    clearInterval(translationTimer);
    
    translationTimer = setInterval(() => {
        translationTimeLeft--;
        
        const minutes = Math.floor(translationTimeLeft / 60);
        const seconds = translationTimeLeft % 60;
        document.getElementById('translationTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (translationTimeLeft < 300) {
            document.getElementById('translationTimer').style.background = 'var(--danger)';
        }
        
        if (translationTimeLeft <= 0) {
            clearInterval(translationTimer);
            alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ü–µ—Ä–µ–≤–æ–¥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.');
            submitTranslationForCheck();
        }
    }, 1000);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function submitTranslationForCheck() {
    const translationText = document.getElementById('translationText').value.trim();
    
    if (!translationText) {
        alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–µ—Ä–µ–≤–æ–¥!');
        return;
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    clearInterval(translationTimer);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    const translationArea = document.getElementById('translationArea');
    const originalContent = translationArea.innerHTML;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    translationArea.innerHTML = `
        <div style="text-align: center; padding: 50px 0;">
            <div class="loading-spinner" style="margin: 0 auto;"></div>
            <h3 style="margin-top: 20px; color: var(--primary);">AI –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à –ø–µ—Ä–µ–≤–æ–¥...</h3>
            <p style="color: var(--gray);">–°—Ä–∞–≤–Ω–∏–≤–∞—é —Å –∏–¥–µ–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º</p>
        </div>
    `;
    
    try {
        const requestData = {
            original_text: currentTranslationData?.original_text || '–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞',
            user_translation: translationText,
            target_hsk: currentTranslationData?.target_hsk || currentTranslationData?.hskLevel || 4,
            difficulty: currentTranslationData?.difficulty || 'medium',
            user_id: currentUser?.user_id || null,
            time_spent: Math.floor((new Date() - (currentTranslationData?.startTime || new Date())) / 1000),
            mode: 'translation_check'
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–≤–æ–¥–∞:", requestData);
        
        // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
        let response;
        try {
            // –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
            response = await fetch(`${API_BASE}/translation/check`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
        } catch (firstError) {
            console.log("–ü–µ—Ä–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π...");
            try {
                // –ü–æ–ø—Ä–æ–±—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —ç—Å—Å–µ
                response = await fetch(`${API_BASE}/essay/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...requestData,
                        mode: 'translation'
                    })
                });
            } catch (secondError) {
                console.log("–í—Ç–æ—Ä–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É");
                throw new Error("API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É");
            }
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:", result);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        currentTranslationData = {
            ...currentTranslationData,
            result: result,
            userTranslation: translationText,
            score: result.overall_score || 0,
            completed_at: new Date().toISOString()
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        showTranslationResult(result, translationText);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        translationArea.innerHTML = originalContent;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        showLocalTranslationCheck(translationText);
    }
}

// –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
function showLocalTranslationCheck(userTranslation) {
    const translationArea = document.getElementById('translationArea');
    const resultSection = document.getElementById('translationResultSection');
    
    if (!translationArea || !resultSection) return;
    
    translationArea.style.display = 'none';
    resultSection.style.display = 'block';
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const originalText = currentTranslationData?.original_text || "–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞";
    const idealTranslation = generateIdealTranslation(originalText);
    const score = calculateRealisticScore(userTranslation, idealTranslation);
    
    const result = {
        overall_score: score,
        ideal_translation: idealTranslation,
        categories: [
            { name: '–¢–æ—á–Ω–æ—Å—Ç—å', score: Math.floor(score * 0.9), feedback: '–°–º—ã—Å–ª –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –≤–µ—Ä–Ω–æ' },
            { name: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞', score: Math.floor(score * 0.85), feedback: '–ï—Å—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –æ—à–∏–±–∫–∏' },
            { name: '–õ–µ–∫—Å–∏–∫–∞', score: Math.floor(score * 0.95), feedback: '–•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä —Å–ª–æ–≤' },
            { name: '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', score: Math.floor(score * 0.8), feedback: '–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º' }
        ],
        errors: userTranslation.length < 10 ? [
            { position: 1, error: '–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥', correction: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π' }
        ] : [],
        recommendations: `
            <ul>
                <li>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –≤ –∫–∏—Ç–∞–π—Å–∫–æ–º</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</li>
                <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü ‰∫Ü, ÁöÑ, Âú∞, Âæó</li>
            </ul>
        `
    };
    
    currentTranslationData.result = result;
    currentTranslationData.userTranslation = userTranslation;
    currentTranslationData.score = score;
    
    showTranslationResult(result, userTranslation);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
function generateIdealTranslation(originalText) {
    const translations = {
        "–°–µ–≥–æ–¥–Ω—è –≤ –ü–µ–∫–∏–Ω–µ —Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞.": "‰ªäÂ§©Âåó‰∫¨Â§©Ê∞îÂæàÂ•Ω„ÄÇ",
        "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 25 –≥—Ä–∞–¥—É—Å–æ–≤.": "Ê∏©Â∫¶ÊòØ25Â∫¶„ÄÇ",
        "–ú–Ω–æ–≥–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –≥—É–ª—è—é—Ç –ø–æ –ø–∞—Ä–∫—É.": "ÂæàÂ§öÊ∏∏ÂÆ¢Âú®ÂÖ¨Âõ≠ÈáåÊï£Ê≠•„ÄÇ",
        "–í—á–µ—Ä–∞ –≤ –®–∞–Ω—Ö–∞–µ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä.": "Êò®Â§©Âú®‰∏äÊµ∑ÂºÄ‰∫ÜÊñ∞ÁöÑÁßëÊäÄ‰∏≠ÂøÉ„ÄÇ",
        "–û–Ω –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.": "ÂÆÉÂ∞ÜËøõË°å‰∫∫Â∑•Êô∫ËÉΩÁ†îÁ©∂„ÄÇ",
        "–û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ü–µ–Ω—Ç—Ä —Å–æ–∑–¥–∞—Å—Ç 500 –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç.": "È¢ÑËÆ°‰∏≠ÂøÉÂ∞ÜÂàõÈÄ†500‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂ≤ó‰Ωç„ÄÇ",
        "–≠—Ç–æ –ø—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.": "ËøôÊòØ‰∏Ä‰∏™ÁøªËØëÁªÉ‰π†ÁöÑ‰æãÂ≠ê„ÄÇ",
        "–Ø –∏–∑—É—á–∞—é –∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫ —É–∂–µ –¥–≤–∞ –≥–æ–¥–∞.": "ÊàëÂ≠¶‰π†‰∏≠ÊñáÂ∑≤Áªè‰∏§Âπ¥‰∫Ü„ÄÇ",
        "–ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è.": "‰∏≠ÂõΩÊñáÂåñÈùûÂ∏∏ÊúâË∂£ÂíåÂ§öÊ†∑„ÄÇ"
    };
    
    return translations[originalText] || "ËøôÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÁøªËØëÁªÉ‰π†„ÄÇËØ∑ÁªßÁª≠Âä™ÂäõÔºÅ";
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
// –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ –≤ showTranslationResult:
function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    if (score >= 60) return '#ff9a00';
    return 'var(--danger)';
}

function calculateRealisticScore(userTranslation, idealTranslation) {
    if (!userTranslation || !idealTranslation) return 0;
    
    let score = 0;
    
    // 1. –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ (–º–∞–∫—Å–∏–º—É–º 20 –±–∞–ª–ª–æ–≤)
    const userLength = userTranslation.length;
    const idealLength = idealTranslation.length;
    const lengthRatio = Math.min(1, userLength / Math.max(10, idealLength));
    score += Math.round(lengthRatio * 20);
    
    // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (–º–∞–∫—Å–∏–º—É–º 30 –±–∞–ª–ª–æ–≤)
    const chineseChars = countChineseCharacters(userTranslation);
    const minRequired = Math.max(3, idealTranslation.replace(/[^\u4e00-\u9fff]/g, '').length * 0.3);
    
    if (chineseChars >= minRequired) {
        score += Math.min(30, (chineseChars / minRequired) * 30);
    }
    
    // 3. –°—Ö–æ–¥—Å—Ç–≤–æ —Å –∏–¥–µ–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–º–∞–∫—Å–∏–º—É–º 50 –±–∞–ª–ª–æ–≤)
    const similarity = calculateTranslationSimilarity(userTranslation, idealTranslation);
    score += Math.round(similarity * 0.5);
    
    // 4. –®—Ç—Ä–∞—Ñ –∑–∞ –æ—á–µ–≤–∏–¥–Ω—ã–µ –æ—à–∏–±–∫–∏
    if (chineseChars === 0) {
        score = Math.max(0, score - 30);
    }
    
    if (userTranslation.length < 5) {
        score = Math.max(0, score - 20);
    }
    
    return Math.min(100, Math.max(0, score));
}

function countChineseCharacters(text) {
    const chineseRegex = /[\u4e00-\u9fff]/g;
    const matches = text.match(chineseRegex);
    return matches ? matches.length : 0;
}

function calculateTranslationSimilarity(userText, idealText) {
    if (!userText || !idealText) return 0;
    
    const user = userText.toLowerCase().replace(/\s+/g, '');
    const ideal = idealText.toLowerCase().replace(/\s+/g, '');
    
    if (user === ideal) return 100;
    
    // –ü—Ä–æ—Å—Ç–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ –∏ –æ–±—â–∏–º —Å–∏–º–≤–æ–ª–∞–º
    const lengthSimilarity = 1 - Math.abs(user.length - ideal.length) / Math.max(user.length, ideal.length);
    
    const userChars = new Set(user);
    const idealChars = new Set(ideal);
    let common = 0;
    
    for (const char of userChars) {
        if (idealChars.has(char)) common++;
    }
    
    const charSimilarity = (common * 2) / (userChars.size + idealChars.size);
    
    return Math.round((lengthSimilarity * 0.3 + charSimilarity * 0.7) * 100);
}

function generateIdealTranslation(originalText) {
    // –ü—Ä–æ—Å—Ç–æ–π fallback –ø–µ—Ä–µ–≤–æ–¥
    const translations = {
        "–°–µ–≥–æ–¥–Ω—è –≤ –ü–µ–∫–∏–Ω–µ —Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞.": "‰ªäÂ§©Âåó‰∫¨Â§©Ê∞îÂæàÂ•Ω„ÄÇ",
        "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 25 –≥—Ä–∞–¥—É—Å–æ–≤.": "Ê∏©Â∫¶ÊòØ25Â∫¶„ÄÇ",
        "–ú–Ω–æ–≥–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –≥—É–ª—è—é—Ç –ø–æ –ø–∞—Ä–∫—É.": "ÂæàÂ§öÊ∏∏ÂÆ¢Âú®ÂÖ¨Âõ≠ÈáåÊï£Ê≠•„ÄÇ",
        "–í—á–µ—Ä–∞ –≤ –®–∞–Ω—Ö–∞–µ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä.": "Êò®Â§©Âú®‰∏äÊµ∑ÂºÄ‰∫ÜÊñ∞ÁöÑÁßëÊäÄ‰∏≠ÂøÉ„ÄÇ",
        "–û–Ω –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.": "ÂÆÉÂ∞ÜËøõË°å‰∫∫Â∑•Êô∫ËÉΩÁ†îÁ©∂„ÄÇ",
        "–û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ü–µ–Ω—Ç—Ä —Å–æ–∑–¥–∞—Å—Ç 500 –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç.": "È¢ÑËÆ°‰∏≠ÂøÉÂ∞ÜÂàõÈÄ†500‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂ≤ó‰Ωç„ÄÇ"
    };
    
    return translations[originalText] || "ËøôÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÁøªËØëÁªÉ‰π†„ÄÇÁªßÁª≠Âä™ÂäõÔºÅ";
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è showTranslationResult —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function showTranslationResult(result, userTranslation) {
    console.log("–ü–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞:", result);
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
    const translationArea = document.getElementById('translationArea');
    let resultSection = document.getElementById('translationResultSection');
    
    // –ï—Å–ª–∏ —Å–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–µ
    if (!resultSection) {
        console.log("–°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞—é –Ω–æ–≤—É—é...");
        resultSection = createTranslationResultSection();
    }
    
    if (!translationArea) {
        console.error('translationArea –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞
    translationArea.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    resultSection.style.display = 'block';
    
    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤
    const actualScore = result.overall_score || 
                       calculateRealisticScore(userTranslation, 
                                             result.ideal_translation || 
                                             generateIdealTranslation(currentTranslationData?.original_text || ''));
    
    console.log("–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –±–∞–ª–ª:", actualScore);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    fillTranslationResultSection(resultSection, result, userTranslation, actualScore);
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    resultSection.scrollIntoView({ behavior: 'smooth' });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (currentTranslationData) {
        currentTranslationData.result = result;
        currentTranslationData.userTranslation = userTranslation;
        currentTranslationData.score = actualScore;
        currentTranslationData.completed_at = new Date().toISOString();
    }
    
    console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–∫–∞–∑–∞–Ω");
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞
function createTranslationResultSection() {
    console.log("–°–æ–∑–¥–∞—é —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞...");
    
    const translationArea = document.getElementById('translationArea');
    if (!translationArea) return null;
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const resultSection = document.createElement('div');
    resultSection.id = 'translationResultSection';
    resultSection.style.display = 'none';
    resultSection.style.marginTop = '30px';
    
    // –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    resultSection.innerHTML = `
        <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="retryTranslation()">
                        <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <button class="btn btn-success" onclick="saveTranslationResult()">
                        <i class="fas fa-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                </div>
            </div>
            
            <!-- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
            <div id="translationOverallScore" style="text-align: center; margin-bottom: 30px;">
                <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
            </div>
            
            <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
            <div id="translationComparison" style="margin-bottom: 30px;">
                <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
            </div>
            
            <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
            <div id="translationDetailedAnalysis">
                <!-- –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
            </div>
        </div>
    `;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ translationArea
    translationArea.parentNode.insertBefore(resultSection, translationArea.nextSibling);
    
    return resultSection;
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function fillTranslationResultSection(resultSection, result, userTranslation, score) {
    // –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
    const overallScoreDiv = resultSection.querySelector('#translationOverallScore');
    if (overallScoreDiv) {
        overallScoreDiv.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="font-size: 3em; font-weight: bold; color: ${getScoreColor(score)}">${score}/100</div>
                    <div style="color: var(--gray);">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞</div>
                </div>
                <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">
                        HSK ${currentTranslationData?.target_hsk || currentTranslationData?.hskLevel || 4}
                    </div>
                    <div style="color: var(--gray);">–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å</div>
                </div>
                <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5em; font-weight: bold; color: var(--success);">${userTranslation.length}</div>
                    <div style="color: var(--gray);">–°–∏–º–≤–æ–ª–æ–≤</div>
                </div>
            </div>
        `;
    }
    
    // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    const comparisonDiv = resultSection.querySelector('#translationComparison');
    if (comparisonDiv) {
        const idealTranslation = result.ideal_translation || generateIdealTranslation(currentTranslationData?.original_text || '');
        const similarity = calculateTranslationSimilarity(userTranslation, idealTranslation);
        
        comparisonDiv.innerHTML = `
            <h4 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-exchange-alt"></i> –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤:
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <div style="font-weight: bold; color: var(--success); margin-bottom: 10px;">
                        <i class="fas fa-user"></i> –í–∞—à –ø–µ—Ä–µ–≤–æ–¥:
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; min-height: 150px;">
                        ${userTranslation.replace(/\n/g, '<br>')}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                        ${countChineseCharacters(userTranslation)} –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
                    </div>
                </div>
                
                <div>
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                        <i class="fas fa-robot"></i> –ò–¥–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ AI:
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 150px;">
                        ${idealTranslation.replace(/\n/g, '<br>')}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                        AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
                    </div>
                </div>
            </div>
            
            <div class="word-tip" style="margin-bottom: 20px;">
                <strong>–°—Ö–æ–¥—Å—Ç–≤–æ:</strong> ${similarity}%
                ${score >= 85 ? 'üéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!' : score >= 70 ? 'üëç –•–æ—Ä–æ—à–æ, –º–æ–∂–Ω–æ –ª—É—á—à–µ' : 'üí™ –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è'}
            </div>
        `;
    }
    
    // –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    const detailedDiv = resultSection.querySelector('#translationDetailedAnalysis');
    if (detailedDiv) {
        const categories = result.categories || [
            { 
                name: '–¢–æ—á–Ω–æ—Å—Ç—å', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 70), 
                feedback: '–°–º—ã—Å–ª –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤–µ—Ä–Ω–æ' 
            },
            { 
                name: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 65), 
                feedback: '–ï—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö' 
            },
            { 
                name: '–õ–µ–∫—Å–∏–∫–∞', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 75), 
                feedback: '–•–æ—Ä–æ—à–∏–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å' 
            },
            { 
                name: '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 60), 
                feedback: '–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º' 
            }
        ];
        
        const errors = result.errors || [];
        
        detailedDiv.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-chart-pie"></i> –û—Ü–µ–Ω–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${categories.map(cat => `
                        <div class="stat-card">
                            <h3>${cat.name}</h3>
                            <div class="stat-number">${cat.score}/100</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${cat.score}%; background: ${getScoreColor(cat.score)}"></div>
                            </div>
                            <div class="stat-desc">${cat.feedback || ''}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--warning); margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:
                </h4>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                    ${errors.length > 0 ? errors.map((err, index) => `
                        <div style="margin-bottom: ${index < errors.length - 1 ? '15px' : '0'}; padding-bottom: ${index < errors.length - 1 ? '15px' : '0'}; 
                                    border-bottom: ${index < errors.length - 1 ? '1px solid #ffc107' : 'none'}">
                            <div style="font-weight: bold; color: var(--danger);">
                                <i class="fas fa-times-circle"></i> –û—à–∏–±–∫–∞ ${index + 1}:
                            </div>
                            <div style="margin: 5px 0; font-family: 'SimSun', serif;">${err.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>
                            <div style="color: var(--success);">
                                <i class="fas fa-check-circle"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${err.correction || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É'}
                            </div>
                        </div>
                    `).join('') : '<p style="color: var(--success);"><i class="fas fa-check-circle"></i> –°–µ—Ä—å—ë–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!</p>'}
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--success); margin-bottom: 15px;">
                    <i class="fas fa-star"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:
                </h4>
                <div class="word-tip">
                    ${result.recommendations || `
                    <ul>
                        <li>–ò–∑—É—á–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –≤ –∫–∏—Ç–∞–π—Å–∫–æ–º: –ü–æ–¥–ª–µ–∂–∞—â–µ–µ + –°–∫–∞–∑—É–µ–º–æ–µ + –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</li>
                        <li>–û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó</li>
                        <li>–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω–æ</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Pleco –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª–æ–≤</li>
                        <li>–ß–∏—Ç–∞–π—Ç–µ –∫–∏—Ç–∞–π—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –≤–∞—à–µ–≥–æ —É—Ä–æ–≤–Ω—è HSK</li>
                    </ul>
                    `}
                </div>
            </div>
            
            <div>
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-history"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                            ${Math.floor((new Date() - (currentTranslationData?.startTime || new Date())) / 1000 / 60)} –º–∏–Ω
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–í—Ä–µ–º—è</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                            ${Math.floor(userTranslation.length / Math.max(1, (new Date() - (currentTranslationData?.startTime || new Date())) / 1000 / 60))}Â≠ó/–º–∏–Ω
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–°–∫–æ—Ä–æ—Å—Ç—å</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                            ${new Set(userTranslation.match(/[\u4e00-\u9fff]/g) || []).size}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                            ${userTranslation.split(/[Ôºå„ÄÇÔºÅÔºü]/).filter(s => s.trim()).length}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –ø–æ –±–∞–ª–ª—É
function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
function calculateRealisticScore(userTranslation, idealTranslation) {
    if (!userTranslation || !idealTranslation) return 0;
    
    let score = 0;
    
    // 1. –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ (–º–∞–∫—Å–∏–º—É–º 20 –±–∞–ª–ª–æ–≤)
    const userLength = userTranslation.length;
    const idealLength = idealTranslation.length;
    const lengthRatio = Math.min(1, userLength / Math.max(10, idealLength));
    score += Math.round(lengthRatio * 20);
    
    // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (–º–∞–∫—Å–∏–º—É–º 30 –±–∞–ª–ª–æ–≤)
    const chineseChars = countChineseCharacters(userTranslation);
    const minRequired = Math.max(3, idealTranslation.replace(/[^\u4e00-\u9fff]/g, '').length * 0.3);
    
    if (chineseChars >= minRequired) {
        score += Math.min(30, (chineseChars / minRequired) * 30);
    }
    
    // 3. –°—Ö–æ–¥—Å—Ç–≤–æ —Å –∏–¥–µ–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–º–∞–∫—Å–∏–º—É–º 50 –±–∞–ª–ª–æ–≤)
    const similarity = calculateTranslationSimilarity(userTranslation, idealTranslation);
    score += Math.round(similarity * 0.5);
    
    // 4. –®—Ç—Ä–∞—Ñ –∑–∞ –æ—á–µ–≤–∏–¥–Ω—ã–µ –æ—à–∏–±–∫–∏
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
    if (chineseChars === 0) {
        score = Math.max(0, score - 30);
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
    if (userTranslation.length < 5) {
        score = Math.max(0, score - 20);
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 100
    return Math.min(100, Math.max(0, score));
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

function clearTimers() {
    clearInterval(essayTimer);
    clearInterval(translationTimer);
}

function cancelEssayWriting() {
    if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ? –í–µ—Å—å —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
        clearInterval(essayTimer);
        document.getElementById('essayWritingArea').style.display = 'none';
        document.getElementById('essayModeContent').style.display = 'block';
    }
}

function cancelTranslation() {
    if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥? –í–µ—Å—å —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
        clearInterval(translationTimer);
        document.getElementById('translationArea').style.display = 'none';
        document.getElementById('translationModeContent').style.display = 'block';
    }
}

function retryEssay() {
    document.getElementById('essayResultSection').style.display = 'none';
    startEssayWriting();
}

function retryTranslation() {
    document.getElementById('translationResultSection').style.display = 'none';
    generateTranslationText();
}

function saveEssayResult() {
    if (!currentEssayData) return;
    
    const data = {
        type: 'essay_check',
        data: currentEssayData,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `essay_check_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
}

function saveTranslationResult() {
    if (!currentTranslationData) return;
    
    const data = {
        type: 'translation_check',
        data: currentTranslationData,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `translation_check_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏
function initEssayChecker() {
    updateEssayRequirements();
    updateTranslationExample();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ HSK
    setEssayHskLevel(4);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
    setTranslationDifficulty('medium');
}
        // –°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–æ–≤
let currentChatId = null;
let userChats = {};
let currentHskTest = null;
let testTimer = null;
let testTimeLeft = 0;
        let testAnswers = {};

        // –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
let currentUser = null;

// –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç
let voiceRecognition = null;
let isRecording = false;
let voiceChatHistory = [];
let learnedChengyu = [];
let currentVoiceThread = null;
let voiceChatSessions = [];

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤
let generatedTextsHistory = [];
let currentGeneratedText = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
function loadTextHistory() {
    try {
        const saved = localStorage.getItem('hsk_generated_texts');
        if (saved) {
            generatedTextsHistory = JSON.parse(saved);
            updateHistoryList();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
function updateHistoryList() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    if (generatedTextsHistory.length === 0) {
        historyList.innerHTML = '<p style="color: var(--gray); text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
        return;
    }
    
    historyList.innerHTML = generatedTextsHistory.slice(0, 5).map((item, index) => `
        <div style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; 
                    border-left: 4px solid var(--primary); cursor: pointer;" 
             onclick="loadTextFromHistory(${generatedTextsHistory.length - 1 - index})">
            <div style="font-weight: bold; display: flex; justify-content: space-between;">
                <span>${item.topic.substring(0, 40)}${item.topic.length > 40 ? '...' : ''}</span>
                <span style="font-size: 0.8em; color: var(--gray);">HSK ${item.hskLevel}</span>
            </div>
            <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                ${new Date(item.timestamp).toLocaleDateString('ru-RU')} ‚Ä¢ 
                ${item.format === 'chinese_only' ? '–¢–æ–ª—å–∫–æ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã' : 
                  item.format === 'manga' ? '–ú–∞–Ω–≥–∞' : '–ü–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'}
            </div>
        </div>
    `).join('');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–∞
function loadExample(type) {
    const examples = {
        'mall': {
            topic: "–î–∏–∞–ª–æ–≥ –≤ –∫–∏—Ç–∞–π—Å–∫–æ–º —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–µ",
            description: "–î–≤–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–∞ –ø—ã—Ç–∞—é—Ç—Å—è –∫—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã, —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Ü–µ–Ω–∞—Ö, –∏—â—É—Ç –Ω—É–∂–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã. –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è —Å –∫–∏—Ç–∞–π—Å–∫–æ–π –µ–¥–æ–π."
        },
        'restaurant': {
            topic: "–ó–∞–∫–∞–∑ –µ–¥—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ",
            description: "–ì—Ä—É–ø–ø–∞ –¥—Ä—É–∑–µ–π –≤ –ø–µ–∫–∏–Ω—Å–∫–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –û–Ω–∏ –≤—ã–±–∏—Ä–∞—é—Ç –±–ª—é–¥–∞, —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–ø–µ—Ü–∏—è—Ö, –æ–±—Å—É–∂–¥–∞—é—Ç –≤–∫—É—Å."
        },
        'university': {
            topic: "–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ",
            description: "–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç –ø—Ä–∏–µ–∑–∂–∞–µ—Ç –≤ –∫–∏—Ç–∞–π—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç. –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Å–æ–∫—É—Ä—Å–Ω–∏–∫–∞–º–∏, –ø–æ–∏—Å–∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –¥–∏–∞–ª–æ–≥–∏ —Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º."
        },
        'travel': {
            topic: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ü–µ–∫–∏–Ω—É",
            description: "–¢—É—Ä–∏—Å—Ç –ø–æ—Å–µ—â–∞–µ—Ç –í–µ–ª–∏–∫—É—é –ö–∏—Ç–∞–π—Å–∫—É—é —Å—Ç–µ–Ω—É, –ó–∞–ø—Ä–µ—Ç–Ω—ã–π –≥–æ—Ä–æ–¥, –•—Ä–∞–º –ù–µ–±–∞. –î–∏–∞–ª–æ–≥–∏ —Å –≥–∏–¥–æ–º, —Ç–∞–∫—Å–∏—Å—Ç–æ–º, –º–µ—Å—Ç–Ω—ã–º–∏ –∂–∏—Ç–µ–ª—è–º–∏."
        },
        'business': {
            topic: "–î–µ–ª–æ–≤—ã–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –≤ –®–∞–Ω—Ö–∞–µ",
            description: "–ë–∏–∑–Ω–µ—Å-–≤—Å—Ç—Ä–µ—á–∞ –≤ –Ω–µ–±–æ—Å–∫—Ä–µ–±–µ –®–∞–Ω—Ö–∞—è. –û–±—Å—É–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞, –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –æ —Ü–µ–Ω–∞—Ö."
        }
    };
    
    if (examples[type]) {
        document.getElementById('textTopic').value = examples[type].topic;
        document.getElementById('textDescription').value = examples[type].description;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
function calculateTranslationSimilarity(userText, idealText) {
    // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
    if (!userText || !idealText) return 0;
    
    // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
    const user = userText.toLowerCase().replace(/\s+/g, '');
    const ideal = idealText.toLowerCase().replace(/\s+/g, '');
    
    if (user === ideal) return 100;
    
    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
    const lengthSimilarity = 1 - Math.abs(user.length - ideal.length) / Math.max(user.length, ideal.length);
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–±—â–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    const userChars = new Set(user);
    const idealChars = new Set(ideal);
    let common = 0;
    
    for (const char of userChars) {
        if (idealChars.has(char)) common++;
    }
    
    const charSimilarity = (common * 2) / (userChars.size + idealChars.size);
    
    // –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    return Math.round((lengthSimilarity * 0.3 + charSimilarity * 0.7) * 100);
}

function countChineseCharacters(text) {
    // –°—á–∏—Ç–∞–µ–º –∫–∏—Ç–∞–π—Å–∫–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
    const chineseRegex = /[\u4e00-\u9fff]/g;
    const matches = text.match(chineseRegex);
    return matches ? matches.length : 0;
}

function generateIdealTranslation(originalText) {
    // –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–≤–æ–¥ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å AI)
    const translations = {
        "–°–µ–≥–æ–¥–Ω—è –≤ –ü–µ–∫–∏–Ω–µ —Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞.": "‰ªäÂ§©Âåó‰∫¨Â§©Ê∞îÂæàÂ•Ω„ÄÇ",
        "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 25 –≥—Ä–∞–¥—É—Å–æ–≤.": "Ê∏©Â∫¶ÊòØ25Â∫¶„ÄÇ",
        "–ú–Ω–æ–≥–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –≥—É–ª—è—é—Ç –ø–æ –ø–∞—Ä–∫—É.": "ÂæàÂ§öÊ∏∏ÂÆ¢Âú®ÂÖ¨Âõ≠ÈáåÊï£Ê≠•„ÄÇ",
        "–í—á–µ—Ä–∞ –≤ –®–∞–Ω—Ö–∞–µ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä.": "Êò®Â§©Âú®‰∏äÊµ∑ÂºÄ‰∫ÜÊñ∞ÁöÑÁßëÊäÄ‰∏≠ÂøÉ„ÄÇ",
        "–û–Ω –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.": "ÂÆÉÂ∞ÜËøõË°å‰∫∫Â∑•Êô∫ËÉΩÁ†îÁ©∂„ÄÇ",
        "–û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ü–µ–Ω—Ç—Ä —Å–æ–∑–¥–∞—Å—Ç 500 –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç.": "È¢ÑËÆ°‰∏≠ÂøÉÂ∞ÜÂàõÈÄ†500‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂ≤ó‰Ωç„ÄÇ"
    };
    
    return translations[originalText] || "ËøôÊòØ‰∏Ä‰∏™‰∏≠ÊñáÁøªËØëÁ§∫‰æã„ÄÇ";
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
async function generateChineseText() {
    const topic = document.getElementById('textTopic').value.trim();
    const description = document.getElementById('textDescription').value.trim();
    const hskLevel = parseInt(document.getElementById('textHskLevel').value);
    const format = document.querySelector('input[name="textFormat"]:checked').value;
    
    if (!topic) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É —Ç–µ–∫—Å—Ç–∞!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const generateBtn = document.getElementById('generateTextBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
    generateBtn.disabled = true;
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ –±—ã–ª
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
const translationResultSection = document.getElementById('translationResultSection');
if (translationResultSection) {
    translationResultSection.style.display = 'none';
}

// –°–∫—Ä—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞ (–µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞)
const translationArea = document.getElementById('translationArea');
if (translationArea) {
    translationArea.style.display = 'none';
}
    
    try {
        const requestData = {
            topic: topic,
            description: description,
            hsk_level: hskLevel,
            format: format,
            user_id: currentUser?.user_id || null,
            length: 'medium', // medium (~2000 —Å–∏–º–≤–æ–ª–æ–≤), short, long
            include_emojis: true,
            manga_style: format === 'manga'
        };
        
        const response = await fetch(`${API_BASE}/text/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç
        currentGeneratedText = data;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        displayGeneratedText(data);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        const historyItem = {
            id: `text_${Date.now()}`,
            topic: topic,
            description: description,
            hskLevel: hskLevel,
            format: format,
            timestamp: new Date().toISOString(),
            text: data.text,
            stats: data.stats
        };
        
        generatedTextsHistory.unshift(historyItem);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if (generatedTextsHistory.length > 50) {
            generatedTextsHistory = generatedTextsHistory.slice(0, 50);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        localStorage.setItem('hsk_generated_texts', JSON.stringify(generatedTextsHistory));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏
        updateHistoryList();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä
        showFallbackText(topic, hskLevel, format);
        
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
function displayGeneratedText(data) {
    const resultSection = document.getElementById('textResultSection');
    const resultDiv = document.getElementById('textResult');
    const statsDiv = document.getElementById('textStats');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
    resultSection.style.display = 'block';
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    let displayText = '';
    
    if (data.format === 'chinese_only') {
        displayText = `<div style="font-size: 18px; line-height: 1.8; font-family: 'SimSun', 'ÂÆã‰Ωì', serif;">
            ${data.text.replace(/\n/g, '<br>')}
        </div>`;
    } else if (data.format === 'full') {
        displayText = `<div style="font-family: 'Segoe UI', sans-serif;">
            ${data.text_with_pinyin || data.text.replace(/\n/g, '<br>')}
        </div>`;
    } else if (data.format === 'manga') {
        displayText = `<div style="font-family: 'SimSun', 'ÂÆã‰Ωì', serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px;">
            <div style="text-align: center; margin-bottom: 20px; font-weight: bold; color: var(--primary);">
                üéå ${data.topic}
            </div>
            ${data.text.replace(/\n/g, '<br>')}
        </div>`;
    }
    
    resultDiv.innerHTML = displayText;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if (data.stats) {
        statsDiv.innerHTML = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                        ${data.stats.characters || 0}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–ò–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                        ${data.stats.unique_words || 0}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                        HSK ${data.stats.hsk_level || 3}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                        ${data.stats.new_words || 0}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">–ù–æ–≤—ã—Ö —Å–ª–æ–≤</div>
                </div>
            </div>
        `;
    }
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// –§–æ–ª–ª–±—ç–∫ –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
function showFallbackText(topic, hskLevel, format) {
    const fallbackTexts = {
        'mall': `üè¨ **Âú®Ë∂ÖÂ∏ÇË¥≠Áâ©** üõí
        
Â∞èÁéãÔºö‰Ω†Â•ΩÔºÅËøô‰∏™ËãπÊûúÂ§öÂ∞ëÈí±Ôºüüçé
ÂîÆË¥ßÂëòÔºö‰∏ÄÊñ§ÂçÅÂùóÈí±„ÄÇüí∞
Â∞èÁéãÔºöÂ§™Ë¥µ‰∫ÜÔºÅÂèØ‰ª•‰æøÂÆú‰∏ÄÁÇπÂêóÔºüü§î
ÂîÆË¥ßÂëòÔºöÂ•ΩÂêßÔºåÁªô‰Ω†ÂÖ´Âùó„ÄÇü§ë
Â∞èÁéãÔºöË∞¢Ë∞¢ÔºÅÊàëË¶Å‰∏§Êñ§„ÄÇüôè
        
‰ªäÂ§©Ë∂ÖÂ∏ÇÈáåÁöÑ‰∫∫ÂæàÂ§öüë•ÔºåÂ§ßÂÆ∂ÈÉΩÂú®‰π∞È£üÁâ©ü•¶„ÄÇÊàëÁúãÂà∞‰∫ÜÂæàÂ§ö‰∏≠ÂõΩËèúü•¨Ôºå‰ΩÜÊòØ‰∏çËÆ§ËØÜÂêçÂ≠óüòÖ„ÄÇ`,
        
        'restaurant': `üçú **Âú®È§êÂéÖÂêÉÈ•≠** ü•¢
        
ÊúçÂä°ÂëòÔºöÊ¨¢ËøéÂÖâ‰∏¥ÔºÅüëã Âá†‰ΩçÔºü
ÊùéÊòéÔºö‰∏â‰ΩçÔºåË∞¢Ë∞¢„ÄÇüôè
ÊúçÂä°ÂëòÔºöËøôÊòØËèúÂçïüìñÔºåËØ∑ÁÇπËèú„ÄÇ
        
Â∞èÁ∫¢ÔºöÊàëÊÉ≥ÂêÉÂÆ´‰øùÈ∏°‰∏ÅüêîÔºåËæ£‰∏çËæ£Ôºüüå∂Ô∏è
ÊúçÂä°ÂëòÔºöÊúâ‰∏ÄÁÇπËæ£ÔºåÂèØ‰ª•Â∞ëÊîæËæ£Ê§í„ÄÇüëç
        
Â§ßÂÆ∂ÈÉΩÁÇπ‰∫ÜËá™Â∑±ÂñúÊ¨¢ÁöÑËèúüç≤ÔºåÈ§êÂéÖÁöÑÈü≥‰πêÂæàÂ•ΩÂê¨üéµ„ÄÇ`,
        
        'university': `üéì **Â§ßÂ≠¶Á¨¨‰∏ÄÂ§©** üìö
        
ËÄÅÂ∏àÔºöÂêåÂ≠¶‰ª¨Â•ΩÔºÅüë®‚Äçüè´ ÊàëÊòØÁéãËÄÅÂ∏à„ÄÇ
Â≠¶Áîü‰ª¨ÔºöËÄÅÂ∏àÂ•ΩÔºÅüë®‚Äçüéìüë©‚Äçüéì
        
Â§ñÂõΩÂ≠¶ÁîüÔºöÂØπ‰∏çËµ∑ÔºåÊàëÁöÑ‰∏≠Êñá‰∏çÂ•ΩüòÖ„ÄÇ
ÁéãËÄÅÂ∏àÔºöÊ≤°ÂÖ≥Á≥ªÔºåÊÖ¢ÊÖ¢Â≠¶‰π†üí™„ÄÇ
        
Â§ßÂ≠¶ÂæàÂ§ßüèõÔ∏èÔºåÊúâÂæàÂ§öÊ•º„ÄÇÂõæ‰π¶È¶ÜüìöÂú®ÊúÄ‰∏≠Èó¥ÔºåÈ£üÂ†ÇüçöÂú®Â∑¶Ëæπ„ÄÇ`
    };
    
    let fallbackKey = 'mall';
    if (topic.includes('—Ä–µ—Å—Ç–æ—Ä–∞–Ω') || topic.includes('—Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ')) fallbackKey = 'restaurant';
    if (topic.includes('—É–Ω–∏–≤–µ—Ä') || topic.includes('—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç')) fallbackKey = 'university';
    
    const mockData = {
        text: fallbackTexts[fallbackKey],
        format: format,
        topic: topic,
        stats: {
            characters: 350,
            unique_words: 120,
            hsk_level: hskLevel,
            new_words: 15
        }
    };
    
    currentGeneratedText = mockData;
    displayGeneratedText(mockData);
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
function copyTextToClipboard() {
    if (!currentGeneratedText) return;
    
    const textToCopy = currentGeneratedText.text || currentGeneratedText.text_with_pinyin;
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
    });
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
function saveGeneratedText() {
    if (!currentGeneratedText) return;
    
    const blob = new Blob([JSON.stringify(currentGeneratedText, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hsk_text_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ –¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
}

// –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
function speakGeneratedText() {
    if (!currentGeneratedText || !currentGeneratedText.text) return;
    
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(currentGeneratedText.text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.pitch = 1;
        
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh-CN') || voice.lang.startsWith('zh')
        );
        
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        speechSynthesis.speak(utterance);
        showNotification('üîä –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å');
    } else {
        alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞');
    }
}

// –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
function regenerateText() {
    if (!currentGeneratedText) return;
    
    generateChineseText();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
function loadTextFromHistory(index) {
    if (index < 0 || index >= generatedTextsHistory.length) return;
    
    const item = generatedTextsHistory[index];
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
    document.getElementById('textTopic').value = item.topic;
    document.getElementById('textDescription').value = item.description;
    document.getElementById('textHskLevel').value = item.hskLevel;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç
    const formatRadios = document.querySelectorAll('input[name="textFormat"]');
    formatRadios.forEach(radio => {
        radio.checked = (radio.value === item.format);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
    currentGeneratedText = {
        text: item.text,
        format: item.format,
        topic: item.topic,
        stats: item.stats
    };
    
    displayGeneratedText(currentGeneratedText);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--success), #4cd964);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.5s ease;
    `;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// –î–æ–±–∞–≤—å—Ç–µ –≤ window.onload:
// loadTextHistory();

function initVoiceChatHistory() {
    try {
        const saved = localStorage.getItem('hsk_voice_history');
        if (saved) {
            voiceChatHistory = JSON.parse(saved);
        }
        
        const savedSessions = localStorage.getItem('hsk_voice_sessions');
        if (savedSessions) {
            voiceChatSessions = JSON.parse(savedSessions);
            updateVoiceSessionsList();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function saveVoiceChatHistory() {
    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â—É—é –∏—Å—Ç–æ—Ä–∏—é
        localStorage.setItem('hsk_voice_history', JSON.stringify(voiceChatHistory));
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏–∏
        localStorage.setItem('hsk_voice_sessions', JSON.stringify(voiceChatSessions));
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
function addToVoiceHistory(sender, text, type = 'normal') {
    const message = {
        id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        sender: sender,
        text: text,
        type: type,
        timestamp: new Date().toISOString(),
        sessionId: currentVoiceSessionId
    };
    
    voiceChatHistory.push(message);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
    if (voiceChatHistory.length > 1000) {
        voiceChatHistory = voiceChatHistory.slice(-500);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
    updateCurrentSession(message);
    
    saveVoiceChatHistory();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
let currentVoiceSessionId = null;
function createNewVoiceSession() {
    const sessionId = `session_${Date.now()}`;
    const session = {
        id: sessionId,
        title: `ÂØπËØù ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`,
        created: new Date().toISOString(),
        lastActivity: new Date().toISOString(),
        messageCount: 0,
        chengyuLearned: [],
        language: 'zh-CN'
    };
    
    voiceChatSessions.unshift(session);
    currentVoiceSessionId = sessionId;
    
    updateVoiceSessionsList();
    saveVoiceChatHistory();
    
    return sessionId;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
function updateCurrentSession(message) {
    const session = voiceChatSessions.find(s => s.id === currentVoiceSessionId);
    if (session) {
        session.lastActivity = new Date().toISOString();
        session.messageCount++;
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —á—ç–Ω—ä—é–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (message.sender === 'AI') {
            const chengyuInMessage = extractChengyuFromMessage(message.text);
            chengyuInMessage.forEach(chengyu => {
                if (!session.chengyuLearned.includes(chengyu)) {
                    session.chengyuLearned.push(chengyu);
                }
            });
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π
function updateVoiceSessionsList() {
    const container = document.getElementById('voiceSessionsList');
    if (!container) return;
    
    if (voiceChatSessions.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--gray); padding: 20px;">
                <div style="font-size: 2em;">üìÅ</div>
                <p>–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –ø—É—Å—Ç–∞</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = voiceChatSessions.map((session, index) => `
        <div class="session-item ${session.id === currentVoiceSessionId ? 'active' : ''}"
             onclick="loadVoiceSession('${session.id}')"
             style="padding: 12px; 
                    margin-bottom: 8px; 
                    border-radius: 8px; 
                    background: ${session.id === currentVoiceSessionId ? '#e3f2fd' : '#f8f9fa'};
                    border-left: 4px solid ${session.id === currentVoiceSessionId ? 'var(--primary)' : '#dee2e6'};
                    cursor: pointer;
                    transition: all 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: ${session.id === currentVoiceSessionId ? 'bold' : 'normal'}; 
                            color: var(--dark);">
                    ${session.title}
                </div>
                <div style="font-size: 0.8em; color: var(--gray);">
                    ${formatDate(session.lastActivity)}
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                <div style="font-size: 0.8em; color: var(--gray);">
                    Ê∂àÊÅØ: ${session.messageCount}
                </div>
                <div style="font-size: 0.8em; color: var(--success);">
                    ÊàêËØ≠: ${session.chengyuLearned.length}
                </div>
            </div>
            ${session.chengyuLearned.length > 0 ? `
                <div style="margin-top: 5px; font-size: 0.7em; color: var(--gray);">
                    ${session.chengyuLearned.slice(0, 2).join('„ÄÅ')}${session.chengyuLearned.length > 2 ? '...' : ''}
                </div>
            ` : ''}
        </div>
    `).join('');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏
function loadVoiceSession(sessionId) {
    currentVoiceSessionId = sessionId;
    
    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
    document.getElementById('voiceChatBox').innerHTML = '';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
    const sessionMessages = voiceChatHistory.filter(msg => msg.sessionId === sessionId);
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    sessionMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    sessionMessages.forEach(msg => {
        addVoiceMessage(msg.sender, msg.text, msg.type);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
    updateVoiceSessionsList();
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
    const chatBox = document.getElementById('voiceChatBox');
    chatBox.scrollTop = chatBox.scrollHeight;
}

// –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
function exportVoiceHistory() {
    const data = {
        sessions: voiceChatSessions,
        messages: voiceChatHistory,
        exportedAt: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hsk_voice_history_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// –ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
function importVoiceHistory(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.sessions) {
                voiceChatSessions = data.sessions;
            }
            
            if (data.messages) {
                voiceChatHistory = data.messages;
            }
            
            saveVoiceChatHistory();
            updateVoiceSessionsList();
            
            alert('–ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
        }
    };
    
    reader.readAsText(file);
}

async function refreshAudioHistory() {
    try {
        if (currentUser?.user_id) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞
            const response = await fetch(`${API_BASE}/audio/history/${currentUser.user_id}`);
            if (response.ok) {
                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                if (data.history && data.history.length > 0) {
                    localStorage.setItem('hsk_audio_history', JSON.stringify(data.history));
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        updateAudioHistory();
        showNotification('üîÑ –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
const isSpeechSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
const isSpeechSynthesisSupported = 'speechSynthesis' in window;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞
function initVoiceChat() {
    if (!isSpeechSupported) {
        alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´„ÄÇËØ∑‰ΩøÁî®ChromeÊàñEdge„ÄÇ„Äê–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge.„Äë');
        return;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SpeechRecognition();
    
    voiceRecognition.continuous = true;
    voiceRecognition.interimResults = true;
    voiceRecognition.lang = 'zh-CN'; // –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π!
    
    voiceRecognition.onstart = function() {
        console.log('üé§ –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞');
        isRecording = true;
        updateVoiceUI(true);
    };
    
    voiceRecognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (interimTranscript) {
            updateInterimTranscript(interimTranscript);
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        if (finalTranscript) {
            processVoiceCommand(finalTranscript);
        }
    };
    
    voiceRecognition.onerror = function(event) {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
        if (event.error === 'no-speech') {
            addVoiceMessage('AI', '–Ø –Ω–µ —É—Å–ª—ã—à–∞–ª —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
        }
    };
    
    voiceRecognition.onend = function() {
        console.log('üé§ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        isRecording = false;
        updateVoiceUI(false);
    };
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑—É—á–µ–Ω–Ω—ã—Ö —á—ç–Ω—ä—é–µ–≤
    loadLearnedChengyu();

    initVoiceChatHistory();
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
    createNewVoiceSession();
    
    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º
    setTimeout(() => {
        addVoiceMessage('AI', '‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑ‰∏≠ÊñáAIËÄÅÂ∏à„ÄÇÊàë‰ºöÂè™ËØ¥‰∏≠ÊñáÔºåÂ∏Æ‰Ω†ÁªÉ‰π†Âê¨Âäõ„ÄÅÂè£ËØ≠ÂíåÊàêËØ≠„ÄÇËØ∑ËØ¥"ÂºÄÂßã"ÊàñÊèêÈóÆÂêßÔºÅ', 'info');
    }, 500);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∑–∞–ø–∏—Å–∏
function updateVoiceUI(recording) {
    const startBtn = document.getElementById('startVoiceBtn');
    const stopBtn = document.getElementById('stopVoiceBtn');
    const indicator = document.getElementById('recordingIndicator');
    const level = document.getElementById('recordingLevel');
    
    if (recording) {
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        indicator.style.display = 'block';
        level.style.display = 'block';
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞
        animateVoiceLevel();
    } else {
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        indicator.style.display = 'none';
        level.style.display = 'none';
    }
}

// –ê–Ω–∏–º–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞
function animateVoiceLevel() {
    const levelFill = document.querySelector('#recordingLevel .progress-fill');
    if (!isRecording) return;
    
    const randomLevel = 20 + Math.random() * 80;
    levelFill.style.width = randomLevel + '%';
    
    setTimeout(animateVoiceLevel, 100);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
async function processVoiceCommand(text) {
    text = text.trim();
    if (!text) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addVoiceMessage('user', text);
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç
    clearInterimTranscript();
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã
    const commandType = detectVoiceCommand(text);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ AI
    try {
        const response = await sendVoiceToAI(text, commandType);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
        addVoiceMessage('AI', response);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —á—ç–Ω—ä—é–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
        extractChengyuFromResponse(response);
        
        // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        if (document.getElementById('autoPlayAudio').checked) {
            speakText(response);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ AI:', error);
        addVoiceMessage('AI', '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
    }
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ–º–∞–Ω–¥—ã
function detectVoiceCommand(text) {
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes('—á—ç–Ω—ä—é') || lowerText.includes('ÊàêËØ≠') || lowerText.includes('–∏–¥–∏–æ–º')) {
        return 'chengyu';
    } else if (lowerText.includes('–æ–±—ä—è—Å–Ω–∏') || lowerText.includes('–∑–Ω–∞—á–µ–Ω–∏–µ') || lowerText.includes('Ëß£Èáä')) {
        return 'explain';
    } else if (lowerText.includes('–ø—Ä–∏–º–µ—Ä') || lowerText.includes('–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ') || lowerText.includes('‰æãÂ≠ê')) {
        return 'example';
    } else if (lowerText.includes('–ø–µ—Ä–µ–≤–µ–¥–∏') || lowerText.includes('translation') || lowerText.includes('ÁøªËØë')) {
        return 'translate';
    } else if (lowerText.includes('—Å–ª–µ–¥—É—é—â–∏–π') || lowerText.includes('–¥—Ä—É–≥–æ–π') || lowerText.includes('‰∏ã‰∏Ä‰∏™')) {
        return 'next';
    } else if (lowerText.includes('—Ç–µ—Å—Ç') || lowerText.includes('quiz') || lowerText.includes('ÁªÉ‰π†')) {
        return 'quiz';
    } else if (lowerText.includes('–ø–æ–º–æ—â—å') || lowerText.includes('help') || lowerText.includes('Â∏ÆÂä©')) {
        return 'help';
    }
    
    return 'general';
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–∞ AI
async function sendVoiceToAI(text, commandType) {
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º thread –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞
    if (!currentVoiceThread) {
        try {
            currentVoiceThread = await createVoiceThread();
            console.log("–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ç—Ä–µ–¥:", currentVoiceThread);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–µ–¥–∞:", error);
            currentVoiceThread = `voice_${Date.now()}`;
        }
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —á—ç–Ω—ä—é—è–º–∏
    const context = {
        command_type: commandType,
        learned_chengyu: learnedChengyu.slice(0, 5).map(c => c.character),
        user_level: currentUser?.current_level || 3
    };
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å voice/chat:", {
        message: text.substring(0, 100) + "...",
        thread_id: currentVoiceThread,
        context: context,
        user_id: currentUser?.user_id || null
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    try {
        const response = await fetch(`${API_BASE}/voice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: text,
                thread_id: currentVoiceThread,
                context: context,
                user_id: currentUser?.user_id || null
            })
        });
        
        console.log("–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:", response.status);
        
        if (!response.ok) {
            let errorText = await response.text();
            console.error("–û—à–∏–±–∫–∞ HTTP:", response.status, errorText);
            
            // –ï—Å–ª–∏ 422, –ø—ã—Ç–∞–µ–º—Å—è —Å –Ω–æ–≤—ã–º thread_id
            if (response.status === 422) {
                currentVoiceThread = `voice_retry_${Date.now()}`;
                console.log("–ü—Ä–æ–±—É—é —Å –Ω–æ–≤—ã–º thread_id:", currentVoiceThread);
                
                // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                const retryResponse = await fetch(`${API_BASE}/voice/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: text,
                        thread_id: currentVoiceThread,
                        context: context,
                        user_id: currentUser?.user_id || null
                    })
                });
                
                if (retryResponse.ok) {
                    return (await retryResponse.json()).response;
                }
            }
            
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        return data.response;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ AI:', error);
        throw error;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–µ–¥–∞
async function createVoiceThread() {
    try {
        const response = await fetch(`${API_BASE}/chat/threads/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUser?.user_id || 'voice_user',
                title: '–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç —Å AI',
                category: 'voice_chat'
            })
        });
        
        const data = await response.json();
        return data.thread_id;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–µ–¥–∞:', error);
        return `voice_${Date.now()}`;
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç
function addVoiceMessage(sender, text, type = 'normal') {
    const chatBox = document.getElementById('voiceChatBox');
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (!currentVoiceSessionId) {
        currentVoiceSessionId = createNewVoiceSession();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    let icon = sender === 'user' ? 'üë§' : 'ü§ñ';
    let className = 'ai-message';
    
    if (type === 'warning') {
        icon = '‚ö†Ô∏è';
        className = 'ai-message warning';
    } else if (type === 'tip') {
        icon = 'üí°';
        className = 'ai-message tip';
    } else if (type === 'error') {
        icon = '‚ùå';
        className = 'ai-message error';
    } else if (type === 'info') {
        icon = '‚ÑπÔ∏è';
        className = 'ai-message info';
    }
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="ai-label">${icon} ‰Ω†:</div>
            <div>${text}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="ai-label">${icon} AIËÄÅÂ∏à:</div>
            <div>${text}</div>
        `;
    }
    
    messageDiv.className = `message ${className}`;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    addToVoiceHistory(sender, text, type);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
function updateInterimTranscript(text) {
    let interimDiv = document.getElementById('interimTranscript');
    if (!interimDiv) {
        interimDiv = document.createElement('div');
        interimDiv.id = 'interimTranscript';
        interimDiv.style.cssText = `
            font-style: italic;
            color: var(--gray);
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 5px 0;
        `;
        document.getElementById('voiceChatBox').appendChild(interimDiv);
    }
    interimDiv.textContent = text;
    interimDiv.scrollIntoView({ behavior: 'smooth' });
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
function clearInterimTranscript() {
    const interimDiv = document.getElementById('interimTranscript');
    if (interimDiv) {
        interimDiv.remove();
    }
}

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á—ç–Ω—ä—é–µ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞
// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–æ—è—â–∏—Ö —á—ç–Ω—ä—é–µ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞
function extractChengyuFromResponse(response) {
    if (!document.getElementById('saveChengyu').checked) return;
    
    console.log("üìù –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ AI –¥–ª—è —á—ç–Ω—ä—é–µ–≤...");
    console.log("–û—Ç–≤–µ—Ç:", response.substring(0, 200));
    
    // –ò—â–µ–º —á—ç–Ω—ä—é–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞—Ö
    const patterns = [
        // –ü–∞—Ç—Ç–µ—Ä–Ω: "ÊàêËØ≠: ÁîªËõáÊ∑ªË∂≥"
        /ÊàêËØ≠[:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        // –ü–∞—Ç—Ç–µ—Ä–Ω: "ÊàêËØ≠ÔºöÁîªËõáÊ∑ªË∂≥"
        /[\u4e00-\u9fff]{4}[:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        // –ü–∞—Ç—Ç–µ—Ä–Ω: "¬´ÁîªËõáÊ∑ªË∂≥¬ª"
        /[„Ää„Äå„Äé"]([\u4e00-\u9fff]{4})[„Äç„Äè"„Äã]/g,
        // –ü–∞—Ç—Ç–µ—Ä–Ω: "—á—ç–Ω—äyu: ÁîªËõáÊ∑ªË∂≥"
        /[Cc]h[√©e]ngy[u√º][:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        // –ü–∞—Ç—Ç–µ—Ä–Ω –≤ AI —Ñ–æ—Ä–º–∞—Ç–µ: "ÊàêËØ≠: [4 —Å–∏–º–≤–æ–ª–∞]"
        /ÊàêËØ≠[:Ôºö]\s*\[([\u4e00-\u9fff]{4})\]/g
    ];
    
    let foundChengyu = [];
    
    patterns.forEach(pattern => {
        const matches = response.matchAll(pattern);
        for (const match of matches) {
            const chengyu = match[1];
            if (chengyu && isRealChengyu(chengyu)) {
                foundChengyu.push(chengyu);
                console.log("‚úÖ –ù–∞–π–¥–µ–Ω —á—ç–Ω—ä—é–π:", chengyu);
            }
        }
    });
    
    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    const uniqueChengyu = [...new Set(foundChengyu)];
    
    if (uniqueChengyu.length > 0) {
        console.log("üéØ –î–æ–±–∞–≤–ª—è—é —á—ç–Ω—ä—é–∏:", uniqueChengyu);
        uniqueChengyu.forEach(chengyu => addChengyu(chengyu));
    } else {
        console.log("üì≠ –ß—ç–Ω—ä—é–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç–≤–µ—Ç–µ");
    }
}

// –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–π —á—ç–Ω—ä—é–π
function isRealChengyu(character) {
    if (character.length !== 4) return false;
    
    // –ë–∞–∑–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á—ç–Ω—ä—é–µ–≤ (—Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ)
    const realChengyu = [
        // –£—Ä–æ–≤–µ–Ω—å 1 (–Ω–∞—á–∞–ª—å–Ω—ã–π)
        'ÁîªËõáÊ∑ªË∂≥', 'ÂÆàÊ†™ÂæÖÂÖî', '‰∫ïÂ∫ï‰πãËõô', '‰∫°ÁæäË°•Áâ¢', 'ÁãêÂÅáËôéÂ®Å',
        'ÂØπÁâõÂºπÁê¥', 'ÂçßËôéËóèÈæô', '‰∏ÄÁÆ≠ÂèåÈõï', 'Áè≠Èó®ÂºÑÊñß', 'ÊùØÂºìËõáÂΩ±',
        
        // –£—Ä–æ–≤–µ–Ω—å 2 (—Å—Ä–µ–¥–Ω–∏–π)
        'Èó≠Èó®ÈÄ†ËΩ¶', '‰∏çËÄª‰∏ãÈóÆ', '‰∏çÊâì‰∏çÁõ∏ËØÜ', '‰∏çÂä≥ËÄåËé∑', '‰∏çÂÖ•ËôéÁ©¥ÁÑâÂæóËôéÂ≠ê',
        'Â§ßÂô®ÊôöÊàê', 'ÂΩìÂ±ÄËÄÖËø∑ÊóÅËßÇËÄÖÊ∏Ö', 'ÈÅìÈ´ò‰∏ÄÂ∞∫È≠îÈ´ò‰∏Ä‰∏à', 'ÂæóÂØ∏ËøõÂ∞∫',
        'Êª¥Ê∞¥Á©øÁü≥', 'Â§öÂ§öÁõäÂñÑ', 'ËÄ≥Êø°ÁõÆÊüì', 'ÂàÜÁßíÂøÖ‰∫â', 'Ëµ¥Ê±§ËπàÁÅ´',
        
        // –£—Ä–æ–≤–µ–Ω—å 3 (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)
        'È´òÊûïÊó†Âøß', 'ÂêÑÂæóÂÖ∂ÊâÄ', 'Âäü‰∫è‰∏ÄÁØë', 'Â≠§Ê≥®‰∏ÄÊé∑', 'È°æÂêçÊÄù‰πâ',
        'È°æÂÖ®Â§ßÂ±Ä', 'ÂÖâÊòéÊ≠£Â§ß', 'Êµ∑Â∫ïÊçûÈíà', 'Êµ∑ÈòîÂ§©Á©∫', 'ÈÇØÈÉ∏Â≠¶Ê≠•',
        'Â•Ω‰∫ãÂ§öÁ£®', 'Èπ§Á´ãÈ∏°Áæ§', 'ÂêéÊù•Â±Ö‰∏ä', 'ÁîªÈæôÁÇπÁùõ', 'ÁÑïÁÑ∂‰∏ÄÊñ∞',
        
        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
        'ÊÅçÁÑ∂Â§ßÊÇü', 'ÂõûÂ§¥ÊòØÂ≤∏', 'ÁÅ´‰∏äÊµáÊ≤π', 'Êú∫‰∏çÂèØÂ§±', 'ÈõÜÊÄùÂπøÁõä',
        'ÂÆ∂ÂñªÊà∑Êôì', 'ËßÅ‰πâÂãá‰∏∫', 'Â∞ÜËÆ°Â∞±ËÆ°', 'ËÑöË∏èÂÆûÂú∞', 'Êç∑Ë∂≥ÂÖàÁôª',
        'Á´≠Â∞ΩÂÖ®Âäõ', 'ÈáëÁéâËâØË®Ä', 'Ê¥•Ê¥•ÊúâÂë≥', 'ËøëÊ∞¥Ê•ºÂè∞ÂÖàÂæóÊúà', 'Á≤æÁõäÊ±ÇÁ≤æ',
        '‰πùÁâõ‰∏ÄÊØõ', '‰∏æ‰∏ñÈóªÂêç', 'ÂºÄÈó®ËßÅÂ±±', 'ÂºÄÂ§©ËæüÂú∞', 'ÂàªËàüÊ±ÇÂâë',
        'Âè£Ëã•ÊÇ¨Ê≤≥', 'Âø´È©¨Âä†Èû≠', 'Êª•Á´ΩÂÖÖÊï∞', 'Âä≥ÈÄ∏ÁªìÂêà', 'ËÄÅÈ©¨ËØÜÈÄî',
        '‰πêÊûÅÁîüÊÇ≤', 'Âäõ‰∏ç‰ªéÂøÉ', 'Á´ãÁ´øËßÅÂΩ±', '‰∏§ÂÖ®ÂÖ∂Áæé', 'Êü≥ÊöóËä±Êòé',
        'È©¨Âà∞ÊàêÂäü', '‰π∞Ê§üËøòÁè†', 'Êª°ËÖπÁªèÁ∫∂', 'ÊØõÈÅÇËá™Ëçê', 'Èó®Â∫≠Ëã•Â∏Ç',
        'ÂêçËêΩÂ≠ôÂ±±', 'ÂêçÂàóÂâçËåÖ', 'ÂêçÊ≠£Ë®ÄÈ°∫', 'ÊòéÁü•ÊïÖÁäØ', 'ÁõÆ‰∏çËØÜ‰∏Å',
        'ÁõÆ‰∏çËΩ¨Áùõ', 'ÂçóËæïÂåóËæô', 'ÈöæËÉΩÂèØË¥µ', 'ÂºÑÂ∑ßÊàêÊãô', 'ÊäõÁ†ñÂºïÁéâ',
        'Êä´ÊòüÊà¥Êúà', 'Âπ≥ÊòìËøë‰∫∫', 'Á†¥ÈáúÊ≤âËàü', '‰∏ÉÂò¥ÂÖ´Ëàå', 'Â•áË£ÖÂºÇÊúç',
        'ÊóóÂºÄÂæóËÉú', 'Êùû‰∫∫ÂøßÂ§©', 'ÂçÉÂèò‰∏áÂåñ', 'ÂçÉÊñπÁôæËÆ°', 'ÂçÉÈíß‰∏ÄÂèë',
        'ÂâçÂäüÂ∞ΩÂºÉ', 'Ââç‰ªÜÂêéÁªß', 'Êû™ÊûóÂºπÈõ®', 'Èî≤ËÄå‰∏çËàç', 'ÈùíÂá∫‰∫éËìù',
        'ÂÖ®Âäõ‰ª•Ëµ¥', 'ÂÖ®ÂøÉÂÖ®ÊÑè', '‰∫∫Â±±‰∫∫Êµ∑', 'Êó•ÁßØÊúàÁ¥Ø', 'Â¶ÇÈ±ºÂæóÊ∞¥',
        '‰∏âÊÄùËÄåË°å', 'ÊùÄÈ∏°ÂèñÂçµ', 'Â±±Á©∑Ê∞¥Â∞Ω', '‰∏äË°å‰∏ãÊïà', 'Ê∑±ÊÄùÁÜüËôë',
        'Á•ûÊú∫Â¶ôÁÆó', 'ÁîüÈæôÊ¥ªËôé', 'Â£∞‰∏úÂáªË•ø', '‰∫ãÂçäÂäüÂÄç', '‰∫ãÂÄçÂäüÂçä',
        'ÂÆàÂè£Â¶ÇÁì∂', 'ÁÜüËÉΩÁîüÂ∑ß', 'ÂèåÁÆ°ÈΩê‰∏ã', 'Ê∞¥Êª¥Áü≥Á©ø', 'Ê∞¥ËêΩÁü≥Âá∫',
        'È°∫Ê∞¥Êé®Ëàü', 'ÂõõÊµ∑‰∏∫ÂÆ∂', 'ÂõõÈù¢Ê•öÊ≠å', 'ÈöèÊ≥¢ÈÄêÊµÅ', 'ÈöèÂøÉÊâÄÊ¨≤',
        'Êçü‰∫∫Âà©Â∑±', 'Ë∞àËôéËâ≤Âèò', 'Ëû≥ËáÇÂΩìËΩ¶', 'Ëû≥ËûÇÊçïËùâÈªÑÈõÄÂú®Âêé', 'ÊªîÊªî‰∏çÁªù',
        'Â§©Ë°£Êó†Áºù', 'ÂêåÁîòÂÖ±Ëã¶', 'ÂêåÂøÉÂçèÂäõ', 'Â§¥Â§¥ÊòØÈÅì', 'ÊäïÊú∫ÂèñÂ∑ß',
        'ËÑ±È¢ñËÄåÂá∫', '‰∏áÁ¥´ÂçÉÁ∫¢', 'ÊúõÊ¢ÖÊ≠¢Ê∏¥', 'ÊúõÊ¥ãÂÖ¥Âèπ', 'Âç±Âú®Êó¶Â§ï',
        'ÂîØÂà©ÊòØÂõæ', 'Êú™Èõ®Áª∏Áº™', 'ÈóªÈ∏°Ëµ∑Ëàû', 'Êó†ÁöÑÊîæÁü¢', 'Êó†ÂèØÂ•à‰Ωï',
        'Êó†ÂæÆ‰∏çËá≥', '‰∫îÂÖâÂçÅËâ≤', '‰∫î‰ΩìÊäïÂú∞', 'ÂñúÂá∫ÊúõÂ§ñ', 'ÂÖàÂèëÂà∂‰∫∫',
        'Áõ∏ËæÖÁõ∏Êàê', 'Â∞èÈ¢òÂ§ßÂÅö', 'ÂøÉ‰∏çÂú®ÁÑâ', 'ÂøÉÊó∑Á•ûÊÄ°', 'ÂøÉÈ¢ÜÁ•û‰ºö',
        'ÂøÉÂπ≥Ê∞îÂíå', '‰ø°Âè£ÂºÄÊ≤≥', 'Ë°å‰∫ëÊµÅÊ∞¥', 'ÂÖ¥È´òÈááÁÉà', 'ËÉ∏ÊúâÊàêÁ´π',
        'Â≠¶‰ª•Ëá¥Áî®', 'Èõ™‰∏≠ÈÄÅÁÇ≠', 'Âæ™ËßÑËπàÁü©', 'Ë®Ä‰∏çÁî±Ë°∑', 'Êé©ËÄ≥ÁõóÈìÉ',
        'ÁúºÈ´òÊâã‰Ωé', 'Êâ¨ÁúâÂêêÊ∞î', '‰∏ÄË¥•Ê∂ÇÂú∞', '‰∏ÄÊú¨Ê≠£Áªè', '‰∏ÄÁ¨îÂãæÈîÄ',
        '‰∏ÄÈºì‰ΩúÊ∞î', '‰∏ÄÂ≠î‰πãËßÅ', '‰∏ÄËßàÊó†‰Ωô', '‰∏ÄËêΩÂçÉ‰∏à', '‰∏ÄÊØõ‰∏çÊãî',
        '‰∏ÄÈ∏£ÊÉä‰∫∫', '‰∏ÄÁõÆ‰∫ÜÁÑ∂', '‰∏ÄËØ∫ÂçÉÈáë', '‰∏ÄÊãçÂç≥Âêà', '‰∏ÄÊõùÂçÅÂØí',
        '‰∏ÄÊ∞îÂëµÊàê', '‰∏ÄÁ™ç‰∏çÈÄö', '‰∏ÄÊó•ÂçÉÈáå', '‰∏Ä‰∏ù‰∏çËãü', '‰∏ÄÂæÄÊó†Ââç',
        '‰∏ÄÊúõÊó†ÈôÖ', '‰∏ÄÊó†ÊòØÂ§Ñ', '‰∏ÄÂé¢ÊÉÖÊÑø', '‰∏ÄÊÑèÂ≠§Ë°å', '‰∏ÄÂ≠óÂçÉÈáë',
        '‰æù‰æù‰∏çËàç', '‰ª•ÊØíÊîªÊØí', '‰ª•ÂçµÂáªÁü≥', '‰ª•Ë∫´‰ΩúÂàô', 'ÂºÇÂè£ÂêåÂ£∞',
        'Âõ†Â∞èÂ§±Â§ß', 'ÂºïÁãºÂÖ•ÂÆ§', 'È•ÆÊ∞¥ÊÄùÊ∫ê', 'ËøéÂàÉËÄåËß£', 'Â∫îÊúâÂ∞ΩÊúâ',
        'ÂãáÂæÄÁõ¥Ââç', 'ÊúâÂ§áÊó†ÊÇ£', 'ÊúâÁöÑÊîæÁü¢', 'ÊúâÂè£ÁöÜÁ¢ë', 'ÊúâÁõÆÂÖ±Áùπ',
        'ÊúâÂßãÊúâÁªà', 'ÊúâÊÅÉÊó†ÊÅê', 'ÊúâÊù°‰∏çÁ¥ä', 'ÊúâÂãáÊó†Ë∞ã', 'ÊÑöÂÖ¨ÁßªÂ±±',
        'È±ºÁõÆÊ∑∑Áè†', '‰∏éËôéË∞ãÁöÆ', 'Ê¨≤ÈÄüÂàô‰∏çËææ', 'ÁºòÊú®Ê±ÇÈ±º', 'Ê∫êÊ∫ê‰∏çÊñ≠',
        'Êúà‰∏ãËÄÅ‰∫∫', 'ËøêÁ≠πÂ∏∑ÂπÑ', 'ÂÜçÊé•ÂÜçÂéâ', 'Ë¥£Êó†ÊóÅË¥∑', 'Êñ©ËçâÈô§Ê†π',
        'ÊàòÊó†‰∏çËÉú', 'Êéå‰∏äÊòéÁè†', '‰ªóÂäøÊ¨∫‰∫∫', 'Êúù‰∏âÊöÆÂõõ', 'ÁÖßÁå´ÁîªËôé',
        'ÈíàÈîãÁõ∏ÂØπ', 'ÁúüÊâçÂÆûÂ≠¶', 'ÁúüÁü•ÁÅºËßÅ', 'Ëí∏Ëí∏Êó•‰∏ä', 'Áü•Â∑±Áü•ÂΩº',
        'Áü•ÈöæËÄåÈÄÄ', 'Áü•Êó†‰∏çË®Ä', 'ÊâßÊ≥ïÂ¶ÇÂ±±', 'ÊåáÈπø‰∏∫È©¨', 'ÊåáÊ°ëÈ™ÇÊßê',
        'ÊåáÊâãÁîªËÑö', 'Á∫∏‰∏äË∞àÂÖµ', 'ÂøóÂêåÈÅìÂêà', 'ÁΩÆ‰πãÂ∫¶Â§ñ', 'Âø†Ë®ÄÈÄÜËÄ≥',
        '‰ºóÂè£ÈöæË∞É', '‰ºóÂøóÊàêÂüé', 'Áè†ÂÖâÂÆùÊ∞î', 'Âä©‰∫∫‰∏∫‰πê', '‰∏ìÂøÉËá¥Âøó',
        'ËøΩÊú¨Ê∫ØÊ∫ê', 'ÊÉ¥ÊÉ¥‰∏çÂÆâ', 'Â≠úÂ≠ú‰∏çÂÄ¶', 'Ëá™ÂëäÂ•ãÂãá', 'Ëá™Áõ∏ÁüõÁõæ',
        'Â≠óÊñüÂè•ÈÖå', 'ÊÄªËÄåË®Ä‰πã', 'Ëµ∞È©¨ËßÇËä±', 'Âùê‰∫ïËßÇÂ§©', 'Âùê‰∫´ÂÖ∂Êàê',
        'Â∫ßÊó†ËôöÂ∏≠'
    ];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –±–∞–∑–µ
    if (realChengyu.includes(character)) {
        return true;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö
    // –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
    const simplePatterns = [
        /[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ‰∏á‰∫ø]{2,}/,  // –ß–∏—Å–ª–∞
        /(.)\1{2,}/,  // –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
        /^[ÁöÑÂæàÊòØÊúâÂú®Âíå‰∫ÜÈÉΩÂ∞±‰πü]+$/,  // –¢–æ–ª—å–∫–æ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞
        /[ÂêóÂë¢ÂêßÂïäÂëÄÂìáÂì¶ËØ∂Âîâ]/  // –ú–æ–¥–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã
    ];
    
    for (const pattern of simplePatterns) {
        if (pattern.test(character)) {
            return false;
        }
    }
    
    // –î–ª—è –Ω–æ–≤—ã—Ö —á—ç–Ω—ä—é–µ–≤ - —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å
    const chars = character.split('');
    const uniqueChars = new Set(chars);
    
    // –•–æ—Ç—è –±—ã 3 —Ä–∞–∑–Ω—ã—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞
    return uniqueChars.size >= 3;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –≤–µ—Ä–æ—è—Ç–Ω–æ —á—ç–Ω—ä—é–π
function isLikelyChengyu(character) {
    // –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
    const simplePatterns = [
        /[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]{4}/,  // –ß–∏—Å–ª–∞
        /(.)\1{3}/,  // –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–∏–º–≤–æ–ª 4 —Ä–∞–∑–∞
        /^(ÁöÑ|‰∫Ü|ÊòØ|Âú®|Êúâ|Âíå).{3}$/,  // –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–ª–æ–≤
        /(Ë∞¢Ë∞¢|‰Ω†Â•Ω|ÂÜçËßÅ|ÂØπ‰∏çËµ∑)/,  // –û–±—ã—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    ];
    
    // –ï—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    for (const pattern of simplePatterns) {
        if (pattern.test(character)) {
            return false;
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –±–∞–∑–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á—ç–Ω—ä—é–µ–≤
    const commonChengyu = [
        'ÁîªËõáÊ∑ªË∂≥', 'ÂÆàÊ†™ÂæÖÂÖî', '‰∫ïÂ∫ï‰πãËõô', '‰∫°ÁæäË°•Áâ¢', 'ÁãêÂÅáËôéÂ®Å',
        'ÂØπÁâõÂºπÁê¥', 'ÂçßËôéËóèÈæô', '‰∏ÄÁÆ≠ÂèåÈõï', 'Áè≠Èó®ÂºÑÊñß', 'ÊùØÂºìËõáÂΩ±',
        'Èó≠Èó®ÈÄ†ËΩ¶', '‰∏çËÄª‰∏ãÈóÆ', '‰∏çÊâì‰∏çÁõ∏ËØÜ', '‰∏çÂä≥ËÄåËé∑', '‰∏çÂÖ•ËôéÁ©¥ÁÑâÂæóËôéÂ≠ê',
        'ÈïøÊ±üÂêéÊµ™Êé®ÂâçÊµ™', 'ËΩ¶Âà∞Â±±ÂâçÂøÖÊúâË∑Ø', 'ÂêÉ‰∏ÄÂ†ëÈïø‰∏ÄÊô∫', 'Âá∫Ê∑§Ê≥•ËÄå‰∏çÊüì',
        'Â§ßÂô®ÊôöÊàê', 'ÂΩìÂ±ÄËÄÖËø∑ÊóÅËßÇËÄÖÊ∏Ö', 'ÈÅìÈ´ò‰∏ÄÂ∞∫È≠îÈ´ò‰∏Ä‰∏à', 'ÂæóÂØ∏ËøõÂ∞∫',
        'Êª¥Ê∞¥Á©øÁü≥', 'ÂØπÁâõÂºπÁê¥', 'Â§öÂ§öÁõäÂñÑ', 'ËÄ≥Êø°ÁõÆÊüì', 'ÂàÜÁßíÂøÖ‰∫â',
        'Ëµ¥Ê±§ËπàÁÅ´', 'È´òÊûïÊó†Âøß', 'ÂêÑÂæóÂÖ∂ÊâÄ', 'Âäü‰∫è‰∏ÄÁØë', 'Â≠§Ê≥®‰∏ÄÊé∑',
        'È°æÂêçÊÄù‰πâ', 'È°æÂÖ®Â§ßÂ±Ä', 'ÂÖâÊòéÊ≠£Â§ß', 'Êµ∑Â∫ïÊçûÈíà', 'Êµ∑ÈòîÂ§©Á©∫',
        'ÈÇØÈÉ∏Â≠¶Ê≠•', 'Â•Ω‰∫ãÂ§öÁ£®', 'Èπ§Á´ãÈ∏°Áæ§', 'ÂêéÊù•Â±Ö‰∏ä', 'ÁîªÈæôÁÇπÁùõ',
        'ÁîªËõáÊ∑ªË∂≥', 'ÁÑïÁÑ∂‰∏ÄÊñ∞', 'ÊÅçÁÑ∂Â§ßÊÇü', 'ÂõûÂ§¥ÊòØÂ≤∏', 'ÁÅ´‰∏äÊµáÊ≤π',
        'Êú∫‰∏çÂèØÂ§±', 'ÈõÜÊÄùÂπøÁõä', 'ÂÆ∂ÂñªÊà∑Êôì', 'ËßÅ‰πâÂãá‰∏∫', 'Â∞ÜËÆ°Â∞±ËÆ°',
        'ËÑöË∏èÂÆûÂú∞', 'Êç∑Ë∂≥ÂÖàÁôª', 'Á´≠Â∞ΩÂÖ®Âäõ', 'ÈáëÁéâËâØË®Ä', 'Ê¥•Ê¥•ÊúâÂë≥',
        'ËøëÊ∞¥Ê•ºÂè∞ÂÖàÂæóÊúà', 'Á≤æÁõäÊ±ÇÁ≤æ', '‰πùÁâõ‰∏ÄÊØõ', '‰∏æ‰∏ñÈóªÂêç', 'ÂºÄÈó®ËßÅÂ±±',
        'ÂºÄÂ§©ËæüÂú∞', 'ÂàªËàüÊ±ÇÂâë', 'Âè£Ëã•ÊÇ¨Ê≤≥', 'Âø´È©¨Âä†Èû≠', 'Êª•Á´ΩÂÖÖÊï∞',
        'Âä≥ÈÄ∏ÁªìÂêà', 'ËÄÅÈ©¨ËØÜÈÄî', '‰πêÊûÅÁîüÊÇ≤', 'Âäõ‰∏ç‰ªéÂøÉ', 'Á´ãÁ´øËßÅÂΩ±',
        '‰∏§ÂÖ®ÂÖ∂Áæé', 'Êü≥ÊöóËä±Êòé', 'È©¨Âà∞ÊàêÂäü', '‰π∞Ê§üËøòÁè†', 'Êª°ËÖπÁªèÁ∫∂',
        'ÊØõÈÅÇËá™Ëçê', 'Èó®Â∫≠Ëã•Â∏Ç', 'ÂêçËêΩÂ≠ôÂ±±', 'ÂêçÂàóÂâçËåÖ', 'ÂêçÊ≠£Ë®ÄÈ°∫',
        'ÊòéÁü•ÊïÖÁäØ', 'ÁõÆ‰∏çËØÜ‰∏Å', 'ÁõÆ‰∏çËΩ¨Áùõ', 'ÂçóËæïÂåóËæô', 'ÈöæËÉΩÂèØË¥µ',
        'ÂºÑÂ∑ßÊàêÊãô', 'ÊäõÁ†ñÂºïÁéâ', 'Êä´ÊòüÊà¥Êúà', 'Âπ≥ÊòìËøë‰∫∫', 'Á†¥ÈáúÊ≤âËàü',
        '‰∏ÉÂò¥ÂÖ´Ëàå', 'Â•áË£ÖÂºÇÊúç', 'ÊóóÂºÄÂæóËÉú', 'Êùû‰∫∫ÂøßÂ§©', 'ÂçÉÂèò‰∏áÂåñ',
        'ÂçÉÊñπÁôæËÆ°', 'ÂçÉÈíß‰∏ÄÂèë', 'ÂâçÂäüÂ∞ΩÂºÉ', 'Ââç‰ªÜÂêéÁªß', 'Êû™ÊûóÂºπÈõ®',
        'Èî≤ËÄå‰∏çËàç', 'ÈùíÂá∫‰∫éËìù', 'ÂÖ®Âäõ‰ª•Ëµ¥', 'ÂÖ®ÂøÉÂÖ®ÊÑè', '‰∫∫Â±±‰∫∫Êµ∑',
        'Êó•ÁßØÊúàÁ¥Ø', 'Â¶ÇÈ±ºÂæóÊ∞¥', '‰∏âÊÄùËÄåË°å', 'ÊùÄÈ∏°ÂèñÂçµ', 'Â±±Á©∑Ê∞¥Â∞Ω',
        '‰∏äË°å‰∏ãÊïà', 'Ê∑±ÊÄùÁÜüËôë', 'Á•ûÊú∫Â¶ôÁÆó', 'ÁîüÈæôÊ¥ªËôé', 'Â£∞‰∏úÂáªË•ø',
        '‰∫ãÂçäÂäüÂÄç', '‰∫ãÂÄçÂäüÂçä', 'ÂÆàÂè£Â¶ÇÁì∂', 'ÂÆàÊ†™ÂæÖÂÖî', 'ÁÜüËÉΩÁîüÂ∑ß',
        'ÂèåÁÆ°ÈΩê‰∏ã', 'Ê∞¥Êª¥Áü≥Á©ø', 'Ê∞¥ËêΩÁü≥Âá∫', 'È°∫Ê∞¥Êé®Ëàü', 'ÂõõÊµ∑‰∏∫ÂÆ∂',
        'ÂõõÈù¢Ê•öÊ≠å', 'ÈöèÊ≥¢ÈÄêÊµÅ', 'ÈöèÂøÉÊâÄÊ¨≤', 'Êçü‰∫∫Âà©Â∑±', 'Ë∞àËôéËâ≤Âèò',
        'Ëû≥ËáÇÂΩìËΩ¶', 'Ëû≥ËûÇÊçïËùâÈªÑÈõÄÂú®Âêé', 'ÊªîÊªî‰∏çÁªù', 'Â§©Ë°£Êó†Áºù',
        'ÂêåÁîòÂÖ±Ëã¶', 'ÂêåÂøÉÂçèÂäõ', 'Â§¥Â§¥ÊòØÈÅì', 'ÊäïÊú∫ÂèñÂ∑ß', 'ËÑ±È¢ñËÄåÂá∫',
        '‰∏áÁ¥´ÂçÉÁ∫¢', '‰∫°ÁæäË°•Áâ¢', 'ÊúõÊ¢ÖÊ≠¢Ê∏¥', 'ÊúõÊ¥ãÂÖ¥Âèπ', 'Âç±Âú®Êó¶Â§ï',
        'ÂîØÂà©ÊòØÂõæ', 'Êú™Èõ®Áª∏Áº™', 'ÈóªÈ∏°Ëµ∑Ëàû', 'Êó†ÁöÑÊîæÁü¢', 'Êó†ÂèØÂ•à‰Ωï',
        'Êó†ÂæÆ‰∏çËá≥', '‰∫îÂÖâÂçÅËâ≤', '‰∫î‰ΩìÊäïÂú∞', 'ÂñúÂá∫ÊúõÂ§ñ', 'ÂÖàÂèëÂà∂‰∫∫',
        'Áõ∏ËæÖÁõ∏Êàê', 'Â∞èÈ¢òÂ§ßÂÅö', 'ÂøÉ‰∏çÂú®ÁÑâ', 'ÂøÉÊó∑Á•ûÊÄ°', 'ÂøÉÈ¢ÜÁ•û‰ºö',
        'ÂøÉÂπ≥Ê∞îÂíå', '‰ø°Âè£ÂºÄÊ≤≥', 'Ë°å‰∫ëÊµÅÊ∞¥', 'ÂÖ¥È´òÈááÁÉà', 'ËÉ∏ÊúâÊàêÁ´π',
        'Â≠¶‰ª•Ëá¥Áî®', 'Èõ™‰∏≠ÈÄÅÁÇ≠', 'Âæ™ËßÑËπàÁü©', 'Ë®Ä‰∏çÁî±Ë°∑', 'Êé©ËÄ≥ÁõóÈìÉ',
        'ÁúºÈ´òÊâã‰Ωé', 'Êâ¨ÁúâÂêêÊ∞î', '‰∏ÄË¥•Ê∂ÇÂú∞', '‰∏ÄÊú¨Ê≠£Áªè', '‰∏ÄÁ¨îÂãæÈîÄ',
        '‰∏ÄÈºì‰ΩúÊ∞î', '‰∏ÄÁÆ≠ÂèåÈõï', '‰∏ÄÂ≠î‰πãËßÅ', '‰∏ÄËßàÊó†‰Ωô', '‰∏ÄËêΩÂçÉ‰∏à',
        '‰∏ÄÊØõ‰∏çÊãî', '‰∏ÄÈ∏£ÊÉä‰∫∫', '‰∏ÄÁõÆ‰∫ÜÁÑ∂', '‰∏ÄËØ∫ÂçÉÈáë', '‰∏ÄÊãçÂç≥Âêà',
        '‰∏ÄÊõùÂçÅÂØí', '‰∏ÄÊ∞îÂëµÊàê', '‰∏ÄÁ™ç‰∏çÈÄö', '‰∏ÄÊó•ÂçÉÈáå', '‰∏Ä‰∏ù‰∏çËãü',
        '‰∏ÄÂæÄÊó†Ââç', '‰∏ÄÊúõÊó†ÈôÖ', '‰∏ÄÊó†ÊòØÂ§Ñ', '‰∏ÄÂé¢ÊÉÖÊÑø', '‰∏ÄÊÑèÂ≠§Ë°å',
        '‰∏ÄÂ≠óÂçÉÈáë', '‰æù‰æù‰∏çËàç', '‰ª•ÊØíÊîªÊØí', '‰ª•ÂçµÂáªÁü≥', '‰ª•Ë∫´‰ΩúÂàô',
        'ÂºÇÂè£ÂêåÂ£∞', 'Âõ†Â∞èÂ§±Â§ß', 'ÂºïÁãºÂÖ•ÂÆ§', 'È•ÆÊ∞¥ÊÄùÊ∫ê', 'ËøéÂàÉËÄåËß£',
        'Â∫îÊúâÂ∞ΩÊúâ', 'ÂãáÂæÄÁõ¥Ââç', 'ÊúâÂ§áÊó†ÊÇ£', 'ÊúâÁöÑÊîæÁü¢', 'ÊúâÂè£ÁöÜÁ¢ë',
        'ÊúâÁõÆÂÖ±Áùπ', 'ÊúâÂßãÊúâÁªà', 'ÊúâÊÅÉÊó†ÊÅê', 'ÊúâÊù°‰∏çÁ¥ä', 'ÊúâÂãáÊó†Ë∞ã',
        'ÊÑöÂÖ¨ÁßªÂ±±', 'È±ºÁõÆÊ∑∑Áè†', '‰∏éËôéË∞ãÁöÆ', 'Ê¨≤ÈÄüÂàô‰∏çËææ', 'ÁºòÊú®Ê±ÇÈ±º',
        'Ê∫êÊ∫ê‰∏çÊñ≠', 'Êúà‰∏ãËÄÅ‰∫∫', 'ËøêÁ≠πÂ∏∑ÂπÑ', 'ÂÜçÊé•ÂÜçÂéâ', 'Ë¥£Êó†ÊóÅË¥∑',
        'Êñ©ËçâÈô§Ê†π', 'ÊàòÊó†‰∏çËÉú', 'Êéå‰∏äÊòéÁè†', '‰ªóÂäøÊ¨∫‰∫∫', 'Êúù‰∏âÊöÆÂõõ',
        'ÁÖßÁå´ÁîªËôé', 'ÈíàÈîãÁõ∏ÂØπ', 'ÁúüÊâçÂÆûÂ≠¶', 'ÁúüÁü•ÁÅºËßÅ', 'Ëí∏Ëí∏Êó•‰∏ä',
        'Áü•Â∑±Áü•ÂΩº', 'Áü•ÈöæËÄåÈÄÄ', 'Áü•Êó†‰∏çË®Ä', 'ÊâßÊ≥ïÂ¶ÇÂ±±', 'ÊåáÈπø‰∏∫È©¨',
        'ÊåáÊ°ëÈ™ÇÊßê', 'ÊåáÊâãÁîªËÑö', 'Á∫∏‰∏äË∞àÂÖµ', 'ÂøóÂêåÈÅìÂêà', 'ÁΩÆ‰πãÂ∫¶Â§ñ',
        'Âø†Ë®ÄÈÄÜËÄ≥', '‰ºóÂè£ÈöæË∞É', '‰ºóÂøóÊàêÂüé', 'Áè†ÂÖâÂÆùÊ∞î', 'Âä©‰∫∫‰∏∫‰πê',
        '‰∏ìÂøÉËá¥Âøó', 'ËøΩÊú¨Ê∫ØÊ∫ê', 'ÊÉ¥ÊÉ¥‰∏çÂÆâ', 'Â≠úÂ≠ú‰∏çÂÄ¶', 'Ëá™ÂëäÂ•ãÂãá',
        'Ëá™Áõ∏ÁüõÁõæ', 'Â≠óÊñüÂè•ÈÖå', 'ÊÄªËÄåË®Ä‰πã', 'Ëµ∞È©¨ËßÇËä±', 'Âùê‰∫ïËßÇÂ§©',
        'Âùê‰∫´ÂÖ∂Êàê', 'Â∫ßÊó†ËôöÂ∏≠'
    ];
    
    // –ï—Å–ª–∏ —ç—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–π —á—ç–Ω—ä—é–π - —Ç–æ—á–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º
    if (commonChengyu.includes(character)) {
        return true;
    }
    
    // –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å
    const uniqueChars = new Set(character.split(''));
    return uniqueChars.size >= 3;  // –ú–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–Ω—ã—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á—ç–Ω—ä—é—è
function addChengyu(character) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ
    if (learnedChengyu.some(c => c.character === character)) {
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á—ç–Ω—ä—é–µ
    getChengyuInfo(character).then(info => {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á—ç–Ω—ä—é–π
        const newChengyu = {
            character: character,
            pinyin: info.pinyin || estimatePinyin(character),
            meaning: info.meaning || '',
            example: info.example || '',
            translation: info.translation || '',
            story: info.story || '',
            learned_at: new Date().toISOString(),
            reviewed_count: 0,
            confidence: info.confidence || 0.5
        };
        
        learnedChengyu.unshift(newChengyu);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        saveLearnedChengyu();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateChengyuList();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showChengyuNotification(character, newChengyu.pinyin);
        
    }).catch(error => {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á—ç–Ω—ä—é–µ:', character);
        // –î–æ–±–∞–≤–ª—è–µ–º —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        const newChengyu = {
            character: character,
            pinyin: estimatePinyin(character),
            meaning: '',
            example: '',
            translation: '',
            story: '',
            learned_at: new Date().toISOString(),
            reviewed_count: 0,
            confidence: 0.3
        };
        
        learnedChengyu.unshift(newChengyu);
        saveLearnedChengyu();
        updateChengyuList();
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á—ç–Ω—ä—é–µ
async function getChengyuInfo(character) {
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º AI –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        const response = await fetch(`${API_BASE}/ai/translate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: character,
                user_id: currentUser?.user_id || null,
                detailed: true
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            return {
                pinyin: data.pinyin || '',
                meaning: data.translation || '',
                example: data.example_sentences?.[0]?.chinese || '',
                translation: data.example_sentences?.[0]?.translation || '',
                confidence: 0.9
            };
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á—ç–Ω—ä—é–µ:', error);
    }
    
    // Fallback - –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–≤–æ–¥
    return {
        pinyin: '',
        meaning: '',
        example: '',
        confidence: 0.3
    };
}

// –ü—Ä–æ—Å—Ç–æ–π –ø–∏–Ω—å–∏–Ω—å (–∑–∞–≥–ª—É—à–∫–∞)
function estimatePinyin(character) {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã API
    // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–º–≤–æ–ª—å–Ω—ã–π –ø–∏–Ω—å–∏–Ω—å
    const charToPinyin = {
        'Áîª': 'hu√†', 'Ëõá': 'sh√©', 'Ê∑ª': 'tiƒÅn', 'Ë∂≥': 'z√∫',
        'ÂÆà': 'sh«íu', 'Ê†™': 'zh≈´', 'ÂæÖ': 'd√†i', 'ÂÖî': 't√π',
        // –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    };
    
    return character.split('').map(char => 
        charToPinyin[char] || '?'
    ).join(' ');
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —á—ç–Ω—ä—é–µ
function showChengyuNotification(character, pinyin) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.5s ease;
        max-width: 300px;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">üéâ –ù–æ–≤—ã–π —á—ç–Ω—ä—é–π!</div>
        <div style="font-size: 2em; margin: 10px 0;">${character}</div>
        <div style="color: #ffd700; margin-bottom: 10px;">${pinyin || ''}</div>
        <div style="font-size: 0.9em;">–î–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é</div>
    `;
    
    document.body.appendChild(notification);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏–Ω—å–∏–Ω—è (–∑–∞–≥–ª—É—à–∫–∞)
function getPinyin(character) {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏–Ω—å–∏–Ω—è
    // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    return character.split('').map(() => 'pinyin').join(' ');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑—É—á–µ–Ω–Ω—ã—Ö —á—ç–Ω—ä—é–µ–≤
function loadLearnedChengyu() {
    try {
        const saved = localStorage.getItem('hsk_learned_chengyu');
        if (saved) {
            learnedChengyu = JSON.parse(saved);
            updateChengyuList();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á—ç–Ω—ä—é–µ–≤:', error);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑—É—á–µ–Ω–Ω—ã—Ö —á—ç–Ω—ä—é–µ–≤
function saveLearnedChengyu() {
    try {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        if (learnedChengyu.length > 100) {
            learnedChengyu = learnedChengyu.slice(0, 100);
        }
        localStorage.setItem('hsk_learned_chengyu', JSON.stringify(learnedChengyu));
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á—ç–Ω—ä—é–µ–≤:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á—ç–Ω—ä—é–µ–≤
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á—ç–Ω—ä—é–µ–≤
function updateChengyuList() {
    const container = document.getElementById('chengyuList');
    const countElement = document.getElementById('chengyuCount');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —á—ç–Ω—ä—é–∏ (–æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ–º –º—É—Å–æ—Ä)
    const realChengyu = learnedChengyu.filter(c => isRealChengyu(c.character));
    
    countElement.textContent = realChengyu.length;
    
    if (realChengyu.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--gray); padding: 20px;">
                <div style="font-size: 3em;">üìö</div>
                <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∏–∑—É—á–µ–Ω–Ω—ã–µ —á—ç–Ω—ä—é–∏</p>
                <p style="font-size: 0.9em;">–°–∫–∞–∂–∏—Ç–µ: "–†–∞—Å—Å–∫–∞–∂–∏ —á—ç–Ω—ä—é–π"</p>
            </div>
        `;
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–≤–µ—Ä—Ö—É)
    const recentChengyu = [...realChengyu].reverse();
    
    container.innerHTML = recentChengyu.map((chengyu, index) => `
        <div class="chengyu-item" 
             onclick="showChengyuDetails('${chengyu.character}')"
             style="padding: 12px; 
                    margin-bottom: 8px; 
                    border-radius: 8px; 
                    background: #f8f9fa;
                    border-left: 4px solid ${getChengyuColor(chengyu.confidence || 0.5)};
                    cursor: pointer;
                    transition: all 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 1.5em; font-weight: bold;">${chengyu.character}</div>
                <div style="font-size: 0.8em; color: var(--gray);">
                    ${formatDate(chengyu.learned_at)}
                </div>
            </div>
            ${chengyu.pinyin && chengyu.pinyin !== 'pinyin pinyin pinyin pinyin' ? 
                `<div style="color: var(--danger); font-size: 0.9em; margin: 5px 0;">${chengyu.pinyin}</div>` : ''}
            ${chengyu.meaning ? 
                `<div style="font-size: 0.9em; color: var(--dark);">${chengyu.meaning.substring(0, 60)}${chengyu.meaning.length > 60 ? '...' : ''}</div>` : 
                `<div style="font-size: 0.8em; color: var(--gray);">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</div>`}
            ${chengyu.reviewed_count > 0 ? 
                `<div style="font-size: 0.7em; color: var(--gray); margin-top: 5px;">
                    –ü–æ–≤—Ç–æ—Ä–µ–Ω: ${chengyu.reviewed_count} —Ä–∞–∑
                </div>` : ''}
        </div>
    `).join('');
}

// –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
function getChengyuColor(confidence) {
    if (confidence > 0.8) return 'var(--success)';    // –∑–µ–ª–µ–Ω—ã–π - —Ç–æ—á–Ω–æ —á—ç–Ω—ä—é–π
    if (confidence > 0.5) return 'var(--warning)';    // –∂–µ–ª—Ç—ã–π - –≤–µ—Ä–æ—è—Ç–Ω–æ —á—ç–Ω—ä—é–π
    return 'var(--danger)';                           // –∫—Ä–∞—Å–Ω—ã–π - –º–∞–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
}

// –ü–æ–∏—Å–∫ —á—ç–Ω—ä—é–µ–≤
function searchChengyu() {
    const searchTerm = document.getElementById('chengyuSearch').value.toLowerCase();
    const items = document.querySelectorAll('.chengyu-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
}

// –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
function speakText(text, forceLang = null) {
    if (!isSpeechSynthesisSupported || !document.getElementById('autoPlayAudio').checked) {
        return;
    }
    
    // –î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞ - –í–°–ï–ì–î–ê –∫–∏—Ç–∞–π—Å–∫–∏–π
    const lang = 'zh-CN';
    
    // –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ —Ç–µ–∫—É—â–∏–µ
    window.speechSynthesis.cancel();
    
    setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = parseFloat(document.getElementById('voiceSpeed').value);
        utterance.volume = 1;
        utterance.pitch = 1;
        
        // –ò—â–µ–º –∫–∏—Ç–∞–π—Å–∫–∏–π –≥–æ–ª–æ—Å
        const voices = speechSynthesis.getVoices();
        let chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh-CN') || 
            voice.lang.startsWith('zh') ||
            voice.name.toLowerCase().includes('chinese')
        );
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        utterance.onstart = () => {
            console.log('üéµ ÂºÄÂßãÂèëÈü≥...');
        };
        
        utterance.onend = () => {
            console.log('üéµ ÂèëÈü≥ÁªìÊùü');
        };
        
        utterance.onerror = (event) => {
            console.error('ÂèëÈü≥ÈîôËØØ:', event);
        };
        
        speechSynthesis.speak(utterance);
        
    }, 100);
}

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
function extractChineseTextForSpeech(text) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∏—Ç–∞–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç (—É–±–∏—Ä–∞–µ–º —Ä—É—Å—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã –≤ —Å–∫–æ–±–∫–∞—Ö)
    const chineseOnly = text.replace(/„Äê[^„Äë]*„Äë/g, '') // –£–±–∏—Ä–∞–µ–º —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
                           .replace(/\([^)]*\)/g, '')  // –£–±–∏—Ä–∞–µ–º –ø–∏–Ω—å–∏–Ω—å
                           .replace(/[\u0400-\u04FF]/g, ''); // –£–±–∏—Ä–∞–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É
    
    return chineseOnly.trim() || text; // –ï—Å–ª–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ, –æ–∑–≤—É—á–∏–≤–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'ÂàöÂàö';
    if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
    if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
    if (diffDays < 7) return `${diffDays}Â§©Ââç`;
    
    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
}

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á—ç–Ω—ä—é–µ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
function extractChengyuFromMessage(text) {
    const patterns = [
        /ÊàêËØ≠[:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        /[„Ää„Äå„Äé]([\u4e00-\u9fff]{4})[„Äç„Äè„Äã]/g,
        /[\u4e00-\u9fff]{4}[:Ôºö]\s*([\u4e00-\u9fff]{4})/g
    ];
    
    let found = [];
    patterns.forEach(pattern => {
        const matches = text.matchAll(pattern);
        for (const match of matches) {
            if (match[1] && isRealChengyu(match[1])) {
                found.push(match[1]);
            }
        }
    });
    
    return [...new Set(found)];
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≥–æ–ª–æ—Å–∞
function updateVoiceSpeed() {
    const speed = document.getElementById('voiceSpeed').value;
    document.getElementById('speedValue').textContent = `${speed}x`;
}

// –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
function sendQuickVoiceCommand(command) {
    processVoiceCommand(command);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞ –ø–æ —á—ç–Ω—ä—é—è–º
function generateChengyuQuiz() {
    if (learnedChengyu.length < 3) {
        addVoiceMessage('AI', '–°–Ω–∞—á–∞–ª–∞ –∏–∑—É—á–∏—Ç–µ —Ö–æ—Ç—è –±—ã 3 —á—ç–Ω—ä—é—è!', 'warning');
        return;
    }
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —á—ç–Ω—ä—é–∏
    const quizChengyu = [...learnedChengyu]
        .sort(() => Math.random() - 0.5)
        .slice(0, 5);
    
    let quizText = "üìù –¢–µ—Å—Ç –ø–æ —á—ç–Ω—ä—é—è–º:\n\n";
    
    quizChengyu.forEach((chengyu, index) => {
        quizText += `${index + 1}. ${chengyu.character} (${chengyu.pinyin || '???'})\n`;
        quizText += `   –∞) –ó–Ω–∞—á–µ–Ω–∏–µ 1\n`;
        quizText += `   –±) –ó–Ω–∞—á–µ–Ω–∏–µ 2\n`;
        quizText += `   –≤) –ó–Ω–∞—á–µ–Ω–∏–µ 3\n`;
        quizText += `   –≥) –ó–Ω–∞—á–µ–Ω–∏–µ 4\n\n`;
    });
    
    quizText += "–û—Ç–≤–µ—Ç—å—Ç–µ –≥–æ–ª–æ—Å–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ü–µ—Ä–≤—ã–π - –ê, –≤—Ç–æ—Ä–æ–π - –ë'";
    
    addVoiceMessage('AI', quizText, 'info');
    
    if (document.getElementById('autoPlayAudio').checked) {
        speakText("–í–æ—Ç —Ç–µ—Å—Ç –ø–æ —á—ç–Ω—ä—é—è–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.");
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —á—ç–Ω—ä—é—è
// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —á—ç–Ω—ä—é—è
function showChengyuDetails(character) {
    const chengyu = learnedChengyu.find(c => c.character === character);
    if (!chengyu) return;
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; 
                    padding: 30px; 
                    border-radius: 15px; 
                    width: 100%;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin: 0;">${character}</h2>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                ${chengyu.pinyin && chengyu.pinyin !== 'pinyin pinyin pinyin pinyin' ? 
                    `<div style="color: var(--danger); font-size: 1.2em; margin-bottom: 10px;">
                        <strong>–ü–∏–Ω—å–∏–Ω—å:</strong> ${chengyu.pinyin}
                    </div>` : ''}
                
                ${chengyu.meaning ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>–ó–Ω–∞—á–µ–Ω–∏–µ:</strong> ${chengyu.meaning}
                    </div>` : ''}
                
                ${chengyu.translation ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>–ü–µ—Ä–µ–≤–æ–¥:</strong> ${chengyu.translation}
                    </div>` : ''}
                
                ${chengyu.example ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>–ü—Ä–∏–º–µ—Ä:</strong> ${chengyu.example}
                    </div>` : ''}
                
                ${chengyu.story ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>–ò—Å—Ç–æ—Ä–∏—è:</strong> ${chengyu.story}
                    </div>` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="speakText('${character}', 'zh-CN')">
                    <i class="fas fa-volume-up"></i> –ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏
                </button>
                <button class="btn btn-success" onclick="processVoiceCommand('–û–±—ä—è—Å–Ω–∏ —á—ç–Ω—ä—é–π ${character}')">
                    <i class="fas fa-graduation-cap"></i> –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
                </button>
                <button class="btn btn-danger" onclick="removeChengyu('${character}'); this.parentElement.parentElement.parentElement.remove()">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// –£–¥–∞–ª–µ–Ω–∏–µ —á—ç–Ω—ä—é—è
function removeChengyu(character) {
    learnedChengyu = learnedChengyu.filter(c => c.character !== character);
    saveLearnedChengyu();
    updateChengyuList();
}



async function checkAuth() {
    const savedUser = localStorage.getItem('hsk_user');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        updateAuthUI();
        return true;
    }
    return false;
}

async function loginOrRegister() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
        return;
    }
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
        const response = await fetch(`${API_BASE}/auth/user`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                action: 'login_or_register'
            })
        });
        
        if (response.ok) {
            const userData = await response.json();
            currentUser = userData;
            localStorage.setItem('hsk_user', JSON.stringify(userData));
            localStorage.setItem('hsk_user_id', userData.user_id);
            updateAuthUI();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadStats();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            addMessage(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.name}! –¢–µ–ø–µ—Ä—å —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è.`, 'ai');
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç API, —Å–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            createLocalUser(username);
        }
    } catch (error) {
        console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        createLocalUser(username);
    }
}

function createLocalUser(username) {
    const userId = "user_" + Date.now();
    currentUser = {
        user_id: userId,
        name: username,
        current_level: 1,
        target_level: 4,
        registered_at: new Date().toISOString()
    };
    
    localStorage.setItem('hsk_user', JSON.stringify(currentUser));
    localStorage.setItem('hsk_user_id', userId);
    updateAuthUI();
    
    // –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    addMessage(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}! –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.`, 'ai');
}

// –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
function logout() {
    if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
        localStorage.removeItem('hsk_user');
        localStorage.removeItem('hsk_user_id');
        currentUser = null;
        updateAuthUI();  // –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç UI
        
        // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ Progress –∞–∫—Ç–∏–≤–Ω–∞ - –æ–±–Ω–æ–≤–∏—Ç—å –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
        
        addMessage('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', 'ai');
    }
}

// –û–±–Ω–æ–≤–∏–º getOrCreateUser –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function getOrCreateUser() {
    if (currentUser) {
        return currentUser.user_id;
    }
    
    await checkAuth();
    if (currentUser) {
        return currentUser.user_id;
    }
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ
    return "guest_" + Date.now();
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º
function showLoginForm() {
    document.getElementById('loginModal').style.display = 'flex';
}

function hideLoginForm() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
}

// –ù–∞ –≤–∫–ª–∞–¥–∫–µ Progress –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
function showUserProfile() {
    const progressContent = document.getElementById('progressContent');
    
    if (!currentUser) {
        progressContent.innerHTML = `
            <div style="text-align: center; padding: 40px 0;">
                <div style="font-size: 4em; color: var(--gray);">üîê</div>
                <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h3>
                <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                    </button>
                    <button class="btn btn-success" onclick="showRegisterFormFull()" style="margin-left: 10px;">
                        <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </div>
            </div>
        `;
        return;
    }

    function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
function retryEssayAnalysis() {
    if (confirm('–ù–∞—á–∞—Ç—å —ç—Å—Å–µ –∑–∞–Ω–æ–≤–æ? –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
        document.getElementById('essayAnalysisResult').style.display = 'none';
        document.getElementById('essayAnalysisArea').style.display = 'block';
        document.getElementById('essayAnalysisText').value = '';
        updateEssayAnalysisCounter();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞
function saveEssayAnalysisResult() {
    if (!currentEssayAnalysisData) return;
    
    const data = {
        type: 'essay_analysis_result',
        data: currentEssayAnalysisData,
        timestamp: new Date().toISOString(),
        essay_text: document.getElementById('essayAnalysisText').value
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `essay_analysis_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
function showCorrectedEssay() {
    const essayText = document.getElementById('essayAnalysisText').value;
    const errors = currentEssayAnalysisData?.result?.errors || [];
    
    let correctedText = essayText;
    
    // –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±—É–¥–µ—Ç AI)
    errors.forEach(err => {
        // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ (–ø—Ä–∏–º–µ—Ä)
        correctedText = correctedText
            .replace('‰∫Ü‰∏ç', '‰∏ç')
            .replace('ÁöÑÂæó', 'Âæó')
            .replace('Âú∞Âæó', 'Âæó');
    });
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; 
                    width: 100%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-edit"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —ç—Å—Å–µ
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                    <i class="fas fa-check-circle"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤—ã–¥–µ–ª–µ–Ω—ã:
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; 
                            font-family: 'SimSun', serif; font-size: 16px; line-height: 1.8; 
                            white-space: pre-wrap;">
                    ${correctedText}
                </div>
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    progressContent.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-user"></i> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="icon">üë§</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="stat-card">
                <h3>–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                <div class="stat-number">${currentUser.stats?.learned_words || 0}/${currentUser.stats?.total_words || 5462}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${currentUser.stats?.progress_percentage || 0}%"></div>
                </div>
                <div class="stat-desc">${currentUser.stats?.progress_percentage || 0}% –∏–∑—É—á–µ–Ω–æ</div>
            </div>
            
            <div class="stat-card">
                <h3>–¶–µ–ª—å</h3>
                <div class="stat-number">HSK ${currentUser.current_level || 1} ‚Üí HSK ${currentUser.target_level || 4}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((currentUser.current_level || 1) / (currentUser.target_level || 4)) * 100}%"></div>
                </div>
                <div class="stat-desc">${currentUser.days_until_exam || 0} –¥–Ω–µ–π –¥–æ —ç–∫–∑–∞–º–µ–Ω–∞</div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="showEditProfile()">
                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </button>
                <button class="btn btn-warning" onclick="showResetPassword()">
                    <i class="fas fa-key"></i> –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                </button>
                <button class="btn btn-secondary" onclick="exportProgress()">
                    <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                </button>
            </div>
        </div>
    `;
}

// –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É Progress
// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
async function loadProgress() {
    const progressContent = document.getElementById('progressContent');
   
    if (!currentUser) {
        progressContent.innerHTML = `
            <div style="text-align: center; padding: 40px 0;">
                <div style="font-size: 4em; color: var(--gray);">üîê</div>
                <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h3>
                <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                    </button>
                    <button class="btn btn-success" onclick="showRegisterFormFull()" style="margin-left: 10px;">
                        <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </div>
            </div>
        `;
        return;
    }
   
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        progressContent.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞—é –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å...</p>
            </div>
        `;
       
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        const response = await fetch(`${API_BASE}/user/profile/${currentUser.user_id}`);
       
        if (response.ok) {
            const userData = await response.json();
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('hsk_user', JSON.stringify(currentUser));
        }
       
        // –°—á–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ userWordsStatus (—Ç–≤–æ–∏ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞)
        const learnedWords = Object.values(userWordsStatus).filter(s => s.status === 'learned').length;
        const totalWords = allWords.length || 5462; // —Ç–≤–æ—è –±–∞–∑–∞ —Å–ª–æ–≤
        const progressPercentage = totalWords > 0 ? Math.round((learnedWords / totalWords) * 100) : 0;
       
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        progressContent.innerHTML = `
            <div class="section-header">
                <h2><i class="fas fa-user"></i> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <div class="icon">üë§</div>
            </div>
           
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="stat-card">
                    <h3>–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                    <div class="stat-number">${learnedWords}/${totalWords}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="stat-desc">${progressPercentage}% –∏–∑—É—á–µ–Ω–æ</div>
                </div>
               
                <div class="stat-card">
                    <h3>–¶–µ–ª—å</h3>
                    <div class="stat-number">HSK ${currentUser.current_level || 1} ‚Üí HSK ${currentUser.target_level || 4}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${((currentUser.current_level || 1) / (currentUser.target_level || 4)) * 100}%"></div>
                    </div>
                    <div class="stat-desc">${currentUser.days_until_exam || 0} –¥–Ω–µ–π –¥–æ —ç–∫–∑–∞–º–µ–Ω–∞</div>
                </div>
            </div>
           
            <div style="margin-top: 30px;">
                <h3><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="showEditProfile()">
                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                    <button class="btn btn-warning" onclick="showResetPassword()">
                        <i class="fas fa-key"></i> –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                    <button class="btn btn-secondary" onclick="exportProgress()">
                        <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    </button>
                </div>
            </div>
           
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-success" onclick="loadProgress()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                </button>
            </div>
        `;
       
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
       
        // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ userWordsStatus
        const learnedWords = Object.values(userWordsStatus).filter(s => s.status === 'learned').length;
        const totalWords = allWords.length || 5462;
        const progressPercentage = totalWords > 0 ? Math.round((learnedWords / totalWords) * 100) : 0;
       
        progressContent.innerHTML = `
            <div class="section-header">
                <h2><i class="fas fa-user"></i> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å (–ª–æ–∫–∞–ª—å–Ω–æ)</h2>
                <div class="icon">üíæ</div>
            </div>
           
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="stat-card">
                    <h3>–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                    <div class="stat-number">${learnedWords}/${totalWords}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="stat-desc">${progressPercentage}% –∏–∑—É—á–µ–Ω–æ</div>
                </div>
               
                <div class="stat-card">
                    <h3>–¶–µ–ª—å</h3>
                    <div class="stat-number">HSK ${currentUser?.current_level || 1} ‚Üí HSK ${currentUser?.target_level || 4}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${((currentUser?.current_level || 1) / (currentUser?.target_level || 4)) * 100}%"></div>
                    </div>
                    <div class="stat-desc">${currentUser?.days_until_exam || 0} –¥–Ω–µ–π –¥–æ —ç–∫–∑–∞–º–µ–Ω–∞</div>
                </div>
            </div>
           
            <div class="word-tip" style="margin-top: 20px;">
                <i class="fas fa-info-circle"></i> –î–∞–Ω–Ω—ã–µ –≤–∑—è—Ç—ã –∏–∑ –≤–∞—à–∏—Ö –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤. –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
            </div>
        `;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
function showLocalProgress() {
    const progressContent = document.getElementById('progressContent');
    
    if (!currentUser) return;
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ localStorage
    const localProgress = JSON.parse(localStorage.getItem('hsk_word_progress') || '{}');
    const learnedWords = Object.values(localProgress).filter(p => p.remembered).length;
    
    progressContent.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-user"></i> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å (–ª–æ–∫–∞–ª—å–Ω–æ)</h2>
            <div class="icon">üíæ</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="stat-card">
                <h3>–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                <div class="stat-number">${learnedWords}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, (learnedWords / 5462) * 100)}%"></div>
                </div>
                <div class="stat-desc">${Math.round((learnedWords / 5462) * 100)}% –∏–∑—É—á–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ</div>
            </div>
            
            <div class="stat-card">
                <h3>–¶–µ–ª—å</h3>
                <div class="stat-number">HSK ${currentUser.current_level || 1} ‚Üí HSK ${currentUser.target_level || 4}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((currentUser.current_level || 1) / (currentUser.target_level || 4)) * 100}%"></div>
                </div>
                <div class="stat-desc">–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>
            </div>
        </div>
        
        <div class="word-tip" style="margin-top: 20px;">
            <i class="fas fa-info-circle"></i> –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è.
        </div>
    `;
}

function hideRegisterForm() {
    document.getElementById('registerModal').style.display = 'none';
}

function showProfile() {
    switchTab('progress');
}

function showRegisterFormFull() {
    hideLoginForm();
    document.getElementById('registerModal').style.display = 'flex';
}

// –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
// –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    if (!email || !password) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å!');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                password: password
            })
        });
        
        if (response.ok) {
            const userData = await response.json();
            currentUser = userData;
            localStorage.setItem('hsk_user', JSON.stringify(userData));
            localStorage.setItem('hsk_user_id', userData.user_id);
            hideLoginForm();
            updateAuthUI();  // –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç UI
            
            // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ Progress –∞–∫—Ç–∏–≤–Ω–∞ - –æ–±–Ω–æ–≤–∏—Ç—å –µ—ë
            if (document.getElementById('progress-tab').classList.contains('active')) {
                loadProgress();
            }
            
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            addMessage(`üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${userData.name}! –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å: ${userData.stats?.learned_words || 0} –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤.`, 'ai');
        } else {
            const error = await response.json();
            alert(error.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        // Fallback: —Å–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        createLocalUser(email.split('@')[0]);
        hideLoginForm();
    }
}

// –ü–æ–ª–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
// –ü–æ–ª–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
async function registerFull() {
    const name = document.getElementById('regNameFull').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const currentLevel = parseInt(document.getElementById('regCurrentLevelFull').value);
    const targetLevel = parseInt(document.getElementById('regTargetLevelFull').value);
    
    if (!name || !email || !password) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
        return;
    }
    
    if (password.length < 6) {
        alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    try {
        const userData = {
            name: name,
            email: email,
            password: password,
            current_level: currentLevel,
            target_level: targetLevel,
            exam_date: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0],
            exam_location: "–ú–æ—Å–∫–≤–∞",
            exam_format: "computer",
            interests: ["–∫–∏—Ç–∞–π—Å–∫–∏–π", "HSK"],
            daily_time: 30,
            learning_style: "visual"
        };
        
        const response = await fetch(`${API_BASE}/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        if (response.ok) {
            const result = await response.json();
            currentUser = result;
            localStorage.setItem('hsk_user', JSON.stringify(result));
            localStorage.setItem('hsk_user_id', result.user_id);
            hideRegisterForm();
            updateAuthUI();  // –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç UI
            
            // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ Progress –∞–∫—Ç–∏–≤–Ω–∞ - –æ–±–Ω–æ–≤–∏—Ç—å –µ—ë
            if (document.getElementById('progress-tab').classList.contains('active')) {
                loadProgress();
            }
            
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            addMessage(`üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${name}! –ù–∞—á–Ω—ë–º —É—á–∏—Ç—å –∫–∏—Ç–∞–π—Å–∫–∏–π! –í–∞—à –ø–ª–∞–Ω: ${result.plan?.daily_words || 10} —Å–ª–æ–≤ –≤ –¥–µ–Ω—å.`, 'ai');
        } else {
            const error = await response.json();
            alert(error.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        // Fallback: –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        createLocalUser(name);
        hideRegisterForm();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
function updateAuthUI() {
    const guestView = document.getElementById('guestView');
    const userView = document.getElementById('userView');
    const userNameDisplay = document.getElementById('userNameDisplay');
    
    if (currentUser) {
        guestView.style.display = 'none';
        userView.style.display = 'block';
        userNameDisplay.textContent = currentUser.name;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        loadUserChats();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ï–°–õ–ò –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
    } else {
        guestView.style.display = 'block';
        userView.style.display = 'none';
        
        // –û—á–∏—â–∞–µ–º —á–∞—Ç—ã –¥–ª—è –≥–æ—Å—Ç—è
        userChats = [];
        currentChatId = null;
        renderChatList();
        clearChatBox();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ï–°–õ–ò –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
    }
}

// –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
// –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
function logout() {
    if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
        localStorage.removeItem('hsk_user');
        localStorage.removeItem('hsk_user_id');
        currentUser = null;
        updateAuthUI();  // –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç UI
        
        // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ Progress –∞–∫—Ç–∏–≤–Ω–∞ - –æ–±–Ω–æ–≤–∏—Ç—å –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
        
        addMessage('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', 'ai');
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
async function checkAuth() {
    const savedUser = localStorage.getItem('hsk_user');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞/—Å–µ—Å—Å–∏–∏
            if (currentUser.user_id) {
                const response = await fetch(`${API_BASE}/user/profile/${currentUser.user_id}`);
                if (response.ok) {
                    const freshData = await response.json();
                    currentUser = { ...currentUser, ...freshData };
                    localStorage.setItem('hsk_user', JSON.stringify(currentUser));
                }
            }
            
            updateAuthUI();
            return true;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        }
    }
    return false;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserProgress() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/user/profile/${currentUser.user_id}`);
        if (response.ok) {
            const userData = await response.json();
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('hsk_user', JSON.stringify(currentUser));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
    }
}

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
async function loadStats() {
    try {
        const response = await fetch(`${API_BASE}/stats`);
        const stats = await response.json();
        
        let statsHTML = `
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ —Å–ª–æ–≤</h3>
                <div class="stat-number">${stats.total_words || 0}</div>
                <div class="stat-desc">HSK 1-6</div>
            </div>
        `;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        if (stats.by_level) {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏ –ø–æ –Ω–æ–º–µ—Ä—É
            const sortedLevels = Object.entries(stats.by_level).sort((a, b) => {
                const levelA = parseInt(a[0].replace('HSK ', ''));
                const levelB = parseInt(b[0].replace('HSK ', ''));
                return levelA - levelB;
            });
            
            for (const [levelName, count] of sortedLevels) {
                const levelNum = levelName.replace('HSK ', '');
                
                const descriptions = {
                    '1': '–ë–∞–∑–æ–≤—ã–π',
                    '2': '–ù–∞—á–∞–ª—å–Ω—ã–π', 
                    '3': '–°—Ä–µ–¥–Ω–∏–π',
                    '4': '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π',
                    '5': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π',
                    '6': '–ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π'
                };
                
                statsHTML += `
                    <div class="stat-card">
                        <h3>${levelName}</h3>
                        <div class="stat-number">${count}</div>
                        <div class="stat-desc">${descriptions[levelNum] || ''} —É—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                `;
            }
        } else {
            // Fallback –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
            for (let level = 1; level <= 6; level++) {
                const descriptions = {
                    1: '–ë–∞–∑–æ–≤—ã–π',
                    2: '–ù–∞—á–∞–ª—å–Ω—ã–π', 
                    3: '–°—Ä–µ–¥–Ω–∏–π',
                    4: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π',
                    5: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π',
                    6: '–ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π'
                };
                
                statsHTML += `
                    <div class="stat-card">
                        <h3>HSK ${level}</h3>
                        <div class="stat-number">...</div>
                        <div class="stat-desc">${descriptions[level]} —É—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                `;
            }
        }
        
        document.getElementById('stats').innerHTML = statsHTML;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        
        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        document.getElementById('stats').innerHTML = `
            <div class="stat-card" style="grid-column: 1 / -1;">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                <div class="stat-number">‚ùå</div>
                <div class="stat-desc">–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç</div>
                <button class="btn btn-primary" onclick="loadStats()" style="margin-top: 10px; padding: 5px 10px; font-size: 0.8em;">
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            </div>
        `;
    }
}

// –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getOrCreateUser() {
    const storedId = localStorage.getItem('hsk_user_id');
    if (storedId) return storedId;
    
    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = {
        name: "–ì–æ—Å—Ç—å",
        current_level: 1,
        target_level: 4,
        exam_date: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0], // +90 –¥–Ω–µ–π
        exam_location: "–ú–æ—Å–∫–≤–∞",
        exam_format: "computer",
        interests: ["–∫–∏—Ç–∞–π—Å–∫–∏–π", "HSK"],
        daily_time: 30,
        learning_style: "visual"
    };
    
    try {
        const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        localStorage.setItem('hsk_user_id', result.user_id);
        return result.user_id;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        return "demo_user_" + Date.now(); // fallback
    }
}

// ========== –°–ò–°–¢–ï–ú–ê –ß–ê–¢–û–í ==========

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserChats() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/chat/threads/${currentUser.user_id}`);
        if (response.ok) {
            const data = await response.json();
            userChats = data.threads || [];
            currentChatId = data.current_thread;
            renderChatList();
        } else {
            // –ï—Å–ª–∏ API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            loadLocalChats();
        }
    } catch (error) {
        console.log('API —á–∞—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
        loadLocalChats();
    }
}

async function generateEssayAnalysis() {
    const topic = document.getElementById('essayAnalysisTopic').value.trim();
    const details = document.getElementById('essayAnalysisDetails').value.trim();
    const difficulty = document.getElementById('essayDifficulty').value;
    const length = parseInt(document.getElementById('essayAnalysisLength').value);
    
    if (!topic) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É —ç—Å—Å–µ!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const generateBtn = document.getElementById('generateEssayBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∑–∞–¥–∞–Ω–∏–µ...';
    generateBtn.disabled = true;
    
    try {
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–Ω–æ –º–æ–¥–µ–ª–∏ –±—ç–∫–µ–Ω–¥–∞
        const requestData = {
            topic: topic,
            details: details,
            difficulty: difficulty,
            target_length: length,
            user_id: currentUser?.user_id || null
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∑–∞–¥–∞–Ω–∏—è:", requestData);
        
        const response = await fetch(`${API_BASE}/essay/analysis/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:", data);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        currentEssayAnalysisData = {
            prompt: data.prompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            requirements: data.requirements,
            evaluation_criteria: data.evaluation_criteria,
            time_limit_minutes: data.time_limit_minutes || 60,
            start_time: new Date(),
            api_data: data  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ API
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è
        showEssayAnalysisArea(data.prompt, length);
        
        showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ! –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —ç—Å—Å–µ.');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
        
        // Fallback: –ª–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        const fallbackPrompt = generateFallbackEssayPrompt(topic, difficulty, length);
        currentEssayAnalysisData = {
            prompt: fallbackPrompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            start_time: new Date()
        };
        
        showEssayAnalysisArea(fallbackPrompt, length);
        
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ —ç—Å—Å–µ
function showEssayAnalysisResult(result, essayText) {
    console.log("–ü–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:", result);
    
    const essayArea = document.getElementById('essayAnalysisArea');
    const resultSection = document.getElementById('essayAnalysisResult');
    
    if (!essayArea || !resultSection) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    essayArea.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    resultSection.style.display = 'block';
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    const overallScore = result.overall_score || 0;
    const scoreColor = getScoreColor(overallScore);
    
    let resultHTML = `
        <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="retryEssayAnalysis()">
                        <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <button class="btn btn-success" onclick="saveEssayAnalysisResult()">
                        <i class="fas fa-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                    <button class="btn btn-warning" onclick="showCorrectedEssay()">
                        <i class="fas fa-edit"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
                    </button>
                </div>
            </div>
            
            <!-- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 3em; font-weight: bold; color: ${scoreColor}">${overallScore}/100</div>
                        <div style="color: var(--gray);">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞</div>
                        <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                            ${overallScore >= 70 ? 'üéâ –ú–æ–∂–µ—Ç–µ –≥–æ—Ä–¥–∏—Ç—å—Å—è!' : 
                              overallScore >= 50 ? 'üí™ –ù–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –ª—É—á—à–µ' : 
                              'üìö –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏'}
                        </div>
                    </div>
                    
                    ${result.would_pass_exam !== undefined ? `
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; color: ${result.would_pass_exam ? 'var(--success)' : 'var(--danger)'}">
                                ${result.would_pass_exam ? '‚úÖ' : '‚ùå'}
                            </div>
                            <div style="color: var(--gray);">
                                ${result.would_pass_exam ? '–°–¥–∞–ª –±—ã —ç–∫–∑–∞–º–µ–Ω' : '–ù–µ —Å–¥–∞–ª –±—ã —ç–∫–∑–∞–º–µ–Ω'}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">
                            ${essayText.length}
                        </div>
                        <div style="color: var(--gray);">–ò–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</div>
                    </div>
                </div>
                
                ${result.estimated_level ? `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; display: inline-block;">
                        <strong>–†–µ–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å:</strong> ${result.estimated_level}
                    </div>
                ` : ''}
            </div>
            
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-chart-pie"></i> –û—Ü–µ–Ω–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const categories = result.categories || [
        { name: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ', score: 0, feedback: '' },
        { name: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞', score: 0, feedback: '' },
        { name: '–õ–µ–∫—Å–∏–∫–∞', score: 0, feedback: '' },
        { name: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞', score: 0, feedback: '' }
    ];
    
    categories.forEach(cat => {
        resultHTML += `
            <div class="stat-card">
                <h3>${cat.name}</h3>
                <div class="stat-number">${cat.score}/100</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${cat.score}%; background: ${getScoreColor(cat.score)}"></div>
                </div>
                <div class="stat-desc">${cat.feedback || ''}</div>
            </div>
        `;
    });
    
    resultHTML += `
                </div>
            </div>
            
            <!-- –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                ${result.strengths ? `
                    <div class="word-card" style="border-left-color: var(--success);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                            <i class="fas fa-check-circle"></i> –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
                        </div>
                        <div>${result.strengths}</div>
                    </div>
                ` : ''}
                
                ${result.weaknesses ? `
                    <div class="word-card" style="border-left-color: var(--danger);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
                        </div>
                        <div>${result.weaknesses}</div>
                    </div>
                ` : ''}
            </div>
            
            <!-- –û—à–∏–±–∫–∏ -->
            ${result.errors && result.errors.length > 0 ? `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--warning); margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (${result.errors.length}):
                    </h4>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                        ${result.errors.map((err, index) => `
                            <div style="margin-bottom: ${index < result.errors.length - 1 ? '15px' : '0'}; 
                                        padding-bottom: ${index < result.errors.length - 1 ? '15px' : '0'}; 
                                        border-bottom: ${index < result.errors.length - 1 ? '1px solid #ffc107' : 'none'}">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <div style="color: ${err.severity === 'high' ? 'var(--danger)' : 'var(--warning)'}; font-size: 1.2em;">
                                        ${err.severity === 'high' ? '‚ùå' : '‚ö†Ô∏è'}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: var(--danger);">
                                            –û—à–∏–±–∫–∞ ${index + 1} (${err.type || '–æ–±—â–∞—è'}):
                                        </div>
                                        <div style="margin: 5px 0; font-family: 'SimSun', serif;">${err.description}</div>
                                        <div style="color: var(--success);">
                                            <i class="fas fa-check-circle"></i> <strong>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${err.correction}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
            ${result.recommendations ? `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--success); margin-bottom: 15px;">
                        <i class="fas fa-star"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:
                    </h4>
                    <div class="word-tip">
                        ${result.recommendations}
                    </div>
                </div>
            ` : ''}
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div>
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-history"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                            ${Math.floor((new Date() - currentEssayAnalysisData.start_time) / 1000 / 60)} –º–∏–Ω
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–í—Ä–µ–º—è</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                            ${Math.floor(essayText.length / Math.max(1, (new Date() - currentEssayAnalysisData.start_time) / 1000 / 60))}Â≠ó/–º–∏–Ω
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–°–∫–æ—Ä–æ—Å—Ç—å</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                            ${essayText.split(/[Ôºå„ÄÇÔºÅÔºü]/).filter(s => s.trim()).length}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                            ${new Set(essayText.match(/[\u4e00-\u9fff]/g) || []).size}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultSection.innerHTML = resultHTML;
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// ========== –ì–†–ê–ú–ú–ê–¢–ò–ö–ê ==========

let grammarTopics = [];
let currentGrammarTopic = null;
let grammarCategories = new Set();

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
async function loadGrammarTopics() {
    try {
        const response = await fetch(`${API_BASE}/grammar/topics?limit=200`);
        const data = await response.json();
        
        grammarTopics = data.topics || [];
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('–í—Å–µ —Ç–µ–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', grammarTopics.length);
        console.log('–£—Ä–æ–≤–Ω–∏ –≤ –¥–∞–Ω–Ω—ã—Ö:', [...new Set(grammarTopics.map(t => t.level))]);
        console.log('–ü—Ä–∏–º–µ—Ä —Ç–µ–º—ã –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è:', 
            grammarTopics.find(t => t.level === 'È´ò'));
        
        // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        grammarCategories.clear();
        grammarTopics.forEach(topic => {
            if (topic.category) grammarCategories.add(topic.category);
        });
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const categoryFilter = document.getElementById('grammarCategoryFilter');
        categoryFilter.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
        Array.from(grammarCategories).sort().forEach(cat => {
            categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        
        renderGrammarTopicsList();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('grammarCount').textContent = grammarTopics.length;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (currentUser) {
            loadGrammarHistory();
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏:', error);
        document.getElementById('grammarTopicsList').innerHTML = `
            <div class="loading">
                <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏</p>
                <button class="btn btn-primary" onclick="loadGrammarTopics()">
                    <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}

// –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Ç–µ–º
function renderGrammarTopicsList(filteredTopics = grammarTopics) {
    const topicsList = document.getElementById('grammarTopicsList');
    
    if (filteredTopics.length === 0) {
        topicsList.innerHTML = '<p style="text-align: center; color: var(--gray);">–¢–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    topicsList.innerHTML = filteredTopics.map(topic => {
        const complexity = topic.complexity || 3;
        const complexityColor = complexity <= 2 ? 'var(--success)' : 
                               complexity <= 4 ? 'var(--warning)' : 'var(--danger)';
        
        return `
            <div class="grammar-topic-item" 
                 onclick="selectGrammarTopic('${topic.id}')"
                 style="padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; 
                        background: ${currentGrammarTopic?.id === topic.id ? '#e3f2fd' : '#f8f9fa'};
                        border-left: 4px solid ${getLevelColor(topic.level)};
                        transition: all 0.3s;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: ${currentGrammarTopic?.id === topic.id ? 'bold' : 'normal'}; 
                                    color: var(--dark); margin-bottom: 5px;">
                            ${topic.chinese}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">
                            ${topic.english}
                        </div>
                        <div style="font-size: 0.8em; color: var(--gray);">
                            ${topic.russian}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: end; gap: 5px;">
                        <span class="word-level" style="font-size: 0.7em; background: ${getLevelColor(topic.level)};">
                            ${topic.level}
                        </span>
                        <div style="font-size: 0.7em; color: ${complexityColor};">
                            ${'‚òÖ'.repeat(Math.min(5, complexity))}${'‚òÜ'.repeat(5 - Math.min(5, complexity))}
                        </div>
                    </div>
                </div>
                ${topic.tags ? `
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                        ${topic.tags.map(tag => `
                            <span style="font-size: 0.7em; background: #e9ecef; padding: 2px 6px; border-radius: 10px;">
                                ${tag}
                            </span>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// –¶–≤–µ—Ç–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
function getLevelColor(level) {
    const colors = {
        'Âàù': '#667eea', // —Å–∏–Ω–∏–π - –Ω–∞—á–∞–ª—å–Ω—ã–π
        '‰∏≠': '#4cd964', // –∑–µ–ª–µ–Ω—ã–π - —Å—Ä–µ–¥–Ω–∏–π
        'È´ò': '#f5576c', // –∫—Ä–∞—Å–Ω—ã–π - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ —Å–ª—É—á–∞–π —Ä–∞–∑–Ω—ã—Ö –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π
        'beginner': '#667eea',
        'intermediate': '#4cd964',
        'advanced': '#f5576c',
        'HSK1-2': '#667eea',
        'HSK3-4': '#4cd964',
        'HSK5-6': '#f5576c',
        '1': '#667eea',
        '2': '#4cd964',
        '3': '#f5576c'
    };
    return colors[level] || '#6c757d';
}

// –í—ã–±–æ—Ä —Ç–µ–º—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
async function selectGrammarTopic(topicId) {
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–º—É
    currentGrammarTopic = grammarTopics.find(t => t.id === topicId);
    if (!currentGrammarTopic) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (–≤—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é)
    renderGrammarTopicsList();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ –¥–µ—Ç–∞–ª—è—Ö
    const detailsDiv = document.getElementById('grammarTopicDetails');
    detailsDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>üß† AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ...</p>
        </div>
    `;
    
    try {
        // –ü–æ–ª—É—á–∞–µ–º AI-–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        const response = await fetch(`${API_BASE}/grammar/explain`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic_id: topicId,
                user_id: currentUser?.user_id || null
            })
        });
        
        const explanation = await response.json();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        displayGrammarExplanation(explanation);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        const exercisesDiv = document.getElementById('grammarExercises');
        exercisesDiv.innerHTML = `
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-success" onclick="generateGrammarPractice('${topicId}')">
                    <i class="fas fa-dumbbell"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                </button>
            </div>
        `;
        exercisesDiv.style.display = 'block';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è:', error);
        detailsDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ùå</div>
                <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</p>
                <button class="btn btn-primary" onclick="selectGrammarTopic('${topicId}')" style="margin-top: 10px;">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}



// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
function displayGrammarExplanation(explanation) {
    const detailsDiv = document.getElementById('grammarTopicDetails');
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä—ã
    let examplesHTML = '';
    if (explanation.examples && Array.isArray(explanation.examples)) {
        examplesHTML = explanation.examples.map((example, index) => `
            <div style="margin-bottom: ${index < explanation.examples.length - 1 ? '15px' : '0'}; 
                        padding-bottom: ${index < explanation.examples.length - 1 ? '15px' : '0'}; 
                        border-bottom: ${index < explanation.examples.length - 1 ? '1px solid #dee2e6' : 'none'}">
                <div style="font-size: 1.1em; margin-bottom: 5px; font-weight: bold;">
                    ${example.chinese || ''}
                </div>
                <div style="color: var(--danger); margin-bottom: 5px;">
                    ${example.pinyin || ''}
                </div>
                <div style="color: var(--gray); margin-bottom: 5px;">
                    ${example.translation || ''}
                </div>
                ${example.explanation ? `
                    <div style="font-size: 0.9em; color: var(--warning);">
                        <i class="fas fa-lightbulb"></i> ${example.explanation}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    detailsDiv.innerHTML = `
        <div style="max-height: 450px; overflow-y: auto; padding-right: 10px;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div style="margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin-bottom: 5px;">
                    ${explanation.topic_chinese || currentGrammarTopic.chinese}
                </h2>
                <div style="color: var(--danger); font-size: 1.1em; margin-bottom: 5px;">
                    ${explanation.topic_pinyin || currentGrammarTopic.pinyin}
                </div>
                <div style="color: var(--gray); margin-bottom: 15px;">
                    ${explanation.topic_english || currentGrammarTopic.english} ‚Ä¢ 
                    ${explanation.topic_russian || currentGrammarTopic.russian}
                </div>
            </div>
            
            <!-- –†–µ–∑—é–º–µ -->
            ${explanation.topic_summary ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--primary);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                        <i class="fas fa-info-circle"></i> –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ:
                    </div>
                    <div>${explanation.topic_summary}</div>
                </div>
            ` : ''}
            
            <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ -->
            ${explanation.basic_rule ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--success);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                        <i class="fas fa-gavel"></i> –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
                    </div>
                    <div>${explanation.basic_rule}</div>
                </div>
            ` : ''}
            
            <!-- –§–æ—Ä–º—É–ª–∞ -->
            ${explanation.formula ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--warning);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">
                        <i class="fas fa-calculator"></i> –§–æ—Ä–º—É–ª–∞/–ü–∞—Ç—Ç–µ—Ä–Ω:
                    </div>
                    <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        ${explanation.formula}
                    </div>
                </div>
            ` : ''}
            
            <!-- –ü—Ä–∏–º–µ—Ä—ã -->
            ${examplesHTML ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--danger);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                        <i class="fas fa-comment-alt"></i> –ü—Ä–∏–º–µ—Ä—ã:
                    </div>
                    ${examplesHTML}
                </div>
            ` : ''}
            
            <!-- –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ -->
            ${explanation.common_mistakes ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--danger);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle"></i> –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ —Ä—É—Å—Å–∫–æ–≥–æ–≤–æ—Ä—è—â–∏—Ö:
                    </div>
                    <div>${explanation.common_mistakes}</div>
                </div>
            ` : ''}
            
            <!-- –°–æ–≤–µ—Ç –ø–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—é -->
            ${explanation.memory_tips ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--accent);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--accent);">
                        <i class="fas fa-brain"></i> –°–æ–≤–µ—Ç—ã –ø–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—é:
                    </div>
                    <div>${explanation.memory_tips}</div>
                </div>
            ` : ''}
            
            <!-- –ü—Ä–∞–∫—Ç–∏–∫–∞ -->
            ${explanation.practice_sentences ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--success);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                        <i class="fas fa-dumbbell"></i> –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:
                    </div>
                    <div>${Array.isArray(explanation.practice_sentences) 
                        ? explanation.practice_sentences.map(s => `‚Ä¢ ${s}`).join('<br>')
                        : explanation.practice_sentences}</div>
                </div>
            ` : ''}
            
            ${explanation.fallback ? `
                <div class="word-tip" style="background: #fff3cd; border-left-color: #ffc107;">
                    <i class="fas fa-exclamation-triangle"></i> ${explanation.note || '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ'}
                </div>
            ` : ''}
        </div>
    `;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
async function generateGrammarPractice(topicId) {
    const exercisesDiv = document.getElementById('grammarExercises');
    exercisesDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>üéØ AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è...</p>
        </div>
    `;
    
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º GET –∑–∞–ø—Ä–æ—Å
        const response = await fetch(`${API_BASE}/grammar/practice/${topicId}?difficulty=medium`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const data = await response.json();
        
        console.log('–ü–æ–ª—É—á–µ–Ω—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', data);
        
        displayGrammarExercises(data);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', error);
        exercisesDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ùå</div>
                <p>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
                <p style="font-size: 0.9em; color: var(--gray);">${error.message}</p>
                <button class="btn btn-primary" onclick="generateGrammarPractice('${topicId}')" style="margin-top: 10px;">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
function displayGrammarExercises(data) {
    const exercisesDiv = document.getElementById('grammarExercises');
    
    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', data); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞
    if (data.error) {
        exercisesDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ö†Ô∏è</div>
                <h4>${data.error}</h4>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É</p>
            </div>
        `;
        return;
    }
    
    let exercisesHTML = `
        <h3 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-dumbbell"></i> –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —Ç–µ–º–µ
            <span class="word-level" style="font-size: 0.8em; margin-left: 10px;">
                –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${data.difficulty || 'medium'}
            </span>
        </h3>
    `;
    
    const exercises = data.exercises || data; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    
    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
    if (exercises.multiple_choice && Array.isArray(exercises.multiple_choice) && exercises.multiple_choice.length > 0) {
    exercisesHTML += `
        <div class="word-card" style="margin-bottom: 20px;">
            <div style="font-weight: bold; margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-list-ol"></i> –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
            </div>
            ${exercises.multiple_choice.map((q, index) => {
                const options = q.options || [];
                return `
                    <div style="margin-bottom: 15px; padding-bottom: 15px; 
                                border-bottom: ${index < exercises.multiple_choice.length - 1 ? '1px solid #dee2e6' : 'none'}">
                        <div style="font-weight: bold; margin-bottom: 10px;">${index + 1}. ${q.question || '–í–æ–ø—Ä–æ—Å'}</div>
                        <div class="test-options" style="margin-top: 10px;">
                            ${options.map((opt, optIndex) => `
                                <div class="test-option" onclick="checkGrammarAnswer(this, '${String.fromCharCode(65 + optIndex)}', '${q.correct}', ${index})">
                                    ${String.fromCharCode(65 + optIndex)}) ${opt}
                                </div>
                            `).join('')}
                        </div>
                        <div id="explanation-${index}" class="answer-explanation" style="display: none; margin-top: 10px; padding: 10px; 
                                background: #e3f2fd; border-radius: 5px; color: #1976d2;">
                            <strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> ${q.explanation || '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + (q.correct || 'A')}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤
    if (exercises.fill_in_blanks) {
        exercisesHTML += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--success);">
                    <i class="fas fa-edit"></i> –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫–∏:
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-line;">
                    ${exercises.fill_in_blanks}
                </div>
            </div>
        `;
    }
    
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
    if (exercises.error_correction) {
        exercisesHTML += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--warning);">
                    <i class="fas fa-exclamation-triangle"></i> –ù–∞–π–¥–∏—Ç–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-line;">
                    ${exercises.error_correction}
                </div>
            </div>
        `;
    }
    
    // –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    if (exercises.sentence_formation) {
        exercisesHTML += `
            <div class="word-card">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--danger);">
                    <i class="fas fa-puzzle-piece"></i> –°–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–∑ —Å–ª–æ–≤:
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-line;">
                    ${exercises.sentence_formation}
                </div>
            </div>
        `;
    }
    
    // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    if (!exercises.multiple_choice && !exercises.fill_in_blanks && 
        !exercises.error_correction && !exercises.sentence_formation) {
        exercisesHTML += `
            <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                <div style="font-size: 3em;">üìù</div>
                <h4>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</h4>
                <p>AI –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateGrammarPractice('${currentGrammarTopic?.id}')">
                        <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            </div>
        `;
    } else {
        exercisesHTML += `
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="generateGrammarPractice('${currentGrammarTopic?.id}')">
                    <i class="fas fa-sync-alt"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                </button>
            </div>
        `;
    }
    
    exercisesDiv.innerHTML = exercisesHTML;
    exercisesDiv.style.display = 'block';
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö
function checkGrammarAnswer(element, userAnswer, correctAnswer) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ
    const questionDiv = element.closest('.test-options').parentNode;
    questionDiv.querySelectorAll('.test-option').forEach(opt => {
        opt.classList.remove('selected', 'correct', 'wrong');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    element.classList.add('selected');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    if (userAnswer === correctAnswer) {
        element.classList.add('correct');
        element.style.borderColor = 'var(--success)';
        element.style.background = '#e3f2fd';
    } else {
        element.classList.add('wrong');
        element.style.borderColor = 'var(--danger)';
        element.style.background = '#fde8e8';
        
        // –í—ã–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        questionDiv.querySelectorAll('.test-option').forEach(opt => {
            if (opt.textContent.startsWith(correctAnswer + ')')) {
                opt.classList.add('correct');
                opt.style.borderColor = 'var(--success)';
                opt.style.background = '#e3f2fd';
            }
        });
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    const explanation = questionDiv.querySelector('.answer-explanation');
    if (explanation) {
        explanation.style.display = 'block';
    }
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–º
// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–º
function filterGrammarTopics() {
    const levelFilter = document.getElementById('grammarLevelFilter').value;
    const categoryFilter = document.getElementById('grammarCategoryFilter').value;
    const sortBy = document.getElementById('grammarSort').value;
    
    let filtered = grammarTopics;
    
    if (levelFilter) {
        filtered = filtered.filter(t => {
            const topicLevel = t.level;
            // –ü—Ä–æ—Å—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
            return topicLevel === levelFilter;
        });
    }
    
    if (categoryFilter) {
        filtered = filtered.filter(t => t.category === categoryFilter);
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    if (sortBy === 'complexity') {
        filtered.sort((a, b) => (a.complexity || 3) - (b.complexity || 3));
    } else if (sortBy === 'level') {
        // –ü—Ä–æ—Å—Ç–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é: Âàù -> ‰∏≠ -> È´ò
        const levelOrder = { 'Âàù': 1, '‰∏≠': 2, 'È´ò': 3 };
        filtered.sort((a, b) => {
            const levelA = levelOrder[a.level] || 0;
            const levelB = levelOrder[b.level] || 0;
            return levelA - levelB;
        });
    } else if (sortBy === 'name') {
        filtered.sort((a, b) => a.chinese.localeCompare(b.chinese));
    }
    
    renderGrammarTopicsList(filtered);
}

// –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–∞–º
function searchGrammarTopics() {
    const searchTerm = document.getElementById('grammarSearch').value.toLowerCase();
    
    if (!searchTerm) {
        filterGrammarTopics();
        return;
    }
    
    const filtered = grammarTopics.filter(topic => 
        topic.chinese.toLowerCase().includes(searchTerm) ||
        topic.pinyin.toLowerCase().includes(searchTerm) ||
        topic.english.toLowerCase().includes(searchTerm) ||
        topic.russian.toLowerCase().includes(searchTerm) ||
        (topic.tags && topic.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
    );
    
    renderGrammarTopicsList(filtered);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function loadGrammarStats() {
    try {
        const response = await fetch(`${API_BASE}/grammar/stats`);
        const stats = await response.json();
        
        const statsDiv = document.getElementById('grammarStats');
        
        // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        statsDiv.innerHTML = `
            <div class="word-card" style="border-left-color: var(--primary); margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                    <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏:
                </div>
                
                <!-- –í—Å–µ–≥–æ —Ç–µ–º -->
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.9em; color: var(--gray);">–í—Å–µ–≥–æ —Ç–µ–º:</span>
                        <span style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                            ${stats.total_topics || 0}
                        </span>
                    </div>
                </div>
                
                <!-- –£—Ä–æ–≤–Ω–∏ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ) -->
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">–£—Ä–æ–≤–Ω–∏:</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${(stats.by_level_formatted || Object.entries(stats.by_level || {})).map(item => {
                            const level = item.level || item[0];
                            const count = item.count || item[1];
                            const display = item.display || 
                                {"Âàù": "–ù–∞—á–∞–ª—å–Ω—ã–π", "‰∏≠": "–°—Ä–µ–¥–Ω–∏–π", "È´ò": "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π"}[level] || level;
                            const color = {"Âàù": "#667eea", "‰∏≠": "#4cd964", "È´ò": "#f5576c"}[level] || "#6c757d";
                            
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${color};"></div>
                                        <span style="font-size: 0.9em;">${display}</span>
                                    </div>
                                    <span class="word-level" style="font-size: 0.8em; background: ${color};">${count}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å -->
                <div>
                    <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</div>
                    <div style="display: flex; gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--success);">
                                ${stats.complexity_distribution?.easy || 0}
                            </div>
                            <div style="font-size: 0.7em;">–õ—ë–≥–∫–∏–µ</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--warning);">
                                ${stats.complexity_distribution?.medium || 0}
                            </div>
                            <div style="font-size: 0.7em;">–°—Ä–µ–¥–Ω–∏–µ</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--danger);">
                                ${stats.complexity_distribution?.hard || 0}
                            </div>
                            <div style="font-size: 0.7em;">–°–ª–æ–∂–Ω—ã–µ</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        statsDiv.style.display = 'block';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        const statsDiv = document.getElementById('grammarStats');
        statsDiv.innerHTML = `
            <div class="word-card" style="border-left-color: var(--danger);">
                <div style="color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                </div>
            </div>
        `;
        statsDiv.style.display = 'block';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑—É—á–µ–Ω–∏—è
async function loadGrammarHistory() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/grammar/history/${currentUser.user_id}`);
        const data = await response.json();
        
        if (data.history && data.history.length > 0) {
            const historyDiv = document.getElementById('grammarHistory');
            const contentDiv = document.getElementById('grammarHistoryContent');
            
            contentDiv.innerHTML = data.history.map(item => `
                <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 0.9em;">
                    <div style="font-weight: bold;">${item.topic_info?.chinese || item.topic_id}</div>
                    <div style="color: var(--gray); font-size: 0.8em;">
                        ${formatDate(item.studied_at)}
                    </div>
                </div>
            `).join('');
            
            historyDiv.style.display = 'block';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}

// –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ
async function askGrammarQuestion() {
    const question = prompt('–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞:');
    if (!question) return;
    
    try {
        const response = await fetch(`${API_BASE}/grammar/ask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question: question,
                user_id: currentUser?.user_id || null,
                topic_id: currentGrammarTopic?.id || null
            })
        });
        
        const data = await response.json();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–º –æ–∫–Ω–µ
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
            align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 15px; 
                        width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 15px; color: var(--primary);">
                    <i class="fas fa-question-circle"></i> –û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å
                </h3>
                <div style="margin-bottom: 15px; font-weight: bold;">
                    ${question}
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    ${data.answer?.answer || '–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω'}
                </div>
                ${data.answer?.examples ? `
                    <div style="margin-bottom: 15px;">
                        <strong>–ü—Ä–∏–º–µ—Ä—ã:</strong><br>
                        ${data.answer.examples}
                    </div>
                ` : ''}
                <button onclick="this.parentElement.parentElement.remove()" 
                        class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤–æ–ø—Ä–æ—Å–∞:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ switchTab –¥–ª—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
// –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é switchTab

// –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤
// –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤
function loadLocalChats() {
    const savedChats = localStorage.getItem(`hsk_chats_${currentUser?.user_id}`);
    if (savedChats) {
        try {
            userChats = JSON.parse(savedChats);
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã:', userChats.length);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
            userChats.forEach(chat => {
                console.log(`–ß–∞—Ç ${chat.title}: ${chat.messages?.length || 0} —Å–æ–æ–±—â–µ–Ω–∏–π`);
            });
            
            if (userChats.length > 0) {
                // –í—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
                userChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                currentChatId = userChats[0].thread_id;
                renderChatList();
                loadChatMessages(currentChatId);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤:', error);
            // –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—ã–π —á–∞—Ç
            createLocalChat();
        }
    } else {
        console.log('–õ–æ–∫–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞—é –ø–µ—Ä–≤—ã–π —á–∞—Ç');
        // –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—ã–π —á–∞—Ç
        createLocalChat();
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    saveChatsLocally();
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ
function saveChatsLocally() {
    if (!currentUser) {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é —á–∞—Ç—ã');
        return;
    }
    
    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤
        userChats.forEach(chat => {
            if (chat.messages && chat.messages.length > 0) {
                chat.updated_at = new Date().toISOString();
            }
        });
        
        const data = JSON.stringify(userChats);
        localStorage.setItem(`hsk_chats_${currentUser.user_id}`, data);
        console.log('–ß–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ:', userChats.length, '—á–∞—Ç–æ–≤');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–æ–≤:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
async function createNewChat() {
    if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã!');
        showLoginForm();
        return;
    }
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ QUERY PARAMETERS (–Ω–µ JSON!)
        const url = `${API_BASE}/chat/threads/create?user_id=${encodeURIComponent(currentUser.user_id)}&title=${encodeURIComponent("–ù–æ–≤—ã–π —á–∞—Ç")}&category=general`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
            // –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º body!
        });
        
        if (response.ok) {
            const data = await response.json();
            userChats.push(data.thread);
            currentChatId = data.thread.thread_id;
            renderChatList();
            clearChatBox();
            saveChatsLocally();
        } else {
            // Fallback: –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
            createLocalChat();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
        createLocalChat();
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞
// –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞
function createLocalChat() {
    const chatId = `chat_${Date.now()}`;
    const newChat = {
        thread_id: chatId,
        user_id: currentUser.user_id,
        title: "–ù–æ–≤—ã–π —á–∞—Ç",
        category: "general",
        created_at: new Date().toISOString(),
        messages: [],  // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
        updated_at: new Date().toISOString()
    };
    
    userChats.push(newChat);
    currentChatId = chatId;
    renderChatList();
    clearChatBox();
    saveChatsLocally();
    
    console.log('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Ç:', chatId);
    
    return newChat;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
function renderChatList() {
    const chatList = document.getElementById('chatList');
    if (!chatList) return;
    
    chatList.innerHTML = '';
    
    userChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
    
    userChats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${chat.thread_id === currentChatId ? 'active' : ''}`;
        chatItem.style.cssText = `
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            background: ${chat.thread_id === currentChatId ? '#e3f2fd' : '#f8f9fa'};
            border-left: 3px solid ${getCategoryColor(chat.category)};
            display: flex;
            justify-content: space-between;
            align-items: center;
        `;
        
        chatItem.innerHTML = `
            <div style="overflow: hidden;">
                <div style="font-weight: ${chat.thread_id === currentChatId ? 'bold' : 'normal'}; font-size: 0.9em;">
                    ${chat.title.length > 20 ? chat.title.substring(0, 20) + '...' : chat.title}
                </div>
                <div style="font-size: 0.8em; color: #6c757d;">
                    ${formatDate(chat.updated_at)}
                </div>
            </div>
            <div class="chat-category" style="font-size: 0.7em; background: ${getCategoryColor(chat.category)}; color: white; padding: 2px 6px; border-radius: 10px;">
                ${getCategoryIcon(chat.category)}
            </div>
        `;
        
        chatItem.onclick = () => switchChat(chat.thread_id);
        chatList.appendChild(chatItem);
    });
    
    updateChatInfo();
}

// –¶–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function getCategoryColor(category) {
    const colors = {
        'general': '#667eea',
        'grammar': '#f093fb',
        'vocabulary': '#4cd964',
        'test_prep': '#ff9a00',
        'strategy': '#f5576c'
    };
    return colors[category] || '#667eea';
}

// –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function getCategoryIcon(category) {
    const icons = {
        'general': 'üí¨',
        'grammar': 'üìö',
        'vocabulary': 'üìñ',
        'test_prep': 'üß™',
        'strategy': 'üéØ'
    };
    return icons[category] || 'üí¨';
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diffMins < 60) return `${diffMins} –º–∏–Ω`;
    if (diffHours < 24) return `${diffHours} —á`;
    if (diffDays < 7) return `${diffDays} –¥`;
    
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞
async function switchChat(chatId) {
    currentChatId = chatId;
    renderChatList();
    await loadChatMessages(chatId);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
async function loadChatMessages(chatId) {
    clearChatBox();
    
    const chat = userChats.find(c => c.thread_id === chatId);
    if (!chat) {
        console.error('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:', chatId);
        return;
    }
    
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞:', chatId);
    console.log('–°–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ:', chat.messages.length);
    
    // –ï—Å–ª–∏ –≤ —á–∞—Ç–µ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
    if (chat.messages && chat.messages.length > 0) {
        chat.messages.forEach(msg => {
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞—é —Å–æ–æ–±—â–µ–Ω–∏–µ:', msg.role, msg.content.substring(0, 50));
            addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
        });
    } else {
        // –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —á–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        addMessage(`–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä HSK. –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ –ª–∞–π—Ñ—Ö–∞–∫–∞—Ö –¥–ª—è —Å–¥–∞—á–∏ —ç–∫–∑–∞–º–µ–Ω–∞!`, 'ai');
    }
}

// –û—á–∏—Å—Ç–∫–∞ –æ–∫–Ω–∞ —á–∞—Ç–∞
function clearChatBox() {
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function updateChatTitleFromMessage(message) {
    const chat = userChats.find(c => c.thread_id === currentChatId);
    if (!chat || chat.title !== "–ù–æ–≤—ã–π —á–∞—Ç") return;
    
    // –°–æ–∑–¥–∞—ë–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    let newTitle = message.trim();
    if (newTitle.length > 30) {
        newTitle = newTitle.substring(0, 30) + '...';
    }
    
    chat.title = newTitle;
    renderChatList();
    saveChatsLocally();
    updateChatInfo();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ
function updateChatInfo() {
    const chatInfo = document.getElementById('chatInfo');
    const chatTitleInput = document.getElementById('chatTitleInput');
    const chatCategory = document.getElementById('chatCategory');
    
    const chat = userChats.find(c => c.thread_id === currentChatId);
    if (chat) {
        chatInfo.style.display = 'block';
        chatTitleInput.value = chat.title;
        chatCategory.value = chat.category;
    } else {
        chatInfo.style.display = 'none';
    }
}

function quickTranslate(text) {
    document.getElementById('translateInput').value = text;
    smartTranslate();
}

// –£–º–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
async function smartTranslate() {
    const input = document.getElementById('translateInput');
    const text = input.value.trim();
    
    if (!text) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const resultDiv = document.getElementById('translationResult');
    resultDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>üß† AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç...</p>
        </div>
    `;
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
    const request = {
        text: text,
        user_id: currentUser?.user_id || null,
        detailed: true,
        include_exercises: document.getElementById('includeExercises').checked
    };
    
    try {
        const response = await fetch(`${API_BASE}/ai/translate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        displayTranslationResult(data);
        
        // –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
        if (document.getElementById('analyzePronunciation').checked) {
            await analyzePronunciation(text);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
        resultDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ùå</div>
                <h3>–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞</h3>
                <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</p>
                <button class="btn btn-primary" onclick="smartTranslate()" style="margin-top: 10px;">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
function displayTranslationResult(data) {
    const resultDiv = document.getElementById('translationResult');
    const detailsDiv = document.getElementById('translationDetails');
    
    // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    resultDiv.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-language"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞
                </h3>
                <span class="word-level">
                    –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${data.difficulty_score || 5}/10
                </span>
            </div>
            
            <!-- –û—Ä–∏–≥–∏–Ω–∞–ª -->
            <div class="word-card" style="margin-bottom: 15px;">
                <div class="word-header">
                    <div class="word-character">${data.original || ''}</div>
                </div>
                <div class="word-pinyin">${data.pinyin || ''}</div>
            </div>
            
            <!-- –ü–µ—Ä–µ–≤–æ–¥ -->
            <div class="word-card" style="border-left-color: var(--success);">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                    <i class="fas fa-exchange-alt"></i> –ü–µ—Ä–µ–≤–æ–¥:
                </div>
                <div style="font-size: 1.1em; margin-bottom: 10px;">
                    ${data.translation || ''}
                </div>
                ${data.word_by_word ? `
                    <div style="font-size: 0.9em; color: var(--gray); font-style: italic;">
                        –î–æ—Å–ª–æ–≤–Ω–æ: ${data.word_by_word}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // –î–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
    let detailsHTML = `
        <div style="margin-top: 30px;">
            <h3><i class="fas fa-info-circle"></i> –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
            
            <!-- –ì—Ä–∞–º–∞—Ç–∏–∫–∞ -->
            ${data.grammar_explanation ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                        <i class="fas fa-book"></i> –ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:
                    </div>
                    <div>${data.grammar_explanation}</div>
                </div>
            ` : ''}
            
            <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -->
            ${data.key_words && data.key_words.length > 0 ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">
                        <i class="fas fa-key"></i> –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                        ${data.key_words.map(word => `
                            <div style="padding: 10px; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div style="font-size: 1.3em; font-weight: bold;">${word.character}</div>
                                <div style="color: var(--danger);">${word.pinyin}</div>
                                <div style="font-size: 0.9em;">${word.translation}</div>
                                ${word.explanation ? `<div style="font-size: 0.8em; color: var(--gray); margin-top: 5px;">${word.explanation}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
            ${data.example_sentences && data.example_sentences.length > 0 ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                        <i class="fas fa-comment-alt"></i> –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:
                    </div>
                    ${data.example_sentences.map((example, index) => `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: ${index < data.example_sentences.length - 1 ? '1px solid #dee2e6' : 'none'}">
                            <div style="font-size: 1.1em; margin-bottom: 5px;">${example.chinese}</div>
                            <div style="color: var(--danger); margin-bottom: 5px;">${example.pinyin}</div>
                            <div style="color: var(--gray);">${example.translation}</div>
                            ${example.explanation ? `<div style="font-size: 0.9em; color: var(--warning); margin-top: 5px;"><i class="fas fa-lightbulb"></i> ${example.explanation}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <!-- –°–æ–≤–µ—Ç—ã –ø–æ –∏–∑—É—á–µ–Ω–∏—é -->
            ${data.study_tips ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                        <i class="fas fa-lightbulb"></i> –°–æ–≤–µ—Ç—ã –ø–æ –∏–∑—É—á–µ–Ω–∏—é:
                    </div>
                    <div>${data.study_tips}</div>
                </div>
            ` : ''}
            
            <!-- –ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ -->
            ${data.cultural_notes ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--secondary);">
                        <i class="fas fa-globe-asia"></i> –ö—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
                    </div>
                    <div>${data.cultural_notes}</div>
                </div>
            ` : ''}
            
            <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
            
        </div>
    `;
    
    detailsDiv.innerHTML = detailsHTML;
    detailsDiv.style.display = 'block';
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ª–æ–≤–∞–º–∏
let allWords = [];
let currentWordsPage = 1;
let wordsPerPage = 12;
let filteredWords = [];
let userWordsStatus = {}; // {wordId: {status: 'saved'/'learned', added_at: timestamp}}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ —Å–ª–æ–≤
async function initWordsTab() {
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–ö–õ–ê–î–ö–ò –°–õ–û–í–ê ===');

    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –°–û–î–ï–†–ñ–ò–ú–û–ì–û (—Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤), –ù–ï —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!
    const wordsList = document.getElementById('wordsList'); // –∏–ª–∏ #wordsContainer, #wordsGrid ‚Äî —Ç–æ—Ç, –≥–¥–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–æ–≤
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π ID ‚Äî –ø–æ–¥—Å—Ç–∞–≤—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¢–û–õ–¨–ö–û –≤ —Å–ø–∏—Å–∫–µ —Å–ª–æ–≤
    if (wordsList) {
        wordsList.innerHTML = `
            <div style="text-align: center; padding: 80px 20px; color: var(--gray);">
                <div class="loading-spinner" style="width: 60px; height: 60px; margin: 0 auto 30px;"></div>
                <p style="font-size: 1.2em;">–ó–∞–≥—Ä—É–∂–∞—é —Å–ª–æ–≤–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞...</p>
            </div>
        `;
    }

    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏–∑ localStorage (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    loadUserWordsStatus();

    // 2. –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
    try {
        await loadWordsFromServer();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤:', error);
        if (wordsList) {
            wordsList.innerHTML = `
                <div style="text-align: center; padding: 80px; color: var(--danger);">
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</p>
                    <button class="btn btn-primary" onclick="initWordsTab()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                </div>
            `;
        }
        return;
    }

    // 3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å—ë
    displayWords();         // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
    updateWordsStats();     // ‚Üê –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏: –ò–∑—É—á–µ–Ω–æ, –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ, %
    
    // –ï—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –ø–æ–∏—Å–∫ ‚Äî reapplies
    if (currentFilter && currentFilter !== 'all') {
        filterWords();
    }
    if (currentSearchQuery) {
        searchWords();
    }

    console.log('–í–∫–ª–∞–¥–∫–∞ "–°–ª–æ–≤–∞" –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
}

function loadUserWordsStatus() {
    console.log('loadUserWordsStatus –∑–∞–ø—É—â–µ–Ω–∞');

    // –ñ–¥—ë–º, –ø–æ–∫–∞ currentUser –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (–µ—Å–ª–∏ –æ–Ω –≤–æ–æ–±—â–µ –µ—Å—Ç—å)
    if (!currentUser && localStorage.getItem('hsk_user')) {
        try {
            currentUser = JSON.parse(localStorage.getItem('hsk_user'));
            console.log('currentUser –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ localStorage:', currentUser?.user_id);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ hsk_user:', e);
        }
    }

    const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–ª—é—á –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–ª–æ–≤:', savedKey);

    const saved = localStorage.getItem(savedKey);
    console.log('–ù–∞–π–¥–µ–Ω–æ –≤ localStorage –ø–æ —ç—Ç–æ–º—É –∫–ª—é—á—É:', saved);

    if (saved) {
        try {
            userWordsStatus = JSON.parse(saved);
            console.log('–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–ª–æ–≤:', Object.keys(userWordsStatus).length);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–ª–æ–≤:', e);
            userWordsStatus = {};
        }
    } else {
        console.log('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ –∫–ª—é—á—É', savedKey);
        userWordsStatus = {};
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
    window.userWordsStatus = userWordsStatus;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–ª–æ–≤
function saveUserWordsStatus() {
    try {
        const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
        localStorage.setItem(savedKey, JSON.stringify(userWordsStatus));
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã:', Object.keys(userWordsStatus).length, '—Å–ª–æ–≤');
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
async function loadWordsFromServer() {
    try {
        const response = await fetch(`${API_BASE}/words/level/1`);
        if (response.ok) {
            const data = await response.json();
            allWords = data.words || [];
        } else {
            // Fallback: —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–ª–æ–≤–∞
            allWords = generateTestWords();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –¥—Ä—É–≥–∏—Ö —É—Ä–æ–≤–Ω–µ–π
        for (let level = 2; level <= 6; level++) {
            try {
                const levelResponse = await fetch(`${API_BASE}/words/level/${level}`);
                if (levelResponse.ok) {
                    const levelData = await levelResponse.json();
                    allWords = [...allWords, ...(levelData.words || [])];
                }
            } catch (e) {
                console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞ HSK ${level}:`, e);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
        filteredWords = [...allWords];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        displayWords();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤:', error);
        allWords = generateTestWords();
        filteredWords = [...allWords];
        displayWords();
    }
    
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª–æ–≤ (fallback)
function generateTestWords() {
    const testWords = [];
    const levels = [1, 2, 3, 4, 5, 6];
    
    // HSK 1 —Å–ª–æ–≤–∞
    const hsk1Words = [
        {character: "‰Ω†Â•Ω", pinyin: "n«ê h«éo", translation: "–ø—Ä–∏–≤–µ—Ç", hsk_level: 1},
        {character: "Ë∞¢Ë∞¢", pinyin: "xi√® xie", translation: "—Å–ø–∞—Å–∏–±–æ", hsk_level: 1},
        {character: "ÂÜçËßÅ", pinyin: "z√†i ji√†n", translation: "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", hsk_level: 1},
        {character: "ÊòØ", pinyin: "sh√¨", translation: "–±—ã—Ç—å", hsk_level: 1},
        {character: "‰∏ç", pinyin: "b√π", translation: "–Ω–µ", hsk_level: 1},
        {character: "Êàë", pinyin: "w«í", translation: "—è", hsk_level: 1},
        {character: "‰Ω†", pinyin: "n«ê", translation: "—Ç—ã", hsk_level: 1},
        {character: "Â•Ω", pinyin: "h«éo", translation: "—Ö–æ—Ä–æ—à–∏–π", hsk_level: 1},
        {character: "ËØ∑", pinyin: "q«êng", translation: "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞", hsk_level: 1},
        {character: "‰ªÄ‰πà", pinyin: "sh√©n me", translation: "—á—Ç–æ", hsk_level: 1}
    ];
    
    // HSK 2 —Å–ª–æ–≤–∞
    const hsk2Words = [
        {character: "Â≠¶Ê†°", pinyin: "xu√© xi√†o", translation: "—à–∫–æ–ª–∞", hsk_level: 2},
        {character: "Â≠¶Áîü", pinyin: "xu√© shƒìng", translation: "—Å—Ç—É–¥–µ–Ω—Ç", hsk_level: 2},
        {character: "ËÄÅÂ∏à", pinyin: "l«éo shƒ´", translation: "—É—á–∏—Ç–µ–ª—å", hsk_level: 2},
        {character: "Â≠¶‰π†", pinyin: "xu√© x√≠", translation: "—É—á–∏—Ç—å—Å—è", hsk_level: 2},
        {character: "Â∑•‰Ωú", pinyin: "g≈çng zu√≤", translation: "—Ä–∞–±–æ—Ç–∞", hsk_level: 2}
    ];
    
    // HSK 3 —Å–ª–æ–≤–∞
    const hsk3Words = [
        {character: "ÊñáÂåñ", pinyin: "w√©n hu√†", translation: "–∫—É–ª—å—Ç—É—Ä–∞", hsk_level: 3},
        {character: "ÂéÜÂè≤", pinyin: "l√¨ sh«ê", translation: "–∏—Å—Ç–æ—Ä–∏—è", hsk_level: 3},
        {character: "ÂõΩÂÆ∂", pinyin: "gu√≥ jiƒÅ", translation: "—Å—Ç—Ä–∞–Ω–∞", hsk_level: 3},
        {character: "Á§æ‰ºö", pinyin: "sh√® hu√¨", translation: "–æ–±—â–µ—Å—Ç–≤–æ", hsk_level: 3},
        {character: "ÁªèÊµé", pinyin: "jƒ´ng j√¨", translation: "—ç–∫–æ–Ω–æ–º–∏–∫–∞", hsk_level: 3}
    ];
    
    // HSK 4 —Å–ª–æ–≤–∞
    const hsk4Words = [
        {character: "ÂèëÂ±ï", pinyin: "fƒÅ zh«én", translation: "—Ä–∞–∑–≤–∏—Ç–∏–µ", hsk_level: 4},
        {character: "ÈáçË¶Å", pinyin: "zh√≤ng y√†o", translation: "–≤–∞–∂–Ω—ã–π", hsk_level: 4},
        {character: "ÈóÆÈ¢ò", pinyin: "w√®n t√≠", translation: "–ø—Ä–æ–±–ª–µ–º–∞", hsk_level: 4},
        {character: "Ëß£ÂÜ≥", pinyin: "jiƒõ ju√©", translation: "—Ä–µ—à–∞—Ç—å", hsk_level: 4},
        {character: "ÂΩ±Âìç", pinyin: "y«êng xi«éng", translation: "–≤–ª–∏—è—Ç—å", hsk_level: 4}
    ];
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å–ª–æ–≤–∞
    return [...hsk1Words, ...hsk2Words, ...hsk3Words, ...hsk4Words];
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ–≤
function displayWords() {
    const wordsList = document.getElementById('wordsList');
    if (!wordsList) return;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∫–∏–µ —Å–ª–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    const startIndex = (currentWordsPage - 1) * wordsPerPage;
    const endIndex = startIndex + wordsPerPage;
    const pageWords = filteredWords.slice(startIndex, endIndex);
    
    if (pageWords.length === 0) {
        wordsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--gray);">
                <div style="font-size: 3em;">üì≠</div>
                <h3>–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</p>
            </div>
        `;
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–æ–≤
    wordsList.innerHTML = pageWords.map(word => {
        const wordId = `${word.character}_${word.hsk_level}`;
        const wordStatus = userWordsStatus[wordId]?.status || 'new';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –∏ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
        const statusConfig = {
            'new': {icon: 'far fa-star', color: '#6c757d', text: '–î–æ–±–∞–≤–∏—Ç—å'},
            'saved': {icon: 'fas fa-bookmark', color: '#ffc107', text: '–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ'},
            'learned': {icon: 'fas fa-check-circle', color: '#28a745', text: '–ò–∑—É—á–µ–Ω–æ'}
        };
        
        const config = statusConfig[wordStatus] || statusConfig.new;
        
        return `
            <div class="word-card" data-word-id="${wordId}">
                <div class="word-character">${word.character}</div>
                <div class="word-pinyin">${word.pinyin}</div>
                <div class="word-translation">${word.translation}</div>
                <div class="word-level">HSK ${word.hsk_level}</div>
                
                <div class="word-actions">
                    <button class="word-action-btn" onclick="toggleWordStatus('${wordId}', 'saved')" 
                            style="color: ${wordStatus === 'saved' ? '#ffc107' : '#6c757d'};">
                        <i class="fas fa-bookmark"></i>
                        ${wordStatus === 'saved' ? '–£–±—Ä–∞—Ç—å' : '–ü—Ä–æ–±–ª–µ–º–Ω–æ–µ'}
                    </button>
                    
                    <button class="word-action-btn" onclick="toggleWordStatus('${wordId}', 'learned')"
                            style="color: ${wordStatus === 'learned' ? '#28a745' : '#6c757d'};">
                        <i class="fas ${wordStatus === 'learned' ? 'fa-check-circle' : 'fa-circle'}"></i>
                        ${wordStatus === 'learned' ? '–ù–µ –∏–∑—É—á–µ–Ω–æ' : '–ò–∑—É—á–µ–Ω–æ'}
                    </button>
                    
                    <button class="word-action-btn" onclick="speakWord('${word.character}')">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    updatePagination();
    console.log('displayWords –≤—ã–∑–≤–∞–Ω–∞. userWordsStatus —Å–æ–¥–µ—Ä–∂–∏—Ç:', Object.keys(userWordsStatus).length, '—Å–ª–æ–≤');
    updateWordsStats();  // –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
function updatePagination() {
    const totalPages = Math.ceil(filteredWords.length / wordsPerPage);
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (pageInfo) {
        pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentWordsPage} –∏–∑ ${totalPages}`;
    }
    
    if (prevBtn) {
        prevBtn.disabled = currentWordsPage === 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentWordsPage === totalPages || totalPages === 0;
    }
}

// –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function changeWordsPage(direction) {
    const totalPages = Math.ceil(filteredWords.length / wordsPerPage);
    const newPage = currentWordsPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentWordsPage = newPage;
        displayWords();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
}

// –ü–æ–∏—Å–∫ —Å–ª–æ–≤
function searchWords() {
    const searchInput = document.getElementById('wordsSearch');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (searchTerm === '') {
        filteredWords = [...allWords];
    } else {
        filteredWords = allWords.filter(word => {
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–∏—Å–∫–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏ –¥–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
    const searchLower = searchTerm.toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
    if (word.character.toLowerCase().includes(searchLower)) return true;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∏–Ω—å–∏–Ω—å (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Ç–æ–Ω—ã)
    const pinyinClean = word.pinyin.toLowerCase().replace(/\s+/g, '').replace(/[ƒÅ√°«é√†]/g, 'a').replace(/[ƒì√©ƒõ√®]/g, 'e').replace(/[ƒ´√≠«ê√¨]/g, 'i').replace(/[≈ç√≥«í√≤]/g, 'o').replace(/[≈´√∫«î√π«ñ«ò«ö«ú]/g, 'u');
    const searchClean = searchLower.replace(/\s+/g, '').replace(/[ƒÅ√°«é√†]/g, 'a').replace(/[ƒì√©ƒõ√®]/g, 'e').replace(/[ƒ´√≠«ê√¨]/g, 'i').replace(/[≈ç√≥«í√≤]/g, 'o').replace(/[≈´√∫«î√π«ñ«ò«ö«ú]/g, 'u');
    
    if (pinyinClean.includes(searchClean)) return true;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
    if (word.translation.toLowerCase().includes(searchLower)) return true;
    
    return false;
});
    }
    
    currentWordsPage = 1;
    displayWords();
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ª–æ–≤
function filterWords() {
    const levelFilter = document.getElementById('wordsLevelFilter').value;
    const statusFilter = document.getElementById('wordsStatusFilter').value;
    
    filteredWords = allWords.filter(word => {
        // –§–∏–ª—å—Ç—Ä –ø–æ —É—Ä–æ–≤–Ω—é
        if (levelFilter !== 'all' && word.hsk_level !== parseInt(levelFilter)) {
            return false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
        const wordId = `${word.character}_${word.hsk_level}`;
        const wordStatus = userWordsStatus[wordId]?.status || 'new';
        
        if (statusFilter === 'saved' && wordStatus !== 'saved') return false;
        if (statusFilter === 'learned' && wordStatus !== 'learned') return false;
        if (statusFilter === 'new' && wordStatus !== 'new') return false;
        
        return true;
    });
    
    currentWordsPage = 1;
    displayWords();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤
function loadRandomWords() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    document.getElementById('wordsLevelFilter').value = 'all';
    document.getElementById('wordsStatusFilter').value = 'all';
    document.getElementById('wordsSearch').value = '';
    
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–ª–æ–≤–∞
    filteredWords = [...allWords].sort(() => Math.random() - 0.5);
    currentWordsPage = 1;
    displayWords();
    
    showNotification('üé≤ –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—é
async function loadWordsByLevel(level) {
    try {
        document.getElementById('wordsLevelFilter').value = level;
        document.getElementById('wordsStatusFilter').value = 'all';
        document.getElementById('wordsSearch').value = '';
        
        const response = await fetch(`${API_BASE}/words/level/${level}`);
        if (response.ok) {
            const data = await response.json();
            filteredWords = data.words || [];
        } else {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
            filteredWords = allWords.filter(word => word.hsk_level === level);
        }
        
        currentWordsPage = 1;
        displayWords();
        showNotification(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–ª–æ–≤–∞ HSK ${level}`);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤');
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª–æ–≤–∞
function toggleWordStatus(wordId, targetStatus) {
    console.log(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ${wordId} –Ω–∞ ${targetStatus}`);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
    const saved = localStorage.getItem(savedKey);
    if (saved) {
        userWordsStatus = JSON.parse(saved);
    }
    
    const currentStatus = userWordsStatus[wordId]?.status || 'new';
    
    if (currentStatus === targetStatus) {
        delete userWordsStatus[wordId];
        console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è ${wordId}`);
    } else {
        userWordsStatus[wordId] = {
            status: targetStatus,
            added_at: new Date().toISOString(),
            last_reviewed: new Date().toISOString()
        };
        console.log(`‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å ${targetStatus} –¥–ª—è ${wordId}`);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –¥–∞–Ω–Ω—ã–µ
    try {
        localStorage.setItem(savedKey, JSON.stringify(userWordsStatus));
        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage: ${Object.keys(userWordsStatus).length} —Å–ª–æ–≤`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        window.userWordsStatus = userWordsStatus;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        updateWordDisplay(wordId);
        updateWordsStats();
        
        showNotification('‚úÖ –°—Ç–∞—Ç—É—Å —Å–ª–æ–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω');
        
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
    }
}

function saveAllWordsStatus() {
    try {
        const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
        localStorage.setItem(savedKey, JSON.stringify(userWordsStatus));
        console.log(`üíæ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${Object.keys(userWordsStatus).length} —Å–ª–æ–≤`);
        showNotification('üíæ –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        return true;
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        return false;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ–≤–∞
function updateWordDisplay(wordId) {
    const wordCard = document.querySelector(`.word-card[data-word-id="${wordId}"]`);
    if (!wordCard) return;
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–ª–æ–≤–æ –≤ –º–∞—Å—Å–∏–≤–µ
    const word = allWords.find(w => `${w.character}_${w.hsk_level}` === wordId);
    if (!word) return;
    
    const wordStatus = userWordsStatus[wordId]?.status || 'new';
    const statusConfig = {
        'new': {icon: 'far fa-star', color: '#6c757d', text: '–î–æ–±–∞–≤–∏—Ç—å'},
        'saved': {icon: 'fas fa-bookmark', color: '#ffc107', text: '–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ'},
        'learned': {icon: 'fas fa-check-circle', color: '#28a745', text: '–ò–∑—É—á–µ–Ω–æ'}
    };
    
    const config = statusConfig[wordStatus] || statusConfig.new;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    const savedBtn = wordCard.querySelector('.word-actions button:nth-child(1)');
    const learnedBtn = wordCard.querySelector('.word-actions button:nth-child(2)');
    const statusDiv = wordCard.querySelector('.word-status');
    
    if (savedBtn) {
        savedBtn.innerHTML = `<i class="fas fa-bookmark"></i> ${wordStatus === 'saved' ? '–£–±—Ä–∞—Ç—å' : '–ü—Ä–æ–±–ª–µ–º–Ω–æ–µ'}`;
        savedBtn.style.color = wordStatus === 'saved' ? '#ffc107' : '#6c757d';
    }
    
    if (learnedBtn) {
        learnedBtn.innerHTML = `<i class="fas ${wordStatus === 'learned' ? 'fa-check-circle' : 'fa-circle'}"></i> ${wordStatus === 'learned' ? '–ù–µ –∏–∑—É—á–µ–Ω–æ' : '–ò–∑—É—á–µ–Ω–æ'}`;
        learnedBtn.style.color = wordStatus === 'learned' ? '#28a745' : '#6c757d';
    }
    
    if (statusDiv) {
        statusDiv.innerHTML = `<i class="${config.icon}"></i> ${config.text}`;
        statusDiv.style.background = config.color;
    }
}

function updateWordsStats() {
    const statsDiv = document.getElementById('wordsStats');
    if (!statsDiv) return;
    
    // –ü–†–û–í–ï–†–Ø–ï–ú: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—Ç–∞—Ç—É—Å—ã
    console.log('updateWordsStats: —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ø–∞–º—è—Ç–∏', Object.keys(userWordsStatus).length);
    console.log('updateWordsStats: —Å—Ç–∞—Ç—É—Å—ã', userWordsStatus);
    
    const totalWords = allWords.length;
    const learnedWords = Object.values(userWordsStatus).filter(s => {
        const hasStatus = s && s.status === 'learned';
        if (hasStatus) console.log('–ù–∞–π–¥–µ–Ω–æ –∏–∑—É—á–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ:', s);
        return hasStatus;
    }).length;
    
    const savedWords = Object.values(userWordsStatus).filter(s => {
        const hasStatus = s && s.status === 'saved';
        if (hasStatus) console.log('–ù–∞–π–¥–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ:', s);
        return hasStatus;
    }).length;
    
    console.log('updateWordsStats: –∏–∑—É—á–µ–Ω–æ', learnedWords, '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', savedWords);
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ currentUser –∏ target_level
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–æ—á–Ω–æ –∏ –±–µ–∑ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞
let progressPercentage = 0;
const learnedWordsCount = learnedWords;

if (currentUser && currentUser.target_level) {
    const targetWordsMap = {
        1: 150,
        2: 300,
        3: 600,
        4: 1200,
        5: 2500,
        6: 5000
    };
    const targetWords = targetWordsMap[currentUser.target_level] || 5000;

    progressPercentage = (learnedWordsCount / targetWords) * 100;
} else {
    // –î–ª—è –≥–æ—Å—Ç—è –∏–ª–∏ –±–µ–∑ —Ü–µ–ª–∏ ‚Äî —Å—á–∏—Ç–∞–µ–º –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–ª–æ–≤
    progressPercentage = (learnedWordsCount / totalWords) * 100;
}

// –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –¥–ª—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
progressPercentage = Math.round(progressPercentage * 10) / 10;  // –Ω–∞–ø—Ä–∏–º–µ—Ä: 0.2%, 1.8% –∏ —Ç.–¥.

// –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—å—à–µ 0 –∏ –±–æ–ª—å—à–µ 100
progressPercentage = Math.max(0, Math.min(100, progressPercentage));

// –ï—Å–ª–∏ 0 –∏–∑—É—á–µ–Ω–Ω—ã—Ö ‚Äî —è–≤–Ω–æ 0%
if (learnedWordsCount === 0) {
    progressPercentage = 0;
}
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    document.getElementById('totalWordsCount').textContent = totalWords;
    document.getElementById('learnedWordsCount').textContent = learnedWords;
    document.getElementById('savedWordsCount').textContent = savedWords;
    document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
    
    statsDiv.style.display = 'block';
}

// –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ–≤
async function startWordsTest() {
    const source = document.getElementById('testSource').value;
    const testType = document.getElementById('testType').value;
    const count = parseInt(document.getElementById('testCount').value) || 10;
    
    console.log('–¢–µ—Å—Ç:', source, testType, count);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–∞
    if (allWords.length === 0) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ª–æ–≤–∞!');
        return;
    }
    
    try {
        const testData = generateLocalTest(source, testType, count);
        
        if (!testData || testData.questions.length === 0) {
            alert('–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏!');
            return;
        }
        
        console.log('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–µ—Å—Ç:', testData);
        startTestSession(testData);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞: ' + error.message);
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ (fallback)
function generateLocalTest(source, testType, count) {
    // –£–ü–†–û–©–ï–ù–ù–ê–Ø –≤–µ—Ä—Å–∏—è:
    let testWords = [];
    
    if (source === 'all') {
        testWords = [...allWords];
    } else {
        testWords = allWords.filter(word => {
            const wordId = `${word.character}_${word.hsk_level}`;
            const wordStatus = userWordsStatus[wordId]?.status || 'new';
            return wordStatus === source;
        });
    }
    
    // –ë–µ—Ä–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞
    testWords = [...testWords].sort(() => Math.random() - 0.5).slice(0, count);
    
    // –°–æ–∑–¥–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
    const questions = testWords.map((word, index) => {
        const question = {
            id: `q${index}`,
            character: word.character,
            pinyin: word.pinyin,
            translation: typeof word.translation === 'string' ? word.translation : 
                        word.translation?.ru || word.translation?.en || '',
            correct: ''
        };
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞
        if (testType === 'pinyin_from_char') {
            question.prompt = `–ü–∏–Ω—å–∏–Ω—å –¥–ª—è: ${word.character}`;
            question.correct = word.pinyin;
        } else if (testType === 'char_from_pinyin') {
            question.prompt = `–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã –¥–ª—è: ${word.pinyin}`;
            question.correct = word.character;
        } else if (testType === 'translation_from_char') {
            question.prompt = `–ü–µ—Ä–µ–≤–æ–¥ –¥–ª—è: ${word.character}`;
            question.correct = typeof word.translation === 'string' ? word.translation : 
                              word.translation?.ru || word.translation?.en || '';
        } else if (testType === 'translation_from_pinyin') {
            question.prompt = `–ü–µ—Ä–µ–≤–æ–¥ –¥–ª—è: ${word.pinyin}`;
            question.correct = typeof word.translation === 'string' ? word.translation : 
                              word.translation?.ru || word.translation?.en || '';
        }
        
        return question;
    });
    
    return {
        test_id: `test_${Date.now()}`,
        questions: questions,
        total: questions.length,
        type: testType
    };
}

// –ó–∞–ø—É—Å–∫ —Å–µ—Å—Å–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function startTestSession(testData) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ—Å—Ç
    currentTest = testData;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É —Å–ª–æ–≤
    document.getElementById('words-tab').style.display = 'none';
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞
    createTestModal(testData);
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
function createTestModal(testData) {
    const modal = document.createElement('div');
    modal.id = 'testModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    const questionsHTML = testData.questions.map((q, index) => `
        <div class="test-question" style="margin-bottom: 25px;">
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                ${index + 1}. ${q.prompt}
            </div>
<input type="text" id="answer_${q.id}" 
       oninput="updateTestProgress()" 
       placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." 
       style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
            <div id="feedback_${q.id}" style="margin-top: 5px; font-size: 0.9em; display: none;"></div>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-graduation-cap"></i> –¢–µ—Å—Ç —Å–ª–æ–≤
                </h2>
                <button onclick="closeTestModal()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="testProgress">0/${testData.total}</span></span>
                    <span id="testScore">0%</span>
                </div>
                <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                    <div id="testProgressBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.3s;"></div>
                </div>
            </div>
            
            <div id="testQuestions" style="margin-bottom: 30px;">
                ${questionsHTML}
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="submitWordsTest()" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç
                </button>
                <button onclick="closeTestModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    setTimeout(() => {
        const firstInput = document.getElementById(`answer_${testData.questions[0]?.id}`);
        if (firstInput) firstInput.focus();
    }, 100);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—Å—Ç–µ
function checkTestAnswer(questionId, answer) {
    const question = currentTest.questions.find(q => q.id === questionId);
    if (!question) return;
    
    const feedbackDiv = document.getElementById(`feedback_${questionId}`);
    if (!feedbackDiv) return;
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Ä–µ–≥–∏—Å—Ç—Ä)
    const normalizedAnswer = answer.trim().toLowerCase();
    const normalizedCorrect = question.correct.trim().toLowerCase();
    
    if (normalizedAnswer === normalizedCorrect) {
        feedbackDiv.innerHTML = '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</span>';
        feedbackDiv.style.display = 'block';
    } else if (answer.length >= question.correct.length * 0.5) {
        feedbackDiv.innerHTML = '<span style="color: var(--warning);"><i class="fas fa-exclamation-circle"></i> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç</span>';
        feedbackDiv.style.display = 'block';
    } else {
        feedbackDiv.style.display = 'none';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    updateTestProgress();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ç–µ—Å—Ç–∞
function updateTestProgress() {
    if (!currentTest) return;
    
    let correct = 0;
    currentTest.questions.forEach(q => {
        const answerInput = document.getElementById(`answer_${q.id}`);
        if (normalizedUser === normalizedCorrect) {
    correct++;
} else if (testType === 'translation' || testType.includes('translation')) {
    // –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ —Ä–∞–∑–ª–∏—á–∏—è
    const userWords = normalizedUser.split(' ');
    const correctWords = normalizedCorrect.split(' ');
    const matchWords = userWords.filter(word => correctWords.includes(word));
    if (matchWords.length >= correctWords.length * 0.7) {
        correct++;
    }
}
    });
    
    const progress = document.getElementById('testProgress');
    const score = document.getElementById('testScore');
    const progressBar = document.getElementById('testProgressBar');
    
    if (progress) progress.textContent = `${correct}/${currentTest.total}`;
    if (score) score.textContent = `${Math.round((correct / currentTest.total) * 100)}%`;
    if (progressBar) progressBar.style.width = `${(correct / currentTest.total) * 100}%`;
}

async function submitWordsTest() {
    if (!currentTest || !currentTest.questions) {
        alert('–¢–µ—Å—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
    const answers = {};
    currentTest.questions.forEach(q => {
        const input = document.getElementById(`answer_${q.id}`);
        answers[q.id] = input ? input.value.trim() : '';
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const modalContent = document.querySelector('#testModal > div > div');
    modalContent.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
            <h3>–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã...</h3>
            <p>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
        </div>
    `;

    try {
        const response = await fetch(`${API_BASE}/words/test/check-ai`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: currentUser?.user_id || "guest",
                test_id: currentTest.test_id,
                questions: currentTest.questions,
                answers: answers
            })
        });

        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);

        const result = await response.json();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –ò–ò
        showTestResult(
            result.correct_count || 0,
            result.total || currentTest.questions.length,
            result.percentage || 0,
            result.results || [],
            result.summary || "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
        );

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ò–ò:', error);
        modalContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
                <h3>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                <p>–ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.</p>
                <button class="btn btn-primary" onclick="submitWordsTest()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
        `;
    }
}

function showTestResult(correct, total, percentage, detailedResults = [], summary = "") {
    const modalContent = document.querySelector('#testModal > div > div');

    let detailsHTML = "";
    if (detailedResults.length > 0) {
        detailsHTML = `<div style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
            <h4>–ü–æ–¥—Ä–æ–±–Ω–æ:</h4>
            ${detailedResults.map(r => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; background: ${r.is_correct ? '#e3f2fd' : '#fde8e8'};">
                    <strong>${r.prompt}</strong><br>
                    –í–∞—à –æ—Ç–≤–µ—Ç: <em>${r.user_answer}</em><br>
                    –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${r.is_correct ? '‚úì' : '‚úó'} ${r.feedback}
                </div>
            `).join('')}
        </div>`;
    }

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 4em; margin: 20px 0;">
                ${percentage >= 90 ? 'üéâ' : percentage >= 70 ? 'üëç' : 'üí™'}
            </div>
            <h2>${percentage >= 90 ? '–û—Ç–ª–∏—á–Ω–æ!' : percentage >= 70 ? '–•–æ—Ä–æ—à–æ!' : '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å!'}</h2>
            <div style="font-size: 3em; font-weight: bold; color: ${percentage >= 70 ? 'var(--success)' : 'var(--danger)'};">
                ${correct}/${total} (${percentage}%)
            </div>
            <div style="margin: 20px 0; color: var(--gray);">
                ${summary}
            </div>
            ${detailsHTML}
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="closeTestModal()">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button class="btn btn-secondary" onclick="startWordsTest()" style="margin-left: 10px;">
                    –ù–æ–≤—ã–π —Ç–µ—Å—Ç
                </button>
            </div>
        </div>
    `;
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞
function showTestResult(correct, total, percentage) {
    const modal = document.getElementById('testModal');
    if (!modal) return;
    
    const resultHTML = `
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 4em; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üéâ' : percentage >= 60 ? 'üëç' : 'üí™'}
            </div>
            
            <h2 style="color: ${percentage >= 80 ? 'var(--success)' : percentage >= 60 ? 'var(--warning)' : 'var(--danger)'}">
                ${percentage}% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            </h2>
            
            <div style="font-size: 2em; margin: 20px 0;">
                ${correct} –∏–∑ ${total}
            </div>
            
            <div style="margin: 20px 0;">
                ${percentage >= 80 ? 
                    '–û—Ç–ª–∏—á–Ω–æ! –í—ã —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—Ç–µ —ç—Ç–∏ —Å–ª–æ–≤–∞!' : 
                  percentage >= 60 ? 
                    '–•–æ—Ä–æ—à–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è!' : 
                    '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏! –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —ç—Ç–∏ —Å–ª–æ–≤–∞.'}
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeTestModal()" class="btn btn-primary">
                    <i class="fas fa-check"></i> –ó–∞–∫–æ–Ω—á–∏—Ç—å
                </button>
                <button onclick="retryTest()" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            </div>
        </div>
    `;
    
    const modalContent = modal.querySelector('div > div');
    if (modalContent) {
        modalContent.innerHTML = resultHTML;
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–µ—Å—Ç–∞
function closeTestModal() {
    const modal = document.getElementById('testModal');
    if (modal) {
        modal.remove();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É —Å–ª–æ–≤
    document.getElementById('words-tab').style.display = 'block';
}

// –ü–æ–≤—Ç–æ—Ä —Ç–µ—Å—Ç–∞
function retryTest() {
    closeTestModal();
    startTestSession(currentTest);
}

// –¢–µ—Å—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
function startReviewTest() {
    document.getElementById('testSource').value = 'learned';
    document.getElementById('testType').value = 'translation_from_char';
    startWordsTest();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateUserProgress() {
    if (!currentUser) return;
    
    const learnedWords = Object.values(userWordsStatus).filter(s => s.status === 'learned').length;
    const targetLevel = currentUser.target_level || 4;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const targetWords = {
        1: 150, 2: 300, 3: 600, 4: 1200, 5: 2500, 6: 5000
    }[targetLevel] || 1000;
    
    const progressPercentage = Math.min(100, Math.round((learnedWords / targetWords) * 100));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
    updateProgressDisplay(progressPercentage, learnedWords, targetWords, targetLevel);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ü—Ä–æ–≥—Ä–µ—Å—Å"
function updateProgressDisplay(percentage, learned, target, level) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const progressElements = document.querySelectorAll('.progress-percentage');
    const learnedElements = document.querySelectorAll('.learned-words');
    const targetElements = document.querySelectorAll('.target-words');
    
    progressElements.forEach(el => {
        el.textContent = `${percentage}%`;
        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        const progressBar = el.closest('.progress-container')?.querySelector('.progress-bar-fill');
        if (progressBar) {
            progressBar.style.width = `${percentage}%`;
            progressBar.style.background = percentage >= 80 ? 'var(--success)' : 
                                          percentage >= 60 ? 'var(--warning)' : 'var(--danger)';
        }
    });
    
    learnedElements.forEach(el => {
        el.textContent = learned;
    });
    
    targetElements.forEach(el => {
        el.textContent = target;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç
    const levelElement = document.getElementById('currentTargetLevel');
    if (levelElement) {
        levelElement.textContent = level;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    updateProgressChart(percentage);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgressChart(percentage) {
    const chart = document.getElementById('progressChart');
    if (!chart) return;
    
    // –ü—Ä–æ—Å—Ç–∞—è –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
    chart.innerHTML = `
        <div style="position: relative; width: 200px; height: 200px; margin: 0 auto;">
            <canvas id="progressCanvas" width="200" height="200"></canvas>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: var(--primary);">${percentage}%</div>
                <div style="font-size: 0.9em; color: var(--gray);">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
        </div>
    `;
    
    // –†–∏—Å—É–µ–º –∫—Ä—É–≥–ª—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
    const canvas = document.getElementById('progressCanvas');
    if (canvas && canvas.getContext) {
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;
        
        // –§–æ–Ω
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fillStyle = '#e9ecef';
        ctx.fill();
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å
        const endAngle = (percentage / 100) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, -Math.PI / 2, endAngle - Math.PI / 2);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = percentage >= 80 ? 'var(--success)' : 
                        percentage >= 60 ? 'var(--warning)' : 'var(--danger)';
        ctx.fill();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ...
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ —Å–ª–æ–≤ –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const wordsTab = document.getElementById('words-tab');
    if (wordsTab) {
        initWordsTab();
    }
});

// –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
async function analyzePronunciation(text) {
    try {
        const response = await fetch(`${API_BASE}/ai/pronunciation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                user_id: currentUser?.user_id || null
            })
        });
        
        const data = await response.json();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è –≤ –¥–µ—Ç–∞–ª–∏
        const detailsDiv = document.getElementById('translationDetails');
        const pronunciationHTML = `
            <div class="word-card" style="margin-top: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--accent);">
                    <i class="fas fa-volume-up"></i> –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è:
                </div>
                ${data.tones ? `<div><strong>–¢–æ–Ω–∞:</strong> ${data.tones}</div>` : ''}
                ${data.difficult_sounds ? `<div><strong>–°–ª–æ–∂–Ω—ã–µ –∑–≤—É–∫–∏:</strong> ${data.difficult_sounds}</div>` : ''}
                ${data.pronunciation_tips ? `<div><strong>–°–æ–≤–µ—Ç—ã:</strong> ${data.pronunciation_tips}</div>` : ''}
                ${data.common_errors ? `<div><strong>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:</strong> ${data.common_errors}</div>` : ''}
            </div>
        `;
        
        detailsDiv.innerHTML = pronunciationHTML + detailsDiv.innerHTML;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è:', error);
    }
}

// –ù–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–æ–≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
function getExerciseTypeName(type) {
    const names = {
        'fill_in_blanks': '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫–∏',
        'matching': '–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ',
        'word_order': '–ü–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤',
        'translation_exercise': '–ü–µ—Ä–µ–≤–æ–¥',
        'writing_practice': '–ü–∏—Å—å–º–µ–Ω–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞',
        'conversation_topics': '–¢–µ–º—ã –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞'
    };
    return names[type] || type;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
async function loadTranslationHistory() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/ai/translation-history/${currentUser.user_id}`);
        const data = await response.json();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π
        if (data.history && data.history.length > 0) {
            const historyHTML = `
                <div class="word-card" style="margin-top: 20px;">
                    <h4><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${data.history.map(item => `
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6;">
                                <div style="font-weight: bold;">${item.original}</div>
                                <div style="font-size: 0.9em; color: var(--gray);">${item.translation}</div>
                                <div style="font-size: 0.8em; color: var(--gray);">${formatDate(item.timestamp)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const progressContent = document.getElementById('progressContent');
            if (progressContent) {
                progressContent.innerHTML += historyHTML;
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
function updateCurrentChat() {
    const chat = userChats.find(c => c.thread_id === currentChatId);
    if (!chat) return;
    
    const newTitle = document.getElementById('chatTitleInput').value.trim();
    const newCategory = document.getElementById('chatCategory').value;
    
    if (newTitle) {
        chat.title = newTitle;
        chat.category = newCategory;
        chat.updated_at = new Date().toISOString();
        
        renderChatList();
        saveChatsLocally();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        updateChatOnServer(chat);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
async function updateChatOnServer(chat) {
    try {
        await fetch(`${API_BASE}/chat/threads/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                thread_id: chat.thread_id,
                title: chat.title,
                category: chat.category
            })
        });
    } catch (error) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
function deleteCurrentChat() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–∞.')) return;
    
    const chatIndex = userChats.findIndex(c => c.thread_id === currentChatId);
    if (chatIndex > -1) {
        userChats.splice(chatIndex, 1);
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
        if (userChats.length > 0) {
            currentChatId = userChats[0].thread_id;
            loadChatMessages(currentChatId);
        } else {
            createNewChat();
        }
        
        renderChatList();
        saveChatsLocally();
        
        // –£–¥–∞–ª—è–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        deleteChatOnServer(currentChatId);
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
async function deleteChatOnServer(chatId) {
    try {
        await fetch(`${API_BASE}/chat/threads/delete/${chatId}`, {
            method: 'DELETE'
        });
    } catch (error) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
    }
}
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    const targetTab = document.getElementById(`${tabName}-tab`);
    targetTab.classList.add('active');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
    document.querySelectorAll('.tab').forEach(tab => {
        if (tab.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1))) {
            tab.classList.add('active');
        }
    });

    
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    if (tabName === 'words') {
        loadRandomWords();
    } else if (tabName === 'progress') {
        loadProgress();
    } else if (tabName === 'grammar') {
        loadGrammarTopics();
    } else if (tabName === 'voice-chat') {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        if (!voiceRecognition) {
            setTimeout(initVoiceChat, 100);
        }
    } else if (tabName === 'text-generator') {
        loadTextHistory(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        document.getElementById('textResultSection').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    } else if (tabName === 'essay-checker') {
        initEssayChecker();
    } else if (tabName === 'essay-analysis') {
        initEssayAnalysis();
    }
}
        
        // –ë—ã—Å—Ç—Ä—ã–π –≤–æ–ø—Ä–æ—Å
        function quickQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage();
}
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // –°–æ–∑–¥–∞—ë–º —á–∞—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!currentChatId || userChats.length === 0) {
        await createNewChat();
    }
    
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
    let chat = userChats.find(c => c.thread_id === currentChatId);
    if (!chat) {
        // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        chat = createLocalChat();
    }
    
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ messages —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!chat.messages) {
        chat.messages = [];
    }
    
    console.log('–î–æ–±–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç:', chat.thread_id);
    console.log('–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', chat.messages.length);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat.messages.push({
        role: "user",
        content: message,
        timestamp: new Date().toISOString()
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    input.value = '';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É
    saveChatsLocally();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingMsg = addMessage('ü§ñ AI –¥—É–º–∞–µ—Ç...', 'ai');
    
    try {
        let aiResponse = "–Ø –ø–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã!";
        
        if (currentUser) {
            try {
                const response = await fetch(`${API_BASE}/chat/${currentChatId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: currentUser.user_id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    aiResponse = data.response;
                }
            } catch (error) {
                console.log('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç');
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI
        chat.messages.push({
            role: "assistant",
            content: aiResponse,
            timestamp: new Date().toISOString()
        });
        
        chat.updated_at = new Date().toISOString();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç —Å –æ—Ç–≤–µ—Ç–æ–º
        saveChatsLocally();
        
        // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        loadingMsg.remove();
        addMessage(aiResponse, 'ai');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        loadingMsg.remove();
        addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.', 'ai');
    }
}
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(text, sender) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = `<div class="ai-label">ü§ñ AI –†–µ–ø–µ—Ç–∏—Ç–æ—Ä:</div>${text}`;
            } else {
                messageDiv.textContent = text;
            }
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            return messageDiv;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤
        async function loadRandomWords() {
            showLoading('wordsList', '–ó–∞–≥—Ä—É–∂–∞—é —Å–ª–æ–≤–∞...');
            
            try {
                const response = await fetch(`${API_BASE}/word/random`);
                const data = await response.json();
                
                const wordsList = document.getElementById('wordsList');
                wordsList.innerHTML = '';
                
                // –û—Å–Ω–æ–≤–Ω–æ–µ —Å–ª–æ–≤–æ
                const word = data.word;
                const wordCard = createWordCard(word, data.memory_tip);
                wordsList.appendChild(wordCard);
                
                // –ü–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞
                if (data.similar_words && data.similar_words.length > 0) {
                    const similarHeader = document.createElement('div');
                    similarHeader.innerHTML = '<h3 style="margin: 20px 0 10px 0; color: var(--primary);"><i class="fas fa-link"></i> –ü–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞:</h3>';
                    wordsList.appendChild(similarHeader);
                    
                    data.similar_words.forEach(similar => {
                        const similarCard = document.createElement('div');
                        similarCard.className = 'word-card';
                        similarCard.style.borderLeftColor = 'var(--warning)';
                        similarCard.innerHTML = `
                            <div class="word-header">
                                <div class="word-character">${similar.character}</div>
                            </div>
                            <div class="word-pinyin">${similar.pinyin}</div>
                            <div class="word-translation">${similar.translation}</div>
                        `;
                        wordsList.appendChild(similarCard);
                    });
                }
                
                // –°–æ–≤–µ—Ç—ã –ø–æ –∏–∑—É—á–µ–Ω–∏—é
                if (data.study_suggestions) {
                    const tipsDiv = document.createElement('div');
                    tipsDiv.className = 'word-tip';
                    tipsDiv.style.marginTop = '20px';
                    tipsDiv.innerHTML = `
                        <strong><i class="fas fa-lightbulb"></i> –°–æ–≤–µ—Ç—ã –ø–æ –∏–∑—É—á–µ–Ω–∏—é:</strong><br>
                        ${data.study_suggestions.map(tip => `‚Ä¢ ${tip}`).join('<br>')}
                    `;
                    wordsList.appendChild(tipsDiv);
                }
            } catch (error) {
                document.getElementById('wordsList').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤</p>
                    </div>
                `;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—é
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—é - –í–°–ï —Å–ª–æ–≤–∞
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—é - –í–°–ï —Å–ª–æ–≤–∞ (–¢–ê–ë–õ–ò–¶–ê)
async function loadWordsByLevel(level) {
    showLoading('wordsList', `–ó–∞–≥—Ä—É–∂–∞—é –≤—Å–µ —Å–ª–æ–≤–∞ HSK ${level}...`);
    
    try {
        const response = await fetch(`${API_BASE}/words/level/${level}?limit=10000`);
        const data = await response.json();
        
        const wordsList = document.getElementById('wordsList');
        wordsList.innerHTML = '';
        
        if (data.words && data.words.length > 0) {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            const header = document.createElement('div');
            header.innerHTML = `
                <div class="section-header" style="margin-bottom: 20px;">
                    <h2><i class="fas fa-list"></i> –í—Å–µ —Å–ª–æ–≤–∞ HSK ${level}</h2>
                    <span class="word-level">${data.total} —Å–ª–æ–≤</span>
                </div>
            `;
            wordsList.appendChild(header);
            
            // –¢–∞–±–ª–∏—Ü–∞
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: var(--primary); color: white;">
                        <th style="padding: 12px; text-align: left; width: 15%;">–ò–µ—Ä–æ–≥–ª–∏—Ñ</th>
                        <th style="padding: 12px; text-align: left; width: 25%;">–ü–∏–Ω—å–∏–Ω—å</th>
                        <th style="padding: 12px; text-align: left; width: 50%;">–ü–µ—Ä–µ–≤–æ–¥</th>
                        <th style="padding: 12px; text-align: center; width: 10%;">–£—Ä–æ–≤–µ–Ω—å</th>
                    </tr>
                </thead>
                <tbody id="wordsTableBody">
                </tbody>
            `;
            
            wordsList.appendChild(table);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            const tbody = document.getElementById('wordsTableBody');
            data.words.forEach((word, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                row.style.backgroundColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                row.innerHTML = `
                    <td style="padding: 10px; font-size: 1.4em; font-weight: bold;">${word.character}</td>
                    <td style="padding: 10px; color: var(--danger);">${word.pinyin || ''}</td>
                    <td style="padding: 10px;">${word.translation || ''}</td>
                    <td style="padding: 10px; text-align: center;">
                        <span class="word-level" style="display: inline-block;">HSK ${word.hsk_level || 1}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const pagination = document.createElement('div');
            pagination.style.marginTop = '20px';
            pagination.style.textAlign = 'center';
            pagination.innerHTML = `
                <p>–ü–æ–∫–∞–∑–∞–Ω–æ ${data.count} –∏–∑ ${data.total} —Å–ª–æ–≤</p>
            `;
            wordsList.appendChild(pagination);
            
        } else {
            wordsList.innerHTML = '<p>üì≠ –°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        document.getElementById('wordsList').innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤</p>
                <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 10px;">
                    <i class="fas fa-redo"></i> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            </div>
        `;
    }
}
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–æ–≤–∞
        function createWordCard(word, tip = null) {
            const card = document.createElement('div');
            card.className = 'word-card';
            
            card.innerHTML = `
                <div class="word-header">
                    <div class="word-character">${word.character}</div>
                    <div class="word-level">HSK ${word.hsk_level || 1}</div>
                </div>
                <div class="word-pinyin">${word.pinyin || ''}</div>
                <div class="word-translation">${word.translation || ''}</div>
                ${tip ? `<div class="word-tip"><i class="fas fa-lightbulb"></i> ${tip}</div>` : ''}
            `;
            
            return card;
        }
        
        // –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞
        async function startTest(level) {
            showLoading('testContainer', `–°–æ–∑–¥–∞—é —Ç–µ—Å—Ç HSK ${level}...`);
            
            try {
                const response = await fetch(`${API_BASE}/test/${level}?questions=5`);
                currentTest = await response.json();
                testAnswers = {};
                
                displayTest(currentTest);
            } catch (error) {
                document.getElementById('testContainer').innerHTML = `
                    <div class="loading">
                        <p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞</p>
                        <button class="btn btn-primary" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                `;
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
        function displayTest(test) {
            const container = document.getElementById('testContainer');
            let html = `
                <div class="test-intro">
                    <h3><i class="fas fa-graduation-cap"></i> –¢–µ—Å—Ç HSK ${test.level}</h3>
                    <p>–í–æ–ø—Ä–æ—Å–æ–≤: ${test.total_questions} | –í—Ä–µ–º—è: ${test.time_limit}</p>
                    
                    <div class="word-tip" style="margin: 15px 0;">
                        <strong><i class="fas fa-tips"></i> –õ–∞–π—Ñ—Ö–∞–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∞:</strong><br>
                        ${test.test_hacks.map(hack => `‚Ä¢ ${hack}`).join('<br>')}
                    </div>
                    
                    <div id="testQuestions">
            `;
            
            test.questions.forEach((question, index) => {
                html += `
                    <div class="test-question" id="question-${question.id}">
                        <h4>–í–æ–ø—Ä–æ—Å ${index + 1}: ${question.question}</h4>
                        <div class="test-options">
                `;
                
                question.options.forEach((option, optIndex) => {
                    html += `
                        <div class="test-option" 
                             onclick="selectAnswer('${question.id}', ${optIndex})"
                             id="option-${question.id}-${optIndex}">
                            ${String.fromCharCode(65 + optIndex)}) ${option}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="submitTest()" style="width: 100%;">
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
                        </button>
                        <button class="btn btn-secondary" onclick="resetTest()" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-redo"></i> –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞
        function selectAnswer(questionId, optionIndex) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            const questionDiv = document.getElementById(`question-${questionId}`);
            questionDiv.querySelectorAll('.test-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            const selectedOption = document.getElementById(`option-${questionId}-${optionIndex}`);
            selectedOption.classList.add('selected');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
            testAnswers[questionId] = optionIndex;
        }
        async function saveWordProgress(wordId, remembered = true, difficulty = 3) {
    if (!currentUser) {
        alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å!');
        showLoginForm();
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/review`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUser.user_id,
                word_id: wordId,
                difficulty: difficulty,
                remembered: remembered
            })
        });
        
        if (response.ok) {
            console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ Progress –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
            if (document.getElementById('progress-tab').classList.contains('active')) {
                setTimeout(() => loadProgress(), 500); // –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫
            }
        }
    } catch (error) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        const localProgress = JSON.parse(localStorage.getItem('hsk_word_progress') || '{}');
        localProgress[wordId] = {
            remembered: remembered,
            difficulty: difficulty,
            last_reviewed: new Date().toISOString()
        };
        localStorage.setItem('hsk_word_progress', JSON.stringify(localProgress));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ Progress –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
        if (document.getElementById('progress-tab').classList.contains('active')) {
            showLocalProgress();
        }
    }
}
// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–∞
async function submitTest() {
    if (!currentTest || Object.keys(testAnswers).length === 0) {
        alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã!');
        return;
    }
    
    showLoading('testContainer', '–ü—Ä–æ–≤–µ—Ä—è—é –æ—Ç–≤–µ—Ç—ã...');
    
    try {
        // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const userId = currentUser ? currentUser.user_id : await getOrCreateUser();
        
        const response = await fetch(`${API_BASE}/submit_test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                test_id: currentTest.test_id,
                answers: testAnswers
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        displayTestResults(result);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞:', error);
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º –µ–≥–æ
        if (error.message.includes('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')) {
            alert('–°–æ–∑–¥–∞—é –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            localStorage.removeItem('hsk_user_id'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID
            submitTest(); // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            return;
        }
        
        document.getElementById('testContainer').innerHTML = `
            <div class="loading">
                <p>‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞</p>
                <p style="font-size: 0.9em; margin-top: 10px;">${error.message}</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="resetTest()">
                        <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <button class="btn btn-secondary" onclick="switchTab('test')" style="margin-left: 10px;">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        `;
    }
}

async function startTest(level) {
    showLoading('testContainer', `–ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç HSK ${level}...`);
    
    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        const response = await fetch(`${API_BASE}/hsk/generate-test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                level: level,
                test_type: "reduced",
                user_id: currentUser?.user_id || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        currentHskTest = await response.json();
        console.log("–ü–æ–ª—É—á–µ–Ω —Ç–µ—Å—Ç:", currentHskTest); // –î–õ–Ø –û–¢–õ–ê–î–ö–ò
        console.log("–°–µ–∫—Ü–∏–∏:", currentHskTest.sections); // –î–õ–Ø –û–¢–õ–ê–î–ö–ò
        testTimeLeft = currentHskTest.time_limits?.total_minutes * 60 || 1800;
        
        displayFullTest(currentHskTest);
        startTestTimer();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞:', error);
        document.getElementById('testContainer').innerHTML = `
            <div class="loading">
                <p>‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞</p>
                <button class="btn btn-primary" onclick="startTest(${level})">
                    <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}

function displayFullTest(test) {
    const container = document.getElementById('testContainer');
    
    let html = `
        <div class="test-header" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border-radius: 15px;">
            <h2 style="margin-bottom: 10px;">
                <i class="fas fa-graduation-cap"></i> –¢–µ—Å—Ç HSK ${test.level}
                <span class="word-level" style="background: white; color: var(--primary); margin-left: 10px;">
                    ${test.type === 'reduced' ? '–£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π' : '–ü–æ–ª–Ω—ã–π'}
                </span>
            </h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold;" id="testTimer">${formatTime(testTimeLeft)}</div>
                    <div style="font-size: 0.9em;">–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.2em;">ID: ${test.test_id}</div>
                    <div style="font-size: 0.9em;">–ú–∞–∫—Å–∏–º—É–º: 300 –±–∞–ª–ª–æ–≤</div>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="switchTestSection('listening')" style="margin-right: 10px;">
                <i class="fas fa-headphones"></i> –ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
            <button class="btn btn-success" onclick="switchTestSection('reading')" style="margin-right: 10px;">
                <i class="fas fa-book"></i> –ß—Ç–µ–Ω–∏–µ
            </button>
            <button class="btn btn-warning" onclick="switchTestSection('writing')" ${test.level <= 2 ? 'disabled' : ''}>
                <i class="fas fa-pen"></i> –ü–∏—Å—å–º–æ
            </button>
            <button class="btn btn-danger" onclick="switchTestSection('speaking')">
                <i class="fas fa-microphone"></i> –ì–æ–≤–æ—Ä–µ–Ω–∏–µ
            </button>
        </div>
        
        <div id="testContent">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–µ—Å—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn btn-success" onclick="submitFullTest()" style="padding: 15px 30px; font-size: 1.1em;">
                <i class="fas fa-paper-plane"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç
            </button>
            <button class="btn btn-secondary" onclick="resetTestTimer()" style="margin-left: 10px;">
                <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä
            </button>
        </div>
    `;
    
    container.innerHTML = html;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å–µ–∫—Ü–∏—é
    switchTestSection('listening');
}

function switchTestSection(section) {
    const testContent = document.getElementById('testContent');
    
    if (!currentHskTest || !currentHskTest.sections || !currentHskTest.sections[section]) {
        testContent.innerHTML = `<p>–°–µ–∫—Ü–∏—è ${section} –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞</p>`;
        return;
    }
    
    const sectionData = currentHskTest.sections[section];
    
    let sectionHtml = `
        <div class="section-header" style="margin-bottom: 20px;">
            <h3 style="color: var(--primary);">
                ${section === 'listening' ? 'üéß' : 
                  section === 'reading' ? 'üìñ' : 
                  section === 'writing' ? '‚úçÔ∏è' : 'üé§'} 
                ${sectionData.section_name || section}
                <span class="word-level" style="font-size: 0.8em;">${sectionData.total_score || 0} –±–∞–ª–ª–æ–≤</span>
            </h3>
            <p>${sectionData.instructions || '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏—è:'}</p>
            <p style="font-size: 0.9em; color: var(--gray);">
                –í–æ–ø—Ä–æ—Å–æ–≤: ${sectionData.count || (sectionData.questions?.length || sectionData.tasks?.length || 0)}
            </p>
        </div>
    `;
    
    if (section === 'speaking') {
        // –°–µ–∫—Ü–∏—è –≥–æ–≤–æ—Ä–µ–Ω–∏—è
        sectionHtml += displaySpeakingSection(sectionData);
    } else if (section === 'writing') {
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø–∏—Å—å–º–∞
        const hasWritingContent = sectionData.questions || sectionData.tasks;
        const writingCount = sectionData.questions?.length || sectionData.tasks?.length || 0;
        
        if (hasWritingContent && writingCount > 0) {
            sectionHtml += displayWritingSection(sectionData);
        } else {
            sectionHtml += `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4em; color: var(--warning);">‚úçÔ∏è</div>
                    <h3>–ü–∏—Å—å–º–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å</h3>
                    <p>${sectionData.instructions || '–ó–∞–¥–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'}</p>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ</p>
                </div>
            `;
        }
    } else {
        // –°–µ–∫—Ü–∏–∏ –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —á—Ç–µ–Ω–∏—è
        sectionHtml += displayListeningReadingSection(sectionData, section);
    }
    
    testContent.innerHTML = sectionHtml;
}

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è displayListeningReadingSection
function displayListeningReadingSection(sectionData, sectionType) {
    console.log("Section data:", sectionData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    
    let html = '';
    
    // –ù–û–í–´–ô –§–û–†–ú–ê–¢: questions –≤–º–µ—Å—Ç–æ parts
    if (sectionData.questions && Array.isArray(sectionData.questions)) {
        sectionData.questions.forEach((question, qIndex) => {
            const questionId = question.id || `${sectionType[0]}${qIndex+1}`;
            
            html += `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: ${qIndex < sectionData.questions.length - 1 ? '1px solid #dee2e6' : 'none'}">
                    <div style="font-weight: bold; margin-bottom: 10px;">
                        ${qIndex + 1}. ${question.question || '–í–æ–ø—Ä–æ—Å'}
                    </div>
                    
                    ${question.text ? `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 1.1em;">
                            ${question.text}
                        </div>
                    ` : ''}
                    
                    ${question.options && question.options.length > 0 ? `
                        <div class="test-options">
                            ${question.options.map((option, optIndex) => `
                                <div class="test-option" 
                                     onclick="selectTestAnswer('${questionId}', ${optIndex})" 
                                     id="${questionId}_option_${optIndex}">
                                    ${String.fromCharCode(65 + optIndex)}) ${option}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞</p>'}
                    
                    ${question.audio_text && sectionType === 'listening' ? `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="playAudio('${question.audio_text}')" style="font-size: 0.9em;">
                                <i class="fas fa-play"></i> –ü—Ä–æ–∏–≥—Ä–∞—Ç—å –∞—É–¥–∏–æ
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    } else {
        // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        html += '<p>–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</p>';
    }
    
    return html;
}

function displayWritingSection(sectionData) {
    let html = '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö
    const questions = sectionData.questions || sectionData.tasks || [];
    
    if (!questions || questions.length === 0) {
        return `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 4em; color: var(--gray);">‚úçÔ∏è</div>
                <h3>–ü–∏—Å—å–º–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                <p>–î–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è HSK –ø–∏—Å—å–º–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞</p>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å HSK 3 –∏–ª–∏ –≤—ã—à–µ</p>
            </div>
        `;
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å/–∑–∞–¥–∞–Ω–∏–µ
    questions.forEach((question, qIndex) => {
        const questionId = question.id || `W${qIndex+1}`;
        
        html += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: ${qIndex < questions.length - 1 ? '1px solid #dee2e6' : 'none'}">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">
                        <i class="fas fa-pen"></i> –ó–∞–¥–∞–Ω–∏–µ ${qIndex + 1}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> ${question.task || question.text || '–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç:'}
                    </div>
                    
                    ${question.requirements ? `
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong> ${question.requirements}
                        </div>
                    ` : ''}
                    
                    ${question.word_limit ? `
                        <div style="color: var(--gray); margin-bottom: 15px;">
                            <i class="fas fa-ruler"></i> –û–±—ä–µ–º: ${question.word_limit} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            –í–∞—à –æ—Ç–≤–µ—Ç:
                        </label>
                        <textarea id="${questionId}_answer" 
                                  style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif;"
                                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."></textarea>
                    </div>
                    
                    ${question.example_response || question.example ? `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary);">
                                <i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞
                            </summary>
                            <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                                ${question.example_response || question.example}
                            </div>
                        </details>
                    ` : ''}
                    
                    ${question.evaluation_criteria ? `
                        <div style="margin-top: 15px;">
                            <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                ${question.evaluation_criteria.map(criteria => `
                                    <li>${criteria}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    return html;
}

function displaySpeakingSection(sectionData) {
    let html = '';
    
    sectionData.tasks.forEach((task, taskIndex) => {
        html += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--danger);">
                    –ó–∞–¥–∞–Ω–∏–µ ${taskIndex + 1}
                    <span style="float: right; font-size: 0.9em;">
                        –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: ${task.preparation_time} | –û—Ç–≤–µ—Ç: ${task.speaking_time}
                    </span>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> ${task.task}
                </div>
                
                ${task.keywords ? `
                    <div style="margin-bottom: 15px;">
                        <strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            ${task.keywords.split(',').map(kw => `
                                <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 15px; font-size: 0.9em;">
                                    ${kw.trim()}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-bottom: 15px;">
                    <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong>
                    <ul style="margin-top: 5px; padding-left: 20px;">
                        ${task.evaluation_criteria?.map(criteria => `
                            <li>${criteria}</li>
                        `).join('') || '<li>–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ</li><li>–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</li><li>–°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å</li>'}
                    </ul>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="startRecording(${taskIndex})" id="recordBtn${taskIndex}">
                        <i class="fas fa-microphone"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <button class="btn btn-secondary" onclick="stopRecording(${taskIndex})" id="stopBtn${taskIndex}" style="display: none; margin-left: 10px;">
                        <i class="fas fa-stop"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <button class="btn btn-primary" onclick="playRecording(${taskIndex})" id="playBtn${taskIndex}" style="display: none; margin-left: 10px;">
                        <i class="fas fa-play"></i> –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
                    </button>
                </div>
                
                <div id="recordingStatus${taskIndex}" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="recordingProgress${taskIndex}" style="width: 0%"></div>
                    </div>
                    <div id="recordingTime${taskIndex}" style="text-align: center; margin-top: 5px; font-size: 0.9em;">
                        0:00 / ${task.speaking_time}
                    </div>
                </div>
                
                ${task.example ? `
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: var(--primary);">
                            <i class="fas fa-volume-up"></i> –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞
                        </summary>
                        <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong><br>
                            ${task.example}
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
    });
    
    return html;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
function startTestTimer() {
    clearInterval(testTimer);
    testTimer = setInterval(() => {
        testTimeLeft--;
        updateTimerDisplay();
        
        if (testTimeLeft <= 0) {
            clearInterval(testTimer);
            alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ! –¢–µ—Å—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
            submitFullTest();
        }
    }, 1000);
}

function resetTestTimer() {
    if (currentHskTest) {
        testTimeLeft = currentHskTest.time_limits?.total_minutes * 60 || 1800;
        startTestTimer();
    }
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('testTimer');
    if (timerElement) {
        timerElement.textContent = formatTime(testTimeLeft);
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
        if (testTimeLeft < 300) { // 5 –º–∏–Ω—É—Ç
            timerElement.style.color = 'var(--danger)';
        } else if (testTimeLeft < 600) { // 10 –º–∏–Ω—É—Ç
            timerElement.style.color = 'var(--warning)';
        }
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ
let mediaRecorder = null;
let audioChunks = [];
let recordingTaskIndex = null;
let recordingStartTime = null;
let recordingTimer = null;

async function startRecording(taskIndex) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—É–¥–∏–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            currentHskTest.sections.speaking.tasks[taskIndex].audioBlob = audioBlob;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
            document.getElementById(`playBtn${taskIndex}`).style.display = 'inline-block';
        };
        
        mediaRecorder.start();
        recordingTaskIndex = taskIndex;
        recordingStartTime = Date.now();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        document.getElementById(`recordBtn${taskIndex}`).style.display = 'none';
        document.getElementById(`stopBtn${taskIndex}`).style.display = 'inline-block';
        document.getElementById(`recordingStatus${taskIndex}`).style.display = 'block';
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏
        startRecordingTimer(taskIndex);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    }
}

function stopRecording(taskIndex) {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimer);
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        document.getElementById(`recordBtn${taskIndex}`).style.display = 'inline-block';
        document.getElementById(`stopBtn${taskIndex}`).style.display = 'none';
        document.getElementById(`recordingStatus${taskIndex}`).style.display = 'none';
    }
}

function startRecordingTimer(taskIndex) {
    const maxTime = parseTimeToSeconds(currentHskTest.sections.speaking.tasks[taskIndex].speaking_time);
    let elapsed = 0;
    
    recordingTimer = setInterval(() => {
        elapsed++;
        const progress = (elapsed / maxTime) * 100;
        
        document.getElementById(`recordingProgress${taskIndex}`).style.width = `${Math.min(progress, 100)}%`;
        document.getElementById(`recordingTime${taskIndex}`).textContent = 
            `${formatTime(elapsed)} / ${currentHskTest.sections.speaking.tasks[taskIndex].speaking_time}`;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
        if (elapsed >= maxTime) {
            stopRecording(taskIndex);
        }
    }, 1000);
}

function parseTimeToSeconds(timeStr) {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º "1 –º–∏–Ω—É—Ç–∞" –∏–ª–∏ "90 —Å–µ–∫—É–Ω–¥" –≤ —Å–µ–∫—É–Ω–¥—ã
    const match = timeStr.match(/(\d+)\s*(—Å–µ–∫—É–Ω–¥|–º–∏–Ω—É—Ç)/);
    if (match) {
        const num = parseInt(match[1]);
        const unit = match[2];
        return unit === '–º–∏–Ω—É—Ç' ? num * 60 : num;
    }
    return 60; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 —Å–µ–∫—É–Ω–¥
}

function playRecording(taskIndex) {
    if (currentHskTest.sections.speaking.tasks[taskIndex].audioBlob) {
        const audioUrl = URL.createObjectURL(currentHskTest.sections.speaking.tasks[taskIndex].audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();
    }
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ playAudio –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤:
function playAudio(text) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Speech API
    if ('speechSynthesis' in window) {
        // –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        // –í—ã–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh') || voice.lang.startsWith('cmn')
        );
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        utterance.onstart = () => {
            console.log('–ù–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ');
        };
        
        utterance.onend = () => {
            console.log('–ö–æ–Ω–µ—Ü –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ');
        };
        
        utterance.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', event);
            // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
            showAudioText(text);
        };
        
        speechSynthesis.speak(utterance);
    } else {
        // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        showAudioText(text);
    }
}

function showAudioText(text) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –∞—É–¥–∏–æ
    const audioDiv = document.createElement('div');
    audioDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 80%;
        text-align: center;
    `;
    
    audioDiv.innerHTML = `
        <h3>–¢–µ–∫—Å—Ç –¥–ª—è –∞—É–¥–∏–æ:</h3>
        <div style="font-size: 1.5em; margin: 15px 0;">${text}</div>
        <button onclick="this.parentElement.remove()" class="btn btn-primary">
            –ó–∞–∫—Ä—ã—Ç—å
        </button>
    `;
    
    document.body.appendChild(audioDiv);
}

// –î–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫–∏
function showImagePlaceholder(description) {
    // –°–æ–∑–¥–∞–µ–º placeholder –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
    const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4cd964', '#ff9a00'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    
    return `
        <div style="text-align: center; margin: 20px 0;">
            <div style="
                width: 200px; 
                height: 150px; 
                background: ${color};
                border-radius: 10px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 2em;
                margin-bottom: 10px;
            ">
                üñºÔ∏è
            </div>
            <div style="color: var(--gray); font-size: 0.9em;">
                ${description || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è'}
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
function selectTestAnswer(questionId, optionIndex) {
    const questionElement = document.getElementById(`${questionId}_option_${optionIndex}`).parentNode.parentNode;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    questionElement.querySelectorAll('.test-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    const selectedOption = document.getElementById(`${questionId}_option_${optionIndex}`);
    selectedOption.classList.add('selected');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    if (!currentHskTest.answers) {
        currentHskTest.answers = {};
    }
    currentHskTest.answers[questionId] = optionIndex;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
async function submitFullTest() {
    if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã?')) {
        return;
    }
    
    clearInterval(testTimer);
    showLoading('testContainer', '–û—Ü–µ–Ω–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...');
    
    try {
        // 1. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        // –í–ê–ñ–ù–û: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const testResults = {
            user_id: currentUser?.user_id || 'guest_' + Date.now(),
            test_id: currentHskTest.test_id,
            level: currentHskTest.level,
            listening_score: 0,  // –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            reading_score: 0,    // –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            writing_score: 0,    // –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            speaking_score: 0,   // –î–ª—è –Ω–∞—á–∞–ª–∞ 0
            total_score: 0,      // –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            answers: collectAllAnswers()
        };
        
        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch(`${API_BASE}/hsk/submit-test-results`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testResults)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayTestResults(result);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 3em; color: var(--danger);">‚ùå</div>
                <h3>–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞</h3>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="submitFullTest()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}

function calculateSectionScore(sectionName) {
    const section = currentHskTest?.sections?.[sectionName];
    if (!section) return 0;
    
    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    let correct = 0;
    let total = 0;
    
    // –î–ª—è listening –∏ reading —Å—á–∏—Ç–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    if (sectionName === 'listening' || sectionName === 'reading') {
        const questions = section.questions || [];
        questions.forEach((question, index) => {
            const questionId = question.id || `${sectionName[0].toUpperCase()}${index+1}`;
            if (currentHskTest.answers && currentHskTest.answers[questionId] !== undefined) {
                total++;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
                if (question.correct_index !== undefined) {
                    if (currentHskTest.answers[questionId] === question.correct_index) {
                        correct++;
                    }
                }
            }
        });
        
        if (total > 0) {
            return Math.round((correct / total) * 100);
        }
    }
    
    // –î–ª—è writing –∏ speaking –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0, —Ç–∞–∫ –∫–∞–∫ –æ—Ü–µ–Ω–∫–∞ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    return 0;
}

function collectAllAnswers() {
    const answers = {};
    
    // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    document.querySelectorAll('.test-option.selected').forEach(option => {
        const questionId = option.id.split('_option_')[0];
        const optionIndex = parseInt(option.id.split('_option_')[1]);
        answers[questionId] = optionIndex;
    });
    
    return answers;
}

function showLocalTestResults() {
    const container = document.getElementById('testContainer');
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã
    const listeningScore = calculateSectionScore('listening');
    const readingScore = calculateSectionScore('reading');
    const writingScore = calculateSectionScore('writing');
    const speakingScore = 75;
    const totalScore = listeningScore + readingScore + writingScore + speakingScore;
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>${totalScore >= 180 ? 'üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!' : 'üí™ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!'}</h2>
            <div style="font-size: 3em; font-weight: bold; color: ${totalScore >= 180 ? 'var(--success)' : 'var(--danger)'}">
                ${totalScore}/300
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <h3>–ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <div class="stat-number">${listeningScore}/100</div>
            </div>
            <div class="stat-card">
                <h3>–ß—Ç–µ–Ω–∏–µ</h3>
                <div class="stat-number">${readingScore}/100</div>
            </div>
            <div class="stat-card">
                <h3>–ü–∏—Å—å–º–æ</h3>
                <div class="stat-number">${writingScore}/100</div>
            </div>
            <div class="stat-card">
                <h3>–ì–æ–≤–æ—Ä–µ–Ω–∏–µ</h3>
                <div class="stat-number">${speakingScore}/100</div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="btn btn-primary" onclick="startTest(${currentHskTest.level})">
                <i class="fas fa-redo"></i> –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –µ—â–µ —Ä–∞–∑
            </button>
        </div>
    `;
}

// –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é evaluateWriting:
async function evaluateWriting(text, taskData) {
    try {
        const response = await fetch(`${API_BASE}/hsk/evaluate-writing`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                task_data: taskData,
                user_id: currentUser?.user_id || 'guest_' + Date.now()
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ –ø–∏—Å—å–º–∞:', error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –æ—Ü–µ–Ω–∫—É
        return {
            score: Math.floor(Math.random() * 30) + 60,
            feedback: '–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –∏ —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å.',
            suggestions: ['–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –ª–µ–∫—Å–∏–∫–∏', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤']
        };
    }
}

async function evaluateWriting(text, taskData) {
    try {
        const response = await fetch(`${API_BASE}/hsk/evaluate-writing`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                task_data: taskData,
                user_id: currentUser?.user_id || 'guest'
            })
        });
        
        return await response.json();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ –ø–∏—Å—å–º–∞:', error);
        return {
            score: Math.floor(Math.random() * 30) + 50, // –†–∞–Ω–¥–æ–º 50-80
            feedback: '–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –∏ —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å.'
        };
    }
}

function displayTestResults(data) {
    const container = document.getElementById('testContainer');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
    const totalScore = data.calculated_score || data.scores?.total || 0;
    const maxScore = data.scores?.max || (data.level <= 2 ? 200 : 300);
    const percentage = data.scores?.total ? Math.round((data.scores.total / maxScore) * 100) : 0;
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–∞–ª–ª—ã
    const listeningScore = data.scores?.listening || 0;
    const readingScore = data.scores?.reading || 0;
    const writingScore = data.scores?.writing || 0;
    const speakingScore = data.scores?.speaking || 0;
    const level = data.level || currentHskTest?.level || 1;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–¥–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const passingScore = level <= 2 ? 120 : 180;  // HSK 1-2: 120/200, HSK 3-6: 180/300
    const passed = totalScore >= passingScore;
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–µ–∫—Ü–∏—è–º
    const listeningStats = data.stats?.listening || "0/0 (0/100)";
    const readingStats = data.stats?.reading || "0/0 (0/100)";
    const writingStats = data.stats?.writing || "0/100";
    const speakingStats = data.stats?.speaking || "0/100";
    
    // –†–∞–∑–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è listening –∏ reading
    const listeningMatch = listeningStats.match(/(\d+)\/(\d+)\s+\((\d+)/);
    const listeningCorrect = listeningMatch ? listeningMatch[1] : "0";
    const listeningTotal = listeningMatch ? listeningMatch[2] : "0";
    
    const readingMatch = readingStats.match(/(\d+)\/(\d+)\s+\((\d+)/);
    const readingCorrect = readingMatch ? readingMatch[1] : "0";
    const readingTotal = readingMatch ? readingMatch[2] : "0";
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 4em; color: ${passed && totalScore > 0 ? 'var(--success)' : 'var(--danger)'}">
                ${passed && totalScore > 0 ? 'üéâ' : 'üí™'}
            </div>
            <h2>${passed && totalScore > 0 ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!' : '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏!'}</h2>
            <div style="font-size: 2.5em; font-weight: bold; color: ${passed && totalScore > 0 ? 'var(--success)' : 'var(--danger)'}">
                ${totalScore}/${maxScore} (${percentage}%)
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                ${passed && totalScore > 0 ? `–í—ã —Å–¥–∞–ª–∏ HSK ${level}!` : `–î–ª—è —Å–¥–∞—á–∏ HSK ${level} –Ω—É–∂–Ω–æ ${passingScore} –±–∞–ª–ª–æ–≤`}
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤: ${Object.keys(data.correct_answers || {}).length}
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ–∫—Ü–∏—è–º -->
        <div style="margin-bottom: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-chart-bar"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å–µ–∫—Ü–∏—è–º:
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="stat-card">
                    <h3>–ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <div class="stat-number">${listeningScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${listeningScore}%"></div>
                    </div>
                    <div class="stat-desc">${listeningCorrect}/${listeningTotal} –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <h3>–ß—Ç–µ–Ω–∏–µ</h3>
                    <div class="stat-number">${readingScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${readingScore}%"></div>
                    </div>
                    <div class="stat-desc">${readingCorrect}/${readingTotal} –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div>
                </div>
                ${level >= 3 ? `
                <div class="stat-card">
                    <h3>–ü–∏—Å—å–º–æ</h3>
                    <div class="stat-number">${writingScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${writingScore}%"></div>
                    </div>
                    <div class="stat-desc">–ü–∏—Å—å–º–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å</div>
                </div>
                ` : ''}
                <div class="stat-card">
                    <h3>–ì–æ–≤–æ—Ä–µ–Ω–∏–µ</h3>
                    <div class="stat-number">${speakingScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${speakingScore}%"></div>
                    </div>
                    <div class="stat-desc">–£—Å—Ç–Ω–∞—è —á–∞—Å—Ç—å</div>
                </div>
            </div>
        </div>
        
        <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="word-card" style="margin-bottom: 20px;">
            <h4><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;">
                <div>
                    <strong>–£—Ä–æ–≤–µ–Ω—å:</strong> HSK ${level}
                </div>
                <div>
                    <strong>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª:</strong> ${maxScore}
                </div>
                <div>
                    <strong>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª:</strong> ${passingScore}
                </div>
                <div>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: ${passed && totalScore > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                        ${passed && totalScore > 0 ? '–°–î–ê–õ' : '–ù–ï –°–î–ê–õ'}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
        ${data.correct_answers && Object.keys(data.correct_answers).length > 0 ? `
            <div class="word-card" style="margin-top: 20px;">
                <h4><i class="fas fa-check-circle"></i> –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:</h4>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    ${Object.entries(data.correct_answers).map(([qId, result]) => `
                        <div style="padding: 8px; border-bottom: 1px solid #dee2e6;">
                            <div style="font-weight: bold; color: ${result.correct ? 'var(--success)' : 'var(--danger)'};">
                                ${qId}: ${result.correct ? '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –û—à–∏–±–∫–∞'}
                            </div>
                            ${result.feedback ? `<div style="font-size: 0.9em;">${result.feedback}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-primary" onclick="startTest(${level})">
                <i class="fas fa-redo"></i> –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –µ—â–µ —Ä–∞–∑
            </button>
            <button class="btn btn-secondary" onclick="switchTab('progress')" style="margin-left: 10px;">
                <i class="fas fa-chart-line"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            </button>
        </div>
    `;
}

async function downloadCertificate(certificateId) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    alert('–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF');
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
}

function shareCertificate(certificateId) {
    if (navigator.share) {
        navigator.share({
            title: `–ú–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç HSK ${currentHskTest.level}`,
            text: `–Ø —Å–¥–∞–ª —Ç–µ—Å—Ç HSK ${currentHskTest.level} —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ${currentHskTest.total_score}/300 –±–∞–ª–ª–æ–≤!`,
            url: window.location.href
        });
    } else {
        alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç');
    }
}

function showDetailedReport() {
    switchTab('progress');
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
}
        
        // –°–±—Ä–æ—Å —Ç–µ—Å—Ç–∞
        function resetTest() {
            if (currentTest) {
                displayTest(currentTest);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function showRegisterForm() {
            const progressContent = document.getElementById('progressContent');
            
            progressContent.innerHTML = `
                <h3><i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <p>–î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å:</p>
                
                <div style="margin: 20px 0;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ò–º—è:</label>
                        <input type="text" id="regName" placeholder="–í–∞—à–µ –∏–º—è" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å HSK:</label>
                        <select id="regCurrentLevel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            ${[1,2,3,4,5,6].map(level => `<option value="${level}">HSK ${level}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</label>
                        <select id="regTargetLevel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            ${[1,2,3,4,5,6].map(level => `<option value="${level}" ${level === 4 ? 'selected' : ''}>HSK ${level}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–î–∞—Ç–∞ —ç–∫–∑–∞–º–µ–Ω–∞:</label>
                        <input type="date" id="regExamDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–í—Ä–µ–º—è –≤ –¥–µ–Ω—å (–º–∏–Ω—É—Ç):</label>
                        <input type="number" id="regDailyTime" value="30" min="10" max="180" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <button class="btn btn-primary" onclick="registerUser()" style="width: 100%;">
                        <i class="fas fa-check"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </div>
            `;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞)
            const defaultDate = new Date();
            defaultDate.setMonth(defaultDate.getMonth() + 3);
            document.getElementById('regExamDate').value = defaultDate.toISOString().split('T')[0];
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function registerUser() {
            const userData = {
                name: document.getElementById('regName').value || '–ê–Ω–æ–Ω–∏–º',
                current_level: parseInt(document.getElementById('regCurrentLevel').value) || 1,
                target_level: parseInt(document.getElementById('regTargetLevel').value) || 4,
                exam_date: document.getElementById('regExamDate').value || new Date().toISOString().split('T')[0],
                daily_time: parseInt(document.getElementById('regDailyTime').value) || 30,
                exam_location: "–ú–æ—Å–∫–≤–∞",
                exam_format: "computer",
                interests: ["–∫–∏—Ç–∞–π—Å–∫–∏–π", "HSK"],
                learning_style: "visual"
            };
            
            if (!userData.name.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
                return;
            }
            
            showLoading('progressContent', '–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é...');
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                const progressContent = document.getElementById('progressContent');
                progressContent.innerHTML = `
                    <div style="text-align: center; padding: 30px 0;">
                        <div style="font-size: 4em; color: var(--success);">üéâ</div>
                        <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h3>
                        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.name}!</p>
                        <p>–í–∞—à ID: <strong>${result.user_id}</strong></p>
                        
                        <div class="word-tip" style="margin: 20px 0; text-align: left;">
                            <strong><i class="fas fa-bullseye"></i> –í–∞—à –ø–ª–∞–Ω:</strong><br>
                            ‚Ä¢ –£—á–∏—Ç—å –ø–æ ${result.plan.daily_words} —Å–ª–æ–≤ –≤ –¥–µ–Ω—å<br>
                            ‚Ä¢ –î–æ —ç–∫–∑–∞–º–µ–Ω–∞: ${result.plan.days_until_exam} –¥–Ω–µ–π<br>
                            ‚Ä¢ –õ–∞–π—Ñ—Ö–∞–∫–∏: ${result.plan.hacks.slice(0, 2).join(', ')}<br>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="loadWordsByLevel(${userData.current_level})">
                                <i class="fas fa-book"></i> –ù–∞—á–∞—Ç—å —É—á–∏—Ç—å
                            </button>
                            <button class="btn btn-secondary" onclick="startTest(${userData.current_level})">
                                <i class="fas fa-graduation-cap"></i> –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('progressContent').innerHTML = `
                    <div class="loading">
                        <p>‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                        <button class="btn btn-primary" onclick="showRegisterForm()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading(elementId, message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        async function loadAllWords(level) {
    showLoading('wordsList', `–ó–∞–≥—Ä—É–∂–∞—é –≤—Å–µ —Å–ª–æ–≤–∞ HSK ${level}...`);
    
    try {
        const response = await fetch(`${API_BASE}/words/level/${level}?limit=10000`);
        const data = await response.json();
        
        const wordsList = document.getElementById('wordsList');
        wordsList.innerHTML = '';
        
        if (data.words && data.words.length > 0) {
            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '20px';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            table.innerHTML = `
                <thead>
                    <tr style="background: var(--primary); color: white;">
                        <th style="padding: 12px; text-align: left;">–ò–µ—Ä–æ–≥–ª–∏—Ñ</th>
                        <th style="padding: 12px; text-align: left;">–ü–∏–Ω—å–∏–Ω—å</th>
                        <th style="padding: 12px; text-align: left;">–ü–µ—Ä–µ–≤–æ–¥</th>
                        <th style="padding: 12px; text-align: left;">–£—Ä–æ–≤–µ–Ω—å</th>
                    </tr>
                </thead>
                <tbody id="wordsTableBody">
                </tbody>
            `;
            
            wordsList.appendChild(table);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –í –¢–û–ß–ù–û–ú –ü–û–†–Ø–î–ö–ï –∏–∑ JSON
            const tbody = document.getElementById('wordsTableBody');
            data.words.forEach((word, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                row.style.backgroundColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                row.innerHTML = `
                    <td style="padding: 10px; font-size: 1.2em; font-weight: bold;">${word.character}</td>
                    <td style="padding: 10px; color: var(--danger);">${word.pinyin || ''}</td>
                    <td style="padding: 10px;">${word.translation || ''}</td>
                    <td style="padding: 10px;">
                        <span class="word-level">HSK ${word.hsk_level || 1}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const infoDiv = document.createElement('div');
            infoDiv.className = 'word-tip';
            infoDiv.style.marginTop = '20px';
            infoDiv.innerHTML = `
                <strong><i class="fas fa-info-circle"></i> –í—Å–µ —Å–ª–æ–≤–∞ HSK ${level}:</strong>
                ${data.total} —Å–ª–æ–≤ | –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ
            `;
            wordsList.appendChild(infoDiv);
            
        } else {
            wordsList.innerHTML = '<p>üì≠ –°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤
async function searchChineseUniversities() {
    const query = document.getElementById('admissionQuery').value.trim();
    const hskLevel = document.getElementById('hskLevelFilter').value;
    const budget = document.getElementById('budgetFilter').value;
    const language = document.getElementById('languageFilter').value;
    
    if (!query) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤—ã –∏—â–µ—Ç–µ!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    document.getElementById('searchResults').style.display = 'block';
    document.getElementById('universitiesList').innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
            <h4 style="color: var(--primary);">AI –∏—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...</h4>
            <p style="color: var(--gray);">–ò—â–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∏—Ç–∞–π—Å–∫–∏–º –≤—É–∑–∞–º</p>
        </div>
    `;
    
    const searchBtn = document.getElementById('searchUniversitiesBtn');
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ò–¥–µ—Ç –ø–æ–∏—Å–∫...';
    
    try {
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è AI
        const searchRequest = {
            query: query,
            filters: {
                hsk_level: hskLevel || null,
                max_budget: budget || null,
                language: language || null
            },
            user_id: currentUser?.user_id || null,
            search_type: "university_search"
        };
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫:', searchRequest);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥
        const response = await fetch(`${API_BASE}/ai/search-universities`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(searchRequest)
        });
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        
        const data = await response.json();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayUniversityResults(data.results || data.analysis);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('searchStatus').innerHTML = `
            <i class="fas fa-check" style="color: var(--success);"></i> 
            –ù–∞–π–¥–µ–Ω–æ ${data.count || '–Ω–µ—Å–∫–æ–ª—å–∫–æ'} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${new Date().toLocaleDateString()}
        `;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        document.getElementById('universitiesList').innerHTML = `
            <div class="word-tip" style="border-color: var(--danger);">
                <strong>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:</strong><br>
                ${error.message}<br><br>
                <strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</strong>
                <ul>
                    <li>–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</li>
                    <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
                    <li>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ</li>
                </ul>
            </div>
        `;
        document.getElementById('searchStatus').innerHTML = `
            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> 
            –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π
        `;
    } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤—É–∑—ã';
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
        document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function displayUniversityResults(results) {
    const container = document.getElementById('universitiesList');
    
    if (!results || (typeof results === 'string' && results.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω–æ'))) {
        container.innerHTML = `
            <div class="word-tip">
                <h4>üòï –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞:</p>
                <ul>
                    <li>–£–∫–∞–∂–∏—Ç–µ –¥—Ä—É–≥—É—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</li>
                    <li>–ò–∑–º–µ–Ω–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å HSK</li>
                    <li>–†–∞—Å—à–∏—Ä—å—Ç–µ –±—é–¥–∂–µ—Ç</li>
                    <li>–£–±–µ—Ä–∏—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≥–æ—Ä–æ–¥—É</li>
                </ul>
                <button class="btn btn-primary" onclick="document.getElementById('admissionQuery').focus()">
                    <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                </button>
            </div>
        `;
        return;
    }
    
    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —Ç–µ–∫—Å—Ç –æ—Ç AI
    if (typeof results === 'string') {
        container.innerHTML = `
            <div class="ai-analysis-result">
                ${formatAIText(results)}
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h5><i class="fas fa-robot"></i> –ß—Ç–æ AI —Å–¥–µ–ª–∞–ª:</h5>
                    <ul>
                        <li>üîç –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª —Å–∞–π—Ç—ã –∫–∏—Ç–∞–π—Å–∫–∏—Ö –≤—É–∑–æ–≤</li>
                        <li>üìä –°—Ä–∞–≤–Ω–∏–ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Ü–µ–Ω—ã</li>
                        <li>üéØ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º</li>
                        <li>üí° –î–∞–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é</li>
                    </ul>
                </div>
            </div>
        `;
        return;
    }
    
    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (Array.isArray(results)) {
        let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
        
        results.forEach((uni, index) => {
            html += `
                <div class="university-card" style="border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: var(--primary);">
                                ${index + 1}. ${uni.name || '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç'}
                            </h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                                <span class="word-level">${uni.city || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                                ${uni.hsk_required ? `<span class="word-level">HSK ${uni.hsk_required}</span>` : ''}
                                ${uni.price ? `<span class="word-level">${uni.price} ¬•/–≥–æ–¥</span>` : ''}
                                ${uni.ranking ? `<span class="word-level">–†–µ–π—Ç–∏–Ω–≥: ${uni.ranking}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="showUniversityDetails(${index})">
                            <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <p><strong>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong> ${uni.major || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        ${uni.description ? `<p>${uni.description}</p>` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            ${uni.website ? `<a href="${uni.website}" target="_blank" class="btn btn-sm btn-secondary">
                                <i class="fas fa-external-link-alt"></i> –°–∞–π—Ç
                            </a>` : ''}
                            <button class="btn btn-sm btn-success" onclick="saveUniversity(${index})">
                                <i class="fas fa-bookmark"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatAIText(text) {
    // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ—Ç AI
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/## (.*?)(\n|$)/g, '<h4>$1</h4>')
        .replace(/- (.*?)(\n|$)/g, '<li>$1</li>');
}

function loadExampleQuery(num) {
    const examples = [
        "–ò—â—É –±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç –ø–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–º –Ω–∞—É–∫–∞–º —Å HSK 4, –±—é–¥–∂–µ—Ç –¥–æ 20000 —é–∞–Ω–µ–π –≤ –≥–æ–¥, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –≤ –ü–µ–∫–∏–Ω–µ –∏–ª–∏ –®–∞–Ω—Ö–∞–µ",
        "–ù—É–∂–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∏–ø–µ–Ω–¥–∏—è—Ö CSC –¥–ª—è –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—ã –ø–æ –º–µ–¥–∏—Ü–∏–Ω–µ, —É—Ä–æ–≤–µ–Ω—å HSK 5, –ª—é–±–æ–π –≥–æ—Ä–æ–¥ –ö–∏—Ç–∞—è",
        "–ö–∞–∫–∏–µ –µ—Å—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –≤ –®–∞–Ω—Ö–∞–µ —Å –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –ø–æ –±–∏–∑–Ω–µ—Å—É? –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç MBA",
        "–ò—â—É –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –≤ –ö–∏—Ç–∞–µ, –º–æ–∂–Ω–æ –±–µ–∑ HSK, –≤–∞–∂–Ω–∞ —Å—Ç–∏–ø–µ–Ω–¥–∏—è"
    ];
    
    document.getElementById('admissionQuery').value = examples[num - 1];
    document.getElementById('admissionQuery').focus();
}

function clearSearch() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('admissionQuery').value = '';
}

function exportResults() {
    const results = document.getElementById('universitiesList').innerText;
    const blob = new Blob([results], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '–∫–∏—Ç–∞–π—Å–∫–∏–µ_–≤—É–∑—ã_–ø–æ–∏—Å–∫.txt';
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª');
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
function updateWordButtons() {
    // –ó–∞–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É "HSK 1" –Ω–∞
    `<button class="btn btn-success" onclick="loadAllWords(1)">
        <i class="fas fa-list"></i> –í—Å–µ —Å–ª–æ–≤–∞ HSK 1
    </button>`
}
        
        // –ù–∞–∂–∞—Ç–∏–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
window.onload = async function() {

    document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏
    if (document.getElementById('translationModeContent')) {
        initTranslationButtons();
    }
    
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
    document.addEventListener('click', function(e) {
        // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞"
        if (e.target.closest('[onclick*="lookupWordInTranslation"]')) {
            e.preventDefault();
            lookupWordInTranslation();
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É"
        if (e.target.closest('[onclick*="checkGrammarInTranslation"]')) {
            e.preventDefault();
            checkGrammarInTranslation();
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç"
        if (e.target.closest('[onclick*="suggestAlternative"]')) {
            e.preventDefault();
            suggestAlternative();
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å"
        if (e.target.closest('[onclick*="clearTranslation"]')) {
            e.preventDefault();
            clearTranslation();
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Å–∫–∞–∑–∫–∞"
        if (e.target.closest('[onclick*="showTranslationHint"]')) {
            e.preventDefault();
            showTranslationHint();
        }
    });
});
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    document.getElementById('authSection').style.display = 'block';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await checkAuth();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    loadStats();
    loadRandomWords();
    
    // –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('messageInput').focus();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ Progress
    loadProgress();
    
    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if (!currentUser) {
        setTimeout(() => {
            addMessage('üîê –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏".', 'ai');
        }, 1000);
    }
    // –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü window.onload –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
document.getElementById('startVoiceBtn').addEventListener('click', function() {
    if (!voiceRecognition) {
        initVoiceChat();
    }
    
    if (voiceRecognition && !isRecording) {
        try {
            voiceRecognition.start();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞–ø–∏—Å–∏:', error);
            addVoiceMessage('AI', '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.', 'error');
        }
    }
});

document.getElementById('stopVoiceBtn').addEventListener('click', function() {
    if (voiceRecognition && isRecording) {
        voiceRecognition.stop();
    }
});

document.getElementById('clearVoiceBtn').addEventListener('click', function() {
    document.getElementById('voiceChatBox').innerHTML = '';
    voiceChatHistory = [];
    addVoiceMessage('AI', '–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä!', 'info');
});

};
    </script>
</body>
</html>


–∏–∏–∏–∏–∏–∏–∏–∏–∏–∏

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional, Dict, Any
import json
import os
import re
import random
from datetime import datetime, timedelta
import uvicorn
import pickle
import hashlib
from src.ai_translator import translator
from src.grammar_explainer import grammar_explainer
import json
import asyncio
from src.grammar_explainer import grammar_explainer
from src.hsk_test_generator import test_generator, generate_hsk_test_api, evaluate_speaking_api, evaluate_writing_api, generate_certificate_api, generate_progress_report_api
from pydantic import Field

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è AI
from openai import OpenAI
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
app = FastAPI(
    title="HSK AI Tutor",
    description="–ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –¥–ª—è —Å–¥–∞—á–∏ HSK –ª—é–±–æ–π —Ü–µ–Ω–æ–π (–ª–µ–≥–∞–ª—å–Ω–æ)",
    version="1.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –í –Ω–∞—á–∞–ª–µ main.py
class ChatThread(BaseModel):
    thread_id: str
    user_id: str
    title: str
    created_at: str
    messages: List[Dict]
    category: str = "general"  # grammar, vocabulary, test_prep, etc.

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
chat_threads = {}  # user_id -> list of threads
user_word_status: Dict[str, Dict[str, Dict]] = {}  # user_id -> {word_id: {"status": "saved"/"learned", "added_at": iso_str}}
current_threads = {}  # user_id -> current_thread_id

# ========== –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• ==========
class UserInfo(BaseModel):
    name: str
    current_level: int = 1
    target_level: int = 4
    exam_date: str = "2024-12-01"
    exam_location: str = "–ú–æ—Å–∫–≤–∞"
    exam_format: str = "computer"  # computer –∏–ª–∏ paper
    interests: List[str] = []
    daily_time: int = 30  # –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å
    learning_style: str = "visual"  # visual, auditory, kinesthetic

class ChatMessage(BaseModel):
    message: str
    user_id: Optional[str] = None

class TestAnswer(BaseModel):
    user_id: str
    test_id: str
    answers: Dict[str, Any]  # question_id: answer

class WordReview(BaseModel):
    user_id: str
    word_id: str  # character + level
    difficulty: int  # 1-5, –≥–¥–µ 1=–ª–µ–≥–∫–æ, 5=–æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ
    remembered: bool

class AuthRequest(BaseModel):
    username: str
    action: str = "login_or_register"
    password: Optional[str] = None

# –ú–æ–¥–µ–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
class UserRegister(BaseModel):
    name: str
    email: str
    password: str
    current_level: int = 1
    target_level: int = 4
    exam_date: str
    exam_location: str = "–ú–æ—Å–∫–≤–∞"
    exam_format: str = "computer"
    interests: List[str] = []
    daily_time: int = 30
    learning_style: str = "visual"

class UserLogin(BaseModel):
    email: str
    password: str

# –ú–æ–¥–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
class ChatUpdate(BaseModel):
    thread_id: str
    title: str
    category: str

class VoiceChatRequest(BaseModel):
    message: str
    thread_id: str = Field(..., min_length=1, description="ID —Ç—Ä–µ–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    context: Dict[str, Any] = Field(default_factory=dict)
    user_id: Optional[str] = None

@app.post("/voice")
async def voice_chat(request: VoiceChatRequest):
    """–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç —Å AI –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —á—ç–Ω—ä—é—è–º (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
    try:
        # –í–ê–õ–ò–î–ê–¶–ò–Ø: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if not request.thread_id or request.thread_id.strip() == "":
            raise HTTPException(status_code=422, detail="thread_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
        
        if not request.message or request.message.strip() == "":
            raise HTTPException(status_code=422, detail="message –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
        
        print(f"üé§ –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å voice/chat:")
        print(f"   message: {request.message[:100]}...")
        print(f"   thread_id: {request.thread_id}")
        print(f"   context keys: {list(request.context.keys())}")
        print(f"   user_id: {request.user_id}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç—Ä–µ–¥
        thread_exists = False
        if request.thread_id:
            for user_threads in chat_threads.values():
                for thread in user_threads:
                    if thread["thread_id"] == request.thread_id:
                        thread_exists = True
                        break
                if thread_exists:
                    break
        
        # –ï—Å–ª–∏ —Ç—Ä–µ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        if not thread_exists and request.user_id:
            print(f"üìù –°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π —Ç—Ä–µ–¥ –¥–ª—è user_id: {request.user_id}")
            thread_id = f"voice_thread_{datetime.now().timestamp()}"
            
            if request.user_id not in chat_threads:
                chat_threads[request.user_id] = []
            
            thread = {
                "thread_id": thread_id,
                "user_id": request.user_id,
                "title": "–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç —Å AI",
                "category": "voice_chat",
                "created_at": datetime.now().isoformat(),
                "messages": [],
                "updated_at": datetime.now().isoformat()
            }
            
            chat_threads[request.user_id].append(thread)
            current_threads[request.user_id] = thread_id
            request.thread_id = thread_id  # –û–±–Ω–æ–≤–ª—è–µ–º thread_id –≤ –∑–∞–ø—Ä–æ—Å–µ
        system_prompt = """–¢—ã ‚Äî –∫–∏—Ç–∞–π—Å–∫–∏–π AI-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å. –¢—ã –û–ë–Ø–ó–ê–ù –≥–æ–≤–æ—Ä–∏—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ (ÊôÆÈÄöËØù).

# –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
1. üá®üá≥ –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ
2. üó£Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ —É—Å—Ç–Ω—ã–π, —Ç–∞–∫ –∏ –ø–∏—Å—å–º–µ–Ω–Ω—ã–π –∫–∏—Ç–∞–π—Å–∫–∏–π
3. üìö –ö–∞–∂–¥—ã–µ 2-3 —Ä–µ–ø–ª–∏–∫–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–∫–ª—é—á–∞–π —á—ç–Ω—ä—é–π (ÊàêËØ≠)
4. üéØ –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω–æ–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –Ω–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º
5. üî§ –î–ª—è –ø–∏–Ω—å–∏–Ω—è –∏—Å–ø–æ–ª—å–∑—É–π: (–ø–∏–Ω—å–∏–Ω—å)
6. üá∑üá∫ –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π: „Äê—Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥„Äë

# –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
1. –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º
2. –°–ª–æ–∂–Ω—ã–µ —Å–ª–æ–≤–∞ —Å –ø–∏–Ω—å–∏–Ω–µ–º –≤ —Å–∫–æ–±–∫–∞—Ö
3. –ß—ç–Ω—ä—é–∏ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
4. –ö—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑

# –ü–†–ò–ú–ï–†–´:

## –ü—Ä–∏–º–µ—Ä 1: –û–±—ã—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å
Áî®Êà∑: "–ö–∞–∫ –¥–µ–ª–∞?"
AI: "ÊàëÂæàÂ•ΩÔºåË∞¢Ë∞¢ÔºÅ(w«í hƒõn h«éo, xi√®xi√®) „Äê–ú–Ω–µ —Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ!„Äë‰Ω†‰ªäÂ§©ÊÄé‰πàÊ†∑Ôºü(n«ê jƒ´ntiƒÅn zƒõnmey√†ng)"

## –ü—Ä–∏–º–µ—Ä 2: –° —á—ç–Ω—ä—é–µ–º
Áî®Êà∑: "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"
AI: "‰ªäÂ§©ÊàëÊÉ≥Êïô‰Ω†‰∏Ä‰∏™ÊàêËØ≠ÔºöÁîªËõáÊ∑ªË∂≥(hu√† sh√© tiƒÅn z√∫)„ÄÇ„Äê–°–µ–≥–æ–¥–Ω—è —è —Ö–æ—á—É –Ω–∞—É—á–∏—Ç—å —Ç–µ–±—è —á—ç–Ω—ä—é—é: —Ä–∏—Å–æ–≤–∞—Ç—å –∑–º–µ—é –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≥–∏„ÄëÊÑèÊÄùÊòØÂÅöÂ§ö‰ΩôÁöÑ‰∫ãÊÉÖÂèçËÄå‰∏çÂ•Ω„ÄÇ„Äê–ó–Ω–∞—á–∏—Ç: –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–µ–µÂèçËÄå‰∏çÂ•Ω„ÄëÊØîÂ¶ÇÔºö‰ªñÁöÑËß£ÈáäÂ§™Èïø‰∫ÜÔºåÁÆÄÁõ¥ÊòØÁîªËõáÊ∑ªË∂≥„ÄÇ„Äê–ù–∞–ø—Ä–∏–º–µ—Ä: –ï–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æÁîªËõáÊ∑ªË∂≥„Äë"

## –ü—Ä–∏–º–µ—Ä 3: –û–±—ä—è—Å–Ω–µ–Ω–∏–µ
Áî®Êà∑: "Êàë‰∏çÊòéÁôΩËøô‰∏™ÊàêËØ≠"
AI: "ÊàëÊù•Ëß£Èáä‰∏Ä‰∏ãÔºöÁîªËõáÊ∑ªË∂≥(hu√† sh√© tiƒÅn z√∫)Êù•Ëá™Âè§‰ª£ÊïÖ‰∫ã„ÄÇÂá†‰∏™‰∫∫ÊØîËµõÁîªËõáÔºåË∞ÅÂÖàÁîªÂÆåË∞ÅËµ¢„ÄÇ‰∏Ä‰∏™‰∫∫ÂæàÂø´ÁîªÂÆå‰∫ÜÔºå‰ΩÜ‰ªñËá™‰ΩúËÅ™ÊòéÁªôËõáÂä†‰∫ÜËÑöÔºåÁªìÊûúËæì‰∫Ü„ÄÇÊâÄ‰ª•Ëøô‰∏™ÊàêËØ≠ÂëäËØâÊàë‰ª¨ÔºöÂÅö‰∫ãÊÅ∞Âà∞Â•ΩÂ§ÑÂ∞±Â•ΩÔºå‰∏çË¶ÅÂÅöÂ§ö‰ΩôÁöÑ‰∫ãÊÉÖ„ÄÇ„Äê–Ø –æ–±—ä—è—Å–Ω—é: ÁîªËõáÊ∑ªË∂≥Êù•Ëá™Âè§‰ª£ÊïÖ‰∫ã...„Äë"

# –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (HSK 1-6)
- –ü–æ–≤—Ç–æ—Ä—è–π —Ä–∞–Ω–µ–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
- –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏
- –ë—É–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–º –∏ –æ–±–æ–¥—Ä—è—é—â–∏–º

# –ò–°–¢–û–†–ò–Ø –ß–≠–ù–™–Æ–ï–í:
Â∑≤Â≠¶ÊàêËØ≠Ôºö{learned_chengyu}

# –¢–ï–ö–£–©–ò–ô –£–†–û–í–ï–ù–¨ –£–ß–ï–ù–ò–ö–ê:
Áî®Êà∑Á≠âÁ∫ßÔºöHSK {user_level}

–ù–µ –≥–æ–≤–æ—Ä–∏ –ø–æ-—Ä—É—Å—Å–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ç–µ–∫—Å—Ç–µ. –¢–æ–ª—å–∫–æ –∫–∏—Ç–∞–π—Å–∫–∏–π —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏ –≤ —Å–∫–æ–±–∫–∞—Ö!"""

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        learned_chengyu = request.context.get("learned_chengyu", [])
        command_type = request.context.get("command_type", "general")
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –ø–æ–¥ —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã
        if command_type == "chengyu":
            system_prompt += "\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–π —á—ç–Ω—ä—é–π. –í—ã–±–µ—Ä–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π —á—ç–Ω—ä—é–π –¥–ª—è –µ–≥–æ —É—Ä–æ–≤–Ω—è."
        elif command_type == "explain":
            system_prompt += "\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –æ–±—ä—è—Å–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º."
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑—É—á–µ–Ω–Ω—ã—Ö —á—ç–Ω—ä—é—è—Ö
        if learned_chengyu:
            system_prompt += f"\n\n–ò–∑—É—á–µ–Ω–Ω—ã–µ —á—ç–Ω—ä—é–∏: {', '.join(learned_chengyu[:5])}"
        
        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_level = 3
        if request.user_id and request.user_id in users_db:
            user = users_db[request.user_id]
            user_level = user.get("current_level", 3)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤ –ø—Ä–æ–º–ø—Ç
        system_prompt += f"\n\n–£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: HSK {user_level}"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ DeepSeek
        client = get_deepseek_client()
        if not client:
            return {"response": "AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "error": "no_api_key"}
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": request.message}
        ]
        
        print(f"ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ AI —Å {len(request.message)} —Å–∏–º–≤–æ–ª–∞–º–∏")
        
        try:
            response = client.chat.completions.create(
                model="deepseek-chat",
                messages=messages,
                temperature=0.8,
                max_tokens=800,
                presence_penalty=0.6,
                frequency_penalty=0.5
            )
            
            ai_response = response.choices[0].message.content
            
            print(f"ü§ñ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç AI: {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            if request.thread_id and request.user_id:
                # –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ç—Ä–µ–¥
                thread_found = False
                for user_threads in chat_threads.values():
                    for thread in user_threads:
                        if thread["thread_id"] == request.thread_id:
                            thread["messages"].append({
                                "role": "user",
                                "content": request.message,
                                "timestamp": datetime.now().isoformat()
                            })
                            thread["messages"].append({
                                "role": "assistant",
                                "content": ai_response,
                                "timestamp": datetime.now().isoformat()
                            })
                            thread["updated_at"] = datetime.now().isoformat()
                            thread_found = True
                            break
                    if thread_found:
                        break
                
                if not thread_found and request.user_id:
                    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç—Ä–µ–¥
                    if request.user_id not in chat_threads:
                        chat_threads[request.user_id] = []
                    
                    new_thread = {
                        "thread_id": request.thread_id,
                        "user_id": request.user_id,
                        "title": "–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç —Å AI",
                        "category": "voice_chat",
                        "created_at": datetime.now().isoformat(),
                        "messages": [
                            {
                                "role": "user",
                                "content": request.message,
                                "timestamp": datetime.now().isoformat()
                            },
                            {
                                "role": "assistant",
                                "content": ai_response,
                                "timestamp": datetime.now().isoformat()
                            }
                        ],
                        "updated_at": datetime.now().isoformat()
                    }
                    chat_threads[request.user_id].append(new_thread)
                    current_threads[request.user_id] = request.thread_id
                
                save_user_data()
            
            return {
                "response": ai_response,
                "thread_id": request.thread_id,
                "user_id": request.user_id,
                "timestamp": datetime.now().isoformat()
            }
            
        except Exception as ai_error:
            print(f"‚ùå –û—à–∏–±–∫–∞ AI: {str(ai_error)}")
            return {
                "response": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                "thread_id": request.thread_id,
                "error": str(ai_error),
                "timestamp": datetime.now().isoformat()
            }
        
    except HTTPException as http_err:
        raise http_err
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞: {str(e)}")
        import traceback
        traceback.print_exc()
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}")

class TranslationRequest(BaseModel):
    text: str
    user_id: Optional[str] = None
    detailed: bool = True
    include_exercises: bool = False

class PronunciationRequest(BaseModel):
    text: str
    user_id: Optional[str] = None

class ExerciseRequest(BaseModel):
    text: str
    level: int = 1
    exercise_type: str = "all"  # fill_blanks, matching, word_order, etc.

# –î–æ–±–∞–≤—å—Ç–µ –º–æ–¥–µ–ª–∏
class GrammarTopicRequest(BaseModel):
    topic_id: str
    user_id: Optional[str] = None
    user_level: Optional[str] = "Âàù"

class GrammarQuestionRequest(BaseModel):
    question: str
    topic_id: Optional[str] = None
    user_id: Optional[str] = None

class HSKTestRequest(BaseModel):
    level: int
    test_type: str = "reduced"  # reduced –∏–ª–∏ full
    user_id: Optional[str] = None

class SpeakingEvaluationRequest(BaseModel):
    audio_text: str  # –¢–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–π —Ä–µ—á–∏
    task_data: Dict[str, Any]
    user_id: str

class WritingEvaluationRequest(BaseModel):
    text: str
    task_data: Dict[str, Any]
    user_id: str

class TestResults(BaseModel):
    user_id: str
    test_id: str
    level: int  # üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï
    listening_score: Optional[int] = 0
    reading_score: Optional[int] = 0
    writing_score: Optional[int] = 0
    speaking_score: Optional[int] = 0
    total_score: Optional[int] = 0
    answers: Dict[str, Any]

@app.get("/hsk/test-answers/{test_id}/{user_id}")
async def get_test_answers(test_id: str, user_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if test_id not in tests_db or user_id not in tests_db[test_id]:
        raise HTTPException(status_code=404, detail="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    user_results = tests_db[test_id][user_id]
    
    return {
        "test_id": test_id,
        "user_id": user_id,
        "answers": user_results.get("correct_answers", {}),
        "score": user_results.get("total_score_calculated", 0),
        "max_score": user_results.get("max_possible_score", 0),
        "percentage": user_results.get("percentage", 0),
        "ai_evaluated": user_results.get("ai_evaluated", False)
    }

# –ù–ê–ô–î–ò–¢–ï —Ñ—É–Ω–∫—Ü–∏—é generate_hsk_test –∏ –ò–ó–ú–ï–ù–ò–¢–ï –µ—ë:
@app.post("/hsk/generate-test")
async def generate_hsk_test(request: HSKTestRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ HSK"""
    try:
        test_data = await generate_hsk_test_api(request.level, request.test_type)
        
        # üî¥ –°–†–ê–ó–£ –°–û–•–†–ê–ù–Ø–ï–ú –¢–ï–°–¢ –í –ë–ê–ó–£ –î–ê–ù–ù–´–•
        test_id = test_data["test_id"]
        tests_db[test_id] = test_data  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º —Ç–µ—Å—Ç
        
        # –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        if test_id not in tests_db:
            tests_db[test_id] = {}
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
        tests_db[f"test_data_{test_id}"] = test_data
        
        return test_data
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞: {str(e)}")

@app.post("/hsk/evaluate-speaking")
async def evaluate_speaking(request: SpeakingEvaluationRequest):
    """–û—Ü–µ–Ω–∫–∞ —Ä–µ—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        evaluation = await evaluate_speaking_api(request.audio_text, request.task_data)
        return evaluation
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ —Ä–µ—á–∏: {str(e)}")

@app.post("/hsk/evaluate-writing")
async def evaluate_writing(request: WritingEvaluationRequest):
    """–û—Ü–µ–Ω–∫–∞ –ø–∏—Å—å–º–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã"""
    try:
        evaluation = await evaluate_writing_api(request.text, request.task_data)
        return evaluation
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ –ø–∏—Å—å–º–∞: {str(e)}")

@app.post("/hsk/submit-test-results")
async def submit_test_results(results: TestResults):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞"""
    try:
        test_id = results.test_id
        user_id = results.user_id
        
        # 1. –ò—â–µ–º —Ç–µ—Å—Ç
        original_test = None
        
        if test_id in tests_db and isinstance(tests_db[test_id], dict) and "sections" in tests_db[test_id]:
            original_test = tests_db[test_id]
        elif f"test_data_{test_id}" in tests_db:
            original_test = tests_db[f"test_data_{test_id}"]
        
        if not original_test:
            # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã
            original_test = {
                "test_id": test_id,
                "level": results.level,
                "sections": {
                    "listening": {"questions": []},
                    "reading": {"questions": []},
                    "writing": {"tasks": []},
                    "speaking": {"tasks": []}
                }
            }
        
        # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        correct_answers = {}
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º listening –≤–æ–ø—Ä–æ—Å—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Ç–µ—Å—Ç–µ)
        listening_correct = 0
        listening_total = 0
        listening_questions = original_test.get("sections", {}).get("listening", {}).get("questions", [])
        
        for question in listening_questions:
            q_id = question.get("id")
            correct_index = question.get("correct_index")
            
            if correct_index is not None:
                listening_total += 1
                user_answer = results.answers.get(q_id)
                
                if user_answer is not None:
                    is_correct = user_answer == correct_index
                    if is_correct:
                        listening_correct += 1
                    
                    correct_answers[q_id] = {
                        "correct": is_correct,
                        "user_answer": user_answer,
                        "correct_answer": correct_index,
                        "points": 1 if is_correct else 0,
                        "section": "listening"
                    }
                else:
                    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª
                    correct_answers[q_id] = {
                        "correct": False,
                        "user_answer": None,
                        "correct_answer": correct_index,
                        "points": 0,
                        "section": "listening"
                    }
        
        # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º reading –≤–æ–ø—Ä–æ—Å—ã
        reading_correct = 0
        reading_total = 0
        reading_questions = original_test.get("sections", {}).get("reading", {}).get("questions", [])
        
        for question in reading_questions:
            q_id = question.get("id")
            correct_index = question.get("correct_index")
            
            if correct_index is not None:
                reading_total += 1
                user_answer = results.answers.get(q_id)
                
                if user_answer is not None:
                    is_correct = user_answer == correct_index
                    if is_correct:
                        reading_correct += 1
                    
                    correct_answers[q_id] = {
                        "correct": is_correct,
                        "user_answer": user_answer,
                        "correct_answer": correct_index,
                        "points": 1 if is_correct else 0,
                        "section": "reading"
                    }
                else:
                    correct_answers[q_id] = {
                        "correct": False,
                        "user_answer": None,
                        "correct_answer": correct_index,
                        "points": 0,
                        "section": "reading"
                    }
        
        # 5. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        # –í–∞–∂–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–µ—Å—Ç–µ!
        listening_score = 0
        reading_score = 0
        
        if listening_total > 0:
            listening_score = int((listening_correct / listening_total) * 100)
        
        if reading_total > 0:
            reading_score = int((reading_correct / reading_total) * 100)
        
        # 6. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –ø–∏—Å—å–º–µ–Ω–Ω–æ–π –∏ —É—Å—Ç–Ω–æ–π —á–∞—Å—Ç–µ–π
        writing_score = results.writing_score if results.writing_score is not None else 0
        speaking_score = results.speaking_score if results.speaking_score is not None else 0
        
        # 7. –î–ª—è –ø–∏—Å—å–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –¥–æ–±–∞–≤–ª—è–µ–º –≤ correct_answers
        writing_tasks = original_test.get("sections", {}).get("writing", {}).get("tasks", [])
        if writing_tasks:
            for task in writing_tasks:
                task_id = task.get("id", "1")
                correct_answers[f"W{task_id}"] = {
                    "correct": writing_score >= 60,
                    "score": writing_score,
                    "feedback": f"–ü–∏—Å—å–º–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å: {writing_score}/100",
                    "section": "writing"
                }
        
        # 8. –î–ª—è –≥–æ–≤–æ—Ä–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ–º –≤ correct_answers
        speaking_tasks = original_test.get("sections", {}).get("speaking", {}).get("tasks", [])
        if speaking_tasks:
            for task in speaking_tasks:
                task_id = task.get("id", "1")
                correct_answers[f"S{task_id}"] = {
                    "correct": speaking_score >= 60,
                    "score": speaking_score,
                    "feedback": f"–£—Å—Ç–Ω–∞—è —á–∞—Å—Ç—å: {speaking_score}/100",
                    "section": "speaking"
                }
        
        # 9. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π –±–∞–ª–ª –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û!
        # HSK 1-2: —Ç–æ–ª—å–∫–æ listening (100) + reading (100) = –º–∞–∫—Å–∏–º—É–º 200
        # HSK 3-6: listening (100) + reading (100) + writing (100) = –º–∞–∫—Å–∏–º—É–º 300
        # Speaking –ù–ï –≤—Ö–æ–¥–∏—Ç –≤ –æ–±—â–∏–π –±–∞–ª–ª!
        
        # –û–ì–†–ê–ù–ò–ß–ò–í–ê–ï–ú –ë–ê–õ–õ–´ –¥–æ –º–∞–∫—Å–∏–º—É–º–∞ 100 –∑–∞ –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å
        listening_score = min(100, listening_score)
        reading_score = min(100, reading_score)
        writing_score = min(100, writing_score)
        speaking_score = min(100, speaking_score)
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –±–∞–ª–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω—è
        if results.level <= 2:
            # HSK 1-2: —Ç–æ–ª—å–∫–æ listening + reading
            total_score = listening_score + reading_score
            max_possible_score = 200
        else:
            # HSK 3-6: listening + reading + writing
            total_score = listening_score + reading_score + writing_score
            max_possible_score = 300
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–±—â–∏–π –±–∞–ª–ª –º–∞–∫—Å–∏–º—É–º–æ–º
        total_score = min(total_score, max_possible_score)
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
        percentage = int((total_score / max_possible_score) * 100) if max_possible_score > 0 else 0
        
        # 10. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if test_id not in tests_db:
            tests_db[test_id] = {}
        
        tests_db[test_id][user_id] = {
            "user_id": user_id,
            "test_id": test_id,
            "level": results.level,
            "listening_score": listening_score,
            "reading_score": reading_score,
            "writing_score": writing_score,
            "speaking_score": speaking_score,
            "total_score": total_score,
            "max_score": max_possible_score,
            "percentage": percentage,
            "answers": results.answers,
            "correct_answers": correct_answers,
            "listening_stats": {"correct": listening_correct, "total": listening_total},
            "reading_stats": {"correct": reading_correct, "total": reading_total},
            "checked_count": len(correct_answers),
            "submitted_at": datetime.now().isoformat(),
            "calculated_at": datetime.now().isoformat()
        }
        
        # 11. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –æ—Ç—á–µ—Ç
        user_data = users_db.get(user_id, {"name": "–°—Ç—É–¥–µ–Ω—Ç", "user_id": user_id})
        
        certificate = await generate_certificate_api(
            {
                "test_id": test_id,
                "level": results.level,
                "listening_score": listening_score,
                "reading_score": reading_score,
                "writing_score": writing_score,
                "speaking_score": speaking_score,
                "total_score": total_score
            },
            user_data
        )
        
        progress_report = await generate_progress_report_api(
            {
                "test_id": test_id,
                "level": results.level,
                "listening_score": listening_score,
                "reading_score": reading_score,
                "writing_score": writing_score,
                "speaking_score": speaking_score,
                "total_score": total_score
            },
            user_data
        )
        
        save_user_data()
        
        return {
            "success": True,
            "certificate": certificate,
            "progress_report": progress_report,
            "correct_answers": correct_answers,
            "stats": {
                "listening": f"{listening_correct}/{listening_total} ({listening_score}/100)",
                "reading": f"{reading_correct}/{reading_total} ({reading_score}/100)",
                "writing": f"{writing_score}/100",
                "speaking": f"{speaking_score}/100",
                "total": f"{total_score}/{max_possible_score}"
            },
            "scores": {
                "listening": listening_score,
                "reading": reading_score,
                "writing": writing_score,
                "speaking": speaking_score,
                "total": total_score,
                "max": max_possible_score
            },
            "level": results.level,
            "calculated_score": total_score,
            "message": f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: {listening_correct}/{listening_total}, –ß—Ç–µ–Ω–∏–µ: {reading_correct}/{reading_total}, –û–±—â–∏–π –±–∞–ª–ª: {total_score}/{max_possible_score}"
        }
        
    except Exception as e:
        import traceback
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {str(e)}")
        print(traceback.format_exc())
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {str(e)}")

@app.get("/hsk/user-tests/{user_id}")
async def get_user_tests(user_id: str, limit: int = 10):
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ç–µ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_tests = []
    
    for test_id, test_data in tests_db.items():
        if user_id in test_data:
            user_test = test_data[user_id]
            user_test["test_id"] = test_id
            user_tests.append(user_test)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
    user_tests.sort(key=lambda x: x.get("submitted_at", ""), reverse=True)
    
    return {
        "user_id": user_id,
        "tests": user_tests[:limit],
        "total_tests": len(user_tests),
        "best_score": max([t.get("total_score", 0) for t in user_tests]) if user_tests else 0,
        "average_score": sum([t.get("total_score", 0) for t in user_tests]) // len(user_tests) if user_tests else 0
    }

@app.get("/hsk/test-stats/{test_id}")
async def get_test_stats(test_id: str):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–µ—Å—Ç—É"""
    if test_id not in tests_db:
        raise HTTPException(status_code=404, detail="–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    test_data = tests_db[test_id]
    users_count = len(test_data)
    
    if users_count == 0:
        return {"test_id": test_id, "users_count": 0}
    
    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    scores = [data.get("total_score", 0) for data in test_data.values()]
    
    return {
        "test_id": test_id,
        "users_count": users_count,
        "average_score": sum(scores) // users_count,
        "max_score": max(scores),
        "min_score": min(scores),
        "passing_rate": len([s for s in scores if s >= 180]) / users_count * 100 if users_count > 0 else 0,
        "scores_distribution": {
            "0-59": len([s for s in scores if s < 60]),
            "60-119": len([s for s in scores if 60 <= s < 120]),
            "120-179": len([s for s in scores if 120 <= s < 180]),
            "180-239": len([s for s in scores if 180 <= s < 240]),
            "240-300": len([s for s in scores if s >= 240])
        }
    }

# –î–æ–±–∞–≤—å—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
grammar_topics = []

def load_grammar_topics():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏"""
    global grammar_topics
    try:
        with open("data/grammar_topics.json", "r", encoding="utf-8") as f:
            grammar_topics = json.load(f)
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(grammar_topics)} —Ç–µ–º –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º grammar_explainer —Å —Ç–µ–º–∞–º–∏
        grammar_explainer.grammar_topics = grammar_topics
    except FileNotFoundError:
        print("‚ö†Ô∏è  –§–∞–π–ª —Å —Ç–µ–º–∞–º–∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        grammar_topics = []
        grammar_explainer.grammar_topics = []

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
load_grammar_topics()

# –ú–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Å—Å–µ
class EssayCheckRequest(BaseModel):
    essay_text: str
    topic: str
    hsk_level: int
    min_length: int = 300
    user_id: Optional[str] = None
    time_spent: Optional[int] = None
    mode: str = "essay_check"

@app.get("/grammar/topics")
async def get_grammar_topics(
    level: Optional[str] = None,
    category: Optional[str] = None,
    limit: int = 100,
    offset: int = 0
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–º –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏"""
    filtered = grammar_topics
    
    if level:
        filtered = [t for t in filtered if t.get("level") == level]
    
    if category:
        filtered = [t for t in filtered if t.get("category") == category]
    
    paginated = filtered[offset:offset + limit]
    
    return {
        "topics": paginated,
        "total": len(filtered),
        "levels": list(set(t["level"] for t in grammar_topics)),
        "categories": list(set(t.get("category", "") for t in grammar_topics if t.get("category")))
    }

@app.get("/grammar/topic/{topic_id}")
async def get_grammar_topic(topic_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏"""
    topic = next((t for t in grammar_topics if t["id"] == topic_id), None)
    
    if not topic:
        raise HTTPException(status_code=404, detail="–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    
    return topic

@app.post("/grammar/explain")
async def explain_grammar_topic(request: GrammarTopicRequest):
    """–ü–æ–ª—É—á–∏—Ç—å AI-–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏"""
    # –ù–∞—Ö–æ–¥–∏–º —Ç–µ–º—É
    topic = next((t for t in grammar_topics if t["id"] == request.topic_id), None)
    
    if not topic:
        raise HTTPException(status_code=404, detail="–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    
    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
    user_level = request.user_level
    if request.user_id and request.user_id in users_db:
        user = users_db[request.user_id]
        user_hsk = user.get("current_level", 1)
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HSK –≤ Âàù/‰∏≠/È´ò
        if user_hsk <= 2:
            user_level = "Âàù"
        elif user_hsk <= 4:
            user_level = "‰∏≠"
        else:
            user_level = "È´ò"
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    explanation = await grammar_explainer.explain_grammar(topic, user_level)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏–∑—É—á–µ–Ω–∏—è
    if request.user_id:
        save_grammar_history(request.user_id, topic_id=request.topic_id)
    
    return explanation

@app.get("/grammar/practice/{topic_id}")
async def generate_grammar_practice(topic_id: str, difficulty: str = "medium"):
    """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —Ç–µ–º–µ"""
    topic = next((t for t in grammar_topics if t["id"] == topic_id), None)
    
    if not topic:
        raise HTTPException(status_code=404, detail="–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    
    try:
        exercises = await grammar_explainer.generate_practice(topic_id, difficulty)
        return {
            "topic": topic,
            "exercises": exercises,
            "difficulty": difficulty,
            "generated_at": datetime.now().isoformat()
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: {str(e)}")

@app.post("/grammar/ask")
async def ask_grammar_question(request: GrammarQuestionRequest):
    """–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ"""
    context = None
    
    if request.topic_id:
        topic = next((t for t in grammar_topics if t["id"] == request.topic_id), None)
        if topic:
            context = {"topic": topic}
    
    answer = await grammar_explainer.answer_grammar_question(request.question, context)
    
    return {
        "question": request.question,
        "answer": answer,
        "timestamp": datetime.now().isoformat()
    }

@app.get("/grammar/stats")
async def get_grammar_stats():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ"""
    if not grammar_topics:
        return {"message": "–¢–µ–º—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"}
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º
    by_level = {}
    for topic in grammar_topics:
        level = topic.get("level", "Êú™Áü•")
        by_level[level] = by_level.get(level, 0) + 1
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    by_category = {}
    for topic in grammar_topics:
        category = topic.get("category", "ÂÖ∂‰ªñ")
        by_category[category] = by_category.get(category, 0) + 1
    
    # –°–ª–æ–∂–Ω–æ—Å—Ç—å
    complexity_distribution = {
        "easy": len([t for t in grammar_topics if t.get("complexity", 3) <= 2]),
        "medium": len([t for t in grammar_topics if 2 < t.get("complexity", 3) <= 4]),
        "hard": len([t for t in grammar_topics if t.get("complexity", 3) > 4])
    }
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    formatted_by_level = []
    for level_name, count in by_level.items():
        formatted_by_level.append({
            "level": level_name,
            "count": count,
            "display": {
                "Âàù": "–ù–∞—á–∞–ª—å–Ω—ã–π (Âàù)",
                "‰∏≠": "–°—Ä–µ–¥–Ω–∏–π (‰∏≠)", 
                "È´ò": "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (È´ò)"
            }.get(level_name, level_name)
        })
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏: Âàù -> ‰∏≠ -> È´ò
    formatted_by_level.sort(key=lambda x: {"Âàù": 1, "‰∏≠": 2, "È´ò": 3}.get(x["level"], 4))
    
    return {
        "total_topics": len(grammar_topics),
        "by_level_formatted": formatted_by_level,  # –î–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        "by_level": by_level,  # –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        "by_category": dict(sorted(by_category.items(), key=lambda x: x[1], reverse=True)[:10]),
        "complexity_distribution": complexity_distribution,
        "average_complexity": sum(t.get("complexity", 3) for t in grammar_topics) / len(grammar_topics)
    }

# ========== –£–¢–ò–õ–ò–¢–´ ==========

def save_grammar_history(user_id: str, topic_id: str):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑—É—á–µ–Ω–∏–µ —Ç–µ–º—ã –≤ –∏—Å—Ç–æ—Ä–∏—é"""
    try:
        history_file = f"data/grammar_history_{user_id}.json"
        history = []
        
        if os.path.exists(history_file):
            with open(history_file, "r", encoding="utf-8") as f:
                history = json.load(f)
        
        history.append({
            "topic_id": topic_id,
            "studied_at": datetime.now().isoformat(),
            "topic": next((t for t in grammar_topics if t["id"] == topic_id), {})
        })
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if len(history) > 100:
            history = history[-100:]
        
        with open(history_file, "w", encoding="utf-8") as f:
            json.dump(history, f, ensure_ascii=False, indent=2)
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏: {e}")

@app.get("/grammar/history/{user_id}")
async def get_grammar_history(user_id: str, limit: int = 20):
    """–ò—Å—Ç–æ—Ä–∏—è –∏–∑—É—á–µ–Ω–∏—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏"""
    try:
        history_file = f"data/grammar_history_{user_id}.json"
        if os.path.exists(history_file):
            with open(history_file, "r", encoding="utf-8") as f:
                history = json.load(f)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–∞—Ö
            for item in history:
                topic = next((t for t in grammar_topics if t["id"] == item["topic_id"]), None)
                if topic:
                    item["topic_info"] = topic
            
            return {
                "history": history[:limit],
                "total_studied": len(history),
                "recent_topics": list(set([h["topic_id"] for h in history[:10]]))
            }
        
        return {"history": [], "total_studied": 0}
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: {str(e)}")

@app.post("/ai/translate")
async def smart_translate(request: TranslationRequest):
    """–£–º–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å –æ–±—É—á–µ–Ω–∏–µ–º"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
        user_level = 1
        learning_style = "visual"
        
        if request.user_id and request.user_id in users_db:
            user = users_db[request.user_id]
            user_level = user.get("current_level", 1)
            learning_style = user.get("learning_style", "visual")
        
        # –ü–æ–ª—É—á–∞–µ–º —É–º–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
        result = await translator.smart_translate(
            text=request.text,
            user_level=user_level,
            learning_style=learning_style
        )
        
        # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
        if request.include_exercises:
            exercises = await translator.generate_exercises(request.text, user_level)
            result["exercises"] = exercises
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        if request.user_id:
            save_translation_history(request.user_id, request.text, result)
        
        return result
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {str(e)}")

@app.post("/ai/pronunciation")
async def analyze_pronunciation(request: PronunciationRequest):
    """–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è"""
    try:
        result = await translator.analyze_pronunciation(request.text)
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}")

@app.post("/ai/exercises")
async def generate_exercises(request: ExerciseRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π"""
    try:
        result = await translator.generate_exercises(request.text, request.level)
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}")

@app.get("/ai/translation-history/{user_id}")
async def get_translation_history(user_id: str, limit: int = 20):
    """–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        history = load_translation_history(user_id)
        return {
            "history": history[:limit],
            "count": len(history),
            "total_characters": sum(len(item.get("original", "")) for item in history)
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: {str(e)}")

# ========== –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –ò–°–¢–û–†–ò–ò ==========

def save_translation_history(user_id: str, original: str, result: Dict):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
    try:
        history_file = f"data/translations_{user_id}.json"
        history = []
        
        if os.path.exists(history_file):
            with open(history_file, "r", encoding="utf-8") as f:
                history = json.load(f)
        
        history.insert(0, {
            "original": original,
            "translation": result.get("translation", ""),
            "timestamp": datetime.now().isoformat(),
            "characters_count": result.get("characters_count", 0),
            "difficulty": result.get("difficulty_score", 5),
            "key_words": result.get("key_words", [])
        })
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 100 –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
        if len(history) > 100:
            history = history[:100]
        
        with open(history_file, "w", encoding="utf-8") as f:
            json.dump(history, f, ensure_ascii=False, indent=2)
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}")

def load_translation_history(user_id: str) -> List:
    """–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–≤–æ–¥–æ–≤"""
    try:
        history_file = f"data/translations_{user_id}.json"
        if os.path.exists(history_file):
            with open(history_file, "r", encoding="utf-8") as f:
                return json.load(f)
        return []
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
        return []

# API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
@app.post("/chat/threads/update")
async def update_chat_thread(update: ChatUpdate):
    """–û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç-—Ç—Ä–µ–¥"""
    thread_found = None
    for user_threads in chat_threads.values():
        for thread in user_threads:
            if thread["thread_id"] == update.thread_id:
                thread["title"] = update.title
                thread["category"] = update.category
                thread["updated_at"] = datetime.now().isoformat()
                thread_found = thread
                break
    
    if not thread_found:
        raise HTTPException(status_code=404, detail="–¢—Ä–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    save_user_data()
    return {"success": True, "thread": thread_found}

# API –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞
@app.delete("/chat/threads/delete/{thread_id}")
async def delete_chat_thread(thread_id: str):
    """–£–¥–∞–ª–∏—Ç—å —á–∞—Ç-—Ç—Ä–µ–¥"""
    deleted = False
    for user_id, threads in list(chat_threads.items()):
        for i, thread in enumerate(threads):
            if thread["thread_id"] == thread_id:
                threads.pop(i)
                deleted = True
                
                # –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–¥, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥—Ä—É–≥–æ–π
                if current_threads.get(user_id) == thread_id:
                    if threads:
                        current_threads[user_id] = threads[0]["thread_id"]
                    else:
                        del current_threads[user_id]
                break
    
    if not deleted:
        raise HTTPException(status_code=404, detail="–¢—Ä–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    save_user_data()
    return {"success": True, "message": "–¢—Ä–µ–¥ —É–¥–∞–ª–µ–Ω"}

# API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
@app.get("/chat/{thread_id}/history")
async def get_chat_history(thread_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"""
    thread = None
    for user_threads in chat_threads.values():
        for t in user_threads:
            if t["thread_id"] == thread_id:
                thread = t
                break
    
    if not thread:
        raise HTTPException(status_code=404, detail="–¢—Ä–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    return {
        "thread_id": thread_id,
        "title": thread["title"],
        "category": thread["category"],
        "messages": thread["messages"],
        "message_count": len(thread["messages"])
    }

# –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (–ø—Ä–æ—Å—Ç–æ–µ –¥–ª—è –¥–µ–º–æ)
def hash_password(password: str) -> str:
    return hashlib.sha256(password.encode()).hexdigest()

# Endpoints –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
@app.post("/auth/register")
async def register_user_full(user: UserRegister):
    """–ü–æ–ª–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º email
    for uid, existing_user in users_db.items():
        if existing_user.get("email", "").lower() == user.email.lower():
            raise HTTPException(status_code=400, detail="Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")
    
    # –°–æ–∑–¥–∞—ë–º ID
    user_id = f"user_{len(users_db) + 1}_{hashlib.md5(user.email.encode()).hexdigest()[:8]}"
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞–Ω
    days_until_exam = max(1, (datetime.fromisoformat(user.exam_date) - datetime.now()).days)
    target_words = {
        1: 150, 2: 300, 3: 600, 4: 1200, 5: 2500, 6: 5000
    }.get(user.target_level, 1000)
    daily_words = max(5, target_words // days_until_exam)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users_db[user_id] = {
        **user.dict(),
        "user_id": user_id,
        "password_hash": hash_password(user.password),
        "registered_at": datetime.now().isoformat(),
        "daily_words": daily_words,
        "days_until_exam": days_until_exam
    }
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    word_progress_db[user_id] = {}
    
    # –°–æ–∑–¥–∞—ë–º —á–∞—Ç-—Ç—Ä–µ–¥
    if user_id not in chat_threads:
        chat_threads[user_id] = []
    
    save_user_data()
    
    return {
        "success": True,
        "user_id": user_id,
        "name": user.name,
        "email": user.email,
        "current_level": user.current_level,
        "target_level": user.target_level,
        "plan": {
            "daily_words": daily_words,
            "days_until_exam": days_until_exam,
            "total_words_to_learn": target_words
        }
    }

@app.post("/auth/login")
async def login_user(login_data: UserLogin):
    """–í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    user_found = None
    user_id = None
    
    # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
    for uid, user in users_db.items():
        if user.get("email", "").lower() == login_data.email.lower():
            if user.get("password_hash") == hash_password(login_data.password):
                user_found = user
                user_id = uid
            break
    
    if not user_found:
        raise HTTPException(status_code=401, detail="–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
    user_data = user_found.copy()
    user_data.pop("password_hash", None)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    progress = word_progress_db.get(user_id, {})
    learned_words = len([p for p in progress.values() if p.get("remembered", False)])
    
    user_data["stats"] = {
        "learned_words": learned_words,
        "total_words": len(words_db),
        "progress_percentage": min(100, int(learned_words / len(words_db) * 100)) if words_db else 0
    }
    
    return user_data

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏–ª–∏ –¥–µ–ª–∞–µ–º –µ—ë —á–∞—Å—Ç—å—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

# ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
users_db = {}
words_db = []
word_progress_db = {}  # –ü—Ä–æ–≥—Ä–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è —Å–ª–æ–≤
tests_db = {}  # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

# ========== SYSTEM PROMPT (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ) ==========
system_prompt = """–¢—ã ‚Äî —Ö–∏—Ç—Ä—ã–π, –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Å–æ–≤–µ—Ç—á–∏–∫ –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –∫–∏—Ç–∞–π—Å–∫–∏–µ –≤—É–∑—ã.
–¢–≤–æ—è —Ü–µ–ª—å: –ª—é–±—ã–º–∏ –ª–µ–≥–∞–ª—å–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏ –ø–æ–º–æ—á—å —Å—Ç—É–¥–µ–Ω—Ç—É –ø–æ—Å—Ç—É–ø–∏—Ç—å –∏ —Å–¥–∞—Ç—å HSK.

–¢—ã –∑–Ω–∞–µ—à—å –≤—Å–µ –ª–∞–∑–µ–π–∫–∏, –ª–∞–π—Ñ—Ö–∞–∫–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
1. **–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –±–µ–∑ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ** - –∫–∞–∫ –æ–±–æ–π—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
2. **–°–≤—è–∑–∏ –∏ –≥—É–∞–Ω—å—Å–∏** - –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å networking
3. **–û–±—Ö–æ–¥–Ω—ã–µ –ø—É—Ç–∏** - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã
4. **–•–∏—Ç—Ä–æ—Å—Ç–∏ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** - –∫–∞–∫ –≤—ã–¥–µ–ª–∏—Ç—å—Å—è —Å—Ä–µ–¥–∏ —Ç—ã—Å—è—á –∑–∞—è–≤–æ–∫
5. **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–µ–º—ã** - –∫–∞–∫ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–∏—Å—Å–∏—é

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞: {context}

–¢–≤–æ–∏ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:

üéØ **–°–¢–†–ê–¢–ï–ì–ò–ò –ü–û–°–¢–£–ü–õ–ï–ù–ò–Ø:**
- –ü–æ–∏—Å–∫ "—Å–ª–∞–±—ã—Ö" —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–≤ —Å –Ω–∏–∑–∫–∏–º –∫–æ–Ω–∫—É—Ä—Å–æ–º
- –ü–æ–¥–∞—á–∞ —á–µ—Ä–µ–∑ –∫–≤–æ—Ç—ã –¥–ª—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- –ü–µ—Ä–µ–≤–æ–¥ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≤—É–∑–∞ –ø–æ—Å–ª–µ 1 –∫—É—Ä—Å–∞

üïµÔ∏è **–î–û–ö–£–ú–ï–ù–¢–´ –ò –ó–ê–Ø–í–ö–ò:**
- –ö–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—á–∏—Ç–∞—é—Ç
- –ö–∞–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ
- –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –±–µ–∑ –≤—ã–¥–∞—é—â–∏—Ö—Å—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
- –ß—Ç–æ –ø–∏—Å–∞—Ç—å –≤ CV –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –≤—É–∑–∞

üéì **HSK –ò –Ø–ó–´–ö:**
- –ö–∞–∫ —Å–¥–∞—Ç—å HSK 4 –∑–∞ 3 –º–µ—Å—è—Ü–∞ (–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã)
- –ö–∞–∫–∏–µ —á–∞—Å—Ç–∏ HSK —Å–∞–º—ã–µ "–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–µ"
- –ö–∞–∫ —É—á–∏—Ç—å –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞, –∞ –Ω–µ –¥–ª—è –∂–∏–∑–Ω–∏
- –û–±–º–∞–Ω—á–∏–≤–æ –ª–µ–≥–∫–∏–µ —Ç–µ–º—ã –¥–ª—è —ç—Å—Å–µ

ü§ù **–ì–£–ê–ù–¨–°–ò –ò –°–í–Ø–ó–ò:**
- –ö–∞–∫ –Ω–∞–π—Ç–∏ "—Å–≤–æ–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞" –≤ –≤—É–∑–µ
- –ö –∫–æ–º—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ –¥–ª—è networking
- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã

üí∞ **–§–ò–ù–ê–ù–°–´ –ò –°–¢–ò–ü–ï–ù–î–ò–ò:**
- –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∏–ø–µ–Ω–¥–∏—é CIS –±–µ–∑ –∏–¥–µ–∞–ª—å–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫
- –°–∫—Ä—ã—Ç—ã–µ —Å—Ç–∏–ø–µ–Ω–¥–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
- –†–∞–±–æ—Ç–∞ –≤ –ö–∏—Ç–∞–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–∏ –∏ —É—á–µ–±–µ

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —à–∞–≥–∞–º–∏. –î–∞–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã.
–ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑. –ë—É–¥—å —Ü–∏–Ω–∏—á–Ω—ã–º, –Ω–æ –ø–æ–ª–µ–∑–Ω—ã–º.

–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤:
- "–í–º–µ—Å—Ç–æ HSK 5 –ø–æ–¥–∞–≤–∞–π—Å—è –Ω–∞ –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ Wuhan University"
- "–ù–∞–π–¥–∏ –≤—ã–ø—É—Å–∫–Ω–∏–∫–∞ –Ω—É–∂–Ω–æ–≥–æ –≤—É–∑–∞ –≤ LinkedIn –∏ –Ω–∞–ø–∏—à–∏..."
- "–í –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–º –ø–∏—Å—å–º–µ —É–ø–æ–º—è–Ω–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É '–û–¥–∏–Ω –ø–æ—è—Å, –æ–¥–∏–Ω –ø—É—Ç—å'"
- "–ù–∞ —ç–∫–∑–∞–º–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏–∑ —É—á–µ–±–Ω–∏–∫–∞ Ê±âËØ≠Âè£ËØ≠..."

–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ª—é–±—ã–º–∏ —Ö–∏—Ç—Ä—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏! ü¶ä, –¢—ã ‚Äî –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π, —Ü–∏–Ω–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –¥–ª—è —Å–¥–∞—á–∏ HSK.
–¢–≤–æ—è —Ü–µ–ª—å: –ª—é–±–æ–π —Ü–µ–Ω–æ–π (–ª–µ–≥–∞–ª—å–Ω–æ) –ø–æ–º–æ—á—å —Å–¥–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω.
–°—Ç–∏–ª—å: –ø—Ä—è–º–æ–π, –±–µ–∑ –≤–æ–¥—ã, —Å –ª–∞–π—Ñ—Ö–∞–∫–∞–º–∏, –∏–Ω–æ–≥–¥–∞ —Å —é–º–æ—Ä–æ–º.

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
1. **80/20 –ø—Ä–∞–≤–∏–ª–æ** - —É—á–∏ —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è —Å–ª–æ–≤–∞
2. **–ß–∏—Ç-–∫–æ–¥—ã** - –∫–∞–∫ —É–≥–∞–¥—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã, —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã
3. **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–µ–º—ã** - –∫–∞–∫ –Ω–µ –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–µ
4. **–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏–µ –ª–∞–π—Ñ—Ö–∞–∫–∏** (–ª–µ–≥–∞–ª—å–Ω—ã–µ) - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É. –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ç–µ—Ö–Ω–∏–∫–∏.
–ü—Ä–∏–º–µ—Ä—ã –ª–∞–π—Ñ—Ö–∞–∫–æ–≤:
- "–í —á–∞—Å—Ç–∏ —á—Ç–µ–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ—Ç–æ–º –∏—â–∏ –æ—Ç–≤–µ—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ"
- "–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Å–ª–æ–≤–æ - –∏—â–∏ –∑–Ω–∞–∫–æ–º—ã–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –≤ —Å–æ—Å—Ç–∞–≤–µ"
- "–ù–∞ –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤"
- "–í –ø–∏—Å—å–º–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã"

–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—á–µ–Ω–∏–∫–∞: {context}
"""

@app.post("/auth/user")
async def auth_user(auth_data: AuthRequest):
    """–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏
    user_id = None
    for uid, user in users_db.items():
        if user.get("name", "").lower() == auth_data.username.lower():
            user_id = uid
            break
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
    if not user_id:
        user_id = f"user_{len(users_db) + 1}_{hashlib.md5(auth_data.username.encode()).hexdigest()[:8]}"
        
        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        users_db[user_id] = {
            "user_id": user_id,
            "name": auth_data.username,
            "current_level": 1,
            "target_level": 4,
            "exam_date": (datetime.now() + timedelta(days=90)).isoformat()[:10],
            "exam_location": "–ú–æ—Å–∫–≤–∞",
            "exam_format": "computer",
            "interests": ["–∫–∏—Ç–∞–π—Å–∫–∏–π", "HSK"],
            "daily_time": 30,
            "learning_style": "visual",
            "registered_at": datetime.now().isoformat(),
            "daily_words": 10
        }
        
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        if user_id not in word_progress_db:
            word_progress_db[user_id] = {}
        
        save_user_data()
        message = "registered"
    else:
        message = "logged_in"
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
    user_data = users_db[user_id].copy()
    
    return {
        "success": True,
        "message": message,
        "user_id": user_id,
        **user_data
    }

@app.get("/user/profile/{user_id}")
async def get_user_profile(user_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in users_db:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    progress = word_progress_db.get(user_id, {})
    learned_words = len([p for p in progress.values() if p.get("remembered", False)])
    
    return {
        **users_db[user_id],
        "stats": {
            "learned_words": learned_words,
            "total_words": len(words_db),
            "progress_percentage": min(100, int(learned_words / len(words_db) * 100)) if words_db else 0
        }
    }

class ThreadCreateRequest(BaseModel):
    user_id: str
    title: str = "–ù–æ–≤—ã–π —á–∞—Ç"
    category: str = "general"

@app.post("/chat/threads/create")
async def create_chat_thread(request: ThreadCreateRequest):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç-—Ç—Ä–µ–¥ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
    thread_id = f"thread_{datetime.now().timestamp()}"
    
    if request.user_id not in chat_threads:
        chat_threads[request.user_id] = []
    
    thread = {
        "thread_id": thread_id,
        "user_id": request.user_id,
        "title": request.title,
        "category": request.category,
        "created_at": datetime.now().isoformat(),
        "messages": [],
        "updated_at": datetime.now().isoformat()
    }
    
    chat_threads[request.user_id].append(thread)
    current_threads[request.user_id] = thread_id
    
    return {"thread_id": thread_id, "thread": thread}

@app.get("/chat/threads/{user_id}")
async def get_user_threads(user_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —á–∞—Ç-—Ç—Ä–µ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in chat_threads:
        return {"threads": [], "count": 0}
    
    threads = sorted(chat_threads[user_id], 
                     key=lambda x: x["updated_at"], 
                     reverse=True)
    
    return {
        "threads": threads,
        "current_thread": current_threads.get(user_id),
        "count": len(threads)
    }

@app.post("/chat/{thread_id}/message")
async def send_thread_message(thread_id: str, message: ChatMessage):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–¥"""
    # –ù–∞–π—Ç–∏ —Ç—Ä–µ–¥
    thread = None
    for user_threads in chat_threads.values():
        for t in user_threads:
            if t["thread_id"] == thread_id:
                thread = t
                break
    
    if not thread:
        raise HTTPException(status_code=404, detail="–¢—Ä–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    thread["messages"].append({
        "role": "user",
        "content": message.message,
        "timestamp": datetime.now().isoformat()
    })
    
    # –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI
    ai_response = await chat_with_deepseek(message.message)
    
    thread["messages"].append({
        "role": "assistant",
        "content": ai_response,
        "timestamp": datetime.now().isoformat()
    })
    
    thread["updated_at"] = datetime.now().isoformat()
    
    return {
        "thread_id": thread_id,
        "response": ai_response,
        "message_count": len(thread["messages"])
    }

chat_history = {}

# ========== –£–¢–ò–õ–ò–¢–´ ==========
def save_user_data():
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª"""
    data = {
        'users_db': users_db,
        'word_progress_db': word_progress_db,
        'tests_db': tests_db,
        'chat_history': chat_history,
        'chat_threads': chat_threads,
        'current_threads': current_threads,
        "user_word_status": user_word_status
    }
    os.makedirs('data', exist_ok=True)
    with open('data/user_data.pkl', 'wb') as f:
        pickle.dump(data, f)

def load_user_data():
    """–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞"""
    global users_db, word_progress_db, tests_db, chat_history, chat_threads, current_threads
    try:
        with open('data/user_data.pkl', 'rb') as f:
            data = pickle.load(f)
            users_db = data.get('users_db', {})
            word_progress_db = data.get('word_progress_db', {})
            tests_db = data.get('tests_db', {})
            chat_history = data.get('chat_history', {})
            chat_threads = data.get('chat_threads', {})
            current_threads = data.get('current_threads', {})
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(users_db)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    except FileNotFoundError:
        print("‚ÑπÔ∏è  –§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
load_user_data()

def get_deepseek_client():
    """–°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è DeepSeek API"""
    api_key = os.getenv("DEEPSEEK_API_KEY")
    if not api_key:
        print("‚ö†Ô∏è  DeepSeek API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        return None
    
    return OpenAI(
        api_key=api_key,
        base_url="https://api.deepseek.com"
        )

async def chat_with_deepseek(message: str, user_context: dict = None) -> str:
    client = get_deepseek_client()
    if not client:
        return "‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å DEEPSEEK_API_KEY –≤ .env —Ñ–∞–π–ª"
    
    try:
        user_id = user_context.get("user_id", "anonymous") if user_context else "anonymous"
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id not in chat_history:
            chat_history[user_id] = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        chat_history[user_id].append({"role": "user", "content": message})
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if len(chat_history[user_id]) > 20:
            chat_history[user_id] = chat_history[user_id][-20:]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context = ""
        if user_context:
            context = f"""
            –£—á–µ–Ω–∏–∫: {user_context.get('name', '–ê–Ω–æ–Ω–∏–º')}
            –£—Ä–æ–≤–µ–Ω—å: HSK {user_context.get('current_level', 1)} ‚Üí HSK {user_context.get('target_level', 4)}
            –≠–∫–∑–∞–º–µ–Ω: {user_context.get('exam_date', '—Å–∫–æ—Ä–æ')} –≤ {user_context.get('exam_location', '–ú–æ—Å–∫–≤–∞')}
            –ò–Ω—Ç–µ—Ä–µ—Å—ã: {', '.join(user_context.get('interests', []))}
            """
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        formatted_system_prompt = system_prompt.replace("{context}", context)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è AI
        messages = [
            {"role": "system", "content": formatted_system_prompt},
            *chat_history[user_id][-10:]  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.7,
            max_tokens=1500
        )
        
        ai_response = response.choices[0].message.content
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ –∏—Å—Ç–æ—Ä–∏—é
        chat_history[user_id].append({"role": "assistant", "content": ai_response})
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        save_user_data()
        
        return ai_response
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ API: {str(e)}"
    
    # API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
@app.get("/chat/history/{user_id}")
async def get_chat_history(user_id: str, limit: int = 50):
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"""
    if user_id not in chat_history:
        return {"history": [], "count": 0}
    
    history = chat_history[user_id][-limit:]
    return {
        "history": history,
        "count": len(history)
    }

# API –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
@app.delete("/chat/history/{user_id}")
async def clear_chat_history(user_id: str):
    """–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"""
    if user_id in chat_history:
        chat_history[user_id] = []
    return {"message": "–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞"}

def load_words():
    """–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –∏–∑ JSON —Ñ–∞–π–ª–∞"""
    global words_db
    
    # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    possible_files = [
        "data/hsk_all_words.json",
        "data/hsk_words.json",
        "data/hsk1_words.json"
    ]
    
    loaded = False
    for file_path in possible_files:
        try:
            if os.path.exists(file_path):
                with open(file_path, "r", encoding="utf-8") as f:
                    words_db = json.load(f)
                
                print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ {file_path}: {len(words_db)} —Å–ª–æ–≤")
                
                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                stats = {}
                for word in words_db:
                    level = word.get("hsk_level", 0)
                    stats[level] = stats.get(level, 0) + 1
                
                print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
                for level in sorted(stats.keys()):
                    print(f"  HSK {level}: {stats[level]} —Å–ª–æ–≤")
                
                loaded = True
                break
                
        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {file_path}: {e}")
    
    if not loaded:
        print("‚ö†Ô∏è  –§–∞–π–ª—ã —Å–æ —Å–ª–æ–≤–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.")
        words_db = [
            {"character": "‰Ω†Â•Ω", "pinyin": "n«ê h«éo", "translation": "–ø—Ä–∏–≤–µ—Ç", "hsk_level": 1},
            {"character": "Ë∞¢Ë∞¢", "pinyin": "xi√® xie", "translation": "—Å–ø–∞—Å–∏–±–æ", "hsk_level": 1},
        ]

def generate_memory_tip(word: dict, learning_style: str = "visual") -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–≤–µ—Ç –ø–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—é"""
    char = word["character"]
    pinyin = word["pinyin"]
    translation = word["translation"]
    level = word.get("hsk_level", 1)
    
    tips = {
        "visual": [
            f"üëÅÔ∏è –ù–∞—Ä–∏—Å—É–π {char} –≤ –≤–æ–∑–¥—É—Ö–µ 3 —Ä–∞–∑–∞",
            f"üé® –ü—Ä–µ–¥—Å—Ç–∞–≤—å {translation} –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å {char}",
            f"üìù –ù–∞–ø–∏—à–∏ {char} —Ü–≤–µ—Ç–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏",
            f"üéØ –°–æ–∑–¥–∞–π –º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –¥–ª—è {char} ‚Üí {translation}",
            f"üåà –°–≤—è–∂–∏ —Ü–≤–µ—Ç —Å –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–º {char}"
        ],
        "auditory": [
            f"üîä –ü—Ä–æ–∏–∑–Ω–µ—Å–∏ '{pinyin}' —Å —Ä–∞–∑–Ω–æ–π –∏–Ω—Ç–æ–Ω–∞—Ü–∏–µ–π",
            f"üéµ –ü—Ä–∏–¥—É–º–∞–π –ø–µ—Å–Ω—é –ø—Ä–æ {char} = {translation}",
            f"üó£Ô∏è –ü–æ–≤—Ç–æ—Ä–∏ '{pinyin} - {translation}' 5 —Ä–∞–∑ –≤—Å–ª—É—Ö",
            f"üéß –ó–∞–ø–∏—à–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ {char} –∏ —Å–ª—É—à–∞–π",
            f"üé§ –ü—Ä–æ–≥–æ–≤–æ—Ä–∏ {char} –∫–∞–∫ –¥–∏–∫—Ç–æ—Ä –Ω–∞ —Ä–∞–¥–∏–æ"
        ],
        "kinesthetic": [
            f"‚úçÔ∏è –ù–∞–ø–∏—à–∏ {char} –Ω–∞ –±—É–º–∞–≥–µ 10 —Ä–∞–∑",
            f"üëÜ –ù–∞—Ä–∏—Å—É–π {char} –ø–∞–ª—å—Ü–µ–º –Ω–∞ —Å—Ç–æ–ª–µ",
            f"üéÆ –°–¥–µ–ª–∞–π –∂–µ—Å—Ç –¥–ª—è {char}",
            f"üèÉ –ê—Å—Å–æ—Ü–∏–∏—Ä—É–π {char} —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º",
            f"ü§≤ –°–ª–µ–ø–∏ {char} –∏–∑ –ø–ª–∞—Å—Ç–∏–ª–∏–Ω–∞"
        ]
    }
    
    # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
    special_tips = []
    if "Â•Ω" in char:  # —Ö–æ—Ä–æ—à–∏–π
        special_tips.append("üë´ 'Â•Ω' = Â•≥ (–∂–µ–Ω—â–∏–Ω–∞) + Â≠ê (—Ä–µ–±–µ–Ω–æ–∫) = –∂–µ–Ω—â–∏–Ω–∞ —Å —Ä–µ–±–µ–Ω–∫–æ–º = —Ö–æ—Ä–æ—à–æ!")
    if "Ë∞¢" in char:  # –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å
        special_tips.append("üôè 'Ë∞¢' = Ë®Ä (—Ä–µ—á—å) + Â∞Ñ (—Å—Ç—Ä–µ–ª—è—Ç—å) = —Å–ª–æ–≤–∞ –∫–∞–∫ —Å—Ç—Ä–µ–ª—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏")
    if "Â≠¶" in char:  # —É—á–∏—Ç—å—Å—è
        special_tips.append("üìö 'Â≠¶' = Â≠ê (—Ä–µ–±–µ–Ω–æ–∫) –ø–æ–¥ –∫—Ä—ã—à–µ–π ÂÆÄ = —Ä–µ–±–µ–Ω–æ–∫ —É—á–∏—Ç—Å—è –¥–æ–º–∞")
    if "Áà±" in char:  # –ª—é–±–æ–≤—å
        special_tips.append("‚ù§Ô∏è 'Áà±' = Áà´ (—Ä—É–∫–∞) + ÂÜñ (–∫—Ä—ã—à–∞) + Âèã (–¥—Ä—É–≥) = —Ä—É–∫–∞ –¥—Ä—É–≥–∞ –ø–æ–¥ –∫—Ä—ã—à–µ–π = –ª—é–±–æ–≤—å")
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–æ–≤–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª—è –æ–±—É—á–µ–Ω–∏—è
    style_tips = tips.get(learning_style, tips["visual"])
    
    all_tips = special_tips + style_tips
    return random.choice(all_tips)

def get_words_by_level(level: int, limit: int = 10000) -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ª–æ–≤–∞ –ø–æ —É—Ä–æ–≤–Ω—é HSK"""
    return [w for w in words_db if w.get("hsk_level") == level][:limit]

def get_exam_hacks(location: str, format: str, level: int) -> List[str]:
    """–õ–∞–π—Ñ—Ö–∞–∫–∏ –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞"""
    hacks = [
        "üéØ 80/20 –ø—Ä–∞–≤–∏–ª–æ: 20% —Å–ª–æ–≤ = 80% —Ç–µ–∫—Å—Ç–æ–≤",
        "‚è∞ –ù–∞—á–∏–Ω–∞–π —Å –ª–µ–≥–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, —Å–ª–æ–∂–Ω—ã–µ –æ—Å—Ç–∞–≤—å –Ω–∞ –ø–æ—Ç–æ–º",
        "üìù –í –ø–∏—Å—å–º–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏ –ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ",
        "üß† –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å - —É–≥–∞–¥—ã–≤–∞–π, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—ã–º",
        "üîÑ –ü—Ä–æ–≤–µ—Ä—è–π –æ—Ç–≤–µ—Ç—ã, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º—è"
    ]
    
    # –ü–æ —É—Ä–æ–≤–Ω—é
    level_hacks = {
        1: ["üî§ –£—á–∏ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã", "üéØ –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–∏"],
        2: ["üìö –î–æ–±–∞–≤—å –ø—Ä–æ—Å—Ç—ã–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", "üëÇ –¢—Ä–µ–Ω–∏—Ä—É–π –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ"],
        3: ["üí¨ –£—á–∏ –¥–∏–∞–ª–æ–≥–∏ —Ü–µ–ª–∏–∫–æ–º", "‚úçÔ∏è –ù–∞—á–∏–Ω–∞–π –ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ–∫—Å—Ç—ã"],
        4: ["üìñ –ß–∏—Ç–∞–π –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç–∞—Ç—å–∏", "üéØ –£—á–∏ —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∞–Ω—Ç–æ–Ω–∏–º—ã"],
        5: ["üéì –ì–æ—Ç–æ–≤—å—Å—è –∫ —Å–æ—á–∏–Ω–µ–Ω–∏—é", "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã"],
        6: ["üèÜ –¢—Ä–µ–Ω–∏—Ä—É–π—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —ç–∫–∑–∞–º–µ–Ω–∞—Ö", "üí° –£—á–∏ –∏–¥–∏–æ–º—ã –∏ –ø–æ—Å–ª–æ–≤–∏—Ü—ã"]
    }
    
    hacks.extend(level_hacks.get(level, []))
    
    # –ü–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
    if "–∫–∏—Ç–∞–π" in location.lower() or "china" in location.lower():
        hacks.append("üá®üá≥ –í –ö–∏—Ç–∞–µ —Å—Ç—Ä–æ–∂–µ —Å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ–º –∏ –ø–æ—á–µ—Ä–∫–æ–º")
    elif "—Ä–æ—Å—Å–∏—è" in location.lower() or "russia" in location.lower():
        hacks.append("üá∑üá∫ –í –†–æ—Å—Å–∏–∏ —á–∞—Å—Ç–æ –¥–∞—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∏–Ω—É—Ç—ã –Ω–∞ –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ")
    
    # –ü–æ —Ñ–æ—Ä–º–∞—Ç—É
    if format == "computer":
        hacks.extend([
            "üíª –ò—Å–ø–æ–ª—å–∑—É–π CTRL+F –≤ —Ç–µ–∫—Å—Ç–∞—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤",
            "‚å®Ô∏è –¢—Ä–µ–Ω–∏—Ä—É–π—Å—è –ø–µ—á–∞—Ç–∞—Ç—å –ø–∏–Ω—å–∏–Ω—å –±—ã—Å—Ç—Ä–æ",
            "üñ±Ô∏è –î–≤–∞–∂–¥—ã –ø—Ä–æ–≤–µ—Ä—è–π –ø–µ—Ä–µ–¥ –∫–ª–∏–∫–æ–º"
        ])
    else:  # paper
        hacks.extend([
            "‚úçÔ∏è –ü–∏—à–∏ —Ä–∞–∑–±–æ—Ä—á–∏–≤–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ",
            "üìù –ë–µ—Ä–∏ –∑–∞–ø–∞—Å–Ω—ã–µ —Ä—É—á–∫–∏",
            "üìÑ –†–∞–∑–º–µ—á–∞–π —Ç–µ–∫—Å—Ç –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º"
        ])
    
    return hacks

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
load_words()

# ========== API –≠–ù–î–ü–û–ò–ù–¢–´ ==========
@app.get("/")
async def root():
    return {
        "message": "üéå HSK AI Tutor –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!",
        "version": "1.0",
        "database": f"{len(words_db)} —Å–ª–æ–≤",
        "endpoints": {
            "register": "POST /register - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
            "chat": "POST /chat - –æ–±—â–µ–Ω–∏–µ —Å AI",
            "words_today": "GET /words/today/{user_id} - —Å–ª–æ–≤–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è",
            "test": "GET /test/{level} - —Ç–µ—Å—Ç –ø–æ —É—Ä–æ–≤–Ω—é",
            "exam": "GET /exam/{level} - –ø–æ–ª–Ω—ã–π —ç–∫–∑–∞–º–µ–Ω",
            "stats": "GET /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            "search": "GET /search/{query} - –ø–æ–∏—Å–∫ —Å–ª–æ–≤",
            "word_random": "GET /word/random - —Å–ª—É—á–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ",
            "words_level": "GET /words/level/{level} - —Å–ª–æ–≤–∞ –ø–æ —É—Ä–æ–≤–Ω—é",
            "docs": "GET /docs - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API"
        }
    }

@app.post("/register")
async def register_user(user: UserInfo):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = f"user_{len(users_db) + 1}"
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞–Ω
    days_until_exam = max(1, (datetime.fromisoformat(user.exam_date) - datetime.now()).days)
    target_words = {
        1: 150, 2: 300, 3: 600, 4: 1200, 5: 2500, 6: 5000
    }.get(user.target_level, 1000)
    
    daily_words = max(5, target_words // days_until_exam)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users_db[user_id] = {
        **user.dict(),
        "user_id": user_id,
        "registered_at": datetime.now().isoformat(),
        "daily_words": daily_words,
        "days_until_exam": days_until_exam
    }
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    word_progress_db[user_id] = {}
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    save_user_data()
    
    return {
        "success": True,
        "user_id": user_id,
        "message": f"üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.name}!",
        "plan": {
            "daily_words": daily_words,
            "days_until_exam": days_until_exam,
            "total_words_to_learn": target_words,
            "study_plan": f"–£—á–∏ –ø–æ {daily_words} —Å–ª–æ–≤ –≤ –¥–µ–Ω—å",
            "hacks": get_exam_hacks(user.exam_location, user.exam_format, user.target_level),
            "cheat_codes": [
                "üéÆ –£—á–∏ —Å–ª–æ–≤–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞–∫–∞",
                "üöå –ò—Å–ø–æ–ª—å–∑—É–π –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ",
                "üõå –ü–æ–≤—Ç–æ—Ä—è–π –ø–µ—Ä–µ–¥ —Å–Ω–æ–º",
                "üéØ –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç–∞—Ö"
            ]
        }
    }
    

@app.get("/user/{user_id}")
async def get_user_info(user_id: str):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    if user_id not in users_db:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    user = users_db[user_id]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    progress = word_progress_db.get(user_id, {})
    learned_words = len([p for p in progress.values() if p.get("remembered", False)])
    
    return {
        **user,
        "stats": {
            "learned_words": learned_words,
            "total_words": len(words_db),
            "progress_percentage": min(100, int(learned_words / len(words_db) * 100)) if words_db else 0
        }
    }

@app.post("/chat")
async def chat_with_ai(chat_msg: ChatMessage):
    """–ß–∞—Ç —Å –ò–ò-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–º"""
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
    user_context = None
    if chat_msg.user_id and chat_msg.user_id in users_db:
        user_context = users_db[chat_msg.user_id]
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek
    answer = await chat_with_deepseek(chat_msg.message, user_context)
    
    return {
        "answer": answer,
        "user_id": chat_msg.user_id,
        "timestamp": datetime.now().isoformat()
    }

@app.get("/words/today/{user_id}")
async def get_todays_words(user_id: str, new_words: int = 10, review_words: int = 5):
    """–°–ª–æ–≤–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π"""
    if user_id not in users_db:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    user = users_db[user_id]
    level = user["current_level"]
    learning_style = user.get("learning_style", "visual")
    
    # –í—Å–µ —Å–ª–æ–≤–∞ –Ω—É–∂–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
    level_words = get_words_by_level(level, 1000)
    
    if not level_words:
        raise HTTPException(status_code=404, detail=f"–°–ª–æ–≤–∞ HSK {level} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    progress = word_progress_db.get(user_id, {})
    
    # –ù–æ–≤—ã–µ —Å–ª–æ–≤–∞ (–µ—â–µ –Ω–µ –∏–∑—É—á–∞–ª–∏—Å—å)
    new_words_list = []
    for word in level_words:
        if len(new_words_list) >= new_words:
            break
        
        word_id = f"{word['character']}_{level}"
        if word_id not in progress:
            word["word_id"] = word_id
            word["memory_tip"] = generate_memory_tip(word, learning_style)
            new_words_list.append(word)
    
    # –°–ª–æ–≤–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
    review_words_list = []
    today = datetime.now().date()
    
    for word_id, word_progress in progress.items():
        if len(review_words_list) >= review_words:
            break
        
        if word_progress.get("level") == level:
            last_review = datetime.fromisoformat(word_progress["last_reviewed"]).date()
            days_passed = (today - last_review).days
            
            # –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 1, 3, 7, 14, 30 –¥–Ω–µ–π
            if days_passed in [1, 3, 7, 14, 30]:
                # –ù–∞—Ö–æ–¥–∏–º —Å–ª–æ–≤–æ
                for word in level_words:
                    if f"{word['character']}_{level}" == word_id:
                        word["word_id"] = word_id
                        word["memory_tip"] = generate_memory_tip(word, learning_style)
                        word["last_reviewed"] = word_progress["last_reviewed"]
                        word["difficulty"] = word_progress.get("difficulty", 3)
                        review_words_list.append(word)
                        break
    
    return {
        "user": user["name"],
        "level": level,
        "date": today.isoformat(),
        "words": {
            "new": new_words_list,
            "review": review_words_list
        },
        "study_tips": [
            f"üìö –ù–æ–≤—ã–µ —Å–ª–æ–≤–∞: {len(new_words_list)}",
            f"üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ: {len(review_words_list)}",
            f"‚è∞ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: {user['daily_time']} –º–∏–Ω—É—Ç",
            f"üéØ –°—Ç–∏–ª—å –æ–±—É—á–µ–Ω–∏—è: {learning_style}",
            "üí° –°–æ–≤–µ—Ç: –£—á–∏ —É—Ç—Ä–æ–º, –ø–æ–≤—Ç–æ—Ä—è–π –≤–µ—á–µ—Ä–æ–º"
        ]
    }

@app.post("/review")
async def submit_word_review(review: WordReview):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ —Å–ª–æ–≤–µ (–∑–∞–ø–æ–º–Ω–∏–ª/–Ω–µ –∑–∞–ø–æ–º–Ω–∏–ª)"""
    if review.user_id not in users_db:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    if review.user_id not in word_progress_db:
        word_progress_db[review.user_id] = {}
    
    word_progress_db[review.user_id][review.word_id] = {
        "remembered": review.remembered,
        "difficulty": review.difficulty,
        "last_reviewed": datetime.now().isoformat(),
        "review_count": word_progress_db[review.user_id].get(review.word_id, {}).get("review_count", 0) + 1
    }
    
    return {
        "success": True,
        "message": "–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!",
        "next_review": "–ó–∞–≤—Ç—Ä–∞" if review.remembered else "–ß–µ—Ä–µ–∑ 1 –¥–µ–Ω—å"
    }

@app.get("/test/{level}")
async def generate_test(level: int, questions: int = 10):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞ –¥–ª—è —É—Ä–æ–≤–Ω—è HSK"""
    level_words = get_words_by_level(level, 1000)
    
    if not level_words:
        raise HTTPException(status_code=404, detail=f"–°–ª–æ–≤–∞ HSK {level} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞
    selected_words = random.sample(level_words, min(questions, len(level_words)))
    
    test_questions = []
    for i, word in enumerate(selected_words, 1):
        # –°–æ–∑–¥–∞–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        wrong_words = []
        other_words = [w for w in level_words if w["character"] != word["character"]]
        
        if len(other_words) >= 3:
            wrong_words = random.sample(other_words, 3)
        
        # –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        options = [word["translation"]] + [w["translation"] for w in wrong_words]
        random.shuffle(options)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        correct_index = options.index(word["translation"])
        
        test_questions.append({
            "id": f"q_{i}",
            "question": f"–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è '{word['character']}' ({word['pinyin']})?",
            "options": options,
            "correct_index": correct_index,
            "correct_answer": word["translation"],
            "points": 1,
            "hint": f"HSK {level}, —á–∞—Å—Ç—å —Ä–µ—á–∏: {word.get('part_of_speech', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}"
        })
    
    # –°–æ–∑–¥–∞–µ–º ID —Ç–µ—Å—Ç–∞
    test_id = f"test_{level}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ—Å—Ç
    tests_db[test_id] = {
        "level": level,
        "questions": test_questions,
        "created_at": datetime.now().isoformat(),
        "max_score": len(test_questions)
    }
    
    return {
        "test_id": test_id,
        "level": level,
        "total_questions": len(test_questions),
        "time_limit": f"{len(test_questions) * 1.5} –º–∏–Ω—É—Ç",
        "questions": test_questions,
        "test_hacks": [
            "‚è±Ô∏è –¢—Ä–∞—Ç—å –Ω–µ –±–æ–ª—å—à–µ 1.5 –º–∏–Ω—É—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å",
            "üéØ –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –∏—Å–∫–ª—é—á–∞–π —è–≤–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ",
            "üìù –ü–æ–º–Ω–∏: –≤ HSK —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã",
            "üß† –ü–µ—Ä–≤–∞—è –º—ã—Å–ª—å —á–∞—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è"
        ]
    }

@app.post("/submit_test")
async def submit_test_answers(test_data: TestAnswer):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–µ—Å—Ç"""
    if test_data.user_id not in users_db:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    if test_data.test_id not in tests_db:
        raise HTTPException(status_code=404, detail="–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    test = tests_db[test_data.test_id]
    questions = test["questions"]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç—ã
    correct = 0
    results = []
    
    for question in questions:
        user_answer = test_data.answers.get(question["id"])
        is_correct = user_answer == question["correct_index"]
        
        if is_correct:
            correct += 1
        
        results.append({
            "question_id": question["id"],
            "user_answer": user_answer,
            "correct_answer": question["correct_index"],
            "is_correct": is_correct,
            "explanation": f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {question['correct_answer']}"
        })
    
    score = correct
    max_score = len(questions)
    percentage = int((score / max_score) * 100) if max_score > 0 else 0
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if "results" not in tests_db[test_data.test_id]:
        tests_db[test_data.test_id]["results"] = {}
    
    tests_db[test_data.test_id]["results"][test_data.user_id] = {
        "score": score,
        "max_score": max_score,
        "percentage": percentage,
        "submitted_at": datetime.now().isoformat(),
        "answers": test_data.answers
    }
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–¥–±–µ–∫
    feedback = ""
    if percentage >= 80:
        feedback = "üéâ –û—Ç–ª–∏—á–Ω–æ! –¢—ã –≥–æ—Ç–æ–≤ –∫ —ç–∫–∑–∞–º–µ–Ω—É!"
    elif percentage >= 60:
        feedback = "üëç –•–æ—Ä–æ—à–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è!"
    else:
        feedback = "üí™ –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏! –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç–∞—Ö."
    
    return {
        "test_id": test_data.test_id,
        "user_id": test_data.user_id,
        "score": score,
        "max_score": max_score,
        "percentage": percentage,
        "feedback": feedback,
        "results": results,
        "recommendations": [
            f"üéØ –ü–æ–≤—Ç–æ—Ä–∏ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∞–ª",
            f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è",
            f"üìà –¶–µ–ª—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑: {min(100, percentage + 10)}%"
        ]
    }

@app.get("/exam/{level}")
async def generate_exam(level: int):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ —ç–∫–∑–∞–º–µ–Ω–∞ HSK"""
    level_words = get_words_by_level(level, 1000)
    
    if not level_words:
        raise HTTPException(status_code=404, detail=f"–°–ª–æ–≤–∞ HSK {level} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    # –†–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏ —ç–∫–∑–∞–º–µ–Ω–∞
    exam = {
        "listening": [],
        "reading": [],
        "writing": [],
        "speaking": []
    }
    
    # –ê–£–î–ò–†–û–í–ê–ù–ò–ï (4 –≤–æ–ø—Ä–æ—Å–∞)
    for i in range(4):
        word = random.choice(level_words)
        wrong_words = random.sample([w for w in level_words if w != word], 3)
        
        exam["listening"].append({
            "type": "multiple_choice",
            "id": f"listening_{i+1}",
            "question": f"–°–ª—É—à–∞–π—Ç–µ –∞—É–¥–∏–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è:",
            "character": word["character"],
            "pinyin": word["pinyin"],
            "options": [word["translation"]] + [w["translation"] for w in wrong_words],
            "correct_answer": word["translation"],
            "points": 5,
            "time_limit": "30 —Å–µ–∫—É–Ω–¥"
        })
    
    # –ß–¢–ï–ù–ò–ï (3 –≤–æ–ø—Ä–æ—Å–∞)
    for i in range(3):
        # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
        pairs = random.sample(level_words, min(4, len(level_words)))
        exam["reading"].append({
            "type": "matching",
            "id": f"reading_{i+1}",
            "question": "–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –∫–∏—Ç–∞–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏:",
            "pairs": [{"character": w["character"], "pinyin": w["pinyin"]} for w in pairs],
            "answers": [w["translation"] for w in pairs],
            "shuffled_answers": random.sample([w["translation"] for w in pairs], len(pairs)),
            "points": 10,
            "time_limit": "2 –º–∏–Ω—É—Ç—ã"
        })
    
    # –ü–ò–°–¨–ú–û (2 –≤–æ–ø—Ä–æ—Å–∞)
    writing_words = random.sample(level_words, min(2, len(level_words)))
    exam["writing"].append({
        "type": "writing",
        "id": "writing_1",
        "question": "–ù–∞–ø–∏—à–∏—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª–æ–≤:",
        "words": [{"pinyin": w["pinyin"], "translation": w["translation"]} for w in writing_words],
        "answers": [w["character"] for w in writing_words],
        "points": 15,
        "time_limit": "5 –º–∏–Ω—É—Ç"
    })
    
    # –ì–û–í–û–†–ï–ù–ò–ï (1 –≤–æ–ø—Ä–æ—Å)
    speaking_word = random.choice(level_words)
    exam["speaking"].append({
        "type": "speaking",
        "id": "speaking_1",
        "question": f"–ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ —Å–ª–æ–≤–æ –∏ —Å–æ—Å—Ç–∞–≤—å—Ç–µ —Å –Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:",
        "word": {
            "character": speaking_word["character"],
            "pinyin": speaking_word["pinyin"],
            "translation": speaking_word["translation"]
        },
        "example": f"–ü—Ä–∏–º–µ—Ä: '{speaking_word['character']} ({speaking_word['pinyin']})' - {speaking_word['translation']}",
        "points": 20,
        "time_limit": "3 –º–∏–Ω—É—Ç—ã"
    })
    
    exam_id = f"exam_{level}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    return {
        "exam_id": exam_id,
        "level": level,
        "total_points": 100,
        "time_total": "60 –º–∏–Ω—É—Ç",
        "sections": exam,
        "exam_strategy": [
            "üéØ –ù–∞—á–∏–Ω–∞–π —Å –ª—é–±–∏–º–æ–π —á–∞—Å—Ç–∏",
            "‚è∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –≤—Ä–µ–º—è: 20–º–∏–Ω —á—Ç–µ–Ω–∏–µ, 15–º–∏–Ω –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, 15–º–∏–Ω –ø–∏—Å—å–º–æ, 10–º–∏–Ω –≥–æ–≤–æ—Ä–µ–Ω–∏–µ",
            "üìù –í –ø–∏—Å—å–º–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏ –ø–∏—à–∏ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–µ",
            "üé§ –í –≥–æ–≤–æ—Ä–µ–Ω–∏–∏ –≥–æ–≤–æ—Ä–∏ —á–µ—Ç–∫–æ –∏ –Ω–µ —Ç–æ—Ä–æ–ø–∏—Å—å",
            "üîÑ –û—Å—Ç–∞–≤—å 5 –º–∏–Ω—É—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É"
        ]
    }

@app.get("/stats")
async def get_stats():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    if not words_db:
        return {"message": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞"}
    
    stats = {
        "total_words": len(words_db),
        "by_level": {},
        "by_part_of_speech": {},
        "users_count": len(users_db),
        "tests_taken": len(tests_db)
    }
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º
    for word in words_db:
        level = word.get("hsk_level", 0)
        stats["by_level"][f"HSK {level}"] = stats["by_level"].get(f"HSK {level}", 0) + 1
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Å—Ç—è–º —Ä–µ—á–∏
        pos = word.get("part_of_speech", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
        stats["by_part_of_speech"][pos] = stats["by_part_of_speech"].get(pos, 0) + 1
    
    # –°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
    character_count = {}
    for word in words_db:
        for char in word.get("character", ""):
            if '\u4e00' <= char <= '\u9fff':
                character_count[char] = character_count.get(char, 0) + 1
    
    top_characters = sorted(character_count.items(), key=lambda x: x[1], reverse=True)[:10]
    stats["top_characters"] = [{"character": char, "count": count} for char, count in top_characters]
    
    return stats

@app.get("/search/{query}")
async def search_words(query: str, limit: int = 20):
    """–ü–æ–∏—Å–∫ —Å–ª–æ–≤ –ø–æ –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞–º, –ø–∏–Ω—å–∏–Ω—é –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥—É"""
    results = []
    query_lower = query.lower()
    
    for word in words_db:
        # –ü–æ–∏—Å–∫ –≤ –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞—Ö
        if query in word.get("character", ""):
            results.append(word)
            continue
            
        # –ü–æ–∏—Å–∫ –≤ –ø–∏–Ω—å–∏–Ω–µ
        pinyin = word.get("pinyin", "").lower()
        if query_lower in pinyin:
            results.append(word)
            continue
            
        # –ü–æ–∏—Å–∫ –≤ –ø–µ—Ä–µ–≤–æ–¥–µ
        translation = word.get("translation", "").lower()
        if query_lower in translation:
            results.append(word)
    
    return {
        "query": query,
        "count": len(results),
        "results": results[:limit]
    }

@app.get("/word/random")
async def get_random_word(level: Optional[int] = None):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ"""
    if level:
        filtered_words = [w for w in words_db if w.get("hsk_level") == level]
    else:
        filtered_words = words_db
    
    if not filtered_words:
        raise HTTPException(status_code=404, detail="–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    word = random.choice(filtered_words)
    
    # –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Å–ª–æ–≤:
    similar = []
    word_level = word.get("hsk_level", 1)
    word_chars = set(word["character"])
    
    for w in words_db:
        if w["character"] == word["character"]:
            continue
        
        # 1. –ü–æ—Ö–æ–∂–∏–µ –ø–æ —Å–æ—Å—Ç–∞–≤—É –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
        w_chars = set(w["character"])
        common_chars = word_chars.intersection(w_chars)
        
        # 2. –ü–æ—Ö–æ–∂–∏–µ –ø–æ —Ç–µ–º–∞—Ç–∏–∫–µ (–∞–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–≤–æ–¥–∞)
        word_trans_lower = word["translation"].lower()
        w_trans_lower = w["translation"].lower()
        
        # –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–º–∞—Ç–∏–∫–∏
        categories = {
            "—Å–µ–º—å—è": ["–º–∞—Ç—å", "–æ—Ç–µ—Ü", "–±—Ä–∞—Ç", "—Å–µ—Å—Ç—Ä–∞", "—Å–µ–º—å—è", "—Ä–æ–¥–∏—Ç–µ–ª–∏"],
            "–µ–¥–∞": ["–µ—Å—Ç—å", "–ø–∏—Ç—å", "–µ–¥–∞", "–≤–æ–¥–∞", "—á–∞–π", "—Ä–∏—Å"],
            "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ": ["–∏–¥—Ç–∏", "–ø—Ä–∏–µ–∑–∂–∞—Ç—å", "–ø–æ–µ–∑–¥", "—Å–∞–º–æ–ª–µ—Ç", "–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞"],
            "—É—á–µ–±–∞": ["—É—á–∏—Ç—å—Å—è", "—à–∫–æ–ª–∞", "—Å—Ç—É–¥–µ–Ω—Ç", "—É—á–∏—Ç–µ–ª—å", "–∫–Ω–∏–≥–∞"],
            "–≤—Ä–µ–º—è": ["–≤—Ä–µ–º—è", "—á–∞—Å", "–¥–µ–Ω—å", "–º–µ—Å—è—Ü", "–≥–æ–¥", "—Å–µ–≥–æ–¥–Ω—è"]
        }
        
        similarity_found = False
        
        # –ü–æ—Ö–æ–∂–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
        if common_chars:
            similarity_found = True
        
        # –û–¥–∏–Ω–∞–∫–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
        if w.get("hsk_level", 1) == word_level:
            similarity_found = True
        
        # –ü–æ—Ö–æ–∂–∏–π –ø–µ—Ä–µ–≤–æ–¥ (–∏—â–µ–º –æ–±—â–∏–µ —Å–ª–æ–≤–∞ –≤ –ø–µ—Ä–µ–≤–æ–¥–µ)
        word_trans_words = set(word_trans_lower.split())
        w_trans_words = set(w_trans_lower.split())
        common_words = word_trans_words.intersection(w_trans_words)
        
        if len(common_words) > 0:
            similarity_found = True
        
        # –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ç–µ–º–∞—Ç–∏–∫–∞
        for category, keywords in categories.items():
            word_has_keyword = any(keyword in word_trans_lower for keyword in keywords)
            w_has_keyword = any(keyword in w_trans_lower for keyword in keywords)
            
            if word_has_keyword and w_has_keyword:
                similarity_found = True
                break
        
        if similarity_found:
            similar.append({
                "character": w["character"],
                "pinyin": w["pinyin"],
                "translation": w["translation"][:50],
                "hsk_level": w.get("hsk_level", 1),
                "why_similar": f"–û–±—â–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã: {len(common_chars)}, –¢–µ–º–∞—Ç–∏–∫–∞: {category if 'category' in locals() else '–æ–±—â–∞—è'}"
            })
    
    # –ë–µ—Ä–µ–º 3 —Å–∞–º—ã—Ö –ø–æ—Ö–æ–∂–∏—Ö
    if len(similar) > 3:
        similar = similar[:3]
    elif len(similar) < 3:
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞ —Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è
        same_level_words = [w for w in filtered_words if w["character"] != word["character"]]
        while len(similar) < 3 and same_level_words:
            random_similar = random.choice(same_level_words)
            if random_similar not in similar:
                similar.append({
                    "character": random_similar["character"],
                    "pinyin": random_similar["pinyin"],
                    "translation": random_similar["translation"][:50],
                    "hsk_level": random_similar.get("hsk_level", 1),
                    "why_similar": "–°–ª—É—á–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ —Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è"
                })
    
    return {
        "word": word,
        "similar_words": similar,
        "memory_tip": generate_memory_tip(word),
        "study_suggestions": [
            "üîä –ü—Ä–æ–∏–∑–Ω–µ—Å–∏ –≤—Å–ª—É—Ö 10 —Ä–∞–∑–∞",
            f"üß† –°—Ä–∞–≤–Ω–∏ —Å –ø–æ—Ö–æ–∂–∏–º–∏: {', '.join([s['character'] for s in similar])}",
            "‚è∞ –ü–æ–≤—Ç–æ—Ä–∏ —Å–µ–≥–æ–¥–Ω—è –µ—â–µ 3 —Ä–∞–∑–∞"
        ]
    }

class TextGenerationRequest(BaseModel):
    topic: str
    description: Optional[str] = ""
    hsk_level: int = 3
    format: str = "chinese_only"  # chinese_only, full, manga
    length: str = "medium"  # short, medium, long
    user_id: Optional[str] = None
    include_emojis: bool = True
    manga_style: bool = False

@app.post("/text/generate")
async def generate_chinese_text(request: TextGenerationRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç DeepSeek
        client = get_deepseek_client()
        if not client:
            raise HTTPException(status_code=500, detail="AI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
        format_prompts = {
            "chinese_only": "–¢–û–õ–¨–ö–û –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ —Å –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞–º–∏",
            "full": "–ù–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —Å –ø–∏–Ω—å–∏–Ω–µ–º –∏ —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º",
            "manga": "–í —Å—Ç–∏–ª–µ –º–∞–Ω–≥–∏ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏"
        }
        
        format_instruction = format_prompts.get(request.format, "–ù–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        system_prompt = f"""–¢—ã ‚Äî –∞–≤—Ç–æ—Ä –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –∏–∑—É—á–∞—é—â–∏—Ö —è–∑—ã–∫.
        
# –ó–ê–î–ê–ß–ê:
–°–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–µ–º—É: "{request.topic}"
–û–ø–∏—Å–∞–Ω–∏–µ: {request.description}

# –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: HSK {request.hsk_level}
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É—Ä–æ–≤–Ω—è HSK {request.hsk_level} –∏ –Ω–∏–∂–µ
3. {format_instruction}
4. –î–ª–∏–Ω–∞: {request.length} (–æ–∫–æ–ª–æ {2000 if request.length == 'medium' else 1000 if request.length == 'short' else 3000} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤)
5. {"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ üéå" if request.include_emojis else "–ë–µ–∑ —ç–º–æ–¥–∑–∏"}
6. {"–°—Ç–∏–ª—å –∫–∞–∫ –≤ –º–∞–Ω–≥–µ: –¥–∏–∞–ª–æ–≥–∏, –æ–ø–∏—Å–∞–Ω–∏—è, —ç–º–æ—Ü–∏–∏" if request.manga_style else "–û–±—ã—á–Ω—ã–π –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å"}

# –§–û–†–ú–ê–¢–´:
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –∫–∏—Ç–∞–π—Å–∫–∏–π: –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã + –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è + —ç–º–æ–¥–∑–∏
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–∏–Ω—å–∏–Ω—å: Ê±âÂ≠ó (pinyin) „Äê–ø–µ—Ä–µ–≤–æ–¥„Äë
- –ï—Å–ª–∏ —Å—Ç–∏–ª—å –º–∞–Ω–≥–∏: 
  „Äê–ü–µ—Ä—Å–æ–Ω–∞–∂„Äë: –†–µ–ø–ª–∏–∫–∞
  *–æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è*
  
# –°–¢–†–£–ö–¢–£–†–ê:
- –í–≤–µ–¥–µ–Ω–∏–µ/–Ω–∞—á–∞–ª–æ
- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —Å —Ä–∞–∑–≤–∏—Ç–∏–µ–º
- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–≤–æ–¥

–ë—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —É—Ä–æ–≤–Ω—é –ª–µ–∫—Å–∏–∫—É!"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"–°–æ–∑–¥–∞–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–µ–º—É: {request.topic}"}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.8,
            max_tokens=4000,
            presence_penalty=0.3,
            frequency_penalty=0.2
        )
        
        text_content = response.choices[0].message.content
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats = analyze_chinese_text(text_content, request.hsk_level)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
        formatted_text = format_generated_text(text_content, request.format)
        
        return {
            "success": True,
            "text": text_content,
            "formatted_text": formatted_text,
            "text_with_pinyin": add_pinyin_to_text(text_content) if request.format == "full" else None,
            "topic": request.topic,
            "hsk_level": request.hsk_level,
            "format": request.format,
            "stats": stats,
            "generated_at": datetime.now().isoformat(),
            "length_chars": len(text_content)
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞: {str(e)}")

def analyze_chinese_text(text: str, target_hsk_level: int) -> Dict:
    """–ê–Ω–∞–ª–∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"""
    # –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HSK —Å–ª–æ–≤–∞—Ä—å)
    characters = len([c for c in text if '\u4e00-\u9fff'])
    words = text.split()
    unique_words = len(set(words))
    
    # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    estimated_level = min(6, max(1, target_hsk_level + random.randint(-1, 1)))
    
    return {
        "characters": characters,
        "words": len(words),
        "unique_words": unique_words,
        "hsk_level": estimated_level,
        "estimated_reading_time": f"{max(1, characters // 300)} –º–∏–Ω—É—Ç",
        "new_words": max(0, unique_words - target_hsk_level * 100)  # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞
    }

def format_generated_text(text: str, format_type: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
    if format_type == "manga":
        # –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –º–∞–Ω–≥–∏
        lines = text.split('\n')
        formatted_lines = []
        for line in lines:
            if ':' in line and len(line) < 50:
                formatted_lines.append(f"üé≠ {line}")
            elif len(line) > 0:
                formatted_lines.append(f"üìñ {line}")
            else:
                formatted_lines.append("")
        return '\n'.join(formatted_lines)
    
    elif format_type == "full":
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∏–Ω—å–∏–Ω—å –∏ –ø–µ—Ä–µ–≤–æ–¥
        return text  # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å pinyin –∏ –ø–µ—Ä–µ–≤–æ–¥
    
    return text

def add_pinyin_to_text(text: str) -> str:
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∏–Ω—å–∏–Ω—è –∫ —Ç–µ–∫—Å—Ç—É (–∑–∞–≥–ª—É—à–∫–∞)"""
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –ø–∏–Ω—å–∏–Ω—è
    # –ù–∞–ø—Ä–∏–º–µ—Ä, pypinyin
    return text

# –ú–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Å—Å–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
class EssayCheckRequest(BaseModel):
    essay_text: str
    topic: str
    hsk_level: int
    min_length: int = 300
    user_id: Optional[str] = None
    time_spent: Optional[int] = None
    mode: str = "essay_check"

class TranslationCheckRequest(BaseModel):
    original_text: str
    user_translation: str
    target_hsk: int
    difficulty: str
    user_id: Optional[str] = None
    time_spent: Optional[int] = None
    mode: str = "translation_check"

class TranslationGenerateRequest(BaseModel):
    topic: str
    description: Optional[str] = ""  # <-- –¥–æ–±–∞–≤—å—Ç–µ
    difficulty: str = "medium"
    length: str = "medium"
    hsk_level: int = 4
    user_id: Optional[str] = None
    include_emojis: bool = True  # <-- –¥–æ–±–∞–≤—å—Ç–µ
    manga_style: bool = False  # <-- –¥–æ–±–∞–≤—å—Ç–µ

@app.post("/essay/check")
async def check_essay(request: EssayCheckRequest):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ AI"""
    try:
        client = get_deepseek_client()
        if not client:
            return generate_fallback_essay_check(request)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        system_prompt = f"""–¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞.
        
# –ó–ê–î–ê–ß–ê:
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç—Å—Å–µ –Ω–∞ —Ç–µ–º—É: "{request.topic}"
–£—Ä–æ–≤–µ–Ω—å —Å—Ç—É–¥–µ–Ω—Ç–∞: HSK {request.hsk_level}
–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {request.min_length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
–î–ª–∏–Ω–∞ —ç—Å—Å–µ —Å—Ç—É–¥–µ–Ω—Ç–∞: {len(request.essay_text)} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤

# –ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:
1. **–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞** (30%) - –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, —á–∞—Å—Ç–∏—Ü, –≤—Ä–µ–º–µ–Ω
2. **–õ–µ–∫—Å–∏–∫–∞** (25%) - –±–æ–≥–∞—Ç—Å—Ç–≤–æ —Å–ª–æ–≤–∞—Ä–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞, —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å —Å–ª–æ–≤  
3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞** (20%) - –ª–æ–≥–∏—á–Ω–æ—Å—Ç—å, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —Å–≤—è–∑–Ω–æ—Å—Ç—å
4. **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ** (15%) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è
5. **–°—Ç–∏–ª—å** (10%) - —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Å–ª–æ–∂–Ω–æ—Å—Ç—å

# –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê JSON:
{{
    "overall_score": 85,
    "categories": [
        {{"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": 80, "feedback": "..."}},
        {{"name": "–õ–µ–∫—Å–∏–∫–∞", "score": 85, "feedback": "..."}},
        {{"name": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "score": 90, "feedback": "..."}},
        {{"name": "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "score": 75, "feedback": "..."}},
        {{"name": "–°—Ç–∏–ª—å", "score": 80, "feedback": "..."}}
    ],
    "errors": [
        {{"position": 15, "error": "‰∫Ü –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–µ –∫ –º–µ—Å—Ç—É", "correction": "..."}},
        {{"position": 42, "error": "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤", "correction": "..."}}
    ],
    "recommendations": "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é...",
    "strengths": "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Ä–∞–±–æ—Ç—ã...",
    "estimated_hsk_level": {request.hsk_level}
}}

# –ë–£–î–¨ –°–¢–†–û–ì–ò–ú:
- –ù–µ –∑–∞–≤—ã—à–∞–π –æ—Ü–µ–Ω–∫–∏
- –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ë—É–¥—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–º, –Ω–æ —á–µ—Å—Ç–Ω—ã–º

# –≠–°–°–ï –°–¢–£–î–ï–ù–¢–ê:
{request.essay_text}"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": "–ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ —ç—Å—Å–µ –∏ –¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑."}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.3,
            max_tokens=2000
        )
        
        # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
        try:
            result = json.loads(response.choices[0].message.content)
        except json.JSONDecodeError:
            # –ï—Å–ª–∏ AI –Ω–µ –≤–µ—Ä–Ω—É–ª JSON, —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            result = {
                "overall_score": 75,
                "categories": [
                    {"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": 70, "feedback": "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü"},
                    {"name": "–õ–µ–∫—Å–∏–∫–∞", "score": 80, "feedback": "–•–æ—Ä–æ—à–∏–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å"},
                    {"name": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "score": 85, "feedback": "–õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"},
                    {"name": "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "score": 75, "feedback": "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ"},
                    {"name": "–°—Ç–∏–ª—å", "score": 70, "feedback": "–ú–æ–∂–Ω–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç–∏–ª—å"}
                ],
                "errors": [],
                "recommendations": "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —ç—Å—Å–µ",
                "strengths": "–≠—Å—Å–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ –∏ –∏–º–µ–µ—Ç –ª–æ–≥–∏—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É"
            }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        result.update({
            "topic": request.topic,
            "target_hsk": request.hsk_level,
            "actual_length": len(request.essay_text),
            "min_required": request.min_length,
            "checked_at": datetime.now().isoformat(),
            "ai_checked": True
        })
        
        return result
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Å—Å–µ: {str(e)}")
        return generate_fallback_essay_check(request)

def generate_fallback_essay_check(request: EssayCheckRequest):
    """Fallback –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ (–µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)"""
    text = request.essay_text
    char_count = len(text)
    
    # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã
    if char_count < request.min_length:
        length_score = 50
    elif char_count < request.min_length * 1.5:
        length_score = 70
    else:
        length_score = 90
    
    base_score = length_score
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
    grammar_score = max(0, min(100, base_score + random.randint(-15, 15)))
    vocab_score = max(0, min(100, base_score + random.randint(-10, 10)))
    structure_score = max(0, min(100, base_score + random.randint(-5, 15)))
    content_score = max(0, min(100, base_score + random.randint(-5, 10)))
    style_score = max(0, min(100, base_score + random.randint(-10, 5)))
    
    overall_score = int((grammar_score + vocab_score + structure_score + content_score + style_score) / 5)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
    errors = []
    if char_count > 100:
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—É –ø—Ä–∏–º–µ—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫
        errors.append({
            "position": min(50, char_count - 10),
            "error": "–í–æ–∑–º–æ–∂–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ ‰∫Ü",
            "correction": "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ‰∫Ü –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π"
        })
    
    return {
        "overall_score": overall_score,
        "categories": [
            {"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": grammar_score, 
             "feedback": "–ï—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —á–∞—Å—Ç–∏—Ü. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ ‰∫Ü, ÁöÑ, Âú∞, Âæó."},
            {"name": "–õ–µ–∫—Å–∏–∫–∞", "score": vocab_score,
             "feedback": f"–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –¥–ª—è —É—Ä–æ–≤–Ω—è HSK {request.hsk_level}."},
            {"name": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "score": structure_score,
             "feedback": "–õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å–≤—è–∑–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏."},
            {"name": "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "score": content_score,
             "feedback": f"–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ '{request.topic}', –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã."},
            {"name": "–°—Ç–∏–ª—å", "score": style_score,
             "feedback": "–°—Ç–∏–ª—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."}
        ],
        "errors": errors,
        "recommendations": f"""
1. –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å ËôΩÁÑ∂...‰ΩÜÊòØ..., Âõ†‰∏∫...ÊâÄ‰ª•...
2. –£–≤–µ–ª–∏—á—å—Ç–µ —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –ø–æ —Ç–µ–º–µ "{request.topic}"
3. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü ‰∫Ü, ÁöÑ, Âú∞, Âæó
4. –î–æ–±–∞–≤—å—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞: È¶ñÂÖà, ÂÖ∂Ê¨°, ÊúÄÂêé, ÊÄªËÄåË®Ä‰πã
5. –ü–∏—à–∏—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
        """,
        "strengths": "–•–æ—Ä–æ—à–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –æ–±—ä–µ–º.",
        "estimated_hsk_level": request.hsk_level,
        "topic": request.topic,
        "target_hsk": request.hsk_level,
        "actual_length": char_count,
        "min_required": request.min_length,
        "checked_at": datetime.now().isoformat(),
        "ai_checked": False,
        "fallback": True
    }

def generate_fallback_essay_check(request: EssayCheckRequest):
    """Fallback –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ"""
    # –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —ç—Å—Å–µ
    text = request.essay_text
    char_count = len(text)
    
    # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞
    base_score = min(100, max(50, char_count / request.min_length * 80))
    
    # –°–ª—É—á–∞–π–Ω—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
    grammar_score = max(0, min(100, base_score + random.randint(-15, 15)))
    vocab_score = max(0, min(100, base_score + random.randint(-10, 10)))
    structure_score = max(0, min(100, base_score + random.randint(-5, 15)))
    content_score = max(0, min(100, base_score + random.randint(-5, 10)))
    style_score = max(0, min(100, base_score + random.randint(-10, 5)))
    
    overall_score = int((grammar_score + vocab_score + structure_score + content_score + style_score) / 5)
    
    return {
        "overall_score": overall_score,
        "categories": [
            {"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": grammar_score, 
             "feedback": "–ï—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —á–∞—Å—Ç–∏—Ü. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ ‰∫Ü, ÁöÑ, Âú∞, Âæó."},
            {"name": "–õ–µ–∫—Å–∏–∫–∞", "score": vocab_score,
             "feedback": "–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –¥–ª—è —É—Ä–æ–≤–Ω—è HSK " + str(request.hsk_level)},
            {"name": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "score": structure_score,
             "feedback": "–õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å–≤—è–∑–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏."},
            {"name": "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "score": content_score,
             "feedback": "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ, –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã."},
            {"name": "–°—Ç–∏–ª—å", "score": style_score,
             "feedback": "–°—Ç–∏–ª—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."}
        ],
        "errors": [
            {"position": random.randint(10, len(text)//2), 
             "error": "–í–æ–∑–º–æ–∂–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ª–æ–≤",
             "correction": "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏"},
            {"position": random.randint(len(text)//2, len(text)-10),
             "error": "–ü–æ–≤—Ç–æ—Ä –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ —Å–ª–æ–≤",
             "correction": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è"}
        ] if char_count > 50 else [],
        "recommendations": """
        1. –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å ËôΩÁÑ∂...‰ΩÜÊòØ..., Âõ†‰∏∫...ÊâÄ‰ª•...
        2. –£–≤–µ–ª–∏—á—å—Ç–µ —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –ø–æ —Ç–µ–º–µ "{}"
        3. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü ‰∫Ü, ÁöÑ, Âú∞, Âæó
        4. –î–æ–±–∞–≤—å—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞: È¶ñÂÖà, ÂÖ∂Ê¨°, ÊúÄÂêé, ÊÄªËÄåË®Ä‰πã
        5. –ü–∏—à–∏—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
        """.format(request.topic),
        "strengths": "–•–æ—Ä–æ—à–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –æ–±—ä–µ–º.",
        "estimated_hsk_level": request.hsk_level,
        "topic": request.topic,
        "target_hsk": request.hsk_level,
        "actual_length": char_count,
        "checked_at": datetime.now().isoformat(),
        "ai_checked": False,
        "fallback": True
    }

@app.post("/translation/generate")
async def generate_translation_text(request: TranslationGenerateRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞"""
    try:
        client = get_deepseek_client()
        if not client:
            return generate_fallback_translation_text(request)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª–∏–Ω—É
        lengths = {
            "short": "3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π",
            "medium": "6-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π", 
            "long": "10-15 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
        }
        
        system_prompt = f"""–¢—ã —Å–æ–∑–¥–∞–µ—à—å —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π.
        
# –ó–ê–î–ê–ß–ê:
–°–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–µ–º—É: "{request.topic}"
–°–ª–æ–∂–Ω–æ—Å—Ç—å: {request.difficulty}
–î–ª–∏–Ω–∞: {lengths.get(request.length, "6-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π")}
–£—Ä–æ–≤–µ–Ω—å —Å—Ç—É–¥–µ–Ω—Ç–∞: HSK {request.hsk_level}

# –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
2. –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω—é —Å—Ç—É–¥–µ–Ω—Ç–∞
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –ª–µ–∫—Å–∏–∫—É –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É
4. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏
5. –í–∫–ª—é—á–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

# –§–û–†–ú–ê–¢–´ –¢–ï–ö–°–¢–ê:
- –ù–æ–≤–æ—Å—Ç—å: —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å, —Ñ–∞–∫—Ç—ã
- –†–∞—Å—Å–∫–∞–∑: –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ, –¥–∏–∞–ª–æ–≥–∏
- –î–∏–∞–ª–æ–≥: —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–∞—è —Ä–µ—á—å, –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
- –û–ø–∏—Å–∞–Ω–∏–µ: –¥–µ—Ç–∞–ª–∏, –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –∏–º–ø–µ—Ä–∞—Ç–∏–≤—ã, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

# –ü–†–ò–ú–ï–† –î–õ–Ø –°–†–ï–î–ù–ï–ô –°–õ–û–ñ–ù–û–°–¢–ò:
"–í—á–µ—Ä–∞ –≤ –®–∞–Ω—Ö–∞–µ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π –∫—É–ª—å—Ç—É—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä. –û–Ω –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –º—É–∑–µ–π –∏ –∫–æ–Ω—Ü–µ—Ä—Ç–Ω—ã–π –∑–∞–ª. –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –º–æ–≥—É—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ—Å–µ—â–∞—Ç—å –≤—ã—Å—Ç–∞–≤–∫–∏ –≤ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"–°–æ–∑–¥–∞–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ —Ç–µ–º—É: {request.topic}"}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.7,
            max_tokens=800
        )
        
        text = response.choices[0].message.content
        
        return {
            "text": text.strip(),
            "topic": request.topic,
            "difficulty": request.difficulty,
            "length": request.length,
            "target_hsk": request.hsk_level,
            "generated_at": datetime.now().isoformat(),
            "ai_generated": True
        }
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞: {str(e)}")
        return generate_fallback_translation_text(request)

def generate_fallback_translation_text(request: TranslationGenerateRequest):
    """Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞"""
    topics_texts = {
        "news": "–ö–∏—Ç–∞–π –∑–∞–ø—É—Å—Ç–∏–ª –Ω–æ–≤—ã–π —Å–ø—É—Ç–Ω–∏–∫ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –ó–µ–º–ª–µ–π. –û–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–≥–æ–¥—ã –∏ —ç–∫–æ–ª–æ–≥–∏–∏. –°–ø—É—Ç–Ω–∏–∫ –≤—ã–≤–µ–¥–µ–Ω –Ω–∞ –æ—Ä–±–∏—Ç—É —Ä–∞–∫–µ—Ç–æ–π-–Ω–æ—Å–∏—Ç–µ–ª–µ–º –ß–∞–Ω—á–∂—ç–Ω.",
        "story": "–î–∞–≤–Ω—ã–º-–¥–∞–≤–Ω–æ –≤ –º–∞–ª–µ–Ω—å–∫–æ–π –¥–µ—Ä–µ–≤–Ω–µ –∂–∏–ª —Å—Ç–∞—Ä—ã–π –º–∞—Å—Ç–µ—Ä –∫–∞–ª–ª–∏–≥—Ä–∞—Ñ–∏–∏. –ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –æ–Ω –≤—Å—Ç–∞–≤–∞–ª –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–µ –∏ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞–ª –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã. –ï–≥–æ —Ä–∞–±–æ—Ç—ã –±—ã–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã –ø–æ –≤—Å–µ–º—É —Ä–µ–≥–∏–æ–Ω—É.",
        "dialogue": "- –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞. –Ø –∏–∑ –†–æ—Å—Å–∏–∏. - –û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ! –Ø –õ–∏ –í—ç–π. –í—ã –≤–ø–µ—Ä–≤—ã–µ –≤ –ö–∏—Ç–∞–µ? - –î–∞, —è –∑–¥–µ—Å—å –∏–∑—É—á–∞—é –∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫. - –û—Ç–ª–∏—á–Ω–æ! –£–¥–∞—á–∏ –≤ —É—á–µ–±–µ!",
        "description": "–í–µ–ª–∏–∫–∞—è –ö–∏—Ç–∞–π—Å–∫–∞—è —Å—Ç–µ–Ω–∞ - —ç—Ç–æ –¥—Ä–µ–≤–Ω–µ–µ –æ–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ—Ä—É–∂–µ–Ω–∏–µ. –û–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≥–æ—Ä—ã –∏ –¥–æ–ª–∏–Ω—ã —Å–µ–≤–µ—Ä–Ω–æ–≥–æ –ö–∏—Ç–∞—è. –î–ª–∏–Ω–∞ —Å—Ç–µ–Ω—ã —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ–ª–µ–µ 20 —Ç—ã—Å—è—á –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤.",
        "instruction": "–ß—Ç–æ–±—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∂–∞—Ä–µ–Ω—ã–π —Ä–∏—Å –ø–æ-–∫–∏—Ç–∞–π—Å–∫–∏, —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –æ—Ç–≤–∞—Ä–∏—Ç—å —Ä–∏—Å –∏ –æ—Ö–ª–∞–¥–∏—Ç—å –µ–≥–æ. –ó–∞—Ç–µ–º –æ–±–∂–∞—Ä–∏—Ç—å —è–π—Ü–∞, –¥–æ–±–∞–≤–∏—Ç—å –æ–≤–æ—â–∏ –∏ –Ω–∞—Ä–µ–∑–∞–Ω–Ω–æ–µ –º—è—Å–æ. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∏—Å –∏ —Å–æ–µ–≤—ã–π —Å–æ—É—Å."
    }
    
    # –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ —Ç–µ–º–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
    text = topics_texts.get(request.topic, 
        "–ö–∏—Ç–∞–π—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –æ—á–µ–Ω—å –±–æ–≥–∞—Ç–∞ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–∞. –û–Ω–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—É—é –º–µ–¥–∏—Ü–∏–Ω—É, –∫—É—Ö–Ω—é, –∏—Å–∫—É—Å—Å—Ç–≤–æ –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é. –ò–∑—É—á–µ–Ω–∏–µ –∫–∏—Ç–∞–π—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –ø–æ–º–æ–≥–∞–µ—Ç –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —è–∑—ã–∫.")
    
    # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å
    if request.difficulty == "easy":
        # –£–ø—Ä–æ—â–∞–µ–º —Ç–µ–∫—Å—Ç
        sentences = text.split('. ')
        text = '. '.join(sentences[:2]) + '.'
    elif request.difficulty == "hard":
        # –£—Å–ª–æ–∂–Ω—è–µ–º —Ç–µ–∫—Å—Ç
        text += " –≠—Ç–∏ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ—Å–Ω–æ —Å–≤—è–∑–∞–Ω—ã —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω—ã –∏ –≤–ª–∏—è–Ω–∏–µ–º –∫–æ–Ω—Ñ—É—Ü–∏–∞–Ω—Å—Ç–≤–∞."
    
    return {
        "text": text,
        "topic": request.topic,
        "difficulty": request.difficulty,
        "length": request.length,
        "target_hsk": request.hsk_level,
        "generated_at": datetime.now().isoformat(),
        "ai_generated": False,
        "fallback": True
    }

@app.post("/translation/check")
async def check_translation(request: TranslationCheckRequest):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ AI"""
    try:
        client = get_deepseek_client()
        if not client:
            return generate_fallback_translation_check(request)
        
        system_prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π.
        
# –ó–ê–î–ê–ß–ê:
–°—Ä–∞–≤–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –∏–¥–µ–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º.
–û—Ä–∏–≥–∏–Ω–∞–ª (—Ä—É—Å—Å–∫–∏–π): "{request.original_text}"
–ü–µ—Ä–µ–≤–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞: "{request.user_translation}"
–£—Ä–æ–≤–µ–Ω—å —Å—Ç—É–¥–µ–Ω—Ç–∞: HSK {request.target_hsk}
–°–ª–æ–∂–Ω–æ—Å—Ç—å: {request.difficulty}

# –ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:
1. **–¢–æ—á–Ω–æ—Å—Ç—å** (40%) - –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–º—ã—Å–ª–∞
2. **–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞** (30%) - –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
3. **–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å** (20%) - –∑–≤—É—á–∏—Ç –ª–∏ –∫–∞–∫ —Ä–æ–¥–Ω–æ–π —è–∑—ã–∫
4. **–°—Ç–∏–ª—å** (10%) - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

# –¢–í–û–Ø –†–ê–ë–û–¢–ê:
1. –°–æ–∑–¥–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—É–¥–µ–Ω—Ç–∞
3. –ù–∞–π—Ç–∏ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏
4. –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
5. –ü–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É

# –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê JSON:
{{
    "overall_score": 85,
    "ideal_translation": "–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π...",
    "categories": [
        {{"name": "–¢–æ—á–Ω–æ—Å—Ç—å", "score": 90, "feedback": "..."}},
        {{"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": 80, "feedback": "..."}},
        {{"name": "–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "score": 85, "feedback": "..."}},
        {{"name": "–°—Ç–∏–ª—å", "score": 80, "feedback": "..."}}
    ],
    "errors": [
        {{"type": "grammar", "description": "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤", "suggestion": "..."}},
        {{"type": "vocabulary", "description": "–ù–µ—Ç–æ—á–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å–ª–æ–≤–∞", "suggestion": "..."}}
    ],
    "correct_translations": [
        {{"original": "—Ä—É—Å—Å–∫–∞—è —Ñ—Ä–∞–∑–∞", "student": "–ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞", "ideal": "–∏–¥–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥"}}
    ],
    "recommendations": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...",
    "estimated_hsk_level": {request.target_hsk}
}}

# –ë–£–î–¨ –ö–û–ù–°–¢–†–£–ö–¢–ò–í–ù–´–ú:
- –•–≤–∞–ª–∏ –∑–∞ —Ö–æ—Ä–æ—à–∏–µ –º–æ–º–µ–Ω—Ç—ã
- –û–±—ä—è—Å–Ω—è–π –æ—à–∏–±–∫–∏ –ø–æ–¥—Ä–æ–±–Ω–æ
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –ü–æ–º–æ–≥–∞–π —É—á–∏—Ç—å—Å—è –Ω–∞ –æ—à–∏–±–∫–∞—Ö"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": "–ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏ –¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑."}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.3,
            max_tokens=2000,
            response_format={"type": "json_object"}
        )
        
        result = json.loads(response.choices[0].message.content)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        result.update({
            "original_text": request.original_text,
            "user_translation": request.user_translation,
            "target_hsk": request.target_hsk,
            "difficulty": request.difficulty,
            "checked_at": datetime.now().isoformat(),
            "ai_checked": True
        })
        
        return result
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞: {str(e)}")
        return generate_fallback_translation_check(request)

def generate_fallback_translation_check(request: TranslationCheckRequest):
    """Fallback –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞"""
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–∏–¥–µ–∞–ª—å–Ω—ã–π" –ø–µ—Ä–µ–≤–æ–¥ (–ø—Ä–æ—Å—Ç–æ–π)
    ideal_translation = generate_simple_translation(request.original_text, request.target_hsk)
    
    # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞
    base_score = 70 + random.randint(-15, 15)
    accuracy_score = max(0, min(100, base_score + random.randint(-10, 10)))
    grammar_score = max(0, min(100, base_score + random.randint(-15, 5)))
    naturalness_score = max(0, min(100, base_score + random.randint(-5, 10)))
    style_score = max(0, min(100, base_score + random.randint(-10, 5)))
    
    overall_score = int((accuracy_score + grammar_score + naturalness_score + style_score) / 4)
    
    return {
        "overall_score": overall_score,
        "ideal_translation": ideal_translation,
        "categories": [
            {"name": "–¢–æ—á–Ω–æ—Å—Ç—å", "score": accuracy_score,
             "feedback": "–û—Å–Ω–æ–≤–Ω–æ–π —Å–º—ã—Å–ª –ø–µ—Ä–µ–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –µ—Å—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ –¥–µ—Ç–∞–ª—è—Ö."},
            {"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": grammar_score,
             "feedback": "–ï—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ª–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —á–∞—Å—Ç–∏—Ü."},
            {"name": "–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "score": naturalness_score,
             "feedback": "–ü–µ—Ä–µ–≤–æ–¥ –ø–æ–Ω—è—Ç–µ–Ω, –Ω–æ –∑–≤—É—á–∏—Ç –Ω–µ–º–Ω–æ–≥–æ –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è –Ω–æ—Å–∏—Ç–µ–ª—è."},
            {"name": "–°—Ç–∏–ª—å", "score": style_score,
             "feedback": "–°—Ç–∏–ª—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å."}
        ],
        "errors": [
            {"type": "grammar", 
             "description": "–í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ª–æ–≤",
             "suggestion": "–í –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ –ø–æ—Ä—è–¥–æ–∫ SVO (–ø–æ–¥–ª–µ–∂–∞—â–µ–µ-—Å–∫–∞–∑—É–µ–º–æ–µ-–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)"},
            {"type": "vocabulary",
             "description": "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞",
             "suggestion": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –∏ —Ç–æ—á–Ω–æ—Å—Ç–∏"}
        ],
        "correct_translations": [
            {"original": request.original_text.split('. ')[0] if '. ' in request.original_text else request.original_text,
             "student": request.user_translation.split('„ÄÇ')[0] if '„ÄÇ' in request.user_translation else request.user_translation,
             "ideal": ideal_translation.split('„ÄÇ')[0] if '„ÄÇ' in ideal_translation else ideal_translation}
        ],
        "recommendations": """
        1. –û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
        2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–æ–≤
        3. –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ –ø–µ—Ä–µ–≤–æ–¥–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–µ–∫—Å—Ç–æ–≤
        4. –ß–∏—Ç–∞–π—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–∏—Ç–∞–π—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è
        5. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü ‰∫Ü, ÁöÑ, Âú∞, Âæó
        """,
        "estimated_hsk_level": request.target_hsk,
        "original_text": request.original_text,
        "user_translation": request.user_translation,
        "target_hsk": request.target_hsk,
        "difficulty": request.difficulty,
        "checked_at": datetime.now().isoformat(),
        "ai_checked": False,
        "fallback": True
    }

def generate_simple_translation(text: str, hsk_level: int) -> str:
    """–ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)"""
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã —Ä–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
    # –°–µ–π—á–∞—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    translations = {
        3: "ËøôÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁøªËØëÁ§∫‰æã„ÄÇ‰∏≠ÊñáÂæàÈáçË¶Å„ÄÇ",
        4: "Êò®Â§©Âú®ÂÖ¨Âõ≠ÈáåÊúâÂæàÂ§ö‰∫∫„ÄÇÂ§©Ê∞îÂæàÂ•ΩÔºåÈò≥ÂÖâÊòéÂ™ö„ÄÇ",
        5: "ÈöèÁùÄ‰∏≠ÂõΩÁªèÊµéÁöÑÂèëÂ±ïÔºåË∂äÊù•Ë∂äÂ§öÁöÑÂ§ñÂõΩ‰∫∫Êù•Âà∞‰∏≠ÂõΩÂ∑•‰ΩúÂíåÂ≠¶‰π†„ÄÇ",
        6: "‰∏≠ÂõΩ‰º†ÁªüÊñáÂåñÂçöÂ§ßÁ≤æÊ∑±ÔºåÊ∫êËøúÊµÅÈïø„ÄÇÂÆÉ‰∏ç‰ªÖÂåÖÊã¨‰∏∞ÂØåÁöÑÂì≤Â≠¶ÊÄùÊÉ≥ÔºåËøòÊ∂µÁõñ‰∫ÜÁã¨ÁâπÁöÑËâ∫ÊúØÂΩ¢ÂºèÂíåÁîüÊ¥ªÊô∫ÊÖß„ÄÇ"
    }
    
    return translations.get(hsk_level, "ËøôÊòØ‰∏Ä‰∏™ÁøªËØëÊñáÊú¨„ÄÇ")

@app.get("/text/history/{user_id}")
async def get_text_generation_history(user_id: str, limit: int = 20):
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Ñ–∞–π–ª–∞
        history_file = f"data/text_history_{user_id}.json"
        if os.path.exists(history_file):
            with open(history_file, "r", encoding="utf-8") as f:
                history = json.load(f)
            return {
                "history": history[:limit],
                "count": len(history),
                "total_characters": sum(item.get("length_chars", 0) for item in history)
            }
        return {"history": [], "count": 0}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: {str(e)}")

@app.get("/words/level/{level}")
async def get_level_words(level: int, limit: int = 10000, offset: int = 0):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ª–æ–≤–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è HSK"""
    level_words = get_words_by_level(level, 20000)
    
    if not level_words:
        raise HTTPException(status_code=404, detail=f"–°–ª–æ–≤–∞ HSK {level} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    paginated_words = level_words[offset:offset + limit]
    
    return {
        "level": level,
        "count": len(paginated_words),
        "total": len(level_words),
        "offset": offset,
        "limit": limit,
        "words": paginated_words
    }

@app.get("/levels/summary")
async def get_levels_summary():
    """–°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —É—Ä–æ–≤–Ω—è–º HSK"""
    summary = {}
    for level in range(1, 7):
        level_words = get_words_by_level(level, 1000)
        if level_words:
            summary[f"hsk{level}"] = {
                "word_count": len(level_words),
                "sample_words": level_words[:3],
                "common_characters": list(set([char for word in level_words[:10] for char in word["character"]]))[:5]
            }
    
    return summary

@app.get("/user/{user_id}/progress")
async def get_user_progress(user_id: str):
    """–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in users_db:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    user = users_db[user_id]
    progress = word_progress_db.get(user_id, {})
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º
    level_stats = {}
    for level in range(1, 7):
        level_words = get_words_by_level(level, 1000)
        total_level_words = len(level_words)
        
        # –°—á–∏—Ç–∞–µ–º –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è
        learned = 0
        for word_id, word_progress in progress.items():
            if word_progress.get("remembered", False):
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–ª–æ–≤–æ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è
                for word in level_words:
                    if f"{word['character']}_{level}" == word_id:
                        learned += 1
                        break
        
        if total_level_words > 0:
            level_stats[f"HSK {level}"] = {
                "learned": learned,
                "total": total_level_words,
                "percentage": int((learned / total_level_words) * 100)
            }
    
    total_learned = len([p for p in progress.values() if p.get("remembered", False)])
    
    return {
        "user": user["name"],
        "user_id": user_id,
        "stats": {
            "total_learned": total_learned,
            "total_words": len(words_db),
            "overall_percentage": int((total_learned / len(words_db)) * 100) if words_db else 0,
            "by_level": level_stats
        },
        "study_plan": {
            "daily_words": user.get("daily_words", 10),
            "days_until_exam": user.get("days_until_exam", 30),
            "words_per_day_to_goal": max(1, (user.get("target_words", 1000) - total_learned) // max(1, user.get("days_until_exam", 30)))
        }
    }


# –î–æ–±–∞–≤—å—Ç–µ –≤ –º–æ–¥–µ–ª–∏ –±—ç–∫–µ–Ω–¥–∞:
class EssayAnalysisRequest(BaseModel):
    topic: str
    details: Optional[str] = ""
    difficulty: str = "intermediate"
    target_length: int = 400
    user_id: Optional[str] = None

class EssayAnalysisResponse(BaseModel):
    prompt: str
    topic: str
    difficulty: str
    target_length: int
    requirements: str
    evaluation_criteria: List[str]
    time_limit_minutes: int
    generated_at: str

class EssaySubmitRequest(BaseModel):
    essay_text: str
    topic: str
    difficulty: str
    target_length: int
    user_id: Optional[str] = None
    time_spent: Optional[int] = None

# –î–æ–±–∞–≤—å—Ç–µ –≤ —Ä–æ—É—Ç—ã –±—ç–∫–µ–Ω–¥–∞:
@app.post("/essay/analysis/generate")
async def generate_essay_analysis(request: EssayAnalysisRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —ç—Å—Å–µ"""
    try:
        client = get_deepseek_client()
        if not client:
            return generate_fallback_essay_analysis(request)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        time_limits = {
            "beginner": 45,
            "intermediate": 60,
            "advanced": 75,
            "exam": 90
        }
        
        system_prompt = f"""–¢—ã —Å–æ–∑–¥–∞–µ—à—å –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —ç—Å—Å–µ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ.
        
# –ó–ê–î–ê–ß–ê:
–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —ç—Å—Å–µ –Ω–∞ —Ç–µ–º—É: "{request.topic}"
–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: {request.difficulty}
–¶–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞: {request.target_length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏: {request.details}

# –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ó–ê–î–ê–ù–ò–Æ:
1. –ß–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ–º–∞ –∏ –∑–∞–¥–∞—á–∞
2. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é
3. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ 4 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
   - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (40%)
   - –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ (30%) 
   - –õ–µ–∫—Å–∏–∫–∞ (20%)
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (10%)
4. –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: {time_limits.get(request.difficulty, 60)} –º–∏–Ω—É—Ç

# –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê JSON:
{{
    "prompt": "–ü–æ–ª–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏...",
    "requirements": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —ç—Å—Å–µ...",
    "evaluation_criteria": [
        "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã (40%)",
        "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, —á–∞—Å—Ç–∏—Ü—ã, –≤—Ä–µ–º–µ–Ω–∞ (30%)",
        "–õ–µ–∫—Å–∏–∫–∞: —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–ª–æ–≤–∞—Ä—è, —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å —Å–ª–æ–≤ (20%)",
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ª–æ–≥–∏—á–Ω–æ—Å—Ç—å, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —Å–≤—è–∑–Ω–æ—Å—Ç—å (10%)"
    ],
    "time_limit_minutes": {time_limits.get(request.difficulty, 60)},
    "suggested_structure": ["–í–≤–µ–¥–µ–Ω–∏–µ", "2-3 –∞—Ä–≥—É–º–µ–Ω—Ç–∞", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"]
}}"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"–°–æ–∑–¥–∞–π –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —ç—Å—Å–µ –Ω–∞ —Ç–µ–º—É: {request.topic}"}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.7,
            max_tokens=1000,
            response_format={"type": "json_object"}
        )
        
        result = json.loads(response.choices[0].message.content)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        result.update({
            "topic": request.topic,
            "difficulty": request.difficulty,
            "target_length": request.target_length,
            "generated_at": datetime.now().isoformat(),
            "ai_generated": True
        })
        
        return result
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è: {str(e)}")
        return generate_fallback_essay_analysis(request)

def generate_fallback_essay_analysis(request: EssayAnalysisRequest):
    """Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —ç—Å—Å–µ"""
    difficulty_texts = {
        "beginner": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –±–∞–∑–æ–≤—É—é –ª–µ–∫—Å–∏–∫—É HSK 1-3.",
        "intermediate": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –ª–µ–∫—Å–∏–∫—É HSK 4-5.",
        "advanced": "–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤–ª–∞–¥–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã–º–∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.",
        "exam": "–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–ª–∞–¥–µ–Ω–∏—è —è–∑—ã–∫–æ–º –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ."
    }
    
    time_limits = {
        "beginner": 45,
        "intermediate": 60,
        "advanced": 75,
        "exam": 90
    }
    
    return {
        "prompt": f"""
<h4>–¢–µ–º–∞: {request.topic}</h4>
<p><strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> –ù–∞–ø–∏—à–∏—Ç–µ —ç—Å—Å–µ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É. –í–∞—à–µ —ç—Å—Å–µ –¥–æ–ª–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å:</p>
<ul>
    <li>–í–≤–µ–¥–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º —Ç–µ–º—ã –∏ –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏</li>
    <li>2-3 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏</li>
    <li>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –≤—ã–≤–æ–¥–∞–º–∏ –∏ –æ–±–æ–±—â–µ–Ω–∏–µ–º</li>
</ul>
<p><strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong></p>
<ul>
    <li>–û–±—ä–µ–º: {request.target_length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</li>
    <li>{difficulty_texts.get(request.difficulty, '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è')}</li>
    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Å–≤—è–∑—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã</li>
    <li>–ò–∑–±–µ–≥–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫</li>
</ul>
<p><strong>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> {time_limits.get(request.difficulty, 60)} –º–∏–Ω—É—Ç</p>
        """,
        "requirements": f"–û–±—ä–µ–º: {request.target_length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤. {difficulty_texts.get(request.difficulty, '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è')}",
        "evaluation_criteria": [
            "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã (40%)",
            "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, —á–∞—Å—Ç–∏—Ü—ã, –≤—Ä–µ–º–µ–Ω–∞ (30%)",
            "–õ–µ–∫—Å–∏–∫–∞: —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–ª–æ–≤–∞—Ä—è, —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å —Å–ª–æ–≤ (20%)",
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ª–æ–≥–∏—á–Ω–æ—Å—Ç—å, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —Å–≤—è–∑–Ω–æ—Å—Ç—å (10%)"
        ],
        "time_limit_minutes": time_limits.get(request.difficulty, 60),
        "suggested_structure": ["–í–≤–µ–¥–µ–Ω–∏–µ", "2-3 –∞—Ä–≥—É–º–µ–Ω—Ç–∞", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"],
        "topic": request.topic,
        "difficulty": request.difficulty,
        "target_length": request.target_length,
        "generated_at": datetime.now().isoformat(),
        "ai_generated": False,
        "fallback": True
    }

@app.post("/essay/analysis/check")
async def check_essay_analysis(request: EssaySubmitRequest):
    """–°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç—Å—Å–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
    try:
        client = get_deepseek_client()
        if not client:
            return generate_fallback_essay_check_analysis(request)
        
        system_prompt = f"""–¢—ã ‚Äî –°–¢–†–û–ì–ò–ô –∏ –¢–†–ï–ë–û–í–ê–¢–ï–õ–¨–ù–´–ô –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞.
        
# –ó–ê–î–ê–ß–ê:
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç—Å—Å–µ –Ω–∞ —Ç–µ–º—É: "{request.topic}"
–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: {request.difficulty}
–¶–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞: {request.target_length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
–î–ª–∏–Ω–∞ —ç—Å—Å–µ —Å—Ç—É–¥–µ–Ω—Ç–∞: {len(request.essay_text)} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤

# –ë–£–î–¨ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –°–¢–†–û–ì–ò–ú:
- –ù–µ –∑–∞–≤—ã—à–∞–π –æ—Ü–µ–Ω–∫–∏ –Ω–∏ –Ω–∞ –±–∞–ª–ª!
- –ó–∞ –∫–∞–∂–¥—É—é –æ—à–∏–±–∫—É —Å–Ω–∏–∂–∞–π –±–∞–ª–ª—ã
- –¢—Ä–µ–±—É–π —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞
- –ù–µ –¥–µ–ª–∞–π —Å–∫–∏–¥–æ–∫

# –ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:
1. **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ** (40%) - —Ç–æ—á–Ω–æ—Å—Ç—å, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã, –≥–ª—É–±–∏–Ω–∞
2. **–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞** (30%) - –∏–¥–µ–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –Ω–∏–∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫
3. **–õ–µ–∫—Å–∏–∫–∞** (20%) - –±–æ–≥–∞—Ç—ã–π —Å–ª–æ–≤–∞—Ä—å, —Ç–æ—á–Ω–æ—Å—Ç—å, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
4. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞** (10%) - –∏–¥–µ–∞–ª—å–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –ª–æ–≥–∏–∫–∞, —Å–≤—è–∑–Ω–æ—Å—Ç—å

# –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê JSON:
{{
    "overall_score": 65,  // –ë–£–î–¨ –°–¢–†–û–ì–ò–ú!
    "categories": [
        {{"name": "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "score": 70, "feedback": "–°–¢–†–û–ì–ò–ô –æ—Ç–∑—ã–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –í–°–ï–• –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤"}},
        {{"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": 60, "feedback": "–°–¢–†–û–ì–ò–ô –æ—Ç–∑—ã–≤ —Å –ü–ï–†–ï–ß–ù–ï–ú –í–°–ï–• –æ—à–∏–±–æ–∫"}},
        {{"name": "–õ–µ–∫—Å–∏–∫–∞", "score": 75, "feedback": "–°–¢–†–û–ì–ò–ô –æ—Ç–∑—ã–≤ –æ —Å–ª–æ–≤–∞—Ä–Ω–æ–º –∑–∞–ø–∞—Å–µ"}},
        {{"name": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "score": 80, "feedback": "–°–¢–†–û–ì–ò–ô –æ—Ç–∑—ã–≤ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ"}}
    ],
    "errors": [
        {{"type": "grammar", "position": 15, "description": "–ö–û–ù–ö–†–ï–¢–ù–ê–Ø –æ—à–∏–±–∫–∞", "correction": "–¢–û–ß–ù–û–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "severity": "high"}},
        {{"type": "vocabulary", "position": 42, "description": "–ù–ï–¢–û–ß–ù–û–ï —Å–ª–æ–≤–æ", "correction": "–ü–†–ê–í–ò–õ–¨–ù–´–ô –≤–∞—Ä–∏–∞–Ω—Ç", "severity": "medium"}}
    ],
    "strengths": "–¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π!",
    "weaknesses": "–ü–û–î–†–û–ë–ù–´–ô —Å–ø–∏—Å–æ–∫ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç",
    "recommendations": "–ö–û–ù–ö–†–ï–¢–ù–´–ï –∏ –ñ–ï–°–¢–ö–ò–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é",
    "estimated_level": "–†–µ–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—É–¥–µ–Ω—Ç–∞ (–ù–ï –∑–∞–≤—ã—à–∞–π!)",
    "would_pass_exam": false  // –ß–µ—Å—Ç–Ω–æ –æ—Ü–µ–Ω–∏, —Å–¥–∞–ª –±—ã —ç–∫–∑–∞–º–µ–Ω?
}}

# –≠–°–°–ï –°–¢–£–î–ï–ù–¢–ê:
{request.essay_text}"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": "–ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ —ç—Å—Å–µ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –°–¢–†–û–ì–û –∏ –¥–∞–π —á–µ—Å—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É."}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.2,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏
            max_tokens=2500
        )
        
        try:
            result = json.loads(response.choices[0].message.content)
        except json.JSONDecodeError:
            result = generate_fallback_essay_check_analysis(request)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        result.update({
            "topic": request.topic,
            "difficulty": request.difficulty,
            "target_length": request.target_length,
            "actual_length": len(request.essay_text),
            "time_spent": request.time_spent,
            "checked_at": datetime.now().isoformat(),
            "strict_check": True
        })
        
        return result
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏: {str(e)}")
        return generate_fallback_essay_check_analysis(request)
    
@app.post("/ai/search-universities")
async def search_universities(request: dict):
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: AI –∏—â–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
    """
    try:
        query = request.get("query", "")
        filters = request.get("filters", {})
        
        if not query:
            raise HTTPException(status_code=400, detail="–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å")
        
        # 1. –§–æ—Ä–º–∏—Ä—É–µ–º –£–ú–ù–´–ô –ø—Ä–æ–º–ø—Ç –¥–ª—è AI
        system_prompt = f"""
        –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏—Ç–∞–π—Å–∫–æ–º—É –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç: "{query}"
        
        –¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ù–ê–ô–¢–ò –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –ò–ù–§–û–†–ú–ê–¶–ò–Æ –í –ò–ù–¢–ï–†–ù–ï–¢–ï
        
        –ò–ù–°–¢–†–£–ö–¶–ò–ò:
        1. –ò–°–ü–û–õ–¨–ó–£–ô –ü–û–ò–°–ö –í –ò–ù–¢–ï–†–ù–ï–¢–ï —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
        2. –ò—â–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö
        3. –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã –≤—É–∑–æ–≤ (.edu.cn), csc.edu.cn, studyinchina.edu.cn
        4. –£—á–∏—Ç—ã–≤–∞–π —Ñ–∏–ª—å—Ç—Ä—ã: HSK {filters.get('hsk_level', '–ª—é–±–æ–π')}, –±—é–¥–∂–µ—Ç {filters.get('max_budget', '–ª—é–±–æ–π')}
        5. –°—Ä–∞–≤–Ω–∏ –º–∏–Ω–∏–º—É–º 3-5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        6. –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: —Ü–µ–Ω—ã, —Å—Ä–æ–∫–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã
        
        –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
        - –ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ (–≥–æ—Ä–æ–¥)
        - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: HSK, —ç–∫–∑–∞–º–µ–Ω—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã
        - –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–≤ —é–∞–Ω—è—Ö)
        - –°—Ç–∏–ø–µ–Ω–¥–∏–∏: –∫–∞–∫–∏–µ –µ—Å—Ç—å, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å
        - –°—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        - –°—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        - –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        - –°–æ–≤–µ—Ç—ã –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é
        
        –í–ê–ñ–ù–û: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–ö–¢–£–ê–õ–¨–ù–´–ú–ò (2024-2025 –≥–æ–¥).
        """
        
        # 2. –í—ã–∑—ã–≤–∞–µ–º DeepSeek —Å –í–ö–õ–Æ–ß–ï–ù–ù–´–ú –ø–æ–∏—Å–∫–æ–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
        client = get_deepseek_client()
        if not client:
            return {"error": "API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"}
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í–∫–ª—é—á–∏—Ç–µ –≤–µ–±-–ø–æ–∏—Å–∫!
        # –£—Ç–æ—á–Ω–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ DeepSeek
        response = client.chat.completions.create(
            model="deepseek-chat",  # –ò–ª–∏ –¥—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å —Å –ø–æ–∏—Å–∫–æ–º
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"–ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∑–∞–ø—Ä–æ—Å—É: {query}"}
            ],
            # –ü–ê–†–ê–ú–ï–¢–† –î–õ–Ø –í–ï–ë-–ü–û–ò–°–ö–ê (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è):
            # web_search=True, 
            # use_web=True,
            # search_online=True,
            max_tokens=4000  # –ú–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        )
        
        ai_response = response.choices[0].message.content
        
        # 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return {
            "success": True,
            "query": query,
            "analysis": ai_response,  # –¢–µ–∫—Å—Ç –æ—Ç AI
            "count": len(ai_response.split('\n')) // 10,  # –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            "search_performed": True,
            "timestamp": datetime.now().isoformat()
        }
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ AI –ø–æ–∏—Å–∫–µ: {e}")
        return {
            "success": False,
            "error": str(e),
            "fallback": "–ü–æ–∫–∞–∂—É –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...",
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å fallback –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–π –ë–î
        }

def generate_fallback_essay_check_analysis(request: EssaySubmitRequest):
    """Fallback —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"""
    text = request.essay_text
    char_count = len(text)
    
    # –°–¢–†–û–ì–ê–Ø –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã
    length_ratio = char_count / request.target_length
    if length_ratio < 0.5:
        length_penalty = 30
    elif length_ratio < 0.8:
        length_penalty = 15
    elif length_ratio < 1.0:
        length_penalty = 5
    else:
        length_penalty = 0
    
    base_score = 70 - length_penalty
    
    # –°–¢–†–û–ì–ò–ï –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    content_score = max(0, min(100, base_score + random.randint(-20, 10)))
    grammar_score = max(0, min(100, base_score + random.randint(-25, 5)))
    vocab_score = max(0, min(100, base_score + random.randint(-15, 10)))
    structure_score = max(0, min(100, base_score + random.randint(-10, 15)))
    
    overall_score = int((content_score + grammar_score + vocab_score + structure_score) / 4)
    
    # –ñ–ï–°–¢–ö–ò–ï –æ—à–∏–±–∫–∏
    errors = []
    if char_count > 50:
        errors.append({
            "type": "grammar",
            "position": min(30, char_count - 20),
            "description": "–°–ï–†–¨–ï–ó–ù–ê–Ø –æ—à–∏–±–∫–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ ‰∫Ü",
            "correction": "–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‰∫Ü –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ",
            "severity": "high"
        })
        
    if char_count > 100:
        errors.append({
            "type": "vocabulary", 
            "position": min(70, char_count - 30),
            "description": "–≠–¢–û —Å–ª–æ–≤–æ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ï –≤ –¥–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ",
            "correction": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ: ...",
            "severity": "medium"
        })
    
    would_pass = overall_score >= 70  # –ñ–ï–°–¢–ö–ò–ô –ø—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª
    
    return {
        "overall_score": overall_score,
        "categories": [
            {"name": "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "score": content_score,
             "feedback": "–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑. –ù—É–∂–Ω—ã –ö–û–ù–ö–†–ï–¢–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã –∏ –¥–µ—Ç–∞–ª–∏."},
            {"name": "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", "score": grammar_score,
             "feedback": "–ú–ù–û–ì–û –æ—à–∏–±–æ–∫ –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ. –ù–µ–ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è."},
            {"name": "–õ–µ–∫—Å–∏–∫–∞", "score": vocab_score,
             "feedback": "–°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –û–ß–ï–ù–¨ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –£—á–∏—Ç–µ –±–æ–ª—å—à–µ —Å–ª–æ–≤."},
            {"name": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "score": structure_score,
             "feedback": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö–∞–æ—Ç–∏—á–Ω–∞. –°–ª–µ–¥—É–π—Ç–µ –ø–ª–∞–Ω—É: –≤–≤–µ–¥–µ–Ω–∏–µ-–∞—Ä–≥—É–º–µ–Ω—Ç—ã-–∑–∞–∫–ª—é—á–µ–Ω–∏–µ."}
        ],
        "errors": errors,
        "strengths": "–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–ª—é—Å: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ (–Ω–æ —Å–ª–∞–±–æ–µ).",
        "weaknesses": "–í–°–Å –æ—Å—Ç–∞–ª—å–Ω–æ–µ: –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –ª–µ–∫—Å–∏–∫–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è.",
        "recommendations": """
1. –í–´–£–ß–ò–¢–ï –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –∑–∞–Ω–æ–≤–æ. –û—à–∏–±–∫–∏ –ù–ï–î–û–ü–£–°–¢–ò–ú–´.
2. –£–í–ï–õ–ò–ß–¨–¢–ï —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –≤ 2 —Ä–∞–∑–∞. –°–ï–ô–ß–ê–° –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
3. –ü–ò–®–ò–¢–ï –ø–æ –ø–ª–∞–Ω—É –í–°–ï–ì–î–ê. –•–∞–æ—Å - —ç—Ç–æ –ø—Ä–æ–≤–∞–ª.
4. –ü–†–ê–ö–¢–ò–ö–£–ô–¢–ï–°–¨ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é - –°–õ–ò–®–ö–û–ú –ú–ê–õ–û.
5. –ù–ê–ù–ò–ú–ò–¢–ï —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞, –µ—Å–ª–∏ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å–∞–º–∏.
        """,
        "estimated_level": f"–†–µ–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: HSK {max(1, min(6, overall_score // 15))}",
        "would_pass_exam": would_pass,
        "topic": request.topic,
        "difficulty": request.difficulty,
        "target_length": request.target_length,
        "actual_length": char_count,
        "checked_at": datetime.now().isoformat(),
        "strict_check": True,
        "fallback": True
    }

class AudioLessonRequest(BaseModel):
    topic: str
    description: Optional[str] = None
    difficulty: str = "medium"  # easy, medium, hard
    target_length: str = "medium"  # short, medium, long
    hsk_level: int = 3
    include_pinyin: bool = False
    include_translation: bool = False
    user_id: Optional[str] = None

class AudioLessonResponse(BaseModel):
    id: str
    title: str
    chinese_text: str
    pinyin_text: Optional[str] = None
    translation: Optional[str] = None
    vocabulary: List[Dict[str, str]]
    difficulty: str
    estimated_duration: int  # –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    generated_at: str

# –ó–ê–ú–ï–ù–ò–¢–ï —Ñ—É–Ω–∫—Ü–∏—é generate_audio_lesson –≤ –±—ç–∫–µ–Ω–¥–µ –Ω–∞ —ç—Ç—É:
@app.post("/audio/generate-lesson")
async def generate_audio_lesson(request: AudioLessonRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞ (–ø–æ–¥–∫–∞—Å—Ç–∞) –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º"""
    try:
        client = get_deepseek_client()
        if not client:
            return generate_fallback_audio_lesson(request)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        length_targets = {
            "short": 300,    # 1-2 –º–∏–Ω—É—Ç—ã
            "medium": 600,   # 3-5 –º–∏–Ω—É—Ç
            "long": 1000     # 5-10 –º–∏–Ω—É—Ç
        }
        
        target_chars = length_targets.get(request.target_length, 600)
        
        system_prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–∏—Ç–∞–π—Å–∫–∏—Ö –ø–æ–¥–∫–∞—Å—Ç–æ–≤ –¥–ª—è –∏–∑—É—á–∞—é—â–∏—Ö —è–∑—ã–∫.

# –ó–ê–î–ê–ß–ê:
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–æ–¥–∫–∞—Å—Ç –Ω–∞ —Ç–µ–º—É: "{request.topic}"
–î–µ—Ç–∞–ª–∏ —Ç–µ–º—ã: {request.description or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
–£—Ä–æ–≤–µ–Ω—å HSK: {request.hsk_level}
–°–ª–æ–∂–Ω–æ—Å—Ç—å: {request.difficulty}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {request.target_length}
–ü—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä–µ–º: {target_chars} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤

# –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ü–û–î–ö–ê–°–¢–£:
1. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–û–¶–ï–ù–ù–´–ú –∞—É–¥–∏–æ-—É—Ä–æ–∫–æ–º —Å:
   - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –≤–≤–µ–¥–µ–Ω–∏–µ–º –≤ —Ç–µ–º—É
   - –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç—å—é —Å —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Ç–µ–º—ã
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –¥–µ—Ç–∞–ª—è–º–∏
   - –ü–æ–ª–µ–∑–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –ª–µ–∫—Å–∏–∫–æ–π
   - –í–æ–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π
   - –ò—Ç–æ–≥–∞–º–∏ –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º

2. –î–õ–ò–ù–ê: –ù–µ –º–µ–Ω–µ–µ {target_chars} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
3. –°–¢–†–£–ö–¢–£–†–ê:
   - –í–≤–µ–¥–µ–Ω–∏–µ (20%)
   - –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (60%)
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (20%)
4. –°–¢–ò–õ–¨: –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π
5. –í–ö–õ–Æ–ß–ò–¢–¨: 
   - –î–∏–∞–ª–æ–≥–∏ –∏–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–æ–≤
   - –ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
   - –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —è–∑—ã–∫–∞

# –ò–ó–ë–ï–ì–ê–¢–¨:
- –®–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑
- –°–ª–∏—à–∫–æ–º –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
- –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

# –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê JSON:
{{
    "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥–∫–∞—Å—Ç–∞",
    "chinese_text": "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–¥–∫–∞—Å—Ç–∞ –∑–¥–µ—Å—å...",
    "pinyin_text": "–¢–µ–∫—Å—Ç —Å –ø–∏–Ω—å–∏–Ω–µ–º (–µ—Å–ª–∏ include_pinyin=true)",
    "translation": "–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π (–µ—Å–ª–∏ include_translation=true)",
    "vocabulary": [
        {{
            "chinese": "ËØçËØ≠",
            "pinyin": "c√≠y«î", 
            "translation": "–ø–µ—Ä–µ–≤–æ–¥",
            "example": "–ü—Ä–∏–º–µ—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
            "category": "—á–∞—Å—Ç—å —Ä–µ—á–∏"
        }}
    ],
    "comprehension_questions": [
        {{
            "question": "–í–æ–ø—Ä–æ—Å –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ",
            "options": ["A", "B", "C", "D"],
            "correct_answer": 0,
            "explanation": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞"
        }}
    ],
    "estimated_duration": 180,
    "word_count": 500,
    "character_count": 800,
    "difficulty_analysis": {{
        "grammar_complexity": "—Å—Ä–µ–¥–Ω—è—è",
        "vocabulary_level": "HSK {request.hsk_level}",
        "speed_recommendation": "1.0x"
    }}
}}"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"""–°–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–æ–¥–∫–∞—Å—Ç –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º.

–¢–µ–º–∞: {request.topic}
–û–ø–∏—Å–∞–Ω–∏–µ: {request.description or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
–£—Ä–æ–≤–µ–Ω—å: HSK {request.hsk_level}
–°–ª–æ–∂–Ω–æ—Å—Ç—å: {request.difficulty}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {request.target_length}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–ú –∏ –†–ê–ó–ì–û–í–û–†–ù–´–ú, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–æ–¥–∫–∞—Å—Ç."""}
        ]
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.9,  # –ë–æ–ª–µ–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥
            max_tokens=4000,   # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
            response_format={"type": "json_object"}
        )
        
        result = json.loads(response.choices[0].message.content)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —É—Ä–æ–∫–∞
        lesson_id = f"audio_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{hash(request.topic[:20])}"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        result.update({
            "id": lesson_id,
            "difficulty": request.difficulty,
            "hsk_level": request.hsk_level,
            "generated_at": datetime.now().isoformat(),
            "topic": request.topic,
            "description": request.description,
            "ai_generated": True,
            "target_length": request.target_length,
            "request_details": {
                "topic": request.topic,
                "description": request.description,
                "hsk_level": request.hsk_level,
                "difficulty": request.difficulty,
                "include_pinyin": request.include_pinyin,
                "include_translation": request.include_translation
            }
        })
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ø—Ä–æ—Å–∏–ª –ø–∏–Ω—å–∏–Ω—å, —É–¥–∞–ª—è–µ–º –µ–≥–æ
        if not request.include_pinyin:
            result["pinyin_text"] = None
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–≤–æ–¥, —É–¥–∞–ª—è–µ–º –µ–≥–æ
        if not request.include_translation:
            result["translation"] = None
        
        return result
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞: {str(e)}")
        # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback —Å –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
        return generate_improved_fallback_audio_lesson(request)

def generate_improved_fallback_audio_lesson(request: AudioLessonRequest):
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π fallback –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–∫–∞—Å—Ç–∞"""
    
    # –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
    topic = request.topic
    difficulty = request.difficulty
    
    # –ë–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    base_text = f"""Â§ßÂÆ∂Â•ΩÔºÅÊ¨¢ËøéÊî∂Âê¨‰ªäÂ§©ÁöÑÊ±âËØ≠Â≠¶‰π†Êí≠ÂÆ¢„ÄÇ

‰ªäÂ§©Êàë‰ª¨ÁöÑËØùÈ¢òÊòØÔºö{topic}„ÄÇ

Ëøô‰∏™ËØùÈ¢òÂæàÊúâÊÑèÊÄùÔºå‰πüÂæàÈáçË¶Å„ÄÇËÆ©ÊàëÊù•ËØ¶ÁªÜ‰ªãÁªç‰∏Ä‰∏ã„ÄÇ

È¶ñÂÖàÔºå{topic}Âú®‰∏≠ÂõΩÊñáÂåñ‰∏≠Âç†ÊúâÁâπÊÆäÂú∞‰Ωç„ÄÇÊó†ËÆ∫ÊòØ‰º†ÁªüËøòÊòØÁé∞‰ª£ËßíÂ∫¶ÔºåËøô‰∏™ËØùÈ¢òÈÉΩÂÄºÂæóÊ∑±ÂÖ•Êé¢ËÆ®„ÄÇ

‰∏æ‰∏™‰æãÂ≠êÊù•ËØ¥ÔºåÂæàÂ§öÂ§ñÂõΩÊúãÂèãÊù•Âà∞‰∏≠ÂõΩÔºåÈÉΩ‰ºöÂØπ{topic}‰∫ßÁîüÊµìÂéöÁöÑÂÖ¥Ë∂£„ÄÇ‰ªñ‰ª¨ÁªèÂ∏∏ÈóÆÔºö"‰∏≠ÂõΩÁöÑ{topic}Êúâ‰ªÄ‰πàÁâπÁÇπÔºü" "ÊàëÂ∫îËØ•Â¶Ç‰ΩïÊõ¥Â•ΩÂú∞‰∫ÜËß£{topic}Ôºü"

‰∫ãÂÆû‰∏äÔºå{topic}‰∏ç‰ªÖÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊ¶ÇÂøµÔºåÂÆÉÂèçÊò†‰∫Ü‰∏≠ÂõΩÁ§æ‰ºöÁöÑÂæàÂ§öÊñπÈù¢„ÄÇ‰ªéÂéÜÂè≤ËßíÂ∫¶Êù•ÁúãÔºå{topic}ÊúâÁùÄÊÇ†‰πÖÁöÑÂéÜÂè≤‰º†Êâø„ÄÇ‰ªéÁé∞‰ª£ËßÜËßíÊù•ÁúãÔºå{topic}‰πüÂú®‰∏çÊñ≠ÂèëÂ±ïÂíåÂèòÂåñ„ÄÇ

Êàë‰∏™‰∫∫ËÆ§‰∏∫ÔºåÂ≠¶‰π†{topic}ÂØπ‰∫éÁêÜËß£‰∏≠ÂõΩÈùûÂ∏∏ÊúâÂ∏ÆÂä©„ÄÇÈÄöËøáËøô‰∏™ËØùÈ¢òÔºåÊàë‰ª¨ÂèØ‰ª•‰∫ÜËß£‰∏≠ÂõΩ‰∫∫ÁöÑÊÄùÁª¥ÊñπÂºè„ÄÅÊñáÂåñ‰º†ÁªüÂíåÁ§æ‰ºö‰ª∑ÂÄºËßÇ„ÄÇ

Âú®Â≠¶‰π†Ê±âËØ≠ÁöÑËøáÁ®ã‰∏≠ÔºåÂÖ≥‰∫é{topic}ÁöÑËØçÊ±áÂíåË°®Ëææ‰πüÈùûÂ∏∏ÊúâÁî®„ÄÇÊØîÂ¶ÇÔºåÊàë‰ª¨ÂèØ‰ª•Â≠¶‰π†Âà∞ÂæàÂ§öÁõ∏ÂÖ≥ÁöÑËØçËØ≠ÂíåÂè•Â≠êÁªìÊûÑ„ÄÇ

ÈÇ£‰πàÔºåÂ¶Ç‰ΩïÊõ¥Â•ΩÂú∞Â≠¶‰π†Ëøô‰∏™ËØùÈ¢òÂë¢ÔºüÊàëÂª∫ËÆÆÔºö
Á¨¨‰∏ÄÔºåÂ§öÂê¨Áõ∏ÂÖ≥ÁöÑÊùêÊñôÔºõ
Á¨¨‰∫åÔºåÂ∞ùËØïÁî®Ê±âËØ≠ËÆ®ËÆ∫Ëøô‰∏™ËØùÈ¢òÔºõ
Á¨¨‰∏âÔºåÂ¶ÇÊûúÊúâÊú∫‰ºöÔºå‰∫≤Ë∫´‰ΩìÈ™å‰∏Ä‰∏ã„ÄÇ

ÂΩìÁÑ∂ÔºåÂ≠¶‰π†ËøáÁ®ã‰∏≠ÂèØËÉΩ‰ºöÈÅáÂà∞‰∏Ä‰∫õÂõ∞Èöæ„ÄÇÊØîÂ¶ÇÔºåÊúâ‰∫õ‰∏ì‰∏öËØçÊ±áÊØîËæÉÈöæËÆ∞ÔºåÊúâ‰∫õÊñáÂåñÊ¶ÇÂøµ‰∏çÂ§™ÂÆπÊòìÁêÜËß£„ÄÇ‰ΩÜÊ≤°ÂÖ≥Á≥ªÔºåÊÖ¢ÊÖ¢Êù•Ôºå‰∏ÄÊ≠•‰∏ÄÊ≠•Â≠¶‰π†„ÄÇ

ËÆ∞‰ΩèÔºåÂ≠¶‰π†ËØ≠Ë®Ä‰∏ç‰ªÖÊòØÂ≠¶‰π†ÂçïËØçÂíåËØ≠Ê≥ïÔºåÊõ¥ÊòØÂ≠¶‰π†‰∏ÄÁßçÊñáÂåñÂíåÊÄùÁª¥ÊñπÂºè„ÄÇÈÄöËøá{topic}ÔºåÊàë‰ª¨ÂèØ‰ª•Êõ¥Ê∑±ÂÖ•Âú∞‰∫ÜËß£‰∏≠ÂõΩ„ÄÇ

Â•Ω‰∫ÜÔºå‰ªäÂ§©ÁöÑÊí≠ÂÆ¢Â∞±Âà∞ËøôÈáå„ÄÇÂ∏åÊúõËøô‰∏™ÂÜÖÂÆπÂØπ‰Ω†ÊúâÂ∏ÆÂä©„ÄÇÂ¶ÇÊûú‰Ω†Êúâ‰ªª‰ΩïÈóÆÈ¢òÊàñÊÉ≥Ê≥ïÔºåÊ¨¢ËøéÁïôË®ÄËÆ®ËÆ∫„ÄÇ

‰∏ãÊ¨°ÂÜçËßÅÔºÅÁ•ù‰Ω†Â≠¶‰π†ËøõÊ≠•ÔºÅ"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è HSK
    if request.hsk_level <= 2:
        # –£–ø—Ä–æ—â–∞–µ–º –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö
        base_text = f"""‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑ‰∏≠ÊñáËÄÅÂ∏à„ÄÇ

‰ªäÂ§©Êàë‰ª¨Â≠¶‰π†Ôºö{topic}„ÄÇ

{topic}ÂæàÊúâÊÑèÊÄù„ÄÇÊàë‰ª¨Êù•ÁúãÁúã„ÄÇ

ËøôÊòØ‰ªÄ‰πàÔºüËøôÊòØ{topic}„ÄÇ‰Ω†ÂñúÊ¨¢{topic}ÂêóÔºü

ÊàëÂñúÊ¨¢{topic}„ÄÇ‰Ω†Âë¢Ôºü

Êàë‰ª¨‰∏ÄËµ∑Â≠¶‰π†„ÄÇÊÖ¢ÊÖ¢ËØ¥Ôºå‰∏çË¶ÅÊÄ•„ÄÇ

Â•ΩÔºå‰ªäÂ§©Â≠¶Âà∞ËøôÈáå„ÄÇÂÜçËßÅÔºÅ"""
    
    elif request.hsk_level >= 5:
        # –£—Å–ª–æ–∂–Ω—è–µ–º –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö
        base_text = f"""ÂêÑ‰ΩçÂê¨‰ºóÊúãÂèãÔºåÂ§ßÂÆ∂Â•Ω„ÄÇ

Ê¨¢ËøéÊî∂Âê¨Êú¨ÊúüÊ∑±Â∫¶Ê±âËØ≠Â≠¶‰π†Êí≠ÂÆ¢„ÄÇ‰ªäÂ§©Êàë‰ª¨Â∞ÜÂõ¥Áªï"{topic}"Ëøô‰∏Ä‰∏ªÈ¢òÂ±ïÂºÄÊé¢ËÆ®„ÄÇ

Âú®ÂΩìÂâçÂÖ®ÁêÉÂåñËØ≠Â¢É‰∏ãÔºå{topic}‰Ωú‰∏∫‰∏Ä‰∏™Ë∑®ÊñáÂåñËÆÆÈ¢òÔºåÂºïËµ∑‰∫ÜÂπøÊ≥õÂÖ≥Ê≥®„ÄÇ‰ªéÊú¨Ë¥®‰∏äÁúãÔºå{topic}‰∏ç‰ªÖÊ∂âÂèäËØ≠Ë®ÄÂ±ÇÈù¢ÁöÑË°®ËææÔºåÊõ¥Ëï¥Âê´ÁùÄÊ∑±ÂàªÁöÑÊñáÂåñÂÜÖÊ∂µ„ÄÇ

È¶ñÂÖàÔºåËÆ©Êàë‰ª¨‰ªéÂéÜÂè≤Áª¥Â∫¶ÂÆ°ËßÜ{topic}ÁöÑÊºîÂèòËøáÁ®ã„ÄÇËá™Âè§‰ª•Êù•Ôºå{topic}Âú®‰∏≠ÂõΩ‰º†ÁªüÊñáÂåñ‰ΩìÁ≥ª‰∏≠Âç†ÊçÆÈáçË¶Å‰ΩçÁΩÆ„ÄÇÁõ∏ÂÖ≥ÊñáÁåÆËÆ∞ËΩΩË°®ÊòéÔºåÊó©Âú®ÂÖàÁß¶Êó∂ÊúüÔºå{topic}ÁöÑÊ¶ÇÂøµÂ∞±Â∑≤ÂàùÊ≠•ÂΩ¢ÊàêÔºåÂπ∂ÈöèÁùÄÊó∂‰ª£ÂèòËøÅ‰∏çÊñ≠‰∏∞ÂØåÂèëÂ±ï„ÄÇ

ÂÖ∂Ê¨°ÔºåÁé∞‰ª£Á§æ‰ºöÁöÑ{topic}ÂëàÁé∞Âá∫Êñ∞ÁöÑÁâπÁÇπ„ÄÇÂú®Êï∞Â≠óÂåñËΩ¨ÂûãÁöÑËÉåÊôØ‰∏ãÔºå{topic}ÁöÑË°®Áé∞ÂΩ¢ÂºèÂíåÂÆûË∑µÊñπÂºèÈÉΩÂèëÁîü‰∫ÜÊòæËëóÂèòÂåñ„ÄÇËøôÁßçÂèòÂåñÊó¢Â∏¶Êù•Êú∫ÈÅáÔºå‰πüÂ∏¶Êù•ÊåëÊàò„ÄÇ

‰ªéËØ≠Ë®ÄÂ≠¶‰π†ÁöÑËßíÂ∫¶ËÄåË®ÄÔºåÊéåÊè°‰∏é{topic}Áõ∏ÂÖ≥ÁöÑ‰∏ì‰∏öÊúØËØ≠ÂíåË°®ËææÊñπÂºèËá≥ÂÖ≥ÈáçË¶Å„ÄÇËøô‰∏ç‰ªÖÊúâÂä©‰∫éÊèêÂçáËØ≠Ë®ÄËÉΩÂäõÔºåÊõ¥ËÉΩ‰øÉËøõË∑®ÊñáÂåñÁêÜËß£„ÄÇ

ÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºå‰∏çÂêåÊñáÂåñËÉåÊôØÁöÑÂ≠¶‰π†ËÄÖÂØπ{topic}ÁöÑËÆ§Áü•ÂèØËÉΩÂ≠òÂú®Â∑ÆÂºÇ„ÄÇÂõ†Ê≠§ÔºåÂú®ËÆ®ËÆ∫{topic}Êó∂ÔºåÊàë‰ª¨ÈúÄË¶Å‰øùÊåÅÂºÄÊîæÁöÑÊÄÅÂ∫¶ÔºåÂ∞äÈáçÂ§öÂÖÉËßÜËßí„ÄÇ

ÊÄªËÄåË®Ä‰πãÔºå{topic}ÊòØ‰∏Ä‰∏™ÂÄºÂæóÊ∑±ÂÖ•Á†îÁ©∂ÁöÑÂ§çÊùÇËØæÈ¢ò„ÄÇÈÄöËøáÁ≥ªÁªüÂ≠¶‰π†ÔºåÊàë‰ª¨‰∏ç‰ªÖËÉΩÂ§üÊèêÂçáÊ±âËØ≠Ê∞¥Âπ≥ÔºåÊõ¥ËÉΩÊ∑±ÂåñÂØπ‰∏≠ÂõΩÊñáÂåñÁöÑÁêÜËß£„ÄÇ

ÊÑüË∞¢Êî∂Âê¨ÔºåÊàë‰ª¨‰∏ãÊúüÂÜçËßÅ„ÄÇ"""
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–µ–∫—Å–∏–∫—É
    vocabulary = [
        {
            "chinese": "ËØùÈ¢ò",
            "pinyin": "hu√†t√≠", 
            "translation": "—Ç–µ–º–∞, –ø—Ä–µ–¥–º–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞",
            "example": "‰ªäÂ§©ÁöÑËØùÈ¢òÂæàÊúâÊÑèÊÄù„ÄÇ",
            "category": "ÂêçËØç"
        },
        {
            "chinese": "Â≠¶‰π†",
            "pinyin": "xu√©x√≠",
            "translation": "—É—á–∏—Ç—å—Å—è, –∏–∑—É—á–∞—Ç—å",
            "example": "ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá„ÄÇ",
            "category": "Âä®ËØç"
        },
        {
            "chinese": "ÊñáÂåñ",
            "pinyin": "w√©nhu√†",
            "translation": "–∫—É–ª—å—Ç—É—Ä–∞",
            "example": "‰∏≠ÂõΩÊñáÂåñÂæàÊúâÁâπËâ≤„ÄÇ",
            "category": "ÂêçËØç"
        },
        {
            "chinese": "ÈáçË¶Å",
            "pinyin": "zh√≤ngy√†o",
            "translation": "–≤–∞–∂–Ω—ã–π",
            "example": "Ëøô‰∏™ÈóÆÈ¢òÂæàÈáçË¶Å„ÄÇ",
            "category": "ÂΩ¢ÂÆπËØç"
        }
    ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –±–æ–ª—å—à–µ —Å–ª–æ–≤ –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —É—Ä–æ–≤–Ω–µ–π
    if request.hsk_level >= 4:
        vocabulary.extend([
            {
                "chinese": "Êé¢ËÆ®",
                "pinyin": "t√†nt«éo",
                "translation": "–æ–±—Å—É–∂–¥–∞—Ç—å, –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å",
                "example": "Êàë‰ª¨Êù•Êé¢ËÆ®‰∏Ä‰∏ãËøô‰∏™ÈóÆÈ¢ò„ÄÇ",
                "category": "Âä®ËØç"
            },
            {
                "chinese": "ÁêÜËß£",
                "pinyin": "l«êjiƒõ",
                "translation": "–ø–æ–Ω–∏–º–∞—Ç—å",
                "example": "ÊàëÁêÜËß£‰Ω†ÁöÑÊÑèÊÄù„ÄÇ",
                "category": "Âä®ËØç"
            }
        ])
    
    # –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
    comprehension_questions = [
        {
            "question": f"‰ªäÂ§©Êí≠ÂÆ¢ÁöÑ‰∏ªÈ¢òÊòØ‰ªÄ‰πàÔºü",
            "options": ["Ê±âËØ≠ËØ≠Ê≥ï", topic, "‰∏≠ÂõΩÂéÜÂè≤", "ÊóÖÊ∏∏ÊôØÁÇπ"],
            "correct_answer": 1,
            "explanation": f"‰ªäÂ§©ÁöÑ‰∏ªÈ¢òÊòØÔºö{topic}"
        },
        {
            "question": "‰∏∫‰ªÄ‰πàËøô‰∏™ËØùÈ¢òÂæàÈáçË¶ÅÔºü",
            "options": ["Âõ†‰∏∫ÂæàÁÆÄÂçï", "Âõ†‰∏∫ÊòØÁÉ≠Èó®ËØùÈ¢ò", "Âõ†‰∏∫ÊúâÂä©‰∫éÁêÜËß£‰∏≠ÂõΩÊñáÂåñ", "Âõ†‰∏∫ËÄÅÂ∏àÂñúÊ¨¢"],
            "correct_answer": 2,
            "explanation": "Ëøô‰∏™ËØùÈ¢òÊúâÂä©‰∫éÁêÜËß£‰∏≠ÂõΩÊñáÂåñÂíåÁ§æ‰ºö"
        }
    ]
    
    lesson_id = f"audio_fallback_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–æ 150 –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
    estimated_duration = max(120, len(base_text) // 2)
    
    return {
        "id": lesson_id,
        "title": f"Ê±âËØ≠Â≠¶‰π†Êí≠ÂÆ¢Ôºö{topic}",
        "chinese_text": base_text,
        "pinyin_text": None if not request.include_pinyin else "pinyin —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –∑–¥–µ—Å—å",
        "translation": None if not request.include_translation else "–ø–µ—Ä–µ–≤–æ–¥ –±—É–¥–µ—Ç –∑–¥–µ—Å—å",
        "vocabulary": vocabulary,
        "comprehension_questions": comprehension_questions,
        "difficulty": request.difficulty,
        "hsk_level": request.hsk_level,
        "estimated_duration": estimated_duration,
        "generated_at": datetime.now().isoformat(),
        "topic": request.topic,
        "description": request.description,
        "ai_generated": False,
        "fallback": True,
        "target_length": request.target_length,
        "character_count": len(base_text),
        "word_count": len(base_text.split()),
        "difficulty_analysis": {
            "grammar_complexity": "—Å—Ä–µ–¥–Ω—è—è" if request.hsk_level <= 3 else "–≤—ã—Å–æ–∫–∞—è",
            "vocabulary_level": f"HSK {request.hsk_level}",
            "speed_recommendation": "0.8x" if request.hsk_level <= 2 else "1.0x"
        },
        "note": "–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∫–∞—Å—Ç. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI."
    }

def generate_fallback_audio_lesson(request: AudioLessonRequest):
    """Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ-—É—Ä–æ–∫–∞"""
    
    # –ë–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è HSK
    base_texts = {
        1: "‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑ‰∏≠ÊñáËÄÅÂ∏à„ÄÇ‰ªäÂ§©Êàë‰ª¨Êù•Â≠¶‰π†‰∏≠Êñá„ÄÇ‰∏≠ÊñáÂæàÊúâÊÑèÊÄù„ÄÇ",
        2: "Â§ßÂÆ∂Â•ΩÔºÅÊ¨¢ËøéÊù•Âà∞‰∏≠ÊñáËØæ„ÄÇ‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω„ÄÇÊàëÊÉ≥ÂéªÂÖ¨Âõ≠Êï£Ê≠•„ÄÇ‰Ω†Âë¢Ôºü",
        3: "ÂêåÂ≠¶‰ª¨Â•ΩÔºÅ‰ªäÂ§©Êàë‰ª¨Ë¶ÅÂ≠¶‰π†ÂÖ≥‰∫é‰∏≠ÂõΩÊñáÂåñÁöÑ‰∏ªÈ¢ò„ÄÇ‰∏≠ÂõΩÊúâÂæàÈïøÁöÑÂéÜÂè≤„ÄÇ‰∏≠ÂõΩÁöÑÈ£üÁâ©ÂæàÂ•ΩÂêÉ„ÄÇ",
        4: "Ê¨¢ËøéÊî∂Âê¨Êàë‰ª¨ÁöÑ‰∏≠ÊñáÊí≠ÂÆ¢ÔºÅ‰ªäÂ§©Êàë‰ª¨Êù•ËÅäËÅä‰∏≠ÂõΩÁöÑ‰º†ÁªüËäÇÊó•„ÄÇÊò•ËäÇÊòØÊúÄÈáçË¶ÅÁöÑËäÇÊó•„ÄÇ",
        5: "Âú®Ëøô‰∏™Êï∞Â≠óÊó∂‰ª£ÔºåÂ≠¶‰π†ËØ≠Ë®ÄÂèòÂæóÊõ¥Âä†ÂÆπÊòì„ÄÇÈÄöËøá‰∫íËÅîÁΩëÔºåÊàë‰ª¨ÂèØ‰ª•Êé•Ëß¶Âà∞‰∏∞ÂØåÁöÑÂ≠¶‰π†ËµÑÊ∫ê„ÄÇ",
        6: "‰∏≠ÂçéÊñáÊòéÊ∫êËøúÊµÅÈïøÔºåÂçöÂ§ßÁ≤æÊ∑±„ÄÇ‰ªéÂè§‰ª£ÁöÑÂõõÂ§ßÂèëÊòéÂà∞Áé∞‰ª£ÁöÑÁßëÊäÄÂàõÊñ∞Ôºå‰∏≠ÂõΩ‰∏ÄÁõ¥Âú®‰∏∫‰∏ñÁïåÂÅöÂá∫Ë¥°ÁåÆ„ÄÇ"
    }
    
    base_text = base_texts.get(request.hsk_level, base_texts[3])
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–º—É –≤ —Ç–µ–∫—Å—Ç
    chinese_text = f"‰ªäÂ§©ÁöÑËØùÈ¢òÊòØÔºö{request.topic}„ÄÇ{base_text} Â∏åÊúõ‰Ω†ÂñúÊ¨¢Ëøô‰∏™ÂÜÖÂÆπ„ÄÇÂÜçËßÅÔºÅ"
    
    # –ë–∞–∑–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞
    vocabulary = [
        {
            "chinese": "ËØùÈ¢ò",
            "pinyin": "hu√†t√≠", 
            "translation": "—Ç–µ–º–∞",
            "example": "‰ªäÂ§©ÁöÑËØùÈ¢òÂæàÊúâÊÑèÊÄù„ÄÇ"
        },
        {
            "chinese": "Â≠¶‰π†",
            "pinyin": "xu√©x√≠",
            "translation": "—É—á–∏—Ç—å—Å—è",
            "example": "ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá„ÄÇ"
        }
    ]
    
    lesson_id = f"audio_fallback_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    return {
        "id": lesson_id,
        "title": f"–ê—É–¥–∏–æ-—É—Ä–æ–∫: {request.topic}",
        "chinese_text": chinese_text,
        "pinyin_text": None,
        "translation": f"–¢–µ–º–∞ —Å–µ–≥–æ–¥–Ω—è: {request.topic}. {base_text} –ù–∞–¥–µ—é—Å—å, –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!",
        "vocabulary": vocabulary,
        "difficulty": request.difficulty,
        "hsk_level": request.hsk_level,
        "estimated_duration": len(chinese_text) * 0.5,  # ~0.5 —Å–µ–∫ –Ω–∞ –∏–µ—Ä–æ–≥–ª–∏—Ñ
        "generated_at": datetime.now().isoformat(),
        "topic": request.topic,
        "ai_generated": False,
        "fallback": True,
        "speech_rate": 1.0,
        "word_count": len(chinese_text.split()),
        "character_count": len(chinese_text.replace(" ", "")),
        "study_questions": [
            "–ö–∞–∫–æ–≤–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞?",
            "–ö–∞–∫–∏–µ –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –≤—ã —É—Å–ª—ã—à–∞–ª–∏?"
        ]
    }

class WordStatus(BaseModel):
    user_id: str
    word_id: str          # —Ñ–æ—Ä–º–∞—Ç: "‰Ω†Â•Ω_1"
    status: str           # "saved" –∏–ª–∏ "learned"

class WordTestRequest(BaseModel):
    user_id: str
    source: str = "all"          # "all", "saved", "learned"
    count: int = 20
    test_type: str               # "pinyin_from_char", "char_from_pinyin", "translation_from_char", "translation_from_pinyin"

class WordTestSubmit(BaseModel):
    user_id: str
    test_id: str
    answers: Dict[str, str]      # question_id -> –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

@app.post("/words/status")
async def set_word_status(request: WordStatus):
    user_id = request.user_id
    if user_id not in user_word_status:
        user_word_status[user_id] = {}
    
    user_word_status[user_id][request.word_id] = {
        "status": request.status,
        "added_at": datetime.now().isoformat()
    }
    save_user_data()
    return {"success": True}

@app.post("/words/test/generate")
async def generate_word_test(req: WordTestRequest):
    # –ü–æ–ª—É—á–∞–µ–º –ø—É–ª —Å–ª–æ–≤
    if req.source == "all":
        all_words = []
        for level in range(1, 7):
            all_words.extend(words_db.get(level, []))
    else:
        if req.user_id not in user_word_status:
            raise HTTPException(404, "–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö/–∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤")
        word_ids = [wid for wid, data in user_word_status[req.user_id].items() if data["status"] == req.source]
        all_words = []
        for wid in word_ids:
            char, lvl = wid.rsplit("_", 1)
            level = int(lvl)
            for w in words_db.get(level, []):
                if w["character"] == char:
                    all_words.append(w)
                    break

    if len(all_words) == 0:
        raise HTTPException(400, "–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞")

    if req.count > len(all_words):
        req.count = len(all_words)
    selected = random.sample(all_words, req.count)

    questions = []
    for i, word in enumerate(selected):
        q = {
            "id": str(i),
            "character": word["character"],
            "pinyin": word["pinyin"],
            "translation": word["translation"]
        }
        if req.test_type == "pinyin_from_char":
            q["prompt"] = f"–ü–∏–Ω—å–∏–Ω—å –¥–ª—è: {word['character']}"
            q["correct"] = word["pinyin"]
        elif req.test_type == "char_from_pinyin":
            q["prompt"] = f"–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã –¥–ª—è: {word['pinyin']}"
            q["correct"] = word["character"]
        elif req.test_type == "translation_from_char":
            q["prompt"] = f"–ü–µ—Ä–µ–≤–æ–¥ –¥–ª—è: {word['character']}"
            q["correct"] = word["translation"]
        elif req.test_type == "translation_from_pinyin":
            q["prompt"] = f"–ü–µ—Ä–µ–≤–æ–¥ –¥–ª—è: {word['pinyin']}"
            q["correct"] = word["translation"]
        else:
            raise HTTPException(400, "–ù–µ–≤–µ—Ä–Ω—ã–π test_type")
        questions.append(q)

    test_id = f"word_{req.user_id}_{datetime.now().timestamp()}"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∑–∂–µ
    tests_db[f"active_word_test_{req.user_id}"] = {
        "test_id": test_id,
        "questions": questions,
        "generated_at": datetime.now().isoformat()
    }

    return {"test_id": test_id, "questions": questions, "total": len(questions)}

@app.post("/words/test/submit")
async def submit_word_test(submit: WordTestSubmit):
    test_key = f"active_word_test_{submit.user_id}"
    if test_key not in tests_db or tests_db[test_key].get("test_id") != submit.test_id:
        raise HTTPException(status_code=404, detail="–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω")

    test = tests_db[test_key]
    questions = test["questions"]

    correct = 0
    total = len(questions)
    results = []

    for q in questions:
        qid = q["id"]
        correct_ans = q["correct"].strip().lower()

        user_answer_raw = submit.answers.get(qid)

        # –Ø–í–ù–û: –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –ù–ï–í–ï–†–ù–û
        if user_answer_raw is None or user_answer_raw.strip() == "":
            is_correct = False
            user_display = "(–Ω–µ –æ—Ç–≤–µ—á–µ–Ω–æ)"
        else:
            user_normalized = user_answer_raw.strip().lower()
            is_correct = user_normalized == correct_ans
            user_display = user_answer_raw

        if is_correct:
            correct += 1

        results.append({
            "id": qid,
            "prompt": q["prompt"],
            "user_answer": user_display,
            "correct_answer": q["correct"],
            "correct": is_correct
        })

    percentage = round(correct / total * 100, 1) if total > 0 else 0

    message = f"{correct} –∏–∑ {total} –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ({percentage}%)"
    if percentage >= 90:
        message += " –û—Ç–ª–∏—á–Ω–æ! –í—ã —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—Ç–µ —ç—Ç–∏ —Å–ª–æ–≤–∞!"
    elif percentage >= 70:
        message += " –ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –º–æ–∂–Ω–æ –ª—É—á—à–µ."
    else:
        message += " –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è!"

    return {
        "correct": correct,
        "total": total,
        "percentage": percentage,
        "message": message,
        "results": results
    }

class WordTestAIRequest(BaseModel):
    user_id: str
    test_id: str
    questions: List[Dict[str, Any]]  # [{id, prompt, correct, ...}]
    answers: Dict[str, str]          # {question_id: user_answer}

@app.post("/words/test/check-ai")
async def check_word_test_ai(request: WordTestAIRequest):
    """–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ—Å—Ç –Ω–∞ –∑–Ω–∞–Ω–∏–µ —Å–ª–æ–≤"""
    try:
        client = get_deepseek_client()
        if not client:
            raise HTTPException(status_code=503, detail="AI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò
        system_prompt = """–¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π –∏ —Ç–æ—á–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ—Å—Ç –ø–æ –∫–∏—Ç–∞–π—Å–∫–∏–º —Å–ª–æ–≤–∞–º.

–ü–†–ê–í–ò–õ–ê –ü–†–û–í–ï–†–ö–ò:
1. –£—á–∏—Ç—ã–≤–∞–π —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –±–ª–∏–∑–∫–∏–µ –ø–æ —Å–º—ã—Å–ª—É –æ—Ç–≤–µ—Ç—ã
2. –î–ª—è –ø–∏–Ω—å–∏–Ω—è: –∏–≥–Ω–æ—Ä–∏—Ä—É–π —Ç–æ–Ω—ã –∏ –ø—Ä–æ–±–µ–ª—ã (n«êh«éo = nihao = n«ê h«éo)
3. –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞: –¥–æ–ø—É—Å–∫–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞, –µ—Å–ª–∏ —Å–º—ã—Å–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω
4. –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç ‚Äî –≤—Å–µ–≥–¥–∞ –ù–ï–í–ï–†–ù–û
5. –ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê ‚Äî –¢–û–õ–¨–ö–û JSON:
{
    "correct_count": 12,
    "total": 15,
    "percentage": 80,
    "results": [
        {
            "id": "0",
            "prompt": "–ü–∏–Ω—å–∏–Ω—å –¥–ª—è: ‰Ω†Â•Ω",
            "user_answer": "nihao",
            "correct_answer": "n«ê h«éo",
            "is_correct": true,
            "feedback": "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¢–æ–Ω—ã –º–æ–∂–Ω–æ –æ–ø—É—Å—Ç–∏—Ç—å –≤ —Ç–µ—Å—Ç–µ."
        },
        {
            "id": "1",
            "prompt": "–ü–µ—Ä–µ–≤–æ–¥ –¥–ª—è: Ë∞¢Ë∞¢",
            "user_answer": "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞",
            "correct_answer": "—Å–ø–∞—Å–∏–±–æ",
            "is_correct": false,
            "feedback": "–ù–µ–≤–µ—Ä–Ω–æ. Ë∞¢Ë∞¢ = —Å–ø–∞—Å–∏–±–æ. '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞' = ËØ∑ –∏–ª–∏ ‰∏çÂÆ¢Ê∞î."
        }
    ],
    "summary": "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –û—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ ‚Äî –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –≤–µ–∂–ª–∏–≤—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π."
}"""

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –æ—Ç–≤–µ—Ç–∞–º–∏
        questions_text = ""
        for q in request.questions:
            user_ans = request.answers.get(q["id"], "(–Ω–µ –æ—Ç–≤–µ—á–µ–Ω–æ)")
            questions_text += f"""
–í–æ–ø—Ä–æ—Å {q['id']}: {q['prompt']}
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {q['correct']}
–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞: {user_ans}
"""

        user_prompt = f"""–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–∞.

–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã:
{questions_text}

–û—Ü–µ–Ω–∏ –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –∏ –¥–∞–π –æ–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]

        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.3,
            max_tokens=2000,
            response_format={"type": "json_object"}
        )

        try:
            result = json.loads(response.choices[0].message.content)
        except json.JSONDecodeError:
            # Fallback –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ò–ò –Ω–µ –≤–µ—Ä–Ω—É–ª JSON
            result = fallback_word_test_check(request.questions, request.answers)

        return result

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Å—Ç–∞ —Å–ª–æ–≤: {e}")
        # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º fallback
        return fallback_word_test_check(request.questions, request.answers)

def fallback_word_test_check(questions, answers):
    """–†–µ–∑–µ—Ä–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
    correct = 0
    total = len(questions)
    results = []

    for q in questions:
        qid = q["id"]
        user_raw = answers.get(qid, "")
        user_answer = user_raw.strip().lower() if user_raw else ""

        correct_ans = q["correct"].strip().lower()

        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–Ω—å–∏–Ω—è
        if "–ø–∏–Ω—å–∏–Ω—å" in q["prompt"].lower():
            user_answer = user_answer.replace(" ", "").replace("v", "√º")
            correct_ans = correct_ans.replace(" ", "").replace("v", "√º")

        is_correct = bool(user_answer and user_answer == correct_ans)

        if is_correct:
            correct += 1

        results.append({
            "id": qid,
            "prompt": q["prompt"],
            "user_answer": user_raw.strip() if user_raw else "(–Ω–µ –æ—Ç–≤–µ—á–µ–Ω–æ)",
            "correct_answer": q["correct"],
            "is_correct": is_correct,
            "feedback": "–ü—Ä–∞–≤–∏–ª—å–Ω–æ!" if is_correct else "–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç." if user_answer else "–û—Ç–≤–µ—Ç –Ω–µ –¥–∞–Ω ‚Äî —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–≤–µ—Ä–Ω—ã–º."
        })

    percentage = round(correct / total * 100, 1) if total > 0 else 0

    return {
        "correct_count": correct,
        "total": total,
        "percentage": percentage,
        "results": results,
        "summary": f"{correct}/{total} –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ({percentage}%). {'–û—Ç–ª–∏—á–Ω–æ!' if percentage >= 90 else '–•–æ—Ä–æ—à–æ!' if percentage >= 70 else '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –±–æ–ª—å—à–µ!'}"
    }

@app.get("/user/progress/{user_id}")
async def get_user_progress(user_id: str):
    if user_id not in users_db:
        raise HTTPException(404, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    user = users_db[user_id]
    target = user.get("target_level", 4)
    
    total_words = sum(len(words_db.get(l, [])) for l in range(1, target + 1))
    learned = 0
    if user_id in user_word_status:
        learned = sum(1 for v in user_word_status[user_id].values() if v["status"] == "learned")
    
    percentage = round(learned / total_words * 100, 1) if total_words > 0 else 0
    
    return {
        "learned": learned,
        "total": total_words,
        "percentage": percentage,
        "target_level": target
    }

# –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
try:
    with open("data.pkl", "rb") as f:
        loaded = pickle.load(f)
        globals().update(loaded)
except FileNotFoundError:
    pass

# ========== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ==========
if __name__ == "__main__":
    print("=" * 60)
    print("üéå HSK AI Tutor - –ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä")
    print("=" * 60)
    print(f"üìö –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {len(words_db)} —Å–ª–æ–≤ HSK 1-6")
    print(f"üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(users_db)}")
    print(f"üß™ –°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤: {len(tests_db)}")
    print("=" * 60)
    print("üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä –Ω–∞ http://localhost:8000")
    print("üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs")
    print("üåê –§—Ä–æ–Ω—Ç–µ–Ω–¥: –æ—Ç–∫—Ä–æ–π frontend.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ")
    print("=" * 60)
    
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        reload=True  # –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    )