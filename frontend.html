<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéå HSK AI Tutor - Pragmatic Tutor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --danger: #f5576c;
            --warning: #ff9a00;
            --success: #4cd964;
            --dark: #2d3748;
            --light: #f8f9fa;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        /* Chat Styles */
.chat-item:hover {
    background: #e9ecef !important;
}

.chat-item.active {
    background: #e3f2fd !important;
    border-left-color: #1976d2 !important;
}

#chatList {
    scrollbar-width: thin;
    scrollbar-color: #667eea #f1f1f1;
}

#chatList::-webkit-scrollbar {
    width: 6px;
}

#chatList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chatList::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
}

/* Voice Chat Styles */
.ai-message.warning {
    border-left-color: var(--warning);
    background: #fff3cd;
}

.ai-message.tip {
    border-left-color: var(--primary);
    background: #e3f2fd;
}

.ai-message.error {
    border-left-color: var(--danger);
    background: #fde8e8;
}

.ai-message.info {
    border-left-color: var(--success);
    background: #d4edda;
}

.chengyu-item:hover {
    background: #f8f9fa;
    transform: translateX(5px);
    transition: all 0.3s;
}

/* Recording Animation */
@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

.recording-pulse {
    animation: pulse 1s infinite;
}

#chatList::-webkit-scrollbar-thumb:hover {
    background: #555;
}
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--danger) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .header .tagline {
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: var(--light);
            border-bottom: 1px solid #dee2e6;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--danger);
            margin-bottom: 5px;
        }
        
        .stat-desc {
            color: var(--gray);
            font-size: 0.9em;
        }
        
        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .section-header h2 {
            color: var(--dark);
            font-size: 1.5em;
        }
        
        .section-header .icon {
            font-size: 1.5em;
            color: var(--primary);
        }
        
        /* Chat */
        .chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background: #f1f3f5;
            color: var(--dark);
            border-bottom-left-radius: 5px;
        }
        
        .ai-message .ai-label {
            font-weight: bold;
            color: var(--danger);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .input-group button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 0 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Words Section */
        .words-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .word-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--danger);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .word-card:hover {
            transform: translateX(5px);
        }
        
        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .word-character {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--dark);
        }
        
        .word-level {
            background: var(--warning);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .word-pinyin {
            color: var(--danger);
            font-style: italic;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .word-translation {
            color: var(--gray);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .word-tip {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #1976d2;
            border-left: 3px solid #1976d2;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            color: var(--gray);
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Test Section */
        .test-question {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .test-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .test-option {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .test-option:hover {
            background: #f8f9fa;
            border-color: var(--primary);
        }
        
        .test-option.selected {
            background: #e3f2fd;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        /* Footer */
        .footer {
            background: var(--dark);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .api-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .api-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .api-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
                gap: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* Add to existing styles */
.essay-difficulty-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    color: var(--gray);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.essay-difficulty-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.essay-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.trans-difficulty-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    color: var(--gray);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.trans-difficulty-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.trans-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* For mobile devices */
@media (max-width: 768px) {
    .trans-difficulty-btn {
        padding: 6px 12px;
        font-size: 0.9em;
    }
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
    border-radius: inherit;
}

.tabs-container {
    position: relative;
    overflow: hidden;
    border-bottom: 2px solid #dee2e6;
}

.tabs-scroll {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) #f1f1f1;
    padding-bottom: 5px;
    -webkit-overflow-scrolling: touch;
}

.tabs-scroll::-webkit-scrollbar {
    height: 6px;
}

.tabs-scroll::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.tabs-scroll::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
}

.tab {
    flex-shrink: 0;
    min-width: 120px;
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    font-weight: bold;
    color: var(--gray);
    transition: all 0.3s;
    text-align: center;
    white-space: nowrap;
}

@media (max-width: 768px) {
    .tab {
        min-width: 100px;
        padding: 10px 12px;
        font-size: 0.9em;
    }
}

@media (max-width: 480px) {
    .tab {
        min-width: 85px;
        padding: 8px 10px;
        font-size: 0.8em;
    }
}

/* Styles for HSK buttons in essay mode */
.essay-hsk-btn {
    padding: 10px 20px;
    border: 2px solid #dee2e6;
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    min-width: 80px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    font-size: 14px;
}

.essay-hsk-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-light);
}

.essay-hsk-btn.active {
    background: linear-gradient(145deg, var(--primary), var(--primary-dark));
    color: white;
    border-color: var(--primary);
    box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);
    position: relative;
}

.essay-hsk-btn.active::before {
    content: '‚úì';
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--success);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* Press animation */
.essay-hsk-btn:active {
    transform: translateY(0);
    transition: transform 0.1s;
}

/* Level indicator with gradients for each HSK */
.essay-hsk-btn[data-level="3"] {
    background: linear-gradient(145deg, #a3d9a5, #7bc67e);
    color: white;
    border-color: #6abf69;
}

.essay-hsk-btn[data-level="4"] {
    background: linear-gradient(145deg, #4fc3f7, #29b6f6);
    color: white;
    border-color: #03a9f4;
}

.essay-hsk-btn[data-level="5"] {
    background: linear-gradient(145deg, #ffb74d, #ffa726);
    color: white;
    border-color: #ff9800;
}

.essay-hsk-btn[data-level="6"] {
    background: linear-gradient(145deg, #e57373, #f44336);
    color: white;
    border-color: #e53935;
}

/* Pulsing effect for active button */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0);
    }
}

.essay-hsk-btn.active {
    animation: pulse 2s infinite;
}

/* Translation difficulty button styles */
.trans-difficulty-btn {
    padding: 10px 20px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 12px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-width: 90px;
    text-align: center;
    box-shadow: 0 3px 5px rgba(0, 0, 0, 0.05);
    font-size: 14px;
}

.trans-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--success-light);
}

.trans-difficulty-btn.active {
    background: linear-gradient(145deg, var(--success), var(--success-dark));
    color: white;
    border-color: var(--success);
    box-shadow: 0 4px 15px rgba(var(--success-rgb), 0.3);
}

/* Colors for difficulty levels */
.trans-difficulty-btn[data-difficulty="easy"] {
    background: linear-gradient(145deg, #81c784, #66bb6a);
    color: white;
}

.trans-difficulty-btn[data-difficulty="medium"] {
    background: linear-gradient(145deg, #64b5f6, #42a5f5);
    color: white;
}

.trans-difficulty-btn[data-difficulty="hard"] {
    background: linear-gradient(145deg, #ffb74d, #ffa726);
    color: white;
}

.trans-difficulty-btn[data-difficulty="expert"] {
    background: linear-gradient(145deg, #e57373, #ef5350);
    color: white;
}

/* Add these CSS variables if they don't exist yet */
:root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --primary-light: #6c8eff;
    --success: #06d6a0;
    --success-dark: #05c293;
    --success-light: #5dfdcb;
    --gray: #6c757d;
    --primary-rgb: 67, 97, 238;
    --success-rgb: 6, 214, 160;
}

/* Media query for mobile devices */
@media (max-width: 768px) {
    .essay-hsk-btn,
    .trans-difficulty-btn {
        padding: 8px 15px;
        min-width: 70px;
        font-size: 13px;
    }
    
    .essay-hsk-btn.active::before {
        width: 18px;
        height: 18px;
        font-size: 10px;
        top: -6px;
        right: -6px;
    }
}

/* Add to existing styles */
.audio-difficulty-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    color: var(--gray);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.audio-difficulty-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.audio-difficulty-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Podcast text styles */
.podcast-text {
    font-size: 18px;
    line-height: 1.8;
    margin-bottom: 20px;
    font-family: 'SimSun', 'ÂÆã‰Ωì', serif;
}

.podcast-pinyin {
    color: var(--danger);
    font-style: italic;
    margin-bottom: 10px;
}

.podcast-translation {
    color: var(--gray);
    margin-bottom: 20px;
    padding-left: 15px;
    border-left: 3px solid var(--warning);
}

/* Vocabulary styles */
.vocabulary-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 15px;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 10px;
    align-items: center;
}

.vocabulary-chinese {
    font-size: 1.8em;
    font-weight: bold;
    min-width: 60px;
}

.vocabulary-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.vocabulary-pinyin {
    color: var(--danger);
    font-weight: bold;
}

.vocabulary-meaning {
    color: var(--dark);
}

.vocabulary-example {
    font-size: 0.9em;
    color: var(--gray);
    font-style: italic;
    margin-top: 5px;
}

.vocabulary-speak {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    font-size: 1.2em;
    padding: 5px;
}

/* Word card styles */
.words-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.word-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 2px solid transparent;
}

.word-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.word-character {
    font-size: 2.5em;
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
    font-family: 'SimSun', serif;
}

.word-pinyin {
    text-align: center;
    color: var(--danger);
    font-size: 1.1em;
    margin-bottom: 5px;
    font-style: italic;
}

.word-translation {
    text-align: center;
    color: var(--dark);
    font-size: 1em;
    margin-bottom: 10px;
}

.word-level {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.word-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.word-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--gray);
    transition: color 0.3s;
}

.word-action-btn:hover {
    color: var(--primary);
}

.word-status {
    position: absolute;
    bottom: 10px;
    left: 10px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
    color: white;
}

/* Progress bar */
.progress-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 20px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    background: var(--primary);
}

/* Improved search field */
#wordsSearch {
    flex: 1;
    min-width: 250px;
    padding: 12px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 25px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#wordsSearch:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    transform: translateY(-1px);
}

/* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ê–î–ê–ü–¢–ê–¶–ò–ò (Mobile & Tablet) --- */

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 1024px) */
@media (max-width: 1024px) {
    /* –ï—Å–ª–∏ —Å–µ–∫—Ü–∏—è Content –±—ã–ª–∞ –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω–æ–π, –æ–Ω–∞ —É–∂–µ —Å—Ö–ª–æ–ø–Ω–µ—Ç—Å—è –¥–æ 1fr –±–ª–∞–≥–æ–¥–∞—Ä—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø—Ä–∞–≤–∏–ª—É */
    .content {
        grid-template-columns: 1fr;
    }
    
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ –¢–µ–∫—Å—Ç–æ–≤ –∏–ª–∏ –ü—Ä–æ—Ñ–∏–ª–µ) —Ç–æ–∂–µ —Å—Ö–ª–æ–ø—ã–≤–∞—é—Ç—Å—è */
    .section > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }
    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–µ–∫—Ü–∏–∏ Grammar, –≥–¥–µ –±—ã–ª–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ 200px */
    #grammar-tab .section > div[style*="grid-template-columns: 200px 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    /* –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –≥—Ä–∏–¥–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
    #progress-tab .section > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 768px) */
@media (max-width: 768px) {
    body {
        padding: 10px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
    }

    .container {
        border-radius: 10px;
    }

    .header {
        padding: 20px 15px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    }
    
    .header h1 {
        font-size: 2em; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    }
    
    .header .subtitle, .header .tagline {
        font-size: 1em;
    }

    .stats-grid {
        padding: 15px;
        gap: 10px;
    }
    
    .stat-card {
        padding: 15px;
    }

    .content {
        padding: 15px;
        gap: 15px;
    }

    .section {
        padding: 15px;
    }
    
    /* –ß–∞—Ç: –≤—ã—Å–æ—Ç–∞ –∏ –≥—Ä—É–ø–ø–∞ –≤–≤–æ–¥–∞ */
    .chat-box {
        height: 350px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É —á–∞—Ç–∞ */
    }
    
    .input-group {
        flex-direction: column;
    }

    .input-group input,
    .input-group button {
        width: 100%;
        padding: 12px;
        justify-content: center;
    }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ: —É–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
    #grammar-tab .section > div[style*="min-height: 500px"] > div:first-child {
        border-right: none !important;
        padding-right: 0 !important;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }

    /* –§—É—Ç–µ—Ä */
    .footer {
        padding: 20px 15px;
    }
    
    .api-links {
        flex-direction: column;
        gap: 8px;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ HSK/Difficulty –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É, –µ—Å–ª–∏ –∏—Ö —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ */
    .essay-hsk-btn-group,
    .trans-difficulty-group {
        flex-wrap: wrap;
        gap: 8px !important;
    }
    
    .essay-hsk-btn,
    .trans-difficulty-btn {
        flex-basis: 48%; /* 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ */
        font-size: 13px;
        padding: 8px 10px;
    }

}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 480px) */
@media (max-width: 480px) {
    .header h1 {
        font-size: 1.6em;
    }
    .header .subtitle, .header .tagline {
        font-size: 0.85em;
    }
    .chat-box {
        height: 250px;
    }
    .message {
        max-width: 95%; /* –î–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
        padding: 10px 12px;
        font-size: 0.9em;
    }
    .tabs-scroll {
        padding-bottom: 0; /* –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
    }

    .essay-hsk-btn,
    .trans-difficulty-btn {
        flex-basis: 100%; /* 1 –∫–Ω–æ–ø–∫–∞ –≤ —Ä—è–¥ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
    }
}
/* --- –ù–û–í–´–ô –ë–õ–û–ö –ê–î–ê–ü–¢–ê–¶–ò–ò (–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Mobile & Tablet) --- */

/* –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–¥–æ 1024px) */
@media (max-width: 1024px) {
    /* –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã—Ö –º–∞–∫–µ—Ç–æ–≤ */
    .content {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    /* –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –ª—é–±—ã—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≥—Ä–∏–¥–æ–≤ (–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫, –ü—Ä–æ—Ñ–∏–ª—å) */
    .section > div[style*="grid-template-columns: 1fr 1fr"],
    /* –§–∏–∫—Å –¥–ª—è —Å–µ–∫—Ü–∏–∏ –ì—Ä–∞–º–º–∞—Ç–∏–∫–∏ (200px 1fr) */
    #grammar-tab .section > div[style*="grid-template-columns: 200px 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }

    /* –£–±—Ä–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    #grammar-tab .section > div[style*="min-height: 500px"] {
        min-height: auto !important;
    }

    /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É —Å–ø–∏—Å–∫–∞ —Ç–µ–º –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ */
    #grammarTopicsList {
        max-height: 300px !important;
        padding-right: 0 !important;
        border-right: none !important;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 768px) */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    .header h1 {
        font-size: 2em;
    }
    
    /* –°–µ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Ç–µ–ø–µ—Ä—å 3-4 —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Ä—è–¥) */
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    }
    
    .chat-box {
        height: 350px;
    }
    
    /* –ì—Ä—É–ø–ø–∞ –≤–≤–æ–¥–∞ —á–∞—Ç–∞ */
    .input-group {
        flex-direction: column;
    }

    .input-group input,
    .input-group button {
        width: 100%;
        padding: 12px;
        justify-content: center;
    }
    
    /* --- –§–ò–ö–° –õ–ò–°–¢–ê –°–õ–û–í (Words Tab) --- */
    #words-tab .section {
        overflow-x: auto; /* –í–∫–ª—é—á–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –ª–∏—Å—Ç–∞ —Å–ª–æ–≤ */
        -webkit-overflow-scrolling: touch;
    }
    
    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è —Å—Ç—Ä–æ–∫, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    .word-item-header, .word-item {
        /* –≠—Ç–∏ –∫–ª–∞—Å—Å—ã –Ω–µ –±—ã–ª–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ, –Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, —Ç–æ: */
        width: 750px; /* –®–∏—Ä–∏–Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è 6 –∫–æ–ª–æ–Ω–æ–∫ */
        grid-template-columns: 1.5fr 2fr 2fr 0.8fr 1.5fr 2fr !important; /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ */
        padding: 10px 10px;
        font-size: 0.9em;
    }

    /* –ï—Å–ª–∏ –≤ Word Tab –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è actual table (Snippet 15), –æ–Ω–∞ –±—É–¥–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è overflow-x: auto –Ω–∞ .section */

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        padding: 10px; 
    }
    .modal-content {
        width: 95% !important; /* –ú–æ–¥–∞–ª–∫–∞ –Ω–∞ 95% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ */
        max-width: none !important;
        margin: 5vh auto; /* –ß—É—Ç—å –≤—ã—à–µ */
        padding: 20px !important;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ HSK/Difficulty (2 –≤ —Ä—è–¥) */
    .essay-hsk-btn,
    .trans-difficulty-btn {
        flex-basis: calc(50% - 4px); /* 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ */
        font-size: 13px;
        padding: 8px 10px;
    }
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–¥–æ 480px) */
@media (max-width: 480px) {
    .header h1 {
        font-size: 1.6em;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ HSK/Difficulty (1 –≤ —Ä—è–¥) */
    .essay-hsk-btn,
    .trans-difficulty-btn {
        flex-basis: 100%; 
    }

    .word-item-header, .word-item {
        width: 600px; /* –ß—É—Ç—å —É–∂–µ –¥–ª—è –º–µ–ª–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
        font-size: 0.85em;
    }
}
/* --- –ù–û–í–´–ô –ë–õ–û–ö –ê–î–ê–ü–¢–ê–¶–ò–ò (–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Mobile & Tablet) --- */

/* –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–¥–æ 1024px) */
@media (max-width: 1024px) {
    /* ... (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è –≥—Ä–∏–¥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) ... */
    
    /* –û–±—â–µ–µ —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≥—Ä–∏–¥–æ–≤ */
    .section > div[style*="grid-template-columns: 1fr 1fr"],
    #grammar-tab .section > div[style*="grid-template-columns: 200px 1fr"],
    #translation-check-tab .section > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 768px) */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    /* 1. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –í–µ—Ä—Ö–Ω–µ–π –ü–∞–Ω–µ–ª–∏ (Header) */
    .header {
        flex-direction: column; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤ —Å—Ç–æ–ª–±–µ—Ü */
        align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        padding: 15px 10px;
        gap: 10px;
    }
    .header h1 {
        font-size: 1.8em; 
    }
    .header .subtitle, .header .tagline {
        font-size: 0.9em;
    }
    .header > div:last-child {
        width: 100%; /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        justify-content: space-between;
    }
    .user-info {
        order: -1; /* –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤–≤–µ—Ä—Ö */
    }

    /* 2. –ß–∞—Ç (AI Tutor –∏ Voice) */
    .chat-box, #voiceChatBox {
        height: 300px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É —á–∞—Ç–∞ */
    }
    .input-group {
        flex-direction: column;
    }
    .input-group input,
    .input-group button {
        width: 100%;
        padding: 12px;
    }

    /* 2.1. –ß–∞—Ç: –ö–Ω–æ–ø–∫–∏ –¥–ª—è –ì–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ */
    #voice-tab .input-group-chat {
        flex-direction: column;
        gap: 10px;
    }
    #voice-tab .input-group-chat button {
        width: 100%;
    }


    /* 3. Grammar (–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞) */
    #grammar-tab .section > div[style*="min-height: 500px"] > div:first-child {
        /* –°–ø–∏—Å–æ–∫ —Ç–µ–º: —É–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é, –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é */
        border-right: none !important;
        padding-right: 0 !important;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        overflow-y: auto;
        max-height: 250px; /* –£–º–µ–Ω—å—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —Å–ø–∏—Å–∫–∞ —Ç–µ–º */
    }
    #grammarTopicsList a {
        padding: 8px 5px;
        font-size: 0.9em;
    }
    
    /* 4. Translation Check */
    /* –ú–∞–∫–µ—Ç —É–∂–µ —Å—Ö–ª–æ–ø–Ω—É—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–±—â–µ–º—É –ø—Ä–∞–≤–∏–ª—É, –Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ */
    #translation-check-tab .input-group {
        flex-direction: column;
        gap: 10px;
    }
    #translation-check-tab .input-group button {
        width: 100%;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ —Ç–∞–±–æ–≤ */
    .tabs-scroll {
        padding-bottom: 0;
    }
    
    /* ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) ... */
}


/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 480px) */
@media (max-width: 480px) {
    .header h1 {
        font-size: 1.4em;
    }
    .header .subtitle, .header .tagline {
        font-size: 0.75em;
    }
    .tabs-scroll .tab-button {
        padding: 8px 12px;
        font-size: 13px;
    }
    .stat-card h3 {
        font-size: 1.2em;
    }
    .stat-card p {
        font-size: 0.8em;
    }
}
:root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --danger: #f5576c;
            --warning: #ff9a00;
            --success: #4cd964;
            --dark: #2d3748;
            --light: #f8f9fa;
            --gray: #6c757d;
            
            /* –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –∫–Ω–æ–ø–æ–∫ */
            --primary-dark: #3a56d4;
            --primary-light: #6c8eff;
            --success-dark: #05c293;
            --success-light: #5dfdcb;
            --primary-rgb: 102, 126, 234;
            --success-rgb: 76, 217, 100;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--danger) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            display: flex; /* –°–¥–µ–ª–∞–µ–º Header flex, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .header .tagline {
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: var(--light);
            border-bottom: 1px solid #dee2e6;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--danger);
            margin-bottom: 5px;
        }
        
        .stat-desc {
            color: var(--gray);
            font-size: 0.9em;
        }
        
        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .section-header h2 {
            color: var(--dark);
            font-size: 1.5em;
        }
        
        .section-header .icon {
            font-size: 1.5em;
            color: var(--primary);
        }
        
        /* Chat */
        .chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background: #f1f3f5;
            color: var(--dark);
            border-bottom-left-radius: 5px;
        }
        
        .ai-message .ai-label {
            font-weight: bold;
            color: var(--danger);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .input-group button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 0 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Words Section (Card View) */
        .words-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .word-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }
        
        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .word-character {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            font-family: 'SimSun', serif;
        }
        
        .word-pinyin {
            text-align: center;
            color: var(--danger);
            font-size: 1.1em;
            margin-bottom: 5px;
            font-style: italic;
        }
        
        .word-translation {
            text-align: center;
            color: var(--dark);
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .word-level {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Tabs */
        .tabs-container {
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid #dee2e6;
        }

        .tabs-scroll {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .tabs-scroll::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            flex-shrink: 0;
            min-width: 120px;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            color: var(--gray);
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Footer */
        .footer {
            background: var(--dark);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .api-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .api-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .api-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
        }
        
        /* --- –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –í–ù–£–¢–†–ï–ù–ù–ò–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í --- */
        
        /* Chat History Sidebar */
        .chat-item:hover {
            background: #e9ecef !important;
        }
        
        .chat-item.active {
            background: #e3f2fd !important;
            border-left-color: #1976d2 !important;
        }
        
        /* Voice Chat Styles */
        #voiceChatBox {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ai-message.warning {
            border-left-color: var(--warning);
            background: #fff3cd;
        }
        
        .ai-message.tip {
            border-left-color: var(--primary);
            background: #e3f2fd;
        }
        
        /* Recording Animation */
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        .recording-pulse {
            animation: pulse 1s infinite;
        }

        /* --- –ê–î–ê–ü–¢–ò–í–ù–´–ô –î–ò–ó–ê–ô–ù (–§–ò–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö) --- */

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ —ç–∫—Ä–∞–Ω–æ–≤ –¥–æ 1024px */
        @media (max-width: 1024px) {
            /* –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã—Ö –º–∞–∫–µ—Ç–æ–≤ */
            .content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            /* –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –ª—é–±—ã—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≥—Ä–∏–¥–æ–≤ (–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫, –ü—Ä–æ—Ñ–∏–ª—å, Translation Check) */
            .section > div[style*="grid-template-columns: 1fr 1fr"],
            #translation-check-tab .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            
            /* –§–∏–∫—Å –¥–ª—è —Å–µ–∫—Ü–∏–∏ Grammar (200px 1fr -> 1fr) */
            #grammar-tab .section > div[style*="grid-template-columns: 200px 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* –£–±—Ä–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ */
            #grammar-tab .section > div[style*="min-height: 500px"] {
                min-height: auto !important;
            }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 768px) */
        @media (max-width: 768px) {
            body {
                padding: 10px; 
            }
            
            /* 1. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –í–µ—Ä—Ö–Ω–µ–π –ü–∞–Ω–µ–ª–∏ (Header) */
            .header {
                flex-direction: column; 
                align-items: flex-start;
                padding: 15px 10px;
                gap: 10px;
                text-align: left;
            }
            .header > div:last-child {
                width: 100%; /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
                justify-content: space-between;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .header h1 {
                font-size: 1.8em; 
                margin-bottom: 0;
            }
            .header .subtitle, .header .tagline {
                font-size: 0.9em;
                margin-bottom: 0;
            }
            .header .tagline {
                order: -1; /* –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–µ–≥–ª–∞–π–Ω –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–µ—Ä–µ–¥ h1/subtitle */
            }

            /* –°–µ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: 3-4 —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Ä—è–¥ */
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
                padding: 15px;
            }
            
            .content {
                padding: 15px;
                gap: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            /* 2. –ß–∞—Ç (AI Tutor) */
            .chat-box {
                height: 300px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É —á–∞—Ç–∞ */
            }
            .input-group {
                flex-direction: column;
            }
            .input-group input,
            .input-group button {
                width: 100%;
                padding: 12px;
                justify-content: center;
            }

            /* 3. Grammar (–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞) */
            #grammarTopicsList {
                /* –°–ø–∏—Å–æ–∫ —Ç–µ–º: —É–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é, –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é */
                max-height: 250px !important;
                padding-right: 0 !important;
                border-right: none !important;
                padding-bottom: 15px;
                border-bottom: 1px solid #dee2e6;
                overflow-y: auto;
            }
            #grammar-tab .section > div[style*="min-height: 500px"] > div:first-child {
                padding-right: 0 !important;
                padding-bottom: 15px;
                border-right: none !important;
                border-bottom: 1px solid #dee2e6 !important;
            }

            /* 4. Voice (–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç) */
            #voice-tab .input-group-chat {
                display: flex;
                flex-direction: column; /* –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞ */
                gap: 10px;
            }
            #voice-tab .input-group-chat button {
                width: 100%;
            }

            /* 5. Translation Check */
            #translation-check-tab .input-group {
                flex-direction: column;
                gap: 10px;
            }
            #translation-check-tab .input-group button {
                width: 100%;
            }

            /* Word List Table (–¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞) */
            #words-tab .section {
                overflow-x: auto; /* –í–∫–ª—é—á–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –ª–∏—Å—Ç–∞ —Å–ª–æ–≤ */
                -webkit-overflow-scrolling: touch;
            }
            
            /* –ö–Ω–æ–ø–∫–∏ HSK/Difficulty (2 –≤ —Ä—è–¥) */
            .essay-hsk-btn-group,
            .trans-difficulty-group {
                flex-wrap: wrap;
                gap: 8px !important;
            }
            .essay-hsk-btn,
            .trans-difficulty-btn {
                flex-basis: calc(50% - 4px); /* 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ */
                font-size: 13px;
                padding: 8px 10px;
            }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—à–∏—Ä–∏–Ω–∞ –¥–æ 480px) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.6em;
            }
            .header .subtitle, .header .tagline {
                font-size: 0.85em;
            }
            .chat-box, #voiceChatBox {
                height: 250px;
            }
            .message {
                max-width: 95%; /* –î–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
                padding: 10px 12px;
                font-size: 0.9em;
            }
            
            /* –ö–Ω–æ–ø–∫–∏ HSK/Difficulty (1 –≤ —Ä—è–¥) */
            .essay-hsk-btn,
            .trans-difficulty-btn {
                flex-basis: 100%; /* 1 –∫–Ω–æ–ø–∫–∞ –≤ —Ä—è–¥ */
            }
        }
    /* Header */
.header {
    background: linear-gradient(135deg, var(--accent) 0%, var(--danger) 100%);
    color: white;
    padding: 30px;
    /* text-align: center; -- –≠—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å Flexbox */
    position: relative;
    
    /* --- FIX 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Flexbox –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ --- */
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: left; /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
}
@media (max-width: 768px) {
    /* ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è 768px) ... */

    /* --- FIX 2: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã –≤ —Ä–∞–∑–¥–µ–ª–µ Grammar --- */
    #grammar-tab .section > div[style*="grid-template-columns: 200px 1fr"] {
         min-height: auto !important; /* –°–±—Ä–æ—Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤—ã—Å–æ—Ç—ã –¥–ª—è –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    }
    
    #grammar-tab .section > div[style*="min-height: 500px"] > div:first-child { 
        height: auto !important; /* –°–±—Ä–æ—Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–µ–º */
    }
    
    /* ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è 768px) ... */
}
@media (max-width: 768px) {
    /* ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è 768px) ... */
    
    /* FIX 3: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –≥—Ä—É–ø–ø –∫–Ω–æ–ø–æ–∫ –≤ Translation Check –∏ Essay Analysis */
    /* –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ —Å–¥–µ–ª–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∫–Ω–æ–ø–æ–∫ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    #translationArea > div > div[style*="display: flex; gap: 10px;"],
    #essayAnalysisArea > div > div[style*="display: flex; gap: 10px;"] {
        flex-direction: column !important; 
        gap: 10px !important; 
    }
    
    #translationArea > div > div[style*="display: flex; gap: 10px;"] button,
    #essayAnalysisArea > div > div[style*="display: flex; gap: 10px;"] button {
        width: 100%;
    }
    
    /* ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è 768px) ... */
}
/* ---------------------------------------------------------------------- */
/* --- –ù–û–í–´–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –ê–î–ê–ü–¢–ê–¶–ò–ò –î–õ–Ø –í–°–ï–• –£–ö–ê–ó–ê–ù–ù–´–• –ü–†–û–ë–õ–ï–ú --- */
/* ---------------------------------------------------------------------- */

/* 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ (Header) */
.header {
    /* –î–æ–±–∞–≤–ª—è–µ–º Flexbox –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    display: flex; 
    justify-content: space-between; /* –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∞—è–º */
    align-items: center; 
    text-align: left; /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º text-align: center –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞ */
    flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
}

/* 2. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (max-width: 1024px) */
@media (max-width: 1024px) {
    
    /* *** –ö–û–†–†–ï–ö–¢–ò–†–£–Æ–©–ï–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø –†–ê–ó–î–ï–õ–ê GRAMMAR *** */
    /* –¢–µ–ø–µ—Ä—å –Ω–∞—Ü–µ–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 300px 1fr */
    #grammar-tab .section > div[style*="grid-template-columns: 300px 1fr"] {
        grid-template-columns: 1fr !important; /* –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –¥–æ –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ */
        gap: 20px !important;
    }
    
    /* –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É 500px –≤ Grammar */
    #grammar-tab .section > div[style*="min-height: 500px"] {
        min-height: auto !important;
    }
    
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ 2-–∫–æ–ª–æ–Ω–æ—á–Ω—ã–µ –≥—Ä–∏–¥—ã —Ç–∞–∫–∂–µ —Å—Ö–ª–æ–ø—ã–≤–∞—é—Ç—Å—è */
    .section > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
}

/* 3. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (max-width: 768px) */
@media (max-width: 768px) {
    
    /* –î–µ–ª–∞–µ–º –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .header {
        flex-direction: column; 
        text-align: center;
        padding: 20px 15px; 
    }
    
    /* –ß–∞—Ç (AI Assistant) - –¥–µ–ª–∞–µ–º –≥—Ä—É–ø–ø—É –≤–≤–æ–¥–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π */
    .input-group {
        flex-direction: column !important; 
    }

    /* *** –ö–û–†–†–ï–ö–¢–ò–†–£–Æ–©–ï–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø –ì–†–£–ü–ü –ö–ù–û–ü–û–ö *** */
    /* –ù–∞—Ü–µ–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –∏–Ω–ª–∞–π–Ω-Flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ Essay/Translation Check/Voice */
    /* (–Ω–∞–ø—Ä–∏–º–µ—Ä, Submit/Cancel –∫–Ω–æ–ø–∫–∏) –∏ –¥–µ–ª–∞–µ–º –∏—Ö –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º–∏ */
    
    /* Essay Analysis (—Å–º. —Å—Ç—Ä–æ–∫—É ~400) */
    #essay-analysis-tab .section > div:first-child > div[style*="display: flex;"] {
        flex-direction: column !important; 
        gap: 10px !important; 
    }
    
    /* Translation Check (–ö–Ω–æ–ø–∫–∏ Submit/Cancel) */
    #translationArea > div:last-child > div[style*="display: flex;"],
    /* –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è flex-–≥—Ä—É–ø–ø –∫–Ω–æ–ø–æ–∫ */
    .section > div[style*="display: flex; gap: 10px;"] {
        flex-direction: column !important; 
        gap: 10px !important; 
        width: 100%; 
    }
    
    /* –î–µ–ª–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø –ø–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–º–∏ */
    #essay-analysis-tab .section > div:first-child > div[style*="display: flex;"] button,
    #translationArea > div:last-child > div[style*="display: flex;"] button,
    .section > div[style*="display: flex; gap: 10px;"] button {
        width: 100%;
        justify-content: center;
    }
    
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ: —É–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é */
    #grammar-tab .section > div[style*="min-height: 500px"] > div:first-child {
        border-right: none !important;
        padding-right: 0 !important;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        max-height: 300px !important; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Å–ø–∏—Å–∫–∞ */
        overflow-y: auto;
    }
}

/* 4. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (max-width: 480px) */
@media (max-width: 480px) {
    /* –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ HSK/Difficulty –ø–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–º–∏ (1 –≤ —Ä—è–¥) –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
    .essay-hsk-btn,
    .trans-difficulty-btn {
        flex-basis: 100% !important; 
    }
}
/* ---------------------------------------------------------------------- */
/* --- –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –ê–î–ê–ü–¢–ò–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï --- */
/* ---------------------------------------------------------------------- */

/* 1. –û–±—â–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ (Header) */
.header {
    /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º Flexbox –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    flex-wrap: wrap !important; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    padding: 30px !important; 
    text-align: left !important;
}

/* 2. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (max-width: 768px) */
@media (max-width: 768px) {

    /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å --- */
    .header {
        flex-direction: column !important; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
        padding: 20px 15px !important;
        text-align: center !important;
        gap: 15px; /* –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    }
    
    /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ —à–∞–ø–∫–∏ –∑–∞–Ω–∏–º–∞—é—Ç –ø–æ–ª–Ω—É—é —à–∏—Ä–∏–Ω—É */
    .header > * {
        width: 100% !important;
        text-align: center !important;
    }


    /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –†–∞–∑–¥–µ–ª Grammar (–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞) --- */
    
    /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª—å grid-template-columns: 300px 1fr */
    #grammar-tab .section > div[style*="grid-template-columns: 300px 1fr"] {
        grid-template-columns: 1fr !important; /* –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –¥–æ –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ */
        min-height: auto !important; /* –£–±–∏—Ä–∞–µ–º –∂–µ—Å—Ç–∫—É—é –≤—ã—Å–æ—Ç—É */
        gap: 20px !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω) */
    #grammar-tab .section > div[style*="min-height: 500px"] > div:first-child {
        border-right: none !important;
        padding-right: 0 !important;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        max-height: 300px !important; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
        overflow-y: auto !important;
    }

    /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∏ –≤ Translation Check, Voice, Essay Analysis --- */
    
    /* –ù–∞—Ü–µ–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –≤—Å–µ –∏–Ω–ª–∞–π–Ω-Flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –¥–µ–ª–∞–µ–º –∏—Ö –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º–∏ */
    .section > div[style*="display: flex;"],
    .input-group {
        flex-direction: column !important;
        gap: 10px !important;
        width: 100% !important;
    }
    
    /* –î–µ–ª–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø –ø–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–º–∏ */
    .section > div[style*="display: flex;"] button,
    .input-group button,
    /* –û—Ç–¥–µ–ª—å–Ω–æ –Ω–∞—Ü–µ–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ HSK/Difficulty, —É –∫–æ—Ç–æ—Ä—ã—Ö –∏–Ω–ª–∞–π–Ω width */
    .essay-hsk-btn[style*="width: 25%"],
    .trans-difficulty-btn[style*="width: 25%"] {
        width: 100% !important;
        flex-basis: 100% !important;
    }
    
}
@media (max-width: 768px) {
    /* AI Tutor layout */
    #ai-tutor-tab .content,
    #ai-tutor-tab .section {
        padding: 12px;
    }

    #ai-tutor-tab .chat-box {
        height: 260px; /* –∫–ª—é—á–µ–≤–æ–π —Ñ–∏–∫—Å */
    }

    #ai-tutor-tab .input-group {
        flex-direction: column;
        gap: 8px;
    }

    #ai-tutor-tab .input-group input,
    #ai-tutor-tab .input-group button {
        width: 100%;
    }
}
@media (max-width: 768px) {
    #voice-tab .chat-box,
    #voiceChatBox {
        height: 240px;
    }

    #voice-tab .input-group,
    #voice-tab .input-group-chat {
        flex-direction: column;
        gap: 10px;
    }

    #voice-tab button {
        width: 100%;
    }
}
@media (max-width: 768px) {
    #translation-check-tab .section > div {
        display: flex !important;
        flex-direction: column !important;
        gap: 15px;
    }

    #translation-check-tab textarea {
        width: 100%;
        min-height: 140px;
        font-size: 15px;
    }

    #translation-check-tab .input-group {
        flex-direction: column;
    }

    #translation-check-tab button {
        width: 100%;
    }
}
@media (max-width: 768px) {
    .tabs {
        overflow-x: auto;
        white-space: nowrap;
    }

    .tab {
        min-width: 100px;
        font-size: 14px;
    }
}
/* –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (‚â§ 768px) */
@media (max-width: 768px) {
    /* –û–±—â–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
    body, .container { padding: 10px; }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .navbar {
        flex-wrap: wrap;
        justify-content: space-between;
        padding: 10px;
    }
    .nav-links {
        display: none; /* —Å–∫—Ä—ã—Ç—å –æ–±—ã—á–Ω–æ–µ –º–µ–Ω—é */
        flex-direction: column;
        width: 100%;
    }
    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é */
    .hamburger { display: block; }

    /* –ß–∞—Ç */
    #chatBox, #voiceChatBox {
        max-height: 60vh;
        font-size: 15px;
    }
    #messageInput, #translationText {
        font-size: 16px;
        padding: 12px;
    }

    /* Translation check */
    #originalTranslationText, #translationText {
        font-size: 16px;
        line-height: 1.5;
        word-break: break-word;
    }
    .translation-buttons {
        flex-direction: column;
        gap: 10px;
    }

    /* Voice controls */
    .voice-controls {
        flex-direction: column;
        align-items: stretch;
    }
}

/* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã (‚â§ 480px) */
@media (max-width: 480px) {
    h2, h3 { font-size: 1.4em; }
    button { padding: 10px 15px; font-size: 14px; }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <!-- Header -->
<div class="header">
    <h1><i class="fas fa-dragon"></i> HSK AI Tutor</h1>
    <p class="subtitle">Pragmatic Tutor for Passing HSK at Any Cost (Legally)</p>
    
    <!-- Authorization Forms -->
    <div id="authSection" style="margin-top: 20px;">
        <!-- Guest -->
        <div id="guestView" style="text-align: center;">
            <div class="tagline" style="margin-bottom: 15px;">
                <i class="fas fa-user"></i> Guest (progress not saved)
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="showLoginForm()" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Log In
                </button>
                <button onclick="showRegisterFormFull()" class="btn btn-success">
                    <i class="fas fa-user-plus"></i> Register
                </button>
            </div>
        </div>
        
        <!-- Authorized User -->
        <div id="userView" style="display: none; text-align: center;">
            <div class="tagline">
                <i class="fas fa-user-check"></i> Welcome, <span id="userNameDisplay"></span>!
            </div>
            <div style="margin-top: 10px;">
                <button onclick="showProfile()" class="btn btn-primary">
                    <i class="fas fa-user"></i> Profile
                </button>
                <button onclick="logout()" class="btn btn-secondary" style="margin-left: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Log Out
                </button>
            </div>
        </div>
    </div>
</div>
        
        <!-- Statistics -->
        <div class="stats-grid" id="stats">
            <!-- Statistics will load via JS -->
        </div>
        
        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-scroll">
                <div class="tab active" onclick="switchTab('chat')">
                    <i class="fas fa-robot"></i> AI Tutor
                </div>
                <div class="tab" onclick="switchTab('words')">
                    <i class="fas fa-book"></i> Words
                </div>
                <div class="tab" onclick="switchTab('test')">
                    <i class="fas fa-graduation-cap"></i> Tests
                </div>
                <div class="tab" onclick="switchTab('progress')">
                    <i class="fas fa-chart-line"></i> Progress
                </div>
                <div class="tab" onclick="switchTab('admission')">
                    <i class="fas fa-university"></i> Admission
                </div>
                <div class="tab" onclick="switchTab('translator')">
                    <i class="fas fa-language"></i> Translator
                </div>
                <div class="tab" onclick="switchTab('grammar')">
                    <i class="fas fa-language"></i> Grammar
                </div>
                <div class="tab" onclick="switchTab('voice-chat')">
                    <i class="fas fa-microphone-alt"></i> Voice
                </div>
                <div class="tab" onclick="switchTab('text-generator')">
                    <i class="fas fa-scroll"></i> Reading Generator
                </div>
                <div class="tab" onclick="switchTab('essay-checker')">
                    <i class="fas fa-check-double"></i> Translation Check
                </div>
                <div class="tab" onclick="switchTab('essay-analysis')">
                    <i class="fas fa-file-alt"></i> Essay Analysis
                </div>
                <div class="tab" onclick="switchTab('audio')">
                    <i class="fas fa-headphones"></i> Listening
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="content">

            <!-- Text Generator Tab -->
<div class="tab-content" id="text-generator-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-scroll"></i> AI Text Generator</h2>
            <div class="icon">üìñ</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <p>Create texts like in manga! Choose topic, difficulty and format:</p>
        </div>
        
        <!-- Settings Form -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Left Column: Settings -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-sliders-h"></i> Generation Settings
                    </h3>
                    
                    <!-- Topic -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-pen"></i> Text Topic:
                        </label>
                        <input type="text" id="textTopic" 
                               placeholder="Example: First day at university in China" 
                               style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                    </div>
                    
                    <!-- Description -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-align-left"></i> Details/Description:
                        </label>
                        <textarea id="textDescription" 
                                  placeholder="Plot details, characters, atmosphere..." 
                                  style="width: 100%; height: 120px; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- HSK Difficulty -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-signal"></i> HSK Level:
                        </label>
                        <select id="textHskLevel" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="1">HSK 1 (Beginner, 150 words)</option>
                            <option value="2">HSK 2 (Elementary, 300 words)</option>
                            <option value="3" selected>HSK 3 (Intermediate, 600 words)</option>
                            <option value="4">HSK 4 (Advanced, 1200 words)</option>
                            <option value="5">HSK 5 (Professional, 2500 words)</option>
                            <option value="6">HSK 6 (Master, 5000+ words)</option>
                        </select>
                    </div>
                    
                    <!-- Format -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-file-alt"></i> Text Format:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                                <input type="radio" name="textFormat" value="chinese_only" checked>
                                <div>
                                    <div style="font-weight: bold;">Characters Only</div>
                                    <div style="font-size: 0.9em; color: var(--gray);">Characters + emoji üéØ</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                                <input type="radio" name="textFormat" value="full">
                                <div>
                                    <div style="font-weight: bold;">Full Format</div>
                                    <div style="font-size: 0.9em; color: var(--gray);">Characters in most complex format</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                                <input type="radio" name="textFormat" value="manga">
                                <div>
                                    <div style="font-weight: bold;">Manga Format</div>
                                    <div style="font-size: 0.9em; color: var(--gray);">Dialogues + descriptions + emoji</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Generation Button -->
                    <button id="generateTextBtn" class="btn btn-primary" onclick="generateChineseText()" 
                            style="width: 100%; padding: 15px; font-size: 1.1em;">
                        <i class="fas fa-magic"></i> Generate Text
                    </button>
                </div>
            </div>
            
            <!-- Right Column: Examples -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i> Quick Examples
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn btn-secondary" onclick="loadExample('mall')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üè¨ At the Mall</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('restaurant')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üçú At a Restaurant</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('university')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéì University</div>
                            </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('travel')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üöÜ Travel</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadExample('business')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üíº Business Meeting</div>
                        </button>
                    </div>
                    
                    <!-- Tips -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 10px; color: var(--warning);">
                            <i class="fas fa-tips"></i> Tips:
                        </h4>
                        <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                            <li>Be specific in description</li>
                            <li>Choose level matching your HSK</li>
                            <li>Use "Manga" format for dialogues</li>
                            <li>Save texts for review</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Result -->
        <div id="textResultSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-file-text"></i> Generated Text
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="copyTextToClipboard()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn btn-success" onclick="saveGeneratedText()">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button class="btn btn-warning" onclick="speakGeneratedText()">
                        <i class="fas fa-volume-up"></i> Speak
                    </button>
                    <button class="btn btn-danger" onclick="regenerateText()">
                        <i class="fas fa-redo"></i> Regenerate
                    </button>
                </div>
            </div>
            
            <div id="textResult" 
                 style="background: white; padding: 30px; border-radius: 15px; border: 2px solid var(--primary); 
                        min-height: 400px; max-height: 600px; overflow-y: auto; font-size: 16px; line-height: 1.8;">
                <!-- Text will load here -->
            </div>
            
            <!-- Statistics -->
            <div id="textStats" style="margin-top: 20px;">
                <!-- Statistics will appear here -->
            </div>
            
            <!-- History -->
            <div id="textHistory" style="margin-top: 30px;">
                <h4><i class="fas fa-history"></i> Generation History</h4>
                <div id="historyList" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    <!-- History will load here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="audio-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-podcast"></i> Chinese Podcast Generator</h2>
            <div class="icon">üéß</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Left Column: Settings -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-sliders-h"></i> Podcast Settings
                    </h3>
                    
                    <!-- Topic -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-bullseye"></i> Podcast Topic:
                        </label>
                        <input type="text" id="audioTopic" 
                               placeholder="Example: Traditional Chinese holidays" 
                               style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                    </div>
                    
                    <!-- Description -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-align-left"></i> Detailed Description:
                        </label>
                        <textarea id="audioDescription" 
                                  placeholder="Describe what should be in the podcast, style, main points..." 
                                  style="width: 100%; height: 120px; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- HSK Level -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-signal"></i> HSK Level:
                        </label>
                        <select id="audioHskLevel" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="1">HSK 1 (Very Easy)</option>
                            <option value="2">HSK 2 (Easy)</option>
                            <option value="3" selected>HSK 3 (Intermediate)</option>
                            <option value="4">HSK 4 (Advanced)</option>
                            <option value="5">HSK 5 (Hard)</option>
                            <option value="6">HSK 6 (Expert)</option>
                        </select>
                    </div>
                    
                    <!-- Difficulty -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-tachometer-alt"></i> Speech Difficulty:
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="audio-difficulty-btn active" onclick="setAudioDifficulty('easy')">Easy</button>
                            <button class="audio-difficulty-btn" onclick="setAudioDifficulty('medium')">Medium</button>
                            <button class="audio-difficulty-btn" onclick="setAudioDifficulty('hard')">Hard</button>
                        </div>
                        <input type="hidden" id="audioDifficulty" value="easy">
                    </div>
                    
                    <!-- Length -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-ruler"></i> Duration:
                        </label>
                        <select id="audioDuration" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="short">Short (1-2 minutes)</option>
                            <option value="medium" selected>Medium (3-5 minutes)</option>
                            <option value="long">Long (5-10 minutes)</option>
                        </select>
                    </div>
                    
                    <!-- Playback Settings -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-cog"></i> Playback Settings:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="includePinyin" checked>
                                <span>Include Pinyin</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="includeTranslation" checked>
                                <span>Include Translation</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Generation Button -->
                    <button id="generateAudioBtn" class="btn btn-primary" onclick="generateAudioLesson()" 
                            style="width: 100%; padding: 15px; font-size: 1.1em;">
                        <i class="fas fa-magic"></i> Generate Podcast
                    </button>
                </div>
            </div>
            
            <!-- Right Column: Examples -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i> Ready Examples
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn btn-secondary" onclick="loadAudioExample('greetings')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üëã Basic Greetings</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('food')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üçú Chinese Cuisine</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('travel')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üó∫Ô∏è Traveling in China</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('culture')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéå Traditions and Culture</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadAudioExample('business')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üíº Business Chinese</div>
                        </button>
                    </div>
                    
                    <!-- Listening Tips -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 10px; color: var(--warning);">
                            <i class="fas fa-tips"></i> Listening Tips:
                        </h4>
                        <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                            <li>Listen first without text</li>
                            <li>Repeat after the speaker</li>
                            <li>Listen in parts</li>
                            <li>Use pause for repetition</li>
                            <li>Take notes on new words</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Result -->
        <div id="audioResultSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-headphones"></i> Generated Podcast
                </h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="playAudioPodcast()" id="playAudioBtn">
                        <i class="fas fa-play"></i> Play
                    </button>
                    <button class="btn btn-secondary" onclick="pauseAudioPodcast()" id="pauseAudioBtn" style="display: none;">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button class="btn btn-warning" onclick="stopAudioPodcast()">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAudioText()">
                        <i class="fas fa-download"></i> Download Text
                    </button>
                </div>
            </div>
            
            <!-- Playback Controls -->
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill" id="audioProgress" style="width: 0%; background: var(--primary);"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em;">
                            <span id="audioCurrentTime">0:00</span>
                            <span id="audioTotalTime">0:00</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div>
                            <label style="font-size: 0.9em; margin-right: 10px;">Speed:</label>
                            <select id="audioSpeed" style="padding: 5px 10px; border-radius: 5px;" onchange="changeAudioSpeed()">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="font-size: 0.9em; margin-right: 10px;">Voice:</label>
                            <select id="audioVoice" style="padding: 5px 10px; border-radius: 5px;" onchange="changeAudioVoice()">
                                <option value="default">Default</option>
                                <!-- Voices will load dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Podcast Content -->
            <div id="audioContent" 
                 style="background: white; padding: 30px; border-radius: 15px; border: 2px solid var(--primary); 
                        max-height: 500px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Podcast text will appear here -->
            </div>
            
            <!-- Vocabulary -->
            <div id="audioVocabulary" style="display: none; margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-book"></i> New Vocabulary from Podcast
                </h4>
                <div id="vocabularyList">
                    <!-- Vocabulary will load here -->
                </div>
            </div>
            
            <!-- Comprehension Questions -->
            <div id="audioQuestions" style="display: none; margin-bottom: 20px;">
                <h4 style="color: var(--success); margin-bottom: 15px;">
                    <i class="fas fa-question-circle"></i> Comprehension Check Questions
                </h4>
                <div id="questionsList">
                    <!-- Questions will load here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="admission-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-robot"></i> AI Chinese University Search Engine</h2>
            <div class="icon">üîç</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <p><strong>How it works:</strong> AI independently searches the internet for up-to-date information on ALL Chinese universities. You simply describe your requirements.</p>
            <div class="word-tip">
                üí° <strong>Example query:</strong> "Want to apply with HSK 4 for computer science, budget 15,000 yuan per year, preferably Beijing or Shanghai"
            </div>
        </div>
        
        <!-- Query Field -->
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                <i class="fas fa-comment-alt"></i> Describe your situation:
            </label>
            <textarea id="admissionQuery" 
                      placeholder="Example: Looking for a Master's in Business with HSK 5, want a scholarship, city doesn't matter..." 
                      style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
        </div>
        
        <!-- Quick Parameters (Optional) -->
        <div style="margin-bottom: 20px;">
            <h4><i class="fas fa-sliders-h"></i> Additional Parameters:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">HSK Level:</label>
                    <select id="hskLevelFilter" style="width: 100%; padding: 8px; border-radius: 8px;">
                        <option value="">Any</option>
                        <option value="3">HSK 3</option>
                        <option value="4" selected>HSK 4</option>
                        <option value="5">HSK 5</option>
                        <option value="6">HSK 6</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Max Budget (yuan/year):</label>
                    <input type="number" id="budgetFilter" placeholder="20000" style="width: 100%; padding: 8px; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Instruction Language:</label>
                    <select id="languageFilter" style="width: 100%; padding: 8px; border-radius: 8px;">
                        <option value="">Any</option>
                        <option value="chinese">Chinese</option>
                        <option value="english">English</option>
                        <option value="both">Both</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Search Button -->
        <button id="searchUniversitiesBtn" class="btn btn-primary" onclick="searchChineseUniversities()" 
                style="width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 20px;">
            <i class="fas fa-search"></i> Find Suitable Universities
        </button>
        
        <!-- Search Results -->
        <div id="searchResults" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-list-alt"></i> Found Options
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="exportResults()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-secondary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Results Container -->
            <div id="universitiesList" style="margin-bottom: 20px;">
                <!-- AI will load results here -->
            </div>
            
            <!-- Search Status -->
            <div id="searchStatus" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
                <i class="fas fa-sync-alt fa-spin"></i> AI is searching for information on the internet...
            </div>
        </div>
        
        <!-- Example Queries -->
        <div style="margin-top: 30px;">
            <h4><i class="fas fa-bolt"></i> Quick Queries:</h4>
            <div class="button-group" style="flex-wrap: wrap; margin-top: 10px;">
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(1)">
                    üéì Engineering with HSK 4
                </button>
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(2)">
                    üí∞ Medicine Scholarships
                </button>
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(3)">
                    üèôÔ∏è Universities in Shanghai
                </button>
                <button class="btn btn-outline-primary" onclick="loadExampleQuery(4)">
                    üìö English-taught Programs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Essay Analysis Tab -->
<div class="tab-content" id="essay-analysis-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-file-alt"></i> AI Essay Analysis</h2>
            <div class="icon">üìä</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Left Column: Settings -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-sliders-h"></i> Analysis Settings
                    </h3>
                    
                    <!-- Difficulty Level -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-signal"></i> Difficulty Level:
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                            <button class="essay-difficulty-btn" onclick="setEssayDifficulty('beginner')" data-difficulty="beginner">
                                Beginner
                            </button>
                            <button class="essay-difficulty-btn active" onclick="setEssayDifficulty('intermediate')" data-difficulty="intermediate">
                                Intermediate
                            </button>
                            <button class="essay-difficulty-btn" onclick="setEssayDifficulty('advanced')" data-difficulty="advanced">
                                Advanced
                            </button>
                            <button class="essay-difficulty-btn" onclick="setEssayDifficulty('exam')" data-difficulty="exam">
                                Exam Level
                            </button>
                        </div>
                        <input type="hidden" id="essayDifficulty" value="intermediate">
                    </div>
                    
                    <!-- Essay Topic -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-bullseye"></i> Essay Topic:
                        </label>
                        <input type="text" id="essayAnalysisTopic" 
                               placeholder="Example: Chinese Culture and Traditions" 
                               style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                    </div>
                    
                    <!-- Details -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-align-left"></i> Additional Details:
                        </label>
                        <textarea id="essayAnalysisDetails" 
                                  placeholder="Specific aspects, requirements, focus..." 
                                  style="width: 100%; height: 120px; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Essay Length -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            <i class="fas fa-ruler"></i> Target Essay Length:
                        </label>
                        <select id="essayAnalysisLength" 
                                style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                            <option value="200">200-300 characters</option>
                            <option value="400" selected>400-500 characters</option>
                            <option value="600">600-700 characters</option>
                            <option value="800">800+ characters</option>
                        </select>
                    </div>
                    
                    <!-- Generation Button -->
                    <button id="generateEssayBtn" class="btn btn-primary" onclick="generateEssayAnalysis()" 
        style="width: 100%; padding: 15px; font-size: 1.1em;">
    <i class="fas fa-magic"></i> Generate Essay Task
</button>
                </div>
            </div>
            
            <!-- Right Column: Examples and Tips -->
            <div>
                <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i> Topic Examples
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn btn-secondary" onclick="loadEssayExample('culture')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéå Chinese Culture</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('technology')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üì± Technology</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('education')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üéì Education</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('environment')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üåç Ecology</div>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadEssayExample('globalization')" 
                                style="text-align: left; padding: 15px;">
                            <div style="font-weight: bold;">üåê Globalization</div>
                        </button>
                    </div>
                    
                    <!-- Grading Criteria -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 10px; color: var(--warning);">
                            <i class="fas fa-star"></i> Grading Criteria:
                        </h4>
                        <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                            <li><strong>Content (40%)</strong> - relevance to topic, arguments</li>
                            <li><strong>Grammar (30%)</strong> - correctness of structures</li>
                            <li><strong>Vocabulary (20%)</strong> - richness of vocabulary</li>
                            <li><strong>Structure (10%)</strong> - logic and organization</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Essay Writing Area -->
        <div id="essayAnalysisArea" style="display: none;">
            <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary); margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--primary);">
                        <i class="fas fa-pen"></i> Essay Writing
                        <span id="essayAnalysisTimer" class="word-level" style="margin-left: 10px;">60:00</span>
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="showEssayAnalysisHint()">
                            <i class="fas fa-question-circle"></i> Hint
                        </button>
                        <button class="btn btn-success" onclick="submitEssayForAnalysis()">
                            <i class="fas fa-check"></i> Submit for Analysis
                        </button>
                        <button class="btn btn-danger" onclick="cancelEssayAnalysis()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Task -->
                <div style="margin-bottom: 25px;">
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                        <i class="fas fa-bullseye"></i> Task:
                    </div>
                    <div id="essayAnalysisPrompt" 
                         style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); 
                                font-size: 16px; line-height: 1.6;">
                        <!-- Task will appear here -->
                    </div>
                </div>
                
                <!-- Input Field -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        <i class="fas fa-keyboard"></i> Your Essay in Chinese:
                    </label>
                    <textarea id="essayAnalysisText" 
                              placeholder="Start writing your essay here..." 
                              style="width: 100%; height: 300px; padding: 20px; border: 2px solid #dee2e6; border-radius: 10px; 
                                     font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif; resize: vertical;"
                              oninput="updateEssayAnalysisCounter()"></textarea>
                    
                    <!-- Counter -->
                    <div style="margin-top: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="essayAnalysisProgress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.9em; color: var(--gray);">
                            <span>Written: <span id="essayAnalysisCharCount">0</span> characters</span>
                            <span>Target: <span id="essayAnalysisTarget">500</span> characters</span>
                            <span>Left: <span id="essayAnalysisCharsLeft">500</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Phrases -->
                <div style="margin-top: 20px;">
                    <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 8px;">
                        <i class="fas fa-bolt"></i> Quick Essay Phrases:
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('introduction')">Introduction</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('thesis')">Thesis</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('argument')">Argument</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('example')">Example</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('contrast')">Contrast</button>
                        <button class="btn btn-sm btn-secondary" onclick="insertEssayAnalysisPhrase('conclusion')">Conclusion</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Result -->
        <div id="essayAnalysisResult" style="display: none;">
            <!-- Analysis result will appear here -->
        </div>
    </div>
</div>

            <!-- Chat Tab -->
            <div class="tab-content active" id="chat-tab">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-robot"></i> AI Tutor</h2>
                        <div class="icon">üí¨</div>
                    </div>
                    
                    <!-- Sidebar with Chats -->
                    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px;">
                        <!-- Left Column: Chat List -->
                        <div style="background: white; border-radius: 12px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 1.1em;">Chats</h3>
                                <button onclick="createNewChat()" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;">
                                    <i class="fas fa-plus"></i> New
                                </button>
                            </div>
                            
                            <div id="chatList" style="max-height: 350px; overflow-y: auto;">
                                <!-- Chat list will load via JS -->
                            </div>
                            
                            <div id="chatInfo" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; display: none;">
                                <h4 style="font-size: 0.9em; margin-bottom: 10px;">Chat Information</h4>
                                <div style="margin-bottom: 10px;">
                                    <input type="text" id="chatTitleInput" placeholder="Chat Name" 
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <select id="chatCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="general">General</option>
                                        <option value="grammar">Grammar</option>
                                        <option value="vocabulary">Vocabulary</option>
                                        <option value="test_prep">Test Preparation</option>
                                        <option value="strategy">Strategies</option>
                                    </select>
                                </div>
                                <div>
                                    <button onclick="updateCurrentChat()" class="btn btn-success" style="width: 100%; padding: 8px; font-size: 0.9em;">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button onclick="deleteCurrentChat()" class="btn btn-danger" style="width: 100%; padding: 8px; margin-top: 5px; font-size: 0.9em;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Chat -->
                        <div>
                            <div class="chat-box" id="chatBox">
                                <div class="message ai-message">
                                    <div class="ai-label">ü§ñ AI Tutor:</div>
                                    Hello! I'm your pragmatic HSK tutor. I know all the dirty life hacks and cheats for passing the exam (legal ones!).<br><br>
                                    Ask me about:<br>
                                    ‚Ä¢ üéØ Preparation strategies<br>
                                    ‚Ä¢ üïµÔ∏è‚Äç‚ôÇÔ∏è Test cheat codes<br>
                                    ‚Ä¢ ‚è∞ Time management<br>
                                    ‚Ä¢ üß† Psychological techniques<br>
                                    ‚Ä¢ üìö Specific HSK words
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <input type="text" id="messageInput" placeholder="Ask about life hacks for HSK 4...">
                                <button onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="quickQuestion('How to get into a Chinese university with low HSK?')">
                                    <i class="fas fa-university"></i> Admission with Low HSK
                                </button>
                                <button class="btn btn-secondary" onclick="quickQuestion('How to get a CIS scholarship?')">
                                    <i class="fas fa-money-bill-wave"></i> CIS Scholarship
                                </button>
                                <button class="btn btn-warning" onclick="quickQuestion('How to find connections in a Chinese university?')">
                                    <i class="fas fa-handshake"></i> University Connections
                                </button>
                                <button class="btn btn-danger" onclick="quickQuestion('Which universities are most foreigner-friendly?')">
                                    <i class="fas fa-star"></i> Friendly Universities
                                </button>
                                <button class="btn btn-success" onclick="quickQuestion('How to write a motivation letter for Tsinghua?')">
                                    <i class="fas fa-envelope"></i> Motivation Letter
                                </button>
                                <button class="btn btn-primary" onclick="quickQuestion('How to prepare for HSK 4 quickly?')">
                                    <i class="fas fa-bolt"></i> Quick Preparation
                                </button>
                                <button class="btn btn-secondary" onclick="quickQuestion('Which words to learn first?')">
                                    <i class="fas fa-star"></i> Priority Words
                                </button>
                                <button class="btn btn-warning" onclick="quickQuestion('How to guess answers on tests?')">
                                    <i class="fas fa-user-secret"></i> Cheat Codes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grammar Tab -->
<div class="tab-content" id="grammar-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-language"></i> AI Grammar Dictionary</h2>
            <div class="icon">üìö</div>
        </div>
        
        <!-- Filters -->
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                <select id="grammarLevelFilter" onchange="filterGrammarTopics()" 
        style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;">
    <option value="">All Levels</option>
    <option value="Âàù">Beginner (Âàù)</option>
    <option value="‰∏≠">Intermediate (‰∏≠)</option>
    <option value="È´ò">Advanced (È´ò)</option>
</select>
                
                <select id="grammarCategoryFilter" onchange="filterGrammarTopics()" style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <option value="">All Categories</option>
                    <!-- Categories will load via JS -->
                </select>
                
                <select id="grammarSort" onchange="filterGrammarTopics()" style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <option value="complexity">By Complexity</option>
                    <option value="level">By Level</option>
                    <option value="name">By Name</option>
                </select>
                
                <button class="btn btn-secondary" onclick="loadGrammarStats()">
                    <i class="fas fa-chart-bar"></i> Statistics
                </button>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <input type="text" id="grammarSearch" placeholder="Search grammar..." 
                       style="flex: 1; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px;"
                       oninput="searchGrammarTopics()">
            </div>
        </div>
        
        <!-- Topics List and Details -->
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; min-height: 500px;">
            <!-- Left Column: Topics List -->
            <div style="border-right: 1px solid #dee2e6; padding-right: 20px;">
                <h3 style="margin-bottom: 15px; color: var(--primary);">
                    <i class="fas fa-list"></i> Grammar Topics
                    <span id="grammarCount" class="word-level" style="font-size: 0.8em; margin-left: 10px;">0</span>
                </h3>
                
                <div id="grammarTopicsList" style="max-height: 450px; overflow-y: auto;">
                    <!-- Topics list will load via JS -->
                </div>
                
                <div id="grammarStats" style="margin-top: 20px; display: none;">
                    <!-- Statistics will load via JS -->
                </div>
            </div>
            
            <!-- Right Column: Topic Details -->
            <div>
                <div id="grammarTopicDetails" style="min-height: 450px;">
                    <div style="text-align: center; color: var(--gray); padding: 50px 0;">
                        <div style="font-size: 3em;">üìñ</div>
                        <h3>Select a Grammar Topic</h3>
                        <p>Click on a topic on the left to see AI explanation</p>
                    </div>
                </div>
                
                <!-- Exercises (Appear after selecting a topic) -->
                <div id="grammarExercises" style="margin-top: 20px; display: none;">
                    <!-- Exercises will load via JS -->
                </div>
            </div>
        </div>
        
        <!-- Study History (for authorized users) -->
        <div id="grammarHistory" style="margin-top: 30px; display: none;">
            <h3><i class="fas fa-history"></i> Study History</h3>
            <div id="grammarHistoryContent" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                <!-- History will load via JS -->
            </div>
        </div>
    </div>
</div>

            <!-- AI Translator Tab -->
<div class="tab-content" id="translator-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-language"></i> Smart AI Translator</h2>
            <div class="icon">üß†</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column: Input -->
            <div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        <i class="fas fa-keyboard"></i> Enter text in Chinese:
                    </label>
                    <textarea id="translateInput" 
                              placeholder="Enter Chinese text for smart translation..."
                              style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        <i class="fas fa-sliders-h"></i> Settings:
                    </label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="analyzePronunciation">
                            Pronunciation analysis
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="smartTranslate()" style="width: 100%; padding: 12px;">
                    <i class="fas fa-brain"></i> Smart Translate
                </button>
                
                <!-- Quick Examples -->
                <div style="margin-top: 20px;">
                    <p style="margin-bottom: 10px; color: var(--gray);">
                        <i class="fas fa-bolt"></i> Quick Examples:
                    </p>
                    <div class="button-group" style="flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="quickTranslate('ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá')" style="font-size: 0.9em;">
                            ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá
                        </button>
                        <button class="btn btn-secondary" onclick="quickTranslate('‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω')" style="font-size: 0.9em;">
                            ‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω
                        </button>
                        <button class="btn btn-secondary" onclick="quickTranslate('‰∏≠ÂõΩËèúÂæàÂ•ΩÂêÉ')" style="font-size: 0.9em;">
                            ‰∏≠ÂõΩËèúÂæàÂ•ΩÂêÉ
                        </button>
                        <button class="btn btn-secondary" onclick="quickTranslate('ÊàëÊÉ≥Âéª‰∏≠ÂõΩÊóÖË°å')" style="font-size: 0.9em;">
                            ÊàëÊÉ≥Âéª‰∏≠ÂõΩÊóÖË°å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Result -->
            <div>
                <div id="translationResult" style="height: 400px; overflow-y: auto; padding: 20px; background: white; border-radius: 10px; border: 1px solid #dee2e6;">
                    <!-- Result will appear here -->
                    <div style="text-align: center; color: var(--gray); padding: 50px 0;">
                        <div style="font-size: 3em;">ü§ñ</div>
                        <p>Translation result will appear here</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Extended Information -->
        <div id="translationDetails" style="margin-top: 20px; display: none;">
            <!-- Details will load via JS -->
        </div>
    </div>
</div>
            
            <!-- Words Tab - EXTENDED VERSION -->
<div class="tab-content" id="words-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-book"></i> Word Management</h2>
            <div class="icon">üìö</div>
        </div>
        
        <!-- Filters and Search -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="wordsSearch" placeholder="üîç Search by translation..." 
                   style="flex: 1; min-width: 250px;" onkeyup="searchWords()">
            <select id="wordsLevelFilter" onchange="filterWords()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="all">All levels</option>
                <option value="1">HSK 1</option>
                <option value="2">HSK 2</option>
                <option value="3">HSK 3</option>
                <option value="4">HSK 4</option>
                <option value="5">HSK 5</option>
                <option value="6">HSK 6</option>
            </select>
            <select id="wordsStatusFilter" onchange="filterWords()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="all">All words</option>
                <option value="saved">Only problematic</option>
                <option value="learned">Only learned</option>
                <option value="new">Only new</option>
            </select>
            <button class="btn btn-primary" onclick="loadRandomWords()">
                <i class="fas fa-random"></i> Random
            </button>
        </div>
        
        <!-- Statistics -->
        <div id="wordsStats" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);" id="totalWordsCount">0</div>
                    <div style="font-size: 0.9em; color: var(--gray);">Total words</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);" id="learnedWordsCount">0</div>
                    <div style="font-size: 0.9em; color: var(--gray);">Learned</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);" id="savedWordsCount">0</div>
                    <div style="font-size: 0.9em; color: var(--gray);">Problematic</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--info);" id="progressPercentage">0%</div>
                    <div style="font-size: 0.9em; color: var(--gray);">Progress</div>
                </div>
            </div>
        </div>
        
        <!-- Words Container -->
        <div class="words-container" id="wordsList">
            <!-- Words will load via JS -->
        </div>
        
        <!-- Pagination -->
        <div style="display: flex; justify-content: center; margin-top: 20px; gap: 10px;">
            <button class="btn btn-secondary" onclick="changeWordsPage(-1)" id="prevPageBtn" disabled>
                <i class="fas fa-chevron-left"></i> Back
            </button>
            <span style="padding: 10px; color: var(--gray);" id="pageInfo">Page 1</span>
            <button class="btn btn-secondary" onclick="changeWordsPage(1)" id="nextPageBtn" disabled>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Testing Buttons -->
        <div class="button-group" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
            <h3><i class="fas fa-graduation-cap"></i> Word Testing</h3>
            <p style="color: var(--gray); margin-bottom: 15px;">Select words for test and task type:</p>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <select id="testSource" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex: 1;">
                    <option value="all">All words</option>
                    <option value="saved">Only problematic</option>
                    <option value="learned">Only learned</option>
                    <option value="new">Only new</option>
                </select>
                <select id="testType" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex: 1;">
                    <option value="pinyin_from_char">Pinyin ‚Üí Characters</option>
                    <option value="char_from_pinyin">Characters ‚Üí Pinyin</option>
                    <option value="translation_from_char">Characters ‚Üí Translation</option>
                    <option value="translation_from_pinyin">Pinyin ‚Üí Translation</option>
                </select>
                <input type="number" id="testCount" placeholder="Number of words" min="5" max="50" value="10" 
                       style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 120px;">
            </div>
            
            <button class="btn btn-primary" onclick="startWordsTest()" style="margin-right: 10px;">
                <i class="fas fa-play"></i> Start Test
            </button>
            <button class="btn btn-success" onclick="startReviewTest()">
                <i class="fas fa-redo"></i> Review Learned
            </button>
        </div>
    </div>
</div>
            
            <!-- Test Tab -->
            <div class="tab-content" id="test-tab">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-graduation-cap"></i> Testing</h2>
                        <div class="icon">üß™</div>
                    </div>
                    
                    <div id="testContainer">
                        <div class="test-intro">
                            <p>Select HSK level for testing:</p>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="startTest(1)">HSK 1</button>
                                <button class="btn btn-primary" onclick="startTest(2)">HSK 2</button>
                                <button class="btn btn-primary" onclick="startTest(3)">HSK 3</button>
                                <button class="btn btn-warning" onclick="startTest(4)">HSK 4</button>
                                <button class="btn btn-warning" onclick="startTest(5)">HSK 5</button>
                                <button class="btn btn-danger" onclick="startTest(6)">HSK 6</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Tab -->
            <div class="tab-content" id="progress-tab">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-line"></i> Learning Progress</h2>
                        <div class="icon">üìà</div>
                    </div>
                    
                    <div id="progressContent">
                        <!-- Content will load via JS -->
                    </div>
                </div>
            </div>
            <!-- Admission Tab -->
<!-- Voice Chat Tab -->
<div class="tab-content" id="voice-chat-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-microphone-alt"></i> Voice AI Chat</h2>
            <div class="icon">üé§</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <!-- Left Column: Chat -->
            <div>
                <div class="chat-box" id="voiceChatBox" style="height: 300px; margin-bottom: 15px;">
                    <!-- Messages will be here -->
                </div>
                
                <!-- Voice Control -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button id="startVoiceBtn" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">
                        <i class="fas fa-microphone"></i> Start Speaking
                    </button>
                    <button id="stopVoiceBtn" class="btn btn-danger" style="padding: 15px 30px; font-size: 1.2em; display: none;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button id="clearVoiceBtn" class="btn btn-secondary" style="margin-left: 10px;">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                
                <!-- Recording Status -->
                <div id="voiceStatus" style="text-align: center; margin-bottom: 20px;">
                    <div id="recordingIndicator" style="display: none;">
                        <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border-width: 2px;"></div>
                        <span style="color: var(--danger); margin-left: 10px;">Recording...</span>
                    </div>
                    <div id="recordingLevel" style="display: none; margin-top: 10px;">
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill" style="width: 0%; background: var(--danger);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Commands -->
                <div>
                    <h4><i class="fas fa-bolt"></i> Quick Commands:</h4>
                    <div class="button-group" style="flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('Tell me a chengyu')" style="font-size: 0.9em;">
                            ÊàêËØ≠
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('Explain the meaning')" style="font-size: 0.9em;">
                            Ëß£Èáä
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('Give an example')" style="font-size: 0.9em;">
                            ‰æãÂ≠ê
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('Next chengyu')" style="font-size: 0.9em;">
                            ‰∏ã‰∏Ä‰∏™
                        </button>
                        <button class="btn btn-secondary" onclick="sendQuickVoiceCommand('Translate to Russian')" style="font-size: 0.9em;">
                            ÁøªËØë
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Chengyu List -->
            <!-- Right Column -->
<div>
    <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
        <!-- Card 1: Chengyu -->
        <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #dee2e6; flex: 1;">
            <h3 style="margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-graduation-cap"></i> Â∑≤Â≠¶ÊàêËØ≠
            </h3>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="chengyuSearch" placeholder="Search chengyu..." 
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;"
                       oninput="searchChengyu()">
            </div>
            
            <div id="chengyuStats" style="margin-bottom: 15px; font-size: 0.9em; color: var(--gray);">
                Learned: <span id="chengyuCount">0</span> chengyu
            </div>
            
            <div id="chengyuList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                <div style="text-align: center; color: var(--gray); padding: 20px;">
                    <div style="font-size: 2em;">üìö</div>
                    <p>Start conversation with AI</p>
                    <p>Chengyu will appear here</p>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-warning" onclick="generateChengyuQuiz()" style="width: 100%;">
                    <i class="fas fa-question-circle"></i> Chengyu Test
                </button>
            </div>
        </div>
        
        <!-- Card 2: Dialogue History -->
        <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #dee2e6; flex: 1;">
            <h3 style="margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-history"></i> Dialogue History
            </h3>
            
            <div id="voiceSessionsList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                <div style="text-align: center; color: var(--gray); padding: 20px;">
                    <div style="font-size: 2em;">üìÅ</div>
                    <p>Dialogue history will be displayed here</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="createNewVoiceSession()" style="flex: 1;">
                    <i class="fas fa-plus"></i> New Dialogue
                </button>
                <button class="btn btn-secondary" onclick="exportVoiceHistory()" style="flex: 1;">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('importHistory').click()" style="flex: 1;">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
            
            <input type="file" id="importHistory" accept=".json" style="display: none;" onchange="importVoiceHistory(event)">
        </div>
    </div>
</div>
            </div>
        </div>
        
        <!-- Settings -->
        <div style="margin-top: 30px;">
            <h4><i class="fas fa-cog"></i> Voice Chat Settings:</h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="autoPlayAudio" checked>
                    Auto-play AI responses
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="saveChengyu" checked>
                    Save learned chengyu
                </label>
            </div>
            
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">AI Voice Speed:</label>
                <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1" 
                       style="width: 200px;" onchange="updateVoiceSpeed()">
                <span id="speedValue" style="margin-left: 10px;">1.0x</span>
            </div>
        </div>
    </div>
</div>
<!-- Essay and Translation Check Tab -->
<div class="tab-content" id="essay-checker-tab">
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-check-double"></i> AI Essay and Translation Check</h2>
            <div class="icon">üìù</div>
        </div>
        
        <!-- Content for Essay Mode -->
        <div id="essayModeContent" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- Left Column: Settings and Input -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-sliders-h"></i> Check Settings
                        </h3>
                        
                        <!-- Topic Selection -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-bullseye"></i> Select essay topic:
                            </label>
                            <select id="essayTopic" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;"
                                    onchange="updateEssayRequirements()">
                                <option value="">-- Select topic --</option>
                                <option value="modern_tech">üì± Modern technology and society</option>
                                <option value="environment">üåç Environmental protection</option>
                                <option value="education">üéì Education system</option>
                                <option value="culture">üéå Chinese culture and traditions</option>
                                <option value="travel">‚úàÔ∏è Travel and tourism</option>
                                <option value="food">üçú Chinese cuisine</option>
                                <option value="business">üíº Business and economy</option>
                                <option value="family">üë™ Family and society</option>
                                <option value="health">üí™ Healthy lifestyle</option>
                                <option value="custom">‚úèÔ∏è Custom topic...</option>
                            </select>
                            
                            <!-- Field for custom topic -->
                            <div id="customTopicDiv" style="margin-top: 10px; display: none;">
                                <input type="text" id="customTopic" 
                                       placeholder="Enter your topic..." 
                                       style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                            </div>
                        </div>
                        
                        <!-- Requirements -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-clipboard-check"></i> Requirements:
                            </label>
                            <div id="essayRequirements" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 14px; color: var(--gray);">
                                Select a topic to see requirements
                            </div>
                        </div>
                        
                        <!-- HSK Level -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-signal"></i> Target HSK Level:
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="essay-hsk-btn" onclick="setEssayHskLevel(3)" data-level="3">HSK 3</button>
                                <button class="essay-hsk-btn active" onclick="setEssayHskLevel(4)" data-level="4">HSK 4</button>
                                <button class="essay-hsk-btn" onclick="setEssayHskLevel(5)" data-level="5">HSK 5</button>
                                <button class="essay-hsk-btn" onclick="setEssayHskLevel(6)" data-level="6">HSK 6</button>
                            </div>
                            <input type="hidden" id="essayHskLevel" value="4">
                        </div>
                        
                        <!-- Length -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-ruler"></i> Minimum length:
                            </label>
                            <select id="essayMinLength" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="150">150 characters (minimum)</option>
                                <option value="300" selected>300 characters (recommended)</option>
                                <option value="500">500 characters (advanced)</option>
                                <option value="800">800+ characters (exam level)</option>
                            </select>
                        </div>
                        
                        <!-- Time -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-clock"></i> Time limit:
                            </label>
                            <select id="essayTimeLimit" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="0">No limit</option>
                                <option value="30" selected>30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">60 minutes (like on HSK)</option>
                            </select>
                        </div>
                        
                        <!-- Start Button -->
                        <button id="startEssayBtn" class="btn btn-primary" onclick="startEssayWriting()" 
                                style="width: 100%; padding: 15px; font-size: 1.1em;">
                            <i class="fas fa-play"></i> Start Writing Essay
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Examples and Tips -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-lightbulb"></i> Essay Tips
                        </h3>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 10px; color: var(--warning);">
                                <i class="fas fa-star"></i> Grading Criteria:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray);">
                                <li><strong>Grammar:</strong> correctness of structures</li>
                                <li><strong>Vocabulary:</strong> richness of vocabulary</li>
                                <li><strong>Structure:</strong> logic and organization</li>
                                <li><strong>Content:</strong> relevance to topic</li>
                                <li><strong>Style:</strong> appropriateness and variety</li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 10px; color: var(--success);">
                                <i class="fas fa-tips"></i> Writing Tips:
                            </h4>
                            <ol style="padding-left: 20px; color: var(--gray);">
                                <li>First make an outline</li>
                                <li>Use complex sentences</li>
                                <li>Include introductory words</li>
                                <li>Check tenses and particles</li>
                                <li>Pay attention to word order</li>
                            </ol>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 10px; color: var(--danger);">
                                <i class="fas fa-exclamation-triangle"></i> Common Mistakes:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                                <li>Incorrect use of ‰∫Ü</li>
                                <li>Confusion between ÁöÑ„ÄÅÂú∞„ÄÅÂæó</li>
                                <li>Incorrect word order</li>
                                <li>Repetition of the same words</li>
                                <li>Lack of connecting elements</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Essay Writing Area (appears after start) -->
            <div id="essayWritingArea" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-pen"></i> Essay Writing
                            <span id="essayTimer" class="word-level" style="margin-left: 10px;">30:00</span>
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="showEssayHint()">
                                <i class="fas fa-question-circle"></i> Hint
                            </button>
                            <button class="btn btn-success" onclick="submitEssayForCheck()">
                                <i class="fas fa-check"></i> Submit for Check
                            </button>
                            <button class="btn btn-danger" onclick="cancelEssayWriting()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: var(--primary);" id="currentEssayTopic">
                                Topic: ...
                            </div>
                            <div style="font-size: 0.9em; color: var(--gray);">
                                Minimum: <span id="minChars">300</span> characters
                            </div>
                        </div>
                        <div id="essayPrompt" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <!-- Task will appear here -->
                        </div>
                    </div>
                    
                    <!-- Character Counter -->
                    <div style="margin-bottom: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="essayProgress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.9em; color: var(--gray);">
                            <span>Written: <span id="charCount">0</span> characters</span>
                            <span>Left: <span id="charsLeft">300</span></span>
                        </div>
                    </div>
                    
                    <!-- Input Field -->
                    <textarea id="essayText" 
                              placeholder="Start writing your essay here..." 
                              style="width: 100%; height: 300px; padding: 20px; border: 2px solid #dee2e6; border-radius: 10px; 
                                     font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif; resize: vertical;"
                              oninput="updateEssayCounter()"></textarea>
                    
                    <!-- Quick Phrases -->
                    <div style="margin-top: 15px;">
                        <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">
                            <i class="fas fa-bolt"></i> Quick Essay Phrases:
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('intro')">Introduction</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('opinion')">Opinion</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('example')">Example</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('conclusion')">Conclusion</button>
                            <button class="btn btn-sm btn-secondary" onclick="insertEssayPhrase('connector')">Connector</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Check Result -->
            <div id="essayResultSection" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-chart-line"></i> Check Result
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="retryEssay()">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                            <button class="btn btn-success" onclick="saveEssayResult()">
                                <i class="fas fa-download"></i> Save Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overall Score -->
                    <div id="essayOverallScore" style="text-align: center; margin-bottom: 30px;">
                        <!-- Overall score will appear here -->
                    </div>
                    
                    <!-- Detailed Analysis -->
                    <div id="essayDetailedAnalysis">
                        <!-- Detailed analysis will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content for Translation Mode -->
        <div id="translationModeContent" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- Left Column: Settings -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-sliders-h"></i> Translation Settings
                        </h3>
                        
                        <!-- Text Topic Selection -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-bullseye"></i> Text topic for translation:
                            </label>
                            <select id="translationTopic" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;"
                                    onchange="updateTranslationExample()">
                                <option value="">-- Select topic --</option>
                                <option value="news">üì∞ News article</option>
                                <option value="story">üìñ Short story</option>
                                <option value="dialogue">üí¨ Dialogue</option>
                                <option value="description">üèûÔ∏è Place description</option>
                                <option value="instruction">üìã Instruction</option>
                                <option value="review">‚≠ê Product review</option>
                                <option value="email">üìß Business email</option>
                                <option value="advertisement">üì¢ Advertisement text</option>
                                <option value="custom_trans">‚úèÔ∏è Custom text...</option>
                            </select>
                        </div>
                        
                        <!-- Difficulty Level -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-signal"></i> Text difficulty:
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="trans-difficulty-btn" onclick="setTranslationDifficulty('easy')" data-difficulty="easy">Easy</button>
                                <button class="trans-difficulty-btn active" onclick="setTranslationDifficulty('medium')" data-difficulty="medium">Medium</button>
                                <button class="trans-difficulty-btn" onclick="setTranslationDifficulty('hard')" data-difficulty="hard">Hard</button>
                                <button class="trans-difficulty-btn" onclick="setTranslationDifficulty('expert')" data-difficulty="expert">Expert</button>
                            </div>
                            <input type="hidden" id="translationDifficulty" value="medium">
                        </div>
                        
                        <!-- Text Length -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-ruler"></i> Text length:
                            </label>
                            <select id="translationLength" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="short">Short (3-5 sentences)</option>
                                <option value="medium" selected>Medium (6-10 sentences)</option>
                                <option value="long">Long (10-15 sentences)</option>
                            </select>
                        </div>
                        
                        <!-- HSK Level -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                <i class="fas fa-graduation-cap"></i> Your HSK Level:
                            </label>
                            <select id="translationHskLevel" 
                                    style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px;">
                                <option value="3">HSK 3</option>
                                <option value="4" selected>HSK 4</option>
                                <option value="5">HSK 5</option>
                                <option value="6">HSK 6</option>
                            </select>
                        </div>
                        
                        <!-- Text Generation Button -->
                        <button id="generateTranslationTextBtn" class="btn btn-primary" onclick="generateTranslationText()" 
                                style="width: 100%; padding: 15px; font-size: 1.1em;">
                            <i class="fas fa-magic"></i> Generate Text for Translation
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Examples -->
                <div>
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 1px solid #dee2e6; height: 100%;">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">
                            <i class="fas fa-eye"></i> Translation Text Example
                        </h3>
                        
                        <div id="translationExample" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; 
                                                           min-height: 150px; font-style: italic; color: var(--gray);">
                            Select a topic to see an example...
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 10px; color: var(--warning);">
                                <i class="fas fa-star"></i> Translation Grading Criteria:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                                <li><strong>Accuracy:</strong> correctness of translation</li>
                                <li><strong>Naturalness:</strong> sounds like native language</li>
                                <li><strong>Grammar:</strong> correct constructions</li>
                                <li><strong>Vocabulary:</strong> appropriateness of words</li>
                                <li><strong>Style:</strong> preservation of original style</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 10px; color: var(--success);">
                                <i class="fas fa-tips"></i> Translation Tips:
                            </h4>
                            <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9em;">
                                <li>Translate meaning, not words</li>
                                <li>Consider cultural peculiarities</li>
                                <li>Use Chinese equivalents of idioms</li>
                                <li>Check word order</li>
                                <li>Pay attention to particles</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Translation Area (appears after text generation) -->
            <div id="translationArea" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-language"></i> Text Translation
                            <span id="translationTimer" class="word-level" style="margin-left: 10px;">25:00</span>
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="submitTranslationForCheck()">
                                <i class="fas fa-check"></i> Submit for Check
                            </button>
                            <button class="btn btn-danger" onclick="cancelTranslation()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Original Text -->
                    <div style="margin-bottom: 25px;">
                        <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                            <i class="fas fa-file-alt"></i> Original Text (Russian):
                        </div>
                        <div id="originalTranslationText" 
                             style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); 
                                    font-size: 16px; line-height: 1.6;">
                            <!-- Translation text will appear here -->
                        </div>
                    </div>
                    
                    <!-- Translation Field -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: var(--success); margin-bottom: 10px;">
                            <i class="fas fa-pen"></i> Your translation into Chinese:
                        </div>
                        <textarea id="translationText" 
                                  placeholder="Enter your translation here..." 
                                  style="width: 100%; height: 250px; padding: 20px; border: 2px solid #dee2e6; border-radius: 10px; 
                                         font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif; resize: vertical;"
                                  oninput="updateTranslationCounter()"></textarea>
                        
                        <!-- Counter -->
                        <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray); text-align: right;">
                            Characters: <span id="transCharCount">0</span>
                        </div>
                    </div>
            
            <!-- Translation Check Result -->
            <div id="translationResultSection" style="display: none; margin-top: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">
                            <i class="fas fa-chart-line"></i> Translation Check Result
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="retryTranslation()">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                            <button class="btn btn-success" onclick="saveTranslationResult()">
                                <i class="fas fa-download"></i> Save Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overall Score -->
                    <div id="translationOverallScore" style="text-align: center; margin-bottom: 30px;">
                        <!-- Overall score will appear here -->
                    </div>
                    
                    <!-- Comparison -->
                    <div id="translationComparison" style="margin-bottom: 30px;">
                        <!-- Comparison will appear here -->
                    </div>
                    
                    <!-- Detailed Analysis -->
                    <div id="translationDetailedAnalysis">
                        <!-- Detailed analysis will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        
        <!-- Footer -->
        <div class="footer">
            <h3>üîó Quick API Links</h3>
            <div class="api-links">
                <a href="https://saiyan-3s8s.onrender.com/docs" target="_blank">
                    <i class="fas fa-book"></i> Documentation
                </a>
                <a href="https://saiyan-3s8s.onrender.com/stats" target="_blank">
                    <i class="fas fa-chart-bar"></i> Statistics
                </a>
                <a href="https://saiyan-3s8s.onrender.com/test/1" target="_blank">
                    <i class="fas fa-file-alt"></i> HSK 1 Test
                </a>
                <a href="https://saiyan-3s8s.onrender.com/word/random" target="_blank">
                    <i class="fas fa-dice"></i> Random Word
                </a>
                <a href="https://saiyan-3s8s.onrender.com/words/level/3" target="_blank">
                    <i class="fas fa-list"></i> HSK 3 Words
                </a>
                <a href="https://saiyan-3s8s.onrender.com/search/Áà±" target="_blank">
                    <i class="fas fa-search"></i> Word Search
                </a>
            </div>
            <p style="margin-top: 20px; opacity: 0.8;">
                üéå HSK AI Tutor v1.0 | 5462 words in database | Pragmatic learning
            </p>
        </div>
    </div>

    <!-- Login Modal -->
<div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;">
        <h3 style="margin-bottom: 20px; color: var(--primary);">
            <i class="fas fa-sign-in-alt"></i> Log In to Account
        </h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
            <input type="email" id="loginEmail" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
            <input type="password" id="loginPassword" placeholder="password" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
            <i class="fas fa-sign-in-alt"></i> Log In
        </button>
        
        <button onclick="hideLoginForm()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
            <i class="fas fa-times"></i> Cancel
        </button>
        
        <p style="margin-top: 15px; text-align: center;">
            Don't have an account? <a href="#" onclick="showRegisterFormFull()" style="color: var(--primary);">Register</a>
        </p>
    </div>
</div>

<!-- Registration Modal -->
<div id="registerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px; color: var(--primary);">
            <i class="fas fa-user-plus"></i> Registration
        </h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Name:</label>
            <input type="text" id="regNameFull" placeholder="Your name" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
            <input type="email" id="regEmail" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
            <input type="password" id="regPassword" placeholder="at least 6 characters" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Current HSK Level:</label>
            <select id="regCurrentLevelFull" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                <option value="1">HSK 1 (beginner)</option>
                <option value="2">HSK 2 (basic)</option>
                <option value="3">HSK 3 (intermediate)</option>
                <option value="4" selected>HSK 4 (advanced)</option>
                <option value="5">HSK 5 (professional)</option>
                <option value="6">HSK 6 (master)</option>
            </select>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Level:</label>
            <select id="regTargetLevelFull" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                <option value="2">HSK 2</option>
                <option value="3">HSK 3</option>
                <option value="4" selected>HSK 4</option>
                <option value="5">HSK 5</option>
                <option value="6">HSK 6</option>
            </select>
        </div>
        
        <button onclick="registerFull()" class="btn btn-success" style="width: 100%;">
            <i class="fas fa-check"></i> Register
        </button>
        
        <button onclick="hideRegisterForm()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
            <i class="fas fa-times"></i> Cancel
        </button>
        
        <p style="margin-top: 15px; text-align: center;">
            Already have an account? <a href="#" onclick="showLoginForm()" style="color: var(--primary);">Log In</a>
        </p>
    </div>
</div>

    <script>
        const API_BASE = 'https://saiyan-3s8s.onrender.com';
        let currentTest = null;
        let currentFilter = 'all';  // –∏–ª–∏ let currentSearchQuery = '';
let currentSearchQuery = '';

        // Global variables for essay analysis
let currentEssayAnalysisData = null;
let essayAnalysisTimer = null;
let essayAnalysisTimeLeft = 0;

// Add to global variables
let currentAudioLesson = null;
let audioUtterance = null;
let isAudioPlaying = false;
let audioHistory = [];

// Initialize listening tab
function initAudioTab() {
    
    // Load available voices
    loadAvailableVoices();
    
    // Set default difficulty
    setAudioDifficulty('easy');
}

// Set difficulty
function setAudioDifficulty(difficulty) {
    // Reset active buttons
    document.querySelectorAll('.audio-difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Activate selected button
    const activeBtn = document.querySelector(`.audio-difficulty-btn:nth-child(${difficulty === 'easy' ? 1 : difficulty === 'medium' ? 2 : 3})`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('audioDifficulty').value = difficulty;
}

// Load example
function loadAudioExample(type) {
    const examples = {
        'greetings': {
            topic: "Basic Greetings and Introduction",
            description: "Simple dialogues for meeting, greeting and saying goodbye in Chinese."
        },
        'food': {
            topic: "Chinese Cuisine and Restaurants",
            description: "Conversation about food, ordering at a restaurant, describing dishes and tastes."
        },
        'travel': {
            topic: "Traveling in China",
            description: "Dialogues at the airport, hotel, taxi, attractions."
        },
        'culture': {
            topic: "Chinese Traditions and Holidays",
            description: "About Chinese culture, holidays, customs and etiquette."
        },
        'business': {
            topic: "Business Chinese",
            description: "Business meetings, negotiations, presentations at work."
        }
    };
    
    if (examples[type]) {
        document.getElementById('audioTopic').value = examples[type].topic;
        document.getElementById('audioDescription').value = examples[type].description;
    }
}

async function generateAudioLesson() {
    const topic = document.getElementById('audioTopic').value.trim();
    const description = document.getElementById('audioDescription').value.trim();
    const hskLevel = parseInt(document.getElementById('audioHskLevel').value);
    const difficulty = document.getElementById('audioDifficulty').value;
    const duration = document.getElementById('audioDuration').value;
    const includePinyin = document.getElementById('includePinyin').checked;
    const includeTranslation = document.getElementById('includeTranslation').checked;
    
    if (!topic) {
        alert('Enter podcast topic!');
        return;
    }
    
    // Show loading
    const generateBtn = document.getElementById('generateAudioBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating podcast...';
    generateBtn.disabled = true;
    
    try {
        const requestData = {
            topic: topic,
            description: description || "",
            difficulty: difficulty,
            hsk_level: hskLevel,
            target_length: duration,
            include_pinyin: includePinyin,
            include_translation: includeTranslation
        };
        
        console.log("Sending request for audio lesson generation:", requestData);
        
        const response = await fetch(`${API_BASE}/audio/generate-lesson`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            
            // Try with user_id if exists
            if (currentUser?.user_id) {
                console.log("Trying with user_id...");
                requestData.user_id = currentUser.user_id;
                
                const retryResponse = await fetch(`${API_BASE}/audio/generate-lesson`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (retryResponse.ok) {
                    const result = await retryResponse.json();
                    console.log("Received audio lesson result:", result);
                    
                    // Save current lesson
                    currentAudioLesson = result;
                    
                    // Display result
                    displayAudioLesson(result);
                    
                    showNotification('‚úÖ Podcast generated! Click "Play" to listen.');
                    return;
                }
            }
            
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log("Received audio lesson result:", result);
        
        // Save current lesson
        currentAudioLesson = result;
        
        // Display result
        displayAudioLesson(result);
        
        showNotification('‚úÖ Podcast generated! Click "Play" to listen.');
        
    } catch (error) {
        console.error('Audio lesson generation error:', error);
        showNotification('‚ùå Podcast generation error');
        
        // Show fallback lesson
        showFallbackAudioLesson(topic, hskLevel, difficulty, duration);
        
    } finally {
        // Restore button
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Display audio lesson
function displayAudioLesson(lesson) {
    const resultSection = document.getElementById('audioResultSection');
    const contentDiv = document.getElementById('audioContent');
    const vocabularyDiv = document.getElementById('audioVocabulary');
    const questionsDiv = document.getElementById('audioQuestions');
    
    // Show result section
    resultSection.style.display = 'block';
    
    // Display content
    let contentHTML = `
        <h3 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-headphones"></i> ${lesson.title}
        </h3>
        <div style="color: var(--gray); margin-bottom: 20px;">
            <span class="word-level" style="margin-right: 10px;">HSK ${lesson.hsk_level}</span>
            <span class="word-level" style="background: ${getDifficultyColor(lesson.difficulty)};">
                ${lesson.difficulty}
            </span>
            <span style="margin-left: 10px; font-size: 0.9em;">
                ${Math.floor(lesson.estimated_duration / 60)}:${(lesson.estimated_duration % 60).toString().padStart(2, '0')}
            </span>
        </div>
        
        <div class="podcast-text">
            ${lesson.chinese_text.replace(/\n/g, '<br>')}
        </div>
    `;
    
    // Add pinyin if exists
    if (lesson.pinyin_text) {
        contentHTML += `
            <div class="podcast-pinyin">
                ${lesson.pinyin_text.replace(/\n/g, '<br>')}
            </div>
        `;
    }
    
    // Add translation if exists
    if (lesson.translation) {
        contentHTML += `
            <div class="podcast-translation">
                <strong>Translation:</strong><br>
                ${lesson.translation.replace(/\n/g, '<br>')}
            </div>
        `;
    }
    
    contentDiv.innerHTML = contentHTML;
    
    // Display vocabulary if exists
    if (lesson.vocabulary && lesson.vocabulary.length > 0) {
        vocabularyDiv.style.display = 'block';
        
        const vocabularyHTML = lesson.vocabulary.map(word => `
            <div class="vocabulary-item">
                <div class="vocabulary-chinese">${word.chinese}</div>
                <div class="vocabulary-details">
                    <div class="vocabulary-pinyin">${word.pinyin}</div>
                    <div class="vocabulary-meaning">${word.translation}</div>
                    ${word.example ? `<div class="vocabulary-example">${word.example}</div>` : ''}
                </div>
                <button class="vocabulary-speak" onclick="speakWord('${word.chinese}')" title="Pronounce">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        `).join('');
        
        document.getElementById('vocabularyList').innerHTML = vocabularyHTML;
    } else {
        vocabularyDiv.style.display = 'none';
    }
    
    // Display questions if exists
    if (lesson.comprehension_questions && lesson.comprehension_questions.length > 0) {
        questionsDiv.style.display = 'block';
        
        const questionsHTML = lesson.comprehension_questions.map((q, index) => `
            <div class="test-question" style="margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px;">
                    ${index + 1}. ${q.question}
                </div>
                <div class="test-options">
                    ${q.options.map((opt, optIndex) => `
                        <div class="test-option" onclick="checkComprehensionAnswer(this, ${index}, ${optIndex}, ${q.correct_answer})">
                            ${String.fromCharCode(65 + optIndex)}) ${opt}
                        </div>
                    `).join('')}
                </div>
                <div id="question-explanation-${index}" style="display: none; margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #1976d2;">
                    ${q.explanation || ''}
                </div>
            </div>
        `).join('');
        
        document.getElementById('questionsList').innerHTML = questionsHTML;
    } else {
        questionsDiv.style.display = 'none';
    }
}

// Function for pronouncing word
function speakWord(text) {
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.pitch = 1;
        
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh-CN') || voice.lang.startsWith('zh')
        );
        
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        speechSynthesis.speak(utterance);
    } else {
        alert('Browser does not support text-to-speech');
    }
}

// Check comprehension question answer
function checkComprehensionAnswer(element, questionIndex, selectedIndex, correctIndex) {
    const questionDiv = element.closest('.test-question');
    const options = questionDiv.querySelectorAll('.test-option');
    
    // Reset all highlights
    options.forEach(opt => {
        opt.classList.remove('correct', 'wrong');
    });
    
    // Check answer
    if (selectedIndex === correctIndex) {
        element.classList.add('correct');
        element.style.borderColor = 'var(--success)';
        element.style.background = '#e3f2fd';
    } else {
        element.classList.add('wrong');
        element.style.borderColor = 'var(--danger)';
        element.style.background = '#fde8e8';
        
        // Highlight correct answer
        options[correctIndex].classList.add('correct');
        options[correctIndex].style.borderColor = 'var(--success)';
        options[correctIndex].style.background = '#e3f2fd';
    }
    
    // Show explanation
    const explanationDiv = document.getElementById(`question-explanation-${questionIndex}`);
    if (explanationDiv) {
        explanationDiv.style.display = 'block';
    }
}

// Color for difficulty
function getDifficultyColor(difficulty) {
    const colors = {
        'easy': '#4cd964',
        'medium': '#ff9a00',
        'hard': '#f5576c'
    };
    return colors[difficulty] || '#667eea';
}

// Play audio podcast
function playAudioPodcast() {
    if (!currentAudioLesson) return;
    
    const playBtn = document.getElementById('playAudioBtn');
    const pauseBtn = document.getElementById('pauseAudioBtn');
    
    if (isAudioPlaying) {
        pauseAudioPodcast();
        return;
    }
    
    isAudioPlaying = true;
    playBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    
    // Use Web Speech API for speech synthesis
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const textToSpeak = currentAudioLesson.chinese_text;
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = 'zh-CN';
        utterance.rate = parseFloat(document.getElementById('audioSpeed').value);
        utterance.volume = 1;
        utterance.pitch = 1;
        
        // Choose voice
        const voiceSelect = document.getElementById('audioVoice');
        const selectedVoice = voiceSelect.value;
        if (selectedVoice && selectedVoice !== 'default') {
            const voices = speechSynthesis.getVoices();
            const voice = voices.find(v => v.name === selectedVoice);
            if (voice) {
                utterance.voice = voice;
            }
        }
        
        utterance.onstart = () => {
            console.log('Playback started');
            startAudioProgress();
        };
        
        utterance.onend = () => {
            console.log('Playback ended');
            isAudioPlaying = false;
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopAudioProgress();
        };
        
        utterance.onerror = (event) => {
            console.error('Playback error:', event);
            isAudioPlaying = false;
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopAudioProgress();
        };
        
        speechSynthesis.speak(utterance);
        
    } else {
        alert('Browser does not support speech synthesis');
    }
}

// Pause audio
function pauseAudioPodcast() {
    if ('speechSynthesis' in window) {
        speechSynthesis.pause();
        isAudioPlaying = false;
        
        const playBtn = document.getElementById('playAudioBtn');
        const pauseBtn = document.getElementById('pauseAudioBtn');
        playBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
        
        pauseAudioProgress();
    }
}

// Stop audio
function stopAudioPodcast() {
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        isAudioPlaying = false;
        
        const playBtn = document.getElementById('playAudioBtn');
        const pauseBtn = document.getElementById('pauseAudioBtn');
        playBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
        
        stopAudioProgress();
    }
}

// Playback progress
let audioProgressInterval = null;
let audioStartTime = null;
let audioTotalDuration = 0;

function startAudioProgress() {
    stopAudioProgress();
    
    // Estimate total duration (approximately 150 characters per minute)
    const textLength = currentAudioLesson.chinese_text.length;
    audioTotalDuration = Math.max(30, Math.floor(textLength / 150 * 60)); // in seconds
    
    audioStartTime = Date.now();
    audioProgressInterval = setInterval(updateAudioProgress, 100);
    
    document.getElementById('audioTotalTime').textContent = formatTime(audioTotalDuration);
}

function updateAudioProgress() {
    if (!audioStartTime) return;
    
    const elapsed = Math.floor((Date.now() - audioStartTime) / 1000);
    const progress = Math.min(100, (elapsed / audioTotalDuration) * 100);
    
    document.getElementById('audioProgress').style.width = `${progress}%`;
    document.getElementById('audioCurrentTime').textContent = formatTime(elapsed);
}

function pauseAudioProgress() {
    clearInterval(audioProgressInterval);
}

function stopAudioProgress() {
    clearInterval(audioProgressInterval);
    audioProgressInterval = null;
    audioStartTime = null;
    
    document.getElementById('audioProgress').style.width = '0%';
    document.getElementById('audioCurrentTime').textContent = '0:00';
}

// Change playback speed
function changeAudioSpeed() {
    if (isAudioPlaying && 'speechSynthesis' in window) {
        // If audio is playing, stop and restart with new speed
        speechSynthesis.cancel();
        setTimeout(() => playAudioPodcast(), 100);
    }
}

// Change voice
function changeAudioVoice() {
    if (isAudioPlaying && 'speechSynthesis' in window) {
        speechSynthesis.cancel();
        setTimeout(() => playAudioPodcast(), 100);
    }
}

// Load available voices
function loadAvailableVoices() {
    if ('speechSynthesis' in window) {
        // Wait for voices to load
        setTimeout(() => {
            const voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('audioVoice');
            
            // Clear existing options except first
            voiceSelect.innerHTML = '<option value="default">Default</option>';
            
            // Add Chinese voices
            const chineseVoices = voices.filter(voice => 
                voice.lang.startsWith('zh-CN') || 
                voice.lang.startsWith('zh') ||
                voice.name.toLowerCase().includes('chinese')
            );
            
            chineseVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            // If no Chinese voices, show all available
            if (chineseVoices.length === 0) {
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            }
        }, 1000);
    }
}

// Format time
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Download podcast text
function downloadAudioText() {
    if (!currentAudioLesson) return;
    
    const content = `
Topic: ${currentAudioLesson.title}
Level: HSK ${currentAudioLesson.hsk_level}
Difficulty: ${currentAudioLesson.difficulty}

${currentAudioLesson.chinese_text}

${currentAudioLesson.pinyin_text ? `\nPinyin:\n${currentAudioLesson.pinyin_text}` : ''}

${currentAudioLesson.translation ? `\nTranslation:\n${currentAudioLesson.translation}` : ''}

${currentAudioLesson.vocabulary && currentAudioLesson.vocabulary.length > 0 ? 
`\nVocabulary:\n${currentAudioLesson.vocabulary.map(word => 
    `${word.chinese} (${word.pinyin}) - ${word.translation}`).join('\n')}` : ''}
    `;
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `podcast_${currentAudioLesson.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Replace saveAudioLesson() function in frontend.html
function saveAudioLesson() {
    if (!currentAudioLesson) return;
    
    try {
        // Create object for history
        const historyItem = {
            id: currentAudioLesson.id || `audio_${Date.now()}`,
            title: currentAudioLesson.title,
            topic: currentAudioLesson.topic || document.getElementById('audioTopic').value,
            hsk_level: currentAudioLesson.hsk_level || parseInt(document.getElementById('audioHskLevel').value),
            difficulty: currentAudioLesson.difficulty || document.getElementById('audioDifficulty').value,
            duration: currentAudioLesson.estimated_duration || 180,
            character_count: currentAudioLesson.chinese_text?.length || 0,
            generated_at: currentAudioLesson.generated_at || new Date().toISOString(),
            saved_at: new Date().toISOString()
        };
        
        // Get existing history
        const savedHistory = localStorage.getItem('hsk_audio_history');
        let history = savedHistory ? JSON.parse(savedHistory) : [];
        
        // Remove duplicates (if any)
        history = history.filter(item => item.id !== historyItem.id);
        
        // Add to beginning
        history.unshift(historyItem);
        
        // Limit history
        if (history.length > 20) {
            history = history.slice(0, 20);
        }
        
        // Save
        localStorage.setItem('hsk_audio_history', JSON.stringify(history));
        
        // Update history display
        updateAudioHistory();
        
        showNotification('‚úÖ Lesson saved to history!');
        
        // If user is authorized, save on server
        if (currentUser?.user_id) {
            saveAudioLessonToServer(historyItem);
        }
        
    } catch (error) {
        console.error('Error saving lesson:', error);
        showNotification('‚ùå Saving error');
    }
}

// Function to save on server
async function saveAudioLessonToServer(lessonData) {
    try {
        const response = await fetch(`${API_BASE}/audio/save-lesson`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUser.user_id,
                lesson: lessonData
            })
        });
        
        if (response.ok) {
            console.log('Lesson saved on server');
        }
    } catch (error) {
        console.error('Server saving error:', error);
    }
}

// Update updateAudioHistory() function
function updateAudioHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    try {
        const savedHistory = localStorage.getItem('hsk_audio_history');
        const history = savedHistory ? JSON.parse(savedHistory) : [];
        
        if (history.length === 0) {
            historyList.innerHTML = `
                <div style="text-align: center; color: var(--gray); padding: 20px;">
                    <div style="font-size: 2em;">üìö</div>
                    <p>History empty</p>
                    <p style="font-size: 0.9em;">Generated podcasts will appear here</p>
                </div>
            `;
            return;
        }
        
        historyList.innerHTML = history.map(item => `
            <div style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; 
                        border-left: 4px solid var(--primary); cursor: pointer;" 
                 onclick="loadAudioLessonFromHistory('${item.id}')">
                <div style="font-weight: bold; display: flex; justify-content: space-between;">
                    <span>${item.title?.substring(0, 30) || 'No title'}</span>
                    <span style="font-size: 0.8em; color: var(--gray);">
                        HSK ${item.hsk_level || 3}
                    </span>
                </div>
                <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                    ${formatDate(item.saved_at || item.generated_at)} ‚Ä¢ ${item.difficulty || 'medium'}
                </div>
                ${item.character_count ? `
                    <div style="font-size: 0.8em; color: var(--gray); margin-top: 3px;">
                        ${item.character_count} characters
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('History update error:', error);
        historyList.innerHTML = '<p style="color: var(--danger);">History loading error</p>';
    }
}

async function loadAudioLessonFromHistory(lessonId) {
    try {
        // Try to load from server if there's user_id
        let lesson = null;
        
        if (currentUser?.user_id) {
            const response = await fetch(`${API_BASE}/audio/load-lesson`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lesson_id: lessonId,
                    user_id: currentUser.user_id
                })
            });
            
            if (response.ok) {
                lesson = await response.json();
            }
        }
        
        // If failed to load from server, search in localStorage
        if (!lesson) {
            const savedHistory = localStorage.getItem('hsk_audio_history');
            const history = savedHistory ? JSON.parse(savedHistory) : [];
            lesson = history.find(item => item.id === lessonId);
        }
        
        if (lesson) {
            // Show lesson
            currentAudioLesson = lesson;
            
            // Display
            displayAudioLesson(lesson);
            
            // Scroll to result
            document.getElementById('audioResultSection').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('‚úÖ Lesson loaded from history!');
        } else {
            showNotification('‚ùå Lesson not found in history');
        }
        
    } catch (error) {
        console.error('Lesson loading error:', error);
        showNotification('‚ùå Error loading lesson from history');
    }
}

function showFallbackAudioLesson(topic, hskLevel, difficulty, duration) {
    const fallbackLesson = {
        id: `fallback_audio_${Date.now()}`,
        title: topic,
        hsk_level: hskLevel,
        difficulty: difficulty,
        estimated_duration: duration === 'short' ? 90 : duration === 'medium' ? 180 : 300,
        chinese_text: `Â§ßÂÆ∂Â•ΩÔºÅ‰ªäÂ§©Êàë‰ª¨Êù•ËÅä‰∏ÄËÅä"${topic}"„ÄÇ

Ëøô‰∏™ËØùÈ¢òÂØπ‰∏≠ÂõΩÂ≠¶ÁîüÊù•ËØ¥ÂæàÈáçË¶Å„ÄÇËÆ©Êàë‰ª¨‰∏ÄËµ∑Â≠¶‰π†ÂêßÔºÅ

È¶ñÂÖàÔºå${topic}ÊòØÂæàÊúâÊÑèÊÄùÁöÑ‰∏ªÈ¢ò„ÄÇÂú®ÂæàÂ§öÊñπÈù¢ÔºåËøô‰∏™ËØùÈ¢òÂèØ‰ª•Â∏ÆÂä©Êàë‰ª¨ÁêÜËß£‰∏≠ÂõΩÊñáÂåñÂíåËØ≠Ë®Ä„ÄÇ

ÊØîÂ¶ÇËØ¥ÔºåÂΩì‰Ω†Â≠¶‰π†ÂÖ≥‰∫é${topic}ÁöÑ‰∏≠ÊñáÊó∂Ôºå‰Ω†‰ºöÂ≠¶Âà∞ÂæàÂ§öÊñ∞ËØçËØ≠ÂíåË°®ËææÊñπÂºè„ÄÇËøôÂØπ‰∫éÊèêÈ´ò‰Ω†ÁöÑÊ±âËØ≠Ê∞¥Âπ≥ÂæàÊúâÂ∏ÆÂä©„ÄÇ

ËÆ∞‰ΩèÔºåÂ≠¶‰π†ËØ≠Ë®ÄÈúÄË¶ÅÊó∂Èó¥ÂíåËÄêÂøÉ„ÄÇÊØèÂ§©ÂùöÊåÅÂ≠¶‰π†‰∏ÄÁÇπÁÇπÔºå‰Ω†Â∞±‰ºöÁúãÂà∞ËøõÊ≠•„ÄÇ

Â•Ω‰∫ÜÔºå‰ªäÂ§©ÁöÑÂÜÖÂÆπÂ∞±Âà∞ËøôÈáå„ÄÇÂ∏åÊúõËøô‰∏™Êí≠ÂÆ¢ÂØπ‰Ω†ÊúâÂ∏ÆÂä©„ÄÇ‰∏ãÊ¨°ÂÜçËßÅÔºÅ`,
        pinyin_text: `D√†jiƒÅ h«éo! Jƒ´ntiƒÅn w«ímen l√°i li√°o yƒ´ li√°o "${topic}"„ÄÇ

Zh√®ge hu√†t√≠ du√¨ Zh≈çnggu√≥ xu√©shƒìng l√°i shu≈ç hƒõn zh√≤ngy√†o. R√†ng w«ímen yƒ´q«ê xu√©x√≠ ba!

Sh«íuxiƒÅn, ${topic} sh√¨ hƒõn y«íuy√¨si de zh«ît√≠. Z√†i hƒõndu≈ç fƒÅngmi√†n, zh√®ge hu√†t√≠ kƒõy«ê bƒÅngzh√π w«ímen l«êjiƒõ Zh≈çnggu√≥ w√©nhu√† h√© y«îy√°n.

B«êr√∫ shu≈ç, dƒÅng n«ê xu√©x√≠ guƒÅny√∫ ${topic} de Zh≈çngw√©n sh√≠, n«ê hu√¨ xu√© d√†o hƒõndu≈ç xƒ´n c√≠y«î h√© bi«éod√° fƒÅngsh√¨. Zh√® du√¨y√∫ t√≠gƒÅo n«ê de H√†ny«î shu«êp√≠ng hƒõn y«íu bƒÅngzh√π.

J√¨zh√π, xu√©x√≠ y«îy√°n x≈´y√†o sh√≠jiƒÅn h√© n√†ixƒ´n. Mƒõi tiƒÅn jiƒÅnch√≠ xu√©x√≠ yƒ´di«éndi«én, n«ê ji√π hu√¨ k√†n d√†o j√¨nb√π.

H«éole, jƒ´ntiƒÅn de n√®ir√≥ng ji√π d√†o zh√®l«ê. Xƒ´w√†ng zh√®ge b≈çk√® du√¨ n«ê y«íu bƒÅngzh√π. Xi√†c√¨ z√†iji√†n!`,
        translation: `Hello everyone! Today we'll talk about "${topic}".

This topic is very important for Chinese students. Let's learn together!

First, ${topic} is a very interesting topic. In many aspects, this topic can help us understand Chinese culture and language.

For example, when you study Chinese on the topic of ${topic}, you'll learn many new words and expressions. This will help you improve your Chinese level.

Remember, learning a language requires time and patience. Learn a little bit every day, and you'll see progress.

Alright, that's all for today. I hope this podcast was helpful for you. See you next time!`,
        vocabulary: [
            {
                chinese: 'ËØùÈ¢ò',
                pinyin: 'hu√†t√≠',
                translation: 'topic of conversation',
                example: '‰ªäÂ§©ÁöÑËØùÈ¢òÂæàÊúâÊÑèÊÄù„ÄÇ'
            },
            {
                chinese: 'Â≠¶‰π†',
                pinyin: 'xu√©x√≠',
                translation: 'to study, learn',
                example: 'ÊàëÂñúÊ¨¢Â≠¶‰π†‰∏≠Êñá„ÄÇ'
            },
            {
                chinese: 'ÈáçË¶Å',
                pinyin: 'zh√≤ngy√†o',
                translation: 'important',
                example: 'Ëøô‰∏™ËÄÉËØïÂæàÈáçË¶Å„ÄÇ'
            },
            {
                chinese: 'Â∏ÆÂä©',
                pinyin: 'bƒÅngzh√π',
                translation: 'to help',
                example: 'ÊàëÂèØ‰ª•Â∏ÆÂä©‰Ω†Â≠¶‰π†‰∏≠Êñá„ÄÇ'
            }
        ],
        comprehension_questions: [
            {
                question: '‰ªäÂ§©Êàë‰ª¨Ë¶ÅËÅä‰ªÄ‰πàËØùÈ¢òÔºü',
                options: ['‰∏≠Êñá', topic, 'Â≠¶‰π†', 'ËÄÉËØï'],
                correct_answer: 1,
                explanation: '‰ªäÂ§©Êàë‰ª¨ËÅäÁöÑËØùÈ¢òÊòØÔºö' + topic
            },
            {
                question: 'Â≠¶‰π†Ëøô‰∏™‰∏ªÈ¢òÈáçË¶ÅÂêóÔºü',
                options: ['‰∏çÈáçË¶Å', 'Êúâ‰∏ÄÁÇπÈáçË¶Å', 'ÂæàÈáçË¶Å', '‰∏çÁü•ÈÅì'],
                correct_answer: 2,
                explanation: 'Êí≠ÂÆ¢‰∏≠ËØ¥ÔºöËøô‰∏™ËØùÈ¢òÂæàÈáçË¶Å„ÄÇ'
            }
        ],
        generated_at: new Date().toISOString(),
        ai_generated: false,
        fallback: true
    };
    
    currentAudioLesson = fallbackLesson;
    displayAudioLesson(fallbackLesson);
}

// Set essay difficulty
function setEssayDifficulty(difficulty) {
    // Reset active buttons
    document.querySelectorAll('.essay-difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Activate selected button
    const activeBtn = document.querySelector(`.essay-difficulty-btn[data-difficulty="${difficulty}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('essayDifficulty').value = difficulty;
}

// Load topic example
function loadEssayExample(type) {
    const examples = {
        'culture': {
            topic: "Influence of Chinese culture on the modern world",
            details: "Discuss how traditional Chinese culture (Confucianism, art, philosophy) influences modern society and world culture."
        },
        'technology': {
            topic: "Artificial Intelligence and the Future of China",
            details: "Analyze the role of AI in the development of Chinese economy and society. What ethical questions arise?"
        },
        'education': {
            topic: "Comparison of Chinese and Western education systems",
            details: "Compare learning approaches, educational goals and results. What are the advantages and disadvantages of each system?"
        },
        'environment': {
            topic: "Environmental problems and sustainable development in China",
            details: "Discuss measures taken by China to solve environmental problems. Are these measures effective?"
        },
        'globalization': {
            topic: "China's role in the global economy",
            details: "Analyze how China has changed the world economy through the 'Belt and Road' initiative and other projects."
        }
    };
    
    if (examples[type]) {
        document.getElementById('essayAnalysisTopic').value = examples[type].topic;
        document.getElementById('essayAnalysisDetails').value = examples[type].details;
    }
}

// REPLACE existing generateEssayPrompt() function with this one:
async function generateEssayPrompt() {
    const topic = document.getElementById('essayAnalysisTopic').value.trim();
    const details = document.getElementById('essayAnalysisDetails').value.trim();
    const difficulty = document.getElementById('essayDifficulty').value;
    const length = parseInt(document.getElementById('essayAnalysisLength').value);
    
    if (!topic) {
        alert('Enter essay topic!');
        return;
    }
    
    // Show loading
    const generateBtn = document.getElementById('generateEssayBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating task...';
    generateBtn.disabled = true;
    
    try {
        // Form request according to backend model
        const requestData = {
            topic: topic,
            details: details,
            difficulty: difficulty,
            target_length: length,
            user_id: currentUser?.user_id || null
        };
        
        console.log("Sending request for task generation:", requestData);
        
        const response = await fetch(`${API_BASE}/essay/analysis/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("Received task data:", data);
        
        // Save data
        currentEssayAnalysisData = {
            prompt: data.prompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            requirements: data.requirements,
            evaluation_criteria: data.evaluation_criteria,
            time_limit_minutes: data.time_limit_minutes || 60,
            start_time: new Date(),
            api_data: data  // Save all API data
        };
        
        // Show writing area
        showEssayAnalysisArea(data.prompt, length);
        
        showNotification('‚úÖ Task generated! Start writing your essay.');
        
    } catch (error) {
        console.error('Task generation error:', error);
        showNotification('‚ùå Task generation error');
        
        // Fallback: local generation
        const fallbackPrompt = generateFallbackEssayPrompt(topic, difficulty, length);
        currentEssayAnalysisData = {
            prompt: fallbackPrompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            start_time: new Date()
        };
        
        showEssayAnalysisArea(fallbackPrompt, length);
        
    } finally {
        // Restore button
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Fallback task generation
function generateFallbackEssayPrompt(topic, difficulty, length) {
    const difficultyTexts = {
        'beginner': 'Use simple sentences and basic vocabulary.',
        'intermediate': 'Use complex sentences and varied vocabulary.',
        'advanced': 'Demonstrate mastery of complex grammatical constructions.',
        'exam': 'Demonstrate all aspects of language proficiency at a high level.'
    };
    
    const lengthTexts = {
        200: 'Length: 200-300 characters',
        400: 'Length: 400-500 characters',
        600: 'Length: 600-700 characters',
        800: 'Length: 800+ characters'
    };
    
    return `
        <h4>Topic: ${topic}</h4>
        <p><strong>Task:</strong> Write an essay on the given topic. Your essay should include:</p>
        <ul>
            <li>Introduction with thesis</li>
            <li>2-3 main arguments with examples</li>
            <li>Conclusion with findings</li>
        </ul>
        <p><strong>Requirements:</strong></p>
        <ul>
            <li>${lengthTexts[length] || '400-500 characters'}</li>
            <li>${difficultyTexts[difficulty] || 'Use complex sentences'}</li>
            <li>Use introductory words and connecting elements</li>
            <li>Avoid repetitions and grammatical errors</li>
        </ul>
        <p><strong>Grading Criteria:</strong> content (40%), grammar (30%), vocabulary (20%), structure (10%).</p>
    `;
}

// Show writing area
function showEssayAnalysisArea(prompt, targetLength) {
    // Hide settings
    document.querySelector('#essay-analysis-tab .section > div:first-child').style.display = 'none';
    
    // Show writing area
    document.getElementById('essayAnalysisArea').style.display = 'block';
    
    // Fill data
    document.getElementById('essayAnalysisPrompt').innerHTML = prompt;
    document.getElementById('essayAnalysisTarget').textContent = targetLength;
    document.getElementById('essayAnalysisCharsLeft').textContent = targetLength;
    
    // Clear input field
    document.getElementById('essayAnalysisText').value = '';
    
    // Reset counter
    updateEssayAnalysisCounter();
    
    // Start timer
    essayAnalysisTimeLeft = difficultyToTime(currentEssayAnalysisData.difficulty);
    startEssayAnalysisTimer();
    
    // Focus on input field
    setTimeout(() => {
        document.getElementById('essayAnalysisText').focus();
    }, 300);
}

// Convert difficulty to time
function difficultyToTime(difficulty) {
    const times = {
        'beginner': 45 * 60,     // 45 minutes
        'intermediate': 60 * 60,  // 60 minutes
        'advanced': 75 * 60,      // 75 minutes
        'exam': 90 * 60          // 90 minutes
    };
    return times[difficulty] || 60 * 60;
}

// Start timer
function startEssayAnalysisTimer() {
    clearInterval(essayAnalysisTimer);
    
    essayAnalysisTimer = setInterval(() => {
        essayAnalysisTimeLeft--;
        
        const minutes = Math.floor(essayAnalysisTimeLeft / 60);
        const seconds = essayAnalysisTimeLeft % 60;
        document.getElementById('essayAnalysisTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is low
        if (essayAnalysisTimeLeft < 300) { // 5 minutes
            document.getElementById('essayAnalysisTimer').style.background = 'var(--danger)';
        }
        
        if (essayAnalysisTimeLeft <= 0) {
            clearInterval(essayAnalysisTimer);
            alert('Time is up! The essay will be submitted for analysis.');
            submitEssayForAnalysis();
        }
    }, 1000);
}

// Update character counter
function updateEssayAnalysisCounter() {
    const text = document.getElementById('essayAnalysisText').value;
    const charCount = text.length;
    const targetLength = parseInt(document.getElementById('essayAnalysisTarget').textContent);
    
    document.getElementById('essayAnalysisCharCount').textContent = charCount;
    document.getElementById('essayAnalysisCharsLeft').textContent = Math.max(0, targetLength - charCount);
    
    // Update progress bar
    const progress = Math.min(100, (charCount / targetLength) * 100);
    const progressBar = document.getElementById('essayAnalysisProgress');
    progressBar.style.width = `${progress}%`;
    
    // Change progress bar color
    if (progress >= 100) {
        progressBar.style.background = 'var(--success)';
    } else if (progress >= 50) {
        progressBar.style.background = 'var(--warning)';
    } else {
        progressBar.style.background = 'var(--danger)';
    }
}

// Insert quick phrases
function insertEssayAnalysisPhrase(type) {
    const textarea = document.getElementById('essayAnalysisText');
    const phrases = {
        'introduction': 'ËøëÂπ¥Êù•Ôºå...ÈóÆÈ¢òÂºïËµ∑‰∫ÜÂπøÊ≥õÂÖ≥Ê≥®„ÄÇÊú¨ÊñáÂ∞Ü‰ªé‰ª•‰∏ãÂá†‰∏™ÊñπÈù¢ËøõË°åÂàÜÊûê„ÄÇ',
        'thesis': 'Á¨îËÄÖËÆ§‰∏∫Ôºå... ‰∏ªË¶ÅÊúâ‰ª•‰∏ãÂá†‰∏™ÂéüÂõ†„ÄÇ',
        'argument': 'È¶ñÂÖàÔºå... ÂÖ∂Ê¨°Ôºå... ÊúÄÂêéÔºå...',
        'example': '‰æãÂ¶ÇÔºå... Ëøô‰∏™‰æãÂ≠êÊ∏ÖÊ•öÂú∞Ë°®Êòé...',
        'contrast': '‰∏é...Áõ∏ÊØîÔºå... ÁÑ∂ËÄåÔºå...',
        'conclusion': 'ÊÄªËÄåË®Ä‰πãÔºå... Âõ†Ê≠§ÔºåÊàë‰ª¨Â∫îËØ•...'
    };
    
    if (phrases[type]) {
        textarea.value += phrases[type] + ' ';
        textarea.focus();
        updateEssayAnalysisCounter();
    }
}

// Hint
function showEssayAnalysisHint() {
    const hints = [
        "üí° Start with introduction, present the topic and your position",
        "üí° Use structure: introduction ‚Üí arguments ‚Üí conclusion",
        "üí° Each paragraph should have one main idea",
        "üí° Use introductory words: È¶ñÂÖàÔºåÂÖ∂Ê¨°ÔºåÊúÄÂêé",
        "üí° Add specific examples for arguments",
        "üí° Check grammar, especially particles ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó"
    ];
    
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    alert(randomHint);
}

// REPLACE submitEssayForAnalysis() function with this one:
async function submitEssayForAnalysis() {
    const essayText = document.getElementById('essayAnalysisText').value.trim();
    
    if (!essayText) {
        alert('Write an essay before submitting!');
        return;
    }
    
    // Check minimum length
    const targetLength = currentEssayAnalysisData.target_length;
    if (essayText.length < targetLength * 0.5) {
        if (!confirm(`Your essay is too short (${essayText.length}/${targetLength} characters). Submit for checking?`)) {
            return;
        }
    }
    
    // Stop timer
    clearInterval(essayAnalysisTimer);
    
    // Show loading
    const essayArea = document.getElementById('essayAnalysisArea');
    const originalContent = essayArea.innerHTML;
    
    essayArea.innerHTML = `
        <div style="text-align: center; padding: 50px 0;">
            <div class="loading-spinner" style="margin: 0 auto;"></div>
            <h3 style="margin-top: 20px; color: var(--primary);">AI is STRICTLY checking your essay...</h3>
            <p style="color: var(--gray);">Be ready for a tough but fair assessment</p>
        </div>
    `;
    
    try {
        const requestData = {
            essay_text: essayText,
            topic: currentEssayAnalysisData.topic,
            difficulty: currentEssayAnalysisData.difficulty,
            target_length: currentEssayAnalysisData.target_length,
            user_id: currentUser?.user_id || null,
            time_spent: Math.floor((new Date() - currentEssayAnalysisData.start_time) / 1000)
        };
        
        console.log("Submitting essay for strict check:", {
            topic: requestData.topic,
            length: essayText.length,
            difficulty: requestData.difficulty
        });
        
        const response = await fetch(`${API_BASE}/essay/analysis/check`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const analysisResult = await response.json();
        console.log("Received strict check result:", analysisResult);
        
        // Save result
        currentEssayAnalysisData.result = analysisResult;
        currentEssayAnalysisData.essay_text = essayText;
        currentEssayAnalysisData.completed_at = new Date().toISOString();
        
        // Show result
        showEssayAnalysisResult(analysisResult, essayText);
        
    } catch (error) {
        console.error('Essay analysis error:', error);
        
        // Restore original content
        essayArea.innerHTML = originalContent;
        
        // Show local analysis (strict)
        showLocalEssayAnalysis(essayText);
    }
}


// Helper functions
function getCategoryName(category) {
    const names = {
        'content': 'Content',
        'grammar': 'Grammar',
        'vocabulary': 'Vocabulary',
        'structure': 'Structure'
    };
    return names[category] || category;
}

function getDefaultFeedback(category) {
    const feedbacks = {
        'content': 'Good relevance to topic, but can add more details',
        'grammar': 'Some small errors, pay attention to particles',
        'vocabulary': 'Varied vocabulary, but can use more complex words',
        'structure': 'Logical organization, but can improve transitions between paragraphs'
    };
    return feedbacks[category] || 'Good job!';
}

function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

function calculateLocalEssayScore(essayText) {
    // Simple scoring algorithm based on length, complexity and other factors
    let score = 0;
    
    // 1. Essay length (max 30 points)
    const targetLength = currentEssayAnalysisData.target_length;
    const lengthRatio = Math.min(1, essayText.length / targetLength);
    score += Math.round(lengthRatio * 30);
    
    // 2. Number of sentences (max 20 points)
    const sentenceCount = essayText.split(/[„ÄÇÔºÅÔºü]/).filter(s => s.trim()).length;
    const minSentences = Math.max(5, targetLength / 50);
    if (sentenceCount >= minSentences) {
        score += Math.min(20, (sentenceCount / minSentences) * 20);
    }
    
    // 3. Unique characters (max 25 points)
    const uniqueChars = new Set(essayText.match(/[\u4e00-\u9fff]/g) || []).size;
    const minUnique = Math.max(30, targetLength * 0.3);
    if (uniqueChars >= minUnique) {
        score += Math.min(25, (uniqueChars / minUnique) * 25);
    }
    
    // 4. Complexity check (max 25 points)
    const difficulty = currentEssayAnalysisData.difficulty;
    const complexityScore = difficulty === 'beginner' ? 20 :
                          difficulty === 'intermediate' ? 22 :
                          difficulty === 'advanced' ? 24 : 25;
    score += complexityScore;
    
    return Math.min(100, score);
}

// Local analysis (if server unavailable)
function showLocalEssayAnalysis(essayText) {
    // Calculate local scores
    const overallScore = calculateLocalEssayScore(essayText);
    
    const mockResult = {
        overall_score: overallScore,
        content_analysis: {
            score: Math.floor(overallScore * 0.95),
            feedback: 'Content relevant to topic, but can add more details and examples.'
        },
        grammar_analysis: {
            score: Math.floor(overallScore * 0.85),
            feedback: 'Good grammar, but some small errors in particle usage.'
        },
        vocabulary_analysis: {
            score: Math.floor(overallScore * 0.9),
            feedback: 'Varied vocabulary, use more complex words.'
        },
        structure_analysis: {
            score: Math.floor(overallScore * 0.88),
            feedback: 'Logical structure, but can improve transitions between paragraphs.'
        },
        errors: generateMockErrors(essayText),
        recommendations: `
            <ul>
                <li>Use more complex sentences</li>
                <li>Add specific examples for arguments</li>
                <li>Pay attention to particles ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó</li>
                <li>Use introductory words to improve coherence</li>
                <li>Practice writing essays regularly</li>
            </ul>
        `
    };
    
    showEssayAnalysisResult(mockResult, essayText);
}

function generateMockErrors(essayText) {
    const errors = [];
    
    // Generate some example errors
    if (essayText.length > 50) {
        errors.push({
            context: essayText.substring(20, 40),
            description: 'Incorrect use of ‰∫Ü',
            correction: 'Use ‰∫Ü only for completed actions'
        });
    }
    
    if (essayText.length > 100) {
        errors.push({
            context: essayText.substring(80, 100),
            description: 'Word order can be improved',
            correction: 'Should be: ÊàëÂéªÂ≠¶Ê†°Ôºå‰∏çÊòØÂ≠¶Ê†°ÂéªÊàë'
        });
    }
    
    return errors;
}

// Other functions
function cancelEssayAnalysis() {
    if (confirm('Cancel essay writing? All text will be lost.')) {
        clearInterval(essayAnalysisTimer);
        document.getElementById('essayAnalysisArea').style.display = 'none';
        document.getElementById('essayAnalysisResult').style.display = 'none';
        document.querySelector('#essay-analysis-tab .section > div:first-child').style.display = 'grid';
    }
}

function retryEssayAnalysis() {
    document.getElementById('essayAnalysisResult').style.display = 'none';
    document.querySelector('#essay-analysis-tab .section > div:first-child').style.display = 'grid';
}

function saveEssayAnalysisResult() {
    if (!currentEssayAnalysisData) return;
    
    const data = {
        type: 'essay_analysis',
        data: currentEssayAnalysisData,
        essay_text: document.getElementById('essayAnalysisText').value,
        timestamp: new Date().toISOString(),
        score: calculateLocalEssayScore(document.getElementById('essayAnalysisText').value)
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `essay_analysis_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ Report saved!');
}

function showCorrectedEssay() {
    const essayText = document.getElementById('essayAnalysisText').value;
    
    // Simple correction (in real project will be AI)
    const correctedText = essayText
        .replace(/‰∫Ü(\s+ÊòØ)/g, '$1') // Remove extra ‰∫Ü
        .replace(/ÁöÑÂæó/g, 'Âæó')      // Fix ÁöÑÂæó
        .replace(/Âú∞Âæó/g, 'Âæó');     // Fix Âú∞Âæó
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; 
                    width: 100%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-edit"></i> Corrected Essay Version
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                    <i class="fas fa-check-circle"></i> Corrected errors are highlighted:
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; 
                            font-family: 'SimSun', serif; font-size: 16px; line-height: 1.8; 
                            white-space: pre-wrap;">
                    ${correctedText}
                </div>
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Initialize when loading tab
function initEssayAnalysis() {
    setEssayDifficulty('intermediate');
}

        // Essay and translation checking
let currentEssayMode = 'essay'; // 'essay' or 'translation'
let essayTimer = null;
let essayTimeLeft = 0;
let translationTimer = null;
let translationTimeLeft = 0;
let currentEssayData = null;
let currentTranslationData = null;

// Switch modes
function switchEssayMode(mode) {
    currentEssayMode = mode;
    
    // Update active buttons
    document.getElementById('essayTabBtn').classList.remove('active');
    document.getElementById('translationTabBtn').classList.remove('active');
    
    if (mode === 'essay') {
        document.getElementById('essayTabBtn').classList.add('active');
        document.getElementById('essayModeContent').style.display = 'block';
        document.getElementById('translationModeContent').style.display = 'none';
    } else {
        document.getElementById('translationTabBtn').classList.add('active');
        document.getElementById('essayModeContent').style.display = 'none';
        document.getElementById('translationModeContent').style.display = 'block';
    }
    
    // Reset timers
    clearTimers();
}

// Update essay requirements
function updateEssayRequirements() {
    const topic = document.getElementById('essayTopic').value;
    const customTopicDiv = document.getElementById('customTopicDiv');
    const requirementsDiv = document.getElementById('essayRequirements');
    
    // Show/hide custom topic field
    if (topic === 'custom') {
        customTopicDiv.style.display = 'block';
    } else {
        customTopicDiv.style.display = 'none';
    }
    
    // Set requirements depending on topic
    const requirements = {
        'modern_tech': 'üì± Discuss the influence of modern technology on society. Use examples from life.',
        'environment': 'üåç Write about the importance of environmental protection. Suggest specific solutions.',
        'education': 'üéì Compare the Chinese education system with your country. What are the advantages and disadvantages?',
        'culture': 'üéå Tell about Chinese culture. What particularly impressed or surprised you?',
        'travel': '‚úàÔ∏è Describe your ideal trip to China. What places would you like to visit and why?',
        'food': 'üçú Share impressions about Chinese cuisine. Which dish do you like most?',
        'business': 'üíº Discuss features of doing business in China. What advice would you give to foreigners?',
        'family': 'üë™ Tell about the role of family in modern society. How have family values changed?',
        'health': 'üí™ Write about the importance of healthy lifestyle. How to maintain health in the modern world?',
        'custom': '‚úèÔ∏è Write an essay on a topic of your choice.'
    };
    
    requirementsDiv.innerHTML = requirements[topic] || 'Select a topic to see requirements';
}

// Set HSK level for essay
function setEssayHskLevel(level) {
    // Reset active buttons
    document.querySelectorAll('.essay-hsk-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Activate selected button
    const activeBtn = document.querySelector(`.essay-hsk-btn[data-level="${level}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('essayHskLevel').value = level;
    
    // Update requirements
    updateEssayRequirements();
}

function startEssayWriting() {
    const topicSelect = document.getElementById('essayTopic');
    const customTopicInput = document.getElementById('customTopic');
    const topic = topicSelect.value;
    const customTopic = customTopicInput ? customTopicInput.value.trim() : '';
    const hskLevel = document.getElementById('essayHskLevel').value;
    const minLength = parseInt(document.getElementById('essayMinLength').value);
    const timeLimit = parseInt(document.getElementById('essayTimeLimit').value);
    
    console.log("Starting essay:", { topic, customTopic, hskLevel, minLength, timeLimit });
    
    // IMPORTANT FIX: Correct topic check
    let finalTopic = '';
    
    if (topic === 'custom') {
        if (!customTopic) {
            alert('Enter your topic!');
            return;
        }
        finalTopic = customTopic;
    } else if (!topic) {
        alert('Select a topic for the essay!');
        return;
    } else {
        finalTopic = topic; // This will be value like "environment"
    }
    
    // Determine topic for display
    const displayTopic = topic === 'custom' ? customTopic : getTopicDisplayName(finalTopic);
    
    // Generate task
    const essayPrompt = generateEssayPrompt(finalTopic, hskLevel);
    
    // Save current essay data
    currentEssayData = {
        topic: finalTopic, // Use finalTopic instead of topic
        displayTopic: displayTopic,
        hskLevel: hskLevel,
        minLength: minLength,
        timeLimit: timeLimit,
        startTime: new Date(),
        prompt: essayPrompt,
        topicType: topic
    };
    
    // Show writing area
    document.getElementById('essayModeContent').style.display = 'none';
    document.getElementById('essayWritingArea').style.display = 'block';
    
    // Update information
    document.getElementById('currentEssayTopic').textContent = `Topic: ${displayTopic}`;
    document.getElementById('essayPrompt').innerHTML = `<strong>Task:</strong><br>${essayPrompt}`;
    document.getElementById('minChars').textContent = minLength;
    document.getElementById('charsLeft').textContent = minLength;
    
    // Clear input field
    document.getElementById('essayText').value = '';
    
    // Reset counter
    updateEssayCounter();
    
    // Start timer if needed
    if (timeLimit > 0) {
        essayTimeLeft = timeLimit * 60;
        startEssayTimer();
        document.getElementById('essayTimer').textContent = formatTime(essayTimeLeft);
        document.getElementById('essayTimer').style.display = 'inline-block';
    } else {
        document.getElementById('essayTimer').style.display = 'none';
    }
    
    // Scroll to writing area
    document.getElementById('essayWritingArea').scrollIntoView({ behavior: 'smooth' });
    
    // Focus on input field
    setTimeout(() => {
        document.getElementById('essayText').focus();
    }, 300);
}
// Function to get display name of topic
// Function to get display name of topic
function getTopicDisplayName(topicValue) {
    const topicNames = {
        'modern_tech': 'Modern Technology and Society',
        'environment': 'Environmental Protection', 
        'education': 'Education System',
        'culture': 'Chinese Culture and Traditions',
        'travel': 'Travel and Tourism',
        'food': 'Chinese Cuisine',
        'business': 'Business and Economy',
        'family': 'Family and Society',
        'health': 'Healthy Lifestyle',
        'custom': 'Custom Topic'
    };
    return topicNames[topicValue] || topicValue;
}

// Generate essay prompt
// Generate essay prompt - IMPROVED VERSION
function generateEssayPrompt(topic, hskLevel) {
    const levelTips = {
        '3': 'Use simple sentences and basic HSK 1-3 vocabulary.',
        '4': 'Add complex sentences and HSK 4 level vocabulary.',
        '5': 'Use varied vocabulary and complex grammatical structures.',
        '6': 'Demonstrate language mastery, use idioms and complex constructions.'
    };
    
    // Essay structure for different levels
    const structures = {
        '3': 'Introduction (2-3 sentences) ‚Üí Main part (4-5 sentences) ‚Üí Conclusion (2-3 sentences)',
        '4': 'Introduction (topic presentation) ‚Üí 2-3 arguments with examples ‚Üí Conclusion (findings)',
        '5': 'Introduction with thesis ‚Üí 3-4 developed arguments ‚Üí Counter-argument ‚Üí Conclusion',
        '6': 'Attention-grabbing introduction ‚Üí Deep analysis ‚Üí Multiple examples ‚Üí Persuasive conclusion'
    };
    
    // Generate tasks by topics
    let task = '';
    
    if (typeof topic === 'string' && topic.startsWith('custom_')) {
        topic = topic.replace('custom_', '');
    }
    
    const prompts = {
        'modern_tech': `Write an essay about the influence of technology on modern society. 
        Discuss how technology has changed our life, work and communication. 
        Give examples from your experience.`,
        
        'environment': `Write an essay about environmental problems. 
        Discuss causes and consequences of pollution, as well as possible solutions.
        What can each person do to protect nature?`,
        
        'education': `Compare education systems in China and your country.
        What are the advantages and disadvantages of each system?
        How does education affect the future of youth?`,
        
        'culture': `Describe your acquaintance with Chinese culture.
        What impressed or surprised you most?
        What cultural differences did you notice?`,
        
        'travel': `Imagine you are traveling through China.
        Describe places you would like to visit, and why.
        How do travels broaden horizons?`,
        
        'food': `Tell about Chinese cuisine.
        What dishes have you tried or would like to try?
        How does food reflect a country's culture?`,
        
        'business': `Discuss features of doing business in China.
        What advice would you give to foreign entrepreneurs?
        How do cultural differences affect business?`,
        
        'family': `Discuss the role of family in modern society.
        How have family values changed in recent years?
        What significance does family have in Chinese culture?`,
        
        'health': `Write about the importance of healthy lifestyle.
        What habits help maintain health?
        How does modern lifestyle affect people's health?`
    };
    
    const basePrompt = prompts[topic] || `Write an essay on topic: "${topic}"`;
    
    return `
        ${basePrompt}
        
        <br><br>
        <strong>Requirements:</strong>
        <ul>
            <li>Minimum ${currentEssayData?.minLength || 300} characters</li>
            <li>Use HSK level ${hskLevel} vocabulary</li>
            <li>${structures[hskLevel] || structures['4']}</li>
            <li>${levelTips[hskLevel] || ''}</li>
        </ul>
        
        <br>
        <strong>Recommended structure:</strong>
        <ol>
            <li>Introduction: present the topic and your position</li>
            <li>Main part: arguments and examples</li>
            <li>Conclusion: findings and summary</li>
        </ol>
    `;
}

// Timer for essay
function startEssayTimer() {
    clearInterval(essayTimer);
    
    essayTimer = setInterval(() => {
        essayTimeLeft--;
        
        const minutes = Math.floor(essayTimeLeft / 60);
        const seconds = essayTimeLeft % 60;
        document.getElementById('essayTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is low
        if (essayTimeLeft < 300) { // 5 minutes
            document.getElementById('essayTimer').style.background = 'var(--danger)';
        }
        
        if (essayTimeLeft <= 0) {
            clearInterval(essayTimer);
            alert('Time is up! Essay will be automatically submitted for checking.');
            submitEssayForCheck();
        }
    }, 1000);
}

// Update character counter in essay
function updateEssayCounter() {
    const text = document.getElementById('essayText').value;
    const charCount = text.length;
    const minLength = parseInt(document.getElementById('minChars').textContent);
    
    document.getElementById('charCount').textContent = charCount;
    document.getElementById('charsLeft').textContent = Math.max(0, minLength - charCount);
    
    // Update progress bar
    const progress = Math.min(100, (charCount / minLength) * 100);
    document.getElementById('essayProgress').style.width = `${progress}%`;
    
    // Change progress bar color
    const progressBar = document.getElementById('essayProgress');
    if (progress >= 100) {
        progressBar.style.background = 'var(--success)';
    } else if (progress >= 50) {
        progressBar.style.background = 'var(--warning)';
    } else {
        progressBar.style.background = 'var(--danger)';
    }
}

// Insert quick phrases
function insertEssayPhrase(type) {
    const textarea = document.getElementById('essayText');
    const phrases = {
        'intro': 'Âú®ÊàëÁúãÊù•ÔºåËøô‰∏™ÈóÆÈ¢òÈùûÂ∏∏ÈáçË¶Å„ÄÇÂõ†‰∏∫...',
        'opinion': 'ÊàëËÆ§‰∏∫... ‰∏ÄÊñπÈù¢...ÔºåÂè¶‰∏ÄÊñπÈù¢...',
        'example': '‰æãÂ¶ÇÔºåÊúâ‰∏ÄÊ¨°Êàë...',
        'conclusion': 'ÊÄªËÄåË®Ä‰πãÔºå... Âõ†Ê≠§ÔºåÊàë‰ª¨Â∫îËØ•...',
        'connector': '‰∏ç‰ªÖÂ¶ÇÊ≠§ÔºåËÄå‰∏î... Êç¢Âè•ËØùËØ¥...'
    };
    
    if (phrases[type]) {
        textarea.value += phrases[type] + ' ';
        textarea.focus();
        updateEssayCounter();
    }
}

// Hint for essay
function showEssayHint() {
    const hints = [
        "üí° Start with introduction: present topic and your position",
        "üí° Use introductory words: È¶ñÂÖàÔºåÂÖ∂Ê¨°ÔºåÊúÄÂêé",
        "üí° Add examples from life: ‰æãÂ¶ÇÔºåÊúâ‰∏ÄÊ¨°...",
        "üí° Use complex sentences with Âõ†‰∏∫...ÊâÄ‰ª•...",
        "üí° Don't forget particles ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó",
        "üí° In conclusion summarize: ÊÄªËÄåË®Ä‰πã..."
    ];
    
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    alert(randomHint);
}

async function submitEssayForCheck() {
    const essayText = document.getElementById('essayText').value.trim();
    
    if (!essayText) {
        alert('Write an essay before submitting!');
        return;
    }
    
    // TEMPORARY: local check
    const mockResult = {
        overall_score: Math.min(90, Math.max(60, Math.floor(essayText.length / 10))),
        categories: [
            { name: 'Grammar', score: 75, feedback: 'Good, but errors in particles' },
            { name: 'Vocabulary', score: 80, feedback: 'Varied vocabulary' },
            { name: 'Structure', score: 85, feedback: 'Logical organization' },
            { name: 'Content', score: 90, feedback: 'Fully relevant to topic' }
        ],
        errors: essayText.length > 100 ? [
            { position: 20, error: 'Incorrect use of ‰∫Ü', correction: 'Use ‰∫Ü only for completed actions' }
        ] : [],
        recommendations: 'Continue practicing. Pay attention to particles ‰∫Ü, ÁöÑ, Âú∞, Âæó.'
    };
    
    showEssayResult(mockResult, essayText);
}
// Show essay check result
function showEssayResult(result, essayText) {
    // Hide writing area
    document.getElementById('essayWritingArea').style.display = 'none';
    
    // Show result area
    const resultSection = document.getElementById('essayResultSection');
    resultSection.style.display = 'block';
    
    // Overall score
    const overallScoreDiv = document.getElementById('essayOverallScore');
    const score = result.overall_score || Math.floor(Math.random() * 30) + 70; // Fallback
    
    overallScoreDiv.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
            <div style="text-align: center;">
                <div style="font-size: 3em; font-weight: bold; color: ${getScoreColor(score)}">${score}/100</div>
                <div style="color: var(--gray);">Overall Score</div>
            </div>
            <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
            <div style="text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">HSK ${currentEssayData.hskLevel}</div>
                <div style="color: var(--gray);">Target Level</div>
            </div>
            <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
            <div style="text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; color: var(--success);">${essayText.length}</div>
                <div style="color: var(--gray);">Characters</div>
            </div>
        </div>
    `;
    
    // Detailed analysis
    const detailedDiv = document.getElementById('essayDetailedAnalysis');
    
    let analysisHTML = `
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-chart-pie"></i> Score by Categories:
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    `;
    
    // Scoring categories
    const categories = result.categories || [
        { name: 'Grammar', score: Math.floor(Math.random() * 20) + 75, feedback: 'Good, but errors in particles' },
        { name: 'Vocabulary', score: Math.floor(Math.random() * 20) + 70, feedback: 'Use more varied words' },
        { name: 'Structure', score: Math.floor(Math.random() * 20) + 80, feedback: 'Logical text organization' },
        { name: 'Content', score: Math.floor(Math.random() * 20) + 85, feedback: 'Relevant to topic, good examples' }
    ];
    
    categories.forEach(cat => {
        analysisHTML += `
            <div class="stat-card">
                <h3>${cat.name}</h3>
                <div class="stat-number">${cat.score}/100</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${cat.score}%; background: ${getScoreColor(cat.score)}"></div>
                </div>
                <div class="stat-desc">${cat.feedback || ''}</div>
            </div>
        `;
    });
    
    analysisHTML += `
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--warning); margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i> Found Errors:
            </h4>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
    `;
    
    // Error list
    const errors = result.errors || [
        { position: 15, error: '‰∫Ü used out of place', correction: 'Remove ‰∫Ü or use elsewhere' },
        { position: 42, error: 'Incorrect word order', correction: 'Should be: ÊàëÂéªÂ≠¶Ê†°Ôºå‰∏çÊòØÂ≠¶Ê†°ÂéªÊàë' }
    ];
    
    if (errors.length > 0) {
        errors.forEach((err, index) => {
            analysisHTML += `
                <div style="margin-bottom: ${index < errors.length - 1 ? '15px' : '0'}; padding-bottom: ${index < errors.length - 1 ? '15px' : '0'}; 
                            border-bottom: ${index < errors.length - 1 ? '1px solid #ffc107' : 'none'}">
                    <div style="font-weight: bold; color: var(--danger);">
                        <i class="fas fa-times-circle"></i> Error ${index + 1}:
                    </div>
                    <div style="margin: 5px 0; font-family: 'SimSun', serif;">${err.error}</div>
                    <div style="color: var(--success);">
                        <i class="fas fa-check-circle"></i> Correction: ${err.correction}
                    </div>
                </div>
            `;
        });
    } else {
        analysisHTML += `<p style="color: var(--success);"><i class="fas fa-check-circle"></i> No serious errors found!</p>`;
    }
    
    analysisHTML += `
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--success); margin-bottom: 15px;">
                <i class="fas fa-star"></i> Improvement Recommendations:
            </h4>
            <div class="word-tip">
                ${result.recommendations || `
                <ul>
                    <li>Use more complex sentences with ËôΩÁÑ∂...‰ΩÜÊòØ...</li>
                    <li>Add introductory words: È¶ñÂÖàÔºåÂÖ∂Ê¨°ÔºåÊúÄÂêé</li>
                    <li>Use synonyms to avoid repetitions</li>
                    <li>Pay attention to particles ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó</li>
                    <li>Practice writing essays regularly</li>
                </ul>
                `}
            </div>
        </div>
        
        <div>
            <h4 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-history"></i> Writing Statistics:
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                        ${Math.floor((new Date() - currentEssayData.startTime) / 1000 / 60)} min
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Time</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                        ${Math.floor(essayText.length / ((new Date() - currentEssayData.startTime) / 1000 / 60))}Â≠ó/min
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Speed</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                        ${Math.floor(essayText.split('Ôºå').length + essayText.split('„ÄÇ').length)}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Sentences</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                        ${new Set(essayText.split('')).size}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Unique Characters</div>
                </div>
            </div>
        </div>
    `;
    
    detailedDiv.innerHTML = analysisHTML;
    
    // Scroll to result
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// Functions for translation mode
function setTranslationDifficulty(difficulty) {
    // Reset active buttons
    document.querySelectorAll('.trans-difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Activate selected button
    const activeBtn = document.querySelector(`.trans-difficulty-btn[data-difficulty="${difficulty}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    document.getElementById('translationDifficulty').value = difficulty;
    
    // Update example
    updateTranslationExample();
}

// Update example text for translation
function updateTranslationExample() {
    const topic = document.getElementById('translationTopic').value;
    const difficulty = document.getElementById('translationDifficulty').value;
    
    const examples = {
        'news': {
            'easy': 'Today in Beijing the weather is good. Temperature 25 degrees. Many tourists walk in the park.',
            'medium': 'Yesterday a new technology center opened in Shanghai. It will conduct research in artificial intelligence. The center is expected to create 500 new jobs.',
            'hard': 'Chinese company Huawei presented a new line of smartphones with improved cameras and advanced artificial intelligence system. Devices are equipped with self-developed processors and support 5G network.',
            'expert': 'Within the "Belt and Road" initiative China continues to invest in infrastructure projects in Central Asian countries. These investments not only strengthen economic ties but also promote cultural exchange between peoples.'
        },
        'story': {
            'easy': 'A little boy went to the park. He saw a beautiful butterfly. The butterfly was yellow.',
            'medium': 'Once an old fisherman went to the river. He caught a golden fish. The fish could grant wishes.',
            'hard': 'In ancient China lived a wise elder who knew the secret of longevity. Every morning he climbed Mount Taishan to meet the dawn and practice tai chi.',
            'expert': 'According to ancient legend, Emperor Qin Shi Huang sent an expedition east in search of the elixir of immortality. The travelers faced numerous trials but never found the desired elixir.'
        }
    };

    const exampleDiv = document.getElementById('translationExample');
    
    if (topic && examples[topic] && examples[topic][difficulty]) {
        exampleDiv.innerHTML = `<strong>Example (${difficulty}):</strong><br>${examples[topic][difficulty]}`;
    } else {
        exampleDiv.innerHTML = 'Select a topic and difficulty to see an example...';
    }
}

// Generate translation text
// Generate translation text - FIXED VERSION
async function generateTranslationText() {
    const topic = document.getElementById('translationTopic').value;
    const difficulty = document.getElementById('translationDifficulty').value;
    const length = document.getElementById('translationLength').value;
    const hskLevel = document.getElementById('translationHskLevel').value;
    
    if (!topic) {
        alert('Choose a topic for translation!');
        return;
    }
    
    // Show loading
    const generateBtn = document.getElementById('generateTranslationTextBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating text...';
    generateBtn.disabled = true;
    
    try {
        // Hide previous results
        document.getElementById('translationResultSection').style.display = 'none';
        
        const requestData = {
            topic: topic,
            description: "",
            difficulty: difficulty,
            length: length,
            hsk_level: hskLevel,
            user_id: currentUser?.user_id || null,
            include_emojis: true,
            manga_style: false
        };
        
        console.log("Sending generation request:", requestData);
        
        const response = await fetch(`${API_BASE}/translation/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log("Received result:", result);
        
        // Save translation data
        currentTranslationData = {
            original_text: result.text,
            topic: topic,
            difficulty: difficulty,
            hskLevel: hskLevel,
            startTime: new Date(),
            target_hsk: hskLevel,
            result: result
        };
        
        // IMPORTANT: Show translation area AFTER receiving data
        document.getElementById('translationArea').style.display = 'block';
        
        // Update text
        document.getElementById('originalTranslationText').textContent = result.text;
        
        // Clear translation field
        document.getElementById('translationText').value = '';
        
        // Reset counter
        document.getElementById('transCharCount').textContent = '0';
        
        // Reset timer
        translationTimeLeft = 25 * 60;
        if (document.getElementById('translationTimer')) {
            document.getElementById('translationTimer').textContent = '25:00';
            document.getElementById('translationTimer').style.background = '';
        }
        
        // Scroll to translation area
        document.getElementById('translationArea').scrollIntoView({ behavior: 'smooth' });
        
        showNotification('‚úÖ Text generated! Start translation.');
        
    } catch (error) {
        console.error('Error generating text:', error);
        showNotification('‚ùå Error generating text');
        
        // Fallback - show text ANYWAY
        generateFallbackTranslationText(topic, difficulty);
        
    } finally {
        // ALWAYS restore button
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Fallback generation of translation text
// Fallback generation of translation text - FIXED VERSION
function generateFallbackTranslationText(topic, difficulty) {
    // Hide previous translation results
    const translationResultSection = document.getElementById('translationResultSection');
    if (translationResultSection) {
        translationResultSection.style.display = 'none';
    }
    const fallbackTexts = {
        'news': {
            'easy': 'Yesterday in Beijing, the traditional lantern festival took place. Thousands of people gathered on the square.',
            'medium': 'Chinese scientists have developed new water purification technology. This technology can help solve river pollution problems.',
            'hard': 'As part of the "Digital Silk Road" project, China plans to create an international e-commerce platform that will unite entrepreneurs from different countries.',
            'expert': 'According to the latest statistics, exports of Chinese electronics have grown by 15% compared to last year, indicating recovery of the global economy after the pandemic.'
        },
        'story': {
            'easy': 'A little girl found a kitten in the yard. The kitten was black and white and very hungry.',
            'medium': 'Long ago in a small village lived a poor peasant. One day he found a magic pot that could cook rice without fire.',
            'hard': 'Legend says that during the Tang dynasty, poet Li Bai, after drinking wine under the moon, wrote his most famous poems about friendship and loneliness.',
            'expert': 'During the Ming dynasty, a young scholar who failed the state exam embarked on a journey across the country, during which he discovered true wisdom hidden in the hearts of ordinary people.'
        },
        'dialogue': {
            'easy': '‚Äî Hello! How are you? ‚Äî Thank you, good! And you? ‚Äî I am good too.',
            'medium': '‚Äî Excuse me, what time is it? ‚Äî It is two o\'clock. ‚Äî Thank you! ‚Äî You\'re welcome.',
            'hard': '‚Äî Could you tell me how to get to the museum? ‚Äî Go straight, then turn left. ‚Äî Thank you very much! ‚Äî You\'re welcome.',
            'expert': '‚Äî What are your plans for the weekend? ‚Äî I am going to visit an exhibition of traditional Chinese art. ‚Äî Great idea! I heard there will be unique exhibits there.'
        }
    };
    
    // Get text by topic and difficulty
    let fallbackText = "This is a text for translation into Chinese. It contains several sentences of varying complexity.";
    
    if (fallbackTexts[topic] && fallbackTexts[topic][difficulty]) {
        fallbackText = fallbackTexts[topic][difficulty];
    } else if (fallbackTexts[topic]) {
        // Use medium difficulty as fallback
        fallbackText = fallbackTexts[topic]['medium'] || fallbackTexts[topic]['easy'] || fallbackText;
    }
    
    // IMPORTANT: Do not overwrite currentTranslationData if it already exists
    if (!currentTranslationData) {
        currentTranslationData = {
            original_text: fallbackText,
            topic: topic,
            difficulty: difficulty,
            startTime: new Date(),
            fallback: true
        };
    }
    
    // SHOW TRANSLATION AREA (safely)
    const translationArea = document.getElementById('translationArea');
    if (translationArea) {
        translationArea.style.display = 'block';
        const originalTextElement = document.getElementById('originalTranslationText');
        if (originalTextElement) {
            originalTextElement.textContent = fallbackText;
        }
    }
    
    // Clear translation field
    const translationTextElement = document.getElementById('translationText');
    if (translationTextElement) {
        translationTextElement.value = '';
    }
    
    // Reset counter
    const charCountElement = document.getElementById('transCharCount');
    if (charCountElement) {
        charCountElement.textContent = '0';
    }
    
    // Scroll only if element exists
    if (translationArea) {
        translationArea.scrollIntoView({ behavior: 'smooth' });
    }
    
    showNotification('üìù Using fallback text. Start translation.');
}

function updateTranslationCounter() {
    const text = document.getElementById('translationText').value;
    const charCount = text.length;
    document.getElementById('transCharCount').textContent = charCount;
}

// Other functions for translation
function startTranslationTimer() {
    clearInterval(translationTimer);
    
    translationTimer = setInterval(() => {
        translationTimeLeft--;
        
        const minutes = Math.floor(translationTimeLeft / 60);
        const seconds = translationTimeLeft % 60;
        document.getElementById('translationTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (translationTimeLeft < 300) {
            document.getElementById('translationTimer').style.background = 'var(--danger)';
        }
        
        if (translationTimeLeft <= 0) {
            clearInterval(translationTimer);
            alert('Time\'s up! Translation will be automatically sent for checking.');
            submitTranslationForCheck();
        }
    }, 1000);
}

// Submit translation for checking
// Submit translation for checking - FIXED VERSION
async function submitTranslationForCheck() {
    const translationText = document.getElementById('translationText').value.trim();
    
    if (!translationText) {
        alert('Enter your translation!');
        return;
    }
    
    // Stop timer
    clearInterval(translationTimer);
    
    // Save original content
    const translationArea = document.getElementById('translationArea');
    const originalContent = translationArea.innerHTML;
    
    // Show loading
    translationArea.innerHTML = `
        <div style="text-align: center; padding: 50px 0;">
            <div class="loading-spinner" style="margin: 0 auto;"></div>
            <h3 style="margin-top: 20px; color: var(--primary);">AI is checking your translation...</h3>
            <p style="color: var(--gray);">Comparing with perfect translation</p>
        </div>
    `;
    
    try {
        const requestData = {
            original_text: currentTranslationData?.original_text || 'Text for translation',
            user_translation: translationText,
            target_hsk: currentTranslationData?.target_hsk || currentTranslationData?.hskLevel || 4,
            difficulty: currentTranslationData?.difficulty || 'medium',
            user_id: currentUser?.user_id || null,
            time_spent: Math.floor((new Date() - (currentTranslationData?.startTime || new Date())) / 1000),
            mode: 'translation_check'
        };
        
        console.log("Sending translation check request:", requestData);
        
        // Try several possible endpoints
        let response;
        try {
            // Try main endpoint
            response = await fetch(`${API_BASE}/translation/check`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
        } catch (firstError) {
            console.log("First endpoint failed, trying alternative...");
            try {
                // Try essay endpoint
                response = await fetch(`${API_BASE}/essay/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...requestData,
                        mode: 'translation'
                    })
                });
            } catch (secondError) {
                console.log("Second endpoint failed, using local check");
                throw new Error("API unavailable, using local check");
            }
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log("Received check result:", result);
        
        // Save result
        currentTranslationData = {
            ...currentTranslationData,
            result: result,
            userTranslation: translationText,
            score: result.overall_score || 0,
            completed_at: new Date().toISOString()
        };
        
        // Show result
        showTranslationResult(result, translationText);
        
    } catch (error) {
        console.error('Error checking translation:', error);
        
        // Restore original content
        translationArea.innerHTML = originalContent;
        
        // Show local check
        showLocalTranslationCheck(translationText);
    }
}

// Local translation check
function showLocalTranslationCheck(userTranslation) {
    const translationArea = document.getElementById('translationArea');
    const resultSection = document.getElementById('translationResultSection');
    
    if (!translationArea || !resultSection) return;
    
    translationArea.style.display = 'none';
    resultSection.style.display = 'block';
    
    // Generate local result
    const originalText = currentTranslationData?.original_text || "Example text for translation";
    const idealTranslation = generateIdealTranslation(originalText);
    const score = calculateRealisticScore(userTranslation, idealTranslation);
    
    const result = {
        overall_score: score,
        ideal_translation: idealTranslation,
        categories: [
            { name: 'Accuracy', score: Math.floor(score * 0.9), feedback: 'Meaning translated mostly correctly' },
            { name: 'Grammar', score: Math.floor(score * 0.85), feedback: 'There are minor errors' },
            { name: 'Vocabulary', score: Math.floor(score * 0.95), feedback: 'Good word choice' },
            { name: 'Naturalness', score: Math.floor(score * 0.8), feedback: 'Could be made more natural' }
        ],
        errors: userTranslation.length < 10 ? [
            { position: 1, error: 'Translation too short', correction: 'Try adding more details' }
        ] : [],
        recommendations: `
            <ul>
                <li>Pay attention to word order in Chinese</li>
                <li>Use more complex sentences</li>
                <li>Check usage of particles ‰∫Ü, ÁöÑ, Âú∞, Âæó</li>
            </ul>
        `
    };
    
    currentTranslationData.result = result;
    currentTranslationData.userTranslation = userTranslation;
    currentTranslationData.score = score;
    
    showTranslationResult(result, userTranslation);
}

// Function to generate ideal translation
function generateIdealTranslation(originalText) {
    const translations = {
        "Today in Beijing the weather is good.": "‰ªäÂ§©Âåó‰∫¨Â§©Ê∞îÂæàÂ•Ω„ÄÇ",
        "Temperature is 25 degrees.": "Ê∏©Â∫¶ÊòØ25Â∫¶„ÄÇ",
        "Many tourists walk in the park.": "ÂæàÂ§öÊ∏∏ÂÆ¢Âú®ÂÖ¨Âõ≠ÈáåÊï£Ê≠•„ÄÇ",
        "Yesterday in Shanghai a new technology center opened.": "Êò®Â§©Âú®‰∏äÊµ∑ÂºÄ‰∫ÜÊñ∞ÁöÑÁßëÊäÄ‰∏≠ÂøÉ„ÄÇ",
        "It will conduct research in artificial intelligence.": "ÂÆÉÂ∞ÜËøõË°å‰∫∫Â∑•Êô∫ËÉΩÁ†îÁ©∂„ÄÇ",
        "It is expected that the center will create 500 new jobs.": "È¢ÑËÆ°‰∏≠ÂøÉÂ∞ÜÂàõÈÄ†500‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂ≤ó‰Ωç„ÄÇ",
        "This is example text for translation.": "ËøôÊòØ‰∏Ä‰∏™ÁøªËØëÁªÉ‰π†ÁöÑ‰æãÂ≠ê„ÄÇ",
        "I have been studying Chinese for two years already.": "ÊàëÂ≠¶‰π†‰∏≠ÊñáÂ∑≤Áªè‰∏§Âπ¥‰∫Ü„ÄÇ",
        "Chinese culture is very interesting and diverse.": "‰∏≠ÂõΩÊñáÂåñÈùûÂ∏∏ÊúâË∂£ÂíåÂ§öÊ†∑„ÄÇ"
    };
    
    return translations[originalText] || "This is a good translation exercise. Keep up the good work!";
}

// Show translation check result
// Update score calculation in showTranslationResult:
function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    if (score >= 60) return '#ff9a00';
    return 'var(--danger)';
}

function calculateRealisticScore(userTranslation, idealTranslation) {
    if (!userTranslation || !idealTranslation) return 0;
    
    let score = 0;
    
    // 1. Text length (max 20 points)
    const userLength = userTranslation.length;
    const idealLength = idealTranslation.length;
    const lengthRatio = Math.min(1, userLength / Math.max(10, idealLength));
    score += Math.round(lengthRatio * 20);
    
    // 2. Number of Chinese characters (max 30 points)
    const chineseChars = countChineseCharacters(userTranslation);
    const minRequired = Math.max(3, idealTranslation.replace(/[^\u4e00-\u9fff]/g, '').length * 0.3);
    
    if (chineseChars >= minRequired) {
        score += Math.min(30, (chineseChars / minRequired) * 30);
    }
    
    // 3. Similarity to ideal translation (max 50 points)
    const similarity = calculateTranslationSimilarity(userTranslation, idealTranslation);
    score += Math.round(similarity * 0.5);
    
    // 4. Penalty for obvious errors
    if (chineseChars === 0) {
        score = Math.max(0, score - 30);
    }
    
    if (userTranslation.length < 5) {
        score = Math.max(0, score - 20);
    }
    
    return Math.min(100, Math.max(0, score));
}

function countChineseCharacters(text) {
    const chineseRegex = /[\u4e00-\u9fff]/g;
    const matches = text.match(chineseRegex);
    return matches ? matches.length : 0;
}

function calculateTranslationSimilarity(userText, idealText) {
    if (!userText || !idealText) return 0;
    
    const user = userText.toLowerCase().replace(/\s+/g, '');
    const ideal = idealText.toLowerCase().replace(/\s+/g, '');
    
    if (user === ideal) return 100;
    
    // Simple comparison by length and common characters
    const lengthSimilarity = 1 - Math.abs(user.length - ideal.length) / Math.max(user.length, ideal.length);
    
    const userChars = new Set(user);
    const idealChars = new Set(ideal);
    let common = 0;
    
    for (const char of userChars) {
        if (idealChars.has(char)) common++;
    }
    
    const charSimilarity = (common * 2) / (userChars.size + idealChars.size);
    
    return Math.round((lengthSimilarity * 0.3 + charSimilarity * 0.7) * 100);
}

function generateIdealTranslation(originalText) {
    // Simple fallback translation
    const translations = {
        "Today in Beijing the weather is good.": "‰ªäÂ§©Âåó‰∫¨Â§©Ê∞îÂæàÂ•Ω„ÄÇ",
        "Temperature is 25 degrees.": "Ê∏©Â∫¶ÊòØ25Â∫¶„ÄÇ",
        "Many tourists walk in the park.": "ÂæàÂ§öÊ∏∏ÂÆ¢Âú®ÂÖ¨Âõ≠ÈáåÊï£Ê≠•„ÄÇ",
        "Yesterday in Shanghai a new technology center opened.": "Êò®Â§©Âú®‰∏äÊµ∑ÂºÄ‰∫ÜÊñ∞ÁöÑÁßëÊäÄ‰∏≠ÂøÉ„ÄÇ",
        "It will conduct research in artificial intelligence.": "ÂÆÉÂ∞ÜËøõË°å‰∫∫Â∑•Êô∫ËÉΩÁ†îÁ©∂„ÄÇ",
        "It is expected that the center will create 500 new jobs.": "È¢ÑËÆ°‰∏≠ÂøÉÂ∞ÜÂàõÈÄ†500‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂ≤ó‰Ωç„ÄÇ"
    };
    
    return translations[originalText] || "This is a good translation exercise. Keep practicing!";
}

// Show translation check result - FIXED VERSION
// Updated showTranslationResult function with element creation
function showTranslationResult(result, userTranslation) {
    console.log("Showing translation result:", result);
    
    // Find or create DOM elements
    const translationArea = document.getElementById('translationArea');
    let resultSection = document.getElementById('translationResultSection');
    
    // If result section doesn't exist, create it
    if (!resultSection) {
        console.log("Result section not found, creating new...");
        resultSection = createTranslationResultSection();
    }
    
    if (!translationArea) {
        console.error('translationArea not found');
        return;
    }
    
    // Hide translation area
    translationArea.style.display = 'none';
    
    // Show result section
    resultSection.style.display = 'block';
    
    // Fix score calculation
    const actualScore = result.overall_score || 
                       calculateRealisticScore(userTranslation, 
                                             result.ideal_translation || 
                                             generateIdealTranslation(currentTranslationData?.original_text || ''));
    
    console.log("Calculated score:", actualScore);
    
    // Fill result section content
    fillTranslationResultSection(resultSection, result, userTranslation, actualScore);
    
    // Scroll to result
    resultSection.scrollIntoView({ behavior: 'smooth' });
    
    // Save result
    if (currentTranslationData) {
        currentTranslationData.result = result;
        currentTranslationData.userTranslation = userTranslation;
        currentTranslationData.score = actualScore;
        currentTranslationData.completed_at = new Date().toISOString();
    }
    
    console.log("Translation result successfully shown");
}

// Create translation result section
function createTranslationResultSection() {
    console.log("Creating translation result section...");
    
    const translationArea = document.getElementById('translationArea');
    if (!translationArea) return null;
    
    // Create result container
    const resultSection = document.createElement('div');
    resultSection.id = 'translationResultSection';
    resultSection.style.display = 'none';
    resultSection.style.marginTop = '30px';
    
    // Basic structure
    resultSection.innerHTML = `
        <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-chart-line"></i> Translation Check Result
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="retryTranslation()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="btn btn-success" onclick="saveTranslationResult()">
                        <i class="fas fa-download"></i> Save Report
                    </button>
                </div>
            </div>
            
            <!-- Overall score -->
            <div id="translationOverallScore" style="text-align: center; margin-bottom: 30px;">
                <!-- Overall score will appear here -->
            </div>
            
            <!-- Comparison -->
            <div id="translationComparison" style="margin-bottom: 30px;">
                <!-- Comparison will appear here -->
            </div>
            
            <!-- Detailed analysis -->
            <div id="translationDetailedAnalysis">
                <!-- Detailed analysis will appear here -->
            </div>
        </div>
    `;
    
    // Insert after translationArea
    translationArea.parentNode.insertBefore(resultSection, translationArea.nextSibling);
    
    return resultSection;
}

// Fill result section
function fillTranslationResultSection(resultSection, result, userTranslation, score) {
    // Overall score
    const overallScoreDiv = resultSection.querySelector('#translationOverallScore');
    if (overallScoreDiv) {
        overallScoreDiv.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="font-size: 3em; font-weight: bold; color: ${getScoreColor(score)}">${score}/100</div>
                    <div style="color: var(--gray);">Overall Score</div>
                </div>
                <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">
                        HSK ${currentTranslationData?.target_hsk || currentTranslationData?.hskLevel || 4}
                    </div>
                    <div style="color: var(--gray);">Target Level</div>
                </div>
                <div style="height: 80px; width: 2px; background: #dee2e6;"></div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5em; font-weight: bold; color: var(--success);">${userTranslation.length}</div>
                    <div style="color: var(--gray);">Characters</div>
                </div>
            </div>
        `;
    }
    
    // Translation comparison
    const comparisonDiv = resultSection.querySelector('#translationComparison');
    if (comparisonDiv) {
        const idealTranslation = result.ideal_translation || generateIdealTranslation(currentTranslationData?.original_text || '');
        const similarity = calculateTranslationSimilarity(userTranslation, idealTranslation);
        
        comparisonDiv.innerHTML = `
            <h4 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-exchange-alt"></i> Translation Comparison:
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <div style="font-weight: bold; color: var(--success); margin-bottom: 10px;">
                        <i class="fas fa-user"></i> Your Translation:
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; min-height: 150px;">
                        ${userTranslation.replace(/\n/g, '<br>')}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                        ${countChineseCharacters(userTranslation)} Chinese characters
                    </div>
                </div>
                
                <div>
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                        <i class="fas fa-robot"></i> AI Perfect Translation:
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 150px;">
                        ${idealTranslation.replace(/\n/g, '<br>')}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                        AI Recommendation
                    </div>
                </div>
            </div>
            
            <div class="word-tip" style="margin-bottom: 20px;">
                <strong>Similarity:</strong> ${similarity}%
                ${score >= 85 ? 'üéâ Excellent work!' : score >= 70 ? 'üëç Good, could be better' : 'üí™ Keep practicing'}
            </div>
        `;
    }
    
    // Detailed analysis
    const detailedDiv = resultSection.querySelector('#translationDetailedAnalysis');
    if (detailedDiv) {
        const categories = result.categories || [
            { 
                name: 'Accuracy', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 70), 
                feedback: 'Meaning translated correctly' 
            },
            { 
                name: 'Grammar', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 65), 
                feedback: 'There are errors in constructions' 
            },
            { 
                name: 'Vocabulary', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 75), 
                feedback: 'Good vocabulary' 
            },
            { 
                name: 'Naturalness', 
                score: Math.max(60, Math.floor(Math.random() * 20) + 60), 
                feedback: 'Could be made more natural' 
            }
        ];
        
        const errors = result.errors || [];
        
        detailedDiv.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-chart-pie"></i> Score by Categories:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${categories.map(cat => `
                        <div class="stat-card">
                            <h3>${cat.name}</h3>
                            <div class="stat-number">${cat.score}/100</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${cat.score}%; background: ${getScoreColor(cat.score)}"></div>
                            </div>
                            <div class="stat-desc">${cat.feedback || ''}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--warning); margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Found Errors:
                </h4>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                    ${errors.length > 0 ? errors.map((err, index) => `
                        <div style="margin-bottom: ${index < errors.length - 1 ? '15px' : '0'}; padding-bottom: ${index < errors.length - 1 ? '15px' : '0'}; 
                                    border-bottom: ${index < errors.length - 1 ? '1px solid #ffc107' : 'none'}">
                            <div style="font-weight: bold; color: var(--danger);">
                                <i class="fas fa-times-circle"></i> Error ${index + 1}:
                            </div>
                            <div style="margin: 5px 0; font-family: 'SimSun', serif;">${err.error || 'Unknown error'}</div>
                            <div style="color: var(--success);">
                                <i class="fas fa-check-circle"></i> Correction: ${err.correction || 'Check grammar'}
                            </div>
                        </div>
                    `).join('') : '<p style="color: var(--success);"><i class="fas fa-check-circle"></i> No serious errors found!</p>'}
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--success); margin-bottom: 15px;">
                    <i class="fas fa-star"></i> Improvement Recommendations:
                </h4>
                <div class="word-tip">
                    ${result.recommendations || `
                    <ul>
                        <li>Study basic word order in Chinese: Subject + Predicate + Object</li>
                        <li>Pay attention to usage of particles ‰∫ÜÔºåÁöÑÔºåÂú∞ÔºåÂæó</li>
                        <li>Practice translating short sentences daily</li>
                        <li>Use Pleco or other dictionaries to check words</li>
                        <li>Read Chinese texts at your HSK level</li>
                    </ul>
                    `}
                </div>
            </div>
            
            <div>
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-history"></i> Translation Statistics:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                            ${Math.floor((new Date() - (currentTranslationData?.startTime || new Date())) / 1000 / 60)} min
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Time</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                            ${Math.floor(userTranslation.length / Math.max(1, (new Date() - (currentTranslationData?.startTime || new Date())) / 1000 / 60))}Â≠ó/min
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Speed</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                            ${new Set(userTranslation.match(/[\u4e00-\u9fff]/g) || []).size}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Unique Characters</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                            ${userTranslation.split(/[Ôºå„ÄÇÔºÅÔºü]/).filter(s => s.trim()).length}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Sentences</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Helper function for getting color by score
function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

// New function for realistic scoring
function calculateRealisticScore(userTranslation, idealTranslation) {
    if (!userTranslation || !idealTranslation) return 0;
    
    let score = 0;
    
    // 1. Text length (max 20 points)
    const userLength = userTranslation.length;
    const idealLength = idealTranslation.length;
    const lengthRatio = Math.min(1, userLength / Math.max(10, idealLength));
    score += Math.round(lengthRatio * 20);
    
    // 2. Number of Chinese characters (max 30 points)
    const chineseChars = countChineseCharacters(userTranslation);
    const minRequired = Math.max(3, idealTranslation.replace(/[^\u4e00-\u9fff]/g, '').length * 0.3);
    
    if (chineseChars >= minRequired) {
        score += Math.min(30, (chineseChars / minRequired) * 30);
    }
    
    // 3. Similarity to ideal translation (max 50 points)
    const similarity = calculateTranslationSimilarity(userTranslation, idealTranslation);
    score += Math.round(similarity * 0.5);
    
    // 4. Penalty for obvious errors
    // Check for presence of Chinese characters
    if (chineseChars === 0) {
        score = Math.max(0, score - 30);
    }
    
    // Check for too short text
    if (userTranslation.length < 5) {
        score = Math.max(0, score - 20);
    }
    
    // Limit maximum to 100
    return Math.min(100, Math.max(0, score));
}

// Helper functions
function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

function clearTimers() {
    clearInterval(essayTimer);
    clearInterval(translationTimer);
}

function cancelEssayWriting() {
    if (confirm('Cancel essay writing? All text will be lost.')) {
        clearInterval(essayTimer);
        document.getElementById('essayWritingArea').style.display = 'none';
        document.getElementById('essayModeContent').style.display = 'block';
    }
}

function cancelTranslation() {
    if (confirm('Cancel translation? All text will be lost.')) {
        clearInterval(translationTimer);
        document.getElementById('translationArea').style.display = 'none';
        document.getElementById('translationModeContent').style.display = 'block';
    }
}

function retryEssay() {
    document.getElementById('essayResultSection').style.display = 'none';
    startEssayWriting();
}

function retryTranslation() {
    document.getElementById('translationResultSection').style.display = 'none';
    generateTranslationText();
}

function saveEssayResult() {
    if (!currentEssayData) return;
    
    const data = {
        type: 'essay_check',
        data: currentEssayData,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `essay_check_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ Report saved!');
}

function saveTranslationResult() {
    if (!currentTranslationData) return;
    
    const data = {
        type: 'translation_check',
        data: currentTranslationData,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `translation_check_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ Report saved!');
}

// Initialize when loading tab
function initEssayChecker() {
    updateEssayRequirements();
    updateTranslationExample();
    
    // Initialize HSK buttons
    setEssayHskLevel(4);
    
    // Initialize translation difficulty buttons
    setTranslationDifficulty('medium');
}
        // Chat system
let currentChatId = null;
let userChats = {};
let currentHskTest = null;
let testTimer = null;
let testTimeLeft = 0;
        let testAnswers = {};

        // Authorization system
let currentUser = null;

// Voice chat
let voiceRecognition = null;
let isRecording = false;
let voiceChatHistory = [];
let learnedChengyu = [];
let currentVoiceThread = null;
let voiceChatSessions = [];

// Text generator
let generatedTextsHistory = [];
let currentGeneratedText = null;

// Load history
function loadTextHistory() {
    try {
        const saved = localStorage.getItem('hsk_generated_texts');
        if (saved) {
            generatedTextsHistory = JSON.parse(saved);
            updateHistoryList();
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

// Update history list
function updateHistoryList() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    if (generatedTextsHistory.length === 0) {
        historyList.innerHTML = '<p style="color: var(--gray); text-align: center;">History is empty</p>';
        return;
    }
    
    historyList.innerHTML = generatedTextsHistory.slice(0, 5).map((item, index) => `
        <div style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; 
                    border-left: 4px solid var(--primary); cursor: pointer;" 
             onclick="loadTextFromHistory(${generatedTextsHistory.length - 1 - index})">
            <div style="font-weight: bold; display: flex; justify-content: space-between;">
                <span>${item.topic.substring(0, 40)}${item.topic.length > 40 ? '...' : ''}</span>
                <span style="font-size: 0.8em; color: var(--gray);">HSK ${item.hskLevel}</span>
            </div>
            <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                ${new Date(item.timestamp).toLocaleDateString('ru-RU')} ‚Ä¢ 
                ${item.format === 'chinese_only' ? 'Characters only' : 
                  item.format === 'manga' ? 'Manga' : 'Full format'}
            </div>
        </div>
    `).join('');
}

// Load example
function loadExample(type) {
    const examples = {
        'mall': {
            topic: "Dialogue in a Chinese supermarket",
            description: "Two foreigners try to buy groceries, ask about prices, look for needed items. Adventures with Chinese food."
        },
        'restaurant': {
            topic: "Ordering food in a restaurant",
            description: "Group of friends in a Beijing restaurant. They choose dishes, ask about spices, discuss taste."
        },
        'university': {
            topic: "First day at university",
            description: "Foreign student arrives at Chinese university. Meeting classmates, finding classroom, dialogues with teacher."
        },
        'travel': {
            topic: "Travel around Beijing",
            description: "Tourist visits Great Wall of China, Forbidden City, Temple of Heaven. Dialogues with guide, taxi driver, local people."
        },
        'business': {
            topic: "Business negotiations in Shanghai",
            description: "Business meeting in Shanghai skyscraper. Discussing contract, cultural differences, price negotiations."
        }
    };
    
    if (examples[type]) {
        document.getElementById('textTopic').value = examples[type].topic;
        document.getElementById('textDescription').value = examples[type].description;
    }
}

// Helper functions for translation checking
function calculateTranslationSimilarity(userText, idealText) {
    // Simple similarity assessment (real project needs more complex comparison)
    if (!userText || !idealText) return 0;
    
    // Convert to lowercase and remove spaces
    const user = userText.toLowerCase().replace(/\s+/g, '');
    const ideal = idealText.toLowerCase().replace(/\s+/g, '');
    
    if (user === ideal) return 100;
    
    // Compare length
    const lengthSimilarity = 1 - Math.abs(user.length - ideal.length) / Math.max(user.length, ideal.length);
    
    // Simple check for common characters
    const userChars = new Set(user);
    const idealChars = new Set(ideal);
    let common = 0;
    
    for (const char of userChars) {
        if (idealChars.has(char)) common++;
    }
    
    const charSimilarity = (common * 2) / (userChars.size + idealChars.size);
    
    // Average value
    return Math.round((lengthSimilarity * 0.3 + charSimilarity * 0.7) * 100);
}

function countChineseCharacters(text) {
    // Count Chinese characters
    const chineseRegex = /[\u4e00-\u9fff]/g;
    const matches = text.match(chineseRegex);
    return matches ? matches.length : 0;
}

function generateIdealTranslation(originalText) {
    // Simple translation (real project should have AI)
    const translations = {
        "Today in Beijing the weather is good.": "‰ªäÂ§©Âåó‰∫¨Â§©Ê∞îÂæàÂ•Ω„ÄÇ",
        "Temperature is 25 degrees.": "Ê∏©Â∫¶ÊòØ25Â∫¶„ÄÇ",
        "Many tourists walk in the park.": "ÂæàÂ§öÊ∏∏ÂÆ¢Âú®ÂÖ¨Âõ≠ÈáåÊï£Ê≠•„ÄÇ",
        "Yesterday in Shanghai a new technology center opened.": "Êò®Â§©Âú®‰∏äÊµ∑ÂºÄ‰∫ÜÊñ∞ÁöÑÁßëÊäÄ‰∏≠ÂøÉ„ÄÇ",
        "It will conduct research in artificial intelligence.": "ÂÆÉÂ∞ÜËøõË°å‰∫∫Â∑•Êô∫ËÉΩÁ†îÁ©∂„ÄÇ",
        "It is expected that the center will create 500 new jobs.": "È¢ÑËÆ°‰∏≠ÂøÉÂ∞ÜÂàõÈÄ†500‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂ≤ó‰Ωç„ÄÇ"
    };
    
    return translations[originalText] || "ËøôÊòØ‰∏Ä‰∏™‰∏≠ÊñáÁøªËØëÁ§∫‰æã„ÄÇ";
}

// Generate text
async function generateChineseText() {
    const topic = document.getElementById('textTopic').value.trim();
    const description = document.getElementById('textDescription').value.trim();
    const hskLevel = parseInt(document.getElementById('textHskLevel').value);
    const format = document.querySelector('input[name="textFormat"]:checked').value;
    
    if (!topic) {
        alert('Enter text topic!');
        return;
    }
    
    // Show loading
    const generateBtn = document.getElementById('generateTextBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    generateBtn.disabled = true;
    
    // Hide result if there was one
    // Hide previous translation results (if any)
const translationResultSection = document.getElementById('translationResultSection');
if (translationResultSection) {
    translationResultSection.style.display = 'none';
}

// Hide translation area (if open)
const translationArea = document.getElementById('translationArea');
if (translationArea) {
    translationArea.style.display = 'none';
}
    
    try {
        const requestData = {
            topic: topic,
            description: description,
            hsk_level: hskLevel,
            format: format,
            user_id: currentUser?.user_id || null,
            length: 'medium', // medium (~2000 characters), short, long
            include_emojis: true,
            manga_style: format === 'manga'
        };
        
        const response = await fetch(`${API_BASE}/text/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Save current text
        currentGeneratedText = data;
        
        // Display result
        displayGeneratedText(data);
        
        // Add to history
        const historyItem = {
            id: `text_${Date.now()}`,
            topic: topic,
            description: description,
            hskLevel: hskLevel,
            format: format,
            timestamp: new Date().toISOString(),
            text: data.text,
            stats: data.stats
        };
        
        generatedTextsHistory.unshift(historyItem);
        
        // Limit history
        if (generatedTextsHistory.length > 50) {
            generatedTextsHistory = generatedTextsHistory.slice(0, 50);
        }
        
        // Save history
        localStorage.setItem('hsk_generated_texts', JSON.stringify(generatedTextsHistory));
        
        // Update history list
        updateHistoryList();
        
    } catch (error) {
        console.error('Error generating text:', error);
        alert('Error generating text. Check internet connection.');
        
        // Show example
        showFallbackText(topic, hskLevel, format);
        
    } finally {
        // Restore button
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Display generated text
function displayGeneratedText(data) {
    const resultSection = document.getElementById('textResultSection');
    const resultDiv = document.getElementById('textResult');
    const statsDiv = document.getElementById('textStats');
    
    // Show section
    resultSection.style.display = 'block';
    
    // Display text in required format
    let displayText = '';
    
    if (data.format === 'chinese_only') {
        displayText = `<div style="font-size: 18px; line-height: 1.8; font-family: 'SimSun', 'ÂÆã‰Ωì', serif;">
            ${data.text.replace(/\n/g, '<br>')}
        </div>`;
    } else if (data.format === 'full') {
        displayText = `<div style="font-family: 'Segoe UI', sans-serif;">
            ${data.text_with_pinyin || data.text.replace(/\n/g, '<br>')}
        </div>`;
    } else if (data.format === 'manga') {
        displayText = `<div style="font-family: 'SimSun', 'ÂÆã‰Ωì', serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px;">
            <div style="text-align: center; margin-bottom: 20px; font-weight: bold; color: var(--primary);">
                üéå ${data.topic}
            </div>
            ${data.text.replace(/\n/g, '<br>')}
        </div>`;
    }
    
    resultDiv.innerHTML = displayText;
    
    // Display statistics
    if (data.stats) {
        statsDiv.innerHTML = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                        ${data.stats.characters || 0}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Characters</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                        ${data.stats.unique_words || 0}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Unique Words</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                        HSK ${data.stats.hsk_level || 3}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">Difficulty Level</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                        ${data.stats.new_words || 0}
                    </div>
                    <div style="font-size: 0.9em; color: var(--gray);">New Words</div>
                </div>
            </div>
        `;
    }
    
    // Scroll to result
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// Fallback if API unavailable
function showFallbackText(topic, hskLevel, format) {
    const fallbackTexts = {
        'mall': `üè¨ **Âú®Ë∂ÖÂ∏ÇË¥≠Áâ©** üõí
        
Â∞èÁéãÔºö‰Ω†Â•ΩÔºÅËøô‰∏™ËãπÊûúÂ§öÂ∞ëÈí±Ôºüüçé
ÂîÆË¥ßÂëòÔºö‰∏ÄÊñ§ÂçÅÂùóÈí±„ÄÇüí∞
Â∞èÁéãÔºöÂ§™Ë¥µ‰∫ÜÔºÅÂèØ‰ª•‰æøÂÆú‰∏ÄÁÇπÂêóÔºüü§î
ÂîÆË¥ßÂëòÔºöÂ•ΩÂêßÔºåÁªô‰Ω†ÂÖ´Âùó„ÄÇü§ë
Â∞èÁéãÔºöË∞¢Ë∞¢ÔºÅÊàëË¶Å‰∏§Êñ§„ÄÇüôè
        
‰ªäÂ§©Ë∂ÖÂ∏ÇÈáåÁöÑ‰∫∫ÂæàÂ§öüë•ÔºåÂ§ßÂÆ∂ÈÉΩÂú®‰π∞È£üÁâ©ü•¶„ÄÇÊàëÁúãÂà∞‰∫ÜÂæàÂ§ö‰∏≠ÂõΩËèúü•¨Ôºå‰ΩÜÊòØ‰∏çËÆ§ËØÜÂêçÂ≠óüòÖ„ÄÇ`,
        
        'restaurant': `üçú **Âú®È§êÂéÖÂêÉÈ•≠** ü•¢
        
ÊúçÂä°ÂëòÔºöÊ¨¢ËøéÂÖâ‰∏¥ÔºÅüëã Âá†‰ΩçÔºü
ÊùéÊòéÔºö‰∏â‰ΩçÔºåË∞¢Ë∞¢„ÄÇüôè
ÊúçÂä°ÂëòÔºöËøôÊòØËèúÂçïüìñÔºåËØ∑ÁÇπËèú„ÄÇ
        
Â∞èÁ∫¢ÔºöÊàëÊÉ≥ÂêÉÂÆ´‰øùÈ∏°‰∏ÅüêîÔºåËæ£‰∏çËæ£Ôºüüå∂Ô∏è
ÊúçÂä°ÂëòÔºöÊúâ‰∏ÄÁÇπËæ£ÔºåÂèØ‰ª•Â∞ëÊîæËæ£Ê§í„ÄÇüëç
        
Â§ßÂÆ∂ÈÉΩÁÇπ‰∫ÜËá™Â∑±ÂñúÊ¨¢ÁöÑËèúüç≤ÔºåÈ§êÂéÖÁöÑÈü≥‰πêÂæàÂ•ΩÂê¨üéµ„ÄÇ`,
        
        'university': `üéì **Â§ßÂ≠¶Á¨¨‰∏ÄÂ§©** üìö
        
ËÄÅÂ∏àÔºöÂêåÂ≠¶‰ª¨Â•ΩÔºÅüë®‚Äçüè´ ÊàëÊòØÁéãËÄÅÂ∏à„ÄÇ
Â≠¶Áîü‰ª¨ÔºöËÄÅÂ∏àÂ•ΩÔºÅüë®‚Äçüéìüë©‚Äçüéì
        
Â§ñÂõΩÂ≠¶ÁîüÔºöÂØπ‰∏çËµ∑ÔºåÊàëÁöÑ‰∏≠Êñá‰∏çÂ•ΩüòÖ„ÄÇ
ÁéãËÄÅÂ∏àÔºöÊ≤°ÂÖ≥Á≥ªÔºåÊÖ¢ÊÖ¢Â≠¶‰π†üí™„ÄÇ
        
Â§ßÂ≠¶ÂæàÂ§ßüèõÔ∏èÔºåÊúâÂæàÂ§öÊ•º„ÄÇÂõæ‰π¶È¶ÜüìöÂú®ÊúÄ‰∏≠Èó¥ÔºåÈ£üÂ†ÇüçöÂú®Â∑¶Ëæπ„ÄÇ`
    };
    
    let fallbackKey = 'mall';
    if (topic.includes('restaurant')) fallbackKey = 'restaurant';
    if (topic.includes('university')) fallbackKey = 'university';
    
    const mockData = {
        text: fallbackTexts[fallbackKey],
        format: format,
        topic: topic,
        stats: {
            characters: 350,
            unique_words: 120,
            hsk_level: hskLevel,
            new_words: 15
        }
    };
    
    currentGeneratedText = mockData;
    displayGeneratedText(mockData);
}

// Copy text
function copyTextToClipboard() {
    if (!currentGeneratedText) return;
    
    const textToCopy = currentGeneratedText.text || currentGeneratedText.text_with_pinyin;
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification('‚úÖ Text copied to clipboard!');
    }).catch(err => {
        console.error('Error copying:', err);
        alert('Failed to copy text');
    });
}

// Save text
function saveGeneratedText() {
    if (!currentGeneratedText) return;
    
    const blob = new Blob([JSON.stringify(currentGeneratedText, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hsk_text_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ Text saved!');
}

// Speak text
function speakGeneratedText() {
    if (!currentGeneratedText || !currentGeneratedText.text) return;
    
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(currentGeneratedText.text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.pitch = 1;
        
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh-CN') || voice.lang.startsWith('zh')
        );
        
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        speechSynthesis.speak(utterance);
        showNotification('üîä Speaking started');
    } else {
        alert('Browser does not support text-to-speech');
    }
}

// Regenerate
function regenerateText() {
    if (!currentGeneratedText) return;
    
    generateChineseText();
}

// Load from history
function loadTextFromHistory(index) {
    if (index < 0 || index >= generatedTextsHistory.length) return;
    
    const item = generatedTextsHistory[index];
    
    // Fill fields
    document.getElementById('textTopic').value = item.topic;
    document.getElementById('textDescription').value = item.description;
    document.getElementById('textHskLevel').value = item.hskLevel;
    
    // Set format
    const formatRadios = document.querySelectorAll('input[name="textFormat"]');
    formatRadios.forEach(radio => {
        radio.checked = (radio.value === item.format);
    });
    
    // Show text
    currentGeneratedText = {
        text: item.text,
        format: item.format,
        topic: item.topic,
        stats: item.stats
    };
    
    displayGeneratedText(currentGeneratedText);
}

// Helper functions
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--success), #4cd964);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.5s ease;
    `;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// Load history when page loads
// Add to window.onload:
// loadTextHistory();

function initVoiceChatHistory() {
    try {
        const saved = localStorage.getItem('hsk_voice_history');
        if (saved) {
            voiceChatHistory = JSON.parse(saved);
        }
        
        const savedSessions = localStorage.getItem('hsk_voice_sessions');
        if (savedSessions) {
            voiceChatSessions = JSON.parse(savedSessions);
            updateVoiceSessionsList();
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

// Save history
function saveVoiceChatHistory() {
    try {
        // Save general history
        localStorage.setItem('hsk_voice_history', JSON.stringify(voiceChatHistory));
        
        // Save sessions
        localStorage.setItem('hsk_voice_sessions', JSON.stringify(voiceChatSessions));
    } catch (error) {
        console.error('Error saving history:', error);
    }
}
// Add message to history
function addToVoiceHistory(sender, text, type = 'normal') {
    const message = {
        id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        sender: sender,
        text: text,
        type: type,
        timestamp: new Date().toISOString(),
        sessionId: currentVoiceSessionId
    };
    
    voiceChatHistory.push(message);
    
    // Limit history size
    if (voiceChatHistory.length > 1000) {
        voiceChatHistory = voiceChatHistory.slice(-500);
    }
    
    // Update current session
    updateCurrentSession(message);
    
    saveVoiceChatHistory();
}

// Create new session
let currentVoiceSessionId = null;
function createNewVoiceSession() {
    const sessionId = `session_${Date.now()}`;
    const session = {
        id: sessionId,
        title: `Dialogue ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`,
        created: new Date().toISOString(),
        lastActivity: new Date().toISOString(),
        messageCount: 0,
        chengyuLearned: [],
        language: 'zh-CN'
    };
    
    voiceChatSessions.unshift(session);
    currentVoiceSessionId = sessionId;
    
    updateVoiceSessionsList();
    saveVoiceChatHistory();
    
    return sessionId;
}

// Update session
function updateCurrentSession(message) {
    const session = voiceChatSessions.find(s => s.id === currentVoiceSessionId);
    if (session) {
        session.lastActivity = new Date().toISOString();
        session.messageCount++;
        
        // Extract chengyu from message
        if (message.sender === 'AI') {
            const chengyuInMessage = extractChengyuFromMessage(message.text);
            chengyuInMessage.forEach(chengyu => {
                if (!session.chengyuLearned.includes(chengyu)) {
                    session.chengyuLearned.push(chengyu);
                }
            });
        }
    }
}

// Update sessions list
function updateVoiceSessionsList() {
    const container = document.getElementById('voiceSessionsList');
    if (!container) return;
    
    if (voiceChatSessions.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--gray); padding: 20px;">
                <div style="font-size: 2em;">üìÅ</div>
                <p>Dialogue history is empty</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = voiceChatSessions.map((session, index) => `
        <div class="session-item ${session.id === currentVoiceSessionId ? 'active' : ''}"
             onclick="loadVoiceSession('${session.id}')"
             style="padding: 12px; 
                    margin-bottom: 8px; 
                    border-radius: 8px; 
                    background: ${session.id === currentVoiceSessionId ? '#e3f2fd' : '#f8f9fa'};
                    border-left: 4px solid ${session.id === currentVoiceSessionId ? 'var(--primary)' : '#dee2e6'};
                    cursor: pointer;
                    transition: all 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: ${session.id === currentVoiceSessionId ? 'bold' : 'normal'}; 
                            color: var(--dark);">
                    ${session.title}
                </div>
                <div style="font-size: 0.8em; color: var(--gray);">
                    ${formatDate(session.lastActivity)}
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                <div style="font-size: 0.8em; color: var(--gray);">
                    Messages: ${session.messageCount}
                </div>
                <div style="font-size: 0.8em; color: var(--success);">
                    Chengyu: ${session.chengyuLearned.length}
                </div>
            </div>
            ${session.chengyuLearned.length > 0 ? `
                <div style="margin-top: 5px; font-size: 0.7em; color: var(--gray);">
                    ${session.chengyuLearned.slice(0, 2).join('„ÄÅ')}${session.chengyuLearned.length > 2 ? '...' : ''}
                </div>
            ` : ''}
        </div>
    `).join('');
}

// Load session
function loadVoiceSession(sessionId) {
    currentVoiceSessionId = sessionId;
    
    // Clear current chat
    document.getElementById('voiceChatBox').innerHTML = '';
    
    // Load messages of this session
    const sessionMessages = voiceChatHistory.filter(msg => msg.sessionId === sessionId);
    
    // Sort by time
    sessionMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    // Display messages
    sessionMessages.forEach(msg => {
        addVoiceMessage(msg.sender, msg.text, msg.type);
    });
    
    // Update sessions list
    updateVoiceSessionsList();
    
    // Scroll down
    const chatBox = document.getElementById('voiceChatBox');
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Export history
function exportVoiceHistory() {
    const data = {
        sessions: voiceChatSessions,
        messages: voiceChatHistory,
        exportedAt: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hsk_voice_history_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Import history
function importVoiceHistory(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.sessions) {
                voiceChatSessions = data.sessions;
            }
            
            if (data.messages) {
                voiceChatHistory = data.messages;
            }
            
            saveVoiceChatHistory();
            updateVoiceSessionsList();
            
            alert('History successfully imported!');
        } catch (error) {
            alert('Error importing history: ' + error.message);
        }
    };
    
    reader.readAsText(file);
}

async function refreshAudioHistory() {
    try {
        if (currentUser?.user_id) {
            // Load history from server
            const response = await fetch(`${API_BASE}/audio/history/${currentUser.user_id}`);
            if (response.ok) {
                const data = await response.json();
                
                // Save locally
                if (data.history && data.history.length > 0) {
                    localStorage.setItem('hsk_audio_history', JSON.stringify(data.history));
                }
            }
        }
        
        // Update display
        updateAudioHistory();
        showNotification('üîÑ History updated');
        
    } catch (error) {
        console.error('Error updating history:', error);
        showNotification('‚ùå Error updating history');
    }
}

// Check browser support
const isSpeechSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
const isSpeechSynthesisSupported = 'speechSynthesis' in window;

// Initialize voice chat
// Initialize voice chat
function initVoiceChat() {
    if (!isSpeechSupported) {
        alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´„ÄÇËØ∑‰ΩøÁî®ChromeÊàñEdge„ÄÇ„ÄêYour browser does not support speech recognition. Use Chrome or Edge.„Äë');
        return;
    }
    
    // Initialize speech recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SpeechRecognition();
    
    voiceRecognition.continuous = true;
    voiceRecognition.interimResults = true;
    voiceRecognition.lang = 'zh-CN'; // Changed to Chinese!
    
    voiceRecognition.onstart = function() {
        console.log('üé§ Starting voice recording');
        isRecording = true;
        updateVoiceUI(true);
    };
    
    voiceRecognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }
        
        // Show interim result
        if (interimTranscript) {
            updateInterimTranscript(interimTranscript);
        }
        
        // If there is final result - process it
        if (finalTranscript) {
            processVoiceCommand(finalTranscript);
        }
    };
    
    voiceRecognition.onerror = function(event) {
        console.error('Recognition error:', event.error);
        if (event.error === 'no-speech') {
            addVoiceMessage('AI', 'I didn\'t hear speech. Try again.', 'warning');
        }
    };
    
    voiceRecognition.onend = function() {
        console.log('üé§ Recording stopped');
        isRecording = false;
        updateVoiceUI(false);
    };
    
    // Load learned chengyu
    loadLearnedChengyu();

    initVoiceChatHistory();
    
    // Create new session
    createNewVoiceSession();
    
    // Initial message in Chinese
    setTimeout(() => {
        addVoiceMessage('AI', '‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑ‰∏≠ÊñáAIËÄÅÂ∏à„ÄÇÊàë‰ºöÂè™ËØ¥‰∏≠ÊñáÔºåÂ∏Æ‰Ω†ÁªÉ‰π†Âê¨Âäõ„ÄÅÂè£ËØ≠ÂíåÊàêËØ≠„ÄÇËØ∑ËØ¥"ÂºÄÂßã"ÊàñÊèêÈóÆÂêßÔºÅ', 'info');
    }, 500);
}

// Update recording UI
function updateVoiceUI(recording) {
    const startBtn = document.getElementById('startVoiceBtn');
    const stopBtn = document.getElementById('stopVoiceBtn');
    const indicator = document.getElementById('recordingIndicator');
    const level = document.getElementById('recordingLevel');
    
    if (recording) {
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        indicator.style.display = 'block';
        level.style.display = 'block';
        
        // Animate sound level
        animateVoiceLevel();
    } else {
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        indicator.style.display = 'none';
        level.style.display = 'none';
    }
}

// Animate sound level
function animateVoiceLevel() {
    const levelFill = document.querySelector('#recordingLevel .progress-fill');
    if (!isRecording) return;
    
    const randomLevel = 20 + Math.random() * 80;
    levelFill.style.width = randomLevel + '%';
    
    setTimeout(animateVoiceLevel, 100);
}

// Process voice command
async function processVoiceCommand(text) {
    text = text.trim();
    if (!text) return;
    
    // Add user message
    addVoiceMessage('user', text);
    
    // Clear interim text
    clearInterimTranscript();
    
    // Determine command type
    const commandType = detectVoiceCommand(text);
    
    // Send request to AI
    try {
        const response = await sendVoiceToAI(text, commandType);
        
        // Add AI response
        addVoiceMessage('AI', response);
        
        // Extract chengyu from response
        extractChengyuFromResponse(response);
        
        // Speak response
        if (document.getElementById('autoPlayAudio').checked) {
            speakText(response);
        }
        
    } catch (error) {
        console.error('AI error:', error);
        addVoiceMessage('AI', 'Sorry, an error occurred. Try again.', 'error');
    }
}

// Determine command type
function detectVoiceCommand(text) {
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes('chengyu') || lowerText.includes('–∏–¥–∏–æ–º')) {
        return 'chengyu';
    } else if (lowerText.includes('explain') || lowerText.includes('meaning') || lowerText.includes('Ëß£Èáä')) {
        return 'explain';
    } else if (lowerText.includes('example') || lowerText.includes('usage') || lowerText.includes('‰æãÂ≠ê')) {
        return 'example';
    } else if (lowerText.includes('translate') || lowerText.includes('translation') || lowerText.includes('ÁøªËØë')) {
        return 'translate';
    } else if (lowerText.includes('next') || lowerText.includes('another') || lowerText.includes('‰∏ã‰∏Ä‰∏™')) {
        return 'next';
    } else if (lowerText.includes('test') || lowerText.includes('quiz') || lowerText.includes('ÁªÉ‰π†')) {
        return 'quiz';
    } else if (lowerText.includes('help') || lowerText.includes('Â∏ÆÂä©')) {
        return 'help';
    }
    
    return 'general';
}

// Send voice to AI
async function sendVoiceToAI(text, commandType) {
    // Create or get thread for voice chat
    if (!currentVoiceThread) {
        try {
            currentVoiceThread = await createVoiceThread();
            console.log("Created new thread:", currentVoiceThread);
        } catch (error) {
            console.error("Error creating thread:", error);
            currentVoiceThread = `voice_${Date.now()}`;
        }
    }
    
    // Form context with chengyu
    const context = {
        command_type: commandType,
        learned_chengyu: learnedChengyu.slice(0, 5).map(c => c.character),
        user_level: currentUser?.current_level || 3
    };
    
    // Debug information
    console.log("Sending voice/chat request:", {
        message: text.substring(0, 100) + "...",
        thread_id: currentVoiceThread,
        context: context,
        user_id: currentUser?.user_id || null
    });
    
    // Send request
    try {
        const response = await fetch(`${API_BASE}/voice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: text,
                thread_id: currentVoiceThread,
                context: context,
                user_id: currentUser?.user_id || null
            })
        });
        
        console.log("Response status:", response.status);
        
        if (!response.ok) {
            let errorText = await response.text();
            console.error("HTTP error:", response.status, errorText);
            
            // If 422, try with new thread_id
            if (response.status === 422) {
                currentVoiceThread = `voice_retry_${Date.now()}`;
                console.log("Trying with new thread_id:", currentVoiceThread);
                
                // Try again
                const retryResponse = await fetch(`${API_BASE}/voice/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: text,
                        thread_id: currentVoiceThread,
                        context: context,
                        user_id: currentUser?.user_id || null
                    })
                });
                
                if (retryResponse.ok) {
                    return (await retryResponse.json()).response;
                }
            }
            
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("Received response from server");
        return data.response;
        
    } catch (error) {
        console.error('AI error:', error);
        throw error;
    }
}

// Create voice thread
async function createVoiceThread() {
    try {
        const response = await fetch(`${API_BASE}/chat/threads/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUser?.user_id || 'voice_user',
                title: 'Voice chat with AI',
                category: 'voice_chat'
            })
        });
        
        const data = await response.json();
        return data.thread_id;
    } catch (error) {
        console.error('Error creating thread:', error);
        return `voice_${Date.now()}`;
    }
}

// Add message to voice chat
// Add message to voice chat
function addVoiceMessage(sender, text, type = 'normal') {
    const chatBox = document.getElementById('voiceChatBox');
    
    // Create new session if needed
    if (!currentVoiceSessionId) {
        currentVoiceSessionId = createNewVoiceSession();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    let icon = sender === 'user' ? 'üë§' : 'ü§ñ';
    let className = 'ai-message';
    
    if (type === 'warning') {
        icon = '‚ö†Ô∏è';
        className = 'ai-message warning';
    } else if (type === 'tip') {
        icon = 'üí°';
        className = 'ai-message tip';
    } else if (type === 'error') {
        icon = '‚ùå';
        className = 'ai-message error';
    } else if (type === 'info') {
        icon = '‚ÑπÔ∏è';
        className = 'ai-message info';
    }
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="ai-label">${icon} You:</div>
            <div>${text}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="ai-label">${icon} AI Teacher:</div>
            <div>${text}</div>
        `;
    }
    
    messageDiv.className = `message ${className}`;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Add to history
    addToVoiceHistory(sender, text, type);
}

// Update interim transcript
function updateInterimTranscript(text) {
    let interimDiv = document.getElementById('interimTranscript');
    if (!interimDiv) {
        interimDiv = document.createElement('div');
        interimDiv.id = 'interimTranscript';
        interimDiv.style.cssText = `
            font-style: italic;
            color: var(--gray);
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 5px 0;
        `;
        document.getElementById('voiceChatBox').appendChild(interimDiv);
    }
    interimDiv.textContent = text;
    interimDiv.scrollIntoView({ behavior: 'smooth' });
}

// Clear interim text
function clearInterimTranscript() {
    const interimDiv = document.getElementById('interimTranscript');
    if (interimDiv) {
        interimDiv.remove();
    }
}

// Extract chengyu from response
// Extract only real chengyu from response
function extractChengyuFromResponse(response) {
    if (!document.getElementById('saveChengyu').checked) return;
    
    console.log("üìù Analyzing AI response for chengyu...");
    console.log("Response:", response.substring(0, 200));
    
    // Look for chengyu in structured blocks
    const patterns = [
        // Pattern: "ÊàêËØ≠: ÁîªËõáÊ∑ªË∂≥"
        /ÊàêËØ≠[:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        // Pattern: "ÊàêËØ≠ÔºöÁîªËõáÊ∑ªË∂≥"
        /[\u4e00-\u9fff]{4}[:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        // Pattern: "¬´ÁîªËõáÊ∑ªË∂≥¬ª"
        /[„Ää„Äå„Äé"]([\u4e00-\u9fff]{4})[„Äç„Äè"„Äã]/g,
        // Pattern: "chengyu: ÁîªËõáÊ∑ªË∂≥"
        /[Cc]h[√©e]ngy[u√º][:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        // Pattern in AI format: "ÊàêËØ≠: [4 characters]"
        /ÊàêËØ≠[:Ôºö]\s*\[([\u4e00-\u9fff]{4})\]/g
    ];
    
    let foundChengyu = [];
    
    patterns.forEach(pattern => {
        const matches = response.matchAll(pattern);
        for (const match of matches) {
            const chengyu = match[1];
            if (chengyu && isRealChengyu(chengyu)) {
                foundChengyu.push(chengyu);
                console.log("‚úÖ Found chengyu:", chengyu);
            }
        }
    });
    
    // Remove duplicates
    const uniqueChengyu = [...new Set(foundChengyu)];
    
    if (uniqueChengyu.length > 0) {
        console.log("üéØ Adding chengyu:", uniqueChengyu);
        uniqueChengyu.forEach(chengyu => addChengyu(chengyu));
    } else {
        console.log("üì≠ No chengyu found in response");
    }
}

// Strict check for real chengyu
function isRealChengyu(character) {
    if (character.length !== 4) return false;
    
    // Database of known chengyu (only real ones)
    const realChengyu = [
        // Level 1 (beginner)
        'ÁîªËõáÊ∑ªË∂≥', 'ÂÆàÊ†™ÂæÖÂÖî', '‰∫ïÂ∫ï‰πãËõô', '‰∫°ÁæäË°•Áâ¢', 'ÁãêÂÅáËôéÂ®Å',
        'ÂØπÁâõÂºπÁê¥', 'ÂçßËôéËóèÈæô', '‰∏ÄÁÆ≠ÂèåÈõï', 'Áè≠Èó®ÂºÑÊñß', 'ÊùØÂºìËõáÂΩ±',
        
        // Level 2 (intermediate)
        'Èó≠Èó®ÈÄ†ËΩ¶', '‰∏çËÄª‰∏ãÈóÆ', '‰∏çÊâì‰∏çÁõ∏ËØÜ', '‰∏çÂä≥ËÄåËé∑', '‰∏çÂÖ•ËôéÁ©¥ÁÑâÂæóËôéÂ≠ê',
        'Â§ßÂô®ÊôöÊàê', 'ÂΩìÂ±ÄËÄÖËø∑ÊóÅËßÇËÄÖÊ∏Ö', 'ÈÅìÈ´ò‰∏ÄÂ∞∫È≠îÈ´ò‰∏Ä‰∏à', 'ÂæóÂØ∏ËøõÂ∞∫',
        'Êª¥Ê∞¥Á©øÁü≥', 'Â§öÂ§öÁõäÂñÑ', 'ËÄ≥Êø°ÁõÆÊüì', 'ÂàÜÁßíÂøÖ‰∫â', 'Ëµ¥Ê±§ËπàÁÅ´',
        
        // Level 3 (advanced)
        'È´òÊûïÊó†Âøß', 'ÂêÑÂæóÂÖ∂ÊâÄ', 'Âäü‰∫è‰∏ÄÁØë', 'Â≠§Ê≥®‰∏ÄÊé∑', 'È°æÂêçÊÄù‰πâ',
        'È°æÂÖ®Â§ßÂ±Ä', 'ÂÖâÊòéÊ≠£Â§ß', 'Êµ∑Â∫ïÊçûÈíà', 'Êµ∑ÈòîÂ§©Á©∫', 'ÈÇØÈÉ∏Â≠¶Ê≠•',
        'Â•Ω‰∫ãÂ§öÁ£®', 'Èπ§Á´ãÈ∏°Áæ§', 'ÂêéÊù•Â±Ö‰∏ä', 'ÁîªÈæôÁÇπÁùõ', 'ÁÑïÁÑ∂‰∏ÄÊñ∞',
        
        // Continuation of list
        'ÊÅçÁÑ∂Â§ßÊÇü', 'ÂõûÂ§¥ÊòØÂ≤∏', 'ÁÅ´‰∏äÊµáÊ≤π', 'Êú∫‰∏çÂèØÂ§±', 'ÈõÜÊÄùÂπøÁõä',
        'ÂÆ∂ÂñªÊà∑Êôì', 'ËßÅ‰πâÂãá‰∏∫', 'Â∞ÜËÆ°Â∞±ËÆ°', 'ËÑöË∏èÂÆûÂú∞', 'Êç∑Ë∂≥ÂÖàÁôª',
        'Á´≠Â∞ΩÂÖ®Âäõ', 'ÈáëÁéâËâØË®Ä', 'Ê¥•Ê¥•ÊúâÂë≥', 'ËøëÊ∞¥Ê•ºÂè∞ÂÖàÂæóÊúà', 'Á≤æÁõäÊ±ÇÁ≤æ',
        '‰πùÁâõ‰∏ÄÊØõ', '‰∏æ‰∏ñÈóªÂêç', 'ÂºÄÈó®ËßÅÂ±±', 'ÂºÄÂ§©ËæüÂú∞', 'ÂàªËàüÊ±ÇÂâë',
        'Âè£Ëã•ÊÇ¨Ê≤≥', 'Âø´È©¨Âä†Èû≠', 'Êª•Á´ΩÂÖÖÊï∞', 'Âä≥ÈÄ∏ÁªìÂêà', 'ËÄÅÈ©¨ËØÜÈÄî',
        '‰πêÊûÅÁîüÊÇ≤', 'Âäõ‰∏ç‰ªéÂøÉ', 'Á´ãÁ´øËßÅÂΩ±', '‰∏§ÂÖ®ÂÖ∂Áæé', 'Êü≥ÊöóËä±Êòé',
        'È©¨Âà∞ÊàêÂäü', '‰π∞Ê§üËøòÁè†', 'Êª°ËÖπÁªèÁ∫∂', 'ÊØõÈÅÇËá™Ëçê', 'Èó®Â∫≠Ëã•Â∏Ç',
        'ÂêçËêΩÂ≠ôÂ±±', 'ÂêçÂàóÂâçËåÖ', 'ÂêçÊ≠£Ë®ÄÈ°∫', 'ÊòéÁü•ÊïÖÁäØ', 'ÁõÆ‰∏çËØÜ‰∏Å',
        'ÁõÆ‰∏çËΩ¨Áùõ', 'ÂçóËæïÂåóËæô', 'ÈöæËÉΩÂèØË¥µ', 'ÂºÑÂ∑ßÊàêÊãô', 'ÊäõÁ†ñÂºïÁéâ',
        'Êä´ÊòüÊà¥Êúà', 'Âπ≥ÊòìËøë‰∫∫', 'Á†¥ÈáúÊ≤âËàü', '‰∏ÉÂò¥ÂÖ´Ëàå', 'Â•áË£ÖÂºÇÊúç',
        'ÊóóÂºÄÂæóËÉú', 'Êùû‰∫∫ÂøßÂ§©', 'ÂçÉÂèò‰∏áÂåñ', 'ÂçÉÊñπÁôæËÆ°', 'ÂçÉÈíß‰∏ÄÂèë',
        'ÂâçÂäüÂ∞ΩÂºÉ', 'Ââç‰ªÜÂêéÁªß', 'Êû™ÊûóÂºπÈõ®', 'Èî≤ËÄå‰∏çËàç', 'ÈùíÂá∫‰∫éËìù',
        'ÂÖ®Âäõ‰ª•Ëµ¥', 'ÂÖ®ÂøÉÂÖ®ÊÑè', '‰∫∫Â±±‰∫∫Êµ∑', 'Êó•ÁßØÊúàÁ¥Ø', 'Â¶ÇÈ±ºÂæóÊ∞¥',
        '‰∏âÊÄùËÄåË°å', 'ÊùÄÈ∏°ÂèñÂçµ', 'Â±±Á©∑Ê∞¥Â∞Ω', '‰∏äË°å‰∏ãÊïà', 'Ê∑±ÊÄùÁÜüËôë',
        'Á•ûÊú∫Â¶ôÁÆó', 'ÁîüÈæôÊ¥ªËôé', 'Â£∞‰∏úÂáªË•ø', '‰∫ãÂçäÂäüÂÄç', '‰∫ãÂÄçÂäüÂçä',
        'ÂÆàÂè£Â¶ÇÁì∂', 'ÁÜüËÉΩÁîüÂ∑ß', 'ÂèåÁÆ°ÈΩê‰∏ã', 'Ê∞¥Êª¥Áü≥Á©ø', 'Ê∞¥ËêΩÁü≥Âá∫',
        'È°∫Ê∞¥Êé®Ëàü', 'ÂõõÊµ∑‰∏∫ÂÆ∂', 'ÂõõÈù¢Ê•öÊ≠å', 'ÈöèÊ≥¢ÈÄêÊµÅ', 'ÈöèÂøÉÊâÄÊ¨≤',
        'Êçü‰∫∫Âà©Â∑±', 'Ë∞àËôéËâ≤Âèò', 'Ëû≥ËáÇÂΩìËΩ¶', 'Ëû≥ËûÇÊçïËùâÈªÑÈõÄÂú®Âêé', 'ÊªîÊªî‰∏çÁªù',
        'Â§©Ë°£Êó†Áºù', 'ÂêåÁîòÂÖ±Ëã¶', 'ÂêåÂøÉÂçèÂäõ', 'Â§¥Â§¥ÊòØÈÅì', 'ÊäïÊú∫ÂèñÂ∑ß',
        'ËÑ±È¢ñËÄåÂá∫', '‰∏áÁ¥´ÂçÉÁ∫¢', 'ÊúõÊ¢ÖÊ≠¢Ê∏¥', 'ÊúõÊ¥ãÂÖ¥Âèπ', 'Âç±Âú®Êó¶Â§ï',
        'ÂîØÂà©ÊòØÂõæ', 'Êú™Èõ®Áª∏Áº™', 'ÈóªÈ∏°Ëµ∑Ëàû', 'Êó†ÁöÑÊîæÁü¢', 'Êó†ÂèØÂ•à‰Ωï',
        'Êó†ÂæÆ‰∏çËá≥', '‰∫îÂÖâÂçÅËâ≤', '‰∫î‰ΩìÊäïÂú∞', 'ÂñúÂá∫ÊúõÂ§ñ', 'ÂÖàÂèëÂà∂‰∫∫',
        'Áõ∏ËæÖÁõ∏Êàê', 'Â∞èÈ¢òÂ§ßÂÅö', 'ÂøÉ‰∏çÂú®ÁÑâ', 'ÂøÉÊó∑Á•ûÊÄ°', 'ÂøÉÈ¢ÜÁ•û‰ºö',
        'ÂøÉÂπ≥Ê∞îÂíå', '‰ø°Âè£ÂºÄÊ≤≥', 'Ë°å‰∫ëÊµÅÊ∞¥', 'ÂÖ¥È´òÈááÁÉà', 'ËÉ∏ÊúâÊàêÁ´π',
        'Â≠¶‰ª•Ëá¥Áî®', 'Èõ™‰∏≠ÈÄÅÁÇ≠', 'Âæ™ËßÑËπàÁü©', 'Ë®Ä‰∏çÁî±Ë°∑', 'Êé©ËÄ≥ÁõóÈìÉ',
        'ÁúºÈ´òÊâã‰Ωé', 'Êâ¨ÁúâÂêêÊ∞î', '‰∏ÄË¥•Ê∂ÇÂú∞', '‰∏ÄÊú¨Ê≠£Áªè', '‰∏ÄÁ¨îÂãæÈîÄ',
        '‰∏ÄÈºì‰ΩúÊ∞î', '‰∏ÄÂ≠î‰πãËßÅ', '‰∏ÄËßàÊó†‰Ωô', '‰∏ÄËêΩÂçÉ‰∏à', '‰∏ÄÊØõ‰∏çÊãî',
        '‰∏ÄÈ∏£ÊÉä‰∫∫', '‰∏ÄÁõÆ‰∫ÜÁÑ∂', '‰∏ÄËØ∫ÂçÉÈáë', '‰∏ÄÊãçÂç≥Âêà', '‰∏ÄÊõùÂçÅÂØí',
        '‰∏ÄÊ∞îÂëµÊàê', '‰∏ÄÁ™ç‰∏çÈÄö', '‰∏ÄÊó•ÂçÉÈáå', '‰∏Ä‰∏ù‰∏çËãü', '‰∏ÄÂæÄÊó†Ââç',
        '‰∏ÄÊúõÊó†ÈôÖ', '‰∏ÄÊó†ÊòØÂ§Ñ', '‰∏ÄÂé¢ÊÉÖÊÑø', '‰∏ÄÊÑèÂ≠§Ë°å', '‰∏ÄÂ≠óÂçÉÈáë',
        '‰æù‰æù‰∏çËàç', '‰ª•ÊØíÊîªÊØí', '‰ª•ÂçµÂáªÁü≥', '‰ª•Ë∫´‰ΩúÂàô', 'ÂºÇÂè£ÂêåÂ£∞',
        'Âõ†Â∞èÂ§±Â§ß', 'ÂºïÁãºÂÖ•ÂÆ§', 'È•ÆÊ∞¥ÊÄùÊ∫ê', 'ËøéÂàÉËÄåËß£', 'Â∫îÊúâÂ∞ΩÊúâ',
        'ÂãáÂæÄÁõ¥Ââç', 'ÊúâÂ§áÊó†ÊÇ£', 'ÊúâÁöÑÊîæÁü¢', 'ÊúâÂè£ÁöÜÁ¢ë', 'ÊúâÁõÆÂÖ±Áùπ',
        'ÊúâÂßãÊúâÁªà', 'ÊúâÊÅÉÊó†ÊÅê', 'ÊúâÊù°‰∏çÁ¥ä', 'ÊúâÂãáÊó†Ë∞ã', 'ÊÑöÂÖ¨ÁßªÂ±±',
        'È±ºÁõÆÊ∑∑Áè†', '‰∏éËôéË∞ãÁöÆ', 'Ê¨≤ÈÄüÂàô‰∏çËææ', 'ÁºòÊú®Ê±ÇÈ±º', 'Ê∫êÊ∫ê‰∏çÊñ≠',
        'Êúà‰∏ãËÄÅ‰∫∫', 'ËøêÁ≠πÂ∏∑ÂπÑ', 'ÂÜçÊé•ÂÜçÂéâ', 'Ë¥£Êó†ÊóÅË¥∑', 'Êñ©ËçâÈô§Ê†π',
        'ÊàòÊó†‰∏çËÉú', 'Êéå‰∏äÊòéÁè†', '‰ªóÂäøÊ¨∫‰∫∫', 'Êúù‰∏âÊöÆÂõõ', 'ÁÖßÁå´ÁîªËôé',
        'ÈíàÈîãÁõ∏ÂØπ', 'ÁúüÊâçÂÆûÂ≠¶', 'ÁúüÁü•ÁÅºËßÅ', 'Ëí∏Ëí∏Êó•‰∏ä', 'Áü•Â∑±Áü•ÂΩº',
        'Áü•ÈöæËÄåÈÄÄ', 'Áü•Êó†‰∏çË®Ä', 'ÊâßÊ≥ïÂ¶ÇÂ±±', 'ÊåáÈπø‰∏∫È©¨', 'ÊåáÊ°ëÈ™ÇÊßê',
        'ÊåáÊâãÁîªËÑö', 'Á∫∏‰∏äË∞àÂÖµ', 'ÂøóÂêåÈÅìÂêà', 'ÁΩÆ‰πãÂ∫¶Â§ñ', 'Âø†Ë®ÄÈÄÜËÄ≥',
        '‰ºóÂè£ÈöæË∞É', '‰ºóÂøóÊàêÂüé', 'Áè†ÂÖâÂÆùÊ∞î', 'Âä©‰∫∫‰∏∫‰πê', '‰∏ìÂøÉËá¥Âøó',
        'ËøΩÊú¨Ê∫ØÊ∫ê', 'ÊÉ¥ÊÉ¥‰∏çÂÆâ', 'Â≠úÂ≠ú‰∏çÂÄ¶', 'Ëá™ÂëäÂ•ãÂãá', 'Ëá™Áõ∏ÁüõÁõæ',
        'Â≠óÊñüÂè•ÈÖå', 'ÊÄªËÄåË®Ä‰πã', 'Ëµ∞È©¨ËßÇËä±', 'Âùê‰∫ïËßÇÂ§©', 'Âùê‰∫´ÂÖ∂Êàê',
        'Â∫ßÊó†ËôöÂ∏≠'
    ];
    
    // Check by database
    if (realChengyu.includes(character)) {
        return true;
    }
    
    // Additional check for unknown ones
    // Should not be too simple combinations
    const simplePatterns = [
        /[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ‰∏á‰∫ø]{2,}/,  // Numbers
        /(.)\1{2,}/,  // Repeating characters
        /^[ÁöÑÂæàÊòØÊúâÂú®Âíå‰∫ÜÈÉΩÂ∞±‰πü]+$/,  // Only function words
        /[ÂêóÂë¢ÂêßÂïäÂëÄÂìáÂì¶ËØ∂Âîâ]/  // Modal particles
    ];
    
    for (const pattern of simplePatterns) {
        if (pattern.test(character)) {
            return false;
        }
    }
    
    // For new chengyu - require complexity
    const chars = character.split('');
    const uniqueChars = new Set(chars);
    
    // At least 3 different characters
    return uniqueChars.size >= 3;
}

// Check if it's likely a chengyu
function isLikelyChengyu(character) {
    // Exclude too simple combinations
    const simplePatterns = [
        /[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]{4}/,  // Numbers
        /(.)\1{3}/,  // Same character 4 times
        /^(ÁöÑ|‰∫Ü|ÊòØ|Âú®|Êúâ|Âíå).{3}$/,  // Starts with function words
        /(Ë∞¢Ë∞¢|‰Ω†Â•Ω|ÂÜçËßÅ|ÂØπ‰∏çËµ∑)/,  // Common phrases
    ];
    
    // If matches simple patterns - skip
    for (const pattern of simplePatterns) {
        if (pattern.test(character)) {
            return false;
        }
    }
    
    // Check by database of known chengyu
    const commonChengyu = [
        'ÁîªËõáÊ∑ªË∂≥', 'ÂÆàÊ†™ÂæÖÂÖî', '‰∫ïÂ∫ï‰πãËõô', '‰∫°ÁæäË°•Áâ¢', 'ÁãêÂÅáËôéÂ®Å',
        'ÂØπÁâõÂºπÁê¥', 'ÂçßËôéËóèÈæô', '‰∏ÄÁÆ≠ÂèåÈõï', 'Áè≠Èó®ÂºÑÊñß', 'ÊùØÂºìËõáÂΩ±',
        'Èó≠Èó®ÈÄ†ËΩ¶', '‰∏çËÄª‰∏ãÈóÆ', '‰∏çÊâì‰∏çÁõ∏ËØÜ', '‰∏çÂä≥ËÄåËé∑', '‰∏çÂÖ•ËôéÁ©¥ÁÑâÂæóËôéÂ≠ê',
        'ÈïøÊ±üÂêéÊµ™Êé®ÂâçÊµ™', 'ËΩ¶Âà∞Â±±ÂâçÂøÖÊúâË∑Ø', 'ÂêÉ‰∏ÄÂ†ëÈïø‰∏ÄÊô∫', 'Âá∫Ê∑§Ê≥•ËÄå‰∏çÊüì',
        'Â§ßÂô®ÊôöÊàê', 'ÂΩìÂ±ÄËÄÖËø∑ÊóÅËßÇËÄÖÊ∏Ö', 'ÈÅìÈ´ò‰∏ÄÂ∞∫È≠îÈ´ò‰∏Ä‰∏à', 'ÂæóÂØ∏ËøõÂ∞∫',
        'Êª¥Ê∞¥Á©øÁü≥', 'ÂØπÁâõÂºπÁê¥', 'Â§öÂ§öÁõäÂñÑ', 'ËÄ≥Êø°ÁõÆÊüì', 'ÂàÜÁßíÂøÖ‰∫â',
        'Ëµ¥Ê±§ËπàÁÅ´', 'È´òÊûïÊó†Âøß', 'ÂêÑÂæóÂÖ∂ÊâÄ', 'Âäü‰∫è‰∏ÄÁØë', 'Â≠§Ê≥®‰∏ÄÊé∑',
        'È°æÂêçÊÄù‰πâ', 'È°æÂÖ®Â§ßÂ±Ä', 'ÂÖâÊòéÊ≠£Â§ß', 'Êµ∑Â∫ïÊçûÈíà', 'Êµ∑ÈòîÂ§©Á©∫',
        'ÈÇØÈÉ∏Â≠¶Ê≠•', 'Â•Ω‰∫ãÂ§öÁ£®', 'Èπ§Á´ãÈ∏°Áæ§', 'ÂêéÊù•Â±Ö‰∏ä', 'ÁîªÈæôÁÇπÁùõ',
        'ÁîªËõáÊ∑ªË∂≥', 'ÁÑïÁÑ∂‰∏ÄÊñ∞', 'ÊÅçÁÑ∂Â§ßÊÇü', 'ÂõûÂ§¥ÊòØÂ≤∏', 'ÁÅ´‰∏äÊµáÊ≤π',
        'Êú∫‰∏çÂèØÂ§±', 'ÈõÜÊÄùÂπøÁõä', 'ÂÆ∂ÂñªÊà∑Êôì', 'ËßÅ‰πâÂãá‰∏∫', 'Â∞ÜËÆ°Â∞±ËÆ°',
        'ËÑöË∏èÂÆûÂú∞', 'Êç∑Ë∂≥ÂÖàÁôª', 'Á´≠Â∞ΩÂÖ®Âäõ', 'ÈáëÁéâËâØË®Ä', 'Ê¥•Ê¥•ÊúâÂë≥',
        'ËøëÊ∞¥Ê•ºÂè∞ÂÖàÂæóÊúà', 'Á≤æÁõäÊ±ÇÁ≤æ', '‰πùÁâõ‰∏ÄÊØõ', '‰∏æ‰∏ñÈóªÂêç', 'ÂºÄÈó®ËßÅÂ±±',
        'ÂºÄÂ§©ËæüÂú∞', 'ÂàªËàüÊ±ÇÂâë', 'Âè£Ëã•ÊÇ¨Ê≤≥', 'Âø´È©¨Âä†Èû≠', 'Êª•Á´ΩÂÖÖÊï∞',
        'Âä≥ÈÄ∏ÁªìÂêà', 'ËÄÅÈ©¨ËØÜÈÄî', '‰πêÊûÅÁîüÊÇ≤', 'Âäõ‰∏ç‰ªéÂøÉ', 'Á´ãÁ´øËßÅÂΩ±',
        '‰∏§ÂÖ®ÂÖ∂Áæé', 'Êü≥ÊöóËä±Êòé', 'È©¨Âà∞ÊàêÂäü', '‰π∞Ê§üËøòÁè†', 'Êª°ËÖπÁªèÁ∫∂',
        'ÊØõÈÅÇËá™Ëçê', 'Èó®Â∫≠Ëã•Â∏Ç', 'ÂêçËêΩÂ≠ôÂ±±', 'ÂêçÂàóÂâçËåÖ', 'ÂêçÊ≠£Ë®ÄÈ°∫',
        'ÊòéÁü•ÊïÖÁäØ', 'ÁõÆ‰∏çËØÜ‰∏Å', 'ÁõÆ‰∏çËΩ¨Áùõ', 'ÂçóËæïÂåóËæô', 'ÈöæËÉΩÂèØË¥µ',
        'ÂºÑÂ∑ßÊàêÊãô', 'ÊäõÁ†ñÂºïÁéâ', 'Êä´ÊòüÊà¥Êúà', 'Âπ≥ÊòìËøë‰∫∫', 'Á†¥ÈáúÊ≤âËàü',
        '‰∏ÉÂò¥ÂÖ´Ëàå', 'Â•áË£ÖÂºÇÊúç', 'ÊóóÂºÄÂæóËÉú', 'Êùû‰∫∫ÂøßÂ§©', 'ÂçÉÂèò‰∏áÂåñ',
        'ÂçÉÊñπÁôæËÆ°', 'ÂçÉÈíß‰∏ÄÂèë', 'ÂâçÂäüÂ∞ΩÂºÉ', 'Ââç‰ªÜÂêéÁªß', 'Êû™ÊûóÂºπÈõ®',
        'Èî≤ËÄå‰∏çËàç', 'ÈùíÂá∫‰∫éËìù', 'ÂÖ®Âäõ‰ª•Ëµ¥', 'ÂÖ®ÂøÉÂÖ®ÊÑè', '‰∫∫Â±±‰∫∫Êµ∑',
        'Êó•ÁßØÊúàÁ¥Ø', 'Â¶ÇÈ±ºÂæóÊ∞¥', '‰∏âÊÄùËÄåË°å', 'ÊùÄÈ∏°ÂèñÂçµ', 'Â±±Á©∑Ê∞¥Â∞Ω',
        '‰∏äË°å‰∏ãÊïà', 'Ê∑±ÊÄùÁÜüËôë', 'Á•ûÊú∫Â¶ôÁÆó', 'ÁîüÈæôÊ¥ªËôé', 'Â£∞‰∏úÂáªË•ø',
        '‰∫ãÂçäÂäüÂÄç', '‰∫ãÂÄçÂäüÂçä', 'ÂÆàÂè£Â¶ÇÁì∂', 'ÂÆàÊ†™ÂæÖÂÖî', 'ÁÜüËÉΩÁîüÂ∑ß',
        'ÂèåÁÆ°ÈΩê‰∏ã', 'Ê∞¥Êª¥Áü≥Á©ø', 'Ê∞¥ËêΩÁü≥Âá∫', 'È°∫Ê∞¥Êé®Ëàü', 'ÂõõÊµ∑‰∏∫ÂÆ∂',
        'ÂõõÈù¢Ê•öÊ≠å', 'ÈöèÊ≥¢ÈÄêÊµÅ', 'ÈöèÂøÉÊâÄÊ¨≤', 'Êçü‰∫∫Âà©Â∑±', 'Ë∞àËôéËâ≤Âèò',
        'Ëû≥ËáÇÂΩìËΩ¶', 'Ëû≥ËûÇÊçïËùâÈªÑÈõÄÂú®Âêé', 'ÊªîÊªî‰∏çÁªù', 'Â§©Ë°£Êó†Áºù',
        'ÂêåÁîòÂÖ±Ëã¶', 'ÂêåÂøÉÂçèÂäõ', 'Â§¥Â§¥ÊòØÈÅì', 'ÊäïÊú∫ÂèñÂ∑ß', 'ËÑ±È¢ñËÄåÂá∫',
        '‰∏áÁ¥´ÂçÉÁ∫¢', '‰∫°ÁæäË°•Áâ¢', 'ÊúõÊ¢ÖÊ≠¢Ê∏¥', 'ÊúõÊ¥ãÂÖ¥Âèπ', 'Âç±Âú®Êó¶Â§ï',
        'ÂîØÂà©ÊòØÂõæ', 'Êú™Èõ®Áª∏Áº™', 'ÈóªÈ∏°Ëµ∑Ëàû', 'Êó†ÁöÑÊîæÁü¢', 'Êó†ÂèØÂ•à‰Ωï',
        'Êó†ÂæÆ‰∏çËá≥', '‰∫îÂÖâÂçÅËâ≤', '‰∫î‰ΩìÊäïÂú∞', 'ÂñúÂá∫ÊúõÂ§ñ', 'ÂÖàÂèëÂà∂‰∫∫',
        'Áõ∏ËæÖÁõ∏Êàê', 'Â∞èÈ¢òÂ§ßÂÅö', 'ÂøÉ‰∏çÂú®ÁÑâ', 'ÂøÉÊó∑Á•ûÊÄ°', 'ÂøÉÈ¢ÜÁ•û‰ºö',
        'ÂøÉÂπ≥Ê∞îÂíå', '‰ø°Âè£ÂºÄÊ≤≥', 'Ë°å‰∫ëÊµÅÊ∞¥', 'ÂÖ¥È´òÈááÁÉà', 'ËÉ∏ÊúâÊàêÁ´π',
        'Â≠¶‰ª•Ëá¥Áî®', 'Èõ™‰∏≠ÈÄÅÁÇ≠', 'Âæ™ËßÑËπàÁü©', 'Ë®Ä‰∏çÁî±Ë°∑', 'Êé©ËÄ≥ÁõóÈìÉ',
        'ÁúºÈ´òÊâã‰Ωé', 'Êâ¨ÁúâÂêêÊ∞î', '‰∏ÄË¥•Ê∂ÇÂú∞', '‰∏ÄÊú¨Ê≠£Áªè', '‰∏ÄÁ¨îÂãæÈîÄ',
        '‰∏ÄÈºì‰ΩúÊ∞î', '‰∏ÄÁÆ≠ÂèåÈõï', '‰∏ÄÂ≠î‰πãËßÅ', '‰∏ÄËßàÊó†‰Ωô', '‰∏ÄËêΩÂçÉ‰∏à',
        '‰∏ÄÊØõ‰∏çÊãî', '‰∏ÄÈ∏£ÊÉä‰∫∫', '‰∏ÄÁõÆ‰∫ÜÁÑ∂', '‰∏ÄËØ∫ÂçÉÈáë', '‰∏ÄÊãçÂç≥Âêà',
        '‰∏ÄÊõùÂçÅÂØí', '‰∏ÄÊ∞îÂëµÊàê', '‰∏ÄÁ™ç‰∏çÈÄö', '‰∏ÄÊó•ÂçÉÈáå', '‰∏Ä‰∏ù‰∏çËãü',
        '‰∏ÄÂæÄÊó†Ââç', '‰∏ÄÊúõÊó†ÈôÖ', '‰∏ÄÊó†ÊòØÂ§Ñ', '‰∏ÄÂé¢ÊÉÖÊÑø', '‰∏ÄÊÑèÂ≠§Ë°å',
        '‰∏ÄÂ≠óÂçÉÈáë', '‰æù‰æù‰∏çËàç', '‰ª•ÊØíÊîªÊØí', '‰ª•ÂçµÂáªÁü≥', '‰ª•Ë∫´‰ΩúÂàô',
        'ÂºÇÂè£ÂêåÂ£∞', 'Âõ†Â∞èÂ§±Â§ß', 'ÂºïÁãºÂÖ•ÂÆ§', 'È•ÆÊ∞¥ÊÄùÊ∫ê', 'ËøéÂàÉËÄåËß£',
        'Â∫îÊúâÂ∞ΩÊúâ', 'ÂãáÂæÄÁõ¥Ââç', 'ÊúâÂ§áÊó†ÊÇ£', 'ÊúâÁöÑÊîæÁü¢', 'ÊúâÂè£ÁöÜÁ¢ë',
        'ÊúâÁõÆÂÖ±Áùπ', 'ÊúâÂßãÊúâÁªà', 'ÊúâÊÅÉÊó†ÊÅê', 'ÊúâÊù°‰∏çÁ¥ä', 'ÊúâÂãáÊó†Ë∞ã',
        'ÊÑöÂÖ¨ÁßªÂ±±', 'È±ºÁõÆÊ∑∑Áè†', '‰∏éËôéË∞ãÁöÆ', 'Ê¨≤ÈÄüÂàô‰∏çËææ', 'ÁºòÊú®Ê±ÇÈ±º',
        'Ê∫êÊ∫ê‰∏çÊñ≠', 'Êúà‰∏ãËÄÅ‰∫∫', 'ËøêÁ≠πÂ∏∑ÂπÑ', 'ÂÜçÊé•ÂÜçÂéâ', 'Ë¥£Êó†ÊóÅË¥∑',
        'Êñ©ËçâÈô§Ê†π', 'ÊàòÊó†‰∏çËÉú', 'Êéå‰∏äÊòéÁè†', '‰ªóÂäøÊ¨∫‰∫∫', 'Êúù‰∏âÊöÆÂõõ',
        'ÁÖßÁå´ÁîªËôé', 'ÈíàÈîãÁõ∏ÂØπ', 'ÁúüÊâçÂÆûÂ≠¶', 'ÁúüÁü•ÁÅºËßÅ', 'Ëí∏Ëí∏Êó•‰∏ä',
        'Áü•Â∑±Áü•ÂΩº', 'Áü•ÈöæËÄåÈÄÄ', 'Áü•Êó†‰∏çË®Ä', 'ÊâßÊ≥ïÂ¶ÇÂ±±', 'ÊåáÈπø‰∏∫È©¨',
        'ÊåáÊ°ëÈ™ÇÊßê', 'ÊåáÊâãÁîªËÑö', 'Á∫∏‰∏äË∞àÂÖµ', 'ÂøóÂêåÈÅìÂêà', 'ÁΩÆ‰πãÂ∫¶Â§ñ',
        'Âø†Ë®ÄÈÄÜËÄ≥', '‰ºóÂè£ÈöæË∞É', '‰ºóÂøóÊàêÂüé', 'Áè†ÂÖâÂÆùÊ∞î', 'Âä©‰∫∫‰∏∫‰πê',
        '‰∏ìÂøÉËá¥Âøó', 'ËøΩÊú¨Ê∫ØÊ∫ê', 'ÊÉ¥ÊÉ¥‰∏çÂÆâ', 'Â≠úÂ≠ú‰∏çÂÄ¶', 'Ëá™ÂëäÂ•ãÂãá',
        'Ëá™Áõ∏ÁüõÁõæ', 'Â≠óÊñüÂè•ÈÖå', 'ÊÄªËÄåË®Ä‰πã', 'Ëµ∞È©¨ËßÇËä±', 'Âùê‰∫ïËßÇÂ§©',
        'Âùê‰∫´ÂÖ∂Êàê', 'Â∫ßÊó†ËôöÂ∏≠'
    ];
    
    // If it's a known chengyu - definitely add
    if (commonChengyu.includes(character)) {
        return true;
    }
    
    // For unknown ones - check complexity
    const uniqueChars = new Set(character.split(''));
    return uniqueChars.size >= 3;  // Minimum 3 different characters
}

// Add chengyu
function addChengyu(character) {
    // Check if not already added
    if (learnedChengyu.some(c => c.character === character)) {
        return;
    }
    
    // Get chengyu information
    getChengyuInfo(character).then(info => {
        // Create new chengyu
        const newChengyu = {
            character: character,
            pinyin: info.pinyin || estimatePinyin(character),
            meaning: info.meaning || '',
            example: info.example || '',
            translation: info.translation || '',
            story: info.story || '',
            learned_at: new Date().toISOString(),
            reviewed_count: 0,
            confidence: info.confidence || 0.5
        };
        
        learnedChengyu.unshift(newChengyu);
        
        // Save
        saveLearnedChengyu();
        
        // Update UI
        updateChengyuList();
        
        // Show notification
        showChengyuNotification(character, newChengyu.pinyin);
        
    }).catch(error => {
        console.log('Failed to get chengyu information:', character);
        // Add with basic information
        const newChengyu = {
            character: character,
            pinyin: estimatePinyin(character),
            meaning: '',
            example: '',
            translation: '',
            story: '',
            learned_at: new Date().toISOString(),
            reviewed_count: 0,
            confidence: 0.3
        };
        
        learnedChengyu.unshift(newChengyu);
        saveLearnedChengyu();
        updateChengyuList();
    });
}

// Get chengyu information
async function getChengyuInfo(character) {
    try {
        // Use AI to get information
        const response = await fetch(`${API_BASE}/ai/translate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: character,
                user_id: currentUser?.user_id || null,
                detailed: true
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            return {
                pinyin: data.pinyin || '',
                meaning: data.translation || '',
                example: data.example_sentences?.[0]?.chinese || '',
                translation: data.example_sentences?.[0]?.translation || '',
                confidence: 0.9
            };
        }
    } catch (error) {
        console.error('Error getting chengyu information:', error);
    }
    
    // Fallback - simple translation
    return {
        pinyin: '',
        meaning: '',
        example: '',
        confidence: 0.3
    };
}

// Simple pinyin (placeholder)
function estimatePinyin(character) {
    // In real app there would be API here
    // For now return symbolic pinyin
    const charToPinyin = {
        'Áîª': 'hu√†', 'Ëõá': 'sh√©', 'Ê∑ª': 'tiƒÅn', 'Ë∂≥': 'z√∫',
        'ÂÆà': 'sh«íu', 'Ê†™': 'zh≈´', 'ÂæÖ': 'd√†i', 'ÂÖî': 't√π',
        // Add more correspondences as needed
    };
    
    return character.split('').map(char => 
        charToPinyin[char] || '?'
    ).join(' ');
}

// Show new chengyu notification
function showChengyuNotification(character, pinyin) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.5s ease;
        max-width: 300px;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">üéâ New Chengyu!</div>
        <div style="font-size: 2em; margin: 10px 0;">${character}</div>
        <div style="color: #ffd700; margin-bottom: 10px;">${pinyin || ''}</div>
        <div style="font-size: 0.9em;">Added to collection</div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}

// Function to get pinyin (placeholder)
function getPinyin(character) {
    // In real app there would be API for getting pinyin
    // For now return placeholder
    return character.split('').map(() => 'pinyin').join(' ');
}

// Load learned chengyu
function loadLearnedChengyu() {
    try {
        const saved = localStorage.getItem('hsk_learned_chengyu');
        if (saved) {
            learnedChengyu = JSON.parse(saved);
            updateChengyuList();
        }
    } catch (error) {
        console.error('Error loading chengyu:', error);
    }
}

// Save learned chengyu
function saveLearnedChengyu() {
    try {
        // Limit quantity
        if (learnedChengyu.length > 100) {
            learnedChengyu = learnedChengyu.slice(0, 100);
        }
        localStorage.setItem('hsk_learned_chengyu', JSON.stringify(learnedChengyu));
    } catch (error) {
        console.error('Error saving chengyu:', error);
    }
}

// Update chengyu list
// Update chengyu list
function updateChengyuList() {
    const container = document.getElementById('chengyuList');
    const countElement = document.getElementById('chengyuCount');
    
    // Show only real chengyu (filter out garbage)
    const realChengyu = learnedChengyu.filter(c => isRealChengyu(c.character));
    
    countElement.textContent = realChengyu.length;
    
    if (realChengyu.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--gray); padding: 20px;">
                <div style="font-size: 3em;">üìö</div>
                <p>Learned chengyu will appear here</p>
                <p style="font-size: 0.9em;">Say: "Tell me a chengyu"</p>
            </div>
        `;
        return;
    }
    
    // Show in reverse order (most recent learned on top)
    const recentChengyu = [...realChengyu].reverse();
    
    container.innerHTML = recentChengyu.map((chengyu, index) => `
        <div class="chengyu-item" 
             onclick="showChengyuDetails('${chengyu.character}')"
             style="padding: 12px; 
                    margin-bottom: 8px; 
                    border-radius: 8px; 
                    background: #f8f9fa;
                    border-left: 4px solid ${getChengyuColor(chengyu.confidence || 0.5)};
                    cursor: pointer;
                    transition: all 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 1.5em; font-weight: bold;">${chengyu.character}</div>
                <div style="font-size: 0.8em; color: var(--gray);">
                    ${formatDate(chengyu.learned_at)}
                </div>
            </div>
            ${chengyu.pinyin && chengyu.pinyin !== 'pinyin pinyin pinyin pinyin' ? 
                `<div style="color: var(--danger); font-size: 0.9em; margin: 5px 0;">${chengyu.pinyin}</div>` : ''}
            ${chengyu.meaning ? 
                `<div style="font-size: 0.9em; color: var(--dark);">${chengyu.meaning.substring(0, 60)}${chengyu.meaning.length > 60 ? '...' : ''}</div>` : 
                `<div style="font-size: 0.8em; color: var(--gray);">Click to study</div>`}
            ${chengyu.reviewed_count > 0 ? 
                `<div style="font-size: 0.7em; color: var(--gray); margin-top: 5px;">
                    Reviewed: ${chengyu.reviewed_count} times
                </div>` : ''}
        </div>
    `).join('');
}

// Color depending on confidence
function getChengyuColor(confidence) {
    if (confidence > 0.8) return 'var(--success)';    // green - definitely chengyu
    if (confidence > 0.5) return 'var(--warning)';    // yellow - likely chengyu
    return 'var(--danger)';                           // red - little information
}

// Search chengyu
function searchChengyu() {
    const searchTerm = document.getElementById('chengyuSearch').value.toLowerCase();
    const items = document.querySelectorAll('.chengyu-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
}

// Speak text
function speakText(text, forceLang = null) {
    if (!isSpeechSynthesisSupported || !document.getElementById('autoPlayAudio').checked) {
        return;
    }
    
    // For voice chat - ALWAYS Chinese
    const lang = 'zh-CN';
    
    // Cancel all current
    window.speechSynthesis.cancel();
    
    setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = parseFloat(document.getElementById('voiceSpeed').value);
        utterance.volume = 1;
        utterance.pitch = 1;
        
        // Look for Chinese voice
        const voices = speechSynthesis.getVoices();
        let chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh-CN') || 
            voice.lang.startsWith('zh') ||
            voice.name.toLowerCase().includes('chinese')
        );
        
        // If no Chinese, use first available
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        utterance.onstart = () => {
            console.log('üéµ Starting pronunciation...');
        };
        
        utterance.onend = () => {
            console.log('üéµ Pronunciation ended');
        };
        
        utterance.onerror = (event) => {
            console.error('Pronunciation error:', event);
        };
        
        speechSynthesis.speak(utterance);
        
    }, 100);
}

// Extract Chinese text for speech
function extractChineseTextForSpeech(text) {
    // Extract only Chinese text (remove Russian translations in brackets)
    const chineseOnly = text.replace(/„Äê[^„Äë]*„Äë/g, '') // Remove Russian translation
                           .replace(/\([^)]*\)/g, '')  // Remove pinyin
                           .replace(/[\u0400-\u04FF]/g, ''); // Remove Cyrillic
    
    return chineseOnly.trim() || text; // If no Chinese left, speak entire text
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'ÂàöÂàö';
    if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
    if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
    if (diffDays < 7) return `${diffDays}Â§©Ââç`;
    
    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
}

// Extract chengyu from message
function extractChengyuFromMessage(text) {
    const patterns = [
        /ÊàêËØ≠[:Ôºö]\s*([\u4e00-\u9fff]{4})/g,
        /[„Ää„Äå„Äé]([\u4e00-\u9fff]{4})[„Äç„Äè„Äã]/g,
        /[\u4e00-\u9fff]{4}[:Ôºö]\s*([\u4e00-\u9fff]{4})/g
    ];
    
    let found = [];
    patterns.forEach(pattern => {
        const matches = text.matchAll(pattern);
        for (const match of matches) {
            if (match[1] && isRealChengyu(match[1])) {
                found.push(match[1]);
            }
        }
    });
    
    return [...new Set(found)];
}

// Update voice speed
function updateVoiceSpeed() {
    const speed = document.getElementById('voiceSpeed').value;
    document.getElementById('speedValue').textContent = `${speed}x`;
}

// Quick commands
function sendQuickVoiceCommand(command) {
    processVoiceCommand(command);
}

// Generate chengyu test
function generateChengyuQuiz() {
    if (learnedChengyu.length < 3) {
        addVoiceMessage('AI', 'First study at least 3 chengyu!', 'warning');
        return;
    }
    
    // Choose random chengyu
    const quizChengyu = [...learnedChengyu]
        .sort(() => Math.random() - 0.5)
        .slice(0, 5);
    
    let quizText = "üìù Chengyu Test:\n\n";
    
    quizChengyu.forEach((chengyu, index) => {
        quizText += `${index + 1}. ${chengyu.character} (${chengyu.pinyin || '???'})\n`;
        quizText += `   a) Meaning 1\n`;
        quizText += `   b) Meaning 2\n`;
        quizText += `   c) Meaning 3\n`;
        quizText += `   d) Meaning 4\n\n`;
    });
    
    quizText += "Answer by voice, for example: 'First - A, second - B'";
    
    addVoiceMessage('AI', quizText, 'info');
    
    if (document.getElementById('autoPlayAudio').checked) {
        speakText("Here's a chengyu test. Try to answer the questions.");
    }
}

// Show chengyu details
// Show chengyu details
function showChengyuDetails(character) {
    const chengyu = learnedChengyu.find(c => c.character === character);
    if (!chengyu) return;
    
    // Create modal window
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; 
                    padding: 30px; 
                    border-radius: 15px; 
                    width: 100%;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin: 0;">${character}</h2>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                ${chengyu.pinyin && chengyu.pinyin !== 'pinyin pinyin pinyin pinyin' ? 
                    `<div style="color: var(--danger); font-size: 1.2em; margin-bottom: 10px;">
                        <strong>Pinyin:</strong> ${chengyu.pinyin}
                    </div>` : ''}
                
                ${chengyu.meaning ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>Meaning:</strong> ${chengyu.meaning}
                    </div>` : ''}
                
                ${chengyu.translation ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>Translation:</strong> ${chengyu.translation}
                    </div>` : ''}
                
                ${chengyu.example ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>Example:</strong> ${chengyu.example}
                    </div>` : ''}
                
                ${chengyu.story ? 
                    `<div style="margin-bottom: 10px;">
                        <strong>Story:</strong> ${chengyu.story}
                    </div>` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="speakText('${character}', 'zh-CN')">
                    <i class="fas fa-volume-up"></i> Pronounce
                </button>
                <button class="btn btn-success" onclick="processVoiceCommand('Explain chengyu ${character}')">
                    <i class="fas fa-graduation-cap"></i> Learn more
                </button>
                <button class="btn btn-danger" onclick="removeChengyu('${character}'); this.parentElement.parentElement.parentElement.remove()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Remove chengyu
function removeChengyu(character) {
    learnedChengyu = learnedChengyu.filter(c => c.character !== character);
    saveLearnedChengyu();
    updateChengyuList();
}



async function checkAuth() {
    const savedUser = localStorage.getItem('hsk_user');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        updateAuthUI();
        return true;
    }
    return false;
}

async function loginOrRegister() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        alert('Enter username!');
        return;
    }
    
    try {
        // Check existing user or create new one
        const response = await fetch(`${API_BASE}/auth/user`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                action: 'login_or_register'
            })
        });
        
        if (response.ok) {
            const userData = await response.json();
            currentUser = userData;
            localStorage.setItem('hsk_user', JSON.stringify(userData));
            localStorage.setItem('hsk_user_id', userData.user_id);
            updateAuthUI();
            
            // Update statistics
            loadStats();
            
            // Show greeting
            addMessage(`üëã Welcome, ${userData.name}! Now your progress will be saved.`, 'ai');
        } else {
            // If no API, create local user
            createLocalUser(username);
        }
    } catch (error) {
        console.log('API unavailable, creating local user');
        createLocalUser(username);
    }
}

function createLocalUser(username) {
    const userId = "user_" + Date.now();
    currentUser = {
        user_id: userId,
        name: username,
        current_level: 1,
        target_level: 4,
        registered_at: new Date().toISOString()
    };
    
    localStorage.setItem('hsk_user', JSON.stringify(currentUser));
    localStorage.setItem('hsk_user_id', userId);
    updateAuthUI();
    
    // Inform user
    addMessage(`üëã Welcome, ${username}! Your progress will be saved locally.`, 'ai');
}

// Logout
function logout() {
    if (confirm('Log out of account?')) {
        localStorage.removeItem('hsk_user');
        localStorage.removeItem('hsk_user_id');
        currentUser = null;
        updateAuthUI();  // This will update UI
        
        // If Progress tab is active - refresh its content
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
        
        addMessage('üëã You have logged out. Your progress is saved.', 'ai');
    }
}

// Update getOrCreateUser to use authorization
async function getOrCreateUser() {
    if (currentUser) {
        return currentUser.user_id;
    }
    
    await checkAuth();
    if (currentUser) {
        return currentUser.user_id;
    }
    
    // If no user, create temporary one
    return "guest_" + Date.now();
}

// Show/hide forms
function showLoginForm() {
    document.getElementById('loginModal').style.display = 'flex';
}

function hideLoginForm() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
}

// On Progress tab show profile
function showUserProfile() {
    const progressContent = document.getElementById('progressContent');
    
    if (!currentUser) {
        progressContent.innerHTML = `
            <div style="text-align: center; padding: 40px 0;">
                <div style="font-size: 4em; color: var(--gray);">üîê</div>
                <h3>Progress unavailable</h3>
                <p>Log in to track progress</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt"></i> Log In
                    </button>
                    <button class="btn btn-success" onclick="showRegisterFormFull()" style="margin-left: 10px;">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </div>
            </div>
        `;
        return;
    }

    function getScoreColor(score) {
    if (score >= 90) return 'var(--success)';
    if (score >= 75) return 'var(--warning)';
    return 'var(--danger)';
}

// Retry function
function retryEssayAnalysis() {
    if (confirm('Start essay again? Current text will be lost.')) {
        document.getElementById('essayAnalysisResult').style.display = 'none';
        document.getElementById('essayAnalysisArea').style.display = 'block';
        document.getElementById('essayAnalysisText').value = '';
        updateEssayAnalysisCounter();
    }
}

// Save report function
function saveEssayAnalysisResult() {
    if (!currentEssayAnalysisData) return;
    
    const data = {
        type: 'essay_analysis_result',
        data: currentEssayAnalysisData,
        timestamp: new Date().toISOString(),
        essay_text: document.getElementById('essayAnalysisText').value
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `essay_analysis_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üíæ Report saved!');
}

// Show corrected version function
function showCorrectedEssay() {
    const essayText = document.getElementById('essayAnalysisText').value;
    const errors = currentEssayAnalysisData?.result?.errors || [];
    
    let correctedText = essayText;
    
    // Simple correction (in real app would be AI)
    errors.forEach(err => {
        // Replace simple errors (example)
        correctedText = correctedText
            .replace('‰∫Ü‰∏ç', '‰∏ç')
            .replace('ÁöÑÂæó', 'Âæó')
            .replace('Âú∞Âæó', 'Âæó');
    });
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; 
                    width: 100%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-edit"></i> Corrected essay version
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                    <i class="fas fa-check-circle"></i> Corrected errors highlighted:
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; 
                            font-family: 'SimSun', serif; font-size: 16px; line-height: 1.8; 
                            white-space: pre-wrap;">
                    ${correctedText}
                </div>
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}
    
    // Show user profile
    progressContent.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-user"></i> My Profile</h2>
            <div class="icon">üë§</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="stat-card">
                <h3>Overall Progress</h3>
                <div class="stat-number">${currentUser.stats?.learned_words || 0}/${currentUser.stats?.total_words || 5462}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${currentUser.stats?.progress_percentage || 0}%"></div>
                </div>
                <div class="stat-desc">${currentUser.stats?.progress_percentage || 0}% learned</div>
            </div>
            
            <div class="stat-card">
                <h3>Goal</h3>
                <div class="stat-number">HSK ${currentUser.current_level || 1} ‚Üí HSK ${currentUser.target_level || 4}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((currentUser.current_level || 1) / (currentUser.target_level || 4)) * 100}%"></div>
                </div>
                <div class="stat-desc">${currentUser.days_until_exam || 0} days until exam</div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3><i class="fas fa-cog"></i> Profile Settings</h3>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="showEditProfile()">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
                <button class="btn btn-warning" onclick="showResetPassword()">
                    <i class="fas fa-key"></i> Change Password
                </button>
                <button class="btn btn-secondary" onclick="exportProgress()">
                    <i class="fas fa-download"></i> Export Progress
                </button>
            </div>
        </div>
    `;
}

// Update Progress tab
// Load user progress
// Load user progress (main function)
async function loadProgress() {
    const progressContent = document.getElementById('progressContent');
   
    if (!currentUser) {
        progressContent.innerHTML = `
            <div style="text-align: center; padding: 40px 0;">
                <div style="font-size: 4em; color: var(--gray);">üîê</div>
                <h3>Progress unavailable</h3>
                <p>Log in to track progress</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt"></i> Log In
                    </button>
                    <button class="btn btn-success" onclick="showRegisterFormFull()" style="margin-left: 10px;">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </div>
            </div>
        `;
        return;
    }
   
    try {
        // Show loading
        progressContent.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading your real progress...</p>
            </div>
        `;
       
        // Try to get fresh data from server
        const response = await fetch(`${API_BASE}/user/profile/${currentUser.user_id}`);
       
        if (response.ok) {
            const userData = await response.json();
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('hsk_user', JSON.stringify(currentUser));
        }
       
        // Calculate real progress from userWordsStatus (your learned words)
        const learnedWords = Object.values(userWordsStatus).filter(s => s.status === 'learned').length;
        const totalWords = allWords.length || 5462; // your word database
        const progressPercentage = totalWords > 0 ? Math.round((learnedWords / totalWords) * 100) : 0;
       
        // Show actual profile
        progressContent.innerHTML = `
            <div class="section-header">
                <h2><i class="fas fa-user"></i> My Profile</h2>
                <div class="icon">üë§</div>
            </div>
           
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="stat-card">
                    <h3>Overall Progress</h3>
                    <div class="stat-number">${learnedWords}/${totalWords}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="stat-desc">${progressPercentage}% learned</div>
                </div>
               
                <div class="stat-card">
                    <h3>Goal</h3>
                    <div class="stat-number">HSK ${currentUser.current_level || 1} ‚Üí HSK ${currentUser.target_level || 4}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${((currentUser.current_level || 1) / (currentUser.target_level || 4)) * 100}%"></div>
                    </div>
                    <div class="stat-desc">${currentUser.days_until_exam || 0} days until exam</div>
                </div>
            </div>
           
            <div style="margin-top: 30px;">
                <h3><i class="fas fa-cog"></i> Profile Settings</h3>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="showEditProfile()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="btn btn-warning" onclick="showResetPassword()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                    <button class="btn btn-secondary" onclick="exportProgress()">
                        <i class="fas fa-download"></i> Export Progress
                    </button>
                </div>
            </div>
           
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-success" onclick="loadProgress()">
                    <i class="fas fa-sync-alt"></i> Refresh Progress
                </button>
            </div>
        `;
       
    } catch (error) {
        console.error('Error loading progress:', error);
       
        // Fallback: show local progress from userWordsStatus
        const learnedWords = Object.values(userWordsStatus).filter(s => s.status === 'learned').length;
        const totalWords = allWords.length || 5462;
        const progressPercentage = totalWords > 0 ? Math.round((learnedWords / totalWords) * 100) : 0;
       
        progressContent.innerHTML = `
            <div class="section-header">
                <h2><i class="fas fa-user"></i> My Profile (local)</h2>
                <div class="icon">üíæ</div>
            </div>
           
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="stat-card">
                    <h3>Local Progress</h3>
                    <div class="stat-number">${learnedWords}/${totalWords}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="stat-desc">${progressPercentage}% learned</div>
                </div>
               
                <div class="stat-card">
                    <h3>Goal</h3>
                    <div class="stat-number">HSK ${currentUser?.current_level || 1} ‚Üí HSK ${currentUser?.target_level || 4}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${((currentUser?.current_level || 1) / (currentUser?.target_level || 4)) * 100}%"></div>
                    </div>
                    <div class="stat-desc">${currentUser?.days_until_exam || 0} days until exam</div>
                </div>
            </div>
           
            <div class="word-tip" style="margin-top: 20px;">
                <i class="fas fa-info-circle"></i> Data taken from your learned words. Server temporarily unavailable.
            </div>
        `;
    }
}

// Show local progress (if server unavailable)
function showLocalProgress() {
    const progressContent = document.getElementById('progressContent');
    
    if (!currentUser) return;
    
    // Calculate local progress from localStorage
    const localProgress = JSON.parse(localStorage.getItem('hsk_word_progress') || '{}');
    const learnedWords = Object.values(localProgress).filter(p => p.remembered).length;
    
    progressContent.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-user"></i> My Profile (local)</h2>
            <div class="icon">üíæ</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="stat-card">
                <h3>Local Progress</h3>
                <div class="stat-number">${learnedWords}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, (learnedWords / 5462) * 100)}%"></div>
                </div>
                <div class="stat-desc">${Math.round((learnedWords / 5462) * 100)}% learned locally</div>
            </div>
            
            <div class="stat-card">
                <h3>Goal</h3>
                <div class="stat-number">HSK ${currentUser.current_level || 1} ‚Üí HSK ${currentUser.target_level || 4}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((currentUser.current_level || 1) / (currentUser.target_level || 4)) * 100}%"></div>
                </div>
                <div class="stat-desc">Server unavailable</div>
            </div>
        </div>
        
        <div class="word-tip" style="margin-top: 20px;">
            <i class="fas fa-info-circle"></i> Data saved locally. Will sync when server connection available.
        </div>
    `;
}

function hideRegisterForm() {
    document.getElementById('registerModal').style.display = 'none';
}

function showProfile() {
    switchTab('progress');
}

function showRegisterFormFull() {
    hideLoginForm();
    document.getElementById('registerModal').style.display = 'flex';
}

// Log in
// Log in
async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    if (!email || !password) {
        alert('Fill in email and password!');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                password: password
            })
        });
        
        if (response.ok) {
            const userData = await response.json();
            currentUser = userData;
            localStorage.setItem('hsk_user', JSON.stringify(userData));
            localStorage.setItem('hsk_user_id', userData.user_id);
            hideLoginForm();
            updateAuthUI();  // This will update UI
            
            // If Progress tab is active - refresh it
            if (document.getElementById('progress-tab').classList.contains('active')) {
                loadProgress();
            }
            
            // Greeting
            addMessage(`üëã Welcome back, ${userData.name}! Your progress: ${userData.stats?.learned_words || 0} learned words.`, 'ai');
        } else {
            const error = await response.json();
            alert(error.detail || 'Login error');
        }
    } catch (error) {
        console.error('Login error:', error);
        // Fallback: create local user
        createLocalUser(email.split('@')[0]);
        hideLoginForm();
    }
}

// Full registration
// Full registration
async function registerFull() {
    const name = document.getElementById('regNameFull').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const currentLevel = parseInt(document.getElementById('regCurrentLevelFull').value);
    const targetLevel = parseInt(document.getElementById('regTargetLevelFull').value);
    
    if (!name || !email || !password) {
        alert('Fill all required fields!');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    try {
        const userData = {
            name: name,
            email: email,
            password: password,
            current_level: currentLevel,
            target_level: targetLevel,
            exam_date: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0],
            exam_location: "Moscow",
            exam_format: "computer",
            interests: ["chinese", "HSK"],
            daily_time: 30,
            learning_style: "visual"
        };
        
        const response = await fetch(`${API_BASE}/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        if (response.ok) {
            const result = await response.json();
            currentUser = result;
            localStorage.setItem('hsk_user', JSON.stringify(result));
            localStorage.setItem('hsk_user_id', result.user_id);
            hideRegisterForm();
            updateAuthUI();  // This will update UI
            
            // If Progress tab is active - refresh it
            if (document.getElementById('progress-tab').classList.contains('active')) {
                loadProgress();
            }
            
            // Greeting
            addMessage(`üéâ Welcome, ${name}! Let's start learning Chinese! Your plan: ${result.plan?.daily_words || 10} words per day.`, 'ai');
        } else {
            const error = await response.json();
            alert(error.detail || 'Registration error');
        }
    } catch (error) {
        console.error('Registration error:', error);
        // Fallback: local registration
        createLocalUser(name);
        hideRegisterForm();
    }
}

// Update UI
// Update UI
function updateAuthUI() {
    const guestView = document.getElementById('guestView');
    const userView = document.getElementById('userView');
    const userNameDisplay = document.getElementById('userNameDisplay');
    
    if (currentUser) {
        guestView.style.display = 'none';
        userView.style.display = 'block';
        userNameDisplay.textContent = currentUser.name;
        
        // Load user chats
        loadUserChats();
        
        // Update progress tab IF it's active
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
    } else {
        guestView.style.display = 'block';
        userView.style.display = 'none';
        
        // Clear chats for guest
        userChats = [];
        currentChatId = null;
        renderChatList();
        clearChatBox();
        
        // Update progress tab IF it's active
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
    }
}

// Logout
// Logout
function logout() {
    if (confirm('Log out of account?')) {
        localStorage.removeItem('hsk_user');
        localStorage.removeItem('hsk_user_id');
        currentUser = null;
        updateAuthUI();  // This will update UI
        
        // If Progress tab is active - refresh its content
        if (document.getElementById('progress-tab').classList.contains('active')) {
            loadProgress();
        }
        
        addMessage('üëã You have logged out. Your progress is saved.', 'ai');
    }
}

// Check authorization on load
async function checkAuth() {
    const savedUser = localStorage.getItem('hsk_user');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            
            // Check token/session validity
            if (currentUser.user_id) {
                const response = await fetch(`${API_BASE}/user/profile/${currentUser.user_id}`);
                if (response.ok) {
                    const freshData = await response.json();
                    currentUser = { ...currentUser, ...freshData };
                    localStorage.setItem('hsk_user', JSON.stringify(currentUser));
                }
            }
            
            updateAuthUI();
            return true;
        } catch (error) {
            console.error('Error loading user:', error);
        }
    }
    return false;
}

// Load user progress
async function loadUserProgress() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/user/profile/${currentUser.user_id}`);
        if (response.ok) {
            const userData = await response.json();
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('hsk_user', JSON.stringify(currentUser));
        }
    } catch (error) {
        console.error('Error loading progress:', error);
    }
}

        // Load statistics
async function loadStats() {
    try {
        const response = await fetch(`${API_BASE}/stats`);
        const stats = await response.json();
        
        let statsHTML = `
            <div class="stat-card">
                <h3>Total Words</h3>
                <div class="stat-number">${stats.total_words || 0}</div>
                <div class="stat-desc">HSK 1-6</div>
            </div>
        `;
        
        // Use real data from server
        if (stats.by_level) {
            // Sort levels by number
            const sortedLevels = Object.entries(stats.by_level).sort((a, b) => {
                const levelA = parseInt(a[0].replace('HSK ', ''));
                const levelB = parseInt(b[0].replace('HSK ', ''));
                return levelA - levelB;
            });
            
            for (const [levelName, count] of sortedLevels) {
                const levelNum = levelName.replace('HSK ', '');
                
                const descriptions = {
                    '1': 'Basic',
                    '2': 'Beginner', 
                    '3': 'Intermediate',
                    '4': 'Advanced',
                    '5': 'Professional',
                    '6': 'Master'
                };
                
                statsHTML += `
                    <div class="stat-card">
                        <h3>${levelName}</h3>
                        <div class="stat-number">${count}</div>
                        <div class="stat-desc">${descriptions[levelNum] || ''} level</div>
                    </div>
                `;
            }
        } else {
            // Fallback if no server data
            for (let level = 1; level <= 6; level++) {
                const descriptions = {
                    1: 'Basic',
                    2: 'Beginner', 
                    3: 'Intermediate',
                    4: 'Advanced',
                    5: 'Professional',
                    6: 'Master'
                };
                
                statsHTML += `
                    <div class="stat-card">
                        <h3>HSK ${level}</h3>
                        <div class="stat-number">...</div>
                        <div class="stat-desc">${descriptions[level]} level</div>
                    </div>
                `;
            }
        }
        
        document.getElementById('stats').innerHTML = statsHTML;
    } catch (error) {
        console.error('Error loading statistics:', error);
        
        // If server unavailable, show message
        document.getElementById('stats').innerHTML = `
            <div class="stat-card" style="grid-column: 1 / -1;">
                <h3>Statistics unavailable</h3>
                <div class="stat-number">‚ùå</div>
                <div class="stat-desc">Server not responding</div>
                <button class="btn btn-primary" onclick="loadStats()" style="margin-top: 10px; padding: 5px 10px; font-size: 0.8em;">
                    Retry
                </button>
            </div>
        `;
    }
}

// Get or create user
async function getOrCreateUser() {
    const storedId = localStorage.getItem('hsk_user_id');
    if (storedId) return storedId;
    
    // Create new user
    const userData = {
        name: "Guest",
        current_level: 1,
        target_level: 4,
        exam_date: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0], // +90 days
        exam_location: "Moscow",
        exam_format: "computer",
        interests: ["chinese", "HSK"],
        daily_time: 30,
        learning_style: "visual"
    };
    
    try {
        const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        localStorage.setItem('hsk_user_id', result.user_id);
        return result.user_id;
    } catch (error) {
        console.error('Registration error:', error);
        return "demo_user_" + Date.now(); // fallback
    }
}

// ========== CHAT SYSTEM ==========

// Load user chats
async function loadUserChats() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/chat/threads/${currentUser.user_id}`);
        if (response.ok) {
            const data = await response.json();
            userChats = data.threads || [];
            currentChatId = data.current_thread;
            renderChatList();
        } else {
            // If API not available, use local data
            loadLocalChats();
        }
    } catch (error) {
        console.log('Chat API unavailable, using local data');
        loadLocalChats();
    }
}

async function generateEssayAnalysis() {
    const topic = document.getElementById('essayAnalysisTopic').value.trim();
    const details = document.getElementById('essayAnalysisDetails').value.trim();
    const difficulty = document.getElementById('essayDifficulty').value;
    const length = parseInt(document.getElementById('essayAnalysisLength').value);
    
    if (!topic) {
        alert('Enter essay topic!');
        return;
    }
    
    // Show loading
    const generateBtn = document.getElementById('generateEssayBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating assignment...';
    generateBtn.disabled = true;
    
    try {
        // Form request according to backend model
        const requestData = {
            topic: topic,
            details: details,
            difficulty: difficulty,
            target_length: length,
            user_id: currentUser?.user_id || null
        };
        
        console.log("Sending assignment generation request:", requestData);
        
        const response = await fetch(`${API_BASE}/essay/analysis/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("Received assignment data:", data);
        
        // Save data
        currentEssayAnalysisData = {
            prompt: data.prompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            requirements: data.requirements,
            evaluation_criteria: data.evaluation_criteria,
            time_limit_minutes: data.time_limit_minutes || 60,
            start_time: new Date(),
            api_data: data  // Save all API data
        };
        
        // Show writing area
        showEssayAnalysisArea(data.prompt, length);
        
        showNotification('‚úÖ Assignment generated! Start writing essay.');
        
    } catch (error) {
        console.error('Error generating assignment:', error);
        showNotification('‚ùå Error generating assignment');
        
        // Fallback: local generation
        const fallbackPrompt = generateFallbackEssayPrompt(topic, difficulty, length);
        currentEssayAnalysisData = {
            prompt: fallbackPrompt,
            topic: topic,
            difficulty: difficulty,
            target_length: length,
            start_time: new Date()
        };
        
        showEssayAnalysisArea(fallbackPrompt, length);
        
    } finally {
        // Restore button
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    }
}

// Show essay analysis result
function showEssayAnalysisResult(result, essayText) {
    console.log("Showing analysis result:", result);
    
    const essayArea = document.getElementById('essayAnalysisArea');
    const resultSection = document.getElementById('essayAnalysisResult');
    
    if (!essayArea || !resultSection) {
        console.error('Elements not found');
        return;
    }
    
    // Hide writing area
    essayArea.style.display = 'none';
    
    // Show result area
    resultSection.style.display = 'block';
    
    // Form HTML for result
    const overallScore = result.overall_score || 0;
    const scoreColor = getScoreColor(overallScore);
    
    let resultHTML = `
        <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-chart-line"></i> Strict Check Result
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="retryEssayAnalysis()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="btn btn-success" onclick="saveEssayAnalysisResult()">
                        <i class="fas fa-download"></i> Save Report
                    </button>
                    <button class="btn btn-warning" onclick="showCorrectedEssay()">
                        <i class="fas fa-edit"></i> Corrected Version
                    </button>
                </div>
            </div>
            
            <!-- Overall score -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 3em; font-weight: bold; color: ${scoreColor}">${overallScore}/100</div>
                        <div style="color: var(--gray);">Overall Score</div>
                        <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                            ${overallScore >= 70 ? 'üéâ You can be proud!' : 
                              overallScore >= 50 ? 'üí™ Okay, but can be better' : 
                              'üìö Need more practice'}
                        </div>
                    </div>
                    
                    ${result.would_pass_exam !== undefined ? `
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; color: ${result.would_pass_exam ? 'var(--success)' : 'var(--danger)'}">
                                ${result.would_pass_exam ? '‚úÖ' : '‚ùå'}
                            </div>
                            <div style="color: var(--gray);">
                                ${result.would_pass_exam ? 'Would pass exam' : 'Would not pass exam'}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">
                            ${essayText.length}
                        </div>
                        <div style="color: var(--gray);">Characters</div>
                    </div>
                </div>
                
                ${result.estimated_level ? `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; display: inline-block;">
                        <strong>Real level:</strong> ${result.estimated_level}
                    </div>
                ` : ''}
            </div>
            
            <!-- Categories -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-chart-pie"></i> Score by Categories:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    `;
    
    // Add categories
    const categories = result.categories || [
        { name: 'Content', score: 0, feedback: '' },
        { name: 'Grammar', score: 0, feedback: '' },
        { name: 'Vocabulary', score: 0, feedback: '' },
        { name: 'Structure', score: 0, feedback: '' }
    ];
    
    categories.forEach(cat => {
        resultHTML += `
            <div class="stat-card">
                <h3>${cat.name}</h3>
                <div class="stat-number">${cat.score}/100</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${cat.score}%; background: ${getScoreColor(cat.score)}"></div>
                </div>
                <div class="stat-desc">${cat.feedback || ''}</div>
            </div>
        `;
    });
    
    resultHTML += `
                </div>
            </div>
            
            <!-- Strengths and weaknesses -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                ${result.strengths ? `
                    <div class="word-card" style="border-left-color: var(--success);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                            <i class="fas fa-check-circle"></i> Strengths:
                        </div>
                        <div>${result.strengths}</div>
                    </div>
                ` : ''}
                
                ${result.weaknesses ? `
                    <div class="word-card" style="border-left-color: var(--danger);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> Weaknesses:
                        </div>
                        <div>${result.weaknesses}</div>
                    </div>
                ` : ''}
            </div>
            
            <!-- Errors -->
            ${result.errors && result.errors.length > 0 ? `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--warning); margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> Found Errors (${result.errors.length}):
                    </h4>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                        ${result.errors.map((err, index) => `
                            <div style="margin-bottom: ${index < result.errors.length - 1 ? '15px' : '0'}; 
                                        padding-bottom: ${index < result.errors.length - 1 ? '15px' : '0'}; 
                                        border-bottom: ${index < result.errors.length - 1 ? '1px solid #ffc107' : 'none'}">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <div style="color: ${err.severity === 'high' ? 'var(--danger)' : 'var(--warning)'}; font-size: 1.2em;">
                                        ${err.severity === 'high' ? '‚ùå' : '‚ö†Ô∏è'}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: var(--danger);">
                                            Error ${index + 1} (${err.type || 'general'}):
                                        </div>
                                        <div style="margin: 5px 0; font-family: 'SimSun', serif;">${err.description}</div>
                                        <div style="color: var(--success);">
                                            <i class="fas fa-check-circle"></i> <strong>Correction:</strong> ${err.correction}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Recommendations -->
            ${result.recommendations ? `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--success); margin-bottom: 15px;">
                        <i class="fas fa-star"></i> Improvement Recommendations:
                    </h4>
                    <div class="word-tip">
                        ${result.recommendations}
                    </div>
                </div>
            ` : ''}
            
            <!-- Statistics -->
            <div>
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-history"></i> Writing Statistics:
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                            ${Math.floor((new Date() - currentEssayAnalysisData.start_time) / 1000 / 60)} min
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Time</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">
                            ${Math.floor(essayText.length / Math.max(1, (new Date() - currentEssayAnalysisData.start_time) / 1000 / 60))}Â≠ó/min
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Speed</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);">
                            ${essayText.split(/[Ôºå„ÄÇÔºÅÔºü]/).filter(s => s.trim()).length}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Sentences</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger);">
                            ${new Set(essayText.match(/[\u4e00-\u9fff]/g) || []).size}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray);">Unique Characters</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultSection.innerHTML = resultHTML;
    
    // Scroll to result
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// ========== GRAMMAR ==========

let grammarTopics = [];
let currentGrammarTopic = null;
let grammarCategories = new Set();

// Load grammar topics
async function loadGrammarTopics() {
    try {
        const response = await fetch(`${API_BASE}/grammar/topics?limit=200`);
        const data = await response.json();
        
        grammarTopics = data.topics || [];
        
        // Debug information
        console.log('All topics loaded:', grammarTopics.length);
        console.log('Levels in data:', [...new Set(grammarTopics.map(t => t.level))]);
        console.log('Example advanced topic:', 
            grammarTopics.find(t => t.level === 'È´ò'));
        
        // Collect categories
        grammarCategories.clear();
        grammarTopics.forEach(topic => {
            if (topic.category) grammarCategories.add(topic.category);
        });
        
        // Fill category filter
        const categoryFilter = document.getElementById('grammarCategoryFilter');
        categoryFilter.innerHTML = '<option value="">All categories</option>';
        Array.from(grammarCategories).sort().forEach(cat => {
            categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        
        renderGrammarTopicsList();
        
        // Show statistics
        document.getElementById('grammarCount').textContent = grammarTopics.length;
        
        // Load history if user authorized
        if (currentUser) {
            loadGrammarHistory();
        }
        
    } catch (error) {
        console.error('Error loading grammar:', error);
        document.getElementById('grammarTopicsList').innerHTML = `
            <div class="loading">
                <p>‚ùå Error loading grammar</p>
                <button class="btn btn-primary" onclick="loadGrammarTopics()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

// Render topic list
function renderGrammarTopicsList(filteredTopics = grammarTopics) {
    const topicsList = document.getElementById('grammarTopicsList');
    
    if (filteredTopics.length === 0) {
        topicsList.innerHTML = '<p style="text-align: center; color: var(--gray);">Topics not found</p>';
        return;
    }
    
    topicsList.innerHTML = filteredTopics.map(topic => {
        const complexity = topic.complexity || 3;
        const complexityColor = complexity <= 2 ? 'var(--success)' : 
                               complexity <= 4 ? 'var(--warning)' : 'var(--danger)';
        
        return `
            <div class="grammar-topic-item" 
                 onclick="selectGrammarTopic('${topic.id}')"
                 style="padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; 
                        background: ${currentGrammarTopic?.id === topic.id ? '#e3f2fd' : '#f8f9fa'};
                        border-left: 4px solid ${getLevelColor(topic.level)};
                        transition: all 0.3s;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: ${currentGrammarTopic?.id === topic.id ? 'bold' : 'normal'}; 
                                    color: var(--dark); margin-bottom: 5px;">
                            ${topic.chinese}
                        </div>
                        <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">
                            ${topic.english}
                        </div>
                        <div style="font-size: 0.8em; color: var(--gray);">
                            ${topic.russian}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: end; gap: 5px;">
                        <span class="word-level" style="font-size: 0.7em; background: ${getLevelColor(topic.level)};">
                            ${topic.level}
                        </span>
                        <div style="font-size: 0.7em; color: ${complexityColor};">
                            ${'‚òÖ'.repeat(Math.min(5, complexity))}${'‚òÜ'.repeat(5 - Math.min(5, complexity))}
                        </div>
                    </div>
                </div>
                ${topic.tags ? `
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                        ${topic.tags.map(tag => `
                            <span style="font-size: 0.7em; background: #e9ecef; padding: 2px 6px; border-radius: 10px;">
                                ${tag}
                            </span>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Colors for levels
function getLevelColor(level) {
    const colors = {
        'Âàù': '#667eea', // blue - beginner
        '‰∏≠': '#4cd964', // green - intermediate
        'È´ò': '#f5576c', // red - advanced
        // Additional options for different notations
        'beginner': '#667eea',
        'intermediate': '#4cd964',
        'advanced': '#f5576c',
        'HSK1-2': '#667eea',
        'HSK3-4': '#4cd964',
        'HSK5-6': '#f5576c',
        '1': '#667eea',
        '2': '#4cd964',
        '3': '#f5576c'
    };
    return colors[level] || '#6c757d';
}

// Select grammar topic
async function selectGrammarTopic(topicId) {
    // Find topic
    currentGrammarTopic = grammarTopics.find(t => t.id === topicId);
    if (!currentGrammarTopic) return;
    
    // Update list (highlight selected)
    renderGrammarTopicsList();
    
    // Show loading in details
    const detailsDiv = document.getElementById('grammarTopicDetails');
    detailsDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>üß† AI generating explanation...</p>
        </div>
    `;
    
    try {
        // Get AI explanation
        const response = await fetch(`${API_BASE}/grammar/explain`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic_id: topicId,
                user_id: currentUser?.user_id || null
            })
        });
        
        const explanation = await response.json();
        
        // Display explanation
        displayGrammarExplanation(explanation);
        
        // Show button for exercises
        const exercisesDiv = document.getElementById('grammarExercises');
        exercisesDiv.innerHTML = `
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-success" onclick="generateGrammarPractice('${topicId}')">
                    <i class="fas fa-dumbbell"></i> Generate Exercises
                </button>
            </div>
        `;
        exercisesDiv.style.display = 'block';
        
    } catch (error) {
        console.error('Error loading explanation:', error);
        detailsDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ùå</div>
                <h3>Loading Error</h3>
                <p>Failed to get explanation</p>
                <button class="btn btn-primary" onclick="selectGrammarTopic('${topicId}')" style="margin-top: 10px;">
                    Try Again
                </button>
            </div>
        `;
    }
}



// Display grammar explanation
function displayGrammarExplanation(explanation) {
    const detailsDiv = document.getElementById('grammarTopicDetails');
    
    // Format examples
    let examplesHTML = '';
    if (explanation.examples && Array.isArray(explanation.examples)) {
        examplesHTML = explanation.examples.map((example, index) => `
            <div style="margin-bottom: ${index < explanation.examples.length - 1 ? '15px' : '0'}; 
                        padding-bottom: ${index < explanation.examples.length - 1 ? '15px' : '0'}; 
                        border-bottom: ${index < explanation.examples.length - 1 ? '1px solid #dee2e6' : 'none'}">
                <div style="font-size: 1.1em; margin-bottom: 5px; font-weight: bold;">
                    ${example.chinese || ''}
                </div>
                <div style="color: var(--danger); margin-bottom: 5px;">
                    ${example.pinyin || ''}
                </div>
                <div style="color: var(--gray); margin-bottom: 5px;">
                    ${example.translation || ''}
                </div>
                ${example.explanation ? `
                    <div style="font-size: 0.9em; color: var(--warning);">
                        <i class="fas fa-lightbulb"></i> ${example.explanation}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    detailsDiv.innerHTML = `
        <div style="max-height: 450px; overflow-y: auto; padding-right: 10px;">
            <!-- Header -->
            <div style="margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin-bottom: 5px;">
                    ${explanation.topic_chinese || currentGrammarTopic.chinese}
                </h2>
                <div style="color: var(--danger); font-size: 1.1em; margin-bottom: 5px;">
                    ${explanation.topic_pinyin || currentGrammarTopic.pinyin}
                </div>
                <div style="color: var(--gray); margin-bottom: 15px;">
                    ${explanation.topic_english || currentGrammarTopic.english} ‚Ä¢ 
                    ${explanation.topic_russian || currentGrammarTopic.russian}
                </div>
            </div>
            
            <!-- Summary -->
            ${explanation.topic_summary ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--primary);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                        <i class="fas fa-info-circle"></i> Brief Summary:
                    </div>
                    <div>${explanation.topic_summary}</div>
                </div>
            ` : ''}
            
            <!-- Basic rule -->
            ${explanation.basic_rule ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--success);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                        <i class="fas fa-gavel"></i> Basic Rule:
                    </div>
                    <div>${explanation.basic_rule}</div>
                </div>
            ` : ''}
            
            <!-- Formula -->
            ${explanation.formula ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--warning);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">
                        <i class="fas fa-calculator"></i> Formula/Pattern:
                    </div>
                    <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        ${explanation.formula}
                    </div>
                </div>
            ` : ''}
            
            <!-- Examples -->
            ${examplesHTML ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--danger);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                        <i class="fas fa-comment-alt"></i> Examples:
                    </div>
                    ${examplesHTML}
                </div>
            ` : ''}
            
            <!-- Common mistakes -->
            ${explanation.common_mistakes ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--danger);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle"></i> Common Mistakes for Russian Speakers:
                    </div>
                    <div>${explanation.common_mistakes}</div>
                </div>
            ` : ''}
            
            <!-- Memory tips -->
            ${explanation.memory_tips ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--accent);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--accent);">
                        <i class="fas fa-brain"></i> Memory Tips:
                    </div>
                    <div>${explanation.memory_tips}</div>
                </div>
            ` : ''}
            
            <!-- Practice -->
            ${explanation.practice_sentences ? `
                <div class="word-card" style="margin-bottom: 15px; border-left-color: var(--success);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                        <i class="fas fa-dumbbell"></i> Practice Sentences:
                    </div>
                    <div>${Array.isArray(explanation.practice_sentences) 
                        ? explanation.practice_sentences.map(s => `‚Ä¢ ${s}`).join('<br>')
                        : explanation.practice_sentences}</div>
                </div>
            ` : ''}
            
            ${explanation.fallback ? `
                <div class="word-tip" style="background: #fff3cd; border-left-color: #ffc107;">
                    <i class="fas fa-exclamation-triangle"></i> ${explanation.note || 'Using basic explanation'}
                </div>
            ` : ''}
        </div>
    `;
}

// Generate exercises
// Generate exercises
async function generateGrammarPractice(topicId) {
    const exercisesDiv = document.getElementById('grammarExercises');
    exercisesDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>üéØ AI generating exercises...</p>
        </div>
    `;
    
    try {
        // Use GET request
        const response = await fetch(`${API_BASE}/grammar/practice/${topicId}?difficulty=medium`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const data = await response.json();
        
        console.log('Exercises received:', data);
        
        displayGrammarExercises(data);
        
    } catch (error) {
        console.error('Error generating exercises:', error);
        exercisesDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ùå</div>
                <p>Error generating exercises</p>
                <p style="font-size: 0.9em; color: var(--gray);">${error.message}</p>
                <button class="btn btn-primary" onclick="generateGrammarPractice('${topicId}')" style="margin-top: 10px;">
                    Try Again
                </button>
            </div>
        `;
    }
}

// Display exercises
// Display exercises
function displayGrammarExercises(data) {
    const exercisesDiv = document.getElementById('grammarExercises');
    
    console.log('Data for display:', data); // For debugging
    
    // If there's an error
    if (data.error) {
        exercisesDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <div style="font-size: 2em;">‚ö†Ô∏è</div>
                <h4>${data.error}</h4>
                <p>Try again or choose another topic</p>
            </div>
        `;
        return;
    }
    
    let exercisesHTML = `
        <h3 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-dumbbell"></i> Exercises on Topic
            <span class="word-level" style="font-size: 0.8em; margin-left: 10px;">
                Difficulty: ${data.difficulty || 'medium'}
            </span>
        </h3>
    `;
    
    const exercises = data.exercises || data; // Check both variants
    
    // Multiple choice
    if (exercises.multiple_choice && Array.isArray(exercises.multiple_choice) && exercises.multiple_choice.length > 0) {
    exercisesHTML += `
        <div class="word-card" style="margin-bottom: 20px;">
            <div style="font-weight: bold; margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-list-ol"></i> Choose Correct Option:
            </div>
            ${exercises.multiple_choice.map((q, index) => {
                const options = q.options || [];
                return `
                    <div style="margin-bottom: 15px; padding-bottom: 15px; 
                                border-bottom: ${index < exercises.multiple_choice.length - 1 ? '1px solid #dee2e6' : 'none'}">
                        <div style="font-weight: bold; margin-bottom: 10px;">${index + 1}. ${q.question || 'Question'}</div>
                        <div class="test-options" style="margin-top: 10px;">
                            ${options.map((opt, optIndex) => `
                                <div class="test-option" onclick="checkGrammarAnswer(this, '${String.fromCharCode(65 + optIndex)}', '${q.correct}', ${index})">
                                    ${String.fromCharCode(65 + optIndex)}) ${opt}
                                </div>
                            `).join('')}
                        </div>
                        <div id="explanation-${index}" class="answer-explanation" style="display: none; margin-top: 10px; padding: 10px; 
                                background: #e3f2fd; border-radius: 5px; color: #1976d2;">
                            <strong>Explanation:</strong> ${q.explanation || 'Correct answer: ' + (q.correct || 'A')}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}
    
    // Fill in blanks
    if (exercises.fill_in_blanks) {
        exercisesHTML += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--success);">
                    <i class="fas fa-edit"></i> Fill in Blanks:
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-line;">
                    ${exercises.fill_in_blanks}
                </div>
            </div>
        `;
    }
    
    // Error correction
    if (exercises.error_correction) {
        exercisesHTML += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--warning);">
                    <i class="fas fa-exclamation-triangle"></i> Find and Correct Errors:
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-line;">
                    ${exercises.error_correction}
                </div>
            </div>
        `;
    }
    
    // Sentence formation
    if (exercises.sentence_formation) {
        exercisesHTML += `
            <div class="word-card">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--danger);">
                    <i class="fas fa-puzzle-piece"></i> Make Sentences from Words:
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-line;">
                    ${exercises.sentence_formation}
                </div>
            </div>
        `;
    }
    
    // If no exercises at all
    if (!exercises.multiple_choice && !exercises.fill_in_blanks && 
        !exercises.error_correction && !exercises.sentence_formation) {
        exercisesHTML += `
            <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                <div style="font-size: 3em;">üìù</div>
                <h4>Exercises not available yet</h4>
                <p>AI couldn't generate exercises for this topic</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateGrammarPractice('${currentGrammarTopic?.id}')">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            </div>
        `;
    } else {
        exercisesHTML += `
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="generateGrammarPractice('${currentGrammarTopic?.id}')">
                    <i class="fas fa-sync-alt"></i> Generate New Exercises
                </button>
            </div>
        `;
    }
    
    exercisesDiv.innerHTML = exercisesHTML;
    exercisesDiv.style.display = 'block';
}

// Check answers in exercises
function checkGrammarAnswer(element, userAnswer, correctAnswer) {
    // Reset all highlights in this question
    const questionDiv = element.closest('.test-options').parentNode;
    questionDiv.querySelectorAll('.test-option').forEach(opt => {
        opt.classList.remove('selected', 'correct', 'wrong');
    });
    
    // Highlight selected option
    element.classList.add('selected');
    
    // Check answer
    if (userAnswer === correctAnswer) {
        element.classList.add('correct');
        element.style.borderColor = 'var(--success)';
        element.style.background = '#e3f2fd';
    } else {
        element.classList.add('wrong');
        element.style.borderColor = 'var(--danger)';
        element.style.background = '#fde8e8';
        
        // Highlight correct answer
        questionDiv.querySelectorAll('.test-option').forEach(opt => {
            if (opt.textContent.startsWith(correctAnswer + ')')) {
                opt.classList.add('correct');
                opt.style.borderColor = 'var(--success)';
                opt.style.background = '#e3f2fd';
            }
        });
    }
    
    // Show explanation
    const explanation = questionDiv.querySelector('.answer-explanation');
    if (explanation) {
        explanation.style.display = 'block';
    }
}

// Filter topics
// Filter topics
function filterGrammarTopics() {
    const levelFilter = document.getElementById('grammarLevelFilter').value;
    const categoryFilter = document.getElementById('grammarCategoryFilter').value;
    const sortBy = document.getElementById('grammarSort').value;
    
    let filtered = grammarTopics;
    
    if (levelFilter) {
        filtered = filtered.filter(t => {
            const topicLevel = t.level;
            // Simple filtering by exact match
            return topicLevel === levelFilter;
        });
    }
    
    if (categoryFilter) {
        filtered = filtered.filter(t => t.category === categoryFilter);
    }
    
    // Sorting
    if (sortBy === 'complexity') {
        filtered.sort((a, b) => (a.complexity || 3) - (b.complexity || 3));
    } else if (sortBy === 'level') {
        // Simple sorting by level: Âàù -> ‰∏≠ -> È´ò
        const levelOrder = { 'Âàù': 1, '‰∏≠': 2, 'È´ò': 3 };
        filtered.sort((a, b) => {
            const levelA = levelOrder[a.level] || 0;
            const levelB = levelOrder[b.level] || 0;
            return levelA - levelB;
        });
    } else if (sortBy === 'name') {
        filtered.sort((a, b) => a.chinese.localeCompare(b.chinese));
    }
    
    renderGrammarTopicsList(filtered);
}

// Search topics
function searchGrammarTopics() {
    const searchTerm = document.getElementById('grammarSearch').value.toLowerCase();
    
    if (!searchTerm) {
        filterGrammarTopics();
        return;
    }
    
    const filtered = grammarTopics.filter(topic => 
        topic.chinese.toLowerCase().includes(searchTerm) ||
        topic.pinyin.toLowerCase().includes(searchTerm) ||
        topic.english.toLowerCase().includes(searchTerm) ||
        topic.russian.toLowerCase().includes(searchTerm) ||
        (topic.tags && topic.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
    );
    
    renderGrammarTopicsList(filtered);
}

// Load statistics
async function loadGrammarStats() {
    try {
        const response = await fetch(`${API_BASE}/grammar/stats`);
        const stats = await response.json();
        
        const statsDiv = document.getElementById('grammarStats');
        
        // Beautiful statistics display
        statsDiv.innerHTML = `
            <div class="word-card" style="border-left-color: var(--primary); margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                    <i class="fas fa-chart-bar"></i> Grammar Statistics:
                </div>
                
                <!-- Total topics -->
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.9em; color: var(--gray);">Total Topics:</span>
                        <span style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                            ${stats.total_topics || 0}
                        </span>
                    </div>
                </div>
                
                <!-- Levels (vertically) -->
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">Levels:</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${(stats.by_level_formatted || Object.entries(stats.by_level || {})).map(item => {
                            const level = item.level || item[0];
                            const count = item.count || item[1];
                            const display = item.display || 
                                {"Âàù": "Beginner", "‰∏≠": "Intermediate", "È´ò": "Advanced"}[level] || level;
                            const color = {"Âàù": "#667eea", "‰∏≠": "#4cd964", "È´ò": "#f5576c"}[level] || "#6c757d";
                            
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${color};"></div>
                                        <span style="font-size: 0.9em;">${display}</span>
                                    </div>
                                    <span class="word-level" style="font-size: 0.8em; background: ${color};">${count}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Complexity -->
                <div>
                    <div style="font-size: 0.9em; color: var(--gray); margin-bottom: 5px;">Complexity:</div>
                    <div style="display: flex; gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--success);">
                                ${stats.complexity_distribution?.easy || 0}
                            </div>
                            <div style="font-size: 0.7em;">Easy</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--warning);">
                                ${stats.complexity_distribution?.medium || 0}
                            </div>
                            <div style="font-size: 0.7em;">Medium</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--danger);">
                                ${stats.complexity_distribution?.hard || 0}
                            </div>
                            <div style="font-size: 0.7em;">Hard</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        statsDiv.style.display = 'block';
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        const statsDiv = document.getElementById('grammarStats');
        statsDiv.innerHTML = `
            <div class="word-card" style="border-left-color: var(--danger);">
                <div style="color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i> Error loading statistics
                </div>
            </div>
        `;
        statsDiv.style.display = 'block';
    }
}

// Load learning history
async function loadGrammarHistory() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/grammar/history/${currentUser.user_id}`);
        const data = await response.json();
        
        if (data.history && data.history.length > 0) {
            const historyDiv = document.getElementById('grammarHistory');
            const contentDiv = document.getElementById('grammarHistoryContent');
            
            contentDiv.innerHTML = data.history.map(item => `
                <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 0.9em;">
                    <div style="font-weight: bold;">${item.topic_info?.chinese || item.topic_id}</div>
                    <div style="color: var(--gray); font-size: 0.8em;">
                        ${formatDate(item.studied_at)}
                    </div>
                </div>
            `).join('');
            
            historyDiv.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

// Ask grammar question
async function askGrammarQuestion() {
    const question = prompt('Ask a question about Chinese grammar:');
    if (!question) return;
    
    try {
        const response = await fetch(`${API_BASE}/grammar/ask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question: question,
                user_id: currentUser?.user_id || null,
                topic_id: currentGrammarTopic?.id || null
            })
        });
        
        const data = await response.json();
        
        // Show answer in popup
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
            align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 15px; 
                        width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 15px; color: var(--primary);">
                    <i class="fas fa-question-circle"></i> Answer to Your Question
                </h3>
                <div style="margin-bottom: 15px; font-weight: bold;">
                    ${question}
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    ${data.answer?.answer || 'No answer received'}
                </div>
                ${data.answer?.examples ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Examples:</strong><br>
                        ${data.answer.examples}
                    </div>
                ` : ''}
                <button onclick="this.parentElement.parentElement.remove()" 
                        class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Question error:', error);
        alert('Failed to get answer. Check internet connection.');
    }
}

// Add to switchTab for grammar
// Update switchTab function

// Load local chats
// Load local chats
function loadLocalChats() {
    const savedChats = localStorage.getItem(`hsk_chats_${currentUser?.user_id}`);
    if (savedChats) {
        try {
            userChats = JSON.parse(savedChats);
            console.log('Loaded local chats:', userChats.length);
            
            // Check structure of each chat
            userChats.forEach(chat => {
                console.log(`Chat ${chat.title}: ${chat.messages?.length || 0} messages`);
            });
            
            if (userChats.length > 0) {
                // Choose last active chat
                userChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                currentChatId = userChats[0].thread_id;
                renderChatList();
                loadChatMessages(currentChatId);
            }
        } catch (error) {
            console.error('Error loading local chats:', error);
            // Create first chat
            createLocalChat();
        }
    } else {
        console.log('Local chats not found, creating first chat');
        // Create first chat
        createLocalChat();
    }
}

// Save on page refresh
window.addEventListener('beforeunload', function() {
    saveChatsLocally();
});

// Save chats locally
function saveChatsLocally() {
    if (!currentUser) {
        console.log('User not authorized, not saving chats');
        return;
    }
    
    try {
        // Update modification date for all chats
        userChats.forEach(chat => {
            if (chat.messages && chat.messages.length > 0) {
                chat.updated_at = new Date().toISOString();
            }
        });
        
        const data = JSON.stringify(userChats);
        localStorage.setItem(`hsk_chats_${currentUser.user_id}`, data);
        console.log('Chats saved locally:', userChats.length, 'chats');
    } catch (error) {
        console.error('Error saving chats:', error);
    }
}

// Create new chat
// Create new chat
async function createNewChat() {
    if (!currentUser) {
        alert('Log in to create chats!');
        showLoginForm();
        return;
    }
    
    try {
        // Send as QUERY PARAMETERS (not JSON!)
        const url = `${API_BASE}/chat/threads/create?user_id=${encodeURIComponent(currentUser.user_id)}&title=${encodeURIComponent("New Chat")}&category=general`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
            // Do NOT send body!
        });
        
        if (response.ok) {
            const data = await response.json();
            userChats.push(data.thread);
            currentChatId = data.thread.thread_id;
            renderChatList();
            clearChatBox();
            saveChatsLocally();
        } else {
            // Fallback: local creation
            createLocalChat();
        }
    } catch (error) {
        console.error('Error creating chat:', error);
        createLocalChat();
    }
}

// Create local chat
// Create local chat
function createLocalChat() {
    const chatId = `chat_${Date.now()}`;
    const newChat = {
        thread_id: chatId,
        user_id: currentUser.user_id,
        title: "New Chat",
        category: "general",
        created_at: new Date().toISOString(),
        messages: [],  // Make sure this is an array
        updated_at: new Date().toISOString()
    };
    
    userChats.push(newChat);
    currentChatId = chatId;
    renderChatList();
    clearChatBox();
    saveChatsLocally();
    
    console.log('Created new local chat:', chatId);
    
    return newChat;
}

// Display chat list
function renderChatList() {
    const chatList = document.getElementById('chatList');
    if (!chatList) return;
    
    chatList.innerHTML = '';
    
    userChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
    
    userChats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${chat.thread_id === currentChatId ? 'active' : ''}`;
        chatItem.style.cssText = `
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            background: ${chat.thread_id === currentChatId ? '#e3f2fd' : '#f8f9fa'};
            border-left: 3px solid ${getCategoryColor(chat.category)};
            display: flex;
            justify-content: space-between;
            align-items: center;
        `;
        
        chatItem.innerHTML = `
            <div style="overflow: hidden;">
                <div style="font-weight: ${chat.thread_id === currentChatId ? 'bold' : 'normal'}; font-size: 0.9em;">
                    ${chat.title.length > 20 ? chat.title.substring(0, 20) + '...' : chat.title}
                </div>
                <div style="font-size: 0.8em; color: #6c757d;">
                    ${formatDate(chat.updated_at)}
                </div>
            </div>
            <div class="chat-category" style="font-size: 0.7em; background: ${getCategoryColor(chat.category)}; color: white; padding: 2px 6px; border-radius: 10px;">
                ${getCategoryIcon(chat.category)}
            </div>
        `;
        
        chatItem.onclick = () => switchChat(chat.thread_id);
        chatList.appendChild(chatItem);
    });
    
    updateChatInfo();
}

// Colors for categories
function getCategoryColor(category) {
    const colors = {
        'general': '#667eea',
        'grammar': '#f093fb',
        'vocabulary': '#4cd964',
        'test_prep': '#ff9a00',
        'strategy': '#f5576c'
    };
    return colors[category] || '#667eea';
}

// Icons for categories
function getCategoryIcon(category) {
    const icons = {
        'general': 'üí¨',
        'grammar': 'üìö',
        'vocabulary': 'üìñ',
        'test_prep': 'üß™',
        'strategy': 'üéØ'
    };
    return icons[category] || 'üí¨';
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min`;
    if (diffHours < 24) return `${diffHours} h`;
    if (diffDays < 7) return `${diffDays} d`;
    
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

// Switch chat
async function switchChat(chatId) {
    currentChatId = chatId;
    renderChatList();
    await loadChatMessages(chatId);
}

// Load chat messages
// Load chat messages
async function loadChatMessages(chatId) {
    clearChatBox();
    
    const chat = userChats.find(c => c.thread_id === chatId);
    if (!chat) {
        console.error('Chat not found:', chatId);
        return;
    }
    
    console.log('Loading chat messages:', chatId);
    console.log('Messages in chat:', chat.messages.length);
    
    // If chat has messages, show them
    if (chat.messages && chat.messages.length > 0) {
        chat.messages.forEach(msg => {
            console.log('Showing message:', msg.role, msg.content.substring(0, 50));
            addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
        });
    } else {
        // ONLY if chat is really new, show greeting
        addMessage(`Hello! I'm your pragmatic HSK tutor. Ask me about exam life hacks!`, 'ai');
    }
}

// Clear chat window
function clearChatBox() {
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '';
}

// Update chat title from first message
function updateChatTitleFromMessage(message) {
    const chat = userChats.find(c => c.thread_id === currentChatId);
    if (!chat || chat.title !== "New Chat") return;
    
    // Create short title from message
    let newTitle = message.trim();
    if (newTitle.length > 30) {
        newTitle = newTitle.substring(0, 30) + '...';
    }
    
    chat.title = newTitle;
    renderChatList();
    saveChatsLocally();
    updateChatInfo();
}

// Update chat information
function updateChatInfo() {
    const chatInfo = document.getElementById('chatInfo');
    const chatTitleInput = document.getElementById('chatTitleInput');
    const chatCategory = document.getElementById('chatCategory');
    
    const chat = userChats.find(c => c.thread_id === currentChatId);
    if (chat) {
        chatInfo.style.display = 'block';
        chatTitleInput.value = chat.title;
        chatCategory.value = chat.category;
    } else {
        chatInfo.style.display = 'none';
    }
}

function quickTranslate(text) {
    document.getElementById('translateInput').value = text;
    smartTranslate();
}

// Smart translation

async function smartTranslate() {
    const input = document.getElementById('translateInput');
    const text = input.value.trim();
    
    if (!text) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    const resultDiv = document.getElementById('translationResult');
    resultDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>üß† AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç...</p>
        </div>
    `;
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ (–µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç ‚Äî false)
    const includeExercises = document.getElementById('includeExercises')?.checked || false;
    const analyzePronunciationChecked = document.getElementById('analyzePronunciation')?.checked || false;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
    const request = {
        text: text,
        user_id: currentUser?.user_id || null,
        detailed: true,
        include_exercises: includeExercises
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª–æ –≤–µ—á–Ω–æ
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000); // 30 —Å–µ–∫
    
    try {
        const response = await fetch(`${API_BASE}/ai/translate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request),
            signal: controller.signal  // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞—ë–º —Å–∏–≥–Ω–∞–ª –¥–ª—è –æ—Ç–º–µ–Ω—ã
        });
        
        clearTimeout(timeoutId); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–∞—É—Ç
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status} ‚Äî ${errorText}`);
        }
        
        const data = await response.json();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        displayTranslationResult(data);
        
        // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –±—ã–ª –∏ –≤–∫–ª—é—á—ë–Ω
        if (analyzePronunciationChecked) {
            await analyzePronunciation(text);
        }
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
        
        let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        if (error.name === 'AbortError') {
            errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30 —Å–µ–∫). –°–µ—Ä–≤–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞.';
        } else {
            errorMessage = error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ';
        }
        
        resultDiv.innerHTML = `
            <div style="text-align: center; padding: 30px; color: var(--danger);">
                <div style="font-size: 3em; margin-bottom: 20px;">‚ùå</div>
                <h3>–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞</h3>
                <p>${errorMessage}</p>
                <button class="btn btn-primary" onclick="smartTranslate()">
                    üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                </button>
            </div>
        `;
    }
}

// Display translation result
function displayTranslationResult(data) {
    const resultDiv = document.getElementById('translationResult');
    const detailsDiv = document.getElementById('translationDetails');
    
    // Main result
    resultDiv.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-language"></i> Translation Result
                </h3>
                <span class="word-level">
                    Difficulty: ${data.difficulty_score || 5}/10
                </span>
            </div>
            
            <!-- Original -->
            <div class="word-card" style="margin-bottom: 15px;">
                <div class="word-header">
                    <div class="word-character">${data.original || ''}</div>
                </div>
                <div class="word-pinyin">${data.pinyin || ''}</div>
            </div>
            
            <!-- Translation -->
            <div class="word-card" style="border-left-color: var(--success);">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                    <i class="fas fa-exchange-alt"></i> Translation:
                </div>
                <div style="font-size: 1.1em; margin-bottom: 10px;">
                    ${data.translation || ''}
                </div>
                ${data.word_by_word ? `
                    <div style="font-size: 0.9em; color: var(--gray); font-style: italic;">
                        Word-by-word: ${data.word_by_word}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Translation details
    let detailsHTML = `
        <div style="margin-top: 30px;">
            <h3><i class="fas fa-info-circle"></i> Detailed Analysis</h3>
            
            <!-- Grammar -->
            ${data.grammar_explanation ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                        <i class="fas fa-book"></i> Grammar Explanation:
                    </div>
                    <div>${data.grammar_explanation}</div>
                </div>
            ` : ''}
            
            <!-- Key words -->
            ${data.key_words && data.key_words.length > 0 ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">
                        <i class="fas fa-key"></i> Key Words:
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                        ${data.key_words.map(word => `
                            <div style="padding: 10px; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div style="font-size: 1.3em; font-weight: bold;">${word.character}</div>
                                <div style="color: var(--danger);">${word.pinyin}</div>
                                <div style="font-size: 0.9em;">${word.translation}</div>
                                ${word.explanation ? `<div style="font-size: 0.8em; color: var(--gray); margin-top: 5px;">${word.explanation}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Example sentences -->
            ${data.example_sentences && data.example_sentences.length > 0 ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--danger);">
                        <i class="fas fa-comment-alt"></i> Example Sentences:
                    </div>
                    ${data.example_sentences.map((example, index) => `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: ${index < data.example_sentences.length - 1 ? '1px solid #dee2e6' : 'none'}">
                            <div style="font-size: 1.1em; margin-bottom: 5px;">${example.chinese}</div>
                            <div style="color: var(--danger); margin-bottom: 5px;">${example.pinyin}</div>
                            <div style="color: var(--gray);">${example.translation}</div>
                            ${example.explanation ? `<div style="font-size: 0.9em; color: var(--warning); margin-top: 5px;"><i class="fas fa-lightbulb"></i> ${example.explanation}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <!-- Study tips -->
            ${data.study_tips ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--success);">
                        <i class="fas fa-lightbulb"></i> Study Tips:
                    </div>
                    <div>${data.study_tips}</div>
                </div>
            ` : ''}
            
            <!-- Cultural notes -->
            ${data.cultural_notes ? `
                <div class="word-card" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--secondary);">
                        <i class="fas fa-globe-asia"></i> Cultural Context:
                    </div>
                    <div>${data.cultural_notes}</div>
                </div>
            ` : ''}
            
            <!-- Exercises -->
            
        </div>
    `;
    
    detailsDiv.innerHTML = detailsHTML;
    detailsDiv.style.display = 'block';
}

// Global variables for word management
let allWords = [];
let currentWordsPage = 1;
let wordsPerPage = 12;
let filteredWords = [];
let userWordsStatus = {}; // {wordId: {status: 'saved'/'learned', added_at: timestamp}}

// Initialize words tab
async function initWordsTab() {
    console.log('=== INITIALIZING WORDS TAB ===');

    // Find CONTENT container (word list), NOT statistics!
    const wordsList = document.getElementById('wordsList'); // or #wordsContainer, #wordsGrid - the one with word cards
    // If you have a different ID - use the correct one!

    // Show loading ONLY in word list
    if (wordsList) {
        wordsList.innerHTML = `
            <div style="text-align: center; padding: 80px 20px; color: var(--gray);">
                <div class="loading-spinner" style="width: 60px; height: 60px; margin: 0 auto 30px;"></div>
                <p style="font-size: 1.2em;">Loading words from server...</p>
            </div>
        `;
    }

    // 1. Load statuses from localStorage (synchronously)
    loadUserWordsStatus();

    // 2. Wait for word loading from server
    try {
        await loadWordsFromServer();
    } catch (error) {
        console.error('Error loading words:', error);
        if (wordsList) {
            wordsList.innerHTML = `
                <div style="text-align: center; padding: 80px; color: var(--danger);">
                    <p>Failed to load words. Check internet connection.</p>
                    <button class="btn btn-primary" onclick="initWordsTab()">Retry</button>
                </div>
            `;
        }
        return;
    }

    // 3. After successful loading - update everything
    displayWords();         // show cards
    updateWordsStats();     // ‚Üê update labels: Learned, Problematic, %
    
    // If active filter or search - reapplies
    if (currentFilter && currentFilter !== 'all') {
        filterWords();
    }
    if (currentSearchQuery) {
        searchWords();
    }

    console.log('"Words" tab fully initialized');
}

function loadUserWordsStatus() {
    console.log('loadUserWordsStatus started');

    // Wait for currentUser to be available (if it exists)
    if (!currentUser && localStorage.getItem('hsk_user')) {
        try {
            currentUser = JSON.parse(localStorage.getItem('hsk_user'));
            console.log('currentUser restored from localStorage:', currentUser?.user_id);
        } catch (e) {
            console.error('Error parsing hsk_user:', e);
        }
    }

    const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
    console.log('Key used for word statuses:', savedKey);

    const saved = localStorage.getItem(savedKey);
    console.log('Found in localStorage with this key:', saved);

    if (saved) {
        try {
            userWordsStatus = JSON.parse(saved);
            console.log('Successfully loaded word statuses:', Object.keys(userWordsStatus).length);
        } catch (e) {
            console.error('Error parsing word statuses:', e);
            userWordsStatus = {};
        }
    } else {
        console.log('No saved statuses for key', savedKey);
        userWordsStatus = {};
    }

    // Global variable for access from other functions
    window.userWordsStatus = userWordsStatus;
}

// Save word statuses
function saveUserWordsStatus() {
    try {
        const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
        localStorage.setItem(savedKey, JSON.stringify(userWordsStatus));
        console.log('üíæ Saved statuses:', Object.keys(userWordsStatus).length, 'words');
    } catch (e) {
        console.error('‚ùå Save error:', e);
    }
}

// Load words from server
async function loadWordsFromServer() {
    try {
        const response = await fetch(`${API_BASE}/words/level/1`);
        if (response.ok) {
            const data = await response.json();
            allWords = data.words || [];
        } else {
            // Fallback: create test words
            allWords = generateTestWords();
        }
        
        // Load words from other levels
        for (let level = 2; level <= 6; level++) {
            try {
                const levelResponse = await fetch(`${API_BASE}/words/level/${level}`);
                if (levelResponse.ok) {
                    const levelData = await levelResponse.json();
                    allWords = [...allWords, ...(levelData.words || [])];
                }
            } catch (e) {
                console.warn(`Failed to load HSK ${level} words:`, e);
            }
        }
        
        // Initialize filtered words
        filteredWords = [...allWords];
        
        // Update display
        displayWords();
        
    } catch (error) {
        console.error('Error loading words:', error);
        allWords = generateTestWords();
        filteredWords = [...allWords];
        displayWords();
    }
    
}

// Generate test words (fallback)
function generateTestWords() {
    const testWords = [];
    const levels = [1, 2, 3, 4, 5, 6];
    
    // HSK 1 words
    const hsk1Words = [
        {character: "‰Ω†Â•Ω", pinyin: "n«ê h«éo", translation: "hello", hsk_level: 1},
        {character: "Ë∞¢Ë∞¢", pinyin: "xi√® xie", translation: "thank you", hsk_level: 1},
        {character: "ÂÜçËßÅ", pinyin: "z√†i ji√†n", translation: "goodbye", hsk_level: 1},
        {character: "ÊòØ", pinyin: "sh√¨", translation: "to be", hsk_level: 1},
        {character: "‰∏ç", pinyin: "b√π", translation: "not", hsk_level: 1},
        {character: "Êàë", pinyin: "w«í", translation: "I", hsk_level: 1},
        {character: "‰Ω†", pinyin: "n«ê", translation: "you", hsk_level: 1},
        {character: "Â•Ω", pinyin: "h«éo", translation: "good", hsk_level: 1},
        {character: "ËØ∑", pinyin: "q«êng", translation: "please", hsk_level: 1},
        {character: "‰ªÄ‰πà", pinyin: "sh√©n me", translation: "what", hsk_level: 1}
    ];
    
    // HSK 2 words
    const hsk2Words = [
        {character: "Â≠¶Ê†°", pinyin: "xu√© xi√†o", translation: "school", hsk_level: 2},
        {character: "Â≠¶Áîü", pinyin: "xu√© shƒìng", translation: "student", hsk_level: 2},
        {character: "ËÄÅÂ∏à", pinyin: "l«éo shƒ´", translation: "teacher", hsk_level: 2},
        {character: "Â≠¶‰π†", pinyin: "xu√© x√≠", translation: "to study", hsk_level: 2},
        {character: "Â∑•‰Ωú", pinyin: "g≈çng zu√≤", translation: "work", hsk_level: 2}
    ];
    
    // HSK 3 words
    const hsk3Words = [
        {character: "ÊñáÂåñ", pinyin: "w√©n hu√†", translation: "culture", hsk_level: 3},
        {character: "ÂéÜÂè≤", pinyin: "l√¨ sh«ê", translation: "history", hsk_level: 3},
        {character: "ÂõΩÂÆ∂", pinyin: "gu√≥ jiƒÅ", translation: "country", hsk_level: 3},
        {character: "Á§æ‰ºö", pinyin: "sh√® hu√¨", translation: "society", hsk_level: 3},
        {character: "ÁªèÊµé", pinyin: "jƒ´ng j√¨", translation: "economy", hsk_level: 3}
    ];
    
    // HSK 4 words
    const hsk4Words = [
        {character: "ÂèëÂ±ï", pinyin: "fƒÅ zh«én", translation: "development", hsk_level: 4},
        {character: "ÈáçË¶Å", pinyin: "zh√≤ng y√†o", translation: "important", hsk_level: 4},
        {character: "ÈóÆÈ¢ò", pinyin: "w√®n t√≠", translation: "problem", hsk_level: 4},
        {character: "Ëß£ÂÜ≥", pinyin: "jiƒõ ju√©", translation: "to solve", hsk_level: 4},
        {character: "ÂΩ±Âìç", pinyin: "y«êng xi«éng", translation: "to influence", hsk_level: 4}
    ];
    
    // Combine all words
    return [...hsk1Words, ...hsk2Words, ...hsk3Words, ...hsk4Words];
}

// Display words
function displayWords() {
    const wordsList = document.getElementById('wordsList');
    if (!wordsList) return;
    
    // Calculate which words to show
    const startIndex = (currentWordsPage - 1) * wordsPerPage;
    const endIndex = startIndex + wordsPerPage;
    const pageWords = filteredWords.slice(startIndex, endIndex);
    
    if (pageWords.length === 0) {
        wordsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--gray);">
                <div style="font-size: 3em;">üì≠</div>
                <h3>No words found</h3>
                <p>Try changing filters or resetting search</p>
            </div>
        `;
        return;
    }
    
    // Create word cards
    wordsList.innerHTML = pageWords.map(word => {
        const wordId = `${word.character}_${word.hsk_level}`;
        const wordStatus = userWordsStatus[wordId]?.status || 'new';
        
        // Define colors and icons for statuses
        const statusConfig = {
            'new': {icon: 'far fa-star', color: '#6c757d', text: 'Add'},
            'saved': {icon: 'fas fa-bookmark', color: '#ffc107', text: 'Problematic'},
            'learned': {icon: 'fas fa-check-circle', color: '#28a745', text: 'Learned'}
        };
        
        const config = statusConfig[wordStatus] || statusConfig.new;
        
        return `
            <div class="word-card" data-word-id="${wordId}">
                <div class="word-character">${word.character}</div>
                <div class="word-pinyin">${word.pinyin}</div>
                <div class="word-translation">${word.translation}</div>
                <div class="word-level">HSK ${word.hsk_level}</div>
                
                <div class="word-actions">
                    <button class="word-action-btn" onclick="toggleWordStatus('${wordId}', 'saved')" 
                            style="color: ${wordStatus === 'saved' ? '#ffc107' : '#6c757d'};">
                        <i class="fas fa-bookmark"></i>
                        ${wordStatus === 'saved' ? 'Remove' : 'Problematic'}
                    </button>
                    
                    <button class="word-action-btn" onclick="toggleWordStatus('${wordId}', 'learned')"
                            style="color: ${wordStatus === 'learned' ? '#28a745' : '#6c757d'};">
                        <i class="fas ${wordStatus === 'learned' ? 'fa-check-circle' : 'fa-circle'}"></i>
                        ${wordStatus === 'learned' ? 'Not learned' : 'Learned'}
                    </button>
                    
                    <button class="word-action-btn" onclick="speakWord('${word.character}')">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // Update pagination
    updatePagination();
    console.log('displayWords called. userWordsStatus contains:', Object.keys(userWordsStatus).length, 'words');
    updateWordsStats();  // This will update statistics after rendering cards
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredWords.length / wordsPerPage);
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (pageInfo) {
        pageInfo.textContent = `Page ${currentWordsPage} of ${totalPages}`;
    }
    
    if (prevBtn) {
        prevBtn.disabled = currentWordsPage === 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentWordsPage === totalPages || totalPages === 0;
    }
}

// Change page
function changeWordsPage(direction) {
    const totalPages = Math.ceil(filteredWords.length / wordsPerPage);
    const newPage = currentWordsPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentWordsPage = newPage;
        displayWords();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
}

// Search words
function searchWords() {
    const searchInput = document.getElementById('wordsSearch');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (searchTerm === '') {
        filteredWords = [...allWords];
    } else {
        filteredWords = allWords.filter(word => {
    // Normalize search query and word data
    const searchLower = searchTerm.toLowerCase();
    
    // Check characters
    if (word.character.toLowerCase().includes(searchLower)) return true;
    
    // Check pinyin (ignore spaces and tones)
    const pinyinClean = word.pinyin.toLowerCase().replace(/\s+/g, '').replace(/[ƒÅ√°«é√†]/g, 'a').replace(/[ƒì√©ƒõ√®]/g, 'e').replace(/[ƒ´√≠«ê√¨]/g, 'i').replace(/[≈ç√≥«í√≤]/g, 'o').replace(/[≈´√∫«î√π«ñ«ò«ö«ú]/g, 'u');
    const searchClean = searchLower.replace(/\s+/g, '').replace(/[ƒÅ√°«é√†]/g, 'a').replace(/[ƒì√©ƒõ√®]/g, 'e').replace(/[ƒ´√≠«ê√¨]/g, 'i').replace(/[≈ç√≥«í√≤]/g, 'o').replace(/[≈´√∫«î√π«ñ«ò«ö«ú]/g, 'u');
    
    if (pinyinClean.includes(searchClean)) return true;
    
    // Check translation
    if (word.translation.toLowerCase().includes(searchLower)) return true;
    
    return false;
});
    }
    
    currentWordsPage = 1;
    displayWords();
}

// Filter words
function filterWords() {
    const levelFilter = document.getElementById('wordsLevelFilter').value;
    const statusFilter = document.getElementById('wordsStatusFilter').value;
    
    filteredWords = allWords.filter(word => {
        // Level filter
        if (levelFilter !== 'all' && word.hsk_level !== parseInt(levelFilter)) {
            return false;
        }
        
        // Status filter
        const wordId = `${word.character}_${word.hsk_level}`;
        const wordStatus = userWordsStatus[wordId]?.status || 'new';
        
        if (statusFilter === 'saved' && wordStatus !== 'saved') return false;
        if (statusFilter === 'learned' && wordStatus !== 'learned') return false;
        if (statusFilter === 'new' && wordStatus !== 'new') return false;
        
        return true;
    });
    
    currentWordsPage = 1;
    displayWords();
}

// Load random words
function loadRandomWords() {
    // Reset filters
    document.getElementById('wordsLevelFilter').value = 'all';
    document.getElementById('wordsStatusFilter').value = 'all';
    document.getElementById('wordsSearch').value = '';
    
    // Shuffle words
    filteredWords = [...allWords].sort(() => Math.random() - 0.5);
    currentWordsPage = 1;
    displayWords();
    
    showNotification('üé≤ Loaded random words');
}

// Load words by level
async function loadWordsByLevel(level) {
    try {
        document.getElementById('wordsLevelFilter').value = level;
        document.getElementById('wordsStatusFilter').value = 'all';
        document.getElementById('wordsSearch').value = '';
        
        const response = await fetch(`${API_BASE}/words/level/${level}`);
        if (response.ok) {
            const data = await response.json();
            filteredWords = data.words || [];
        } else {
            // Filter local words
            filteredWords = allWords.filter(word => word.hsk_level === level);
        }
        
        currentWordsPage = 1;
        displayWords();
        showNotification(`üìö Loaded HSK ${level} words`);
        
    } catch (error) {
        console.error('Error loading words:', error);
        showNotification('‚ùå Error loading words');
    }
}

// Toggle word status
function toggleWordStatus(wordId, targetStatus) {
    console.log(`Changing status ${wordId} to ${targetStatus}`);
    
    // Load current data
    const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
    const saved = localStorage.getItem(savedKey);
    if (saved) {
        userWordsStatus = JSON.parse(saved);
    }
    
    const currentStatus = userWordsStatus[wordId]?.status || 'new';
    
    if (currentStatus === targetStatus) {
        delete userWordsStatus[wordId];
        console.log(`üóëÔ∏è Removed status for ${wordId}`);
    } else {
        userWordsStatus[wordId] = {
            status: targetStatus,
            added_at: new Date().toISOString(),
            last_reviewed: new Date().toISOString()
        };
        console.log(`‚úÖ Set status ${targetStatus} for ${wordId}`);
    }
    
    // Save UPDATED data
    try {
        localStorage.setItem(savedKey, JSON.stringify(userWordsStatus));
        console.log(`üíæ Saved to localStorage: ${Object.keys(userWordsStatus).length} words`);
        
        // Update global variable
        window.userWordsStatus = userWordsStatus;
        
        // Update display
        updateWordDisplay(wordId);
        updateWordsStats();
        
        showNotification('‚úÖ Word status updated');
        
    } catch (e) {
        console.error('‚ùå Save error:', e);
        showNotification('‚ùå Error saving status');
    }
}

function saveAllWordsStatus() {
    try {
        const savedKey = currentUser?.user_id ? `hsk_words_${currentUser.user_id}` : 'hsk_words_guest';
        localStorage.setItem(savedKey, JSON.stringify(userWordsStatus));
        console.log(`üíæ Force saved: ${Object.keys(userWordsStatus).length} words`);
        showNotification('üíæ All statuses saved');
        return true;
    } catch (e) {
        console.error('‚ùå Force save error:', e);
        return false;
    }
}

// Update display of specific word
function updateWordDisplay(wordId) {
    const wordCard = document.querySelector(`.word-card[data-word-id="${wordId}"]`);
    if (!wordCard) return;
    
    // Find word in array
    const word = allWords.find(w => `${w.character}_${w.hsk_level}` === wordId);
    if (!word) return;
    
    const wordStatus = userWordsStatus[wordId]?.status || 'new';
    const statusConfig = {
        'new': {icon: 'far fa-star', color: '#6c757d', text: 'Add'},
        'saved': {icon: 'fas fa-bookmark', color: '#ffc107', text: 'Problematic'},
        'learned': {icon: 'fas fa-check-circle', color: '#28a745', text: 'Learned'}
    };
    
    const config = statusConfig[wordStatus] || statusConfig.new;
    
    // Update buttons
    const savedBtn = wordCard.querySelector('.word-actions button:nth-child(1)');
    const learnedBtn = wordCard.querySelector('.word-actions button:nth-child(2)');
    const statusDiv = wordCard.querySelector('.word-status');
    
    if (savedBtn) {
        savedBtn.innerHTML = `<i class="fas fa-bookmark"></i> ${wordStatus === 'saved' ? 'Remove' : 'Problematic'}`;
        savedBtn.style.color = wordStatus === 'saved' ? '#ffc107' : '#6c757d';
    }
    
    if (learnedBtn) {
        learnedBtn.innerHTML = `<i class="fas ${wordStatus === 'learned' ? 'fa-check-circle' : 'fa-circle'}"></i> ${wordStatus === 'learned' ? 'Not learned' : 'Learned'}`;
        learnedBtn.style.color = wordStatus === 'learned' ? '#28a745' : '#6c757d';
    }
    
    if (statusDiv) {
        statusDiv.innerHTML = `<i class="${config.icon}"></i> ${config.text}`;
        statusDiv.style.background = config.color;
    }
}

function updateWordsStats() {
    const statsDiv = document.getElementById('wordsStats');
    if (!statsDiv) return;
    
    // CHECK: are statuses loading correctly?
    console.log('updateWordsStats: statuses in memory', Object.keys(userWordsStatus).length);
    console.log('updateWordsStats: statuses', userWordsStatus);
    
    const totalWords = allWords.length;
    const learnedWords = Object.values(userWordsStatus).filter(s => {
        const hasStatus = s && s.status === 'learned';
        if (hasStatus) console.log('Found learned word:', s);
        return hasStatus;
    }).length;
    
    const savedWords = Object.values(userWordsStatus).filter(s => {
        const hasStatus = s && s.status === 'saved';
        if (hasStatus) console.log('Found saved word:', s);
        return hasStatus;
    }).length;
    
    console.log('updateWordsStats: learned', learnedWords, 'saved', savedWords);
    // FIXED: Check for currentUser and target_level presence
    // Calculate progress
// Calculate progress accurately without artificial minimum
let progressPercentage = 0;
const learnedWordsCount = learnedWords;

if (currentUser && currentUser.target_level) {
    const targetWordsMap = {
        1: 150,
        2: 300,
        3: 600,
        4: 1200,
        5: 2500,
        6: 5000
    };
    const targetWords = targetWordsMap[currentUser.target_level] || 5000;

    progressPercentage = (learnedWordsCount / targetWords) * 100;
} else {
    // For guest or no target - calculate from total words
    progressPercentage = (learnedWordsCount / totalWords) * 100;
}

// Round to one decimal place for more accuracy
progressPercentage = Math.round(progressPercentage * 10) / 10;  // e.g.: 0.2%, 1.8% etc.

// Never show less than 0 and more than 100
progressPercentage = Math.max(0, Math.min(100, progressPercentage));

// If 0 learned - explicitly 0%
if (learnedWordsCount === 0) {
    progressPercentage = 0;
}
    
    // Update statistics elements
    document.getElementById('totalWordsCount').textContent = totalWords;
    document.getElementById('learnedWordsCount').textContent = learnedWords;
    document.getElementById('savedWordsCount').textContent = savedWords;
    document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
    
    statsDiv.style.display = 'block';
}

// Start word testing
async function startWordsTest() {
    const source = document.getElementById('testSource').value;
    const testType = document.getElementById('testType').value;
    const count = parseInt(document.getElementById('testCount').value) || 10;
    
    console.log('Test:', source, testType, count);
    
    // Check if there are words
    if (allWords.length === 0) {
        alert('Load words first!');
        return;
    }
    
    try {
        const testData = generateLocalTest(source, testType, count);
        
        if (!testData || testData.questions.length === 0) {
            alert('No words for testing with selected parameters!');
            return;
        }
        
        console.log('Generated test:', testData);
        startTestSession(testData);
        
    } catch (error) {
        console.error('Error creating test:', error);
        alert('Error creating test: ' + error.message);
    }
}

// Generate local test (fallback)
function generateLocalTest(source, testType, count) {
    // SIMPLIFIED version:
    let testWords = [];
    
    if (source === 'all') {
        testWords = [...allWords];
    } else {
        testWords = allWords.filter(word => {
            const wordId = `${word.character}_${word.hsk_level}`;
            const wordStatus = userWordsStatus[wordId]?.status || 'new';
            return wordStatus === source;
        });
    }
    
    // Take random words
    testWords = [...testWords].sort(() => Math.random() - 0.5).slice(0, count);
    
    // Create questions
    const questions = testWords.map((word, index) => {
        const question = {
            id: `q${index}`,
            character: word.character,
            pinyin: word.pinyin,
            translation: typeof word.translation === 'string' ? word.translation : 
                        word.translation?.ru || word.translation?.en || '',
            correct: ''
        };
        
        // Define question type
        if (testType === 'pinyin_from_char') {
            question.prompt = `Pinyin for: ${word.character}`;
            question.correct = word.pinyin;
        } else if (testType === 'char_from_pinyin') {
            question.prompt = `Characters for: ${word.pinyin}`;
            question.correct = word.character;
        } else if (testType === 'translation_from_char') {
            question.prompt = `Translation for: ${word.character}`;
            question.correct = typeof word.translation === 'string' ? word.translation : 
                              word.translation?.ru || word.translation?.en || '';
        } else if (testType === 'translation_from_pinyin') {
            question.prompt = `Translation for: ${word.pinyin}`;
            question.correct = typeof word.translation === 'string' ? word.translation : 
                              word.translation?.ru || word.translation?.en || '';
        }
        
        return question;
    });
    
    return {
        test_id: `test_${Date.now()}`,
        questions: questions,
        total: questions.length,
        type: testType
    };
}

// Start test session
function startTestSession(testData) {
    // Save current test
    currentTest = testData;
    
    // Hide words tab
    document.getElementById('words-tab').style.display = 'none';
    
    // Create modal for test
    createTestModal(testData);
}

// Create modal for test
function createTestModal(testData) {
    const modal = document.createElement('div');
    modal.id = 'testModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    const questionsHTML = testData.questions.map((q, index) => `
        <div class="test-question" style="margin-bottom: 25px;">
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                ${index + 1}. ${q.prompt}
            </div>
<input type="text" id="answer_${q.id}" 
       oninput="updateTestProgress()" 
       placeholder="Enter answer..." 
       style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
            <div id="feedback_${q.id}" style="margin-top: 5px; font-size: 0.9em; display: none;"></div>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-graduation-cap"></i> Word Test
                </h2>
                <button onclick="closeTestModal()" 
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--gray);">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Progress: <span id="testProgress">0/${testData.total}</span></span>
                    <span id="testScore">0%</span>
                </div>
                <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                    <div id="testProgressBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.3s;"></div>
                </div>
            </div>
            
            <div id="testQuestions" style="margin-bottom: 30px;">
                ${questionsHTML}
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="submitWordsTest()" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Complete Test
                </button>
                <button onclick="closeTestModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Focus on first input field
    setTimeout(() => {
        const firstInput = document.getElementById(`answer_${testData.questions[0]?.id}`);
        if (firstInput) firstInput.focus();
    }, 100);
}

// Check answer in test
function checkTestAnswer(questionId, answer) {
    const question = currentTest.questions.find(q => q.id === questionId);
    if (!question) return;
    
    const feedbackDiv = document.getElementById(`feedback_${questionId}`);
    if (!feedbackDiv) return;
    
    // Simple match check (ignore spaces and case)
    const normalizedAnswer = answer.trim().toLowerCase();
    const normalizedCorrect = question.correct.trim().toLowerCase();
    
    if (normalizedAnswer === normalizedCorrect) {
        feedbackDiv.innerHTML = '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Correct!</span>';
        feedbackDiv.style.display = 'block';
    } else if (answer.length >= question.correct.length * 0.5) {
        feedbackDiv.innerHTML = '<span style="color: var(--warning);"><i class="fas fa-exclamation-circle"></i> Check your answer</span>';
        feedbackDiv.style.display = 'block';
    } else {
        feedbackDiv.style.display = 'none';
    }
    
    // Update progress
    updateTestProgress();
}

// Update test progress
function updateTestProgress() {
    if (!currentTest) return;
    
    let correct = 0;
    currentTest.questions.forEach(q => {
        const answerInput = document.getElementById(`answer_${q.id}`);
        if (normalizedUser === normalizedCorrect) {
    correct++;
} else if (testType === 'translation' || testType.includes('translation')) {
    // For translations allow small differences
    const userWords = normalizedUser.split(' ');
    const correctWords = normalizedCorrect.split(' ');
    const matchWords = userWords.filter(word => correctWords.includes(word));
    if (matchWords.length >= correctWords.length * 0.7) {
        correct++;
    }
}
    });
    
    const progress = document.getElementById('testProgress');
    const score = document.getElementById('testScore');
    const progressBar = document.getElementById('testProgressBar');
    
    if (progress) progress.textContent = `${correct}/${currentTest.total}`;
    if (score) score.textContent = `${Math.round((correct / currentTest.total) * 100)}%`;
    if (progressBar) progressBar.style.width = `${(correct / currentTest.total) * 100}%`;
}

async function submitWordsTest() {
    if (!currentTest || !currentTest.questions) {
        alert('Test not loaded!');
        return;
    }

    // Collect answers
    const answers = {};
    currentTest.questions.forEach(q => {
        const input = document.getElementById(`answer_${q.id}`);
        answers[q.id] = input ? input.value.trim() : '';
    });

    // Show loading
    const modalContent = document.querySelector('#testModal > div > div');
    modalContent.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
            <h3>AI is checking your answers...</h3>
            <p>This may take a few seconds</p>
        </div>
    `;

    try {
        const response = await fetch(`${API_BASE}/words/test/check-ai`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: currentUser?.user_id || "guest",
                test_id: currentTest.test_id,
                questions: currentTest.questions,
                answers: answers
            })
        });

        if (!response.ok) throw new Error(`Error: ${response.status}`);

        const result = await response.json();

        // Show AI result
        showTestResult(
            result.correct_count || 0,
            result.total || currentTest.questions.length,
            result.percentage || 0,
            result.results || [],
            result.summary || "Check completed."
        );

    } catch (error) {
        console.error('AI check error:', error);
        modalContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
                <h3>‚ùå Check Error</h3>
                <p>AI unavailable. Using fallback check.</p>
                <button class="btn btn-primary" onclick="submitWordsTest()">Retry</button>
            </div>
        `;
    }
}

function showTestResult(correct, total, percentage, detailedResults = [], summary = "") {
    const modalContent = document.querySelector('#testModal > div > div');

    let detailsHTML = "";
    if (detailedResults.length > 0) {
        detailsHTML = `<div style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
            <h4>Details:</h4>
            ${detailedResults.map(r => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; background: ${r.is_correct ? '#e3f2fd' : '#fde8e8'};">
                    <strong>${r.prompt}</strong><br>
                    Your answer: <em>${r.user_answer}</em><br>
                    Correct: ${r.is_correct ? '‚úì' : '‚úó'} ${r.feedback}
                </div>
            `).join('')}
        </div>`;
    }

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 4em; margin: 20px 0;">
                ${percentage >= 90 ? 'üéâ' : percentage >= 70 ? 'üëç' : 'üí™'}
            </div>
            <h2>${percentage >= 90 ? 'Excellent!' : percentage >= 70 ? 'Good!' : 'Practice more!'}</h2>
            <div style="font-size: 3em; font-weight: bold; color: ${percentage >= 70 ? 'var(--success)' : 'var(--danger)'};">
                ${correct}/${total} (${percentage}%)
            </div>
            <div style="margin: 20px 0; color: var(--gray);">
                ${summary}
            </div>
            ${detailsHTML}
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="closeTestModal()">
                    Close
                </button>
                <button class="btn btn-secondary" onclick="startWordsTest()" style="margin-left: 10px;">
                    New Test
                </button>
            </div>
        </div>
    `;
}

// Show test result
function showTestResult(correct, total, percentage) {
    const modal = document.getElementById('testModal');
    if (!modal) return;
    
    const resultHTML = `
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 4em; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üéâ' : percentage >= 60 ? 'üëç' : 'üí™'}
            </div>
            
            <h2 style="color: ${percentage >= 80 ? 'var(--success)' : percentage >= 60 ? 'var(--warning)' : 'var(--danger)'}">
                ${percentage}% correct answers
            </h2>
            
            <div style="font-size: 2em; margin: 20px 0;">
                ${correct} out of ${total}
            </div>
            
            <div style="margin: 20px 0;">
                ${percentage >= 80 ? 
                    'Excellent! You know these words well!' : 
                  percentage >= 60 ? 
                    'Good! Keep practicing!' : 
                    'Need more practice! Review these words.'}
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeTestModal()" class="btn btn-primary">
                    <i class="fas fa-check"></i> Finish
                </button>
                <button onclick="retryTest()" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        </div>
    `;
    
    const modalContent = modal.querySelector('div > div');
    if (modalContent) {
        modalContent.innerHTML = resultHTML;
    }
}

// Close test modal
function closeTestModal() {
    const modal = document.getElementById('testModal');
    if (modal) {
        modal.remove();
    }
    
    // Show words tab
    document.getElementById('words-tab').style.display = 'block';
}

// Retry test
function retryTest() {
    closeTestModal();
    startTestSession(currentTest);
}

// Review learned words test
function startReviewTest() {
    document.getElementById('testSource').value = 'learned';
    document.getElementById('testType').value = 'translation_from_char';
    startWordsTest();
}

// Update user progress
function updateUserProgress() {
    if (!currentUser) return;
    
    const learnedWords = Object.values(userWordsStatus).filter(s => s.status === 'learned').length;
    const targetLevel = currentUser.target_level || 4;
    
    // Calculate progress
    const targetWords = {
        1: 150, 2: 300, 3: 600, 4: 1200, 5: 2500, 6: 5000
    }[targetLevel] || 1000;
    
    const progressPercentage = Math.min(100, Math.round((learnedWords / targetWords) * 100));
    
    // Update progress display if elements exist
    updateProgressDisplay(progressPercentage, learnedWords, targetWords, targetLevel);
}

// Update progress display in "Progress" tab
function updateProgressDisplay(percentage, learned, target, level) {
    // Update elements in progress tab
    const progressElements = document.querySelectorAll('.progress-percentage');
    const learnedElements = document.querySelectorAll('.learned-words');
    const targetElements = document.querySelectorAll('.target-words');
    
    progressElements.forEach(el => {
        el.textContent = `${percentage}%`;
        // Update progress bar width if exists
        const progressBar = el.closest('.progress-container')?.querySelector('.progress-bar-fill');
        if (progressBar) {
            progressBar.style.width = `${percentage}%`;
            progressBar.style.background = percentage >= 80 ? 'var(--success)' : 
                                          percentage >= 60 ? 'var(--warning)' : 'var(--danger)';
        }
    });
    
    learnedElements.forEach(el => {
        el.textContent = learned;
    });
    
    targetElements.forEach(el => {
        el.textContent = target;
    });
    
    // Update level if element exists
    const levelElement = document.getElementById('currentTargetLevel');
    if (levelElement) {
        levelElement.textContent = level;
    }
    
    // Update progress chart if exists
    updateProgressChart(percentage);
}

// Update progress chart
function updateProgressChart(percentage) {
    const chart = document.getElementById('progressChart');
    if (!chart) return;
    
    // Simple pie chart
    chart.innerHTML = `
        <div style="position: relative; width: 200px; height: 200px; margin: 0 auto;">
            <canvas id="progressCanvas" width="200" height="200"></canvas>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: var(--primary);">${percentage}%</div>
                <div style="font-size: 0.9em; color: var(--gray);">Progress</div>
            </div>
        </div>
    `;
    
    // Draw pie chart
    const canvas = document.getElementById('progressCanvas');
    if (canvas && canvas.getContext) {
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;
        
        // Background
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fillStyle = '#e9ecef';
        ctx.fill();
        
        // Progress
        const endAngle = (percentage / 100) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, -Math.PI / 2, endAngle - Math.PI / 2);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = percentage >= 80 ? 'var(--success)' : 
                        percentage >= 60 ? 'var(--warning)' : 'var(--danger)';
        ctx.fill();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // ... rest of initialization code ...
    
    // Initialize words tab if it exists
    const wordsTab = document.getElementById('words-tab');
    if (wordsTab) {
        initWordsTab();
    }
});

// Analyze pronunciation
async function analyzePronunciation(text) {
    try {
        const response = await fetch(`${API_BASE}/ai/pronunciation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                user_id: currentUser?.user_id || null
            })
        });
        
        const data = await response.json();
        
        // Add pronunciation analysis to details
        const detailsDiv = document.getElementById('translationDetails');
        const pronunciationHTML = `
            <div class="word-card" style="margin-top: 15px;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--accent);">
                    <i class="fas fa-volume-up"></i> Pronunciation Analysis:
                </div>
                ${data.tones ? `<div><strong>Tones:</strong> ${data.tones}</div>` : ''}
                ${data.difficult_sounds ? `<div><strong>Difficult sounds:</strong> ${data.difficult_sounds}</div>` : ''}
                ${data.pronunciation_tips ? `<div><strong>Tips:</strong> ${data.pronunciation_tips}</div>` : ''}
                ${data.common_errors ? `<div><strong>Common errors:</strong> ${data.common_errors}</div>` : ''}
            </div>
        `;
        
        detailsDiv.innerHTML = pronunciationHTML + detailsDiv.innerHTML;
        
    } catch (error) {
        console.error('Pronunciation analysis error:', error);
    }
}

// Exercise type names
function getExerciseTypeName(type) {
    const names = {
        'fill_in_blanks': 'Fill in the blanks',
        'matching': 'Matching',
        'word_order': 'Word order',
        'translation_exercise': 'Translation',
        'writing_practice': 'Writing practice',
        'conversation_topics': 'Conversation topics'
    };
    return names[type] || type;
}

// Load translation history
async function loadTranslationHistory() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`${API_BASE}/ai/translation-history/${currentUser.user_id}`);
        const data = await response.json();
        
        // Show history in progress tab or separate
        if (data.history && data.history.length > 0) {
            const historyHTML = `
                <div class="word-card" style="margin-top: 20px;">
                    <h4><i class="fas fa-history"></i> Translation History</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${data.history.map(item => `
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6;">
                                <div style="font-weight: bold;">${item.original}</div>
                                <div style="font-size: 0.9em; color: var(--gray);">${item.translation}</div>
                                <div style="font-size: 0.8em; color: var(--gray);">${formatDate(item.timestamp)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add to progress tab
            const progressContent = document.getElementById('progressContent');
            if (progressContent) {
                progressContent.innerHTML += historyHTML;
            }
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

// Update current chat
function updateCurrentChat() {
    const chat = userChats.find(c => c.thread_id === currentChatId);
    if (!chat) return;
    
    const newTitle = document.getElementById('chatTitleInput').value.trim();
    const newCategory = document.getElementById('chatCategory').value;
    
    if (newTitle) {
        chat.title = newTitle;
        chat.category = newCategory;
        chat.updated_at = new Date().toISOString();
        
        renderChatList();
        saveChatsLocally();
        
        // Update on server if available
        updateChatOnServer(chat);
    }
}

// Update chat on server
async function updateChatOnServer(chat) {
    try {
        await fetch(`${API_BASE}/chat/threads/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                thread_id: chat.thread_id,
                title: chat.title,
                category: chat.category
            })
        });
    } catch (error) {
        console.log('Failed to update chat on server');
    }
}

// Delete current chat
function deleteCurrentChat() {
    if (!confirm('Delete this chat? Message history will be lost.')) return;
    
    const chatIndex = userChats.findIndex(c => c.thread_id === currentChatId);
    if (chatIndex > -1) {
        userChats.splice(chatIndex, 1);
        
        // Switch to another chat or create new
        if (userChats.length > 0) {
            currentChatId = userChats[0].thread_id;
            loadChatMessages(currentChatId);
        } else {
            createNewChat();
        }
        
        renderChatList();
        saveChatsLocally();
        
        // Delete from server if available
        deleteChatOnServer(currentChatId);
    }
}

// Delete chat on server
async function deleteChatOnServer(chatId) {
    try {
        await fetch(`${API_BASE}/chat/threads/delete/${chatId}`, {
            method: 'DELETE'
        });
    } catch (error) {
        console.log('Failed to delete chat on server');
    }
}
        
        // Switch tabs
        function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show target tab
    const targetTab = document.getElementById(`${tabName}-tab`);
    targetTab.classList.add('active');
    
    // Add active class to selected tab
    document.querySelectorAll('.tab').forEach(tab => {
        if (tab.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1))) {
            tab.classList.add('active');
        }
    });

    
    
    // Load data for tab
    if (tabName === 'words') {
        loadRandomWords();
    } else if (tabName === 'progress') {
        loadProgress();
    } else if (tabName === 'grammar') {
        loadGrammarTopics();
    } else if (tabName === 'voice-chat') {
        // Initialize voice chat on first open
        if (!voiceRecognition) {
            setTimeout(initVoiceChat, 100);
        }
    } else if (tabName === 'text-generator') {
        loadTextHistory(); // Load history
        document.getElementById('textResultSection').style.display = 'none'; // Hide result
    } else if (tabName === 'essay-checker') {
        initEssayChecker();
    } else if (tabName === 'essay-analysis') {
        initEssayAnalysis();
    }
}
        
        // Quick question
        function quickQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage();
}
        
        // Send message
        // Send message
        async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Create chat if doesn't exist
    if (!currentChatId || userChats.length === 0) {
        await createNewChat();
    }
    
    // Find current chat
    let chat = userChats.find(c => c.thread_id === currentChatId);
    if (!chat) {
        // If chat not found, create new
        chat = createLocalChat();
    }
    
    // Ensure messages exist
    if (!chat.messages) {
        chat.messages = [];
    }
    
    console.log('Adding message to chat:', chat.thread_id);
    console.log('Current message count:', chat.messages.length);
    
    // Save user message
    chat.messages.push({
        role: "user",
        content: message,
        timestamp: new Date().toISOString()
    });
    
    // Show user message
    addMessage(message, 'user');
    input.value = '';
    
    // Save immediately
    saveChatsLocally();
    
    // Show loading indicator
    const loadingMsg = addMessage('ü§ñ AI is thinking...', 'ai');
    
    try {
        let aiResponse = "I received your message. Keep asking questions!";
        
        if (currentUser) {
            try {
                const response = await fetch(`${API_BASE}/chat/${currentChatId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: currentUser.user_id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    aiResponse = data.response;
                }
            } catch (error) {
                console.log('Server unavailable, using local response');
            }
        }
        
        // Save AI response
        chat.messages.push({
            role: "assistant",
            content: aiResponse,
            timestamp: new Date().toISOString()
        });
        
        chat.updated_at = new Date().toISOString();
        
        // Save chat with response
        saveChatsLocally();
        
        // Remove loading indicator and show response
        loadingMsg.remove();
        addMessage(aiResponse, 'ai');
        
    } catch (error) {
        console.error('Error:', error);
        loadingMsg.remove();
        addMessage('‚ùå Server connection error.', 'ai');
    }
}
        
        // Add message to chat
        function addMessage(text, sender) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = `<div class="ai-label">ü§ñ AI Tutor:</div>${text}`;
            } else {
                messageDiv.textContent = text;
            }
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            return messageDiv;
        }
        
        // Load random words
        async function loadRandomWords() {
            showLoading('wordsList', 'Loading words...');
            
            try {
                const response = await fetch(`${API_BASE}/word/random`);
                const data = await response.json();
                
                const wordsList = document.getElementById('wordsList');
                wordsList.innerHTML = '';
                
                // Main word
                const word = data.word;
                const wordCard = createWordCard(word, data.memory_tip);
                wordsList.appendChild(wordCard);
                
                // Similar words
                if (data.similar_words && data.similar_words.length > 0) {
                    const similarHeader = document.createElement('div');
                    similarHeader.innerHTML = '<h3 style="margin: 20px 0 10px 0; color: var(--primary);"><i class="fas fa-link"></i> Similar words:</h3>';
                    wordsList.appendChild(similarHeader);
                    
                    data.similar_words.forEach(similar => {
                        const similarCard = document.createElement('div');
                        similarCard.className = 'word-card';
                        similarCard.style.borderLeftColor = 'var(--warning)';
                        similarCard.innerHTML = `
                            <div class="word-header">
                                <div class="word-character">${similar.character}</div>
                            </div>
                            <div class="word-pinyin">${similar.pinyin}</div>
                            <div class="word-translation">${similar.translation}</div>
                        `;
                        wordsList.appendChild(similarCard);
                    });
                }
                
                // Study tips
                if (data.study_suggestions) {
                    const tipsDiv = document.createElement('div');
                    tipsDiv.className = 'word-tip';
                    tipsDiv.style.marginTop = '20px';
                    tipsDiv.innerHTML = `
                        <strong><i class="fas fa-lightbulb"></i> Study tips:</strong><br>
                        ${data.study_suggestions.map(tip => `‚Ä¢ ${tip}`).join('<br>')}
                    `;
                    wordsList.appendChild(tipsDiv);
                }
            } catch (error) {
                document.getElementById('wordsList').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>‚ùå Error loading words</p>
                    </div>
                `;
            }
        }
        
        // Load words by level
        // Load words by level - ALL words
// Load words by level - ALL words (TABLE)
async function loadWordsByLevel(level) {
    showLoading('wordsList', `Loading all HSK ${level} words...`);
    
    try {
        const response = await fetch(`${API_BASE}/words/level/${level}?limit=10000`);
        const data = await response.json();
        
        const wordsList = document.getElementById('wordsList');
        wordsList.innerHTML = '';
        
        if (data.words && data.words.length > 0) {
            // Header
            const header = document.createElement('div');
            header.innerHTML = `
                <div class="section-header" style="margin-bottom: 20px;">
                    <h2><i class="fas fa-list"></i> All HSK ${level} Words</h2>
                    <span class="word-level">${data.total} words</span>
                </div>
            `;
            wordsList.appendChild(header);
            
            // Table
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: var(--primary); color: white;">
                        <th style="padding: 12px; text-align: left; width: 15%;">Character</th>
                        <th style="padding: 12px; text-align: left; width: 25%;">Pinyin</th>
                        <th style="padding: 12px; text-align: left; width: 50%;">Translation</th>
                        <th style="padding: 12px; text-align: center; width: 10%;">Level</th>
                    </tr>
                </thead>
                <tbody id="wordsTableBody">
                </tbody>
            `;
            
            wordsList.appendChild(table);
            
            // Fill table
            const tbody = document.getElementById('wordsTableBody');
            data.words.forEach((word, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                row.style.backgroundColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                row.innerHTML = `
                    <td style="padding: 10px; font-size: 1.4em; font-weight: bold;">${word.character}</td>
                    <td style="padding: 10px; color: var(--danger);">${word.pinyin || ''}</td>
                    <td style="padding: 10px;">${word.translation || ''}</td>
                    <td style="padding: 10px; text-align: center;">
                        <span class="word-level" style="display: inline-block;">HSK ${word.hsk_level || 1}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Pagination
            const pagination = document.createElement('div');
            pagination.style.marginTop = '20px';
            pagination.style.textAlign = 'center';
            pagination.innerHTML = `
                <p>Showing ${data.count} of ${data.total} words</p>
            `;
            wordsList.appendChild(pagination);
            
        } else {
            wordsList.innerHTML = '<p>üì≠ No words found</p>';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('wordsList').innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>‚ùå Error loading words</p>
                <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 10px;">
                    <i class="fas fa-redo"></i> Reload Page
                </button>
            </div>
        `;
    }
}
        
        // Create word card
        function createWordCard(word, tip = null) {
            const card = document.createElement('div');
            card.className = 'word-card';
            
            card.innerHTML = `
                <div class="word-header">
                    <div class="word-character">${word.character}</div>
                    <div class="word-level">HSK ${word.hsk_level || 1}</div>
                </div>
                <div class="word-pinyin">${word.pinyin || ''}</div>
                <div class="word-translation">${word.translation || ''}</div>
                ${tip ? `<div class="word-tip"><i class="fas fa-lightbulb"></i> ${tip}</div>` : ''}
            `;
            
            return card;
        }
        
        // Start test
        async function startTest(level) {
            showLoading('testContainer', `Creating HSK ${level} test...`);
            
            try {
                const response = await fetch(`${API_BASE}/test/${level}?questions=5`);
                currentTest = await response.json();
                testAnswers = {};
                
                displayTest(currentTest);
            } catch (error) {
                document.getElementById('testContainer').innerHTML = `
                    <div class="loading">
                        <p>‚ùå Error creating test</p>
                        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
                    </div>
                `;
            }
        }
        
        // Display test
        function displayTest(test) {
            const container = document.getElementById('testContainer');
            let html = `
                <div class="test-intro">
                    <h3><i class="fas fa-graduation-cap"></i> HSK ${test.level} Test</h3>
                    <p>Questions: ${test.total_questions} | Time: ${test.time_limit}</p>
                    
                    <div class="word-tip" style="margin: 15px 0;">
                        <strong><i class="fas fa-tips"></i> Test hacks:</strong><br>
                        ${test.test_hacks.map(hack => `‚Ä¢ ${hack}`).join('<br>')}
                    </div>
                    
                    <div id="testQuestions">
            `;
            
            test.questions.forEach((question, index) => {
                html += `
                    <div class="test-question" id="question-${question.id}">
                        <h4>Question ${index + 1}: ${question.question}</h4>
                        <div class="test-options">
                `;
                
                question.options.forEach((option, optIndex) => {
                    html += `
                        <div class="test-option" 
                             onclick="selectAnswer('${question.id}', ${optIndex})"
                             id="option-${question.id}-${optIndex}">
                            ${String.fromCharCode(65 + optIndex)}) ${option}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="submitTest()" style="width: 100%;">
                            <i class="fas fa-paper-plane"></i> Submit Answers
                        </button>
                        <button class="btn btn-secondary" onclick="resetTest()" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-redo"></i> Start Over
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Select answer
        function selectAnswer(questionId, optionIndex) {
            // Reset highlighting for this question
            const questionDiv = document.getElementById(`question-${questionId}`);
            questionDiv.querySelectorAll('.test-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Highlight selected option
            const selectedOption = document.getElementById(`option-${questionId}-${optionIndex}`);
            selectedOption.classList.add('selected');
            
            // Save answer
            testAnswers[questionId] = optionIndex;
        }
        async function saveWordProgress(wordId, remembered = true, difficulty = 3) {
    if (!currentUser) {
        alert('Log in to save progress!');
        showLoginForm();
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/review`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: currentUser.user_id,
                word_id: wordId,
                difficulty: difficulty,
                remembered: remembered
            })
        });
        
        if (response.ok) {
            console.log('Progress saved on server');
            
            // Update progress in Progress tab if active
            if (document.getElementById('progress-tab').classList.contains('active')) {
                setTimeout(() => loadProgress(), 500); // Update after 0.5 sec
            }
        }
    } catch (error) {
        console.log('Failed to save progress on server');
        // Save locally
        const localProgress = JSON.parse(localStorage.getItem('hsk_word_progress') || '{}');
        localProgress[wordId] = {
            remembered: remembered,
            difficulty: difficulty,
            last_reviewed: new Date().toISOString()
        };
        localStorage.setItem('hsk_word_progress', JSON.stringify(localProgress));
        
        // Update progress in Progress tab if active
        if (document.getElementById('progress-tab').classList.contains('active')) {
            showLocalProgress();
        }
    }
}
// Submit test
async function submitTest() {
    if (!currentTest || Object.keys(testAnswers).length === 0) {
        alert('Answer questions first!');
        return;
    }
    
    showLoading('testContainer', 'Checking answers...');
    
    try {
        // Get or create user
const userId = currentUser ? currentUser.user_id : await getOrCreateUser();
        
        const response = await fetch(`${API_BASE}/submit_test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                test_id: currentTest.test_id,
                answers: testAnswers
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        displayTestResults(result);
        
    } catch (error) {
        console.error('Test submission error:', error);
        
        // If user not found, create one
        if (error.message.includes('User not found')) {
            alert('Creating new user...');
            localStorage.removeItem('hsk_user_id'); // Reset ID
            submitTest(); // Try again
            return;
        }
        
        document.getElementById('testContainer').innerHTML = `
            <div class="loading">
                <p>‚ùå Test submission error</p>
                <p style="font-size: 0.9em; margin-top: 10px;">${error.message}</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="resetTest()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="btn btn-secondary" onclick="switchTab('test')" style="margin-left: 10px;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;
    }
}

async function startTest(level) {
    showLoading('testContainer', `Generating full HSK ${level} test...`);
    
    try {
        // Request reduced test for faster loading
        const response = await fetch(`${API_BASE}/hsk/generate-test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                level: level,
                test_type: "reduced",
                user_id: currentUser?.user_id || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        currentHskTest = await response.json();
        console.log("Received test:", currentHskTest); // FOR DEBUG
        console.log("Sections:", currentHskTest.sections); // FOR DEBUG
        testTimeLeft = currentHskTest.time_limits?.total_minutes * 60 || 1800;
        
        displayFullTest(currentHskTest);
        startTestTimer();
        
    } catch (error) {
        console.error('Test generation error:', error);
        document.getElementById('testContainer').innerHTML = `
            <div class="loading">
                <p>‚ùå Test generation error</p>
                <button class="btn btn-primary" onclick="startTest(${level})">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

function displayFullTest(test) {
    const container = document.getElementById('testContainer');
    
    let html = `
        <div class="test-header" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border-radius: 15px;">
            <h2 style="margin-bottom: 10px;">
                <i class="fas fa-graduation-cap"></i> HSK ${test.level} Test
                <span class="word-level" style="background: white; color: var(--primary); margin-left: 10px;">
                    ${test.type === 'reduced' ? 'Reduced' : 'Full'}
                </span>
            </h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold;" id="testTimer">${formatTime(testTimeLeft)}</div>
                    <div style="font-size: 0.9em;">Time remaining</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.2em;">ID: ${test.test_id}</div>
                    <div style="font-size: 0.9em;">Maximum: 300 points</div>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="switchTestSection('listening')" style="margin-right: 10px;">
                <i class="fas fa-headphones"></i> Listening
            </button>
            <button class="btn btn-success" onclick="switchTestSection('reading')" style="margin-right: 10px;">
                <i class="fas fa-book"></i> Reading
            </button>
            <button class="btn btn-warning" onclick="switchTestSection('writing')" ${test.level <= 2 ? 'disabled' : ''}>
                <i class="fas fa-pen"></i> Writing
            </button>
            <button class="btn btn-danger" onclick="switchTestSection('speaking')">
                <i class="fas fa-microphone"></i> Speaking
            </button>
        </div>
        
        <div id="testContent">
            <!-- Test content will be loaded here -->
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn btn-success" onclick="submitFullTest()" style="padding: 15px 30px; font-size: 1.1em;">
                <i class="fas fa-paper-plane"></i> Complete Test
            </button>
            <button class="btn btn-secondary" onclick="resetTestTimer()" style="margin-left: 10px;">
                <i class="fas fa-redo"></i> Reset Timer
            </button>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Show first section
    switchTestSection('listening');
}

function switchTestSection(section) {
    const testContent = document.getElementById('testContent');
    
    if (!currentHskTest || !currentHskTest.sections || !currentHskTest.sections[section]) {
        testContent.innerHTML = `<p>Section ${section} not available</p>`;
        return;
    }
    
    const sectionData = currentHskTest.sections[section];
    
    let sectionHtml = `
        <div class="section-header" style="margin-bottom: 20px;">
            <h3 style="color: var(--primary);">
                ${section === 'listening' ? 'üéß' : 
                  section === 'reading' ? 'üìñ' : 
                  section === 'writing' ? '‚úçÔ∏è' : 'üé§'} 
                ${sectionData.section_name || section}
                <span class="word-level" style="font-size: 0.8em;">${sectionData.total_score || 0} points</span>
            </h3>
            <p>${sectionData.instructions || 'Complete tasks:'}</p>
            <p style="font-size: 0.9em; color: var(--gray);">
                Questions: ${sectionData.count || (sectionData.questions?.length || sectionData.tasks?.length || 0)}
            </p>
        </div>
    `;
    
    if (section === 'speaking') {
        // Speaking section
        sectionHtml += displaySpeakingSection(sectionData);
    } else if (section === 'writing') {
        // Special handling for writing
        const hasWritingContent = sectionData.questions || sectionData.tasks;
        const writingCount = sectionData.questions?.length || sectionData.tasks?.length || 0;
        
        if (hasWritingContent && writingCount > 0) {
            sectionHtml += displayWritingSection(sectionData);
        } else {
            sectionHtml += `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4em; color: var(--warning);">‚úçÔ∏è</div>
                    <h3>Writing Section</h3>
                    <p>${sectionData.instructions || 'Tasks temporarily unavailable'}</p>
                    <p>Try generating test again</p>
                </div>
            `;
        }
    } else {
        // Listening and reading sections
        sectionHtml += displayListeningReadingSection(sectionData, section);
    }
    
    testContent.innerHTML = sectionHtml;
}

// Fixed displayListeningReadingSection function
function displayListeningReadingSection(sectionData, sectionType) {
    console.log("Section data:", sectionData); // For debugging
    
    let html = '';
    
    // NEW FORMAT: questions instead of parts
    if (sectionData.questions && Array.isArray(sectionData.questions)) {
        sectionData.questions.forEach((question, qIndex) => {
            const questionId = question.id || `${sectionType[0]}${qIndex+1}`;
            
            html += `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: ${qIndex < sectionData.questions.length - 1 ? '1px solid #dee2e6' : 'none'}">
                    <div style="font-weight: bold; margin-bottom: 10px;">
                        ${qIndex + 1}. ${question.question || 'Question'}
                    </div>
                    
                    ${question.text ? `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 1.1em;">
                            ${question.text}
                        </div>
                    ` : ''}
                    
                    ${question.options && question.options.length > 0 ? `
                        <div class="test-options">
                            ${question.options.map((option, optIndex) => `
                                <div class="test-option" 
                                     onclick="selectTestAnswer('${questionId}', ${optIndex})" 
                                     id="${questionId}_option_${optIndex}">
                                    ${String.fromCharCode(65 + optIndex)}) ${option}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>No answer options</p>'}
                    
                    ${question.audio_text && sectionType === 'listening' ? `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="playAudio('${question.audio_text}')" style="font-size: 0.9em;">
                                <i class="fas fa-play"></i> Play Audio
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    } else {
        // Old format (just in case)
        html += '<p>Data format not supported</p>';
    }
    
    return html;
}

function displayWritingSection(sectionData) {
    let html = '';
    
    // Check different data formats
    const questions = sectionData.questions || sectionData.tasks || [];
    
    if (!questions || questions.length === 0) {
        return `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 4em; color: var(--gray);">‚úçÔ∏è</div>
                <h3>Writing section unavailable</h3>
                <p>Writing section not provided for this HSK level</p>
                <p>Try HSK level 3 or higher</p>
            </div>
        `;
    }
    
    // Process each question/task
    questions.forEach((question, qIndex) => {
        const questionId = question.id || `W${qIndex+1}`;
        
        html += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: ${qIndex < questions.length - 1 ? '1px solid #dee2e6' : 'none'}">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">
                        <i class="fas fa-pen"></i> Task ${qIndex + 1}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Task:</strong> ${question.task || question.text || 'Write answer:'}
                    </div>
                    
                    ${question.requirements ? `
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <strong>Requirements:</strong> ${question.requirements}
                        </div>
                    ` : ''}
                    
                    ${question.word_limit ? `
                        <div style="color: var(--gray); margin-bottom: 15px;">
                            <i class="fas fa-ruler"></i> Length: ${question.word_limit} characters
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Your answer:
                        </label>
                        <textarea id="${questionId}_answer" 
                                  style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; font-family: 'SimSun', 'ÂÆã‰Ωì', serif;"
                                  placeholder="Write your answer here..."></textarea>
                    </div>
                    
                    ${question.example_response || question.example ? `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary);">
                                <i class="fas fa-eye"></i> Show example answer
                            </summary>
                            <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                                ${question.example_response || question.example}
                            </div>
                        </details>
                    ` : ''}
                    
                    ${question.evaluation_criteria ? `
                        <div style="margin-top: 15px;">
                            <strong>Evaluation criteria:</strong>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                ${question.evaluation_criteria.map(criteria => `
                                    <li>${criteria}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    return html;
}

function displaySpeakingSection(sectionData) {
    let html = '';
    
    sectionData.tasks.forEach((task, taskIndex) => {
        html += `
            <div class="word-card" style="margin-bottom: 20px;">
                <div style="font-weight: bold; margin-bottom: 15px; color: var(--danger);">
                    Task ${taskIndex + 1}
                    <span style="float: right; font-size: 0.9em;">
                        Preparation: ${task.preparation_time} | Answer: ${task.speaking_time}
                    </span>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Task:</strong> ${task.task}
                </div>
                
                ${task.keywords ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Keywords:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            ${task.keywords.split(',').map(kw => `
                                <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 15px; font-size: 0.9em;">
                                    ${kw.trim()}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-bottom: 15px;">
                    <strong>Evaluation criteria:</strong>
                    <ul style="margin-top: 5px; padding-left: 20px;">
                        ${task.evaluation_criteria?.map(criteria => `
                            <li>${criteria}</li>
                        `).join('') || '<li>Pronunciation</li><li>Grammar</li><li>Vocabulary</li>'}
                    </ul>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="startRecording(${taskIndex})" id="recordBtn${taskIndex}">
                        <i class="fas fa-microphone"></i> Start Recording
                    </button>
                    <button class="btn btn-secondary" onclick="stopRecording(${taskIndex})" id="stopBtn${taskIndex}" style="display: none; margin-left: 10px;">
                        <i class="fas fa-stop"></i> Stop Recording
                    </button>
                    <button class="btn btn-primary" onclick="playRecording(${taskIndex})" id="playBtn${taskIndex}" style="display: none; margin-left: 10px;">
                        <i class="fas fa-play"></i> Playback
                    </button>
                </div>
                
                <div id="recordingStatus${taskIndex}" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="recordingProgress${taskIndex}" style="width: 0%"></div>
                    </div>
                    <div id="recordingTime${taskIndex}" style="text-align: center; margin-top: 5px; font-size: 0.9em;">
                        0:00 / ${task.speaking_time}
                    </div>
                </div>
                
                ${task.example ? `
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: var(--primary);">
                            <i class="fas fa-volume-up"></i> Show example answer
                        </summary>
                        <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                            <strong>Example:</strong><br>
                            ${task.example}
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
    });
    
    return html;
}

// Timer functions
function startTestTimer() {
    clearInterval(testTimer);
    testTimer = setInterval(() => {
        testTimeLeft--;
        updateTimerDisplay();
        
        if (testTimeLeft <= 0) {
            clearInterval(testTimer);
            alert('Time is up! Test will be submitted automatically.');
            submitFullTest();
        }
    }, 1000);
}

function resetTestTimer() {
    if (currentHskTest) {
        testTimeLeft = currentHskTest.time_limits?.total_minutes * 60 || 1800;
        startTestTimer();
    }
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('testTimer');
    if (timerElement) {
        timerElement.textContent = formatTime(testTimeLeft);
        
        // Change color when time is low
        if (testTimeLeft < 300) { // 5 minutes
            timerElement.style.color = 'var(--danger)';
        } else if (testTimeLeft < 600) { // 10 minutes
            timerElement.style.color = 'var(--warning)';
        }
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Audio recording functions
let mediaRecorder = null;
let audioChunks = [];
let recordingTaskIndex = null;
let recordingStartTime = null;
let recordingTimer = null;

async function startRecording(taskIndex) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            // Save audio for submission
            currentHskTest.sections.speaking.tasks[taskIndex].audioBlob = audioBlob;
            
            // Show playback button
            document.getElementById(`playBtn${taskIndex}`).style.display = 'inline-block';
        };
        
        mediaRecorder.start();
        recordingTaskIndex = taskIndex;
        recordingStartTime = Date.now();
        
        // Update UI
        document.getElementById(`recordBtn${taskIndex}`).style.display = 'none';
        document.getElementById(`stopBtn${taskIndex}`).style.display = 'inline-block';
        document.getElementById(`recordingStatus${taskIndex}`).style.display = 'block';
        
        // Start recording timer
        startRecordingTimer(taskIndex);
        
    } catch (error) {
        console.error('Recording error:', error);
        alert('Failed to access microphone');
    }
}

function stopRecording(taskIndex) {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimer);
        
        // Stop all tracks
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Update UI
        document.getElementById(`recordBtn${taskIndex}`).style.display = 'inline-block';
        document.getElementById(`stopBtn${taskIndex}`).style.display = 'none';
        document.getElementById(`recordingStatus${taskIndex}`).style.display = 'none';
    }
}

function startRecordingTimer(taskIndex) {
    const maxTime = parseTimeToSeconds(currentHskTest.sections.speaking.tasks[taskIndex].speaking_time);
    let elapsed = 0;
    
    recordingTimer = setInterval(() => {
        elapsed++;
        const progress = (elapsed / maxTime) * 100;
        
        document.getElementById(`recordingProgress${taskIndex}`).style.width = `${Math.min(progress, 100)}%`;
        document.getElementById(`recordingTime${taskIndex}`).textContent = 
            `${formatTime(elapsed)} / ${currentHskTest.sections.speaking.tasks[taskIndex].speaking_time}`;
        
        // Automatically stop recording when time expires
        if (elapsed >= maxTime) {
            stopRecording(taskIndex);
        }
    }, 1000);
}

function parseTimeToSeconds(timeStr) {
    // Convert "1 minute" or "90 seconds" to seconds
    const match = timeStr.match(/(\d+)\s*(seconds|minutes)/);
    if (match) {
        const num = parseInt(match[1]);
        const unit = match[2];
        return unit === 'minutes' ? num * 60 : num;
    }
    return 60; // Default 60 seconds
}

function playRecording(taskIndex) {
    if (currentHskTest.sections.speaking.tasks[taskIndex].audioBlob) {
        const audioUrl = URL.createObjectURL(currentHskTest.sections.speaking.tasks[taskIndex].audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();
    }
}

// In playAudio function add browser support:
function playAudio(text) {
    // Use Web Speech API
    if ('speechSynthesis' in window) {
        // Cancel current speech
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        // Select voice
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
            voice.lang.startsWith('zh') || voice.lang.startsWith('cmn')
        );
        if (chineseVoice) {
            utterance.voice = chineseVoice;
        }
        
        utterance.onstart = () => {
            console.log('Starting audio playback');
        };
        
        utterance.onend = () => {
            console.log('Audio playback ended');
        };
        
        utterance.onerror = (event) => {
            console.error('Playback error:', event);
            // Fallback: show text
            showAudioText(text);
        };
        
        speechSynthesis.speak(utterance);
    } else {
        // Fallback for browsers without support
        showAudioText(text);
    }
}

function showAudioText(text) {
    // Show text instead of audio
    const audioDiv = document.createElement('div');
    audioDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 80%;
        text-align: center;
    `;
    
    audioDiv.innerHTML = `
        <h3>Audio text:</h3>
        <div style="font-size: 1.5em; margin: 15px 0;">${text}</div>
        <button onclick="this.parentElement.remove()" class="btn btn-primary">
            Close
        </button>
    `;
    
    document.body.appendChild(audioDiv);
}

// For images add placeholders
function showImagePlaceholder(description) {
    // Create image placeholder
    const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4cd964', '#ff9a00'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    
    return `
        <div style="text-align: center; margin: 20px 0;">
            <div style="
                width: 200px; 
                height: 150px; 
                background: ${color};
                border-radius: 10px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 2em;
                margin-bottom: 10px;
            ">
                üñºÔ∏è
            </div>
            <div style="color: var(--gray); font-size: 0.9em;">
                ${description || 'Image for task'}
            </div>
        </div>
    `;
}

// Answer selection function
function selectTestAnswer(questionId, optionIndex) {
    const questionElement = document.getElementById(`${questionId}_option_${optionIndex}`).parentNode.parentNode;
    
    // Reset highlighting for this question
    questionElement.querySelectorAll('.test-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Highlight selected option
    const selectedOption = document.getElementById(`${questionId}_option_${optionIndex}`);
    selectedOption.classList.add('selected');
    
    // Save answer
    if (!currentHskTest.answers) {
        currentHskTest.answers = {};
    }
    currentHskTest.answers[questionId] = optionIndex;
}

// Submit full test
async function submitFullTest() {
    if (!confirm('Complete test and submit answers?')) {
        return;
    }
    
    clearInterval(testTimer);
    showLoading('testContainer', 'Evaluating results...');
    
    try {
        // 1. Collect all data for submission
        // IMPORTANT: Calculate scores based on user answers
        const testResults = {
            user_id: currentUser?.user_id || 'guest_' + Date.now(),
            test_id: currentHskTest.test_id,
            level: currentHskTest.level,
            listening_score: 0,  // Will be calculated on server
            reading_score: 0,    // Will be calculated on server
            writing_score: 0,    // Will be calculated on server
            speaking_score: 0,   // Start with 0
            total_score: 0,      // Will be calculated on server
            answers: collectAllAnswers()
        };
        
        // 2. Send to server
        const response = await fetch(`${API_BASE}/hsk/submit-test-results`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testResults)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        // 3. Show results
        displayTestResults(result);
        
    } catch (error) {
        console.error('Test submission error:', error);
        // Show error message
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 3em; color: var(--danger);">‚ùå</div>
                <h3>Test submission error</h3>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="submitFullTest()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

function calculateSectionScore(sectionName) {
    const section = currentHskTest?.sections?.[sectionName];
    if (!section) return 0;
    
    // Simple scoring logic based on selected answers
    let correct = 0;
    let total = 0;
    
    // For listening and reading count selected answers
    if (sectionName === 'listening' || sectionName === 'reading') {
        const questions = section.questions || [];
        questions.forEach((question, index) => {
            const questionId = question.id || `${sectionName[0].toUpperCase()}${index+1}`;
            if (currentHskTest.answers && currentHskTest.answers[questionId] !== undefined) {
                total++;
                // Check answer (simple check)
                if (question.correct_index !== undefined) {
                    if (currentHskTest.answers[questionId] === question.correct_index) {
                        correct++;
                    }
                }
            }
        });
        
        if (total > 0) {
            return Math.round((correct / total) * 100);
        }
    }
    
    // For writing and speaking return 0, as evaluation is done on server
    return 0;
}

function collectAllAnswers() {
    const answers = {};
    
    // Collect answers from selected options
    document.querySelectorAll('.test-option.selected').forEach(option => {
        const questionId = option.id.split('_option_')[0];
        const optionIndex = parseInt(option.id.split('_option_')[1]);
        answers[questionId] = optionIndex;
    });
    
    return answers;
}

function showLocalTestResults() {
    const container = document.getElementById('testContainer');
    
    // Calculate local scores
    const listeningScore = calculateSectionScore('listening');
    const readingScore = calculateSectionScore('reading');
    const writingScore = calculateSectionScore('writing');
    const speakingScore = 75;
    const totalScore = listeningScore + readingScore + writingScore + speakingScore;
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>${totalScore >= 180 ? 'üéâ Congratulations!' : 'üí™ Try again!'}</h2>
            <div style="font-size: 3em; font-weight: bold; color: ${totalScore >= 180 ? 'var(--success)' : 'var(--danger)'}">
                ${totalScore}/300
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <h3>Listening</h3>
                <div class="stat-number">${listeningScore}/100</div>
            </div>
            <div class="stat-card">
                <h3>Reading</h3>
                <div class="stat-number">${readingScore}/100</div>
            </div>
            <div class="stat-card">
                <h3>Writing</h3>
                <div class="stat-number">${writingScore}/100</div>
            </div>
            <div class="stat-card">
                <h3>Speaking</h3>
                <div class="stat-number">${speakingScore}/100</div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="btn btn-primary" onclick="startTest(${currentHskTest.level})">
                <i class="fas fa-redo"></i> Take Test Again
            </button>
        </div>
    `;
}

// Fix evaluateWriting function:
async function evaluateWriting(text, taskData) {
    try {
        const response = await fetch(`${API_BASE}/hsk/evaluate-writing`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                task_data: taskData,
                user_id: currentUser?.user_id || 'guest_' + Date.now()
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Writing evaluation error:', error);
        // Return fallback score
        return {
            score: Math.floor(Math.random() * 30) + 60,
            feedback: 'AI evaluation error. Check grammar and vocabulary.',
            suggestions: ['Use more diverse vocabulary', 'Check word order']
        };
    }
}

async function evaluateWriting(text, taskData) {
    try {
        const response = await fetch(`${API_BASE}/hsk/evaluate-writing`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                task_data: taskData,
                user_id: currentUser?.user_id || 'guest'
            })
        });
        
        return await response.json();
    } catch (error) {
        console.error('Writing evaluation error:', error);
        return {
            score: Math.floor(Math.random() * 30) + 50, // Random 50-80
            feedback: 'Evaluation error. Check grammar and vocabulary.'
        };
    }
}

function displayTestResults(data) {
    const container = document.getElementById('testContainer');
    
    // Use REAL data from server response
    const totalScore = data.calculated_score || data.scores?.total || 0;
    const maxScore = data.scores?.max || (data.level <= 2 ? 200 : 300);
    const percentage = data.scores?.total ? Math.round((data.scores.total / maxScore) * 100) : 0;
    
    // Get specific scores
    const listeningScore = data.scores?.listening || 0;
    const readingScore = data.scores?.reading || 0;
    const writingScore = data.scores?.writing || 0;
    const speakingScore = data.scores?.speaking || 0;
    const level = data.level || currentHskTest?.level || 1;
    
    // Determine if user passed
    const passingScore = level <= 2 ? 120 : 180;  // HSK 1-2: 120/200, HSK 3-6: 180/300
    const passed = totalScore >= passingScore;
    
    // Get section statistics
    const listeningStats = data.stats?.listening || "0/0 (0/100)";
    const readingStats = data.stats?.reading || "0/0 (0/100)";
    const writingStats = data.stats?.writing || "0/100";
    const speakingStats = data.stats?.speaking || "0/100";
    
    // Parse statistics string for listening and reading
    const listeningMatch = listeningStats.match(/(\d+)\/(\d+)\s+\((\d+)/);
    const listeningCorrect = listeningMatch ? listeningMatch[1] : "0";
    const listeningTotal = listeningMatch ? listeningMatch[2] : "0";
    
    const readingMatch = readingStats.match(/(\d+)\/(\d+)\s+\((\d+)/);
    const readingCorrect = readingMatch ? readingMatch[1] : "0";
    const readingTotal = readingMatch ? readingMatch[2] : "0";
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 4em; color: ${passed && totalScore > 0 ? 'var(--success)' : 'var(--danger)'}">
                ${passed && totalScore > 0 ? 'üéâ' : 'üí™'}
            </div>
            <h2>${passed && totalScore > 0 ? 'Congratulations!' : 'Need more practice!'}</h2>
            <div style="font-size: 2.5em; font-weight: bold; color: ${passed && totalScore > 0 ? 'var(--success)' : 'var(--danger)'}">
                ${totalScore}/${maxScore} (${percentage}%)
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                ${passed && totalScore > 0 ? `You passed HSK ${level}!` : `To pass HSK ${level} you need ${passingScore} points`}
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                Answers checked: ${Object.keys(data.correct_answers || {}).length}
            </div>
        </div>
        
        <!-- Section statistics -->
        <div style="margin-bottom: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-chart-bar"></i> Section Results:
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="stat-card">
                    <h3>Listening</h3>
                    <div class="stat-number">${listeningScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${listeningScore}%"></div>
                    </div>
                    <div class="stat-desc">${listeningCorrect}/${listeningTotal} correct</div>
                </div>
                <div class="stat-card">
                    <h3>Reading</h3>
                    <div class="stat-number">${readingScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${readingScore}%"></div>
                    </div>
                    <div class="stat-desc">${readingCorrect}/${readingTotal} correct</div>
                </div>
                ${level >= 3 ? `
                <div class="stat-card">
                    <h3>Writing</h3>
                    <div class="stat-number">${writingScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${writingScore}%"></div>
                    </div>
                    <div class="stat-desc">Writing section</div>
                </div>
                ` : ''}
                <div class="stat-card">
                    <h3>Speaking</h3>
                    <div class="stat-number">${speakingScore}/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${speakingScore}%"></div>
                    </div>
                    <div class="stat-desc">Speaking section</div>
                </div>
            </div>
        </div>
        
        <!-- General information -->
        <div class="word-card" style="margin-bottom: 20px;">
            <h4><i class="fas fa-info-circle"></i> Test Information:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;">
                <div>
                    <strong>Level:</strong> HSK ${level}
                </div>
                <div>
                    <strong>Maximum score:</strong> ${maxScore}
                </div>
                <div>
                    <strong>Passing score:</strong> ${passingScore}
                </div>
                <div>
                    <strong>Status:</strong> <span style="color: ${passed && totalScore > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                        ${passed && totalScore > 0 ? 'PASSED' : 'FAILED'}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Checked answers (if any) -->
        ${data.correct_answers && Object.keys(data.correct_answers).length > 0 ? `
            <div class="word-card" style="margin-top: 20px;">
                <h4><i class="fas fa-check-circle"></i> Checked Answers:</h4>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    ${Object.entries(data.correct_answers).map(([qId, result]) => `
                        <div style="padding: 8px; border-bottom: 1px solid #dee2e6;">
                            <div style="font-weight: bold; color: ${result.correct ? 'var(--success)' : 'var(--danger)'};">
                                ${qId}: ${result.correct ? '‚úì Correct' : '‚úó Error'}
                            </div>
                            ${result.feedback ? `<div style="font-size: 0.9em;">${result.feedback}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-primary" onclick="startTest(${level})">
                <i class="fas fa-redo"></i> Take Test Again
            </button>
            <button class="btn btn-secondary" onclick="switchTab('progress')" style="margin-left: 10px;">
                <i class="fas fa-chart-line"></i> View Progress
            </button>
        </div>
    `;
}

async function downloadCertificate(certificateId) {
    // Generate PDF certificate
    alert('Certificate will be downloaded as PDF');
    // PDF generation logic will be here
}

function shareCertificate(certificateId) {
    if (navigator.share) {
        navigator.share({
            title: `My HSK ${currentHskTest.level} Certificate`,
            text: `I passed HSK ${currentHskTest.level} test with score ${currentHskTest.total_score}/300 points!`,
            url: window.location.href
        });
    } else {
        alert('Copy certificate link');
    }
}

function showDetailedReport() {
    switchTab('progress');
    // Detailed report logic can be added here
}
        
        // Reset test
        function resetTest() {
            if (currentTest) {
                displayTest(currentTest);
            }
        }
        
        // Show registration form
        function showRegisterForm() {
            const progressContent = document.getElementById('progressContent');
            
            progressContent.innerHTML = `
                <h3><i class="fas fa-user-plus"></i> Registration</h3>
                <p>To track progress, create a profile:</p>
                
                <div style="margin: 20px 0;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Name:</label>
                        <input type="text" id="regName" placeholder="Your name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Current HSK Level:</label>
                        <select id="regCurrentLevel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            ${[1,2,3,4,5,6].map(level => `<option value="${level}">HSK ${level}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Level:</label>
                        <select id="regTargetLevel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            ${[1,2,3,4,5,6].map(level => `<option value="${level}" ${level === 4 ? 'selected' : ''}>HSK ${level}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Exam Date:</label>
                        <input type="date" id="regExamDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Daily Time (minutes):</label>
                        <input type="number" id="regDailyTime" value="30" min="10" max="180" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <button class="btn btn-primary" onclick="registerUser()" style="width: 100%;">
                        <i class="fas fa-check"></i> Register
                    </button>
                </div>
            `;
            
            // Set default date (3 months from now)
            const defaultDate = new Date();
            defaultDate.setMonth(defaultDate.getMonth() + 3);
            document.getElementById('regExamDate').value = defaultDate.toISOString().split('T')[0];
        }
        
        // Register user
        async function registerUser() {
            const userData = {
                name: document.getElementById('regName').value || 'Anonymous',
                current_level: parseInt(document.getElementById('regCurrentLevel').value) || 1,
                target_level: parseInt(document.getElementById('regTargetLevel').value) || 4,
                exam_date: document.getElementById('regExamDate').value || new Date().toISOString().split('T')[0],
                daily_time: parseInt(document.getElementById('regDailyTime').value) || 30,
                exam_location: "Moscow",
                exam_format: "computer",
                interests: ["chinese", "HSK"],
                learning_style: "visual"
            };
            
            if (!userData.name.trim()) {
                alert('Enter name!');
                return;
            }
            
            showLoading('progressContent', 'Registering...');
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                // Show successful registration
                const progressContent = document.getElementById('progressContent');
                progressContent.innerHTML = `
                    <div style="text-align: center; padding: 30px 0;">
                        <div style="font-size: 4em; color: var(--success);">üéâ</div>
                        <h3>Registration successful!</h3>
                        <p>Welcome, ${userData.name}!</p>
                        <p>Your ID: <strong>${result.user_id}</strong></p>
                        
                        <div class="word-tip" style="margin: 20px 0; text-align: left;">
                            <strong><i class="fas fa-bullseye"></i> Your plan:</strong><br>
                            ‚Ä¢ Learn ${result.plan.daily_words} words daily<br>
                            ‚Ä¢ Until exam: ${result.plan.days_until_exam} days<br>
                            ‚Ä¢ Hacks: ${result.plan.hacks.slice(0, 2).join(', ')}<br>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="loadWordsByLevel(${userData.current_level})">
                                <i class="fas fa-book"></i> Start Learning
                            </button>
                            <button class="btn btn-secondary" onclick="startTest(${userData.current_level})">
                                <i class="fas fa-graduation-cap"></i> Take Test
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('progressContent').innerHTML = `
                    <div class="loading">
                        <p>‚ùå Registration error</p>
                        <button class="btn btn-primary" onclick="showRegisterForm()">Try Again</button>
                    </div>
                `;
            }
        }
        
        // Show loading indicator
        function showLoading(elementId, message = 'Loading...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        async function loadAllWords(level) {
    showLoading('wordsList', `Loading all HSK ${level} words...`);
    
    try {
        const response = await fetch(`${API_BASE}/words/level/${level}?limit=10000`);
        const data = await response.json();
        
        const wordsList = document.getElementById('wordsList');
        wordsList.innerHTML = '';
        
        if (data.words && data.words.length > 0) {
            // Create table
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '20px';
            
            // Table header
            table.innerHTML = `
                <thead>
                    <tr style="background: var(--primary); color: white;">
                        <th style="padding: 12px; text-align: left;">Character</th>
                        <th style="padding: 12px; text-align: left;">Pinyin</th>
                        <th style="padding: 12px; text-align: left;">Translation</th>
                        <th style="padding: 12px; text-align: left;">Level</th>
                    </tr>
                </thead>
                <tbody id="wordsTableBody">
                </tbody>
            `;
            
            wordsList.appendChild(table);
            
            // Fill table in EXACT ORDER from JSON
            const tbody = document.getElementById('wordsTableBody');
            data.words.forEach((word, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                row.style.backgroundColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                row.innerHTML = `
                    <td style="padding: 10px; font-size: 1.2em; font-weight: bold;">${word.character}</td>
                    <td style="padding: 10px; color: var(--danger);">${word.pinyin || ''}</td>
                    <td style="padding: 10px;">${word.translation || ''}</td>
                    <td style="padding: 10px;">
                        <span class="word-level">HSK ${word.hsk_level || 1}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add information
            const infoDiv = document.createElement('div');
            infoDiv.className = 'word-tip';
            infoDiv.style.marginTop = '20px';
            infoDiv.innerHTML = `
                <strong><i class="fas fa-info-circle"></i> All HSK ${level} words:</strong>
                ${data.total} words | All shown
            `;
            wordsList.appendChild(infoDiv);
            
        } else {
            wordsList.innerHTML = '<p>üì≠ No words found</p>';
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Function to search universities
async function searchChineseUniversities() {
    const query = document.getElementById('admissionQuery').value.trim();
    const hskLevel = document.getElementById('hskLevelFilter').value;
    const budget = document.getElementById('budgetFilter').value;
    const language = document.getElementById('languageFilter').value;
    
    if (!query) {
        alert('Please describe what you are looking for!');
        return;
    }
    
    // Show results
    document.getElementById('searchResults').style.display = 'block';
    document.getElementById('universitiesList').innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
            <h4 style="color: var(--primary);">AI is searching for information...</h4>
            <p style="color: var(--gray);">Searching for current data on Chinese universities</p>
        </div>
    `;
    
    const searchBtn = document.getElementById('searchUniversitiesBtn');
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
    
    try {
        // Form request for AI
        const searchRequest = {
            query: query,
            filters: {
                hsk_level: hskLevel || null,
                max_budget: budget || null,
                language: language || null
            },
            user_id: currentUser?.user_id || null,
            search_type: "university_search"
        };
        
        console.log('Sending search request:', searchRequest);
        
        // Send request to your backend
        const response = await fetch(`${API_BASE}/ai/search-universities`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(searchRequest)
        });
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Display results
        displayUniversityResults(data.results || data.analysis);
        
        // Update status
        document.getElementById('searchStatus').innerHTML = `
            <i class="fas fa-check" style="color: var(--success);"></i> 
            Found ${data.count || 'several'} options. Data updated: ${new Date().toLocaleDateString()}
        `;
        
    } catch (error) {
        console.error('Search error:', error);
        document.getElementById('universitiesList').innerHTML = `
            <div class="word-tip" style="border-color: var(--danger);">
                <strong>‚ùå Search error:</strong><br>
                ${error.message}<br><br>
                <strong>Try:</strong>
                <ul>
                    <li>Change query</li>
                    <li>Check internet connection</li>
                    <li>Try later</li>
                </ul>
            </div>
        `;
        document.getElementById('searchStatus').innerHTML = `
            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> 
            Search completed with error
        `;
    } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i class="fas fa-search"></i> Find Suitable Universities';
        
        // Scroll to results
        document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
    }
}

// Function to display results
function displayUniversityResults(results) {
    const container = document.getElementById('universitiesList');
    
    if (!results || (typeof results === 'string' && results.includes('not found'))) {
        container.innerHTML = `
            <div class="word-tip">
                <h4>üòï Nothing found</h4>
                <p>Try changing search parameters:</p>
                <ul>
                    <li>Specify different major</li>
                    <li>Change HSK level</li>
                    <li>Increase budget</li>
                    <li>Remove city restrictions</li>
                </ul>
                <button class="btn btn-primary" onclick="document.getElementById('admissionQuery').focus()">
                    <i class="fas fa-edit"></i> Change Query
                </button>
            </div>
        `;
        return;
    }
    
    // If result is text from AI
    if (typeof results === 'string') {
        container.innerHTML = `
            <div class="ai-analysis-result">
                ${formatAIText(results)}
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h5><i class="fas fa-robot"></i> What AI did:</h5>
                    <ul>
                        <li>üîç Scanned Chinese university websites</li>
                        <li>üìä Compared requirements and prices</li>
                        <li>üéØ Filtered by your criteria</li>
                        <li>üí° Gave admission recommendations</li>
                    </ul>
                </div>
            </div>
        `;
        return;
    }
    
    // If result is structured data
    if (Array.isArray(results)) {
        let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
        
        results.forEach((uni, index) => {
            html += `
                <div class="university-card" style="border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: var(--primary);">
                                ${index + 1}. ${uni.name || 'University'}
                            </h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                                <span class="word-level">${uni.city || 'City not specified'}</span>
                                ${uni.hsk_required ? `<span class="word-level">HSK ${uni.hsk_required}</span>` : ''}
                                ${uni.price ? `<span class="word-level">${uni.price} ¬•/year</span>` : ''}
                                ${uni.ranking ? `<span class="word-level">Ranking: ${uni.ranking}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="showUniversityDetails(${index})">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <p><strong>Major:</strong> ${uni.major || 'Not specified'}</p>
                        ${uni.description ? `<p>${uni.description}</p>` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            ${uni.website ? `<a href="${uni.website}" target="_blank" class="btn btn-sm btn-secondary">
                                <i class="fas fa-external-link-alt"></i> Website
                            </a>` : ''}
                            <button class="btn btn-sm btn-success" onclick="saveUniversity(${index})">
                                <i class="fas fa-bookmark"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
}

// Helper functions
function formatAIText(text) {
    // Simple formatting of AI text
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/## (.*?)(\n|$)/g, '<h4>$1</h4>')
        .replace(/- (.*?)(\n|$)/g, '<li>$1</li>');
}

function loadExampleQuery(num) {
    const examples = [
        "Looking for computer science bachelor's with HSK 4, budget up to 20000 yuan per year, interested in universities in Beijing or Shanghai",
        "Need information about CSC scholarships for medical master's, HSK 5 level, any city in China",
        "What universities in Shanghai have English-language business programs? Interested in MBA",
        "Looking for English-language engineering programs in China, can be without HSK, scholarship important"
    ];
    
    document.getElementById('admissionQuery').value = examples[num - 1];
    document.getElementById('admissionQuery').focus();
}

function clearSearch() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('admissionQuery').value = '';
}

function exportResults() {
    const results = document.getElementById('universitiesList').innerText;
    const blob = new Blob([results], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'chinese_universities_search.txt';
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('‚úÖ Results exported to file');
}

// Update buttons
function updateWordButtons() {
    // Replace "HSK 1" button with
    `<button class="btn btn-success" onclick="loadAllWords(1)">
        <i class="fas fa-list"></i> All HSK 1 Words
    </button>`
}
        
        // Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Load data on startup
        // Load data on startup
// Load data on startup
window.onload = async function() {

    document.addEventListener('DOMContentLoaded', function() {
    // Initialize translation buttons when tab loads
    if (document.getElementById('translationModeContent')) {
        initTranslationButtons();
    }
    
    // Dynamic button initialization
    document.addEventListener('click', function(e) {
        // "Search word" button
        if (e.target.closest('[onclick*="lookupWordInTranslation"]')) {
            e.preventDefault();
            lookupWordInTranslation();
        }
        
        // "Check grammar" button
        if (e.target.closest('[onclick*="checkGrammarInTranslation"]')) {
            e.preventDefault();
            checkGrammarInTranslation();
        }
        
        // "Alternative version" button
        if (e.target.closest('[onclick*="suggestAlternative"]')) {
            e.preventDefault();
            suggestAlternative();
        }
        
        // "Clear" button
        if (e.target.closest('[onclick*="clearTranslation"]')) {
            e.preventDefault();
            clearTranslation();
        }
        
        // "Hint" button
        if (e.target.closest('[onclick*="showTranslationHint"]')) {
            e.preventDefault();
            showTranslationHint();
        }
    });
});
    // Show authorization form
    document.getElementById('authSection').style.display = 'block';
    
    // Check saved user
    await checkAuth();
    
    // Load other data
    loadStats();
    loadRandomWords();
    
    // Auto-focus input field
    document.getElementById('messageInput').focus();
    
    // Load initial content for Progress tab
    loadProgress();
    
    // Greeting
    if (!currentUser) {
        setTimeout(() => {
            addMessage('üîê To save progress, enter your name at top of page and click "Log in".', 'ai');
        }, 1000);
    }
    // Add to end of window.onload or separate initialization function
document.getElementById('startVoiceBtn').addEventListener('click', function() {
    if (!voiceRecognition) {
        initVoiceChat();
    }
    
    if (voiceRecognition && !isRecording) {
        try {
            voiceRecognition.start();
        } catch (error) {
            console.error('Recording start error:', error);
            addVoiceMessage('AI', 'Failed to start recording. Check microphone permissions.', 'error');
        }
    }
});

document.getElementById('stopVoiceBtn').addEventListener('click', function() {
    if (voiceRecognition && isRecording) {
        voiceRecognition.stop();
    }
});

document.getElementById('clearVoiceBtn').addEventListener('click', function() {
    document.getElementById('voiceChatBox').innerHTML = '';
    voiceChatHistory = [];
    addVoiceMessage('AI', 'Chat history cleared. Start new conversation!', 'info');
});

};
// –û—Ç–ª–∞–¥–∫–∞ –º–æ–¥–∞–ª–æ–∫
console.log("loginModal:", document.getElementById('loginModal'));
console.log("registerModal:", document.getElementById('registerModal'));

// –ü–µ—Ä–µ–º–µ—Å—Ç–∏–º –º–æ–¥–∞–ª–∫–∏ –≤ body, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
document.addEventListener('DOMContentLoaded', function() {
    const loginModal = document.getElementById('loginModal');
    const registerModal = document.getElementById('registerModal');
    
    if (loginModal && loginModal.parentElement !== document.body) {
        document.body.appendChild(loginModal);
        console.log("loginModal –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ <body>");
    }
    
    if (registerModal && registerModal.parentElement !== document.body) {
        document.body.appendChild(registerModal);
        console.log("registerModal –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ <body>");
    }
});
    </script>
</body>
</html>